<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">
<!--
generated by Pygments <http://pygments.org>
Copyright 2006-2019 by the Pygments team.
Licensed under the BSD license, see LICENSE for details.
-->
<html>
<head>
  <title>client.js</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <style type="text/css">
/*
generated by Pygments <http://pygments.org>
Copyright 2006-2019 by the Pygments team.
Licensed under the BSD license, see LICENSE for details.
*/
td.linenos { background-color: #f0f0f0; padding-right: 10px; }
span.lineno { background-color: #f0f0f0; padding: 0 5px 0 5px; }
pre { line-height: 125%; }
body .hll { background-color: #ffffcc }
body  { background: #eeeedd; }
body .c { color: #228B22 } /* Comment */
body .err { color: #a61717; background-color: #e3d2d2 } /* Error */
body .k { color: #8B008B; font-weight: bold } /* Keyword */
body .ch { color: #228B22 } /* Comment.Hashbang */
body .cm { color: #228B22 } /* Comment.Multiline */
body .cp { color: #1e889b } /* Comment.Preproc */
body .cpf { color: #228B22 } /* Comment.PreprocFile */
body .c1 { color: #228B22 } /* Comment.Single */
body .cs { color: #8B008B; font-weight: bold } /* Comment.Special */
body .gd { color: #aa0000 } /* Generic.Deleted */
body .ge { font-style: italic } /* Generic.Emph */
body .gr { color: #aa0000 } /* Generic.Error */
body .gh { color: #000080; font-weight: bold } /* Generic.Heading */
body .gi { color: #00aa00 } /* Generic.Inserted */
body .go { color: #888888 } /* Generic.Output */
body .gp { color: #555555 } /* Generic.Prompt */
body .gs { font-weight: bold } /* Generic.Strong */
body .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
body .gt { color: #aa0000 } /* Generic.Traceback */
body .kc { color: #8B008B; font-weight: bold } /* Keyword.Constant */
body .kd { color: #8B008B; font-weight: bold } /* Keyword.Declaration */
body .kn { color: #8B008B; font-weight: bold } /* Keyword.Namespace */
body .kp { color: #8B008B; font-weight: bold } /* Keyword.Pseudo */
body .kr { color: #8B008B; font-weight: bold } /* Keyword.Reserved */
body .kt { color: #00688B; font-weight: bold } /* Keyword.Type */
body .m { color: #B452CD } /* Literal.Number */
body .s { color: #CD5555 } /* Literal.String */
body .na { color: #658b00 } /* Name.Attribute */
body .nb { color: #658b00 } /* Name.Builtin */
body .nc { color: #008b45; font-weight: bold } /* Name.Class */
body .no { color: #00688B } /* Name.Constant */
body .nd { color: #707a7c } /* Name.Decorator */
body .ne { color: #008b45; font-weight: bold } /* Name.Exception */
body .nf { color: #008b45 } /* Name.Function */
body .nn { color: #008b45; text-decoration: underline } /* Name.Namespace */
body .nt { color: #8B008B; font-weight: bold } /* Name.Tag */
body .nv { color: #00688B } /* Name.Variable */
body .ow { color: #8B008B } /* Operator.Word */
body .w { color: #bbbbbb } /* Text.Whitespace */
body .mb { color: #B452CD } /* Literal.Number.Bin */
body .mf { color: #B452CD } /* Literal.Number.Float */
body .mh { color: #B452CD } /* Literal.Number.Hex */
body .mi { color: #B452CD } /* Literal.Number.Integer */
body .mo { color: #B452CD } /* Literal.Number.Oct */
body .sa { color: #CD5555 } /* Literal.String.Affix */
body .sb { color: #CD5555 } /* Literal.String.Backtick */
body .sc { color: #CD5555 } /* Literal.String.Char */
body .dl { color: #CD5555 } /* Literal.String.Delimiter */
body .sd { color: #CD5555 } /* Literal.String.Doc */
body .s2 { color: #CD5555 } /* Literal.String.Double */
body .se { color: #CD5555 } /* Literal.String.Escape */
body .sh { color: #1c7e71; font-style: italic } /* Literal.String.Heredoc */
body .si { color: #CD5555 } /* Literal.String.Interpol */
body .sx { color: #cb6c20 } /* Literal.String.Other */
body .sr { color: #1c7e71 } /* Literal.String.Regex */
body .s1 { color: #CD5555 } /* Literal.String.Single */
body .ss { color: #CD5555 } /* Literal.String.Symbol */
body .bp { color: #658b00 } /* Name.Builtin.Pseudo */
body .fm { color: #008b45 } /* Name.Function.Magic */
body .vc { color: #00688B } /* Name.Variable.Class */
body .vg { color: #00688B } /* Name.Variable.Global */
body .vi { color: #00688B } /* Name.Variable.Instance */
body .vm { color: #00688B } /* Name.Variable.Magic */
body .il { color: #B452CD } /* Literal.Number.Integer.Long */

  </style>
</head>
<body>
<h2></h2>

<div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm">Copyright 2022 James D. Miller</span>

<span class="cm">Permission is hereby granted, free of charge, to any person obtaining a copy</span>
<span class="cm">of this software and associated documentation files (the &quot;Software&quot;), to deal</span>
<span class="cm">in the Software without restriction, including without limitation the rights</span>
<span class="cm">to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
<span class="cm">copies of the Software, and to permit persons to whom the Software is</span>
<span class="cm">furnished to do so, subject to the following conditions:</span>

<span class="cm">The above copyright notice and this permission notice shall be included in all</span>
<span class="cm">copies or substantial portions of the Software.</span>

<span class="cm">THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="cm">IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="cm">FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
<span class="cm">AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<span class="cm">LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span>
<span class="cm">OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="cm">SOFTWARE.</span>
<span class="cm">*/</span>

<span class="c1">// Client (cT) module</span>
<span class="c1">// client.js </span>
   <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;cT version 0.0&#39;</span><span class="p">);</span>
<span class="c1">// 4:22 PM Tue July 25, 2023</span>

<span class="cm">/*</span>
<span class="cm">Dependencies for client.js:</span>
<span class="cm">   utilities.js (uT.)</span>
<span class="cm">   Box2D.js (b2DW.)</span>
<span class="cm">   constructorsAndPrototypes.js (cP.)</span>
<span class="cm">   hostAndClient.js (hC.)</span>
<span class="cm">   puckPopper.js (pP.)</span>
<span class="cm">   ghostBall.js (gB.)</span>
<span class="cm">*/</span>

<span class="nb">window</span><span class="p">.</span><span class="nx">cT</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
   <span class="s2">&quot;use strict&quot;</span><span class="p">;</span>
   
   <span class="c1">//////////////////////////////////////////////////////////////////////////////////////////</span>
   <span class="c1">////</span>
   <span class="c1">////  Prototype for a client, each player/user, as represented on the host, index.html </span>
   <span class="c1">////</span>
   <span class="c1">//////////////////////////////////////////////////////////////////////////////////////////</span>
   
   <span class="kd">function</span> <span class="nx">Client</span><span class="p">(</span> <span class="nx">pars</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">cP</span><span class="p">.</span><span class="nx">DrawingFunctions</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span> <span class="c1">// inherit</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">parsAtBirth</span> <span class="o">=</span> <span class="nx">pars</span><span class="p">;</span>
      <span class="c1">//this.alsoThese = [];</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">color</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">color</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">);</span>
      
      <span class="c1">// Used for remembering the host&#39;s server name, for everyone but the host (who&#39;s this.name is &#39;local&#39;),</span>
      <span class="c1">// this parameter is equal to this.name.</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">nameFromServer</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">nameFromServer</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>

      <span class="c1">// Incrementing the network client name is done in server.js.</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="s2">&quot;manWithNoName&quot;</span><span class="p">);</span>
            
      <span class="c1">// Increment the NPC index, but use the higher value.</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;NPC&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">Client</span><span class="p">.</span><span class="nx">npcIndex</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
         <span class="nx">Client</span><span class="p">.</span><span class="nx">npcIndex</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">Client</span><span class="p">.</span><span class="nx">npcIndex</span><span class="p">,</span> <span class="nb">Number</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">3</span><span class="p">)));</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s1">&#39;NPC&#39;</span> <span class="o">+</span> <span class="nx">Client</span><span class="p">.</span><span class="nx">npcIndex</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="c1">// Add this client to the map.</span>
      <span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">puck</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">player</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">player</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">nickName</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">nickName</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">winCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// use this to suggest a nickname after two game wins</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">virtualGamePadUsage</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="c1">// usage in a game</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">twoThumbsEnabled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="c1">// client in tt fullscreen mode</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">touchScreenUsage</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">deviceType</span> <span class="o">=</span> <span class="s1">&#39;desktop&#39;</span><span class="p">;</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">mouseDown</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">mouseUsage</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">button</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">raw_2d_px</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span> <span class="c1">// used only for the &#39;local&#39; (host) in menu operations for gW.tableActions</span>
      
      <span class="c1">// Initially put the drawn cursor (for the local user) out of range of the canvas. That way the cursor doesn&#39;t</span>
      <span class="c1">// render there initially if the page is refreshed, looks cleaner when first coming to the page.</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s1">&#39;local&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">mouse_2d_px</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">mouse_2d_px</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">mouse_2d_m</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">worldFromScreen</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">mouse_2d_px</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">mouse_async_2d_px</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">mouse_2d_m</span><span class="p">;</span>
      
      <span class="c1">// this one is used in calculating cursor speed...</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">prev_mouse_2d_px</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">mouse_2d_px</span><span class="p">;</span>
      
      <span class="c1">// used with fine moves...</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">prevNormalCursorPosOnCanvas_2d_px</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">mouse_2d_px</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">previousFine_2d_px</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="mi">300</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">fineMovesState</span> <span class="o">=</span> <span class="s1">&#39;off&#39;</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">fMT</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;count&#39;</span><span class="o">:</span><span class="mi">0</span><span class="p">};</span> <span class="c1">//fine Move Transition</span>
      
      <span class="c1">// Make a cursor pin for all human clients.</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;NPC&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">pin</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">cP</span><span class="p">.</span><span class="nx">Pin</span><span class="p">(</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">({},</span> <span class="k">this</span><span class="p">.</span><span class="nx">mouse_2d_m</span><span class="p">),</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="s1">&#39;cursorPin&#39;</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span> <span class="s1">&#39;borderColor&#39;</span><span class="o">:</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="s1">&#39;fillColor&#39;</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">color</span><span class="p">});</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">pin</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="p">}</span>
      
      <span class="c1">// ghost ball state</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">gBS</span> <span class="o">=</span> <span class="p">{};</span>
      <span class="nx">gB</span><span class="p">.</span><span class="nx">resetPathAfterShot</span><span class="p">(</span> <span class="k">this</span><span class="p">);</span>
      
      <span class="c1">// box2d cursor sensor for pool shots</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">gBS</span><span class="p">.</span><span class="nx">readyToDraw</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">b2dSensor</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">sensorTargetName</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">sensorContact</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      
      <span class="c1">// method to indicate these two keys are down without actually holding them down.</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">ctrlShiftLock</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">ctrlShiftLock</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
      <span class="c1">// pool-game shot-speed lock</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">poolShotLocked</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">poolShotLocked</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">poolShotLockedSpeed_mps</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">poolShotLockedSpeed_mps</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">poolShotCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">pocketedBallCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="c1">// more ghost-pool related parameters...</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">stripesOrSolids</span> <span class="o">=</span> <span class="s2">&quot;table is open&quot;</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">scratchedDuringGame</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">objectBallFoulDuringGame</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">safetyShotFoulDuringGame</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">mouseStopMessage</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">mouseStopPenalty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">mouseStopFoulDuringGame</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">selectedBody</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      
      <span class="c1">// Selection point (in the local coordinate system of the selected object).</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">selectionPoint_l_2d_m</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">cursorSpring</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      
      <span class="c1">// Initialize all the key values to be Up.</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">keyMap</span><span class="p">)</span> <span class="k">this</span><span class="p">[</span><span class="nx">gW</span><span class="p">.</span><span class="nx">keyMap</span><span class="p">[</span><span class="nx">key</span><span class="p">]]</span> <span class="o">=</span> <span class="s1">&#39;U&#39;</span><span class="p">;</span>
      
      <span class="cm">/*      </span>
<span class="cm">      The following enable/disable feature is needed for keys that do </span>
<span class="cm">      something that should only be done once while the key is down (not each </span>
<span class="cm">      frame). This technique is needed in cases where action is potentially </span>
<span class="cm">      triggered each frame and it is not possible to compare the new key state </span>
<span class="cm">      (coming from a client or the local keyboard) with the current key state. </span>
<span class="cm">      </span>
<span class="cm">      Examples where this is NOT needed are the tube rotation keys. In </span>
<span class="cm">      those cases, something must be done in each frame while the key is down. </span>
<span class="cm">      The action repeats as the key state is inspected each frame (and seen to </span>
<span class="cm">      be down). </span>
<span class="cm">      </span>
<span class="cm">      Note there is an area in this code where pure-local-client key events </span>
<span class="cm">      are handled to avoid repetition; see the keydown area in this file. </span>
<span class="cm">      There, repetition is caused by holding the key down and the associated </span>
<span class="cm">      repeated firing of the keydown event. There, new and current states can </span>
<span class="cm">      be compared to avoid repetition.</span>
<span class="cm">      </span>
<span class="cm">      See also the updateClientState function and how it suppressed </span>
<span class="cm">      unwanted repetition by comparing new and current states.</span>
<span class="cm">      */</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">key_s_enabled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>  <span class="c1">// Flip the jet.</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">key_k_enabled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>  <span class="c1">// Change the gun orientation by 1 large increment.</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">key_i_enabled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>  <span class="c1">// Start a bullet stream.</span>
      
      <span class="c1">// This client-cursor triangle is oriented like an arrow pointing to 10 o&#39;clock.</span>
      <span class="c1">//this.triangle_raw_2d_px = [new wS.Vec2D(0,0), new wS.Vec2D(14,8), new wS.Vec2D(8,14)];</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">triangle_raw_2d_px</span> <span class="o">=</span> <span class="p">[</span><span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">),</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">16</span><span class="p">)];</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">NPC_guncooling_timer_s</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">NPC_guncooling_timer_limit_s</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">NPC_shield_timer_s</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">NPC_shield_timer_limit_s</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">NPC_pin_timer_s</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">NPC_pin_timer_s</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">NPC_pin_timer_limit_s</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">NPC_pin_timer_limit_s</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">);</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">NPC_aimStepCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">NPC_aimStepCount_limit</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">NPC_skipFrame</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">gunAngle_timer_s</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">gunAngle_timer_limit_s</span> <span class="o">=</span> <span class="mf">0.03</span><span class="p">;</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">bulletAgeLimit_ms</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">bulletAgeLimit_ms</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
      
      <span class="c1">// rtc contains WebRTC peer connection and data channel objects.</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">rtc</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">hC</span><span class="p">.</span><span class="nx">RTC</span><span class="p">({});</span>
      
      <span class="c1">// Score for the leaderboard</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">score</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      
      <span class="c1">// for drawing a little rectangle that helps to sync client and host video captures</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">sendDrawSyncCommand</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="c1">// Variables common to all instances of Client...</span>
   <span class="nx">Client</span><span class="p">.</span><span class="nx">npcIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="cm">/* </span>
<span class="cm">   The drag_c parameter affects a drag force that depends on the </span>
<span class="cm">   absolute motion of the COM of the puck (not relative to cursor). This is </span>
<span class="cm">   needed for providing the user with a controlled selection (and </span>
<span class="cm">   positioning) of pucks. If you set these to zero you&#39;ll see it&#39;s just too </span>
<span class="cm">   bouncy (and too much orbital motion). Unfortunately, this also gives a </span>
<span class="cm">   somewhat counterintuitive feel when selecting long rectangular pucks, </span>
<span class="cm">   near an end edge, with gravity on (the expected swing is strongly </span>
<span class="cm">   damped). Refer to Spring.prototype.force_on_pucks to see where these </span>
<span class="cm">   drag forces are applied. There is also the usual relative-motion drag </span>
<span class="cm">   parameter (spring damper), damper_Ns2pm2, that is set to the default </span>
<span class="cm">   value (0.5) here. I found this value is less useful here because the </span>
<span class="cm">   drag_c is being used. </span>
<span class="cm">   */</span> 
   <span class="nx">Client</span><span class="p">.</span><span class="nx">mouse_springs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;0&#39;</span><span class="o">:</span><span class="p">{</span><span class="s1">&#39;strength_Npm&#39;</span><span class="o">:</span>   <span class="mf">60.0</span><span class="p">,</span> <span class="s1">&#39;damper_Ns2pm2&#39;</span><span class="o">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;drag_c&#39;</span><span class="o">:</span>   <span class="mf">60.0</span><span class="o">/</span><span class="mf">30.0</span><span class="p">,</span> <span class="s1">&#39;unstretched_width_m&#39;</span><span class="o">:</span> <span class="mf">0.060</span><span class="p">},</span>   <span class="c1">// &#39;drag_c&#39;: 2.0</span>
                           <span class="s1">&#39;1&#39;</span><span class="o">:</span><span class="p">{</span><span class="s1">&#39;strength_Npm&#39;</span><span class="o">:</span>    <span class="mf">2.0</span><span class="p">,</span> <span class="s1">&#39;damper_Ns2pm2&#39;</span><span class="o">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;drag_c&#39;</span><span class="o">:</span>    <span class="mf">2.0</span><span class="o">/</span><span class="mf">30.0</span><span class="p">,</span> <span class="s1">&#39;unstretched_width_m&#39;</span><span class="o">:</span> <span class="mf">0.002</span><span class="p">},</span>   <span class="c1">//           0.1</span>
                           <span class="s1">&#39;2&#39;</span><span class="o">:</span><span class="p">{</span><span class="s1">&#39;strength_Npm&#39;</span><span class="o">:</span> <span class="mf">1000.0</span><span class="p">,</span> <span class="s1">&#39;damper_Ns2pm2&#39;</span><span class="o">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;drag_c&#39;</span><span class="o">:</span> <span class="mf">1000.0</span><span class="o">/</span><span class="mf">30.0</span><span class="p">,</span> <span class="s1">&#39;unstretched_width_m&#39;</span><span class="o">:</span> <span class="mf">0.100</span><span class="p">}};</span>  <span class="c1">//          20.0</span>
   <span class="nx">Client</span><span class="p">.</span><span class="nx">colors</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;1&#39;</span><span class="o">:</span><span class="s1">&#39;yellow&#39;</span><span class="p">,</span><span class="s1">&#39;2&#39;</span><span class="o">:</span><span class="s1">&#39;cyan&#39;</span><span class="p">,</span><span class="s1">&#39;3&#39;</span><span class="o">:</span><span class="s1">&#39;green&#39;</span><span class="p">,</span><span class="s1">&#39;4&#39;</span><span class="o">:</span><span class="s1">&#39;pink&#39;</span><span class="p">,</span><span class="s1">&#39;5&#39;</span><span class="o">:</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;6&#39;</span><span class="o">:</span><span class="s1">&#39;brown&#39;</span><span class="p">,</span><span class="s1">&#39;7&#39;</span><span class="o">:</span><span class="s1">&#39;greenyellow&#39;</span><span class="p">,</span><span class="s1">&#39;8&#39;</span><span class="o">:</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span><span class="s1">&#39;9&#39;</span><span class="o">:</span><span class="s1">&#39;tan&#39;</span><span class="p">,</span><span class="s1">&#39;0&#39;</span><span class="o">:</span><span class="s1">&#39;purple&#39;</span><span class="p">};</span>
   <span class="nx">Client</span><span class="p">.</span><span class="nx">lightColors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;yellow&#39;</span><span class="p">,</span> <span class="s1">&#39;greenyellow&#39;</span><span class="p">,</span> <span class="s1">&#39;pink&#39;</span><span class="p">,</span> <span class="s1">&#39;cyan&#39;</span><span class="p">,</span> <span class="s1">&#39;tan&#39;</span><span class="p">];</span>
   <span class="nx">Client</span><span class="p">.</span><span class="nx">applyToAll</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">doThis</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">clientName</span> <span class="k">in</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">var</span> <span class="nx">client</span> <span class="o">=</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span> <span class="nx">clientName</span><span class="p">];</span>
         <span class="nx">doThis</span><span class="p">(</span> <span class="nx">client</span><span class="p">);</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="nx">Client</span><span class="p">.</span><span class="nx">deleteNPCs</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">Client</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span> <span class="nx">client</span> <span class="p">=&gt;</span> <span class="p">{</span><span class="k">if</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;NPC&#39;</span><span class="p">)</span> <span class="k">delete</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span> <span class="nx">client</span><span class="p">.</span><span class="nx">name</span><span class="p">]});</span>
      <span class="nx">Client</span><span class="p">.</span><span class="nx">npcIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="nx">Client</span><span class="p">.</span><span class="nx">startingPandV</span> <span class="o">=</span> <span class="p">[];</span>
   <span class="nx">Client</span><span class="p">.</span><span class="nx">scoreSummary</span> <span class="o">=</span> <span class="p">[];</span>
   <span class="nx">Client</span><span class="p">.</span><span class="nx">winnerBonusGiven</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
   <span class="nx">Client</span><span class="p">.</span><span class="nx">resetScores</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">Client</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span> <span class="nx">client</span> <span class="p">=&gt;</span> <span class="p">{</span>
         <span class="nx">client</span><span class="p">.</span><span class="nx">mouseUsage</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
         <span class="nx">client</span><span class="p">.</span><span class="nx">touchScreenUsage</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
         <span class="nx">client</span><span class="p">.</span><span class="nx">virtualGamePadUsage</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
         <span class="nx">client</span><span class="p">.</span><span class="nx">score</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">});</span>
      <span class="c1">// If the npc are still paused, indicate pause usage.</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">pP</span><span class="p">.</span><span class="nx">getNpcSleep</span><span class="p">())</span> <span class="p">{</span>
         <span class="nx">pP</span><span class="p">.</span><span class="nx">setNpcSleepUsage</span><span class="p">(</span> <span class="kc">true</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="nx">pP</span><span class="p">.</span><span class="nx">setNpcSleepUsage</span><span class="p">(</span> <span class="kc">false</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">pP</span><span class="p">.</span><span class="nx">setPuckPopperTimer_s</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
      
      <span class="nx">Client</span><span class="p">.</span><span class="nx">winnerBonusGiven</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="nx">Client</span><span class="p">.</span><span class="nx">scoreSummary</span> <span class="o">=</span> <span class="p">[];</span>
   <span class="p">}</span>
   <span class="c1">// Sometimes it&#39;s just better to see &#39;host&#39; displayed instead of &#39;local&#39;.</span>
   <span class="nx">Client</span><span class="p">.</span><span class="nx">translateIfLocal</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">clientName</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">nameString</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">clientName</span> <span class="o">==</span> <span class="s1">&#39;local&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">nameString</span> <span class="o">=</span> <span class="s1">&#39;host&#39;</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="nx">nameString</span> <span class="o">=</span> <span class="nx">clientName</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">nameString</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="nx">Client</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span> <span class="nx">cP</span><span class="p">.</span><span class="nx">DrawingFunctions</span><span class="p">.</span><span class="nx">prototype</span><span class="p">);</span> <span class="c1">// Inherit methods (containing module must load first)</span>
   <span class="nx">Client</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">=</span> <span class="nx">Client</span><span class="p">;</span> <span class="c1">// Rename the constructor (after inheriting)</span>
   <span class="nx">Client</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">nameString</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">nickNameOnly</span><span class="o">=</span><span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">nameString</span><span class="p">,</span> <span class="nx">finalNameString</span><span class="p">;</span>
      
      <span class="nx">nameString</span> <span class="o">=</span> <span class="nx">Client</span><span class="p">.</span><span class="nx">translateIfLocal</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">nickName</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">nickNameOnly</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">finalNameString</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">nickName</span> <span class="o">+</span> <span class="s1">&#39; (&#39;</span> <span class="o">+</span> <span class="nx">nameString</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">;</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">finalNameString</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">nickName</span><span class="p">;</span>
         <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="nx">finalNameString</span> <span class="o">=</span> <span class="nx">nameString</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">finalNameString</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="nx">Client</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">addScoreToSummary</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">winnerTimeString</span><span class="p">,</span> <span class="nx">demoIndex</span><span class="p">,</span> <span class="nx">npcSleepUsage</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">finalNameString</span><span class="p">,</span> <span class="nx">mouseString</span><span class="p">,</span> <span class="nx">npcSleepString</span><span class="p">,</span> <span class="nx">virtualGamePadString</span><span class="p">;</span>
      
      <span class="nx">finalNameString</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">nameString</span><span class="p">();</span>
            
      <span class="c1">// Clear the mouseString warning for Jello Madness. Mouse is always used.</span>
      <span class="k">if</span> <span class="p">(</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">].</span><span class="nx">includes</span><span class="p">(</span> <span class="nx">demoIndex</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
         <span class="nx">mouseString</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="nx">mouseString</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">mouseUsage</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;x&#39;</span><span class="o">:</span><span class="s1">&#39;&#39;</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">npcSleepString</span> <span class="o">=</span> <span class="p">(</span><span class="nx">npcSleepUsage</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;x&#39;</span><span class="o">:</span><span class="s1">&#39;&#39;</span><span class="p">;</span>
      <span class="nx">virtualGamePadString</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">virtualGamePadUsage</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;x&#39;</span><span class="o">:</span><span class="s1">&#39;&#39;</span><span class="p">;</span>
      <span class="c1">// The randomIndex provides a way to nearly uniquely associate records in the leaderboard report with the local game summary.</span>
      <span class="nx">Client</span><span class="p">.</span><span class="nx">scoreSummary</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="p">{</span><span class="s1">&#39;score&#39;</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">score</span><span class="p">,</span> <span class="s1">&#39;rawName&#39;</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="o">:</span><span class="nx">finalNameString</span><span class="p">,</span> <span class="s1">&#39;virtualGamePad&#39;</span><span class="o">:</span><span class="nx">virtualGamePadString</span><span class="p">,</span> 
                                 <span class="s1">&#39;winner&#39;</span><span class="o">:</span><span class="nx">winnerTimeString</span><span class="p">,</span> <span class="s1">&#39;mouse&#39;</span><span class="o">:</span><span class="nx">mouseString</span><span class="p">,</span> <span class="s1">&#39;npcSleep&#39;</span><span class="o">:</span><span class="nx">npcSleepString</span><span class="p">,</span> <span class="s1">&#39;randomIndex&#39;</span><span class="o">:</span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">((</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100000</span><span class="p">))}</span> <span class="p">);</span>
   <span class="p">}</span>
   <span class="nx">Client</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">createBox2dSensor</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">radius_m</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">bodyDef</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">b2DW</span><span class="p">.</span><span class="nx">BodyDef</span><span class="p">;</span>
      <span class="nx">bodyDef</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="nx">b2DW</span><span class="p">.</span><span class="nx">Body</span><span class="p">.</span><span class="nx">b2_dynamicBody</span><span class="p">;</span> <span class="c1">// same type as a puck</span>
      <span class="nx">bodyDef</span><span class="p">.</span><span class="nx">allowSleep</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">b2dSensor</span> <span class="o">=</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">world</span><span class="p">.</span><span class="nx">CreateBody</span><span class="p">(</span> <span class="nx">bodyDef</span><span class="p">);</span>
      <span class="c1">//this.b2dSensor.SetAwake(true);</span>
      
      <span class="kd">var</span> <span class="nx">fixDef</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">b2DW</span><span class="p">.</span><span class="nx">FixtureDef</span><span class="p">;</span>
      <span class="nx">fixDef</span><span class="p">.</span><span class="nx">shape</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">b2DW</span><span class="p">.</span><span class="nx">CircleShape</span><span class="p">(</span> <span class="nx">radius_m</span><span class="p">);</span>
      <span class="c1">// Turned out to be better (offer more control) to use box2d contact events to inhibit the collision response.</span>
      <span class="c1">// (see contactNormals in ghostBall.js)</span>
      <span class="nx">fixDef</span><span class="p">.</span><span class="nx">isSensor</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
     
      <span class="k">this</span><span class="p">.</span><span class="nx">b2dSensor</span><span class="p">.</span><span class="nx">CreateFixture</span><span class="p">(</span> <span class="nx">fixDef</span><span class="p">);</span>    
      
      <span class="c1">// Set the initial position of the sensor</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">b2dSensor</span><span class="p">.</span><span class="nx">SetPosition</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">mouse_2d_m</span><span class="p">);</span>
      
      <span class="c1">// Mark this....</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">b2dSensor</span><span class="p">.</span><span class="nx">SetUserData</span><span class="p">(</span><span class="s1">&#39;ghost-sensor&#39;</span><span class="p">);</span>
      
      <span class="c1">// Use the table map to get back to this client from the b2d event handler.</span>
      <span class="nx">gW</span><span class="p">.</span><span class="nx">tableMap</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">b2dSensor</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="nx">Client</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">updateBox2dSensor</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">displace_2d_m</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">b2dSensor</span><span class="p">.</span><span class="nx">SetPosition</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">mouse_2d_m</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span> <span class="nx">displace_2d_m</span><span class="p">));</span>
   <span class="p">}</span>
   <span class="nx">Client</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">deleteBox2dSensor</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">gW</span><span class="p">.</span><span class="nx">tableMap</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">b2dSensor</span><span class="p">);</span>
      <span class="nx">gW</span><span class="p">.</span><span class="nx">world</span><span class="p">.</span><span class="nx">DestroyBody</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">b2dSensor</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">sensorTargetName</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">b2dSensor</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="nx">Client</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">checkForMouseSelection</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="c1">// Process selection attempts and object manipulations.</span>
      <span class="k">if</span> <span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">selectedBody</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">mouseDown</span><span class="p">))</span> <span class="p">{</span>

         <span class="c1">// Check for a body at the mouse position.</span>
         <span class="kd">var</span> <span class="nx">selected_b2d_Body</span> <span class="o">=</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">b2d_getBodyAt</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">mouse_2d_m</span><span class="p">);</span>
         
         <span class="k">if</span> <span class="p">(</span><span class="nx">selected_b2d_Body</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">selectedBody</span> <span class="o">=</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">tableMap</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="nx">selected_b2d_Body</span><span class="p">);</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoVersion</span><span class="p">().</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;3.d&quot;</span><span class="p">)</span> <span class="nx">gB</span><span class="p">.</span><span class="nx">checkForMouseStops</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">selectedBody</span><span class="p">);</span>
            
            <span class="c1">// Tip for editing walls and pins</span>
            <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">editor</span><span class="p">.</span><span class="nx">checked</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">key_ctrl</span> <span class="o">==</span> <span class="s2">&quot;U&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;Wall&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;Pin&quot;</span><span class="p">))</span> <span class="p">)</span> <span class="p">{</span>
               <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s1">&#39;Hold down &quot;ctrl&quot; key to drag walls and pins (host only).&#39;</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">);</span>
            <span class="p">}</span>
            
            <span class="c1">// Block the selection on static bodies (walls and pins) by a network client.</span>
            <span class="k">if</span> <span class="p">(</span> <span class="p">((</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">!=</span> <span class="s2">&quot;Puck&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">!=</span> <span class="s1">&#39;local&#39;</span><span class="p">))</span> <span class="o">||</span> 
                 <span class="c1">// Block wall and pin selection if the wall/pin editor is off.</span>
                 <span class="p">(</span><span class="o">!</span><span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">editor</span><span class="p">.</span><span class="nx">checked</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;Wall&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;Pin&quot;</span><span class="p">)))</span> <span class="p">)</span> <span class="p">{</span>
               
               <span class="nx">selected_b2d_Body</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
               
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
               <span class="c1">// Consider the case where client is trying to edit multiple objects (only shift key is down).</span>
               <span class="k">if</span> <span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">key_shift</span> <span class="o">==</span> <span class="s2">&quot;D&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">key_ctrl</span> <span class="o">==</span> <span class="s2">&quot;U&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">key_alt</span> <span class="o">==</span> <span class="s2">&quot;U&quot;</span><span class="p">))</span> <span class="p">{</span>
                  
                  <span class="c1">// Add this body to the multiple-select map (if not already there).</span>
                  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">name</span> <span class="k">in</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">map</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">button</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
                     <span class="c1">// Record the local selection point on the body.</span>
                     <span class="k">if</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">comSelection</span><span class="p">.</span><span class="nx">checked</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">selectedBody</span><span class="p">.</span><span class="nx">selectionPoint_l_2d_m</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
                     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nx">selectedBody</span><span class="p">.</span><span class="nx">selectionPoint_l_2d_m</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D_from_b2Vec2</span><span class="p">(</span> <span class="nx">selected_b2d_Body</span><span class="p">.</span><span class="nx">GetLocalPoint</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">mouse_2d_m</span><span class="p">));</span>
                     <span class="p">}</span>

                     <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">map</span><span class="p">[</span> <span class="nx">selectedBody</span><span class="p">.</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">selectedBody</span><span class="p">;</span>
                  
                  <span class="c1">// Remove this body from the map if doing a right-button (2) mouse click.</span>
                  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">name</span> <span class="k">in</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">map</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">button</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
                     <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">removeOne</span><span class="p">(</span> <span class="nx">selectedBody</span><span class="p">);</span>
                  <span class="p">}</span>
               
               <span class="c1">// If using the box-selection feature...</span>
               <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s1">&#39;local&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">key_alt</span> <span class="o">==</span> <span class="s2">&quot;D&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">key_ctrl</span> <span class="o">==</span> <span class="s2">&quot;U&quot;</span><span class="p">))</span> <span class="p">{</span>
                  <span class="k">if</span> <span class="p">((</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">name</span> <span class="k">in</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">map</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">button</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
                     <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">removeOne</span><span class="p">(</span> <span class="nx">selectedBody</span><span class="p">);</span>
                  <span class="p">}</span>
               
               <span class="c1">// Normal single-body selection:</span>
               <span class="c1">// Allow single-body pin selection only if the wall/pin editor is on.</span>
               <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="p">(</span> <span class="o">!</span><span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">editor</span><span class="p">.</span><span class="nx">checked</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;Pin&quot;</span><span class="p">)))</span> <span class="p">{</span>
                  <span class="c1">// Which body object has been selected?</span>
                  <span class="k">this</span><span class="p">.</span><span class="nx">selectedBody</span> <span class="o">=</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">tableMap</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="nx">selected_b2d_Body</span><span class="p">);</span>
                  <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">clientName</span><span class="p">)</span> <span class="p">{</span>
                     <span class="kd">var</span> <span class="nx">clientNameString</span> <span class="o">=</span> <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">clientName</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">;</span>
                  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                     <span class="kd">var</span> <span class="nx">clientNameString</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
                  <span class="p">}</span> 
                  
                  <span class="c1">// Mark it as selected and record the local point.</span>
                  <span class="k">this</span><span class="p">.</span><span class="nx">selectionPoint_l_2d_m</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D_from_b2Vec2</span><span class="p">(</span> <span class="nx">selected_b2d_Body</span><span class="p">.</span><span class="nx">GetLocalPoint</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">mouse_2d_m</span><span class="p">));</span>
                  <span class="k">this</span><span class="p">.</span><span class="nx">modifyCursorSpring</span><span class="p">(</span><span class="s1">&#39;attach&#39;</span><span class="p">);</span>
                  
                  <span class="c1">// If selecting a small puck with right-button on mouse, warn user about stability:</span>
                  <span class="k">if</span> <span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">mass_kg</span> <span class="o">&lt;</span> <span class="mf">0.15</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">button</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
                     <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s2">&quot;For a small puck, use the middle or left mouse button.&quot;</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">);</span>
                  <span class="p">}</span>
                  
                  <span class="c1">// If using the control key (deterministic drag or rotation) and there already are</span>
                  <span class="c1">// some bodies in the multi-select, add this body to the multi-select group. This</span>
                  <span class="c1">// insures normal group-rotation behaviors.</span>
                  <span class="k">if</span> <span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">key_ctrl</span> <span class="o">==</span> <span class="s2">&quot;D&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
                     <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">map</span><span class="p">[</span> <span class="nx">selectedBody</span><span class="p">.</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">selectedBody</span><span class="p">;</span>
                  <span class="p">}</span>
               <span class="p">}</span>
            <span class="p">}</span>
         <span class="p">}</span>
      <span class="c1">// The mouse button has been released</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">mouseDown</span><span class="p">))</span> <span class="p">{</span>
         <span class="c1">// Shoot the (single-selected) puck with the cursor spring energy.</span>
         <span class="c1">//if ((this.key_ctrl == &#39;D&#39;) &amp;&amp; (this.key_shift == &#39;D&#39;) &amp;&amp; (this.cursorSpring)) {</span>
         <span class="c1">//   this.poolShot();</span>
         <span class="c1">//   gW.messages[&#39;help&#39;].resetMessage(); // stop the help pool players</span>
         <span class="c1">//}</span>
         <span class="c1">//this.modifyCursorSpring(&#39;dettach&#39;);</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="nx">Client</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">modifyCursorSpring</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">mode</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// If there isn&#39;t already a cursor spring, add one. </span>
      <span class="k">if</span> <span class="p">((</span><span class="nx">mode</span> <span class="o">==</span> <span class="s1">&#39;attach&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">cursorSpring</span><span class="p">))</span> <span class="p">{</span>
         
         <span class="c1">// Local selection point on puck.</span>
         <span class="k">if</span> <span class="p">(</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">comSelection</span><span class="p">.</span><span class="nx">checked</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">key_ctrl</span> <span class="o">==</span> <span class="s2">&quot;D&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">ctrlShiftLock</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">shape</span> <span class="o">!=</span> <span class="s1">&#39;circle&#39;</span><span class="p">))</span> <span class="p">)</span> <span class="p">{</span>
            <span class="c1">// For this special case, make sure the COM control reflects the non-COM action. Without this line, </span>
            <span class="c1">// you would have to click c twice in the basketball game for any of the images that are based on rectangular pucks.</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">ctrlShiftLock</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">shape</span> <span class="o">!=</span> <span class="s1">&#39;circle&#39;</span><span class="p">))</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">comSelection</span><span class="p">.</span><span class="nx">checked</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
            
            <span class="kd">var</span> <span class="nx">selectionPoint_l_2d_m</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">selectionPoint_l_2d_m</span><span class="p">.</span><span class="nx">copy</span><span class="p">();</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">selectionPoint_l_2d_m</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">);</span>
         <span class="p">}</span>
         <span class="cm">/*</span>
<span class="cm">         Always use a normal spring for the cursor (&#39;softConstraints&#39;:false). Have played around with using the distance joints but they</span>
<span class="cm">         seem to have similar instability problems with small masses and strong springs.</span>
<span class="cm">         </span>
<span class="cm">         4:20 PM Tue May 12, 2020: Changed my mind. Going to let the cursor spring type be affected by the toggle (shift-s), took out the softConstraints</span>
<span class="cm">         specification: &#39;softConstraints&#39;:false.</span>
<span class="cm">         </span>
<span class="cm">         11:52 AM Sun May 22, 2022: ...and two years later I&#39;ve restricted it again to be fixed (as Hooke&#39;s Law) and not allow soft constraints. Noticed that in the basketball game</span>
<span class="cm">         the ball drifts when aiming if using a distance joint (soft constraint). The (my) Hooke&#39;s law spring allows me to better inhibit (shut off) the spring forces when aiming</span>
<span class="cm">         under the ctrl-shift-locked conditions. Someday, a better solution, that would allow both spring natures in the cursor spring, is to not actually mount the spring</span>
<span class="cm">         until after the shot is launched (that would be a significant change).</span>
<span class="cm">         */</span>
         <span class="c1">// Note that a cursor spring is created using the client&#39;s name (this.name).</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">cursorSpring</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">cP</span><span class="p">.</span><span class="nx">Spring</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pin</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">,</span> 
            <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">({},</span> <span class="nx">Client</span><span class="p">.</span><span class="nx">mouse_springs</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">button</span><span class="p">],</span> <span class="p">{</span><span class="s1">&#39;spo2_ap_l_2d_m&#39;</span><span class="o">:</span><span class="nx">selectionPoint_l_2d_m</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">color</span><span class="p">,</span> <span class="s1">&#39;forCursor&#39;</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="s1">&#39;softConstraints&#39;</span><span class="o">:</span><span class="kc">false</span><span class="p">})</span> <span class="p">);</span>  
         
         <span class="c1">// High drag_c (the default for button 2) was causing instability for right-button manipulation of the inner pucks in a jello grid.</span>
         <span class="k">if</span> <span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">jello</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">button</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))</span> <span class="k">this</span><span class="p">.</span><span class="nx">cursorSpring</span><span class="p">.</span><span class="nx">drag_c</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">;</span>
         
         <span class="k">if</span> <span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s1">&#39;Puck&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">compoundBodySelected</span><span class="p">()))</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">createBox2dSensor</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">radius_m</span><span class="p">);</span>
         <span class="p">}</span>
         
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="nx">mode</span> <span class="o">==</span> <span class="s1">&#39;dettach&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">cursorSpring</span><span class="p">))</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s1">&#39;Puck&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">b2dSensor</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">deleteBox2dSensor</span><span class="p">();</span>
         <span class="p">}</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">cursorSpring</span><span class="p">.</span><span class="nx">deleteThisOne</span><span class="p">({});</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">cursorSpring</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
         
         <span class="k">this</span><span class="p">.</span><span class="nx">selectionPoint_l_2d_m</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
         
         <span class="k">this</span><span class="p">.</span><span class="nx">selectedBody</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="nx">Client</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">moveSBtoPosition</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">theBody</span><span class="p">,</span> <span class="nx">pos_2d_m</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// move Selected Body to Position</span>
      <span class="nx">theBody</span><span class="p">.</span><span class="nx">position_2d_m</span> <span class="o">=</span> <span class="nx">pos_2d_m</span><span class="p">;</span>
      <span class="nx">theBody</span><span class="p">.</span><span class="nx">position_2d_px</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">screenFromWorld</span><span class="p">(</span> <span class="nx">theBody</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">);</span>
      <span class="nx">theBody</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">SetPosition</span><span class="p">(</span> <span class="nx">pos_2d_m</span><span class="p">);</span>
      <span class="c1">// If it&#39;s a puck, freeze it, for more predictable put-it-here behavior.</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">theBody</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;Puck&quot;</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">theBody</span><span class="p">.</span><span class="nx">velocity_2d_mps</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">);</span>
         <span class="nx">theBody</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">SetLinearVelocity</span><span class="p">(</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">));</span>
         <span class="nx">theBody</span><span class="p">.</span><span class="nx">angularSpeed_rps</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
         <span class="nx">theBody</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">SetAngularVelocity</span><span class="p">(</span> <span class="nx">theBody</span><span class="p">.</span><span class="nx">angularSpeed_rps</span><span class="p">);</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="nx">Client</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">moveToCursorPosition</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="c1">// for direct positioning of objects:</span>
      <span class="c1">// Calculate the world (w) delta between the current mouse position and the original selection point.</span>
      <span class="c1">// The delta is used for positioning (direct dragging of) bodies so that selection points</span>
      <span class="c1">// follows the moving mouse location.</span>
      <span class="kd">var</span> <span class="nx">delta_w_2d_m</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">mouse_2d_m</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">cursorSpring</span><span class="p">.</span><span class="nx">spo2_ap_w_2d_m</span><span class="p">);</span>
      <span class="c1">// Adding the delta to the body position, moves the body so that the original selection point is at the mouse position.</span>
      <span class="kd">var</span> <span class="nx">newPosition_2d_m</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span> <span class="nx">delta_w_2d_m</span><span class="p">);</span>

      <span class="c1">// Before actually moving it, keep track of the calculated amount of movement.</span>
      <span class="kd">var</span> <span class="nx">movement_2d_m</span> <span class="o">=</span> <span class="nx">newPosition_2d_m</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">);</span>
      
      <span class="c1">// Move the single selected body (SB) to the mouse position.</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">moveSBtoPosition</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">,</span> <span class="nx">newPosition_2d_m</span><span class="p">);</span>
      
      <span class="c1">// Temporarily inhibit the external forces on this puck (this prevents a gradual droop when gravity is on).</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;Puck&quot;</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">tempInhibitExtForce</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      
      <span class="c1">// Move all the other selected bodies by a similar amount.</span>
      <span class="c1">// Note: the arrow function, used here, will take &quot;this&quot; from the surrounding context.</span>
      <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span> <span class="nx">tableObj</span> <span class="p">=&gt;</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">tableObj</span> <span class="o">!==</span> <span class="k">this</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">moveSBtoPosition</span><span class="p">(</span> <span class="nx">tableObj</span><span class="p">,</span> <span class="nx">tableObj</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span> <span class="nx">movement_2d_m</span><span class="p">));</span>
         
         <span class="c1">// Temporarily inhibit the external forces on this puck (this prevents a gradual droop when gravity is on).</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">tableObj</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;Puck&quot;</span><span class="p">)</span> <span class="nx">tableObj</span><span class="p">.</span><span class="nx">tempInhibitExtForce</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">});</span>
      
      <span class="c1">// For this cursor-selected object, if one object or less in multi-select, output its position (for walls and pucks) and elasticity characteristics (for pucks);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">count</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">let</span> <span class="nx">bulletString</span> <span class="o">=</span> <span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;Puck&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">bullet</span><span class="p">))</span> <span class="o">?</span> <span class="s2">&quot; (bullet)&quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
         <span class="kd">var</span> <span class="nx">objReport</span> <span class="o">=</span> <span class="s2">&quot;[base,yellow]&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot;[base]&quot;</span> <span class="o">+</span> <span class="nx">bulletString</span> <span class="o">+</span> 
             <span class="s2">&quot; @ x:&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">.</span><span class="nx">x</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="s2">&quot;y:&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">.</span><span class="nx">y</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; m&quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
             <span class="c1">//&quot;, \u03B8_deg:&quot; + (this.selectedBody.b2d.GetAngle() * 180/Math.PI).toFixed(0); </span>
         
         <span class="k">if</span> <span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;Puck&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;Wall&quot;</span><span class="p">))</span> <span class="p">{</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">shape</span> <span class="o">==</span> <span class="s2">&quot;circle&quot;</span><span class="p">)</span> <span class="p">{</span>
               <span class="kd">var</span> <span class="nx">dimensionsReport</span> <span class="o">=</span> <span class="s2">&quot;\\  radius = &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">radius_m</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
               <span class="kd">var</span> <span class="nx">dimensionsReport</span> <span class="o">=</span> <span class="s2">&quot;\\  width/2, height/2 = &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">half_width_m</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">half_height_m</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nx">objReport</span> <span class="o">+=</span> <span class="nx">dimensionsReport</span><span class="p">;</span>
         <span class="p">}</span>
         
         <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;Puck&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">let</span> <span class="nx">rF</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">restitution_fixed</span><span class="p">)</span> <span class="o">?</span> <span class="s2">&quot; (fixed)&quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
            <span class="kd">let</span> <span class="nx">fF</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">friction_fixed</span><span class="p">)</span> <span class="o">?</span> <span class="s2">&quot; (fixed)&quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
            <span class="nx">objReport</span> <span class="o">+=</span> <span class="s2">&quot;\\  restitution = &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">restitution</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="nx">rF</span> <span class="o">+</span> <span class="s2">&quot;, surface friction = &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">friction</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="nx">fF</span> <span class="o">+</span>
                         <span class="s2">&quot;\\  translational, rotational drag = &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">linDamp</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">angDamp</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">imageID</span><span class="p">)</span> <span class="p">{</span>
               <span class="kd">let</span> <span class="nx">img</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">imageID</span><span class="p">);</span>
               <span class="k">if</span> <span class="p">(</span><span class="nx">img</span><span class="p">.</span><span class="nx">title</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">objReport</span> <span class="o">+=</span> <span class="s2">&quot;\\  title = &quot;</span> <span class="o">+</span> <span class="nx">img</span><span class="p">.</span><span class="nx">title</span><span class="p">;</span>
               <span class="p">}</span>
            <span class="p">}</span>
         <span class="p">}</span>
         
         <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span> <span class="nx">objReport</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">);</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="nx">Client</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">rotateSB</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">theBody</span><span class="p">,</span> <span class="nx">delta_angle_r</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">theBody</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;Puck&quot;</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">theBody</span><span class="p">.</span><span class="nx">velocity_2d_mps</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">);</span>
         <span class="nx">theBody</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">SetLinearVelocity</span><span class="p">(</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">));</span>
         <span class="nx">theBody</span><span class="p">.</span><span class="nx">angularSpeed_rps</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
         <span class="nx">theBody</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">SetAngularVelocity</span><span class="p">(</span> <span class="nx">theBody</span><span class="p">.</span><span class="nx">angularSpeed_rps</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="c1">// Everything but pins... If you don&#39;t exclude pins here, they become un-selectable after</span>
      <span class="c1">// a rotation with the editor.</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">theBody</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">!=</span> <span class="s2">&quot;Pin&quot;</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">theBody</span><span class="p">.</span><span class="nx">angle_r</span> <span class="o">+=</span> <span class="nx">delta_angle_r</span><span class="p">;</span>
         <span class="nx">theBody</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">SetAngle</span><span class="p">(</span> <span class="nx">theBody</span><span class="p">.</span><span class="nx">angle_r</span><span class="p">);</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="nx">Client</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">rotateToCursorPosition</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">delta_r</span><span class="p">;</span>
      
      <span class="c1">// Rotate about the center of the group.</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">// Find the center only at the beginning of the rotation action.</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">findCenterEnabled</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">findCenter</span><span class="p">();</span>
            <span class="c1">// Don&#39;t do this again until one of the keys is released.</span>
            <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">findCenterEnabled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
         <span class="p">}</span>
         <span class="c1">// Measure the rotation relative to the center of the group.</span>
         <span class="nx">delta_r</span> <span class="o">=</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">center_2d_m</span><span class="p">.</span><span class="nx">angleBetweenPoints_r</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">cursorSpring</span><span class="p">.</span><span class="nx">spo2_ap_w_2d_m</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">mouse_2d_m</span><span class="p">);</span>
      
         <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span> <span class="nx">tableObj</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="c1">// Rotate the vector that runs from the hostMSelect center out to the object center. </span>
            <span class="kd">var</span> <span class="nx">center_to_center_2d</span> <span class="o">=</span> <span class="nx">tableObj</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">center_2d_m</span><span class="p">);</span>
            <span class="nx">center_to_center_2d</span><span class="p">.</span><span class="nx">rotated_by</span><span class="p">(</span> <span class="nx">delta_r</span> <span class="o">*</span> <span class="mf">180.0</span><span class="o">/</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span> <span class="p">);</span>
            
            <span class="c1">// Then reassemble the object vector and put the object there.</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">moveSBtoPosition</span><span class="p">(</span> <span class="nx">tableObj</span><span class="p">,</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">center_2d_m</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span> <span class="nx">center_to_center_2d</span><span class="p">));</span>
            
            <span class="c1">// Rotate the object about its center.</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">rotateSB</span><span class="p">(</span> <span class="nx">tableObj</span><span class="p">,</span> <span class="nx">delta_r</span><span class="p">);</span>
            
            <span class="c1">// Temporarily inhibit the forces on this puck (this prevents a gradual droop when gravity is on).</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">tableObj</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;Puck&quot;</span><span class="p">)</span> <span class="nx">tableObj</span><span class="p">.</span><span class="nx">tempInhibitExtForce</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
         <span class="p">});</span>
      
      <span class="c1">// Rotate about the center of the single object.</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="c1">// Find the angle formed by these three points (angle based at the center of this selected body). This is the angle formed</span>
         <span class="c1">// as the mouse (and cursor pin) moves from the old selection point. Note must use pin position and not simply the mouse</span>
         <span class="c1">// because the ghost sensor might displace the pin from the cursor.</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">pin</span><span class="p">.</span><span class="nx">getPosition</span><span class="p">();</span>
         <span class="c1">// Rotate, if not attached to the center of the puck...</span>
         <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">cursorSpring</span><span class="p">.</span><span class="nx">spo2_ap_l_2d_m</span><span class="p">.</span><span class="nx">zeroLength</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">delta_r</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">.</span><span class="nx">angleBetweenPoints_r</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">cursorSpring</span><span class="p">.</span><span class="nx">spo2_ap_w_2d_m</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">pin</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">);</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">delta_r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
         <span class="p">}</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">rotateSB</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">,</span> <span class="nx">delta_r</span><span class="p">);</span>  
         
         <span class="c1">// Temporarily inhibit the forces on this puck (this prevents a gradual droop when gravity is on).</span>
         <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;Puck&quot;</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">tempInhibitExtForce</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="nx">Client</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">rotateEachAboutItself</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">delta_r</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">.</span><span class="nx">angleBetweenPoints_r</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">cursorSpring</span><span class="p">.</span><span class="nx">spo2_ap_w_2d_m</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">mouse_2d_m</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span> <span class="nx">tableObj</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="c1">// Don&#39;t allow group rotation based on pin selection (avoid wall spinning).</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">!=</span> <span class="s2">&quot;Pin&quot;</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">rotateSB</span><span class="p">(</span><span class="nx">tableObj</span><span class="p">,</span> <span class="nx">delta_r</span><span class="p">);</span>
            
            <span class="c1">// Temporarily inhibit the forces on this puck (this prevents a gradual droop when gravity is on).</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">tableObj</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;Puck&quot;</span><span class="p">)</span> <span class="nx">tableObj</span><span class="p">.</span><span class="nx">tempInhibitExtForce</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
         <span class="p">});</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">rotateSB</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">,</span> <span class="nx">delta_r</span><span class="p">);</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="nx">Client</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">drawTriangle</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">drawingContext</span><span class="p">,</span> <span class="nx">position_2d_px</span><span class="p">,</span> <span class="nx">pars</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Draw a triangle for the network client&#39;s cursor at position_2d_px</span>

      <span class="kd">var</span> <span class="nx">fillIt</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">fillIt</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">fillColor</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">fillColor</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">);</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">triangle_2d_px</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="kd">var</span> <span class="nx">cursorOffset_2d_px</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span> <span class="c1">//tweak the positioning of the cursor.</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">len</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">triangle_raw_2d_px</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">// Put it at the mouse position: mouse + triangle-vertex + offset. </span>
         <span class="kd">var</span> <span class="nx">p_2d_px</span> <span class="o">=</span> <span class="nx">position_2d_px</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">triangle_raw_2d_px</span><span class="p">[</span><span class="nx">i</span><span class="p">]).</span><span class="nx">add</span><span class="p">(</span> <span class="nx">cursorOffset_2d_px</span><span class="p">);</span>
         <span class="c1">// Put it in the triangle array.</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">triangle_2d_px</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">p_2d_px</span><span class="p">);</span>
      <span class="p">}</span>
      
      <span class="kd">var</span> <span class="nx">fillColor</span> <span class="o">=</span> <span class="p">(</span><span class="nx">drawingContext</span><span class="p">.</span><span class="nx">globalCompositeOperation</span> <span class="o">==</span> <span class="s1">&#39;screen&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;white&#39;</span> <span class="o">:</span> <span class="nx">fillColor</span><span class="p">;</span> <span class="c1">// white for color mixing demo</span>
      <span class="k">if</span> <span class="p">(</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">getPauseErase</span><span class="p">())</span> <span class="o">||</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">getLagTesting</span><span class="p">())</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">drawPolygon</span><span class="p">(</span> <span class="nx">drawingContext</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">triangle_2d_px</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;borderColor&#39;</span><span class="o">:</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="s1">&#39;borderWidth_px&#39;</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;fillIt&#39;</span><span class="o">:</span><span class="nx">fillIt</span> <span class="p">,</span><span class="s1">&#39;fillColor&#39;</span><span class="o">:</span><span class="nx">fillColor</span><span class="p">});</span>
         
         <span class="c1">// Use cursor speed to calculate a radius at 2-frames out from the rendered cursor. Useful for quantifying the lag behind the system cursor.</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">getLagTesting</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">fineMovesState</span> <span class="o">==</span> <span class="s1">&#39;off&#39;</span><span class="p">))</span> <span class="p">{</span>
            <span class="kd">let</span> <span class="nx">cursorSpeed_pxps</span> <span class="o">=</span> <span class="nx">position_2d_px</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">prev_mouse_2d_px</span><span class="p">).</span><span class="nx">length</span><span class="p">()</span> <span class="o">/</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">getDeltaT_s</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">cursorSpeed_pxps</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">cursorSpeed_pxps</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
            <span class="kd">let</span> <span class="nx">cursorSpeed_ra_pxps</span> <span class="o">=</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">cursorSpeed_pxps</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span> <span class="nx">cursorSpeed_pxps</span><span class="p">);</span>
            <span class="kd">let</span> <span class="nx">radiusFor2FrameLag_px</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">getDeltaT_s</span><span class="p">()</span> <span class="o">*</span> <span class="nx">cursorSpeed_ra_pxps</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">getPauseErase</span><span class="p">())</span> <span class="k">this</span><span class="p">.</span><span class="nx">drawCircle</span><span class="p">(</span> <span class="nx">drawingContext</span><span class="p">,</span> <span class="nx">position_2d_px</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;borderWidth_px&#39;</span><span class="o">:</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;fillColor&#39;</span><span class="o">:</span><span class="s1">&#39;noFill&#39;</span><span class="p">,</span> <span class="s1">&#39;radius_px&#39;</span><span class="o">:</span><span class="nx">radiusFor2FrameLag_px</span><span class="p">});</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="nx">Client</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">compoundBodySelected</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">(</span> <span class="nx">cP</span><span class="p">.</span><span class="nx">Spring</span><span class="p">.</span><span class="nx">checkIfAttached</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="o">||</span> <span class="nx">cP</span><span class="p">.</span><span class="nx">Joint</span><span class="p">.</span><span class="nx">checkIfAttached</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="p">);</span>
   <span class="p">}</span>
   <span class="nx">Client</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">updateCursor</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">mouse_2d_m</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">worldFromScreen</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">mouse_2d_px</span><span class="p">);</span>   
      
      <span class="kd">var</span> <span class="nx">tryingToShoot_locked</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">ctrlShiftLock</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">key_ctrl</span> <span class="o">==</span> <span class="s2">&quot;U&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">key_shift</span> <span class="o">==</span> <span class="s2">&quot;U&quot;</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">tryingToShoot</span> <span class="o">=</span> <span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">key_ctrl</span> <span class="o">==</span> <span class="s2">&quot;D&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">key_shift</span> <span class="o">==</span> <span class="s2">&quot;D&quot;</span><span class="p">))</span> <span class="o">||</span> <span class="nx">tryingToShoot_locked</span><span class="p">;</span>
      
      <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">cursorSpring</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s1">&#39;Puck&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">tryingToShoot</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">compoundBodySelected</span><span class="p">()</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
         <span class="nx">gB</span><span class="p">.</span><span class="nx">updateGhostBall</span><span class="p">(</span> <span class="k">this</span><span class="p">);</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">gBS</span><span class="p">.</span><span class="nx">readyToDraw</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pin</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">pin</span><span class="p">.</span><span class="nx">setPosition</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">mouse_2d_m</span><span class="p">);</span>
      <span class="p">}</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">cursorSpring</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">cursorSpring</span><span class="p">.</span><span class="nx">updateEndPoints</span><span class="p">();</span>
   <span class="p">}</span>
   <span class="nx">Client</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">drawCursor</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">drawingContext</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">mouseDown</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">key_shift</span> <span class="o">==</span> <span class="s2">&quot;D&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">key_alt</span> <span class="o">==</span> <span class="s2">&quot;D&quot;</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">pin</span><span class="p">.</span><span class="nx">draw_MultiSelectPoint</span><span class="p">(</span> <span class="nx">drawingContext</span><span class="p">);</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">pin</span><span class="p">.</span><span class="nx">draw</span><span class="p">(</span> <span class="nx">drawingContext</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span> <span class="c1">// 4px radius</span>
         <span class="p">}</span>
      <span class="p">}</span>
      <span class="c1">// This shows the actual position of the cursor when fineMoves is active. </span>
      <span class="c1">// This appears as a light-gray outline (no fill) and separate from the normal cursor (drawn next).</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">fineMovesState</span> <span class="o">!=</span> <span class="s1">&#39;off&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">drawingContext</span><span class="p">.</span><span class="nx">globalAlpha</span> <span class="o">=</span> <span class="mf">0.70</span><span class="p">;</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">drawTriangle</span><span class="p">(</span> <span class="nx">drawingContext</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">prevNormalCursorPosOnCanvas_2d_px</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;fillIt&#39;</span><span class="o">:</span><span class="kc">false</span><span class="p">});</span>
         <span class="nx">drawingContext</span><span class="p">.</span><span class="nx">globalAlpha</span> <span class="o">=</span> <span class="mf">1.00</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="c1">// Normal cursor rendering</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">drawTriangle</span><span class="p">(</span> <span class="nx">drawingContext</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">mouse_2d_px</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;fillColor&#39;</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">color</span><span class="p">});</span>
   <span class="p">}</span>  
   <span class="nx">Client</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">updateSelectionPoint</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="c1">// Calculate (update) the world location of the attachment point for use in force calculations.</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">cursorSpring</span><span class="p">.</span><span class="nx">spo2_ap_w_2d_m</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D_from_b2Vec2</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">GetWorldPoint</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">cursorSpring</span><span class="p">.</span><span class="nx">spo2_ap_l_2d_m</span><span class="p">));</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">cursorSpring</span><span class="p">.</span><span class="nx">spo2_ap_w_2d_px</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">screenFromWorld</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">cursorSpring</span><span class="p">.</span><span class="nx">spo2_ap_w_2d_m</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="nx">Client</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">drawSelectionPoint</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">drawingContext</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Draw small circle at the attachment point.</span>
      <span class="kd">var</span> <span class="nx">fillColor</span> <span class="o">=</span> <span class="p">(</span><span class="nx">drawingContext</span><span class="p">.</span><span class="nx">globalCompositeOperation</span> <span class="o">==</span> <span class="s1">&#39;screen&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">color</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">color</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">getPauseErase</span><span class="p">())</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">drawCircle</span><span class="p">(</span> <span class="nx">drawingContext</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">cursorSpring</span><span class="p">.</span><span class="nx">spo2_ap_w_2d_px</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;borderColor&#39;</span><span class="o">:</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="s1">&#39;borderWidth_px&#39;</span><span class="o">:</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;fillColor&#39;</span><span class="o">:</span><span class="nx">fillColor</span><span class="p">,</span> <span class="s1">&#39;radius_px&#39;</span><span class="o">:</span><span class="mi">6</span><span class="p">});</span>  <span class="c1">// 6</span>
      <span class="p">}</span>
   <span class="p">}</span>
  
  
   
   <span class="c1">// Reveal these methods to the global windows scope.</span>
   
   <span class="k">return</span> <span class="p">{</span>
      <span class="c1">// Objects</span>
      <span class="nx">Client</span><span class="o">:</span> <span class="nx">Client</span><span class="p">,</span>
      
      <span class="c1">// Variables</span>
      
      <span class="c1">// Methods</span>
      
   <span class="p">};</span>   
   
<span class="p">})();</span>
</pre></div>
</body>
</html>
