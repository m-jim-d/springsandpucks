<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">
<!--
generated by Pygments <https://pygments.org/>
Copyright 2006-2025 by the Pygments team.
Licensed under the BSD license, see LICENSE for details.
-->
<html>
<head>
  <link rel='canonical' href='https://triquence.org/server_old.js.html' />
  <title>server_old.js</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <style type="text/css">
/*
generated by Pygments <https://pygments.org/>
Copyright 2006-2025 by the Pygments team.
Licensed under the BSD license, see LICENSE for details.
*/
pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
body .hll { background-color: #ffffcc }
body { background: #f8f8f8; }
body .c { color: #3D7B7B; font-style: italic } /* Comment */
body .err { border: 1px solid #F00 } /* Error */
body .k { color: #008000; font-weight: bold } /* Keyword */
body .o { color: #666 } /* Operator */
body .ch { color: #3D7B7B; font-style: italic } /* Comment.Hashbang */
body .cm { color: #3D7B7B; font-style: italic } /* Comment.Multiline */
body .cp { color: #9C6500 } /* Comment.Preproc */
body .cpf { color: #3D7B7B; font-style: italic } /* Comment.PreprocFile */
body .c1 { color: #3D7B7B; font-style: italic } /* Comment.Single */
body .cs { color: #3D7B7B; font-style: italic } /* Comment.Special */
body .gd { color: #A00000 } /* Generic.Deleted */
body .ge { font-style: italic } /* Generic.Emph */
body .ges { font-weight: bold; font-style: italic } /* Generic.EmphStrong */
body .gr { color: #E40000 } /* Generic.Error */
body .gh { color: #000080; font-weight: bold } /* Generic.Heading */
body .gi { color: #008400 } /* Generic.Inserted */
body .go { color: #717171 } /* Generic.Output */
body .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
body .gs { font-weight: bold } /* Generic.Strong */
body .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
body .gt { color: #04D } /* Generic.Traceback */
body .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
body .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
body .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
body .kp { color: #008000 } /* Keyword.Pseudo */
body .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
body .kt { color: #B00040 } /* Keyword.Type */
body .m { color: #666 } /* Literal.Number */
body .s { color: #BA2121 } /* Literal.String */
body .na { color: #687822 } /* Name.Attribute */
body .nb { color: #008000 } /* Name.Builtin */
body .nc { color: #00F; font-weight: bold } /* Name.Class */
body .no { color: #800 } /* Name.Constant */
body .nd { color: #A2F } /* Name.Decorator */
body .ni { color: #717171; font-weight: bold } /* Name.Entity */
body .ne { color: #CB3F38; font-weight: bold } /* Name.Exception */
body .nf { color: #00F } /* Name.Function */
body .nl { color: #767600 } /* Name.Label */
body .nn { color: #00F; font-weight: bold } /* Name.Namespace */
body .nt { color: #008000; font-weight: bold } /* Name.Tag */
body .nv { color: #19177C } /* Name.Variable */
body .ow { color: #A2F; font-weight: bold } /* Operator.Word */
body .w { color: #BBB } /* Text.Whitespace */
body .mb { color: #666 } /* Literal.Number.Bin */
body .mf { color: #666 } /* Literal.Number.Float */
body .mh { color: #666 } /* Literal.Number.Hex */
body .mi { color: #666 } /* Literal.Number.Integer */
body .mo { color: #666 } /* Literal.Number.Oct */
body .sa { color: #BA2121 } /* Literal.String.Affix */
body .sb { color: #BA2121 } /* Literal.String.Backtick */
body .sc { color: #BA2121 } /* Literal.String.Char */
body .dl { color: #BA2121 } /* Literal.String.Delimiter */
body .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
body .s2 { color: #BA2121 } /* Literal.String.Double */
body .se { color: #AA5D1F; font-weight: bold } /* Literal.String.Escape */
body .sh { color: #BA2121 } /* Literal.String.Heredoc */
body .si { color: #A45A77; font-weight: bold } /* Literal.String.Interpol */
body .sx { color: #008000 } /* Literal.String.Other */
body .sr { color: #A45A77 } /* Literal.String.Regex */
body .s1 { color: #BA2121 } /* Literal.String.Single */
body .ss { color: #19177C } /* Literal.String.Symbol */
body .bp { color: #008000 } /* Name.Builtin.Pseudo */
body .fm { color: #00F } /* Name.Function.Magic */
body .vc { color: #19177C } /* Name.Variable.Class */
body .vg { color: #19177C } /* Name.Variable.Global */
body .vi { color: #19177C } /* Name.Variable.Instance */
body .vm { color: #19177C } /* Name.Variable.Magic */
body .il { color: #666 } /* Literal.Number.Integer.Long */

  </style>
</head>
<body>
<h2></h2>

<div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm">Copyright 2022 James D. Miller</span>

<span class="cm">Permission is hereby granted, free of charge, to any person obtaining a copy</span>
<span class="cm">of this software and associated documentation files (the &quot;Software&quot;), to deal</span>
<span class="cm">in the Software without restriction, including without limitation the rights</span>
<span class="cm">to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
<span class="cm">copies of the Software, and to permit persons to whom the Software is</span>
<span class="cm">furnished to do so, subject to the following conditions:</span>

<span class="cm">The above copyright notice and this permission notice shall be included in all</span>
<span class="cm">copies or substantial portions of the Software.</span>

<span class="cm">THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="cm">IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="cm">FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
<span class="cm">AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<span class="cm">LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span>
<span class="cm">OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="cm">SOFTWARE.</span>
<span class="cm">*/</span>

<span class="c1">// Node Server Script</span>
<span class="c1">// server.js</span>
<span class="w">   </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;server.js 0.0&#39;</span><span class="p">);</span>
<span class="c1">// 10:52 AM Thu January 25, 2024</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">)();</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">http</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">).</span><span class="nx">Server</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span>
<span class="kd">let</span><span class="w"> </span><span class="nx">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;cors&#39;</span><span class="o">:</span><span class="p">{</span><span class="s1">&#39;origin&#39;</span><span class="o">:</span><span class="s1">&#39;*&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;credentials&#39;</span><span class="o">:</span><span class="kc">false</span><span class="p">}</span><span class="w"> </span><span class="p">};</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;socket.io&#39;</span><span class="p">)(</span><span class="nx">http</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PORT</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">3000</span><span class="p">;</span><span class="w"> </span><span class="c1">// 3000 or 3443</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="c1">// In a browser, if you set the URL to localhost:3000, you&#39;ll get this page:</span>
<span class="w">   </span><span class="nx">res</span><span class="p">.</span><span class="nx">sendFile</span><span class="p">(</span><span class="w"> </span><span class="s1">&#39;links.html&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;root&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;.&#39;</span><span class="p">}</span><span class="w"> </span><span class="p">);</span><span class="w">   </span>
<span class="p">});</span>

<span class="c1">// Put various client data (cD) and maps in a global.</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">cD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="nx">cD</span><span class="p">.</span><span class="nx">connectionIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="nx">cD</span><span class="p">.</span><span class="nx">nameIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>

<span class="c1">// Map: userName[ socket.id]</span>
<span class="nx">cD</span><span class="p">.</span><span class="nx">userName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="nx">cD</span><span class="p">.</span><span class="nx">nickName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="nx">cD</span><span class="p">.</span><span class="nx">teamName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>

<span class="c1">// Map: id[ userName]</span>
<span class="nx">cD</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>

<span class="c1">// Map: room[ socket.id], i.e. roomName</span>
<span class="nx">cD</span><span class="p">.</span><span class="nx">room</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>

<span class="c1">// Map: hostID[ roomName]</span>
<span class="nx">cD</span><span class="p">.</span><span class="nx">hostID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>

<span class="c1">// After restarting the server, send info to all remaining connections.</span>
<span class="nx">setTimeout</span><span class="p">(</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="nx">io</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;chat message&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;The server has started, restarted, or has been awakened. &lt;br&gt;&lt;br&gt;&quot;</span><span class="w"> </span><span class="o">+</span>
<span class="w">                           </span><span class="s2">&quot;If this is a restart, it&#39;s possible that all prior connections will reconnect automatically, or you may only need to press the connect button. &lt;br&gt;&lt;br&gt;&quot;</span><span class="w"> </span><span class="o">+</span>
<span class="w">                           </span><span class="s2">&quot;If there are problems, clients and hosts should refresh their pages. Hosts should indicate rooms and reconnect. Then clients should reconnect to those rooms.&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;info sent to clients: server has restarted&quot;</span><span class="p">);</span>
<span class="p">},</span><span class="w"> </span><span class="mf">5000</span><span class="p">);</span>

<span class="c1">// Miscellaneous support functions...</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">setDefault</span><span class="p">(</span><span class="w"> </span><span class="nx">theValue</span><span class="p">,</span><span class="w"> </span><span class="nx">theDefault</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="c1">// Return the default if the value is undefined.</span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">theValue</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s2">&quot;undefined&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">theValue</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">theDefault</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">removeUserFromMaps</span><span class="p">(</span><span class="w"> </span><span class="nx">clientID</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="c1">// Do this first, before removing this user from the maps.</span>
<span class="w">   </span><span class="c1">// Check to see if this is the host.</span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">hostID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">hostID</span><span class="p">[</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">room</span><span class="p">[</span><span class="w"> </span><span class="nx">clientID</span><span class="p">]];</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hostID</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">clientID</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="ow">delete</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">hostID</span><span class="p">[</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">room</span><span class="p">[</span><span class="w"> </span><span class="nx">clientID</span><span class="p">]];</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="c1">// In a similar way, make use of the userName map before removing the user from userName.</span>
<span class="w">   </span><span class="ow">delete</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">id</span><span class="p">[</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">userName</span><span class="p">[</span><span class="w"> </span><span class="nx">clientID</span><span class="p">]];</span>
<span class="w">   </span><span class="ow">delete</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">userName</span><span class="p">[</span><span class="w"> </span><span class="nx">clientID</span><span class="p">];</span>
<span class="w">   </span>
<span class="w">   </span><span class="c1">// Not every user will have a nick name.</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">cD</span><span class="p">.</span><span class="nx">nickName</span><span class="p">[</span><span class="w"> </span><span class="nx">clientID</span><span class="p">])</span><span class="w"> </span><span class="ow">delete</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">nickName</span><span class="p">[</span><span class="w"> </span><span class="nx">clientID</span><span class="p">];</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">cD</span><span class="p">.</span><span class="nx">teamName</span><span class="p">[</span><span class="w"> </span><span class="nx">clientID</span><span class="p">])</span><span class="w"> </span><span class="ow">delete</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">teamName</span><span class="p">[</span><span class="w"> </span><span class="nx">clientID</span><span class="p">];</span>
<span class="w">   </span>
<span class="w">   </span><span class="c1">// The room map was used above. Now it&#39;s ok to remove the user from the room map.</span>
<span class="w">   </span><span class="ow">delete</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">room</span><span class="p">[</span><span class="w"> </span><span class="nx">clientID</span><span class="p">];</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">setDisplayName</span><span class="p">(</span><span class="w"> </span><span class="nx">clientID</span><span class="p">,</span><span class="w"> </span><span class="nx">mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">displayNameString</span><span class="p">,</span><span class="w"> </span><span class="nx">userName</span><span class="p">;</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">hostID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">hostID</span><span class="p">[</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">room</span><span class="p">[</span><span class="w"> </span><span class="nx">clientID</span><span class="p">]];</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hostID</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">clientID</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">userName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;host&#39;</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">userName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">userName</span><span class="p">[</span><span class="w"> </span><span class="nx">clientID</span><span class="p">];</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">cD</span><span class="p">.</span><span class="nx">nickName</span><span class="p">[</span><span class="w"> </span><span class="nx">clientID</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">teamString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">cD</span><span class="p">.</span><span class="nx">teamName</span><span class="p">[</span><span class="w"> </span><span class="nx">clientID</span><span class="p">])</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s2">&quot;.&quot;</span><span class="o">+</span><span class="nx">cD</span><span class="p">.</span><span class="nx">teamName</span><span class="p">[</span><span class="w"> </span><span class="nx">clientID</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">;</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;comma&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">displayNameString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">nickName</span><span class="p">[</span><span class="w"> </span><span class="nx">clientID</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">teamString</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;, &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">userName</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;prens&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">displayNameString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">nickName</span><span class="p">[</span><span class="w"> </span><span class="nx">clientID</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">teamString</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39; (&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">userName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;)&#39;</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">displayNameString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">userName</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="nx">displayNameString</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">connectionInfo</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="kd">let</span><span class="w"> </span><span class="nx">infoStr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;sockets=&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">io</span><span class="p">.</span><span class="nx">engine</span><span class="p">.</span><span class="nx">clientsCount</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;, connection acts=&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">connectionIndex</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">                    </span><span class="s1">&#39;, names=&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">userName</span><span class="p">).</span><span class="nx">length</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;, nick names=&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">nickName</span><span class="p">).</span><span class="nx">length</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">                    </span><span class="s1">&#39;, team names=&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">teamName</span><span class="p">).</span><span class="nx">length</span><span class="p">;</span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="nx">infoStr</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">nameReport</span><span class="p">(</span><span class="w"> </span><span class="nx">names</span><span class="p">,</span><span class="w"> </span><span class="nx">socket_id_target</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="kd">let</span><span class="w"> </span><span class="nx">nickNameList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">nickNameArray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">   </span><span class="kd">let</span><span class="w"> </span><span class="nx">teamNameList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">teamNameArray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">   </span><span class="kd">let</span><span class="w"> </span><span class="nx">teamMemberCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">   </span>
<span class="w">   </span><span class="c1">// Remove trailing numbers.</span>
<span class="w">   </span><span class="kd">let</span><span class="w"> </span><span class="nx">nickNameNoNumbers</span><span class="p">,</span><span class="w"> </span><span class="nx">teamNameNoNumbers</span><span class="p">;</span>
<span class="w">   </span><span class="nx">nickNameNoNumbers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">names</span><span class="p">.</span><span class="nx">nickName</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\d+$/</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">names</span><span class="p">.</span><span class="nx">teamName</span><span class="p">)</span><span class="w"> </span><span class="nx">teamNameNoNumbers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">names</span><span class="p">.</span><span class="nx">teamName</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\d+$/</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">);</span>
<span class="w">   </span>
<span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">socket_id</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">userName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">nickNameRaw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">nickName</span><span class="p">[</span><span class="w"> </span><span class="nx">socket_id</span><span class="p">];</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">nickNameRaw</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">nickNameRaw</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="w"> </span><span class="nx">nickNameNoNumbers</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">nickNameArray</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="w"> </span><span class="nx">nickNameRaw</span><span class="p">))</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="c1">// Use socket_id_target to identify current user (to be bold). Better than using names; server increments similar nicknames.</span>
<span class="w">         </span><span class="kd">let</span><span class="w"> </span><span class="nx">nickNameFormatted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">socket_id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">socket_id_target</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s2">&quot;&lt;strong&gt;&quot;</span><span class="o">+</span><span class="w"> </span><span class="nx">nickNameRaw</span><span class="w"> </span><span class="o">+</span><span class="s2">&quot;&lt;/strong&gt;&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">nickNameRaw</span><span class="p">;</span>
<span class="w">         </span><span class="nx">nickNameList</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">nickNameFormatted</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;, &quot;</span><span class="p">;</span>
<span class="w">         </span><span class="nx">nickNameArray</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="w"> </span><span class="nx">nickNameRaw</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">teamNameRaw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">teamName</span><span class="p">[</span><span class="w"> </span><span class="nx">socket_id</span><span class="p">];</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">names</span><span class="p">.</span><span class="nx">teamName</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">teamNameRaw</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">names</span><span class="p">.</span><span class="nx">teamName</span><span class="p">))</span><span class="w"> </span><span class="nx">teamMemberCount</span><span class="o">++</span><span class="p">;</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">teamNameRaw</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">teamNameRaw</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="w"> </span><span class="nx">teamNameNoNumbers</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">teamNameArray</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="w"> </span><span class="nx">teamNameRaw</span><span class="p">))</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="c1">// Use names.teamName to identify current user (socket_id_target would also work).</span>
<span class="w">         </span><span class="kd">let</span><span class="w"> </span><span class="nx">teamNameFormatted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">teamNameRaw</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">names</span><span class="p">.</span><span class="nx">teamName</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s2">&quot;&lt;strong&gt;&quot;</span><span class="o">+</span><span class="w"> </span><span class="nx">teamNameRaw</span><span class="w"> </span><span class="o">+</span><span class="s2">&quot;&lt;/strong&gt;&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">teamNameRaw</span><span class="p">;</span>
<span class="w">         </span><span class="nx">teamNameList</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">teamNameFormatted</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;, &quot;</span><span class="p">;</span>
<span class="w">         </span><span class="nx">teamNameArray</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="w"> </span><span class="nx">teamNameRaw</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="nx">nickNameList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">nickNameList</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="o">-</span><span class="mf">2</span><span class="p">);</span>
<span class="w">   </span><span class="nx">teamNameList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">teamNameList</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="o">-</span><span class="mf">2</span><span class="p">);</span>
<span class="w">   </span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;nickName&#39;</span><span class="o">:</span><span class="nx">nickNameList</span><span class="p">,</span><span class="s1">&#39;teamName&#39;</span><span class="o">:</span><span class="nx">teamNameList</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;teamMemberCount&#39;</span><span class="o">:</span><span class="nx">teamMemberCount</span><span class="p">};</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">roomReport</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="kd">let</span><span class="w"> </span><span class="nx">usersByRoom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">connectionInfo</span><span class="p">();</span>
<span class="w">   </span>
<span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">roomInMap</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">hostID</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">usersByRoom</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s2">&quot;&lt;br&gt;clients in &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">roomInMap</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot; = &quot;</span><span class="p">;</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">socket_id</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">userName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="kd">let</span><span class="w"> </span><span class="nx">userName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">userName</span><span class="p">[</span><span class="w"> </span><span class="nx">socket_id</span><span class="p">];</span>
<span class="w">         </span><span class="kd">let</span><span class="w"> </span><span class="nx">userNickName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">nickName</span><span class="p">[</span><span class="w"> </span><span class="nx">socket_id</span><span class="p">];</span>
<span class="w">         </span><span class="kd">let</span><span class="w"> </span><span class="nx">userTeamName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">teamName</span><span class="p">[</span><span class="w"> </span><span class="nx">socket_id</span><span class="p">];</span>
<span class="w">         </span><span class="kd">let</span><span class="w"> </span><span class="nx">teamString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">userTeamName</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s2">&quot;.&quot;</span><span class="o">+</span><span class="nx">userTeamName</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">;</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">cD</span><span class="p">.</span><span class="nx">room</span><span class="p">[</span><span class="w"> </span><span class="nx">socket_id</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">roomInMap</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// if this name is the host&#39;s name</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">userName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">userName</span><span class="p">[</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">hostID</span><span class="p">[</span><span class="w"> </span><span class="nx">roomInMap</span><span class="p">]])</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">userNickName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="nx">usersByRoom</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">userName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;(h-&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">userNickName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">teamString</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;), &quot;</span><span class="p">;</span>
<span class="w">               </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="nx">usersByRoom</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">userName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;(h), &quot;</span><span class="p">;</span>
<span class="w">               </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">userNickName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="nx">usersByRoom</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">userName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;(&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">userNickName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">teamString</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;), &quot;</span><span class="p">;</span>
<span class="w">               </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="nx">usersByRoom</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">userName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;, &quot;</span><span class="p">;</span>
<span class="w">               </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="c1">// remove the trailing &quot;, &quot;</span>
<span class="w">      </span><span class="nx">usersByRoom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">usersByRoom</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">2</span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="nx">usersByRoom</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// not using this currently...</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">highestNameNumber</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="kd">let</span><span class="w"> </span><span class="nx">maxNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">userName</span><span class="p">).</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">socket_id</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">userName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="kd">let</span><span class="w"> </span><span class="nx">userName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">userName</span><span class="p">[</span><span class="w"> </span><span class="nx">socket_id</span><span class="p">];</span>
<span class="w">         </span><span class="c1">// remove the leading &quot;u&quot; in the name</span>
<span class="w">         </span><span class="kd">let</span><span class="w"> </span><span class="nx">numberInName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">userName</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">1</span><span class="p">);</span>
<span class="w">         </span><span class="nx">maxNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="w"> </span><span class="nx">numberInName</span><span class="p">,</span><span class="w"> </span><span class="nx">maxNumber</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="nx">maxNumber</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">nameInUse</span><span class="p">(</span><span class="w"> </span><span class="nx">nameToCheck</span><span class="p">,</span><span class="w"> </span><span class="nx">nameMap</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="kd">let</span><span class="w"> </span><span class="nx">nameInUse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">socket_id</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">nameMap</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">nameMap</span><span class="p">[</span><span class="w"> </span><span class="nx">socket_id</span><span class="p">];</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">nameToCheck</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">nameInUse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="nx">nameInUse</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">disconnectClientsInOneRoom</span><span class="p">(</span><span class="w"> </span><span class="nx">roomName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">socket_id</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">userName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">userName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">userName</span><span class="p">[</span><span class="w"> </span><span class="nx">socket_id</span><span class="p">];</span>
<span class="w">      </span><span class="c1">// apply to users in the room, but not the room host...</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="nx">cD</span><span class="p">.</span><span class="nx">room</span><span class="p">[</span><span class="w"> </span><span class="nx">socket_id</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">roomName</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">userName</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">userName</span><span class="p">[</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">hostID</span><span class="p">[</span><span class="w"> </span><span class="nx">roomName</span><span class="p">]])</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="kd">let</span><span class="w"> </span><span class="nx">pars</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="o">:</span><span class="nx">userName</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;originator&#39;</span><span class="o">:</span><span class="s1">&#39;host&#39;</span><span class="p">};</span>
<span class="w">         </span><span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="w"> </span><span class="nx">socket_id</span><span class="p">).</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;disconnectByServer&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">pars</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// This one is only used when debugging (see commented call)</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">disconnectClientsInAllRooms</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">roomInMap</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">hostID</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">disconnectClientsInOneRoom</span><span class="p">(</span><span class="w"> </span><span class="nx">roomInMap</span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Socket.io stuff...</span>

<span class="nx">http</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="w"> </span><span class="nx">port</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;listening on *:&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">port</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">io</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">socket</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="c1">// Showing the usage of the auth object if it is sent in the connection attempt from the client.</span>
<span class="w">   </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Connection starting...&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;mode=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">auth</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">               </span><span class="s2">&quot;, currentName=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">auth</span><span class="p">[</span><span class="s1">&#39;currentName&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">               </span><span class="s2">&quot;, nickName=&quot;</span><span class="w">    </span><span class="o">+</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">auth</span><span class="p">[</span><span class="s1">&#39;nickName&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">               </span><span class="s2">&quot;, teamName=&quot;</span><span class="w">    </span><span class="o">+</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">auth</span><span class="p">[</span><span class="s1">&#39;teamName&#39;</span><span class="p">]</span><span class="w"> </span><span class="p">);</span>
<span class="w">   </span>
<span class="w">   </span><span class="nx">cD</span><span class="p">.</span><span class="nx">connectionIndex</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">   </span>
<span class="w">   </span><span class="c1">// Normal initial connection</span>
<span class="w">   </span><span class="c1">// Note that the host is always in normal mode.</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">auth</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;normal&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Increment until find a name that&#39;s not in use.</span>
<span class="w">      </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">cD</span><span class="p">.</span><span class="nx">nameIndex</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">user_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;u&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">nameIndex</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nx">nameInUse</span><span class="p">(</span><span class="w"> </span><span class="nx">user_name</span><span class="p">,</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">userName</span><span class="p">));</span>
<span class="w">      </span>
<span class="w">   </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">auth</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;re-connect&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// If re-connecting, re-use the current user name that comes in via the auth object.</span>
<span class="w">      </span><span class="c1">// Re-connection happens only when the client is starting a stream or when the P2P connection makes a second attempt.</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">user_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">auth</span><span class="p">[</span><span class="s1">&#39;currentName&#39;</span><span class="p">];</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">nick_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">setDefault</span><span class="p">(</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">auth</span><span class="p">[</span><span class="s1">&#39;nickName&#39;</span><span class="p">],</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// Differentiate nicknames in use by multiple clients by appending the user number (slice off the u).</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">nick_name</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">nameInUse</span><span class="p">(</span><span class="w"> </span><span class="nx">nick_name</span><span class="p">,</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">nickName</span><span class="p">))</span><span class="w"> </span><span class="nx">nick_name</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">user_name</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">1</span><span class="p">);</span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">team_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">setDefault</span><span class="p">(</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">handshake</span><span class="p">.</span><span class="nx">auth</span><span class="p">[</span><span class="s1">&#39;teamName&#39;</span><span class="p">],</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>
<span class="w">   </span>
<span class="w">   </span><span class="c1">// Two maps</span>
<span class="w">   </span><span class="nx">cD</span><span class="p">.</span><span class="nx">userName</span><span class="p">[</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">user_name</span><span class="p">;</span>
<span class="w">   </span><span class="nx">cD</span><span class="p">.</span><span class="nx">nickName</span><span class="p">[</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">nick_name</span><span class="p">;</span>
<span class="w">   </span><span class="nx">cD</span><span class="p">.</span><span class="nx">teamName</span><span class="p">[</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">team_name</span><span class="p">;</span>
<span class="w">   </span><span class="nx">cD</span><span class="p">.</span><span class="nx">id</span><span class="p">[</span><span class="w"> </span><span class="nx">user_name</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
<span class="w">   </span>
<span class="w">   </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">   </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="w"> </span><span class="nx">connectionInfo</span><span class="p">());</span>
<span class="w">   </span>
<span class="w">   </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;New client: &#39;</span><span class="o">+</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">userName</span><span class="p">[</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="s1">&#39;, &#39;</span><span class="o">+</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;.&#39;</span><span class="p">);</span>
<span class="w">   </span>
<span class="w">   </span><span class="c1">// Tell the new user their network name. Note there is no listener for this on the host.</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">hostID</span><span class="p">[</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">room</span><span class="p">[</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">]])</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;your name is&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="o">:</span><span class="nx">cD</span><span class="p">.</span><span class="nx">userName</span><span class="p">[</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">]}</span><span class="w"> </span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="c1">// Now set up the various listeners. I know this seems a little odd, but these listeners</span>
<span class="w">   </span><span class="c1">// need to be defined each time this connection event fires, i.e. for each socket.</span>
<span class="w">   </span>
<span class="w">   </span><span class="c1">// Echo test...</span>
<span class="w">   </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;echo-from-Client-to-Server&#39;</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">msg</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;server&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="c1">// This bounces off the SERVER and goes right back to the client.</span>
<span class="w">         </span><span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;echo-from-Server-to-Client&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;server&#39;</span><span class="p">);</span>
<span class="w">         </span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">msg</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;host&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="c1">// Send this first to the host (the scenic route). Include the id of the client so that we know where to send it</span>
<span class="w">         </span><span class="c1">// when it bounces off the host.</span>
<span class="w">         </span><span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">hostID</span><span class="p">[</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">room</span><span class="p">[</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">]]).</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;echo-from-Server-to-Host&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">   </span><span class="p">});</span>
<span class="w">   </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;echo-from-Host-to-Server&#39;</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">socket_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">msg</span><span class="p">;</span>
<span class="w">      </span><span class="c1">// Now that this has come back from the HOST, complete the trip and send this to the originating client.</span>
<span class="w">      </span><span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="nx">socket_id</span><span class="p">).</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;echo-from-Server-to-Client&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;host&#39;</span><span class="p">);</span>
<span class="w">   </span><span class="p">});</span>
<span class="w">   </span>
<span class="w">   </span><span class="cm">/*</span>
<span class="cm">   This timer protects my Heroku account from idle clients: an abandoned browser tab that has a socket open.</span>
<span class="cm">   The timer starts when the socket is opened, resets in &quot;chat message&quot;. The host will not close until</span>
<span class="cm">   all the non-host clients have closed; the host&#39;s timer is recursively extended until it is the only</span>
<span class="cm">   client left.</span>
<span class="cm">   */</span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">logoffTimer</span><span class="p">;</span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">warningTimer</span><span class="p">;</span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">idleTime_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">setTimer</span><span class="p">(</span><span class="w"> </span><span class="nx">reset</span><span class="p">,</span><span class="w"> </span><span class="nx">t_min</span><span class="o">=</span><span class="mf">40.0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// note 40 is in a message string below</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">reset</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;initialize&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">idleTime_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">t_min</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">reset</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;restart&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">         </span><span class="nx">clearTimeout</span><span class="p">(</span><span class="w"> </span><span class="nx">warningTimer</span><span class="p">);</span>
<span class="w">         </span><span class="nx">clearTimeout</span><span class="p">(</span><span class="w"> </span><span class="nx">logoffTimer</span><span class="p">);</span>
<span class="w">         </span><span class="nx">idleTime_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">t_min</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">reset</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;extend&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">clearTimeout</span><span class="p">(</span><span class="w"> </span><span class="nx">warningTimer</span><span class="p">);</span>
<span class="w">         </span><span class="nx">clearTimeout</span><span class="p">(</span><span class="w"> </span><span class="nx">logoffTimer</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">reset</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s2">&quot;extend&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">warningTimer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">setTimeout</span><span class="p">(</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="nx">warningMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Idle socket will disconnect in &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="nx">t_min</span><span class="o">/</span><span class="mf">2.0</span><span class="p">).</span><span class="nx">toFixed</span><span class="p">(</span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39; minutes.&#39;</span><span class="w"> </span><span class="o">+</span>
<span class="w">                                 </span><span class="s1">&#39;&lt;/br&gt;&lt;/br&gt;Click &lt;strong&gt;Chat&lt;/strong&gt; to reset the disconnect timer to &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">t_min</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39; minutes.&#39;</span><span class="p">;</span>
<span class="w">            </span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;chat message&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">warningMessage</span><span class="p">);</span>
<span class="w">         </span><span class="p">},</span><span class="w"> </span><span class="p">(</span><span class="nx">t_min</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1000</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="nx">logoffTimer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">setTimeout</span><span class="p">(</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="kd">let</span><span class="w"> </span><span class="nx">disconnectNotice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Idle for &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">idleTime_m</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39; minutes. Network socket disconnected.&#39;</span><span class="p">;</span>
<span class="w">         </span><span class="kd">let</span><span class="w"> </span><span class="nx">advice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&lt;/br&gt;&lt;/br&gt;Click &lt;strong&gt;Chat&lt;/strong&gt; before disconnection for 40 minutes of network time.&#39;</span><span class="w"> </span><span class="o">+</span>
<span class="w">                      </span><span class="s1">&#39;&lt;/br&gt;&lt;/br&gt;To &lt;strong&gt;reconnect:&lt;/strong&gt; hosts click &lt;strong&gt;Create&lt;/strong&gt;, clients click &lt;strong&gt;Connect&lt;/strong&gt;.&#39;</span>
<span class="w">         </span><span class="kd">let</span><span class="w"> </span><span class="nx">idString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39; (id=&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;)&#39;</span><span class="p">;</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// Host</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">hostID</span><span class="p">[</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">room</span><span class="p">[</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">]])</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// don&#39;t disconnect the host if there are any non-host users</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="nx">n_users</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">userName</span><span class="p">).</span><span class="nx">length</span><span class="p">;</span>
<span class="w">            </span><span class="c1">// don&#39;t let the extensions go on forever</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">n_users</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="nx">idleTime_m</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">180.0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;chat message&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">disconnectNotice</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">advice</span><span class="p">);</span>
<span class="w">               </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="w"> </span><span class="nx">disconnectNotice</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">idString</span><span class="p">);</span>
<span class="w">               </span><span class="nx">removeUserFromMaps</span><span class="p">(</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="w">               </span><span class="nx">socket</span><span class="p">.</span><span class="nx">disconnect</span><span class="p">();</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="kd">let</span><span class="w"> </span><span class="nx">extraTime_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">5.0</span><span class="p">;</span>
<span class="w">               </span><span class="nx">idleTime_m</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">extraTime_m</span><span class="p">;</span>
<span class="w">               </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Time for host socket extended (&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="nx">n_users</span><span class="o">-</span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;,&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">idleTime_m</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mf">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;)&quot;</span><span class="p">);</span>
<span class="w">               </span><span class="nx">setTimer</span><span class="p">(</span><span class="s2">&quot;extend&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">extraTime_m</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">         </span><span class="c1">// non-Host client</span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;chat message&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">disconnectNotice</span><span class="p">);</span>
<span class="w">            </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="w"> </span><span class="nx">disconnectNotice</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">idString</span><span class="p">);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="nx">pars</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="o">:</span><span class="nx">cD</span><span class="p">.</span><span class="nx">userName</span><span class="p">[</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">],</span><span class="w"> </span><span class="s1">&#39;originator&#39;</span><span class="o">:</span><span class="s1">&#39;server&#39;</span><span class="p">};</span>
<span class="w">            </span><span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;disconnectByServer&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">pars</span><span class="p">);</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">         </span>
<span class="w">      </span><span class="p">},</span><span class="w"> </span><span class="nx">t_min</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1000</span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="nx">setTimer</span><span class="p">(</span><span class="s2">&quot;initialize&quot;</span><span class="p">);</span>

<span class="w">   </span><span class="c1">// Broadcast the incoming chat message to everyone in the sender&#39;s room. Allow some special text strings</span>
<span class="w">   </span><span class="c1">// to trigger actions on the server.</span>
<span class="w">   </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;chat message&#39;</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">setTimer</span><span class="p">(</span><span class="s2">&quot;restart&quot;</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">msg</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;dcir&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">hostID</span><span class="p">[</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">room</span><span class="p">[</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">]])</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">disconnectClientsInOneRoom</span><span class="p">(</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">room</span><span class="p">[</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">]);</span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;chat message&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Requests to disconnect clients must come from the host.&#39;</span><span class="p">);</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">         </span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">msg</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;dac&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="c1">//disconnectClientsInAllRooms();</span>
<span class="w">         </span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">msg</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;rr&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">hostID</span><span class="p">[</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">room</span><span class="p">[</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">]])</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">hostID</span><span class="p">[</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">room</span><span class="p">[</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">]]).</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;chat message&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">roomReport</span><span class="p">());</span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;chat message&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Requests for room reports must come from the host.&#39;</span><span class="p">);</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">               </span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="c1">// General emit to the room. Note: io.to and io.in do the same thing.</span>
<span class="w">         </span><span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">room</span><span class="p">[</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">]).</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;chat message&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot; (&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">setDisplayName</span><span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;comma&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;)&quot;</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">});</span>
<span class="w">   </span>
<span class="w">   </span><span class="c1">// Broadcast the incoming chat message to everyone in the sender&#39;s room, except the sender.</span>
<span class="w">   </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;chat message but not me&#39;</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Emit to everyone in the sender&#39;s room except the sender.</span>
<span class="w">      </span><span class="nx">socket</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">room</span><span class="p">[</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">]).</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;chat message&#39;</span><span class="p">,</span><span class="w">  </span><span class="nx">msg</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot; (&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">setDisplayName</span><span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;comma&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;)&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="p">});</span>
<span class="w">   </span>
<span class="w">   </span>
<span class="w">   </span><span class="c1">// Signaling in support of WebRTC.</span>
<span class="w">   </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;signaling message&#39;</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">      </span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">to</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;host&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">hostID</span><span class="p">[</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">room</span><span class="p">[</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">]];</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">id</span><span class="p">[</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">to</span><span class="p">];</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Relay the message (emit) to the target user.</span>
<span class="w">      </span><span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="w"> </span><span class="nx">target</span><span class="p">).</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;signaling message&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">msg</span><span class="p">);</span>
<span class="w">   </span><span class="p">});</span>
<span class="w">   </span>
<span class="w">   </span><span class="c1">// General control message (note: same structure as the above handler for signaling messages)</span>
<span class="w">   </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;control message&#39;</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">      </span>
<span class="w">      </span><span class="c1">// If a targeted chat message, add string that identifies the sender.</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">displayThis</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">msg</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">displayThis</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s2">&quot; (&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">setDisplayName</span><span class="p">(</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;comma&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;)&quot;</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// to the host only</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">to</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;host&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">hostID</span><span class="p">[</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">room</span><span class="p">[</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">]];</span>
<span class="w">      </span><span class="c1">// to everyone in the room   </span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">to</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;room&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">room</span><span class="p">[</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">];</span>
<span class="w">      </span><span class="c1">// to everyone in the room except the sender   </span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">to</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;roomNoSender&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">room</span><span class="p">[</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">];</span>
<span class="w">         </span><span class="nx">socket</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="w"> </span><span class="nx">target</span><span class="p">).</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;control message&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">msg</span><span class="p">);</span>
<span class="w">         </span><span class="k">return</span><span class="p">;</span>
<span class="w">      </span><span class="c1">// to this particular user</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="c1">// Check whether specified as nick name.</span>
<span class="w">         </span><span class="kd">let</span><span class="w"> </span><span class="nx">nickName_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">         </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">socket_id</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">userName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">cD</span><span class="p">.</span><span class="nx">nickName</span><span class="p">[</span><span class="w"> </span><span class="nx">socket_id</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">cD</span><span class="p">.</span><span class="nx">nickName</span><span class="p">[</span><span class="w"> </span><span class="nx">socket_id</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">to</span><span class="p">))</span><span class="w"> </span><span class="nx">nickName_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">socket_id</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">nickName_id</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">nickName_id</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">id</span><span class="p">[</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">to</span><span class="p">];</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Relay the message (emit) to the target user(s).</span>
<span class="w">      </span><span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="w"> </span><span class="nx">target</span><span class="p">).</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;control message&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">msg</span><span class="p">);</span>
<span class="w">   </span><span class="p">});</span>
<span class="w">   </span>
<span class="w">   </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;name report&#39;</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">names</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Generate report then send it back to the user.</span>
<span class="w">      </span><span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;name report&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">nameReport</span><span class="p">(</span><span class="w"> </span><span class="nx">names</span><span class="p">,</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">));</span>
<span class="w">   </span><span class="p">});</span>
<span class="w">   </span>
<span class="w">   </span><span class="c1">// Send mouse and keyboard states to the host.</span>
<span class="w">   </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;client-mK-event&#39;</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Determine the id of the room-host for this client. Then send data to the host for that room.</span>
<span class="w">      </span><span class="c1">// socket.id --&gt; room --&gt; room host.</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">hostID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">hostID</span><span class="p">[</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">room</span><span class="p">[</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">]];</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// StH: Server to Host</span>
<span class="w">      </span><span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="w"> </span><span class="nx">hostID</span><span class="p">).</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;client-mK-StH-event&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">msg</span><span class="p">);</span>
<span class="w">   </span><span class="p">});</span>
<span class="w">   </span>
<span class="w">   </span><span class="c1">// After connecting, the &#39;connect&#39; listener, on client or host, sends a message to &#39;roomJoin&#39; listener on the server.</span>
<span class="w">   </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;roomJoin&#39;</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">roomName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">setDefault</span><span class="p">(</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">roomName</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">requestStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">setDefault</span><span class="p">(</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">requestStream</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">setDefault</span><span class="p">(</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">player</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">hostOrClient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">setDefault</span><span class="p">(</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">hostOrClient</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;client&#39;</span><span class="p">);</span>
<span class="w">      </span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">nickName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">nickName</span><span class="p">[</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">];</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">teamName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">teamName</span><span class="p">[</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">];</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">displayName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">setDisplayName</span><span class="p">(</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;prens&#39;</span><span class="p">);</span>
<span class="w">      </span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hostOrClient</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;client&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="c1">// Check to make sure the room has a host.</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">cD</span><span class="p">.</span><span class="nx">hostID</span><span class="p">[</span><span class="w"> </span><span class="nx">roomName</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">socket</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="w"> </span><span class="nx">roomName</span><span class="p">);</span>
<span class="w">            </span><span class="nx">cD</span><span class="p">.</span><span class="nx">room</span><span class="p">[</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">roomName</span><span class="p">;</span>
<span class="w">            </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Room &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">roomName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39; joined by &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">userName</span><span class="p">[</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;.&#39;</span><span class="p">);</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">// Send message to the individual client that is joining the room.</span>
<span class="w">            </span><span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;room-joining-message&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;message&#39;</span><span class="o">:</span><span class="s1">&#39;You have joined room &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">room</span><span class="p">[</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39; and your client name is &#39;</span><span class="o">+</span><span class="w"> </span><span class="nx">displayName</span><span class="w"> </span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                                           </span><span class="s1">&#39;userName&#39;</span><span class="o">:</span><span class="nx">cD</span><span class="p">.</span><span class="nx">userName</span><span class="p">[</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">]}</span><span class="w"> </span><span class="p">);</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">// Message to the room host.</span>
<span class="w">            </span><span class="c1">// Give the host the name of the new network user so it can create a new game client. </span>
<span class="w">            </span><span class="c1">// This is where &quot;player&quot;, &quot;nickName&quot;, and &quot;teamName&quot; info gets sent to the host.</span>
<span class="w">            </span><span class="c1">// Notice this emit to new-game-client is not done in the host block below.</span>
<span class="w">            </span><span class="c1">// Generally, the host sets its own identity directly, then listens (room-joining-message) </span>
<span class="w">            </span><span class="c1">// to the server for any incrementation of its intended nickname.</span>
<span class="w">            </span><span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">hostID</span><span class="p">[</span><span class="w"> </span><span class="nx">roomName</span><span class="p">]).</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;new-game-client&#39;</span><span class="p">,</span><span class="w"> </span>
<span class="w">               </span><span class="p">{</span><span class="s1">&#39;clientName&#39;</span><span class="o">:</span><span class="nx">cD</span><span class="p">.</span><span class="nx">userName</span><span class="p">[</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">],</span><span class="w"> </span><span class="s1">&#39;requestStream&#39;</span><span class="o">:</span><span class="nx">requestStream</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;player&#39;</span><span class="o">:</span><span class="nx">player</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;nickName&#39;</span><span class="o">:</span><span class="nx">nickName</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;teamName&#39;</span><span class="o">:</span><span class="nx">teamName</span><span class="p">}</span><span class="w"> </span><span class="p">);</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">// Chat message to the host.</span>
<span class="w">            </span><span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">hostID</span><span class="p">[</span><span class="w"> </span><span class="nx">roomName</span><span class="p">]).</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;chat message&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">displayName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39; is a new client in room &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">roomName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;.&#39;</span><span class="p">);</span>
<span class="w">            </span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;room-joining-message&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;message&#39;</span><span class="o">:</span><span class="s1">&#39;Sorry, there is no host yet for room &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">roomName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;.&#39;</span><span class="p">,</span>
<span class="w">                                                           </span><span class="s1">&#39;userName&#39;</span><span class="o">:</span><span class="nx">cD</span><span class="p">.</span><span class="nx">userName</span><span class="p">[</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">]}</span><span class="w"> </span><span class="p">);</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hostOrClient</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;host&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="c1">// Should check if the room already has a host.</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">cD</span><span class="p">.</span><span class="nx">hostID</span><span class="p">[</span><span class="w"> </span><span class="nx">roomName</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Send warning to the client that is attempting to host.</span>
<span class="w">            </span><span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;room-joining-message&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;message&#39;</span><span class="o">:</span><span class="s1">&#39;Sorry, there is already a host for room &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">roomName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;.&#39;</span><span class="p">,</span>
<span class="w">                                                           </span><span class="s1">&#39;userName&#39;</span><span class="o">:</span><span class="nx">cD</span><span class="p">.</span><span class="nx">userName</span><span class="p">[</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">]}</span><span class="w"> </span><span class="p">);</span>
<span class="w">            </span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">socket</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="w"> </span><span class="nx">roomName</span><span class="p">);</span>
<span class="w">            </span><span class="nx">cD</span><span class="p">.</span><span class="nx">room</span><span class="p">[</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">roomName</span><span class="p">;</span>
<span class="w">            </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Room &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">roomName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39; joined by &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">userName</span><span class="p">[</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;.&#39;</span><span class="p">);</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">// General you-have-joined-the-room message. This is where the host gets its incremented nickname.</span>
<span class="w">            </span><span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;room-joining-message&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;message&#39;</span><span class="o">:</span><span class="s1">&#39;You have joined room &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">room</span><span class="p">[</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39; and your client name is &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">displayName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;.&#39;</span><span class="p">,</span>
<span class="w">                                                           </span><span class="s1">&#39;userName&#39;</span><span class="o">:</span><span class="nx">cD</span><span class="p">.</span><span class="nx">userName</span><span class="p">[</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">],</span><span class="w"> </span><span class="s1">&#39;nickName&#39;</span><span class="o">:</span><span class="nx">nickName</span><span class="p">}</span><span class="w"> </span><span class="p">);</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">// Set this user as the host for this room.</span>
<span class="w">            </span><span class="nx">cD</span><span class="p">.</span><span class="nx">hostID</span><span class="p">[</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">room</span><span class="p">[</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">]]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
<span class="w">            </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;User &#39;</span><span class="o">+</span><span class="w"> </span><span class="nx">displayName</span><span class="w"> </span><span class="o">+</span><span class="s1">&#39; identified as host for room &#39;</span><span class="o">+</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">room</span><span class="p">[</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;.&#39;</span><span class="p">);</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">// And oh-by-the-way &quot;you are the host&quot; message.</span>
<span class="w">            </span><span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;room-joining-message&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;message&#39;</span><span class="o">:</span><span class="s1">&#39;You are the host of room &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">room</span><span class="p">[</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;.&#39;</span><span class="p">,</span>
<span class="w">                                                           </span><span class="s1">&#39;userName&#39;</span><span class="o">:</span><span class="nx">cD</span><span class="p">.</span><span class="nx">userName</span><span class="p">[</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">]}</span><span class="w"> </span><span class="p">);</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">});</span>
<span class="w">   </span>
<span class="w">   </span><span class="c1">// This &quot;disconnect&quot; event is fired by the server when a socket is disconnected. </span>
<span class="w">   </span><span class="c1">// (can be triggered by socket.disconnect() in this file or hostAndClient.js, or when a client reloads their page).</span>
<span class="w">   </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;disconnect&#39;</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">cD</span><span class="p">.</span><span class="nx">userName</span><span class="p">[</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">displayName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">setDisplayName</span><span class="p">(</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;prens&#39;</span><span class="p">);</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// Report at the server.</span>
<span class="w">         </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">);</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">displayName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39; has disconnected.&#39;</span><span class="p">;</span>
<span class="w">         </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39; (by self, &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;).&#39;</span><span class="p">);</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// Report to the room host.</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">hostID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">hostID</span><span class="p">[</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">room</span><span class="p">[</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">]];</span>
<span class="w">         </span><span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="w"> </span><span class="nx">hostID</span><span class="p">).</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;chat message&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;.&#39;</span><span class="p">);</span>
<span class="w">         </span><span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="w"> </span><span class="nx">hostID</span><span class="p">).</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;client-disconnected&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">userName</span><span class="p">[</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">]);</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// Remove this user from the maps.</span>
<span class="w">         </span><span class="nx">removeUserFromMaps</span><span class="p">(</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">});</span>
<span class="w">   </span>
<span class="w">   </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;clientDisconnectByHost&#39;</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">clientName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">msg</span><span class="p">;</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">clientID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">id</span><span class="p">[</span><span class="w"> </span><span class="nx">clientName</span><span class="p">];</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Send disconnect message to the client.</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">pars</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="o">:</span><span class="nx">clientName</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;originator&#39;</span><span class="o">:</span><span class="s1">&#39;host&#39;</span><span class="p">};</span>
<span class="w">      </span><span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="w"> </span><span class="nx">clientID</span><span class="p">).</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;disconnectByServer&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">pars</span><span class="p">);</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Don&#39;t do the following. It will disconnect the host socket. Not what we want here!</span>
<span class="w">      </span><span class="c1">//socket.disconnect();</span>
<span class="w">   </span><span class="p">});</span>
<span class="w">   </span>
<span class="w">   </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;okDisconnectMe&#39;</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// This event indicates that the non-host client has gotten the clientDisconnectByHost message (see above) and</span>
<span class="w">      </span><span class="c1">// agrees to go peacefully.</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">clientName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">msg</span><span class="p">;</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">clientID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">id</span><span class="p">[</span><span class="w"> </span><span class="nx">clientName</span><span class="p">];</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Report this at the server.</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">);</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">clientName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39; has disconnected&#39;</span><span class="p">;</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39; (by host, &#39;</span><span class="o">+</span><span class="nx">clientID</span><span class="o">+</span><span class="s1">&#39;).&#39;</span><span class="p">);</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Report to the room host.</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">hostID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">hostID</span><span class="p">[</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">room</span><span class="p">[</span><span class="w"> </span><span class="nx">clientID</span><span class="p">]];</span>
<span class="w">      </span><span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="w"> </span><span class="nx">hostID</span><span class="p">).</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;chat message&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="p">);</span>
<span class="w">      </span><span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="w"> </span><span class="nx">hostID</span><span class="p">).</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;client-disconnected&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">clientName</span><span class="p">);</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Remove this user from the maps.</span>
<span class="w">      </span><span class="nx">removeUserFromMaps</span><span class="p">(</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">//Finally, go ahead and disconnect this client&#39;s socket.</span>
<span class="w">      </span><span class="nx">socket</span><span class="p">.</span><span class="nx">disconnect</span><span class="p">();</span>
<span class="w">   </span><span class="p">});</span>

<span class="w">   </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;shutDown-p2p-deleteClient&#39;</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">clientName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">msg</span><span class="p">;</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">clientID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">id</span><span class="p">[</span><span class="w"> </span><span class="nx">clientName</span><span class="p">];</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">hostID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">hostID</span><span class="p">[</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">room</span><span class="p">[</span><span class="w"> </span><span class="nx">clientID</span><span class="p">]];</span>
<span class="w">      </span><span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="w"> </span><span class="nx">hostID</span><span class="p">).</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;shutDown-p2p-deleteClient&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">clientName</span><span class="p">);</span><span class="w">   </span>
<span class="w">   </span><span class="p">});</span>
<span class="w">   </span>
<span class="w">   </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;command-from-host-to-all-clients&#39;</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// General emit to the room.</span>
<span class="w">      </span><span class="nx">io</span><span class="p">.</span><span class="nx">to</span><span class="p">(</span><span class="w"> </span><span class="nx">cD</span><span class="p">.</span><span class="nx">room</span><span class="p">[</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">]).</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;command-from-host-to-all-clients&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">msg</span><span class="p">);</span>
<span class="w">   </span><span class="p">});</span>
<span class="w">   </span>
<span class="p">});</span>
</pre></div>
</body>
</html>
