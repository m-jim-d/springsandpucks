<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">
<!--
generated by Pygments <http://pygments.org>
Copyright 2006-2019 by the Pygments team.
Licensed under the BSD license, see LICENSE for details.
-->
<html>
<head>
  <link rel='canonical' href='https://triquence.org/consAndPros.js.html' />
  <title>consAndPros.js</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <style type="text/css">
/*
generated by Pygments <http://pygments.org>
Copyright 2006-2019 by the Pygments team.
Licensed under the BSD license, see LICENSE for details.
*/
td.linenos { background-color: #f0f0f0; padding-right: 10px; }
span.lineno { background-color: #f0f0f0; padding: 0 5px 0 5px; }
pre { line-height: 125%; }
body .hll { background-color: #ffffcc }
body  { background: #f8f8f8; }
body .c { color: #408080; font-style: italic } /* Comment */
body .err { border: 1px solid #FF0000 } /* Error */
body .k { color: #008000; font-weight: bold } /* Keyword */
body .o { color: #666666 } /* Operator */
body .ch { color: #408080; font-style: italic } /* Comment.Hashbang */
body .cm { color: #408080; font-style: italic } /* Comment.Multiline */
body .cp { color: #BC7A00 } /* Comment.Preproc */
body .cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */
body .c1 { color: #408080; font-style: italic } /* Comment.Single */
body .cs { color: #408080; font-style: italic } /* Comment.Special */
body .gd { color: #A00000 } /* Generic.Deleted */
body .ge { font-style: italic } /* Generic.Emph */
body .gr { color: #FF0000 } /* Generic.Error */
body .gh { color: #000080; font-weight: bold } /* Generic.Heading */
body .gi { color: #00A000 } /* Generic.Inserted */
body .go { color: #888888 } /* Generic.Output */
body .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
body .gs { font-weight: bold } /* Generic.Strong */
body .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
body .gt { color: #0044DD } /* Generic.Traceback */
body .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
body .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
body .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
body .kp { color: #008000 } /* Keyword.Pseudo */
body .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
body .kt { color: #B00040 } /* Keyword.Type */
body .m { color: #666666 } /* Literal.Number */
body .s { color: #BA2121 } /* Literal.String */
body .na { color: #7D9029 } /* Name.Attribute */
body .nb { color: #008000 } /* Name.Builtin */
body .nc { color: #0000FF; font-weight: bold } /* Name.Class */
body .no { color: #880000 } /* Name.Constant */
body .nd { color: #AA22FF } /* Name.Decorator */
body .ni { color: #999999; font-weight: bold } /* Name.Entity */
body .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
body .nf { color: #0000FF } /* Name.Function */
body .nl { color: #A0A000 } /* Name.Label */
body .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
body .nt { color: #008000; font-weight: bold } /* Name.Tag */
body .nv { color: #19177C } /* Name.Variable */
body .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
body .w { color: #bbbbbb } /* Text.Whitespace */
body .mb { color: #666666 } /* Literal.Number.Bin */
body .mf { color: #666666 } /* Literal.Number.Float */
body .mh { color: #666666 } /* Literal.Number.Hex */
body .mi { color: #666666 } /* Literal.Number.Integer */
body .mo { color: #666666 } /* Literal.Number.Oct */
body .sa { color: #BA2121 } /* Literal.String.Affix */
body .sb { color: #BA2121 } /* Literal.String.Backtick */
body .sc { color: #BA2121 } /* Literal.String.Char */
body .dl { color: #BA2121 } /* Literal.String.Delimiter */
body .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
body .s2 { color: #BA2121 } /* Literal.String.Double */
body .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
body .sh { color: #BA2121 } /* Literal.String.Heredoc */
body .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
body .sx { color: #008000 } /* Literal.String.Other */
body .sr { color: #BB6688 } /* Literal.String.Regex */
body .s1 { color: #BA2121 } /* Literal.String.Single */
body .ss { color: #19177C } /* Literal.String.Symbol */
body .bp { color: #008000 } /* Name.Builtin.Pseudo */
body .fm { color: #0000FF } /* Name.Function.Magic */
body .vc { color: #19177C } /* Name.Variable.Class */
body .vg { color: #19177C } /* Name.Variable.Global */
body .vi { color: #19177C } /* Name.Variable.Instance */
body .vm { color: #19177C } /* Name.Variable.Magic */
body .il { color: #666666 } /* Literal.Number.Integer.Long */

  </style>
</head>
<body>
<h2></h2>

<div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm">Copyright 2022 James D. Miller</span>

<span class="cm">Permission is hereby granted, free of charge, to any person obtaining a copy</span>
<span class="cm">of this software and associated documentation files (the &quot;Software&quot;), to deal</span>
<span class="cm">in the Software without restriction, including without limitation the rights</span>
<span class="cm">to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
<span class="cm">copies of the Software, and to permit persons to whom the Software is</span>
<span class="cm">furnished to do so, subject to the following conditions:</span>

<span class="cm">The above copyright notice and this permission notice shall be included in all</span>
<span class="cm">copies or substantial portions of the Software.</span>

<span class="cm">THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="cm">IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="cm">FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
<span class="cm">AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<span class="cm">LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span>
<span class="cm">OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="cm">SOFTWARE.</span>
<span class="cm">*/</span>

<span class="c1">// Constructors and Prototypes (cP) module</span>
<span class="c1">// consAndPros.js </span>
   <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;cP _*-*_&#39;</span><span class="p">);</span>
<span class="c1">// 11:44 AM Sat December 9, 2023</span>

<span class="cm">/*</span>
<span class="cm">gwModule.js has an alphabetical list of all modules and their nicknames as added to the windows namespace.</span>
<span class="cm">*/</span>

<span class="nb">window</span><span class="p">.</span><span class="nx">cP</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
   <span class="s2">&quot;use strict&quot;</span><span class="p">;</span>   

   <span class="c1">/////////////////////////////////////////////////////////////////////////////</span>
   <span class="c1">////</span>
   <span class="c1">////  Prototypes for Pucks, Springs, Joints, Pins, and Walls</span>
   <span class="c1">////</span>
   <span class="c1">/////////////////////////////////////////////////////////////////////////////</span>
      
   <span class="c1">// For use in sound field, demo #2.</span>
   <span class="kd">function</span> <span class="nx">PuckTail</span><span class="p">(</span> <span class="nx">pars</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">dFM</span><span class="p">.</span><span class="nx">DrawingFunctions</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span> <span class="c1">// inherit</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">firstPoint_2d_m</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">firstPoint_2d_m</span><span class="p">,</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">));</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">initial_radius_m</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">initial_radius_m</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
      
      <span class="c1">// ppf: pixels per frame</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">propSpeed_ppf_px</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">propSpeed_ppf_px</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">length_limit</span> <span class="o">=</span>     <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">length_limit</span><span class="p">,</span> <span class="mi">25</span><span class="p">);</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">color</span> <span class="o">=</span>            <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">color</span><span class="p">,</span> <span class="s1">&#39;lightgray&#39;</span><span class="p">);</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">rainbow</span> <span class="o">=</span>          <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">rainbow</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">rainbow</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">pars</span><span class="p">.</span><span class="nx">hsl</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">hsl</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">HSLColor</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">hsl</span><span class="p">);</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">hsl</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">HSLColor</span><span class="p">(</span> <span class="p">{</span><span class="s1">&#39;hue&#39;</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;saturation&#39;</span><span class="o">:</span><span class="mi">80</span><span class="p">,</span> <span class="s1">&#39;lightness&#39;</span><span class="o">:</span><span class="mi">70</span><span class="p">,</span> <span class="s1">&#39;steppingKey&#39;</span><span class="o">:</span><span class="s1">&#39;hue&#39;</span><span class="p">,</span> <span class="s1">&#39;stepSize&#39;</span><span class="o">:</span><span class="mi">4</span><span class="p">}</span> <span class="p">);</span>
         <span class="p">}</span>
      <span class="p">}</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">machSwitch</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">machSwitch</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">machValue</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">machValue</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
            
      <span class="c1">// The wait (time in seconds) before making a pure white color ping.</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">markerPingTimerLimit_s</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">markerPingTimerLimit_s</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">markerPingTimer_s</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">values</span> <span class="o">=</span> <span class="p">[];</span>
   <span class="p">}</span>
   <span class="nx">PuckTail</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span> <span class="nx">dFM</span><span class="p">.</span><span class="nx">DrawingFunctions</span><span class="p">.</span><span class="nx">prototype</span><span class="p">);</span> <span class="c1">// Inherit methods</span>
   <span class="nx">PuckTail</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">=</span> <span class="nx">PuckTail</span><span class="p">;</span> <span class="c1">// Rename the constructor (after inheriting)</span>
   <span class="nx">PuckTail</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">machCalc</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">puckSpeed_mps</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">waveSpeed_mps</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">meters_from_px</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">propSpeed_ppf_px</span><span class="p">)</span> <span class="o">*</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">getFrameRate</span><span class="p">();</span>
      <span class="kd">var</span> <span class="nx">mach</span> <span class="o">=</span>  <span class="nx">puckSpeed_mps</span> <span class="o">/</span> <span class="nx">waveSpeed_mps</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">mach</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="nx">PuckTail</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">speedFromMach</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">waveSpeed_mps</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">meters_from_px</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">propSpeed_ppf_px</span><span class="p">)</span> <span class="o">*</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">getFrameRate</span><span class="p">();</span>
      <span class="kd">var</span> <span class="nx">puckSpeed_mps</span> <span class="o">=</span> <span class="nx">waveSpeed_mps</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">machValue</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">puckSpeed_mps</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="nx">PuckTail</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">update</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">drawingContext</span><span class="p">,</span> <span class="nx">newPoint_2d_m</span><span class="p">,</span> <span class="nx">deltaT_s</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">lineColor</span><span class="p">;</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">rainbow</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">// hue,   saturation, lightness</span>
         <span class="c1">// 0-360, 0-100%,     0-100%</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">pingColor</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">hsl</span><span class="p">.</span><span class="nx">colorString</span><span class="p">();</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">hsl</span><span class="p">.</span><span class="nx">step</span><span class="p">();</span>
         
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">pingColor</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">color</span><span class="p">;</span>
      <span class="p">}</span>
         
      <span class="c1">// Color one ring specially so to see it propagation better.</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">markerPingTimer_s</span> <span class="o">+=</span> <span class="nx">deltaT_s</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">markerPingTimer_s</span> <span class="o">&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">markerPingTimerLimit_s</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">rainbow</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">pingColor</span> <span class="o">=</span> <span class="s1">&#39;white&#39;</span><span class="p">;</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">markerPingTimer_s</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
      <span class="p">}</span>
      
      <span class="c1">// This is a reminder that an adjustable emit frequency doesn&#39;t render well. </span>
      <span class="c1">// Best to emit once per frame as is done in the single line that follows.</span>
      
      <span class="c1">// Ping out a new ring (once per frame). Each value is a position vector and radius.</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">values</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="s1">&#39;p_2d_px&#39;</span><span class="o">:</span><span class="nx">wS</span><span class="p">.</span><span class="nx">screenFromWorld</span><span class="p">(</span> <span class="nx">newPoint_2d_m</span><span class="p">),</span> <span class="s1">&#39;r_px&#39;</span><span class="o">:</span><span class="nx">wS</span><span class="p">.</span><span class="nx">px_from_meters</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">initial_radius_m</span><span class="p">),</span> <span class="s1">&#39;color&#39;</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">pingColor</span><span class="p">});</span>
      
      <span class="c1">// Remove the oldest value if needed.</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">values</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">length_limit</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">values</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
      <span class="p">}</span>
      
      <span class="c1">// Loop through the tail.</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">len</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">values</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">t</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">t</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
         
         <span class="c1">// Expand the radius of the ping (like a sound wave propagating). Note: doing this addition in pixels (not meters)</span>
         <span class="c1">// to yield a more consistent and pleasing rendering.</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">values</span><span class="p">[</span><span class="nx">t</span><span class="p">].</span><span class="nx">r_px</span> <span class="o">+=</span> <span class="k">this</span><span class="p">.</span><span class="nx">propSpeed_ppf_px</span><span class="p">;</span>
         
         <span class="c1">// Draw the sound circle (make the &#39;white&#39; marker ring even more visible, using red, if single stepping).</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">getSingleStep</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">values</span><span class="p">[</span><span class="nx">t</span><span class="p">].</span><span class="nx">color</span> <span class="o">==</span> <span class="s1">&#39;white&#39;</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">lineColor</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span><span class="p">;</span> <span class="c1">//#008080 cyan yellow magenta orange</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">lineColor</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">values</span><span class="p">[</span><span class="nx">t</span><span class="p">].</span><span class="nx">color</span><span class="p">;</span>
         <span class="p">}</span> 
         <span class="k">this</span><span class="p">.</span><span class="nx">drawCircle</span><span class="p">(</span> <span class="nx">drawingContext</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">values</span><span class="p">[</span><span class="nx">t</span><span class="p">].</span><span class="nx">p_2d_px</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;radius_px&#39;</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">values</span><span class="p">[</span><span class="nx">t</span><span class="p">].</span><span class="nx">r_px</span><span class="p">,</span> <span class="s1">&#39;borderColor&#39;</span><span class="o">:</span><span class="nx">lineColor</span><span class="p">,</span> <span class="s1">&#39;borderWidth_px&#39;</span><span class="o">:</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;fillColor&#39;</span><span class="o">:</span><span class="s1">&#39;noFill&#39;</span><span class="p">});</span>
      <span class="p">}</span>
   <span class="p">}</span>



   <span class="kd">function</span> <span class="nx">Puck</span><span class="p">(</span> <span class="nx">position_2d_m</span><span class="p">,</span> <span class="nx">velocity_2d_mps</span><span class="p">,</span> <span class="nx">pars</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">dFM</span><span class="p">.</span><span class="nx">DrawingFunctions</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span> <span class="c1">// Inherit attributes</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">parsAtBirth</span> <span class="o">=</span> <span class="nx">pars</span><span class="p">;</span>
      
      <span class="c1">// for removing old bullets</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">ageLimit_ms</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">ageLimit_ms</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">bullet</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">bullet</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">bulletIndication</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">bulletIndication</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">jello</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">jello</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">clientName</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">clientName</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">clientName</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">// Don&#39;t allow a client puck if there is not already a client. Client first, then puck.</span>
         <span class="c1">// Throwing an error forces an exit from this constructor.</span>
         <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">clientName</span><span class="p">]))</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">errorObj</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Constructor declines to create a puck for a non-existent client.&#39;</span><span class="p">);</span>
            <span class="nx">errorObj</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s1">&#39;from Puck constructor&#39;</span><span class="p">;</span>
            <span class="k">throw</span> <span class="nx">errorObj</span><span class="p">;</span>
         <span class="p">}</span>
         <span class="nx">pP</span><span class="p">.</span><span class="nx">incrementPlayerCount</span><span class="p">(</span> <span class="o">+</span><span class="mi">1</span><span class="p">);</span>
         <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">clientName</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;NPC&#39;</span><span class="p">))</span> <span class="nx">pP</span><span class="p">.</span><span class="nx">addToNpcCount</span><span class="p">(</span> <span class="o">+</span><span class="mi">1</span><span class="p">);</span>
         <span class="nx">pP</span><span class="p">.</span><span class="nx">updateTeamInfo</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">clientName</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="p">}</span>
      
      <span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">assignName</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">Puck</span><span class="p">.</span><span class="nx">nameIndex</span><span class="p">,</span> <span class="s2">&quot;puck&quot;</span><span class="p">,</span> <span class="s2">&quot;puckMap&quot;</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
      <span class="nx">Puck</span><span class="p">.</span><span class="nx">nameIndex</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">index</span><span class="p">;</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">nameTip_timerLimit_s</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">nameTip_timer_s</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">lowBallFinderCircle_timerLimit_s</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">lowBallFinderCircle_timer_s</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">lowBallFinderCircle_timerLimit_s</span><span class="p">;</span>
      
      <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">puckMap</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      
      <span class="c1">// Position of Center of Mass (COM)</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_m</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D_check</span><span class="p">(</span> <span class="nx">position_2d_m</span><span class="p">);</span>
      <span class="c1">// Position (in pixels).</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_px</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">screenFromWorld</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">);</span>
      
      <span class="c1">// Velocity of COM</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">velocity_2d_mps</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D_check</span><span class="p">(</span> <span class="nx">velocity_2d_mps</span><span class="p">);</span>
      
      <span class="c1">// Parse out the parameters in the pars object. The values on the right</span>
      <span class="c1">// are the defaults (used if pars value is undefined).</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">color</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">color</span><span class="p">,</span> <span class="s2">&quot;DarkSlateGray&quot;</span><span class="p">);</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">color</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;hsl&#39;</span><span class="p">))</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">hsl</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">hsl</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">HSLColor</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">hsl</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">color</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">hsl</span><span class="p">.</span><span class="nx">colorString</span><span class="p">();</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">hsl</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">HSLColor</span><span class="p">();</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">hsl</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">color</span><span class="p">);</span>
         <span class="p">}</span>
      <span class="p">}</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">borderColor</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">borderColor</span><span class="p">,</span> <span class="s2">&quot;white&quot;</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">shape</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">shape</span><span class="p">,</span> <span class="s2">&quot;circle&quot;</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">imageID</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">imageID</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">imageScale</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">imageScale</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">colorSource</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">colorSource</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
      <span class="c1">//this.colorExchange = uT.setDefault( pars.colorExchange, false);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">drawDuringPE</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">drawDuringPE</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span> <span class="c1">// PE = pause erase</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">density</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">density</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">);</span>
      <span class="c1">// Linear damping is like a drag force from translational movement through a surrounding fluid.</span>
      <span class="c1">// Note that springs have the attribute drag_c, with an effect similar to linDamp.</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">linDamp</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">linDamp</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
      <span class="c1">// Rotational drag</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">angDamp</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">angDamp</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">hitLimit</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">hitLimit</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">createTail</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">createTail</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">tail</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      
      <span class="c1">// www.iforce2d.net/b2dtut/collision-filtering</span>
      <span class="c1">// For client pucks, assign a negative group index that is based on the puck&#39;s name</span>
      <span class="c1">// This group index can be used to prevent collisions with bullets (having the same negative group index) </span>
      <span class="c1">// coming from a gun hosted by this puck.</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">clientName</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">groupIndex</span> <span class="o">=</span> <span class="o">-</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">-</span><span class="mi">1000</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">groupIndex</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">groupIndex</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="c1">// The following are defaults for Box2D.</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">categoryBits</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">categoryBits</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">maskBits</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">maskBits</span><span class="p">,</span> <span class="mh">0xFFFF</span><span class="p">);</span>
      
      <span class="c1">// Rotational state</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">angle_r</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">angle_r</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">angularSpeed_rps</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">angularSpeed_rps</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">angleLine</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">angleLine</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">borderWidth_px</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">borderWidth_px</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
      
      <span class="c1">// Put a reference to this puck in the client.</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">clientName</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">clientName</span><span class="p">].</span><span class="nx">puck</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="p">}</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">age_ms</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="c1">//this.createTime = window.performance.now();</span>
      
      <span class="c1">// Note that a call to setGravityRelatedParameters() may override the restitution and friction settings</span>
      <span class="c1">// in what follows unless they have been &quot;fixed&quot; (set to be constant).</span>
      
      <span class="c1">// Restitution (elasticity) of the object in collisions</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">restitution</span> <span class="o">===</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">getG_ON</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">restitution</span> <span class="o">=</span> <span class="nx">Puck</span><span class="p">.</span><span class="nx">restitution_gOn</span><span class="p">;</span>                
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">restitution</span> <span class="o">=</span> <span class="nx">Puck</span><span class="p">.</span><span class="nx">restitution_gOff</span><span class="p">;</span>
         <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">restitution</span> <span class="o">=</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">restitution</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="c1">// Option to fix restitution to be independent of the g toggle.</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">restitution_fixed</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">restitution_fixed</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
      
      <span class="c1">// Friction (tangential tackiness) of the object in collisions</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">friction</span> <span class="o">===</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">getG_ON</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">friction</span> <span class="o">=</span> <span class="nx">Puck</span><span class="p">.</span><span class="nx">friction_gOn</span><span class="p">;</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">friction</span> <span class="o">=</span> <span class="nx">Puck</span><span class="p">.</span><span class="nx">friction_gOff</span><span class="p">;</span>
         <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">friction</span> <span class="o">=</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">friction</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="c1">// Option to fix friction to be independent of the g toggle.</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">friction_fixed</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">friction_fixed</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
      
      <span class="c1">// Dimensions</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">radius_m</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">radius_m</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">aspectR</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">aspectR</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">half_height_m</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">half_height_m</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">half_width_m</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">half_width_m</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">shape</span> <span class="o">==</span> <span class="s1">&#39;circle&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">radius_px</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">px_from_meters</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">radius_m</span><span class="p">);</span>
      
      <span class="c1">// Rectangular</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="c1">// Height and width given explicitly.</span>
         <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">half_height_m</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">half_width_px</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">px_from_meters</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">half_width_m</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">half_height_px</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">px_from_meters</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">half_height_m</span><span class="p">);</span>
         
         <span class="c1">// Aspect ratio given.</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">half_width_m</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">radius_m</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">aspectR</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">half_width_px</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">px_from_meters</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">half_width_m</span><span class="p">);</span>
            
            <span class="k">this</span><span class="p">.</span><span class="nx">half_height_m</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">radius_m</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">half_height_px</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">px_from_meters</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">half_height_m</span><span class="p">);</span>
         <span class="p">}</span>
         
         <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">imageID</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">img</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">imageID</span><span class="p">);</span>
            <span class="kd">let</span> <span class="nx">image_aspectRatio</span> <span class="o">=</span> <span class="nx">img</span><span class="p">.</span><span class="nx">width</span> <span class="o">/</span> <span class="nx">img</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
            <span class="c1">// Use the image shape and puck height to establish the puck width.</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">half_width_m</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">half_height_m</span> <span class="o">*</span> <span class="nx">image_aspectRatio</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">half_width_px</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">px_from_meters</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">half_width_m</span><span class="p">);</span>
         <span class="p">}</span>
      <span class="p">}</span>
      
      <span class="c1">// Tail</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">createTail</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">var</span> <span class="nx">tailInitialState</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;firstPoint_2d_m&#39;</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">,</span> <span class="s1">&#39;initial_radius_m&#39;</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">radius_m</span><span class="p">};</span>
         <span class="c1">// Add any specified characteristics.</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">pars</span><span class="p">.</span><span class="nx">tail</span><span class="p">)</span> <span class="p">{</span>
            <span class="cm">/*</span>
<span class="cm">            For pucks that don&#39;t have tails, set the creatTail flag to true in a </span>
<span class="cm">            capture. Then run the capture. That will instantiate the puck with a tail </span>
<span class="cm">            having editable attributes (in the capture).</span>
<span class="cm">            */</span>
            <span class="kd">let</span> <span class="nx">allTailPars</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">({},</span> <span class="nx">tailInitialState</span><span class="p">,</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">tail</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">tail</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PuckTail</span><span class="p">(</span> <span class="nx">allTailPars</span><span class="p">);</span>
            
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">tail</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PuckTail</span><span class="p">(</span> <span class="nx">tailInitialState</span><span class="p">);</span>
         <span class="p">}</span>
         
         <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">tail</span><span class="p">.</span><span class="nx">machSwitch</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Calculate the puck velocity based on the specified Mach number.</span>
            <span class="kd">var</span> <span class="nx">temp_v_2d_mps</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">tail</span><span class="p">.</span><span class="nx">speedFromMach</span><span class="p">());</span>
            <span class="nx">temp_v_2d_mps</span><span class="p">.</span><span class="nx">matchAngle</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">velocity_2d_mps</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">velocity_2d_mps</span> <span class="o">=</span> <span class="nx">temp_v_2d_mps</span><span class="p">;</span>
         <span class="p">}</span>
      <span class="p">}</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">tempInhibitExtForce</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">nonCOM_2d_N</span> <span class="o">=</span> <span class="p">[];</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">sprDamp_force_2d_N</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">);</span>
      <span class="c1">// This vector is needed for aiming the NPC&#39;s navigation jets.</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">navSpringOnly_force_2d_N</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">jet_force_2d_N</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">impulse_2d_Ns</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">);</span>
      
      <span class="c1">// Puck-popper features</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">gun</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">jet</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">rayCastLineLength_m</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">rayCastLineLength_m</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">rayCast_init_deg</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">rayCast_init_deg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">rayRotationRate_dps</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">rayRotationRate_dps</span><span class="p">,</span> <span class="mi">80</span><span class="p">);</span>
      <span class="c1">// Disables and hides the jet</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">disableJet</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">disableJet</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">noRecoil</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">noRecoil</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">cannibalize</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">cannibalize</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">bullet_restitution</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">bullet_restitution</span><span class="p">,</span> <span class="mf">0.92</span><span class="p">);</span>
      <span class="c1">// If a bullet puck never hits another puck, this stays false.</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">atLeastOneHit</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="c1">// It identifies the owner of this (bullet) puck.</span>
      <span class="c1">// (so you can&#39;t shoot yourself in the foot)</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">clientNameOfShooter</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">clientNameOfShooter</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">hitCount</span> <span class="o">=</span>  <span class="mi">0</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">poorHealthFraction</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="c1">// Keep track of who shot the most recent bullet to hit this puck.</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">whoShotBullet</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">flash</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">inComing</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">flashCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      
      <span class="c1">// Navigation spring (not generally the name of any attached spring). There can be only</span>
      <span class="c1">// one navigation spring.</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">clientName</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">clientName</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;NPC&#39;</span><span class="p">))</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">navSpringName</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">pinName</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">pinName</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
         <span class="c1">// If there&#39;s named pin and it still exists...</span>
         <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pinName</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">pinMap</span><span class="p">[</span> <span class="k">this</span><span class="p">.</span><span class="nx">pinName</span><span class="p">]))</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">disableJet</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
            <span class="nx">pP</span><span class="p">.</span><span class="nx">attachNavSpring</span><span class="p">(</span> <span class="k">this</span><span class="p">);</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">disableJet</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
         <span class="p">}</span>
      <span class="p">}</span>
      
      <span class="c1">// Ghost-pool features</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">spotted</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="c1">// With network players involved, this choke is used to prevent more than one client from trying to make direct movements (like mouse-drag rotation).</span>
      <span class="c1">// This is the name of the first client to start a direct-movement on a puck.</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">firstClientDirectMove</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      
      <span class="c1">// Local selection point where candidate springs are to be attached.</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">selectionPoint_l_2d_m</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">deleted</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      
      <span class="c1">// All parameters should be set above this point. </span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">create_Box2d_Puck</span><span class="p">();</span>
      <span class="c1">// Create a reference back to this puck from the b2d puck.</span>
      <span class="c1">// Note that a Map allows any type of object for the key!</span>
      <span class="nx">gW</span><span class="p">.</span><span class="nx">tableMap</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">clientName</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">// Add client controls and give each control a reference to this puck.</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">jet</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">pP</span><span class="p">.</span><span class="nx">Jet</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;initial_angle&#39;</span><span class="o">:-</span><span class="mi">20</span><span class="p">});</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">gun</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">pP</span><span class="p">.</span><span class="nx">Gun</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;initial_angle&#39;</span><span class="o">:</span><span class="mi">200</span><span class="p">,</span> <span class="s1">&#39;indicator&#39;</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span> <span class="s1">&#39;tube_color&#39;</span><span class="o">:</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> 
             <span class="s1">&#39;rayCast_init_deg&#39;</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">rayCast_init_deg</span><span class="p">,</span> <span class="s1">&#39;rayRotationRate_dps&#39;</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">rayRotationRate_dps</span><span class="p">,</span> <span class="s1">&#39;rayCastLineLength_m&#39;</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">rayCastLineLength_m</span><span class="p">});</span>
      <span class="p">}</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">shield</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">pP</span><span class="p">.</span><span class="nx">Shield</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;color&#39;</span><span class="o">:</span><span class="s1">&#39;yellow&#39;</span><span class="p">});</span>
   <span class="p">}</span>
   <span class="nx">Puck</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span> <span class="nx">dFM</span><span class="p">.</span><span class="nx">DrawingFunctions</span><span class="p">.</span><span class="nx">prototype</span><span class="p">);</span> <span class="c1">// Inherit methods</span>
   <span class="nx">Puck</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">=</span> <span class="nx">Puck</span><span class="p">;</span> <span class="c1">// Rename the constructor (after inheriting)</span>
   <span class="nx">Puck</span><span class="p">.</span><span class="nx">nameIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="c1">// Note: these gravity-related defaults are typically set to non-Null values in demoStart (in gwModule).</span>
   <span class="nx">Puck</span><span class="p">.</span><span class="nx">restitution_default_gOn</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">Puck</span><span class="p">.</span><span class="nx">restitution_default_gOff</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
   <span class="nx">Puck</span><span class="p">.</span><span class="nx">restitution_gOn</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>         <span class="nx">Puck</span><span class="p">.</span><span class="nx">restitution_gOff</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
   <span class="nx">Puck</span><span class="p">.</span><span class="nx">friction_default_gOn</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>    <span class="nx">Puck</span><span class="p">.</span><span class="nx">friction_default_gOff</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
   <span class="nx">Puck</span><span class="p">.</span><span class="nx">friction_gOn</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>            <span class="nx">Puck</span><span class="p">.</span><span class="nx">friction_gOff</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
   
   <span class="nx">Puck</span><span class="p">.</span><span class="nx">g_2d_mps2</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
   <span class="nx">Puck</span><span class="p">.</span><span class="nx">hostPars</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;radius_m&#39;</span><span class="o">:</span><span class="mf">0.30</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="o">:</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="s1">&#39;colorSource&#39;</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span> <span class="s1">&#39;clientName&#39;</span><span class="o">:</span><span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="s1">&#39;hitLimit&#39;</span><span class="o">:</span><span class="mi">20</span><span class="p">,</span> <span class="s1">&#39;bullet_restitution&#39;</span><span class="o">:</span><span class="mf">0.85</span><span class="p">,</span> <span class="s1">&#39;linDamp&#39;</span><span class="o">:</span><span class="mf">1.0</span><span class="p">};</span>
   <span class="nx">Puck</span><span class="p">.</span><span class="nx">minRadius_px</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span> <span class="c1">// limits cannibalization</span>
   <span class="nx">Puck</span><span class="p">.</span><span class="nx">applyToAll</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">doThis</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">puckName</span> <span class="k">in</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">puckMap</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">var</span> <span class="nx">puck</span> <span class="o">=</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">puckMap</span><span class="p">[</span> <span class="nx">puckName</span><span class="p">];</span>
         <span class="nx">doThis</span><span class="p">(</span> <span class="nx">puck</span><span class="p">);</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="nx">Puck</span><span class="p">.</span><span class="nx">deleteAll</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">cT</span><span class="p">.</span><span class="nx">Client</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span> <span class="nx">client</span> <span class="p">=&gt;</span> <span class="nx">client</span><span class="p">.</span><span class="nx">puck</span> <span class="o">=</span> <span class="kc">null</span><span class="p">);</span>
      <span class="nx">Puck</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span> <span class="nx">puck</span> <span class="p">=&gt;</span> <span class="p">{</span>
         <span class="nx">gW</span><span class="p">.</span><span class="nx">tableMap</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span> <span class="nx">puck</span><span class="p">.</span><span class="nx">b2d</span><span class="p">);</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">puck</span><span class="p">.</span><span class="nx">b2d</span><span class="p">)</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">world</span><span class="p">.</span><span class="nx">DestroyBody</span><span class="p">(</span> <span class="nx">puck</span><span class="p">.</span><span class="nx">b2d</span><span class="p">);</span>
         <span class="c1">// Tell clients that their puck is gone.</span>
         <span class="k">if</span> <span class="p">((</span><span class="nx">puck</span><span class="p">.</span><span class="nx">clientName</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">puck</span><span class="p">.</span><span class="nx">clientName</span> <span class="o">!=</span> <span class="s1">&#39;local&#39;</span><span class="p">))</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">control_message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;from&#39;</span><span class="o">:</span><span class="s1">&#39;host&#39;</span><span class="p">,</span> <span class="s1">&#39;to&#39;</span><span class="o">:</span><span class="nx">puck</span><span class="p">.</span><span class="nx">clientName</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="o">:</span><span class="p">{</span><span class="s1">&#39;puckPopped&#39;</span><span class="o">:</span><span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="o">:</span><span class="kc">true</span><span class="p">}}</span> <span class="p">};</span>
            <span class="nx">hC</span><span class="p">.</span><span class="nx">sendSocketControlMessage</span><span class="p">(</span> <span class="nx">control_message</span><span class="p">);</span>
         <span class="p">}</span>
      <span class="p">});</span>
      <span class="nx">jM</span><span class="p">.</span><span class="nx">initializeModule</span><span class="p">();</span>
      <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">puckMap</span> <span class="o">=</span> <span class="p">{};</span>
      <span class="nx">Puck</span><span class="p">.</span><span class="nx">nameIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="nx">pP</span><span class="p">.</span><span class="nx">setPlayerCount</span><span class="p">(</span> <span class="mi">0</span><span class="p">);</span>
      <span class="nx">pP</span><span class="p">.</span><span class="nx">setNpcCount</span><span class="p">(</span> <span class="mi">0</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="nx">Puck</span><span class="p">.</span><span class="nx">findCenterOfMass</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="c1">// mass-weighted center of all pucks (COM)</span>
      <span class="kd">let</span> <span class="nx">com_2d_m</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
      <span class="kd">let</span> <span class="nx">mass_total_kg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="nx">Puck</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span> <span class="nx">puck</span> <span class="p">=&gt;</span> <span class="p">{</span>
         <span class="nx">com_2d_m</span> <span class="o">=</span> <span class="nx">com_2d_m</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span> <span class="nx">puck</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">.</span><span class="nx">scaleBy</span><span class="p">(</span> <span class="nx">puck</span><span class="p">.</span><span class="nx">mass_kg</span><span class="p">));</span>
         <span class="nx">mass_total_kg</span> <span class="o">+=</span> <span class="nx">puck</span><span class="p">.</span><span class="nx">mass_kg</span><span class="p">;</span>
      <span class="p">});</span>
      <span class="nx">com_2d_m</span> <span class="o">=</span> <span class="nx">com_2d_m</span><span class="p">.</span><span class="nx">scaleBy</span><span class="p">(</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="nx">mass_total_kg</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">com_2d_m</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="nx">Puck</span><span class="p">.</span><span class="nx">drawSystemCenterOfMass</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">drawingContext</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// The inherited drawing functions aren&#39;t available here, so using dF.</span>
      
      <span class="c1">// draw circle and cross hairs at SCM if more than one puck</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">puckMap</span><span class="p">).</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">let</span> <span class="nx">center_2d_px</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">screenFromWorld</span><span class="p">(</span> <span class="nx">Puck</span><span class="p">.</span><span class="nx">findCenterOfMass</span><span class="p">());</span>
         <span class="nx">dF</span><span class="p">.</span><span class="nx">drawMark</span><span class="p">(</span> <span class="nx">drawingContext</span><span class="p">,</span> <span class="nx">center_2d_px</span><span class="p">);</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="nx">Puck</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">inMultiSelect</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="k">in</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">map</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="nx">Puck</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">deleteThisOne</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">pars</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">deleteMode</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">deleteMode</span><span class="p">,</span> <span class="s1">&#39;fromBullet&#39;</span><span class="p">);</span>
      
      <span class="c1">// Add this player&#39;s score to the summary.</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">clientName</span><span class="p">)</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">clientName</span><span class="p">].</span><span class="nx">addScoreToSummary</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoIndex</span><span class="p">(),</span> <span class="nx">pP</span><span class="p">.</span><span class="nx">getNpcSleepUsage</span><span class="p">());</span>
      
      <span class="c1">// But first, give credit to the owner of the bullet that last hit you.</span>
      <span class="c1">// Ignore old bullets that are being removed. Don&#39;t give any credit for</span>
      <span class="c1">// deletion by the editor. Make sure the client is still there before</span>
      <span class="c1">// changing its score.</span>
      <span class="k">if</span> <span class="p">((</span><span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">bullet</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">deleteMode</span> <span class="o">!=</span> <span class="s1">&#39;fromEditor&#39;</span><span class="p">))</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">((</span> <span class="o">!</span> <span class="nx">cT</span><span class="p">.</span><span class="nx">Client</span><span class="p">.</span><span class="nx">winnerBonusGiven</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">whoShotBullet</span><span class="p">]))</span> <span class="p">{</span>
            <span class="c1">// Give 100 for client and drone pucks, 50 for regular pucks.</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">clientName</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">whoShotBullet</span><span class="p">].</span><span class="nx">score</span> <span class="o">+=</span> <span class="mi">100</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
               <span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">whoShotBullet</span><span class="p">].</span><span class="nx">score</span> <span class="o">+=</span> <span class="mi">50</span><span class="p">;</span>
            <span class="p">}</span>
         <span class="p">}</span>
      <span class="p">}</span>
      
      <span class="c1">// JavaScript uses garbage collection. Deleting a puck involves</span>
      <span class="c1">// mainly nullifying all references to the puck. (Also removing references</span>
      <span class="c1">// from the puck.)</span>
      
      <span class="c1">// Note that springs are checked, in the updateAirTable function, to</span>
      <span class="c1">// see if either of the two objects it is attached to has been deleted.</span>
      <span class="c1">// If so, the spring is deleted. So that&#39;s not needed here.</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">deleted</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">jet</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">gun</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">shield</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      
      <span class="c1">// Sound effect</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">bullet</span><span class="p">)</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">sounds</span><span class="p">[</span><span class="s1">&#39;highPop&#39;</span><span class="p">].</span><span class="nx">play</span><span class="p">();</span>
      
      <span class="c1">// For pucks that are driven by clients (users or NPC)</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">clientName</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">clientName</span> <span class="o">==</span> <span class="s1">&#39;local&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Must keep the local client. Just null out the puck reference in the local client.</span>
            <span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">clientName</span><span class="p">].</span><span class="nx">puck</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// Recently decided to turn off (for now) the client disconnect when the client puck gets</span>
            <span class="c1">// destroyed in a game of Puck Popper. So the following line is commented and then added</span>
            <span class="c1">// the next line where the puck on the client is nulled.</span>
            <span class="c1">//deleteRTC_onClientAndHost( this.clientName);</span>
            <span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">clientName</span><span class="p">].</span><span class="nx">puck</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
            
            <span class="c1">// Tell the client that his puck has been popped.</span>
            <span class="kd">var</span> <span class="nx">control_message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;from&#39;</span><span class="o">:</span><span class="s1">&#39;host&#39;</span><span class="p">,</span> <span class="s1">&#39;to&#39;</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">clientName</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="o">:</span><span class="p">{</span><span class="s1">&#39;puckPopped&#39;</span><span class="o">:</span><span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="o">:</span><span class="kc">true</span><span class="p">}}</span> <span class="p">};</span>
            <span class="nx">hC</span><span class="p">.</span><span class="nx">sendSocketControlMessage</span><span class="p">(</span> <span class="nx">control_message</span><span class="p">);</span>
            
            <span class="c1">// Remove the client if it&#39;s an NPC.</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">clientName</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;NPC&#39;</span><span class="p">)</span> <span class="p">{</span>
               <span class="k">delete</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span> <span class="k">this</span><span class="p">.</span><span class="nx">clientName</span><span class="p">];</span>
               <span class="nx">pP</span><span class="p">.</span><span class="nx">addToNpcCount</span><span class="p">(</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
            <span class="p">}</span>
         <span class="p">}</span>
         <span class="nx">pP</span><span class="p">.</span><span class="nx">incrementPlayerCount</span><span class="p">(</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
         <span class="nx">pP</span><span class="p">.</span><span class="nx">updateTeamInfo</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">clientName</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
      <span class="p">}</span>
      
      <span class="c1">// Filter out any reference to this jello puck in the jelloPuck array.</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">jello</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">jM</span><span class="p">.</span><span class="nx">removeDeletedPucks</span><span class="p">();</span>
      <span class="p">}</span>
      
      <span class="c1">// Delete the corresponding Box2d object.</span>
      <span class="nx">gW</span><span class="p">.</span><span class="nx">tableMap</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">);</span>
      <span class="nx">gW</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">world</span><span class="p">.</span><span class="nx">DestroyBody</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">);</span>
      
      <span class="c1">// Remove this puck from our puck map.</span>
      <span class="k">delete</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">puckMap</span><span class="p">[</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">];</span>
      
      <span class="c1">// ...and from the multi-select map.</span>
      <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">removeOne</span><span class="p">(</span> <span class="k">this</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="nx">Puck</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">copyThisOne</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">pars</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// If the position is not specified in pars, put the copy at the same position as the original.</span>
      <span class="kd">var</span> <span class="nx">position_2d_m</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">);</span>
      
      <span class="c1">// Make a copy of the mutable objects that are passed into the Puck constructor.</span>
      <span class="kd">var</span> <span class="nx">p_2d_m</span> <span class="o">=</span>          <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">({},</span> <span class="nx">position_2d_m</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">v_2d_mps</span> <span class="o">=</span>        <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">({},</span> <span class="k">this</span><span class="p">.</span><span class="nx">velocity_2d_mps</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">parsForNewBirth</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">({},</span> <span class="k">this</span><span class="p">.</span><span class="nx">parsAtBirth</span><span class="p">);</span>
      
      <span class="c1">// Make sure the name is nulled so the auto-naming feature is used in the constructor.</span>
      <span class="nx">parsForNewBirth</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="c1">// Don&#39;t allow any network client or NPC features.</span>
      <span class="nx">parsForNewBirth</span><span class="p">.</span><span class="nx">clientName</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="nx">parsForNewBirth</span><span class="p">.</span><span class="nx">pinName</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      
      <span class="cm">/*</span>
<span class="cm">      Update pars to reflect any edits or state changes. For example,</span>
<span class="cm">      this loop, for the first element in the array, does the following:</span>
<span class="cm">      parsForNewBirth.angle_r = this.angle_r;</span>
<span class="cm">      */</span>
      <span class="kd">var</span> <span class="nx">parsToCopy</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;angle_r&#39;</span><span class="p">,</span><span class="s1">&#39;angularSpeed_rps&#39;</span><span class="p">,</span><span class="s1">&#39;friction&#39;</span><span class="p">,</span><span class="s1">&#39;restitution&#39;</span><span class="p">,</span><span class="s1">&#39;linDamp&#39;</span><span class="p">,</span><span class="s1">&#39;angDamp&#39;</span><span class="p">,</span><span class="s1">&#39;bullet_restitution&#39;</span><span class="p">,</span><span class="s1">&#39;jello&#39;</span><span class="p">];</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">parsToCopy</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">parsForNewBirth</span><span class="p">[</span> <span class="nx">parsToCopy</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span> <span class="o">=</span> <span class="k">this</span><span class="p">[</span> <span class="nx">parsToCopy</span><span class="p">[</span><span class="nx">i</span><span class="p">]];</span>
      <span class="p">}</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">shape</span> <span class="o">==</span> <span class="s1">&#39;circle&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">parsForNewBirth</span><span class="p">.</span><span class="nx">radius_m</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">radius_m</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="nx">parsForNewBirth</span><span class="p">.</span><span class="nx">half_height_m</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">half_height_m</span><span class="p">;</span>
         <span class="nx">parsForNewBirth</span><span class="p">.</span><span class="nx">half_width_m</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">half_width_m</span><span class="p">;</span>
      <span class="p">}</span>
      
      <span class="c1">// If this is a drone puck, make a new NPC client for the copy.</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">clientName</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">clientName</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;NPC&#39;</span><span class="p">))</span> <span class="p">{</span>
         <span class="c1">// Sync the navigation timer of the copy to that of the original.</span>
         <span class="c1">// Note: instantiating with the current NPC name will increment the NPC counter (and the name).</span>
         <span class="kd">var</span> <span class="nx">theClientForTheCopy</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">cT</span><span class="p">.</span><span class="nx">Client</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">clientName</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="o">:</span><span class="s1">&#39;purple&#39;</span><span class="p">,</span> 
                                                  <span class="s1">&#39;NPC_pin_timer_s&#39;</span><span class="o">:</span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">clientName</span><span class="p">].</span><span class="nx">NPC_pin_timer_s</span><span class="p">,</span>
                                                  <span class="s1">&#39;NPC_pin_timer_limit_s&#39;</span><span class="o">:</span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">clientName</span><span class="p">].</span><span class="nx">NPC_pin_timer_limit_s</span><span class="p">});</span>
         <span class="c1">// Add the client name to the birth parameters for the puck.</span>
         <span class="nx">parsForNewBirth</span><span class="p">.</span><span class="nx">clientName</span> <span class="o">=</span> <span class="nx">theClientForTheCopy</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
      <span class="p">}</span>
      
      <span class="c1">// Reset the group index so the copy of a client puck will collide with the original.</span>
      <span class="c1">// Added this to deal with copies of client pucks that have a negative group index (that prevents collisions with their bullets, self shooting).</span>
      <span class="c1">// Want to be able to copy a client&#39;s puck but have it collide normally. Without this statement,</span>
      <span class="c1">// 7b, or any PP capture, would produce a copy that would not collide with the source puck.</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">clientName</span><span class="p">)</span> <span class="nx">parsForNewBirth</span><span class="p">.</span><span class="nx">groupIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      
      <span class="c1">// A copy of an NPC client puck will be fully outfitted (a client name is provided). </span>
      <span class="c1">// A copy of regular client puck will be only a puck shell (no client name).</span>
      <span class="kd">var</span> <span class="nx">newPuck</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Puck</span><span class="p">(</span> <span class="nx">p_2d_m</span><span class="p">,</span> <span class="nx">v_2d_mps</span><span class="p">,</span> <span class="nx">parsForNewBirth</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">newPuck</span><span class="p">.</span><span class="nx">jello</span><span class="p">)</span> <span class="nx">jM</span><span class="p">.</span><span class="nx">addPuck</span><span class="p">(</span> <span class="nx">newPuck</span><span class="p">);</span>
      
      <span class="k">return</span> <span class="nx">newPuck</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="nx">Puck</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">updateState</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">getPosition</span><span class="p">();</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">getVelocity</span><span class="p">();</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">getAngle</span><span class="p">();</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">getAngularSpeed</span><span class="p">();</span>
   <span class="p">}</span>   
   <span class="nx">Puck</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setPosition</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">pos_2d_m</span><span class="p">,</span> <span class="nx">angle_deg</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_m</span> <span class="o">=</span> <span class="nx">pos_2d_m</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_px</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">screenFromWorld</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">SetPosition</span><span class="p">(</span> <span class="nx">pos_2d_m</span><span class="p">);</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">velocity_2d_mps</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">SetLinearVelocity</span><span class="p">(</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">));</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">angularSpeed_rps</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">SetAngularVelocity</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">angularSpeed_rps</span><span class="p">);</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">SetAngle</span><span class="p">(</span> <span class="nx">angle_deg</span> <span class="o">*</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="o">/</span><span class="mf">180.0</span><span class="p">));</span>
   <span class="p">}</span>
   <span class="nx">Puck</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">create_Box2d_Puck</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">bodyDef</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">b2DW</span><span class="p">.</span><span class="nx">BodyDef</span><span class="p">;</span>
      <span class="nx">bodyDef</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="nx">b2DW</span><span class="p">.</span><span class="nx">Body</span><span class="p">.</span><span class="nx">b2_dynamicBody</span><span class="p">;</span>
      
      <span class="c1">// Create the body and a fixture.</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span> <span class="o">=</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">world</span><span class="p">.</span><span class="nx">CreateBody</span><span class="p">(</span> <span class="nx">bodyDef</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">CreateFixture</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">define_fixture</span><span class="p">(</span> <span class="p">{})</span> <span class="p">);</span>
      
      <span class="c1">// Set the state: position and velocity (angle and angular speed).</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">SetPosition</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">SetLinearVelocity</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">velocity_2d_mps</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">SetAngle</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">angle_r</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">SetAngularVelocity</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">angularSpeed_rps</span><span class="p">);</span>
      
      <span class="c1">// Use the mass and moment of inertia calculated by box2d.</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">mass_kg</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">GetMass</span><span class="p">();</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">inertia_kgm2</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">GetInertia</span><span class="p">();</span>
      <span class="cm">/*</span>
<span class="cm">      // just a check...</span>
<span class="cm">      let my_inertia_kgm2;</span>
<span class="cm">      if (this.shape == &quot;circle&quot;) {</span>
<span class="cm">         // I = (m/2) * r^2</span>
<span class="cm">         my_inertia_kgm2 = (1/2) * this.mass_kg * (this.radius_m)**2;</span>
<span class="cm">      } else {</span>
<span class="cm">         // I = (m/12) * (h^2 + w^2)^2</span>
<span class="cm">         my_inertia_kgm2 = (1/12) * this.mass_kg * ((this.half_height_m * 2)**2 + (this.half_width_m * 2)**2);</span>
<span class="cm">      }</span>
<span class="cm">      console.log(&quot;mOI=&quot; +  this.inertia_kgm2 + &quot;,&quot; + my_inertia_kgm2);</span>
<span class="cm">      */</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">SetLinearDamping</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">linDamp</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">SetAngularDamping</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">angDamp</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">SetBullet</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">bullet</span><span class="p">);</span>
      <span class="c1">//this.b2d.SetSleepingAllowed( false);</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">m_fixtureList</span><span class="p">.</span><span class="nx">SetFriction</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">friction</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">m_fixtureList</span><span class="p">.</span><span class="nx">SetRestitution</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">restitution</span><span class="p">);</span>
      
   <span class="p">}</span>
   <span class="nx">Puck</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">modify_Box2d_BodyAndFixture</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">fixture</span><span class="p">,</span> <span class="nx">pars</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// &quot;fixture&quot; can be either a created fixture object or a fixture definition (for use in creation).</span>
      
      <span class="c1">// Note that the default behavior is to have all scaling factors at 1.0 which only updates the box2d attributes</span>
      <span class="c1">// to correspond to those of the Puck object.</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">restitution_scaling</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">restitution_scaling</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">friction_scaling</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">friction_scaling</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">linDamp_scaling</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">linDamp_scaling</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">angDamp_scaling</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">angDamp_scaling</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
      
      <span class="c1">// Adjust elasticity (bounciness).</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">restitution_scaling</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">// If restitution is zero, bump it up a little so the scaling factor has something to work with.</span>
         <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">restitution</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">restitution</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">;</span>
         <span class="c1">// Apply the scaling factor.</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">restitution</span> <span class="o">*=</span> <span class="k">this</span><span class="p">.</span><span class="nx">restitution_scaling</span><span class="p">;</span>
         <span class="c1">// Keep it between 0.0 and 1.0.</span>
         <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">restitution</span> <span class="o">&gt;</span> <span class="mf">1.00</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">restitution</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>
         <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">restitution</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">restitution</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
         
         <span class="c1">// Keep this new restitution value independent of the gravity toggle.</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">restitution_fixed</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
         
         <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s2">&quot;[base,yellow]&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot;[base] restitution = &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">restitution</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="mf">0.5</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="c1">// If this fixture has been created, then use Set function.</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">fixture</span><span class="p">.</span><span class="nx">SetRestitution</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">fixture</span><span class="p">.</span><span class="nx">SetRestitution</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">restitution</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="nx">fixture</span><span class="p">.</span><span class="nx">restitution</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">restitution</span><span class="p">;</span>
      <span class="p">}</span>
      
      <span class="c1">// Adjust friction (surface tackiness).</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">friction_scaling</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">// If friction is zero, bump it up a little so the scaling factor has something to work with.</span>
         <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">friction</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">friction</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">;</span>
         <span class="c1">// Apply the scaling factor.</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">friction</span> <span class="o">*=</span> <span class="k">this</span><span class="p">.</span><span class="nx">friction_scaling</span><span class="p">;</span>
         <span class="c1">// Stop at zero.</span>
         <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">friction</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">friction</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
         
         <span class="c1">// Keep this new friction value independent of the gravity toggle.</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">friction_fixed</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
         
         <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s2">&quot;[base,yellow]&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot;[base] friction = &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">friction</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="mf">0.5</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="c1">// If this fixture has been created, then use Set function.</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">fixture</span><span class="p">.</span><span class="nx">SetFriction</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">fixture</span><span class="p">.</span><span class="nx">SetFriction</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">friction</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="nx">fixture</span><span class="p">.</span><span class="nx">friction</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">friction</span><span class="p">;</span>
      <span class="p">}</span>
      
      <span class="c1">// Adjust linear damping (damping from fluid drag).</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">linDamp_scaling</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">// If linear damping is zero, bump it up a little so the scaling factor has something to work with.</span>
         <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">linDamp</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">linDamp</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">;</span>
         <span class="c1">// Apply the scaling factor.</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">linDamp</span> <span class="o">*=</span> <span class="k">this</span><span class="p">.</span><span class="nx">linDamp_scaling</span><span class="p">;</span>
         <span class="c1">// Stop at zero.</span>
         <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">linDamp</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">linDamp</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
         <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s2">&quot;[base,yellow]&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot;[base] drag coefficient = &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">linDamp</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="mf">0.5</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="c1">// Note: linearDamping is a body property (not fixture property)</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">SetLinearDamping</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">linDamp</span><span class="p">);</span>
      
      <span class="c1">// Adjust angular damping (damping from fluid drag).</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">angDamp_scaling</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">// If angular damping is zero, bump it up a little so the scaling factor has something to work with.</span>
         <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">angDamp</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">angDamp</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">;</span>
         <span class="c1">// Apply the scaling factor.</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">angDamp</span> <span class="o">*=</span> <span class="k">this</span><span class="p">.</span><span class="nx">angDamp_scaling</span><span class="p">;</span>
         <span class="c1">// Stop at zero.</span>
         <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">angDamp</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">angDamp</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
         <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s2">&quot;[base,yellow]&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot;[base] rotational drag coefficient = &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">angDamp</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="mf">0.5</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="c1">// Note: AngularDamping is a body property (not fixture property)</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">SetAngularDamping</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">angDamp</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="nx">Puck</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">define_fixture</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">pars</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Note that the default behavior is to have all scaling factors at 1.0 which only updates the box2d attributes</span>
      <span class="c1">// to correspond to those of the Puck object.</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">width_scaling</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">width_scaling</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">height_scaling</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">height_scaling</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">radius_scaling</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">radius_scaling</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
      
      <span class="c1">// Create a circular or polygon dynamic box2d fixture.</span>
      <span class="kd">var</span> <span class="nx">fixDef</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">b2DW</span><span class="p">.</span><span class="nx">FixtureDef</span><span class="p">;</span>
      <span class="nx">fixDef</span><span class="p">.</span><span class="nx">density</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">density</span><span class="p">;</span>

      <span class="c1">// Adjust some of the attributes of the fixture definition.</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">modify_Box2d_BodyAndFixture</span><span class="p">(</span> <span class="nx">fixDef</span><span class="p">,</span> <span class="nx">pars</span><span class="p">);</span>
      
      <span class="nx">fixDef</span><span class="p">.</span><span class="nx">filter</span><span class="p">.</span><span class="nx">groupIndex</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">groupIndex</span><span class="p">;</span>
      <span class="nx">fixDef</span><span class="p">.</span><span class="nx">filter</span><span class="p">.</span><span class="nx">categoryBits</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">categoryBits</span><span class="p">;</span>
      <span class="nx">fixDef</span><span class="p">.</span><span class="nx">filter</span><span class="p">.</span><span class="nx">maskBits</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">maskBits</span><span class="p">;</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">shape</span> <span class="o">==</span> <span class="s1">&#39;circle&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">// Apply the radius scaling factor.</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">radius_m</span> <span class="o">*=</span> <span class="k">this</span><span class="p">.</span><span class="nx">radius_scaling</span><span class="p">;</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">radius_px</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">px_from_meters</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">radius_m</span><span class="p">);</span>
         <span class="cm">/* </span>
<span class="cm">         Don&#39;t let it get too small (except for gun bullets). </span>
<span class="cm">         Note this chokes off an editing series in a discontinuous way. So this choke is not allowed</span>
<span class="cm">         for a shooting puck in cannibalize mode. In that case, size restrictions must be done at time</span>
<span class="cm">         of shooting (see the restrictions in fireBullet in the puckPopper module). Otherwise the size </span>
<span class="cm">         reduction won&#39;t agree with the size of the bullet.</span>
<span class="cm">         */</span>
         <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">radius_px</span> <span class="o">&lt;</span> <span class="nx">Puck</span><span class="p">.</span><span class="nx">minRadius_px</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">gunBullet</span><span class="p">())</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">cannibalize</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">getPiCalcs</span><span class="p">().</span><span class="nx">enabled</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">radius_px</span> <span class="o">=</span> <span class="nx">Puck</span><span class="p">.</span><span class="nx">minRadius_px</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">radius_m</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">meters_from_px</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">radius_px</span><span class="p">);</span>
         <span class="p">}</span>
         
         <span class="c1">// Don&#39;t let client pucks get so big that their bullets can collide with the body of their ship.</span>
         <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">clientName</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">radius_m</span> <span class="o">&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">parsAtBirth</span><span class="p">.</span><span class="nx">radius_m</span><span class="p">)</span> <span class="p">{</span>
               <span class="k">this</span><span class="p">.</span><span class="nx">radius_m</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parsAtBirth</span><span class="p">.</span><span class="nx">radius_m</span><span class="p">;</span>
               <span class="k">this</span><span class="p">.</span><span class="nx">radius_px</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">px_from_meters</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">radius_m</span><span class="p">);</span>
            <span class="p">}</span>
         <span class="p">}</span>
         
         <span class="nx">fixDef</span><span class="p">.</span><span class="nx">shape</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">b2DW</span><span class="p">.</span><span class="nx">CircleShape</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">radius_m</span><span class="p">);</span>
      
      <span class="c1">// Rectangular (polygon) shapes</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="c1">// Apply the scaling factors to the current width and height.</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">half_width_m</span> <span class="o">*=</span> <span class="k">this</span><span class="p">.</span><span class="nx">width_scaling</span><span class="p">;</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">half_height_m</span> <span class="o">*=</span> <span class="k">this</span><span class="p">.</span><span class="nx">height_scaling</span><span class="p">;</span>
         
         <span class="k">this</span><span class="p">.</span><span class="nx">half_width_px</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">px_from_meters</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">half_width_m</span><span class="p">);</span>
         <span class="c1">// Don&#39;t let it get too skinny because it becomes hard to select.</span>
         <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">half_width_px</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">half_width_px</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">half_width_m</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">meters_from_px</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">half_width_px</span><span class="p">);</span>
         <span class="p">}</span>
         
         <span class="k">this</span><span class="p">.</span><span class="nx">half_height_px</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">px_from_meters</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">half_height_m</span><span class="p">);</span>
         <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">half_height_px</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">half_height_px</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">half_height_m</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">meters_from_px</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">half_height_px</span><span class="p">);</span>
         <span class="p">}</span>
         
         <span class="nx">fixDef</span><span class="p">.</span><span class="nx">shape</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">b2DW</span><span class="p">.</span><span class="nx">PolygonShape</span><span class="p">;</span>
         <span class="c1">// Make it a rectangle.</span>
         <span class="nx">fixDef</span><span class="p">.</span><span class="nx">shape</span><span class="p">.</span><span class="nx">SetAsBox</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">half_width_m</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">half_height_m</span><span class="p">);</span>
      <span class="p">}</span>
      
      <span class="k">return</span> <span class="nx">fixDef</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="nx">Puck</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">interpret_editCommand</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">command</span><span class="p">,</span> <span class="nx">sf</span> <span class="o">=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// For editing puck characteristics:</span>
      
      <span class="c1">// sf (specific factor) is used to override the default scaling factors.</span>
      
      <span class="c1">// Note: to modify the fixture dimensions you must delete</span>
      <span class="c1">// the old one and make a new one. The m_fixtureList linked list always</span>
      <span class="c1">// points to the most recent addition to the linked list. If there&#39;s only</span>
      <span class="c1">// one fixture, then m_fixtureList is a reference to that single fixture.</span>
      
      <span class="kd">var</span> <span class="nx">width_factor</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">height_factor</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">restitution_factor</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">friction_factor</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">drag_factor</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">angDrag_factor</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>
      
      <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">hack</span><span class="p">[</span><span class="s1">&#39;pwsEdits&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="nx">command</span> <span class="o">==</span> <span class="s1">&#39;wider&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">width_factor</span> <span class="o">=</span> <span class="p">(</span><span class="nx">sf</span><span class="p">)</span> <span class="o">?</span> <span class="nx">sf</span> <span class="o">:</span> <span class="mf">1.1</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">command</span> <span class="o">==</span> <span class="s1">&#39;thinner&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">width_factor</span> <span class="o">=</span> <span class="p">(</span><span class="nx">sf</span><span class="p">)</span> <span class="o">?</span> <span class="nx">sf</span> <span class="o">:</span> <span class="mf">1.0</span><span class="o">/</span><span class="mf">1.1</span><span class="p">;</span>
         
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">command</span> <span class="o">==</span> <span class="s1">&#39;taller&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">height_factor</span> <span class="o">=</span> <span class="p">(</span><span class="nx">sf</span><span class="p">)</span> <span class="o">?</span> <span class="nx">sf</span> <span class="o">:</span> <span class="mf">1.1</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">command</span> <span class="o">==</span> <span class="s1">&#39;shorter&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">height_factor</span> <span class="o">=</span> <span class="p">(</span><span class="nx">sf</span><span class="p">)</span> <span class="o">?</span> <span class="nx">sf</span> <span class="o">:</span> <span class="mf">1.0</span><span class="o">/</span><span class="mf">1.1</span><span class="p">;</span>
         
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">command</span> <span class="o">==</span> <span class="s1">&#39;moreDamping&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">restitution_factor</span> <span class="o">=</span> <span class="p">(</span><span class="nx">sf</span><span class="p">)</span> <span class="o">?</span> <span class="nx">sf</span> <span class="o">:</span> <span class="mf">1.0</span><span class="o">/</span><span class="mf">1.05</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">command</span> <span class="o">==</span> <span class="s1">&#39;lessDamping&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">restitution_factor</span> <span class="o">=</span> <span class="p">(</span><span class="nx">sf</span><span class="p">)</span> <span class="o">?</span> <span class="nx">sf</span> <span class="o">:</span> <span class="mf">1.05</span><span class="p">;</span>
      
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">command</span> <span class="o">==</span> <span class="s1">&#39;moreFriction&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">friction_factor</span> <span class="o">=</span> <span class="p">(</span><span class="nx">sf</span><span class="p">)</span> <span class="o">?</span> <span class="nx">sf</span> <span class="o">:</span> <span class="mf">1.05</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">command</span> <span class="o">==</span> <span class="s1">&#39;lessFriction&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">friction_factor</span> <span class="o">=</span> <span class="p">(</span><span class="nx">sf</span><span class="p">)</span> <span class="o">?</span> <span class="nx">sf</span> <span class="o">:</span> <span class="mf">1.0</span><span class="o">/</span><span class="mf">1.05</span><span class="p">;</span>
      
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">command</span> <span class="o">==</span> <span class="s1">&#39;moreDrag&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">drag_factor</span> <span class="o">=</span> <span class="p">(</span><span class="nx">sf</span><span class="p">)</span> <span class="o">?</span> <span class="nx">sf</span> <span class="o">:</span> <span class="mf">1.05</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">command</span> <span class="o">==</span> <span class="s1">&#39;lessDrag&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">drag_factor</span> <span class="o">=</span> <span class="p">(</span><span class="nx">sf</span><span class="p">)</span> <span class="o">?</span> <span class="nx">sf</span> <span class="o">:</span> <span class="mf">1.0</span><span class="o">/</span><span class="mf">1.05</span><span class="p">;</span>
      
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">command</span> <span class="o">==</span> <span class="s1">&#39;moreAngDrag&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">angDrag_factor</span> <span class="o">=</span> <span class="p">(</span><span class="nx">sf</span><span class="p">)</span> <span class="o">?</span> <span class="nx">sf</span> <span class="o">:</span> <span class="mf">1.05</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">command</span> <span class="o">==</span> <span class="s1">&#39;lessAngDrag&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">angDrag_factor</span> <span class="o">=</span> <span class="p">(</span><span class="nx">sf</span><span class="p">)</span> <span class="o">?</span> <span class="nx">sf</span> <span class="o">:</span> <span class="mf">1.0</span><span class="o">/</span><span class="mf">1.05</span><span class="p">;</span>
      
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">command</span> <span class="o">==</span> <span class="s1">&#39;noChange&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">// don&#39;t change anything.</span>
      <span class="p">}</span>
      
      <span class="k">if</span> <span class="p">([</span><span class="s1">&#39;wider&#39;</span><span class="p">,</span><span class="s1">&#39;thinner&#39;</span><span class="p">,</span><span class="s1">&#39;taller&#39;</span><span class="p">,</span><span class="s1">&#39;shorter&#39;</span><span class="p">].</span><span class="nx">includes</span><span class="p">(</span> <span class="nx">command</span><span class="p">))</span> <span class="p">{</span>
         <span class="c1">// Changes to the dimensions of the fixture require the fixture to be deleted and re-created.</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">DestroyFixture</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">m_fixtureList</span><span class="p">);</span>
         
         <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">shape</span> <span class="o">==</span> <span class="s1">&#39;circle&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Use either left/right or up/down to change the circle radius.</span>
            <span class="c1">// Note that adjustAttachments uses x,y factors, even for circular pucks. They must be set to be equal.</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">width_factor</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">)</span> <span class="p">{</span> 
               <span class="nx">height_factor</span> <span class="o">=</span> <span class="nx">width_factor</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">height_factor</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">)</span> <span class="p">{</span> 
               <span class="nx">width_factor</span> <span class="o">=</span> <span class="nx">height_factor</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">CreateFixture</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">define_fixture</span><span class="p">({</span><span class="s1">&#39;radius_scaling&#39;</span><span class="o">:</span><span class="nx">width_factor</span><span class="p">}));</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">CreateFixture</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">define_fixture</span><span class="p">({</span><span class="s1">&#39;width_scaling&#39;</span><span class="o">:</span><span class="nx">width_factor</span><span class="p">,</span> <span class="s1">&#39;height_scaling&#39;</span><span class="o">:</span><span class="nx">height_factor</span><span class="p">}));</span>
         <span class="p">}</span>
         
         <span class="c1">// Update the mass and moment of inertia.</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">mass_kg</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">GetMass</span><span class="p">();</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">inertia_kgm2</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">GetInertia</span><span class="p">();</span>
         
         <span class="k">if</span> <span class="p">((</span><span class="nx">height_factor</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">width_factor</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">))</span> <span class="p">{</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">shape</span> <span class="o">==</span> <span class="s2">&quot;circle&quot;</span><span class="p">)</span> <span class="p">{</span>
               <span class="kd">var</span> <span class="nx">dimensionsReport</span> <span class="o">=</span> <span class="s2">&quot;\\  radius = &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">radius_m</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; m&quot;</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
               <span class="kd">var</span> <span class="nx">dimensionsReport</span> <span class="o">=</span> <span class="s2">&quot;\\  half width, half height = &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">half_width_m</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">half_height_m</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; m&quot;</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="c1">// inhibit this message when a sf factor is provided (like when a shooting puck is in cannibalize mode)</span>
            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">sf</span><span class="p">)</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s2">&quot;[base,yellow]&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot;[base] mass = &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">mass_kg</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; kg&quot;</span> <span class="o">+</span> <span class="nx">dimensionsReport</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
         <span class="p">}</span>
         
         <span class="c1">// This step (after deleting and recreating the fixture) keeps the pucks from falling (penetrating) into the floor when gravity is on.</span>
         <span class="c1">// It&#39;s an odd buggy behavior that only lasts a few frames and then the engine seems to realize the object should be colliding with the floor.</span>
         <span class="c1">// This call to SetPosition somehow gets the collisions working immediately after the fixture violence. Surprising that this body procedure is necessary </span>
         <span class="c1">// since it was the fixture not the body, that was deleted.</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">SetPosition</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">);</span>
         
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="c1">// Non-dimensional changes can be made directly to the box2d body and fixture attributes.</span>
         <span class="kd">let</span> <span class="nx">scalingFactors</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;restitution_scaling&#39;</span><span class="o">:</span><span class="nx">restitution_factor</span><span class="p">,</span> <span class="s1">&#39;friction_scaling&#39;</span><span class="o">:</span><span class="nx">friction_factor</span><span class="p">,</span> <span class="s1">&#39;linDamp_scaling&#39;</span><span class="o">:</span><span class="nx">drag_factor</span><span class="p">,</span> <span class="s1">&#39;angDamp_scaling&#39;</span><span class="o">:</span><span class="nx">angDrag_factor</span><span class="p">};</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">modify_Box2d_BodyAndFixture</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">m_fixtureList</span><span class="p">,</span> <span class="nx">scalingFactors</span><span class="p">);</span>
      <span class="p">}</span>
      
      <span class="c1">// As the puck is resized, adjust attachment points, and multiselect points.</span>
      <span class="nx">adjustAttachments</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">width_factor</span><span class="p">,</span> <span class="nx">height_factor</span><span class="p">);</span>
            
      <span class="c1">// Update the puck tail radius.</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">tail</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">tail</span><span class="p">.</span><span class="nx">initial_radius_m</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">radius_m</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="nx">Puck</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">gunBullet</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">bullet</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">ageLimit_ms</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="nx">Puck</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">regularBullet</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">bullet</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">ageLimit_ms</span><span class="p">));</span>
   <span class="p">}</span>
   <span class="nx">Puck</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getPosition</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_m</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D_from_b2Vec2</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">GetPosition</span><span class="p">());</span>
   <span class="p">}</span>
   <span class="nx">Puck</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">worldPoint</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">localPoint_2d</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D_from_b2Vec2</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">GetWorldPoint</span><span class="p">(</span> <span class="nx">localPoint_2d</span><span class="p">));</span>
   <span class="p">}</span>
   <span class="nx">Puck</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getVelocity</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="c1">// COM velocity</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">velocity_2d_mps</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D_from_b2Vec2</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">GetLinearVelocity</span><span class="p">());</span>
   <span class="p">}</span>
   <span class="nx">Puck</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getAngle</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="c1">// COM angle (radians)</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">angle_r</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">GetAngle</span><span class="p">();</span>
   <span class="p">}</span>   
   <span class="nx">Puck</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getAngularSpeed</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="c1">// COM angular speed (radians per second)</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">angularSpeed_rps</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">GetAngularVelocity</span><span class="p">();</span>
   <span class="p">}</span>  
   <span class="nx">Puck</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">angularMomentum_Orbital</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="c1">// separation of the puck center from the axis of angular momentum</span>
      <span class="kd">let</span> <span class="nx">r_2d_m</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span> <span class="nx">m_EpL</span><span class="p">.</span><span class="nx">angularAxis_2d_m</span><span class="p">);</span>
      <span class="c1">// Lo = m * (r x v)</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">mass_kg</span> <span class="o">*</span> <span class="nx">r_2d_m</span><span class="p">.</span><span class="nx">cross</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">velocity_2d_mps</span><span class="p">);</span>
   <span class="p">}</span>  
   <span class="nx">Puck</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">angularMomentum_Spin</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="c1">// Originally was going to calculate the moments of inertia, then decided to use box2d.</span>
      <span class="c1">// So, leaving this here as documentation...</span>
      <span class="cm">/*</span>
<span class="cm">      let spinAngularMomentum;</span>
<span class="cm">      // Ls = I * omega</span>
<span class="cm">      if (this.shape == &quot;circle&quot;) {</span>
<span class="cm">         // Ls = (m/2) * r^2 * omega</span>
<span class="cm">         spinAngularMomentum = (1/2) * this.mass_kg * (this.radius_m)**2 * this.angularSpeed_rps;</span>
<span class="cm">      } else {</span>
<span class="cm">         // Ls = (m/12) * (h^2 + w^2)^2 * omega</span>
<span class="cm">         spinAngularMomentum = (1/12) * this.mass_kg * ((this.half_height_m * 2)**2 + (this.half_width_m * 2)**2) * this.angularSpeed_rps;</span>
<span class="cm">      }</span>
<span class="cm">      */</span>
      <span class="kd">let</span> <span class="nx">spinAngularMomentum</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">inertia_kgm2</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">angularSpeed_rps</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">spinAngularMomentum</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="nx">Puck</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">energyKinetic_rotational</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">inertia_kgm2</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">angularSpeed_rps</span><span class="o">**</span><span class="mi">2</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="nx">Puck</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">energyKinetic_translational</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">mass_kg</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">velocity_2d_mps</span><span class="p">.</span><span class="nx">length_squared</span><span class="p">();</span>
   <span class="p">}</span>
   <span class="nx">Puck</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">potentialEnergy</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">pe</span> <span class="o">=</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">getG_ON</span><span class="p">())</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">mass_kg</span> <span class="o">*</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">getG_mps2</span><span class="p">()</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">.</span><span class="nx">y</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">pe</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="nx">Puck</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">drawClientName</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">drawingContext</span><span class="p">,</span> <span class="nx">deltaT_s</span><span class="p">,</span> <span class="nx">pars</span> <span class="o">=</span> <span class="p">{})</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">stayOn</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">stayOn</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
      
      <span class="k">if</span> <span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">nameTip_timer_s</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">nameTip_timerLimit_s</span><span class="p">)</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">stayOn</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">nameTip_timer_s</span> <span class="o">+=</span> <span class="nx">deltaT_s</span><span class="p">;</span>
         
         <span class="kd">let</span> <span class="nx">font</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">font</span><span class="p">,</span> <span class="s2">&quot;20px Arial&quot;</span><span class="p">);</span>
         <span class="kd">let</span> <span class="nx">teamFont</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">teamFont</span><span class="p">,</span> <span class="s2">&quot;18px Arial&quot;</span><span class="p">);</span>
         <span class="kd">let</span> <span class="nx">color</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">color</span><span class="p">,</span> <span class="s1">&#39;lightgray&#39;</span><span class="p">);</span>
         
         <span class="kd">let</span> <span class="nx">nickName</span><span class="p">;</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">clientName</span><span class="p">].</span><span class="nx">nickName</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">nickName</span> <span class="o">=</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">clientName</span><span class="p">].</span><span class="nx">nickName</span><span class="p">;</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">nickName</span> <span class="o">=</span> <span class="nx">cT</span><span class="p">.</span><span class="nx">Client</span><span class="p">.</span><span class="nx">translateIfLocal</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">clientName</span><span class="p">);</span> 
         <span class="p">}</span>
         
         <span class="nx">drawingContext</span><span class="p">.</span><span class="nx">font</span> <span class="o">=</span> <span class="nx">font</span><span class="p">;</span>
         <span class="nx">drawingContext</span><span class="p">.</span><span class="nx">fillStyle</span> <span class="o">=</span> <span class="nx">color</span><span class="p">;</span>
         <span class="nx">drawingContext</span><span class="p">.</span><span class="nx">textAlign</span> <span class="o">=</span> <span class="s2">&quot;center&quot;</span><span class="p">;</span>
         <span class="kd">let</span> <span class="nx">x_px</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_px</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
         
         <span class="c1">// Draw nick name (over the puck)</span>
         <span class="kd">var</span> <span class="nx">y_px</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_px</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">radius_px</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
         <span class="nx">drawingContext</span><span class="p">.</span><span class="nx">fillText</span><span class="p">(</span> <span class="nx">nickName</span><span class="p">,</span> <span class="nx">x_px</span><span class="p">,</span> <span class="nx">y_px</span><span class="p">);</span>
         
         <span class="c1">// Draw team name (inside the puck)</span>
         <span class="kd">let</span> <span class="nx">teamName</span> <span class="o">=</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">clientName</span><span class="p">].</span><span class="nx">teamName</span><span class="p">;</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">teamName</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">drawingContext</span><span class="p">.</span><span class="nx">font</span> <span class="o">=</span> <span class="nx">teamFont</span><span class="p">;</span>
            <span class="kd">let</span> <span class="nx">lineHeight_px</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span> <span class="nx">teamFont</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span> <span class="o">*</span> <span class="mf">1.30</span><span class="p">;</span>
            <span class="nx">y_px</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_px</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">radius_px</span> <span class="o">+</span> <span class="nx">lineHeight_px</span><span class="p">;</span>
            <span class="nx">drawingContext</span><span class="p">.</span><span class="nx">fillText</span><span class="p">(</span> <span class="nx">teamName</span><span class="p">,</span> <span class="nx">x_px</span><span class="p">,</span> <span class="nx">y_px</span><span class="p">);</span> 
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>      
   <span class="nx">Puck</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">drawImage</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">drawingContext</span><span class="p">,</span> <span class="nx">imageID</span><span class="p">,</span> <span class="nx">imageScale</span><span class="p">,</span> <span class="nx">alpha</span><span class="p">,</span> <span class="nx">rotateWithPuck</span><span class="o">=</span><span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">img</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span> <span class="nx">imageID</span><span class="p">);</span>
      
      <span class="kd">let</span> <span class="nx">imageWidth_px</span><span class="p">,</span> <span class="nx">imageHeight_px</span><span class="p">,</span> <span class="nx">offset_x_px</span><span class="p">,</span> <span class="nx">offset_y_px</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">shape</span> <span class="o">==</span> <span class="s1">&#39;circle&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">imageWidth_px</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">radius_px</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="nx">imageScale</span><span class="p">;</span>
         <span class="nx">imageHeight_px</span> <span class="o">=</span> <span class="nx">imageWidth_px</span><span class="p">;</span>
         
         <span class="c1">// (my) offset is the distance from center to top left edge of image: half width and half height.</span>
         <span class="nx">offset_x_px</span> <span class="o">=</span> <span class="nx">imageWidth_px</span><span class="o">/</span><span class="mf">2.0</span><span class="p">;</span>
         <span class="nx">offset_y_px</span> <span class="o">=</span> <span class="nx">offset_x_px</span><span class="p">;</span>
         
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="nx">imageWidth_px</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">half_width_px</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="nx">imageScale</span><span class="p">;</span>
         <span class="nx">imageHeight_px</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">half_height_px</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="nx">imageScale</span><span class="p">;</span>
         
         <span class="c1">// (my) offset is the distance from center to top left edge of image: half width and half height.</span>
         <span class="nx">offset_x_px</span> <span class="o">=</span> <span class="nx">imageWidth_px</span><span class="o">/</span><span class="mf">2.0</span><span class="p">;</span>
         <span class="nx">offset_y_px</span> <span class="o">=</span> <span class="nx">imageHeight_px</span><span class="o">/</span><span class="mf">2.0</span><span class="p">;</span>
      <span class="p">}</span>
      
      <span class="nx">drawingContext</span><span class="p">.</span><span class="nx">globalAlpha</span> <span class="o">=</span> <span class="nx">alpha</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">rotateWithPuck</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">// Must translate before doing the rotation</span>
         <span class="nx">drawingContext</span><span class="p">.</span><span class="nx">translate</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_px</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_px</span><span class="p">.</span><span class="nx">y</span><span class="p">);</span>
         <span class="nx">drawingContext</span><span class="p">.</span><span class="nx">rotate</span><span class="p">(</span> <span class="o">-</span><span class="k">this</span><span class="p">.</span><span class="nx">angle_r</span><span class="p">);</span>
         <span class="nx">drawingContext</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span> <span class="nx">img</span><span class="p">,</span> <span class="o">-</span><span class="nx">offset_x_px</span><span class="p">,</span> <span class="o">-</span><span class="nx">offset_y_px</span><span class="p">,</span> <span class="nx">imageWidth_px</span><span class="p">,</span> <span class="nx">imageHeight_px</span><span class="p">);</span>
         <span class="nx">drawingContext</span><span class="p">.</span><span class="nx">rotate</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">angle_r</span><span class="p">);</span>
         <span class="nx">drawingContext</span><span class="p">.</span><span class="nx">translate</span><span class="p">(</span> <span class="o">-</span><span class="k">this</span><span class="p">.</span><span class="nx">position_2d_px</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="o">-</span><span class="k">this</span><span class="p">.</span><span class="nx">position_2d_px</span><span class="p">.</span><span class="nx">y</span><span class="p">);</span>
         
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="c1">//                             left edge--------------------------, top edge---------------------------,</span>
         <span class="nx">drawingContext</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span> <span class="nx">img</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_px</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">offset_x_px</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_px</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">offset_y_px</span><span class="p">,</span> <span class="nx">imageWidth_px</span><span class="p">,</span> <span class="nx">imageHeight_px</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">drawingContext</span><span class="p">.</span><span class="nx">globalAlpha</span> <span class="o">=</span> <span class="mf">1.00</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="nx">Puck</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">drawStripe</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">drawingContext</span><span class="p">,</span> <span class="nx">pars</span><span class="o">=</span><span class="p">{})</span> <span class="p">{</span>
      <span class="c1">// Draw and fill the curved areas that define the outer edge (the background) of the stripe.</span>
      
      <span class="kd">let</span> <span class="nx">outsideColor</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">outsideColor</span><span class="p">,</span> <span class="s1">&#39;lightgray&#39;</span><span class="p">);</span>
      <span class="kd">let</span> <span class="nx">changeFromRadius_px</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">changeFromRadius_px</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
      <span class="kd">let</span> <span class="nx">width</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">);</span> <span class="c1">// 0.05: thin stripe, 0.30: stripe almost covers puck</span>
      <span class="kd">let</span> <span class="nx">stripeAngle_r</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">stripeAngle_r</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
      <span class="kd">let</span> <span class="nx">trackPuckAngle</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">trackPuckAngle</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="nx">trackPuckAngle</span><span class="p">)</span> <span class="nx">stripeAngle_r</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">angle_r</span><span class="p">;</span>
      
      <span class="c1">// Fill the area between the arc and a line connecting the arc&#39;s end points.</span>
      <span class="nx">drawingContext</span><span class="p">.</span><span class="nx">fillStyle</span> <span class="o">=</span> <span class="nx">outsideColor</span><span class="p">;</span>
      <span class="nx">drawingContext</span><span class="p">.</span><span class="nx">beginPath</span><span class="p">();</span>
      <span class="c1">// Note that the start and end angles are entered with a negative sign to be consistent with Box2D.</span>
      <span class="nx">drawingContext</span><span class="p">.</span><span class="nx">arc</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_px</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_px</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="c1">// center position (pixels)</span>
                          <span class="k">this</span><span class="p">.</span><span class="nx">radius_px</span> <span class="o">+</span> <span class="nx">changeFromRadius_px</span><span class="p">,</span> <span class="c1">// radius (pixels)</span>
                          <span class="o">-</span><span class="p">(</span><span class="nx">stripeAngle_r</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.0</span> <span class="o">+</span> <span class="nx">width</span><span class="p">)</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="p">),</span> <span class="c1">// start angle (radians)</span>
                          <span class="o">-</span><span class="p">(</span><span class="nx">stripeAngle_r</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="nx">width</span><span class="p">)</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="p">),</span> <span class="c1">// end angle</span>
                          <span class="kc">true</span><span class="p">);</span> <span class="c1">// counterclockwise if true</span>
      <span class="nx">drawingContext</span><span class="p">.</span><span class="nx">fill</span><span class="p">();</span> 
      <span class="c1">// Now, do the other side.</span>
      <span class="nx">drawingContext</span><span class="p">.</span><span class="nx">fillStyle</span> <span class="o">=</span> <span class="nx">outsideColor</span><span class="p">;</span>
      <span class="nx">drawingContext</span><span class="p">.</span><span class="nx">beginPath</span><span class="p">();</span>
      <span class="nx">drawingContext</span><span class="p">.</span><span class="nx">arc</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_px</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_px</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> 
                          <span class="k">this</span><span class="p">.</span><span class="nx">radius_px</span> <span class="o">+</span> <span class="nx">changeFromRadius_px</span><span class="p">,</span> 
                          <span class="o">-</span><span class="p">(</span><span class="nx">stripeAngle_r</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="nx">width</span><span class="p">)</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="p">),</span> 
                          <span class="o">-</span><span class="p">(</span><span class="nx">stripeAngle_r</span> <span class="o">+</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">-</span> <span class="nx">width</span><span class="p">)</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="p">),</span> 
                          <span class="kc">true</span><span class="p">);</span>
      <span class="nx">drawingContext</span><span class="p">.</span><span class="nx">fill</span><span class="p">();</span>
   <span class="p">}</span>   
   <span class="nx">Puck</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">draw</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">drawingContext</span><span class="p">,</span> <span class="nx">deltaT_s</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_px</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">screenFromWorld</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">borderColor</span><span class="p">,</span> <span class="nx">fillColor</span><span class="p">,</span> <span class="nx">fillAlpha</span><span class="p">;</span>
      
      <span class="c1">// Exit if puck is to be invisible during PauseErase.</span>
      <span class="k">if</span> <span class="p">(</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">getPauseErase</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">drawDuringPE</span><span class="p">)</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>
      
      <span class="c1">// Refer to index.html for the hidden image elements that are needed for each imageID (search on &quot;puck costumes&quot;).</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">shape</span> <span class="o">==</span> <span class="s1">&#39;circle&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#chkC19&#39;</span><span class="p">).</span><span class="nx">prop</span><span class="p">(</span><span class="s1">&#39;checked&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">clientName</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">clientName</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;NPC&#39;</span><span class="p">))</span> <span class="p">{</span> 
            <span class="c1">// Virus                                 scale, alpha, rotate</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span> <span class="nx">drawingContext</span><span class="p">,</span> <span class="s1">&#39;covid&#39;</span><span class="p">,</span> <span class="mf">1.65</span><span class="p">,</span>  <span class="mf">1.00</span><span class="p">,</span>  <span class="kc">false</span><span class="p">);</span>
            <span class="nx">fillColor</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">color</span><span class="p">;</span>
            <span class="nx">fillAlpha</span> <span class="o">=</span> <span class="mf">1.00</span><span class="p">;</span>
         
         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">imageID</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span> <span class="nx">drawingContext</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">imageID</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">imageScale</span><span class="p">,</span> <span class="mf">1.00</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
            <span class="nx">fillColor</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">color</span><span class="p">;</span>
            <span class="nx">fillAlpha</span> <span class="o">=</span> <span class="mf">0.00</span><span class="p">;</span>
         
         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">hsl</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">fillColor</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">hsl</span><span class="p">.</span><span class="nx">colorString</span><span class="p">();</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">hsl</span><span class="p">.</span><span class="nx">step</span><span class="p">();</span>
            <span class="nx">fillAlpha</span> <span class="o">=</span> <span class="mf">1.00</span><span class="p">;</span>
            
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">fillColor</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">color</span><span class="p">;</span>
            <span class="nx">fillAlpha</span> <span class="o">=</span> <span class="mf">1.00</span><span class="p">;</span>
         <span class="p">}</span>
         
         <span class="c1">// Draw the main circle.</span>
         <span class="c1">// If hit, color the border red for a few frames.</span>
         <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">flash</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">borderColor</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">flashCount</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">flashCount</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
               <span class="k">this</span><span class="p">.</span><span class="nx">flash</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
               <span class="k">this</span><span class="p">.</span><span class="nx">flashCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">borderColor</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">borderColor</span><span class="p">;</span>
         <span class="p">}</span>
         
         <span class="k">if</span> <span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">bullet</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">bulletIndication</span><span class="p">))</span> <span class="nx">fillColor</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span><span class="p">;</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">drawCircle</span><span class="p">(</span> <span class="nx">drawingContext</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_px</span><span class="p">,</span> 
                <span class="p">{</span><span class="s1">&#39;borderColor&#39;</span><span class="o">:</span><span class="nx">borderColor</span><span class="p">,</span> <span class="s1">&#39;borderWidth_px&#39;</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">borderWidth_px</span><span class="p">,</span> <span class="s1">&#39;fillColor&#39;</span><span class="o">:</span><span class="nx">fillColor</span><span class="p">,</span> <span class="s1">&#39;radius_px&#39;</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">radius_px</span><span class="p">,</span> <span class="s1">&#39;fillAlpha&#39;</span><span class="o">:</span><span class="nx">fillAlpha</span><span class="p">}</span> <span class="p">);</span>
         
         <span class="c1">// Draw the health circle.</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">poorHealthFraction</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">hitCount</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">hitLimit</span><span class="p">;</span>
         <span class="kd">var</span> <span class="nx">poorHealthRadius</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">radius_px</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">poorHealthFraction</span><span class="p">;</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">poorHealthRadius</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">drawCircle</span><span class="p">(</span> <span class="nx">drawingContext</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_px</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;borderColor&#39;</span><span class="o">:</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="s1">&#39;borderWidth_px&#39;</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;fillColor&#39;</span><span class="o">:</span><span class="s1">&#39;chocolate&#39;</span><span class="p">,</span> <span class="s1">&#39;radius_px&#39;</span><span class="o">:</span><span class="nx">poorHealthRadius</span><span class="p">}</span> <span class="p">);</span>
         <span class="p">}</span>
         
         <span class="k">if</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">clientName</span><span class="p">])</span> <span class="p">{</span>
            <span class="c1">// Update and draw the shield.</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">shield</span><span class="p">.</span><span class="nx">updateState</span><span class="p">(</span> <span class="nx">drawingContext</span><span class="p">,</span> <span class="nx">deltaT_s</span><span class="p">);</span>
            
            <span class="c1">// Draw the client finder circle. Big fat one. Easy to see. So you can find your puck.</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">clientName</span><span class="p">].</span><span class="nx">key_questionMark</span> <span class="o">==</span> <span class="s2">&quot;D&quot;</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">clientName</span><span class="p">].</span><span class="nx">puck</span><span class="p">.</span><span class="nx">nameTip_timer_s</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
               <span class="k">this</span><span class="p">.</span><span class="nx">drawCircle</span><span class="p">(</span> <span class="nx">drawingContext</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_px</span><span class="p">,</span> 
                  <span class="p">{</span><span class="s1">&#39;borderColor&#39;</span><span class="o">:</span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">clientName</span><span class="p">].</span><span class="nx">color</span><span class="p">,</span> 
                   <span class="s1">&#39;fillColor&#39;</span><span class="o">:</span><span class="s1">&#39;noFill&#39;</span><span class="p">,</span> 
                   <span class="s1">&#39;borderWidth_px&#39;</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">radius_px</span> <span class="o">*</span> <span class="mf">0.3</span><span class="p">,</span> 
                   <span class="s1">&#39;radius_px&#39;</span>     <span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">radius_px</span> <span class="o">*</span> <span class="mf">1.5</span> <span class="p">}</span> <span class="p">);</span>
            <span class="p">}</span>
         <span class="p">}</span>
         
         <span class="c1">// Show rotational orientation</span>
         <span class="k">if</span> <span class="p">(</span> <span class="p">(</span> <span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">gun</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">angleLine</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">angleLine</span> <span class="o">==</span> <span class="s2">&quot;stripe&quot;</span><span class="p">)</span> <span class="p">{</span>
               <span class="k">this</span><span class="p">.</span><span class="nx">drawStripe</span><span class="p">(</span> <span class="nx">drawingContext</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;trackPuckAngle&quot;</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span> <span class="s2">&quot;outsideColor&quot;</span><span class="o">:</span><span class="s2">&quot;gray&quot;</span><span class="p">});</span>
               
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
               <span class="c1">// Draw a line segment along the line from the center out to a local point on the radius.</span>
               <span class="c1">// Don&#39;t show this line for client pucks (gun) in Puck Popper.</span>
               <span class="kd">var</span> <span class="nx">pointOnEdge_2d_px</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">screenFromWorld</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">GetWorldPoint</span><span class="p">(</span> <span class="k">new</span> <span class="nx">b2DW</span><span class="p">.</span><span class="nx">Vec2</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">radius_m</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="p">)</span> <span class="p">);</span>
               <span class="kd">var</span> <span class="nx">pointAtHalfRadius_2d_px</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">screenFromWorld</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">GetWorldPoint</span><span class="p">(</span> <span class="k">new</span> <span class="nx">b2DW</span><span class="p">.</span><span class="nx">Vec2</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">radius_m</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="mf">2.0</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">)</span> <span class="p">)</span> <span class="p">);</span>
               <span class="k">this</span><span class="p">.</span><span class="nx">drawLine</span><span class="p">(</span> <span class="nx">drawingContext</span><span class="p">,</span> <span class="nx">pointAtHalfRadius_2d_px</span><span class="p">,</span> <span class="nx">pointOnEdge_2d_px</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;width_px&#39;</span><span class="o">:</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="o">:</span><span class="s1">&#39;white&#39;</span><span class="p">});</span>
            <span class="p">}</span>
         <span class="p">}</span>
         
         <span class="c1">// Draw the tail if we have one.</span>
         <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">tail</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">tail</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span> <span class="nx">drawingContext</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">,</span> <span class="nx">deltaT_s</span><span class="p">);</span>
         
         <span class="c1">// If pool game:</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoVersion</span><span class="p">().</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;3.d&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// label pucks, draw stripe, draw finder circle</span>
            <span class="nx">gB</span><span class="p">.</span><span class="nx">drawPoolBallFeatures</span><span class="p">(</span> <span class="nx">drawingContext</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
         <span class="p">}</span>
      
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="c1">// Draw the rectangle.</span>
         <span class="c1">// This border width adjustment gives a similar result for rectangles when compared with the circle case.</span>
         <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">borderWidth_px</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">rect_borderWidth_px</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">borderWidth_px</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">borderWidth_px</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">rect_borderWidth_px</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">borderWidth_px</span><span class="p">;</span>
         <span class="p">}</span>
         
         <span class="kd">var</span> <span class="nx">fillColor</span> <span class="o">=</span> <span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">bullet</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">bulletIndication</span><span class="p">))</span> <span class="o">?</span> <span class="s1">&#39;black&#39;</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">color</span><span class="p">;</span>
         
         <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">imageID</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span> <span class="nx">drawingContext</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">imageID</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">imageScale</span><span class="p">,</span> <span class="mf">1.00</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
            <span class="kd">var</span> <span class="nx">rect_borderWidth_px</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">lineAlpha</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">fillIt</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">lineAlpha</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">fillIt</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
         <span class="p">}</span>
         
         <span class="k">this</span><span class="p">.</span><span class="nx">drawPolygon</span><span class="p">(</span> <span class="nx">drawingContext</span><span class="p">,</span> <span class="nx">bS</span><span class="p">.</span><span class="nx">b2d_getPolygonVertices_2d_px</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">),</span> 
            <span class="p">{</span><span class="s1">&#39;borderColor&#39;</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">borderColor</span><span class="p">,</span><span class="s1">&#39;borderWidth_px&#39;</span><span class="o">:</span><span class="nx">rect_borderWidth_px</span><span class="p">,</span><span class="s1">&#39;fillColor&#39;</span><span class="o">:</span><span class="nx">fillColor</span><span class="p">,</span><span class="s1">&#39;fillIt&#39;</span><span class="o">:</span><span class="nx">fillIt</span><span class="p">,</span><span class="s1">&#39;lineAlpha&#39;</span><span class="o">:</span><span class="nx">lineAlpha</span><span class="p">});</span>
      <span class="p">}</span>
      
      <span class="k">if</span> <span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">clientName</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">clientName</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;NPC&#39;</span><span class="p">))</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">drawClientName</span><span class="p">(</span> <span class="nx">drawingContext</span><span class="p">,</span> <span class="nx">deltaT_s</span><span class="p">);</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="nx">Puck</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">draw_MultiSelectPoint</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">drawingContext</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">selectionPoint_2d_px</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">comSelection</span><span class="p">.</span><span class="nx">checked</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">selectionPoint_2d_px</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">screenFromWorld</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">GetWorldPoint</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">selectionPoint_l_2d_m</span><span class="p">));</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="nx">selectionPoint_2d_px</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_px</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">drawCircle</span><span class="p">(</span> <span class="nx">drawingContext</span><span class="p">,</span> <span class="nx">selectionPoint_2d_px</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;borderColor&#39;</span><span class="o">:</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="s1">&#39;borderWidth_px&#39;</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;fillColor&#39;</span><span class="o">:</span><span class="s1">&#39;yellow&#39;</span><span class="p">,</span> <span class="s1">&#39;radius_px&#39;</span><span class="o">:</span><span class="mi">5</span><span class="p">});</span>
   <span class="p">}</span>
   <span class="nx">Puck</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">applyForces</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">deltaT_s</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Net resulting force on the puck.</span>
      
      <span class="c1">// First consider forces acting on the COM.</span>
      
      <span class="c1">// F = acceleration * mass</span>
      <span class="kd">var</span> <span class="nx">g_force_2d_N</span> <span class="o">=</span> <span class="nx">Puck</span><span class="p">.</span><span class="nx">g_2d_mps2</span><span class="p">.</span><span class="nx">scaleBy</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">mass_kg</span><span class="p">);</span>
      
      <span class="kd">var</span> <span class="nx">puck_forces_2d_N</span> <span class="o">=</span> <span class="nx">g_force_2d_N</span><span class="p">;</span>
          <span class="nx">puck_forces_2d_N</span><span class="p">.</span><span class="nx">addTo</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">sprDamp_force_2d_N</span><span class="p">);</span> 
          
          <span class="nx">puck_forces_2d_N</span><span class="p">.</span><span class="nx">addTo</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">jet_force_2d_N</span><span class="p">);</span>
          <span class="nx">puck_forces_2d_N</span><span class="p">.</span><span class="nx">addTo</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">impulse_2d_Ns</span><span class="p">.</span><span class="nx">scaleBy</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="nx">deltaT_s</span><span class="p">));</span>

      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">tempInhibitExtForce</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">// Apply this force to the puck&#39;s center of mass (COM) in the Box2d world</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">ApplyForce</span><span class="p">(</span> <span class="nx">puck_forces_2d_N</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">);</span>
         
         <span class="c1">// Apply any non-COM forces in the array. The spring forces are this array.</span>
         <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">len</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">nonCOM_2d_N</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">ApplyForce</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">nonCOM_2d_N</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">force_2d_N</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">nonCOM_2d_N</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">point_w_2d_m</span><span class="p">);</span>
         <span class="p">}</span>
         <span class="cm">/*         </span>
<span class="cm">         // Apply torques.   #b2d</span>
<span class="cm">         */</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">tempInhibitExtForce</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span>
      
      <span class="c1">// Now reset the aggregate forces.</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">sprDamp_force_2d_N</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">nonCOM_2d_N</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">impulse_2d_Ns</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">);</span>
   <span class="p">}</span>



   <span class="c1">// Static spring anchors (no collisions)</span>
   <span class="kd">function</span> <span class="nx">Pin</span><span class="p">(</span> <span class="nx">position_2d_m</span><span class="p">,</span> <span class="nx">pars</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">dFM</span><span class="p">.</span><span class="nx">DrawingFunctions</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="c1">// inherit</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">parsAtBirth</span> <span class="o">=</span> <span class="nx">pars</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">cursorPin</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">cursorPin</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
      
      <span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">assignName</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">Pin</span><span class="p">.</span><span class="nx">nameIndex</span><span class="p">,</span> <span class="s2">&quot;pin&quot;</span><span class="p">,</span> <span class="s2">&quot;pinMap&quot;</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
      <span class="nx">Pin</span><span class="p">.</span><span class="nx">nameIndex</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">index</span><span class="p">;</span>
      
      <span class="c1">// Don&#39;t put cursor pins in the map.</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">cursorPin</span><span class="p">)</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">pinMap</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_m</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D_check</span><span class="p">(</span> <span class="nx">position_2d_m</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_px</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">screenFromWorld</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">);</span>
      
      <span class="c1">// Local selection point for a pin is always at its center.</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">selectionPoint_l_2d_m</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
       
      <span class="k">this</span><span class="p">.</span><span class="nx">velocity_2d_mps</span> <span class="o">=</span>  <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">velocity_2d_mps</span><span class="p">,</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">));</span>
     
      <span class="k">this</span><span class="p">.</span><span class="nx">radius_px</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">radius_px</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
      <span class="c1">// Make the radius in box2d a little larger so can select it easier.</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">radius_m</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">meters_from_px</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">radius_px</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
      
      <span class="c1">// www.iforce2d.net/b2dtut/collision-filtering</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">groupIndex</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">groupIndex</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">categoryBits</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">categoryBits</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">);</span>
      <span class="c1">// Masking parameters for b2d object for the pin:</span>
      <span class="c1">// The default Box2D values are 0xFFFF for maskBits (collide with everything).</span>
      <span class="c1">// Default here, 0x0000, will prevent collisions with the pin (collide with nothing).</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">maskBits</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">maskBits</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">deleted</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      
      <span class="c1">// For creating a circular linked-list of pins to guide the NPC movement.</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">NPC</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">NPC</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">nextPinName</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">nextPinName</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">previousPinName</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">previousPinName</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">visible</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">visible</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">color</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">color</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">borderColor</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">borderColor</span><span class="p">,</span> <span class="s1">&#39;gray&#39;</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">navLineColor</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">navLineColor</span><span class="p">,</span> <span class="s1">&#39;white&#39;</span><span class="p">);</span>
      
      <span class="c1">// All parameters should be set above this point.</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">create_b2d_pin</span><span class="p">();</span>
      <span class="c1">// Create a reference back to this pin from the b2d pin.</span>
      <span class="nx">gW</span><span class="p">.</span><span class="nx">tableMap</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="nx">Pin</span><span class="p">.</span><span class="nx">nameIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="nx">Pin</span><span class="p">.</span><span class="nx">applyToAll</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">doThis</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">pinName</span> <span class="k">in</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">pinMap</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">var</span> <span class="nx">pin</span> <span class="o">=</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">pinMap</span><span class="p">[</span> <span class="nx">pinName</span><span class="p">];</span>
         <span class="nx">doThis</span><span class="p">(</span> <span class="nx">pin</span><span class="p">);</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="nx">Pin</span><span class="p">.</span><span class="nx">deleteAll</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">m_EpL</span><span class="p">.</span><span class="nx">displayReport</span><span class="p">)</span> <span class="nx">m_EpL</span><span class="p">.</span><span class="nx">turnDisplayOff</span><span class="p">({});</span>
      
      <span class="nx">Pin</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span> <span class="nx">pin</span> <span class="p">=&gt;</span> <span class="p">{</span>
         <span class="nx">gW</span><span class="p">.</span><span class="nx">tableMap</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span> <span class="nx">pin</span><span class="p">.</span><span class="nx">b2d</span><span class="p">);</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">pin</span><span class="p">.</span><span class="nx">b2d</span><span class="p">)</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">world</span><span class="p">.</span><span class="nx">DestroyBody</span><span class="p">(</span> <span class="nx">pin</span><span class="p">.</span><span class="nx">b2d</span><span class="p">);</span>
      <span class="p">});</span>
      <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">pinMap</span> <span class="o">=</span> <span class="p">{};</span>
      <span class="nx">Pin</span><span class="p">.</span><span class="nx">nameIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>      
   <span class="p">}</span>
   <span class="nx">Pin</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span> <span class="nx">dFM</span><span class="p">.</span><span class="nx">DrawingFunctions</span><span class="p">.</span><span class="nx">prototype</span><span class="p">);</span> <span class="c1">// Inherit methods</span>
   <span class="nx">Pin</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">=</span> <span class="nx">Pin</span><span class="p">;</span> <span class="c1">// Rename the constructor (after inheriting)</span>
   <span class="nx">Pin</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">deleteThisOne</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">pars</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">deleteMode</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">deleteMode</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
      
      <span class="k">if</span> <span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="nx">m_EpL</span><span class="p">.</span><span class="nx">pinName</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">deleteMode</span> <span class="o">!=</span> <span class="s2">&quot;fromEpL&quot;</span><span class="p">))</span> <span class="p">{</span>
         <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s2">&quot;Can&#39;t let you delete the EpL pin. Try [base,yellow]ctrl-L[base].&quot;</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">);</span>  
         <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">removeOne</span><span class="p">(</span> <span class="k">this</span><span class="p">);</span>
         <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>
      
      <span class="c1">// Note that springs are checked, in the updateAirTable function, to</span>
      <span class="c1">// see if either of the two objects it is attached to has been deleted.</span>
      <span class="c1">// If so, the spring is deleted. So that&#39;s not needed here.</span>
      
      <span class="c1">// Reassign the surrounding pins (if they are part of an NPC path)</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">NPC</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">// Point the next pin back at the previous pin.</span>
         <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">pinMap</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">nextPinName</span><span class="p">].</span><span class="nx">previousPinName</span> <span class="o">=</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">pinMap</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">previousPinName</span><span class="p">].</span><span class="nx">name</span><span class="p">;</span>
         <span class="c1">// Point the previous pin forward to the next pin.</span>
         <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">pinMap</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">previousPinName</span><span class="p">].</span><span class="nx">nextPinName</span> <span class="o">=</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">pinMap</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">nextPinName</span><span class="p">].</span><span class="nx">name</span><span class="p">;</span>
      <span class="p">}</span>
      
      <span class="c1">// Delete reference in the tableMap.</span>
      <span class="nx">gW</span><span class="p">.</span><span class="nx">tableMap</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">);</span>
      
      <span class="c1">// Delete the corresponding Box2d object.</span>
      <span class="nx">gW</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">world</span><span class="p">.</span><span class="nx">DestroyBody</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">);</span>
      
      <span class="c1">// Mark this pin as deleted.</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">deleted</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      
      <span class="c1">// Remove this pin from the pin map.</span>
      <span class="k">delete</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">pinMap</span><span class="p">[</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">];</span>
      <span class="c1">// ...and from the multi-select map.</span>
      <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">removeOne</span><span class="p">(</span> <span class="k">this</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="nx">Pin</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">copyThisOne</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">pars</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">position_2d_m</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">);</span>
      
      <span class="kd">var</span> <span class="nx">p_2d_m</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">({},</span> <span class="nx">position_2d_m</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">parsForNewBirth</span> <span class="o">=</span>   <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">({},</span> <span class="k">this</span><span class="p">.</span><span class="nx">parsAtBirth</span><span class="p">);</span>
      <span class="c1">// Make sure the name is nulled so the auto-naming feature is used in the constructor.</span>
      <span class="nx">parsForNewBirth</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      
      <span class="kd">var</span> <span class="nx">newPin</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Pin</span><span class="p">(</span> <span class="nx">p_2d_m</span><span class="p">,</span> <span class="nx">parsForNewBirth</span><span class="p">);</span>
      
      <span class="c1">// Slide the new pin in front of the old one if it&#39;s in a NPC.</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">NPC</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">// Set the two links for the new pin.</span>
         <span class="nx">newPin</span><span class="p">.</span><span class="nx">nextPinName</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">nextPinName</span><span class="p">;</span>
         <span class="nx">newPin</span><span class="p">.</span><span class="nx">previousPinName</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
         
         <span class="c1">// Update the backward link of the original next pin.</span>
         <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">pinMap</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">nextPinName</span><span class="p">].</span><span class="nx">previousPinName</span> <span class="o">=</span> <span class="nx">newPin</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
         
         <span class="c1">// Update the forward link of the original pin.</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">nextPinName</span> <span class="o">=</span> <span class="nx">newPin</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">newPin</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="nx">Pin</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">define_fixture</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">fixDef</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">b2DW</span><span class="p">.</span><span class="nx">FixtureDef</span><span class="p">;</span>   
      
      <span class="nx">fixDef</span><span class="p">.</span><span class="nx">filter</span><span class="p">.</span><span class="nx">groupIndex</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">groupIndex</span><span class="p">;</span>
      <span class="nx">fixDef</span><span class="p">.</span><span class="nx">filter</span><span class="p">.</span><span class="nx">categoryBits</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">categoryBits</span><span class="p">;</span>
      <span class="nx">fixDef</span><span class="p">.</span><span class="nx">filter</span><span class="p">.</span><span class="nx">maskBits</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">maskBits</span><span class="p">;</span>
      
      <span class="nx">fixDef</span><span class="p">.</span><span class="nx">shape</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">b2DW</span><span class="p">.</span><span class="nx">CircleShape</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">radius_m</span><span class="p">);</span>
      
      <span class="k">return</span> <span class="nx">fixDef</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="nx">Pin</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">create_b2d_pin</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="c1">// Create a rectangular and static box2d object.</span>
      
      <span class="kd">var</span> <span class="nx">bodyDef</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">b2DW</span><span class="p">.</span><span class="nx">BodyDef</span><span class="p">;</span>
      <span class="nx">bodyDef</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="nx">b2DW</span><span class="p">.</span><span class="nx">Body</span><span class="p">.</span><span class="nx">b2_kinematicBody</span><span class="p">;</span> <span class="c1">// b2_kinematicBody b2_staticBody</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span> <span class="o">=</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">world</span><span class="p">.</span><span class="nx">CreateBody</span><span class="p">(</span> <span class="nx">bodyDef</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">CreateFixture</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">define_fixture</span><span class="p">());</span>
      
      <span class="c1">// Set the state: position.</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">SetPosition</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">SetLinearVelocity</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">velocity_2d_mps</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="nx">Pin</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getPosition</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_m</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D_from_b2Vec2</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">GetPosition</span><span class="p">());</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_px</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">screenFromWorld</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="nx">Pin</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setPosition</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">newPosition_2d_m</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">SetPosition</span><span class="p">(</span> <span class="nx">newPosition_2d_m</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_m</span> <span class="o">=</span> <span class="nx">newPosition_2d_m</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_px</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">screenFromWorld</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="nx">Pin</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">worldPoint</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">localPoint_2d</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// This is here for compatibility with the corresponding puck method. Note multi-select and attachment points </span>
      <span class="c1">// are always at the center of the pin.</span>
      <span class="k">return</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D_from_b2Vec2</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">GetWorldPoint</span><span class="p">(</span> <span class="nx">localPoint_2d</span><span class="p">));</span>
   <span class="p">}</span>
   <span class="nx">Pin</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">draw_MultiSelectPoint</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">drawingContext</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">getPosition</span><span class="p">();</span> <span class="c1">// the center</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">drawCircle</span><span class="p">(</span> <span class="nx">drawingContext</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_px</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;borderColor&#39;</span><span class="o">:</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="s1">&#39;borderWidth_px&#39;</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;fillColor&#39;</span><span class="o">:</span><span class="s1">&#39;yellow&#39;</span><span class="p">,</span> <span class="s1">&#39;radius_px&#39;</span><span class="o">:</span><span class="mi">5</span><span class="p">});</span>
   <span class="p">}</span>
   <span class="nx">Pin</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">draw</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">drawingContext</span><span class="p">,</span> <span class="nx">radius_px</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">radius_px</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">radius_px</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">radius_px</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">editor</span><span class="p">.</span><span class="nx">checked</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">visible</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">getPosition</span><span class="p">();</span>
         <span class="c1">// use white for the color-mixing demo (#9).</span>
         <span class="kd">var</span> <span class="nx">fillColor</span> <span class="o">=</span> <span class="p">(</span><span class="nx">drawingContext</span><span class="p">.</span><span class="nx">globalCompositeOperation</span> <span class="o">==</span> <span class="s1">&#39;screen&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;white&#39;</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">color</span><span class="p">;</span>
         <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">getPauseErase</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">drawCircle</span><span class="p">(</span> <span class="nx">drawingContext</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_px</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;borderColor&#39;</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">borderColor</span><span class="p">,</span> <span class="s1">&#39;borderWidth_px&#39;</span><span class="o">:</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;fillColor&#39;</span><span class="o">:</span><span class="nx">fillColor</span><span class="p">,</span> <span class="s1">&#39;radius_px&#39;</span><span class="o">:</span><span class="nx">radius_px</span><span class="p">});</span>
         <span class="p">}</span>
      <span class="p">}</span>
      
      <span class="c1">// Draw lines to indicate the relationships in the NPC navigation map.</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">NPC</span> <span class="o">&amp;&amp;</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">editor</span><span class="p">.</span><span class="nx">checked</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">pinMap</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">nextPinName</span><span class="p">])</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">drawLine</span><span class="p">(</span> <span class="nx">drawingContext</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_px</span><span class="p">,</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">pinMap</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">nextPinName</span><span class="p">].</span><span class="nx">position_2d_px</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;width_px&#39;</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">navLineColor</span><span class="p">,</span> <span class="s1">&#39;dashArray&#39;</span><span class="o">:</span><span class="p">[</span><span class="mi">3</span><span class="p">]});</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>
   
   
   
   <span class="kd">function</span> <span class="nx">Joint</span><span class="p">(</span> <span class="nx">tableObject1</span><span class="p">,</span> <span class="nx">tableObject2</span><span class="p">,</span> <span class="nx">pars</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">dFM</span><span class="p">.</span><span class="nx">DrawingFunctions</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span> <span class="c1">// inherit</span>
      
      <span class="c1">// Must have both objects to attach the Joint.</span>
      <span class="c1">// Throwing an error forces an exit from this constructor.</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">((</span><span class="nx">tableObject1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">tableObject2</span><span class="p">))</span> <span class="p">)</span> <span class="p">{</span>
         <span class="kd">var</span> <span class="nx">errorObj</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Attempting to construct a joint with one or both connected objects missing.&#39;</span><span class="p">);</span>
         <span class="nx">errorObj</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s1">&#39;from Joint constructor&#39;</span><span class="p">;</span>
         <span class="k">throw</span> <span class="nx">errorObj</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">parsAtBirth</span> <span class="o">=</span> <span class="nx">pars</span><span class="p">;</span>

      <span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">assignName</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">Joint</span><span class="p">.</span><span class="nx">nameIndex</span><span class="p">,</span> <span class="s2">&quot;j&quot;</span><span class="p">,</span> <span class="s2">&quot;jointMap&quot;</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
      <span class="nx">Joint</span><span class="p">.</span><span class="nx">nameIndex</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">index</span><span class="p">;</span>
      
      <span class="c1">// Add this joint to the joint map.</span>
      <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">jointMap</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">color</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">color</span><span class="p">,</span> <span class="s2">&quot;black&quot;</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">visible</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">visible</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">enableLimit</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">enableLimit</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">lowerLimit_deg</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">lowerLimit_deg</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">upperLimit_deg</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">upperLimit_deg</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">colorInTransition</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">selected</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">selected</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
      
      <span class="c1">// Joint Table Object (jto1). Giving this a distinctive name so that it can be (if needed) filtered</span>
      <span class="c1">// out in the JSON capture. This filtering avoids some wordiness in the capture.</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">jto1</span> <span class="o">=</span> <span class="nx">tableObject1</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">jto1_name</span> <span class="o">=</span> <span class="nx">tableObject1</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
      <span class="c1">// local point where joint is attached on jto1</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">jto1_ap_l_2d_m</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">jto1_ap_l_2d_m</span><span class="p">.</span><span class="nx">copy</span><span class="p">(),</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">));</span>
      
      <span class="c1">// Same reasoning here for the distinctive name (jto2, not p2).</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">jto2</span> <span class="o">=</span> <span class="nx">tableObject2</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">jto2_name</span> <span class="o">=</span> <span class="nx">tableObject2</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
      <span class="c1">// local point where joint is attached on jto2</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">jto2_ap_l_2d_m</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">jto2_ap_l_2d_m</span><span class="p">.</span><span class="nx">copy</span><span class="p">(),</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">));</span>
      
      <span class="c1">// All parameters should be set above this point.</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">createJoint</span><span class="p">();</span>
   <span class="p">}</span>
   <span class="nx">Joint</span><span class="p">.</span><span class="nx">nameIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="nx">Joint</span><span class="p">.</span><span class="nx">countInMultiSelect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="nx">Joint</span><span class="p">.</span><span class="nx">applyToAll</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">doThis</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Run the doThis code on each joint.</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">jointName</span> <span class="k">in</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">jointMap</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">var</span> <span class="nx">joint</span> <span class="o">=</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">jointMap</span><span class="p">[</span> <span class="nx">jointName</span><span class="p">];</span>
         <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">doThis</span><span class="p">(</span> <span class="nx">joint</span><span class="p">);</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">result</span> <span class="o">&amp;&amp;</span> <span class="nx">result</span><span class="p">[</span><span class="s1">&#39;breakRequest&#39;</span><span class="p">])</span> <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="nx">Joint</span><span class="p">.</span><span class="nx">checkIfAttached</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">objName</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">yesFoundIt</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="nx">Joint</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span> <span class="nx">joint</span> <span class="p">=&gt;</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="nx">joint</span><span class="p">.</span><span class="nx">jto1</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="nx">objName</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">joint</span><span class="p">.</span><span class="nx">jto2</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="nx">objName</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">yesFoundIt</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;breakRequest&#39;</span><span class="o">:</span><span class="kc">true</span><span class="p">};</span>
         <span class="p">}</span>
      <span class="p">});</span>
      <span class="k">return</span> <span class="nx">yesFoundIt</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="nx">Joint</span><span class="p">.</span><span class="nx">deleteAll</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="c1">// Remove these joints from the b2d world.</span>
      <span class="nx">Joint</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span> <span class="nx">joint</span> <span class="p">=&gt;</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">joint</span><span class="p">.</span><span class="nx">softConstraints</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">gW</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">world</span><span class="p">.</span><span class="nx">DestroyJoint</span><span class="p">(</span> <span class="nx">joint</span><span class="p">.</span><span class="nx">b2d</span><span class="p">);</span>
            <span class="nx">joint</span><span class="p">.</span><span class="nx">b2d</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
         <span class="p">}</span>
      <span class="p">});</span>
      <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">jointMap</span> <span class="o">=</span> <span class="p">{};</span>
      <span class="nx">Joint</span><span class="p">.</span><span class="nx">nameIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="nx">Joint</span><span class="p">.</span><span class="nx">findAll_InMultiSelect</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">doThis</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Find all the joints that have both ends in the multi-select map.</span>
      <span class="nx">Joint</span><span class="p">.</span><span class="nx">countInMultiSelect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="nx">Joint</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span> <span class="nx">joint</span> <span class="p">=&gt;</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">joint</span><span class="p">.</span><span class="nx">inMultiSelect</span><span class="p">())</span> <span class="p">{</span>
            <span class="nx">Joint</span><span class="p">.</span><span class="nx">countInMultiSelect</span><span class="o">++</span><span class="p">;</span>
            <span class="c1">// For each joint you find.</span>
            <span class="nx">doThis</span><span class="p">(</span> <span class="nx">joint</span><span class="p">);</span>
         <span class="p">}</span>
      <span class="p">});</span>
   <span class="p">}</span>
   <span class="nx">Joint</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span> <span class="nx">dFM</span><span class="p">.</span><span class="nx">DrawingFunctions</span><span class="p">.</span><span class="nx">prototype</span><span class="p">);</span> <span class="c1">// Inherit methods</span>
   <span class="nx">Joint</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">=</span> <span class="nx">Spring</span><span class="p">;</span> <span class="c1">// Rename the constructor (after inheriting)</span>
   <span class="nx">Joint</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setEnableLimit</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">trueFalse</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">enableLimit</span> <span class="o">=</span> <span class="nx">trueFalse</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">EnableLimit</span><span class="p">(</span> <span class="nx">trueFalse</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="nx">Joint</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setLimits</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">lowerLimit_deg</span><span class="p">,</span> <span class="nx">upperLimit_deg</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">lowerLimit_deg</span> <span class="o">=</span> <span class="nx">lowerLimit_deg</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">upperLimit_deg</span> <span class="o">=</span> <span class="nx">upperLimit_deg</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">SetLimits</span><span class="p">(</span> <span class="nx">lowerLimit_deg</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="o">/</span><span class="mi">180</span><span class="p">,</span> <span class="nx">upperLimit_deg</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="o">/</span><span class="mi">180</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="nx">Joint</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">createJoint</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">joint</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">b2DW</span><span class="p">.</span><span class="nx">RevoluteJointDef</span><span class="p">;</span>
      
      <span class="c1">// Identify the connected bodies.</span>
      <span class="nx">joint</span><span class="p">.</span><span class="nx">bodyA</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">jto1</span><span class="p">.</span><span class="nx">b2d</span><span class="p">;</span>
      <span class="nx">joint</span><span class="p">.</span><span class="nx">bodyB</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">jto2</span><span class="p">.</span><span class="nx">b2d</span><span class="p">;</span>
      
      <span class="c1">// Connect to the attachment point on each body.</span>
      <span class="nx">joint</span><span class="p">.</span><span class="nx">localAnchorA</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">b2Vec2_from_Vec2D</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">jto1_ap_l_2d_m</span><span class="p">);</span>
      <span class="nx">joint</span><span class="p">.</span><span class="nx">localAnchorB</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">b2Vec2_from_Vec2D</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">jto2_ap_l_2d_m</span><span class="p">);</span>
            
      <span class="c1">// Will the connected bodies collide?</span>
      <span class="nx">joint</span><span class="p">.</span><span class="nx">collideConnected</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

      <span class="c1">// Add the joint to the world. And keep a reference to it here (this joint) as b2d.</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span> <span class="o">=</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">world</span><span class="p">.</span><span class="nx">CreateJoint</span><span class="p">(</span> <span class="nx">joint</span><span class="p">);</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">EnableLimit</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">enableLimit</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">SetLimits</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">lowerLimit_deg</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="o">/</span><span class="mi">180</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">upperLimit_deg</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="o">/</span><span class="mi">180</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="nx">Joint</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">deleteThisOne</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">pars</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">deleteMode</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">deleteMode</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
      <span class="nx">gW</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">world</span><span class="p">.</span><span class="nx">DestroyJoint</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="k">delete</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">jointMap</span><span class="p">[</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">];</span>
   <span class="p">}</span>
   <span class="nx">Joint</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">copyThisOne</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">to1</span><span class="p">,</span> <span class="nx">to2</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Make a copy of the mutable objects that are passed into the Joint constructor.</span>
      <span class="kd">var</span> <span class="nx">pars</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">({},</span> <span class="k">this</span><span class="p">.</span><span class="nx">parsAtBirth</span><span class="p">);</span>
      <span class="c1">// Null the name so the auto-naming feature is used in the constructor.</span>
      <span class="nx">pars</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      
      <span class="nx">pars</span><span class="p">.</span><span class="nx">jto1_ap_l_2d_m</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">jto1_ap_l_2d_m</span><span class="p">.</span><span class="nx">copy</span><span class="p">();</span>
      <span class="nx">pars</span><span class="p">.</span><span class="nx">jto2_ap_l_2d_m</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">jto2_ap_l_2d_m</span><span class="p">.</span><span class="nx">copy</span><span class="p">();</span>
      
      <span class="c1">// Note that this instantiation adds this new joint to the joint map. </span>
      <span class="kd">var</span> <span class="nx">tempJoint</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Joint</span><span class="p">(</span> <span class="nx">to1</span><span class="p">,</span> <span class="nx">to2</span><span class="p">,</span> <span class="nx">pars</span><span class="p">);</span>
      
      <span class="k">return</span> <span class="nx">tempJoint</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="nx">Joint</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">updateWorldPositions</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="c1">// Find the world position of the attachment points.</span>
      <span class="c1">// if not attached to the center</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">jto1_ap_l_2d_m</span><span class="p">.</span><span class="nx">zeroLength</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">jto1_ap_w_2d_m</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D_from_b2Vec2</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">jto1</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">GetWorldPoint</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">jto1_ap_l_2d_m</span><span class="p">));</span>
      <span class="c1">// if attached to the center</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">jto1_ap_w_2d_m</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">jto1</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">jto1_ap_w_2d_px</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">screenFromWorld</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">jto1_ap_w_2d_m</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="nx">Joint</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">inMultiSelect</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">jto1</span><span class="p">.</span><span class="nx">name</span> <span class="k">in</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">map</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">jto2</span><span class="p">.</span><span class="nx">name</span> <span class="k">in</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">map</span><span class="p">))</span> <span class="p">{</span>
         <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="nx">Joint</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">report</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="p">)</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">enableLimitString</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">enableLimit</span><span class="p">)</span> <span class="o">?</span> <span class="s2">&quot;on&quot;</span><span class="o">:</span><span class="s2">&quot;off&quot;</span><span class="p">;</span>
      <span class="kd">let</span> <span class="nx">lowerLimitString</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">lowerLimit_deg</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">lowerLimit_deg</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">:</span> <span class="s2">&quot;n/a&quot;</span><span class="p">;</span>
      <span class="kd">let</span> <span class="nx">upperLimitString</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">upperLimit_deg</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">upperLimit_deg</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">:</span> <span class="s2">&quot;n/a&quot;</span><span class="p">;</span>
      
      <span class="kd">let</span> <span class="nx">messageString</span> <span class="o">=</span> <span class="s2">&quot;revolute joint: [base,yellow]&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot;[base]&quot;</span> <span class="o">+</span>
                          <span class="s2">&quot;\\   angle limits (&quot;</span> <span class="o">+</span> <span class="nx">enableLimitString</span> <span class="o">+</span> <span class="s2">&quot;): &quot;</span> <span class="o">+</span> <span class="nx">lowerLimitString</span> <span class="o">+</span> <span class="s2">&quot; to &quot;</span> <span class="o">+</span> <span class="nx">upperLimitString</span> <span class="o">+</span>
                          <span class="s2">&quot;\\   angle = &quot;</span> <span class="o">+</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">GetJointAngle</span><span class="p">()</span> <span class="o">*</span> <span class="mf">180.0</span><span class="o">/</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="p">).</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
      <span class="c1">// For the case where there is a single spring and a single revolute joint, add the revolute report to the end of the spring report.</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help2&#39;</span><span class="p">].</span><span class="nx">message</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;spring&#39;</span><span class="p">))</span> <span class="p">{</span>
         <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help2&#39;</span><span class="p">].</span><span class="nx">addToIt</span><span class="p">(</span> <span class="s2">&quot;\\ \\&quot;</span> <span class="o">+</span> <span class="nx">messageString</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;additionalTime_s&#39;</span><span class="o">:</span><span class="mf">0.0</span><span class="p">});</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help2&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span> <span class="nx">messageString</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">);</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="nx">Joint</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">draw</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">drawingContext</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">updateWorldPositions</span><span class="p">();</span>
      
      <span class="c1">// If this.color is not black, it will be used as the fill color (to get your attention) until the 3 second timer ends.</span>
      <span class="kd">var</span> <span class="nx">transitionColor</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">colorInTransition</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">transitionColor</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">color</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="nx">transitionColor</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> 
         <span class="k">this</span><span class="p">.</span><span class="nx">colorInTransition</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="mi">3000</span><span class="p">);</span>
      
      <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">visible</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">getPauseErase</span><span class="p">())</span> <span class="p">)</span> <span class="p">{</span>
         <span class="kd">let</span> <span class="nx">fillColor</span><span class="p">,</span> <span class="nx">borderColor</span><span class="p">;</span>
         <span class="kd">let</span> <span class="nx">outerRadius_px</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
         
         <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">selected</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">fillColor</span> <span class="o">=</span> <span class="s1">&#39;yellow&#39;</span><span class="p">;</span>
            <span class="nx">borderColor</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span><span class="p">;</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">candidateReportPasteDelete</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">fillColor</span> <span class="o">=</span> <span class="s1">&#39;white&#39;</span><span class="p">;</span>
               <span class="nx">borderColor</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span>
               <span class="nx">outerRadius_px</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
               <span class="nx">fillColor</span> <span class="o">=</span> <span class="nx">transitionColor</span><span class="p">;</span>
               <span class="nx">borderColor</span> <span class="o">=</span> <span class="s1">&#39;white&#39;</span>
            <span class="p">}</span>
         <span class="p">}</span>
         <span class="c1">// larger circle on the bottom</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">drawCircle</span><span class="p">(</span> <span class="nx">drawingContext</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">jto1_ap_w_2d_px</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;borderColor&#39;</span><span class="o">:</span><span class="nx">borderColor</span><span class="p">,</span> <span class="s1">&#39;borderWidth_px&#39;</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;fillColor&#39;</span><span class="o">:</span><span class="nx">fillColor</span><span class="p">,</span> <span class="s1">&#39;radius_px&#39;</span><span class="o">:</span><span class="nx">outerRadius_px</span><span class="p">});</span>
         <span class="c1">// smaller circle on top</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">drawCircle</span><span class="p">(</span> <span class="nx">drawingContext</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">jto1_ap_w_2d_px</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;borderColor&#39;</span><span class="o">:</span><span class="nx">borderColor</span><span class="p">,</span> <span class="s1">&#39;borderWidth_px&#39;</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;fillColor&#39;</span><span class="o">:</span><span class="nx">fillColor</span><span class="p">,</span> <span class="s1">&#39;radius_px&#39;</span><span class="o">:</span><span class="mi">3</span><span class="p">});</span>
      <span class="p">}</span>
   <span class="p">}</span>



   <span class="kd">function</span> <span class="nx">Spring</span><span class="p">(</span> <span class="nx">puckOrPin1</span><span class="p">,</span> <span class="nx">puckOrPin2</span><span class="p">,</span> <span class="nx">pars</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">dFM</span><span class="p">.</span><span class="nx">DrawingFunctions</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span> <span class="c1">// inherit</span>
      
      <span class="c1">// Must have both objects to attach the spring.</span>
      <span class="c1">// Throwing an error forces an exit from this constructor.</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">((</span><span class="nx">puckOrPin1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">puckOrPin2</span><span class="p">))</span> <span class="p">)</span> <span class="p">{</span>
         <span class="kd">var</span> <span class="nx">errorObj</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Attempting to construct a spring with one or both connected objects missing.&#39;</span><span class="p">);</span>
         <span class="nx">errorObj</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s1">&#39;from Spring constructor&#39;</span><span class="p">;</span>
         <span class="k">throw</span> <span class="nx">errorObj</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">parsAtBirth</span> <span class="o">=</span> <span class="nx">pars</span><span class="p">;</span>
      
      <span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">assignName</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">Spring</span><span class="p">.</span><span class="nx">nameIndex</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="s2">&quot;springMap&quot;</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
      <span class="nx">Spring</span><span class="p">.</span><span class="nx">nameIndex</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">index</span><span class="p">;</span>
      
      <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">springMap</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">color</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">color</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">visible</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">visible</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">length_m</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">length_m</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">stretch_m</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">stretch_m</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">strength_Npm</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">strength_Npm</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">);</span>  <span class="c1">// 60.0</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">unstretched_width_m</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">unstretched_width_m</span><span class="p">,</span> <span class="mf">0.025</span><span class="p">);</span>
      
      <span class="c1">// Note that pucks have an attribute linDamp, with an effect similar to drag_c. Both can be</span>
      <span class="c1">// used to model a drag force on the pucks at the end of the spring.</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">drag_c</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">drag_c</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">damper_Ns2pm2</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">damper_Ns2pm2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">);</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">selected</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">selected</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">navigationForNPC</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">navigationForNPC</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">forCursor</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">forCursor</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
      
      <span class="c1">// Spring-puck/pin Object (spo1, not p1). Giving this a distinctive name so that it can be filtered</span>
      <span class="c1">// out in the JSON capture. This filtering avoids some wordiness in the capture.</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">spo1</span> <span class="o">=</span> <span class="nx">puckOrPin1</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">p1_name</span> <span class="o">=</span> <span class="nx">puckOrPin1</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
      <span class="c1">// Pin one end of the spring to a fixed location.</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">spo1</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;Pin&quot;</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">pinned</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">pinned</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="c1">// local point where spring is attached on spo1</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">spo1_ap_l_2d_m</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefaultVector</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">spo1_ap_l_2d_m</span><span class="p">,</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;copy&quot;</span><span class="p">);</span>
      
      <span class="c1">// Same reasoning here for the distinctive name (spo2, not p2).</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">spo2</span> <span class="o">=</span> <span class="nx">puckOrPin2</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">p2_name</span> <span class="o">=</span> <span class="nx">puckOrPin2</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
      <span class="c1">// Pin one end of the spring to a fixed location.</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">spo2</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;Pin&quot;</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">pinned</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">pinned</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="c1">// local point where spring is attached on spo2</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">spo2_ap_l_2d_m</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefaultVector</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">spo2_ap_l_2d_m</span><span class="p">,</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;copy&quot;</span><span class="p">);</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">p1p2_separation_2d_m</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">p1p2_separation_m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">p1p2_normalized_2d</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">fixedLength</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">fixedLength</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">collideConnected</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">collideConnected</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
      
      <span class="c1">// All parameters should be set above this point.</span>
      
      <span class="c1">// To model the spring as a distance joint in b2d. </span>
      <span class="c1">// Don&#39;t allow this for the navigation springs. </span>
      <span class="c1">// If fixedLength is specified, make sure</span>
      <span class="c1">// that softConstraints (i.e. the distance joint) is also specified because it is</span>
      <span class="c1">// needed for modeling the fixed-length join.</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">fixedLength</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">softConstraints_setInPars</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">softConstraints</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">softConstraints_setInPars</span> <span class="o">=</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">softConstraints</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span> <span class="o">?</span> <span class="kc">true</span> <span class="o">:</span> <span class="kc">false</span><span class="p">;</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">softConstraints</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">softConstraints</span><span class="p">,</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">getSoftConstraints_default</span><span class="p">());</span>
      <span class="p">}</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">softConstraints</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">navigationForNPC</span><span class="p">))</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">createDistanceJoint</span><span class="p">();</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">navigationForNPC</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">softConstraints</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="nx">Spring</span><span class="p">.</span><span class="nx">nameIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="nx">Spring</span><span class="p">.</span><span class="nx">nameForPasting</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
   <span class="nx">Spring</span><span class="p">.</span><span class="nx">countInMultiSelect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="nx">Spring</span><span class="p">.</span><span class="nx">applyToAll</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">doThis</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Run the doThis code on each spring.</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">springName</span> <span class="k">in</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">springMap</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">var</span> <span class="nx">spring</span> <span class="o">=</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">springMap</span><span class="p">[</span> <span class="nx">springName</span><span class="p">];</span>
         <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">doThis</span><span class="p">(</span> <span class="nx">spring</span><span class="p">);</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">result</span> <span class="o">&amp;&amp;</span> <span class="nx">result</span><span class="p">[</span><span class="s1">&#39;breakRequest&#39;</span><span class="p">])</span> <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="nx">Spring</span><span class="p">.</span><span class="nx">checkIfAttached</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">objName</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">yesFoundIt</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="nx">Spring</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span> <span class="nx">spring</span> <span class="p">=&gt;</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="o">!</span><span class="nx">spring</span><span class="p">.</span><span class="nx">forCursor</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="nx">spring</span><span class="p">.</span><span class="nx">spo1</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="nx">objName</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">spring</span><span class="p">.</span><span class="nx">spo2</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="nx">objName</span><span class="p">))</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">yesFoundIt</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;breakRequest&#39;</span><span class="o">:</span><span class="kc">true</span><span class="p">};</span>
         <span class="p">}</span>
      <span class="p">});</span>
      <span class="k">return</span> <span class="nx">yesFoundIt</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="nx">Spring</span><span class="p">.</span><span class="nx">deleteAll</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="c1">// If any of these springs are b2d distance joints, remove these from the b2d world.</span>
      <span class="nx">Spring</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span> <span class="nx">spring</span> <span class="p">=&gt;</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">spring</span><span class="p">.</span><span class="nx">softConstraints</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">gW</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">world</span><span class="p">.</span><span class="nx">DestroyJoint</span><span class="p">(</span> <span class="nx">spring</span><span class="p">.</span><span class="nx">b2d</span><span class="p">);</span>
            <span class="nx">spring</span><span class="p">.</span><span class="nx">b2d</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
         <span class="p">}</span>
      <span class="p">});</span>
      <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">springMap</span> <span class="o">=</span> <span class="p">{};</span>
      <span class="nx">Spring</span><span class="p">.</span><span class="nx">nameIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="nx">Spring</span><span class="p">.</span><span class="nx">nameForPasting</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="nx">Spring</span><span class="p">.</span><span class="nx">findAll_InMultiSelect</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">doThis</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Find all the springs that have both ends (puck or pin) in the multi-select map.</span>
      <span class="c1">// Then run the doThis function that has been passed in here.</span>
      <span class="nx">Spring</span><span class="p">.</span><span class="nx">countInMultiSelect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="nx">Spring</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span> <span class="nx">spring</span> <span class="p">=&gt;</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">spring</span><span class="p">.</span><span class="nx">inMultiSelect</span><span class="p">())</span> <span class="p">{</span>
            <span class="nx">Spring</span><span class="p">.</span><span class="nx">countInMultiSelect</span><span class="o">++</span><span class="p">;</span>
            <span class="c1">// For each spring you find there.</span>
            <span class="nx">doThis</span><span class="p">(</span> <span class="nx">spring</span><span class="p">);</span>
         <span class="p">}</span>
      <span class="p">});</span>
   <span class="p">}</span>
   <span class="nx">Spring</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span> <span class="nx">dFM</span><span class="p">.</span><span class="nx">DrawingFunctions</span><span class="p">.</span><span class="nx">prototype</span><span class="p">);</span> <span class="c1">// Inherit methods</span>
   <span class="nx">Spring</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">=</span> <span class="nx">Spring</span><span class="p">;</span> <span class="c1">// Rename the constructor (after inheriting)</span>
   <span class="nx">Spring</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">createDistanceJoint</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">distance_joint</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">b2DW</span><span class="p">.</span><span class="nx">DistanceJointDef</span><span class="p">;</span>
      
      <span class="c1">// Identify the connected bodies.</span>
      <span class="nx">distance_joint</span><span class="p">.</span><span class="nx">bodyA</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">spo1</span><span class="p">.</span><span class="nx">b2d</span><span class="p">;</span>
      <span class="nx">distance_joint</span><span class="p">.</span><span class="nx">bodyB</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">spo2</span><span class="p">.</span><span class="nx">b2d</span><span class="p">;</span>
      
      <span class="c1">// Connect to the attachment point on each body.</span>
      <span class="nx">distance_joint</span><span class="p">.</span><span class="nx">localAnchorA</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">b2Vec2_from_Vec2D</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">spo1_ap_l_2d_m</span><span class="p">);</span>
      <span class="nx">distance_joint</span><span class="p">.</span><span class="nx">localAnchorB</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">b2Vec2_from_Vec2D</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">spo2_ap_l_2d_m</span><span class="p">);</span>
      
      <span class="c1">// Initialize the soft constraints.</span>
      <span class="nx">distance_joint</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">length_m</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">fixedLength</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">distance_joint</span><span class="p">.</span><span class="nx">frequencyHz</span>  <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>
         <span class="nx">distance_joint</span><span class="p">.</span><span class="nx">dampingRatio</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
      <span class="p">}</span>
      
      <span class="c1">// Will the connected bodies collide?</span>
      <span class="nx">distance_joint</span><span class="p">.</span><span class="nx">collideConnected</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">collideConnected</span><span class="p">;</span>

      <span class="c1">// Add the joint to the world. And keep a reference to it here (this spring) as b2d.</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span> <span class="o">=</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">world</span><span class="p">.</span><span class="nx">CreateJoint</span><span class="p">(</span> <span class="nx">distance_joint</span><span class="p">);</span>
      
      <span class="c1">// Update it to reflect the traditional spring parameters and the effective mass.</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">updateB2D_spring</span><span class="p">();</span>
   <span class="p">}</span>
   <span class="nx">Spring</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">updateB2D_spring</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="c1">// Use the smaller of the two pucks in the frequency calculation.</span>
      <span class="kd">var</span> <span class="nx">smallerMass_kg</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">spo1</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s1">&#39;Puck&#39;</span><span class="p">)</span> <span class="nx">smallerMass_kg</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">spo1</span><span class="p">.</span><span class="nx">mass_kg</span><span class="p">,</span> <span class="nx">smallerMass_kg</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">spo2</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s1">&#39;Puck&#39;</span><span class="p">)</span> <span class="nx">smallerMass_kg</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">spo2</span><span class="p">.</span><span class="nx">mass_kg</span><span class="p">,</span> <span class="nx">smallerMass_kg</span><span class="p">);</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">SetLength</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">length_m</span><span class="p">);</span>
      
      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">fixedLength</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">// The frequency and damping ratio expressions are based on the equations on page 45 of this</span>
         <span class="c1">// presentation by Erin Catto.</span>
         <span class="c1">// https://triquence.org/GDC2011_Catto_Erin_Soft_Constraints.pdf</span>
         
         <span class="c1">// omega = (k/m)^0.5</span>
         <span class="c1">// f = omega / 2Pi = (k/m)^0.5 / 2Pi</span>
         <span class="kd">var</span> <span class="nx">freq_hz</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">strength_Npm</span><span class="o">/</span> <span class="nx">smallerMass_kg</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="p">);</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">SetFrequency</span><span class="p">(</span> <span class="nx">freq_hz</span><span class="p">);</span>
         
         <span class="c1">// dampingRatio = c / (2 * m * omega)</span>
         <span class="kd">var</span> <span class="nx">dampingRatio</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">damper_Ns2pm2</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="nx">smallerMass_kg</span> <span class="o">*</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">GetFrequency</span><span class="p">()));</span>
         <span class="kd">var</span> <span class="nx">dampingRatio_tweaked</span> <span class="o">=</span> <span class="nx">dampingRatio</span> <span class="o">/</span><span class="mf">1.0</span> <span class="p">;</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">SetDampingRatio</span><span class="p">(</span> <span class="nx">dampingRatio_tweaked</span><span class="p">);</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="nx">Spring</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">deleteThisOne</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">pars</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">deleteMode</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">deleteMode</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">softConstraints</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">gW</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">world</span><span class="p">.</span><span class="nx">DestroyJoint</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">);</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="p">}</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">navigationForNPC</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">// Dissociate the NPC puck from the navigation pin. Do this to prevent the </span>
         <span class="c1">// navigation spring from regenerating when the capture is restored.</span>
         <span class="c1">// Also disable the jet, since the NPC puck won&#39;t be motoring until attached to navigation again.</span>
         <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">spo1</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;Puck&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">spo1</span><span class="p">.</span><span class="nx">pinName</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">spo1</span><span class="p">.</span><span class="nx">parsAtBirth</span><span class="p">.</span><span class="nx">pinName</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">spo1</span><span class="p">.</span><span class="nx">disableJet</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
         <span class="p">}</span>
         <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">spo2</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;Puck&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">spo2</span><span class="p">.</span><span class="nx">pinName</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">spo2</span><span class="p">.</span><span class="nx">parsAtBirth</span><span class="p">.</span><span class="nx">pinName</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">spo2</span><span class="p">.</span><span class="nx">disableJet</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
         <span class="p">}</span>
      <span class="p">}</span>
      
      <span class="c1">// Remove this spring from the spring map.</span>
      <span class="k">delete</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">springMap</span><span class="p">[</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">];</span>
   <span class="p">}</span>
   <span class="nx">Spring</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">copyThisOne</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">p1</span><span class="p">,</span> <span class="nx">p2</span><span class="p">,</span> <span class="nx">copyMode</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">copyMode</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">copyMode</span><span class="p">,</span> <span class="s2">&quot;regular&quot;</span><span class="p">);</span>
      
      <span class="c1">// Make a copy of the mutable objects that are passed into the Spring constructor.</span>
      <span class="kd">var</span> <span class="nx">pars</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">({},</span> <span class="k">this</span><span class="p">.</span><span class="nx">parsAtBirth</span><span class="p">);</span>
      <span class="c1">// Null the name so the auto-naming feature is used in the constructor.</span>
      <span class="nx">pars</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="c1">// Update attributes that may have been changed (from birth) with editing.</span>
      <span class="nx">pars</span><span class="p">.</span><span class="nx">length_m</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">length_m</span><span class="p">;</span>
      <span class="nx">pars</span><span class="p">.</span><span class="nx">unstretched_width_m</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">unstretched_width_m</span>
      <span class="nx">pars</span><span class="p">.</span><span class="nx">strength_Npm</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">strength_Npm</span><span class="p">;</span>
      <span class="nx">pars</span><span class="p">.</span><span class="nx">damper_Ns2pm2</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">damper_Ns2pm2</span><span class="p">;</span>
      <span class="c1">// factor for drag force on attached pucks (proportional to velocity)</span>
      <span class="nx">pars</span><span class="p">.</span><span class="nx">drag_c</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">drag_c</span><span class="p">;</span>
      
      <span class="c1">// Set local attachment points when pasting a spring.</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">copyMode</span> <span class="o">==</span> <span class="s2">&quot;pasteSingle&quot;</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">comSelection</span><span class="p">.</span><span class="nx">checked</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">pars</span><span class="p">.</span><span class="nx">spo1_ap_l_2d_m</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
            <span class="nx">pars</span><span class="p">.</span><span class="nx">spo2_ap_l_2d_m</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// Always paste onto the center of a pin.</span>
            <span class="nx">pars</span><span class="p">.</span><span class="nx">spo1_ap_l_2d_m</span> <span class="o">=</span> <span class="p">(</span><span class="nx">p1</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;Pin&quot;</span><span class="p">)</span> <span class="o">?</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">:</span> <span class="nx">p1</span><span class="p">.</span><span class="nx">selectionPoint_l_2d_m</span><span class="p">.</span><span class="nx">copy</span><span class="p">();</span>
            <span class="nx">pars</span><span class="p">.</span><span class="nx">spo2_ap_l_2d_m</span> <span class="o">=</span> <span class="p">(</span><span class="nx">p2</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;Pin&quot;</span><span class="p">)</span> <span class="o">?</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">:</span> <span class="nx">p2</span><span class="p">.</span><span class="nx">selectionPoint_l_2d_m</span><span class="p">.</span><span class="nx">copy</span><span class="p">();</span>
         <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="nx">pars</span><span class="p">.</span><span class="nx">spo1_ap_l_2d_m</span> <span class="o">=</span> <span class="p">(</span><span class="nx">p1</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;Pin&quot;</span><span class="p">)</span> <span class="o">?</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">spo1_ap_l_2d_m</span><span class="p">.</span><span class="nx">copy</span><span class="p">();</span>
         <span class="nx">pars</span><span class="p">.</span><span class="nx">spo2_ap_l_2d_m</span> <span class="o">=</span> <span class="p">(</span><span class="nx">p2</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;Pin&quot;</span><span class="p">)</span> <span class="o">?</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">spo2_ap_l_2d_m</span><span class="p">.</span><span class="nx">copy</span><span class="p">();</span>
      <span class="p">}</span>
      
      <span class="c1">// Note that this instantiation adds this new spring to the spring map. </span>
      <span class="kd">var</span> <span class="nx">tempSpring</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Spring</span><span class="p">(</span> <span class="nx">p1</span><span class="p">,</span> <span class="nx">p2</span><span class="p">,</span> <span class="nx">pars</span><span class="p">);</span>
      
      <span class="c1">// Also enable the jet for NPC pucks, since the NPC puck will be motoring now that it is attached to navigation again.</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">tempSpring</span><span class="p">.</span><span class="nx">navigationForNPC</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">tempSpring</span><span class="p">.</span><span class="nx">spo1</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;Puck&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">tempSpring</span><span class="p">.</span><span class="nx">spo1</span><span class="p">.</span><span class="nx">disableJet</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
         <span class="p">}</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">tempSpring</span><span class="p">.</span><span class="nx">spo2</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;Puck&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">tempSpring</span><span class="p">.</span><span class="nx">spo2</span><span class="p">.</span><span class="nx">disableJet</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
         <span class="p">}</span>
      <span class="p">}</span>
      
      <span class="k">return</span> <span class="nx">tempSpring</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="nx">Spring</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">interpret_editCommand</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">command</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">width_factor</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">length_factor</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">damping_factor</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>
      
      <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">hack</span><span class="p">[</span><span class="s1">&#39;pwsEdits&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      
      <span class="k">if</span> <span class="p">((</span><span class="nx">command</span> <span class="o">==</span> <span class="s1">&#39;wider&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">command</span> <span class="o">==</span> <span class="s1">&#39;widerAppearance&#39;</span><span class="p">))</span> <span class="p">{</span>
         <span class="nx">width_factor</span> <span class="o">=</span> <span class="mf">1.1</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="nx">command</span> <span class="o">==</span> <span class="s1">&#39;thinner&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">command</span> <span class="o">==</span> <span class="s1">&#39;thinnerAppearance&#39;</span><span class="p">))</span> <span class="p">{</span>
         <span class="nx">width_factor</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="mf">1.1</span><span class="p">;</span> 
         
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">command</span> <span class="o">==</span> <span class="s1">&#39;taller&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">length_factor</span> <span class="o">=</span> <span class="mf">1.1</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">command</span> <span class="o">==</span> <span class="s1">&#39;shorter&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">length_factor</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="mf">1.1</span><span class="p">;</span>
         
      <span class="c1">// For springs, interpret drag as damping.</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">command</span> <span class="o">==</span> <span class="s1">&#39;moreDrag&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">damping_factor</span> <span class="o">=</span> <span class="mf">1.1</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">command</span> <span class="o">==</span> <span class="s1">&#39;lessDrag&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">damping_factor</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="mf">1.1</span><span class="p">;</span>
         
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">command</span> <span class="o">==</span> <span class="s1">&#39;noChange&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">// don&#39;t change anything.</span>
      <span class="p">}</span>
      
      <span class="c1">// First, the special case of the pinned puck that is using a zero length spring. Give</span>
      <span class="c1">// it a little length to start with, otherwise the zero will always scale to zero (it will never</span>
      <span class="c1">// get longer). </span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">command</span><span class="o">==</span><span class="s1">&#39;shorter&#39;</span> <span class="o">||</span> <span class="nx">command</span><span class="o">==</span><span class="s1">&#39;taller&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">length_m</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">length_m</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">;</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">length_m</span> <span class="o">*=</span> <span class="nx">length_factor</span><span class="p">;</span>
         <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">length_m</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">length_m</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
         <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s2">&quot;spring: [base,yellow]&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot;[base] length = &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">length_m</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="mf">0.5</span><span class="p">);</span>
         
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">command</span><span class="o">==</span><span class="s1">&#39;thinner&#39;</span> <span class="o">||</span> <span class="nx">command</span><span class="o">==</span><span class="s1">&#39;wider&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">// Use the wider/thinner width_factor to affect both the visual width and strength of the spring.</span>
         <span class="c1">// See below, in the draw method, that width_px, the drawing width, has a minimum of 2px.</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">unstretched_width_m</span> <span class="o">*=</span> <span class="nx">width_factor</span><span class="p">;</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">strength_Npm</span> <span class="o">*=</span> <span class="nx">width_factor</span><span class="p">;</span>
         <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s2">&quot;spring: [base,yellow]&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot;[base] strength (k) = &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">strength_Npm</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="mf">0.5</span><span class="p">);</span>
         
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">command</span><span class="o">==</span><span class="s1">&#39;thinnerAppearance&#39;</span> <span class="o">||</span> <span class="nx">command</span><span class="o">==</span><span class="s1">&#39;widerAppearance&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">// Use the widerAppearance/thinnerAppearance width_factor to affect ONLY the visual width of the spring.</span>
         <span class="c1">// (see comment above on width_px)</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">unstretched_width_m</span> <span class="o">*=</span> <span class="nx">width_factor</span><span class="p">;</span>
         <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s2">&quot;spring: [base,yellow]&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot;[base] unstretched width = &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">unstretched_width_m</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="mf">0.5</span><span class="p">);</span>
         
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">command</span><span class="o">==</span><span class="s1">&#39;lessDrag&#39;</span> <span class="o">||</span> <span class="nx">command</span><span class="o">==</span><span class="s1">&#39;moreDrag&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">// If at zero, give the scaling factor something to work with.</span>
         <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">damper_Ns2pm2</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">damper_Ns2pm2</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">;</span>
         <span class="c1">// Apply the scaling factor.</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">damper_Ns2pm2</span> <span class="o">*=</span> <span class="nx">damping_factor</span><span class="p">;</span>
         <span class="c1">// A lower limit.</span>
         <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">damper_Ns2pm2</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">damper_Ns2pm2</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
         <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s2">&quot;spring: [base,yellow]&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot;[base] damping = &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">damper_Ns2pm2</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="mf">0.5</span><span class="p">);</span>
      <span class="p">}</span>
      
      <span class="c1">// If you&#39;re using a distance joint in Box2D...</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">softConstraints</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">updateB2D_spring</span><span class="p">();</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="nx">Spring</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">updateEndPoints</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="c1">// Find the world position of the attachment points.</span>
      <span class="c1">// if not attached to the center</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">spo1_ap_l_2d_m</span><span class="p">.</span><span class="nx">zeroLength</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">spo1_ap_w_2d_m</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D_from_b2Vec2</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">spo1</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">GetWorldPoint</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">spo1_ap_l_2d_m</span><span class="p">));</span>
      <span class="c1">// if attached to the center</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">spo1_ap_w_2d_m</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">spo1</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">spo1_ap_w_2d_px</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">screenFromWorld</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">spo1_ap_w_2d_m</span><span class="p">);</span>
      
      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">spo2_ap_l_2d_m</span><span class="p">.</span><span class="nx">zeroLength</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">spo2_ap_w_2d_m</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D_from_b2Vec2</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">spo2</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">GetWorldPoint</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">spo2_ap_l_2d_m</span><span class="p">));</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">spo2_ap_w_2d_m</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">spo2</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">spo2_ap_w_2d_px</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">screenFromWorld</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">spo2_ap_w_2d_m</span><span class="p">);</span>
   <span class="p">}</span>   
   <span class="nx">Spring</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">calculateSeparation</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">updateEndPoints</span><span class="p">();</span>
      
      <span class="c1">// Separation vector and its length:</span>
      <span class="c1">// Need these two results for both distance joints and regular springs: </span>
      <span class="k">this</span><span class="p">.</span><span class="nx">p1p2_separation_2d_m</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">spo1_ap_w_2d_m</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">spo2_ap_w_2d_m</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">p1p2_separation_m</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">p1p2_separation_2d_m</span><span class="p">.</span><span class="nx">length</span><span class="p">();</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">p1p2_normalized_2d</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">p1p2_separation_2d_m</span><span class="p">.</span><span class="nx">scaleBy</span><span class="p">(</span> <span class="mi">1</span><span class="o">/</span><span class="k">this</span><span class="p">.</span><span class="nx">p1p2_separation_m</span><span class="p">);</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">stretch_m</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">p1p2_separation_m</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">length_m</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="nx">Spring</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">potentialEnergy</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">pE</span><span class="p">;</span> <span class="c1">// PE = (1/2) * k * x^2</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">forCursor</span> <span class="o">&amp;&amp;</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">].</span><span class="nx">poolShotLocked</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">pE</span> <span class="o">=</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">].</span><span class="nx">poolShotLockedEnergy_J</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="nx">pE</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">strength_Npm</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">stretch_m</span><span class="o">**</span><span class="mi">2</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">pE</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="nx">Spring</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">cursorOnWallorPin</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">([</span><span class="s1">&#39;Wall&#39;</span><span class="p">,</span><span class="s1">&#39;Pin&#39;</span><span class="p">].</span><span class="nx">includes</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">spo2</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">forCursor</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="nx">Spring</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">force_on_pucks</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="cm">/*</span>
<span class="cm">      If springs are modeled with Hooke&#39;s law, determine all the forces </span>
<span class="cm">      (related to the spring) that act on the two attached bodies. This </span>
<span class="cm">      includes forces acting at the attachment points and those acting at the </span>
<span class="cm">      COMs. Calculate:</span>
<span class="cm">      -- separation distance (length) and vector between the two attachment points for calculating the spring forces</span>
<span class="cm">      -- relative speed of the attachment points for use in calculating the damping forces</span>
<span class="cm">      -- absolute speed of each attachment point for use in calculating drag forces</span>
<span class="cm">      </span>
<span class="cm">      Some of this is also needed for drawing the springs modeled as distance </span>
<span class="cm">      joints (in Box2D engine).</span>
<span class="cm">      */</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">calculateSeparation</span><span class="p">();</span>
      
      <span class="c1">//  If not using the native spring modeling (distance joints) in b2d, calculate the spring and damping forces.</span>
      <span class="c1">//  note: the logical operator forces a type conversion if softConstraints is undefined (converts to false, so !false is true)</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">softConstraints</span><span class="p">)</span> <span class="p">{</span>
         <span class="cm">/*</span>
<span class="cm">         First, calculate the forces that don&#39;t necessarily act on the center of the body, non COM.</span>
<span class="cm">         </span>
<span class="cm">         The pinned case needs to be able to handle the zero length spring. The </span>
<span class="cm">         separation distance will be zero when the pinned spring is at rest.</span>
<span class="cm">         This will cause a divide by zero error if not handled here.</span>
<span class="cm">         </span>
<span class="cm">         The second clause in this if statement checks for use of the editor, </span>
<span class="cm">         the control key. Block cursor-spring forces when doing deterministic </span>
<span class="cm">         movements. This only blocks traditional springs. If in distance-joint </span>
<span class="cm">         mode, the cursor movement will drag the selected puck some (a little) </span>
<span class="cm">         even when control key is down (and using shift or alt keys for </span>
<span class="cm">         rotation). </span>
<span class="cm">         */</span>
         <span class="k">if</span> <span class="p">(</span> <span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">p1p2_separation_m</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">length_m</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">))</span> <span class="o">||</span> <span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">forCursor</span> <span class="o">&amp;&amp;</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">].</span><span class="nx">key_ctrl</span> <span class="o">==</span> <span class="s2">&quot;D&quot;</span><span class="p">))</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">spring_force_on_1_2d_N</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">);</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// Spring force:  acts along the separation vector and is proportional to the stretch distance.</span>
            <span class="kd">var</span> <span class="nx">spring_force_on_1_2d_N</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">p1p2_normalized_2d</span><span class="p">.</span><span class="nx">scaleBy</span><span class="p">(</span> <span class="o">-</span><span class="k">this</span><span class="p">.</span><span class="nx">stretch_m</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">strength_Npm</span><span class="p">);</span>
         <span class="p">}</span>
         
         <span class="cm">/*</span>
<span class="cm">         These non-COM spring forces must be applied individually, at the</span>
<span class="cm">         attachment points. That&#39;s why these are appended to the puck&#39;s </span>
<span class="cm">         nonCOM_2d_N force array. This array is reset (emptied) after the </span>
<span class="cm">         movements are calculated in the physics engine.</span>
<span class="cm">         */</span>
         
         <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">spo1</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;Puck&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">spo1</span><span class="p">.</span><span class="nx">nonCOM_2d_N</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="s1">&#39;force_2d_N&#39;</span><span class="o">:</span> <span class="nx">spring_force_on_1_2d_N</span><span class="p">.</span><span class="nx">scaleBy</span><span class="p">(</span> <span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;point_w_2d_m&#39;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">spo1_ap_w_2d_m</span><span class="p">});</span>   
            <span class="cm">/*</span>
<span class="cm">            The following vector is used for aiming the NPC&#39;s navigation jets. (Note </span>
<span class="cm">            navigation springs are always conventional springs.) Check to see that </span>
<span class="cm">            this is on a navigation pin before updating navSpringOnly_force_2d_N. We </span>
<span class="cm">            only want the navigation spring force to be affecting the drawing of the </span>
<span class="cm">            navigation jet. This will exclude other springs, like cursor springs, </span>
<span class="cm">            from affecting the jet representation.</span>
<span class="cm">            */</span>
            <span class="k">if</span> <span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">spo2</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;Pin&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">spo2</span><span class="p">.</span><span class="nx">NPC</span><span class="p">))</span> <span class="k">this</span><span class="p">.</span><span class="nx">spo1</span><span class="p">.</span><span class="nx">navSpringOnly_force_2d_N</span> <span class="o">=</span> <span class="nx">spring_force_on_1_2d_N</span><span class="p">.</span><span class="nx">scaleBy</span><span class="p">(</span> <span class="o">+</span><span class="mi">1</span><span class="p">);</span>
         <span class="p">}</span>
         <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">spo2</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;Puck&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">spo2</span><span class="p">.</span><span class="nx">nonCOM_2d_N</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="s1">&#39;force_2d_N&#39;</span><span class="o">:</span> <span class="nx">spring_force_on_1_2d_N</span><span class="p">.</span><span class="nx">scaleBy</span><span class="p">(</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;point_w_2d_m&#39;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">spo2_ap_w_2d_m</span><span class="p">});</span>   
            <span class="c1">// (see explanation in spo1 block above)</span>
            <span class="k">if</span> <span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">spo1</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;Pin&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">spo1</span><span class="p">.</span><span class="nx">NPC</span><span class="p">))</span> <span class="k">this</span><span class="p">.</span><span class="nx">spo2</span><span class="p">.</span><span class="nx">navSpringOnly_force_2d_N</span> <span class="o">=</span> <span class="nx">spring_force_on_1_2d_N</span><span class="p">.</span><span class="nx">scaleBy</span><span class="p">(</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
         <span class="p">}</span>
         
         <span class="c1">// Damper force: acts along the separation vector and is proportional to the relative speed.</span>
         <span class="c1">// First, get the velocity at each attachment point.</span>
         <span class="kd">var</span> <span class="nx">v_spo1_ap_2d_mps</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D_from_b2Vec2</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">spo1</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">GetLinearVelocityFromWorldPoint</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">spo1_ap_w_2d_m</span><span class="p">));</span>
         <span class="kd">var</span> <span class="nx">v_spo2_ap_2d_mps</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D_from_b2Vec2</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">spo2</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">GetLinearVelocityFromWorldPoint</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">spo2_ap_w_2d_m</span><span class="p">));</span>
         
         <span class="kd">var</span> <span class="nx">v_relative_2d_mps</span> <span class="o">=</span> <span class="nx">v_spo1_ap_2d_mps</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span> <span class="nx">v_spo2_ap_2d_mps</span><span class="p">);</span>
         <span class="kd">var</span> <span class="nx">v_relative_alongNormal_2d_mps</span> <span class="o">=</span> <span class="nx">v_relative_2d_mps</span><span class="p">.</span><span class="nx">projection_onto</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">p1p2_separation_2d_m</span><span class="p">);</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">v_relative_alongNormal_2d_mps</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">v_relative_alongNormal_2d_mps</span> <span class="o">=</span> <span class="nx">v_relative_2d_mps</span><span class="p">.</span><span class="nx">scaleBy</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
         
         <span class="kd">var</span> <span class="nx">damper_force_on_1_2d_N</span> <span class="o">=</span> <span class="nx">v_relative_alongNormal_2d_mps</span><span class="p">.</span><span class="nx">scaleBy</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">damper_Ns2pm2</span><span class="p">);</span>
         <span class="c1">// This damper force acts in opposite directions for each of the two pucks. </span>
         <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">spo1</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;Puck&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Again, notice the negative sign here, opposite to the spring force.</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">spo1</span><span class="p">.</span><span class="nx">nonCOM_2d_N</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="s1">&#39;force_2d_N&#39;</span><span class="o">:</span> <span class="nx">damper_force_on_1_2d_N</span><span class="p">.</span><span class="nx">scaleBy</span><span class="p">(</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;point_w_2d_m&#39;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">spo1_ap_w_2d_m</span><span class="p">});</span>
         <span class="p">}</span>
         <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">spo2</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;Puck&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">spo2</span><span class="p">.</span><span class="nx">nonCOM_2d_N</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="s1">&#39;force_2d_N&#39;</span><span class="o">:</span> <span class="nx">damper_force_on_1_2d_N</span><span class="p">.</span><span class="nx">scaleBy</span><span class="p">(</span> <span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;point_w_2d_m&#39;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">spo2_ap_w_2d_m</span><span class="p">});</span>   
         <span class="p">}</span>
      <span class="p">}</span>
      <span class="cm">/* </span>
<span class="cm">      The following drag forces act at the puck&#39;s COM.</span>

<span class="cm">      These forces are not calculated for the b2d distance joints. So, </span>
<span class="cm">      need these in order to reproduce the behavior of the old cursor strings </span>
<span class="cm">      (now springs). These are based on the velocity of the pucks (not </span>
<span class="cm">      relative speed as is the case above for damper forces). </span>
<span class="cm">      </span>
<span class="cm">      This adds to (vector add using addTo) the puck&#39;s sprDamp_force_2d_N </span>
<span class="cm">      vector. By the time you&#39;ve looped through all the springs, you get the </span>
<span class="cm">      NET damping force, on each puck COM, applied by all the individual springs. </span>
<span class="cm">      This aggregate is reset (zeroed) after the movements are calculated. </span>
<span class="cm">      */</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">spo1</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;Puck&quot;</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">spo1</span><span class="p">.</span><span class="nx">sprDamp_force_2d_N</span><span class="p">.</span><span class="nx">addTo</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">spo1</span><span class="p">.</span><span class="nx">velocity_2d_mps</span><span class="p">.</span><span class="nx">scaleBy</span><span class="p">(</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">drag_c</span><span class="p">));</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">spo2</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;Puck&quot;</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">spo2</span><span class="p">.</span><span class="nx">sprDamp_force_2d_N</span><span class="p">.</span><span class="nx">addTo</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">spo2</span><span class="p">.</span><span class="nx">velocity_2d_mps</span><span class="p">.</span><span class="nx">scaleBy</span><span class="p">(</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">drag_c</span><span class="p">));</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="nx">Spring</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">inMultiSelect</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">spo1</span><span class="p">.</span><span class="nx">name</span> <span class="k">in</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">map</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">spo2</span><span class="p">.</span><span class="nx">name</span> <span class="k">in</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">map</span><span class="p">))</span> <span class="p">{</span>
         <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="nx">Spring</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">report</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="p">)</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">stretchValue</span><span class="p">,</span> <span class="nx">lengthPhrase</span><span class="p">,</span> <span class="nx">dragPhrase</span><span class="p">,</span> <span class="nx">springNature</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">fixedLength</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">// Getting a little fancy here: putting a sign (+-) a space away from the absolute value of the stretch.</span>
         <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stretch_m</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">stretchValue</span> <span class="o">=</span> <span class="s2">&quot; [base]+ &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">stretch_m</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;[base]&quot;</span><span class="p">;</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// &amp;#8722; is the code for a minus sign. A true minus sign is better than a dash from keyboard (which is wider than a plus sign).</span>
            <span class="nx">stretchValue</span> <span class="o">=</span> <span class="s2">&quot; [base,cyan]&quot;</span> <span class="o">+</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="mi">8722</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stretch_m</span><span class="p">).</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;[base]&quot;</span><span class="p">;</span>
         <span class="p">}</span>
         <span class="nx">lengthPhrase</span> <span class="o">=</span> <span class="s2">&quot;\\  length + stretch : &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">length_m</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="nx">stretchValue</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">length_m</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">stretch_m</span><span class="p">).</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
         
         <span class="c1">// This spring is modeled as Hooke&#39;s if this.softConstraints is undefined or false.</span>
         <span class="nx">springNature</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">softConstraints</span> <span class="o">===</span> <span class="kc">true</span><span class="p">)</span> <span class="o">?</span> <span class="s2">&quot;soft constraint&quot;</span> <span class="o">:</span> <span class="s2">&quot;Hooke&#39;s Law&quot;</span><span class="p">;</span>
         
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="nx">lengthPhrase</span> <span class="o">=</span> <span class="s2">&quot;\\  length = &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">length_m</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
         <span class="nx">springNature</span> <span class="o">=</span> <span class="s2">&quot;fixed length&quot;</span><span class="p">;</span>
      <span class="p">}</span>
      
      <span class="nx">dragPhrase</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">drag_c</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="s2">&quot;, drag = &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">drag_c</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
      
      <span class="kd">let</span> <span class="nx">objReport</span> <span class="o">=</span> <span class="s2">&quot;spring: [base,yellow]&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot;[base]&quot;</span> <span class="o">+</span> <span class="s2">&quot; (&quot;</span> <span class="o">+</span> <span class="nx">springNature</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span> <span class="o">+</span>
                      <span class="s2">&quot;\\  k = &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">strength_Npm</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, unstretched width = &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">unstretched_width_m</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> 
                      <span class="nx">lengthPhrase</span> <span class="o">+</span>
                      <span class="s2">&quot;\\  damping = &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">damper_Ns2pm2</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="nx">dragPhrase</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoVersion</span><span class="p">().</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;5.c&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nx">pendulumPeriod</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">length_m</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">stretch_m</span><span class="p">)</span> <span class="o">/</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">getG_mps2</span><span class="p">()</span> <span class="p">);</span>
        <span class="kd">let</span> <span class="nx">springPeriod</span>   <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">puckMap</span><span class="p">[</span><span class="s1">&#39;puck2&#39;</span><span class="p">].</span><span class="nx">mass_kg</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">strength_Npm</span> <span class="p">);</span>
        <span class="kd">let</span> <span class="nx">ratio_PS</span> <span class="o">=</span> <span class="nx">pendulumPeriod</span> <span class="o">/</span> <span class="nx">springPeriod</span><span class="p">;</span>
        <span class="nx">objReport</span><span class="o">+=</span> 
                    <span class="s2">&quot;\\ \\pendulum T = &quot;</span> <span class="o">+</span> <span class="nx">pendulumPeriod</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; s&quot;</span> <span class="o">+</span>
                    <span class="s2">&quot;\\spring T = &quot;</span> <span class="o">+</span> <span class="nx">springPeriod</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; s&quot;</span> <span class="o">+</span>
                    <span class="s2">&quot;\\ratio = &quot;</span> <span class="o">+</span> <span class="nx">ratio_PS</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help2&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span> <span class="nx">objReport</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="nx">Spring</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">draw</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">drawingContext</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">alpha</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">,</span> <span class="nx">width_m</span><span class="p">;</span>
      <span class="c1">// Update endpoints and the normal vector calculated from them...</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">calculateSeparation</span><span class="p">();</span>
      
      <span class="k">if</span> <span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">navigationForNPC</span> <span class="o">&amp;&amp;</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">editor</span><span class="p">.</span><span class="nx">checked</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">visible</span> <span class="o">&amp;&amp;</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">editor</span><span class="p">.</span><span class="nx">checked</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">visible</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">navigationForNPC</span><span class="p">))</span> <span class="p">{</span>
         <span class="cm">/*</span>
<span class="cm">         // These two width calculations will cause some discontinuity in how the springs look if they are being</span>
<span class="cm">         // length adjusted between zero and non-zero, especially for a puck in gravity on a zero-length spring. It&#39;s a compromise.</span>
<span class="cm">         if (this.length_m == 0) {</span>
<span class="cm">            // This version looks better for zero-length (pinned pucks)</span>
<span class="cm">            var width_m = this.unstretched_width_m * (1 - (0.40 * this.p1p2_separation_m));</span>
<span class="cm">         } else {</span>
<span class="cm">            // This version of the width calculation conserves the area of the spring.</span>
<span class="cm">            var width_m = (this.unstretched_width_m * this.length_m) / this.p1p2_separation_m;</span>
<span class="cm">         }</span>
<span class="cm">         */</span>
         
         <span class="cm">/* This is one way to deal with zero-length springs in the width </span>
<span class="cm">         calculation that follow and does not produce the discontinuity of the </span>
<span class="cm">         old method (above). The length_min_m effectively gives the spring some </span>
<span class="cm">         cross-sectional area to stretch, and calculate a non-zero width. You may </span>
<span class="cm">         still see some less-than-ideal behavior for a zero-length spring in </span>
<span class="cm">         gravity as the length is dynamically increased from zero. */</span> 
         <span class="kd">let</span> <span class="nx">length_min_m</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">length_m</span> <span class="o">&lt;</span> <span class="mf">0.6</span><span class="p">)</span> <span class="o">?</span> <span class="mf">0.6</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">length_m</span><span class="p">;</span> <span class="c1">// 0.8</span>
         
         <span class="c1">// protect from divide-by-zero</span>
         <span class="kd">let</span> <span class="nx">separation_min_m</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">p1p2_separation_m</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">)</span> <span class="o">?</span> <span class="mf">0.01</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">p1p2_separation_m</span><span class="p">;</span>
         <span class="c1">// conservation of area:  unstretched_width * length  =  width * (length + stretch)</span>
         <span class="nx">width_m</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">unstretched_width_m</span> <span class="o">*</span> <span class="nx">length_min_m</span> <span class="o">/</span> <span class="nx">separation_min_m</span><span class="p">;</span>
         
         <span class="c1">// conservation of volume:  unstretched_width^2 * length  =  width^2 * (length + stretch)</span>
         <span class="c1">//width_m = Math.sqrt( Math.pow( this.unstretched_width_m, 2) * length_min_m / separation_min_m);</span>
         
         <span class="c1">// note: also played with this non-conserving width calculation</span>
         <span class="c1">//let width_m = this.unstretched_width_m * (1 -  0.25 * (this.stretch_m / length_min_m));</span>
         
         <span class="c1">// Prevent the width value from getting too large.</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">width_m</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">unstretched_width_m</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">width_m</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">unstretched_width_m</span><span class="p">;</span>
         <span class="p">}</span>
         
         <span class="kd">var</span> <span class="nx">width_px</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">px_from_meters</span><span class="p">(</span> <span class="nx">width_m</span><span class="p">);</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">width_px</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="nx">width_px</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
         
         <span class="kd">var</span> <span class="nx">fillColor</span> <span class="o">=</span> <span class="p">(</span><span class="nx">drawingContext</span><span class="p">.</span><span class="nx">globalCompositeOperation</span> <span class="o">==</span> <span class="s1">&#39;screen&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;white&#39;</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">color</span><span class="p">;</span>
         
         <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">selected</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">dashArray</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">];</span>
            <span class="c1">// Must use the default &#39;butt&#39; ends if the lines are dashed.</span>
            <span class="c1">// Note: dashed lines require surprising CPU drain.</span>
            <span class="kd">var</span> <span class="nx">lineCap</span> <span class="o">=</span> <span class="s1">&#39;butt&#39;</span><span class="p">;</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="nx">Spring</span><span class="p">.</span><span class="nx">nameForPasting</span><span class="p">)</span> <span class="p">{</span>
               <span class="kd">var</span> <span class="nx">dashArray</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">1</span><span class="p">];</span> <span class="c1">// pattern: 5px solid, 1px gap, ...</span>
               <span class="kd">var</span> <span class="nx">lineCap</span> <span class="o">=</span> <span class="s1">&#39;butt&#39;</span><span class="p">;</span>
               <span class="nx">alpha</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span> <span class="c1">// source spring for pasting will render brighter.</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">candidateReportPasteDelete</span><span class="p">)</span> <span class="p">{</span>
               <span class="kd">var</span> <span class="nx">dashArray</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">];</span>
               <span class="kd">var</span> <span class="nx">lineCap</span> <span class="o">=</span> <span class="s1">&#39;butt&#39;</span><span class="p">;</span>
               <span class="nx">fillColor</span> <span class="o">=</span> <span class="s1">&#39;white&#39;</span><span class="p">;</span>
               <span class="nx">alpha</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
               <span class="c1">// If not dashed, you can use the fancy &#39;round&#39; ends. Nice.</span>
               <span class="kd">var</span> <span class="nx">dashArray</span> <span class="o">=</span> <span class="p">[];</span>
               <span class="kd">var</span> <span class="nx">lineCap</span> <span class="o">=</span> <span class="s1">&#39;round&#39;</span><span class="p">;</span>
            <span class="p">}</span>
         <span class="p">}</span>
         
         <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">getPauseErase</span><span class="p">())</span> <span class="p">{</span>
            
            <span class="c1">// This spring may be a cursor spring (this.forCursor is true). In that case, the name of the spring is also the client name. So</span>
            <span class="c1">// you&#39;ll see references to this.forCursor followed by references to the client in the clients map using the spring&#39;s name.             </span>
            
            <span class="c1">// Draw the spring.</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">spo1_ap_w_2d_px</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">spo2_ap_w_2d_px</span><span class="p">)</span> <span class="p">{</span>
               <span class="k">this</span><span class="p">.</span><span class="nx">drawLine</span><span class="p">(</span> <span class="nx">drawingContext</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">spo1_ap_w_2d_px</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">spo2_ap_w_2d_px</span><span class="p">,</span>
                  <span class="p">{</span><span class="s1">&#39;width_px&#39;</span><span class="o">:</span><span class="nx">width_px</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="o">:</span><span class="nx">fillColor</span><span class="p">,</span> <span class="s1">&#39;dashArray&#39;</span><span class="o">:</span><span class="nx">dashArray</span><span class="p">,</span> <span class="s1">&#39;alpha&#39;</span><span class="o">:</span><span class="nx">alpha</span><span class="p">,</span> <span class="s1">&#39;lineCap&#39;</span><span class="o">:</span><span class="nx">lineCap</span><span class="p">}</span> <span class="p">);</span>
                  
               <span class="c1">// small circle at each end</span>
               <span class="k">this</span><span class="p">.</span><span class="nx">drawCircle</span><span class="p">(</span> <span class="nx">drawingContext</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">spo1_ap_w_2d_px</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;borderColor&#39;</span><span class="o">:</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="s1">&#39;borderWidth_px&#39;</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;fillColor&#39;</span><span class="o">:</span><span class="s1">&#39;lightgray&#39;</span><span class="p">,</span> <span class="s1">&#39;radius_px&#39;</span><span class="o">:</span><span class="mi">3</span><span class="p">});</span>
               <span class="k">this</span><span class="p">.</span><span class="nx">drawCircle</span><span class="p">(</span> <span class="nx">drawingContext</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">spo2_ap_w_2d_px</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;borderColor&#39;</span><span class="o">:</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="s1">&#39;borderWidth_px&#39;</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;fillColor&#39;</span><span class="o">:</span><span class="s1">&#39;lightgray&#39;</span><span class="p">,</span> <span class="s1">&#39;radius_px&#39;</span><span class="o">:</span><span class="mi">3</span><span class="p">});</span>
               
               <span class="c1">// draw extension line for monkeyhunt...</span>
               <span class="k">if</span> <span class="p">(</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoVersion</span><span class="p">().</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;monkeyhunt&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                   <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">forCursor</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">].</span><span class="nx">ctrlShiftLock</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">].</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;Puck&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">].</span><span class="nx">key_ctrl</span> <span class="o">!=</span> <span class="s2">&quot;D&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                   <span class="p">(</span> <span class="o">!</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">].</span><span class="nx">compoundBodySelected</span><span class="p">())</span> <span class="p">)</span> <span class="p">{</span>
                  
                  <span class="kd">let</span> <span class="nx">extensionPoint_2d_m</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">spo1_ap_w_2d_m</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">p1p2_normalized_2d</span><span class="p">.</span><span class="nx">scaleBy</span><span class="p">(</span> <span class="mf">20.0</span><span class="p">));</span>
                  <span class="kd">let</span> <span class="nx">extensionPoint_2d_px</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">screenFromWorld</span><span class="p">(</span> <span class="nx">extensionPoint_2d_m</span><span class="p">);</span>
                  <span class="k">this</span><span class="p">.</span><span class="nx">drawLine</span><span class="p">(</span> <span class="nx">drawingContext</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">spo1_ap_w_2d_px</span><span class="p">,</span> <span class="nx">extensionPoint_2d_px</span><span class="p">,</span>
                     <span class="p">{</span><span class="s1">&#39;width_px&#39;</span><span class="o">:</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="o">:</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="s1">&#39;dashArray&#39;</span><span class="o">:</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;alpha&#39;</span><span class="o">:</span><span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;lineCap&#39;</span><span class="o">:</span><span class="nx">lineCap</span><span class="p">}</span> <span class="p">);</span>
               <span class="p">}</span>
            <span class="p">}</span>
               
            <span class="c1">// Draw a line to indicate the spring stretch associated with the locked-speed value for puck shots.</span>
            <span class="kd">var</span> <span class="nx">readyToShoot</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">forCursor</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(((</span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">].</span><span class="nx">key_ctrl</span> <span class="o">==</span> <span class="s2">&quot;D&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">].</span><span class="nx">key_shift</span> <span class="o">==</span> <span class="s2">&quot;D&quot;</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">].</span><span class="nx">ctrlShiftLock</span><span class="p">));</span>
            <span class="k">if</span> <span class="p">((</span><span class="nx">readyToShoot</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">].</span><span class="nx">poolShotLocked</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">spo2</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s1">&#39;Puck&#39;</span><span class="p">))</span> <span class="p">{</span>
               <span class="c1">// normal vector along the spring.</span>
               <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">p1p2_separation_2d_m</span><span class="p">.</span><span class="nx">zeroLength</span><span class="p">())</span> <span class="p">{</span>
                  <span class="kd">let</span> <span class="nx">stretchAtLockSpeed_m</span> <span class="o">=</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">].</span><span class="nx">poolShotLockedSpringStretch_m</span><span class="p">;</span>
                  
                  <span class="c1">// Don&#39;t extend the indicator line past the ghost ball (ghost must be separated enough to show the speed lock segment).  </span>
                  <span class="k">if</span> <span class="p">(</span><span class="nx">stretchAtLockSpeed_m</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">p1p2_separation_m</span><span class="p">)</span> <span class="p">{</span>
                     <span class="kd">var</span> <span class="nx">endPoint_2d_m</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">p1p2_normalized_2d</span><span class="p">.</span><span class="nx">scaleBy</span><span class="p">(</span> <span class="nx">stretchAtLockSpeed_m</span><span class="p">).</span><span class="nx">add</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">spo2_ap_w_2d_m</span><span class="p">);</span>
                  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                     <span class="kd">var</span> <span class="nx">endPoint_2d_m</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">spo1_ap_w_2d_m</span><span class="p">;</span>
                  <span class="p">}</span>
                  <span class="kd">var</span> <span class="nx">endPoint_2d_px</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">screenFromWorld</span><span class="p">(</span> <span class="nx">endPoint_2d_m</span><span class="p">);</span>
                  
                  <span class="c1">// For the yellow client, shift to a red indicator.</span>
                  <span class="kd">var</span> <span class="nx">indicatorColor</span> <span class="o">=</span> <span class="p">(</span><span class="nx">fillColor</span> <span class="o">==</span> <span class="s1">&#39;yellow&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;red&#39;</span><span class="o">:</span><span class="s1">&#39;yellow&#39;</span><span class="p">;</span>
                  
                  <span class="c1">// Draw line from the source ball (object 2) out to the endpoint, toward the cursor and the ghost ball (object 1).</span>
                  <span class="k">this</span><span class="p">.</span><span class="nx">drawLine</span><span class="p">(</span> <span class="nx">drawingContext</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">spo2_ap_w_2d_px</span><span class="p">,</span> <span class="nx">endPoint_2d_px</span><span class="p">,</span>
                     <span class="p">{</span><span class="s1">&#39;width_px&#39;</span><span class="o">:</span><span class="nx">width_px</span> <span class="o">*</span> <span class="mf">2.0</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="o">:</span><span class="nx">indicatorColor</span><span class="p">,</span> <span class="s1">&#39;dashArray&#39;</span><span class="o">:</span><span class="nx">dashArray</span><span class="p">,</span> <span class="s1">&#39;alpha&#39;</span><span class="o">:</span><span class="nx">alpha</span><span class="p">,</span> <span class="s1">&#39;lineCap&#39;</span><span class="o">:</span><span class="nx">lineCap</span><span class="p">}</span> <span class="p">);</span>
               <span class="p">}</span>
            <span class="p">}</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>
   
   
   
   <span class="kd">function</span> <span class="nx">Wall</span><span class="p">(</span> <span class="nx">position_2d_m</span><span class="p">,</span> <span class="nx">pars</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">dFM</span><span class="p">.</span><span class="nx">DrawingFunctions</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span> <span class="c1">// inherit</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">parsAtBirth</span> <span class="o">=</span> <span class="nx">pars</span><span class="p">;</span>
      
      <span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">assignName</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">Wall</span><span class="p">.</span><span class="nx">nameIndex</span><span class="p">,</span> <span class="s2">&quot;wall&quot;</span><span class="p">,</span> <span class="s2">&quot;wallMap&quot;</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
      <span class="nx">Wall</span><span class="p">.</span><span class="nx">nameIndex</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">index</span><span class="p">;</span>
      
      <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">wallMap</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      
      <span class="c1">// Position of Center of Mass (COM)</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_m</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D_check</span><span class="p">(</span> <span class="nx">position_2d_m</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_px</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">screenFromWorld</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">);</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">fence</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">fence</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">fenceLeg</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">fenceLeg</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">fenceLeg</span> <span class="o">==</span> <span class="s1">&#39;top&#39;</span><span class="p">)</span> <span class="nx">Wall</span><span class="p">.</span><span class="nx">topFenceLegName</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span> <span class="c1">// For use in pi-calc demos</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">sensor</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">sensor</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">visible</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">visible</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">velocity_2d_mps</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">velocity_2d_mps</span><span class="p">,</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">));</span>
      <span class="c1">// Make sure this is a Vec2D vector (e.g. when restoring from a capture).</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">velocity_2d_mps</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D_from_b2Vec2</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">velocity_2d_mps</span><span class="p">);</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">angle_r</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">angle_r</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">angularSpeed_rps</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">angularSpeed_rps</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
      
      <span class="c1">// Dimensions (as specified in box2D)</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">half_width_m</span>  <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">half_width_m</span> <span class="p">,</span> <span class="mf">0.5</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">half_height_m</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">half_height_m</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">);</span>
      
      <span class="c1">// Calculate these characteristics in screen units (pixels).</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">half_width_px</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">px_from_meters</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">half_width_m</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">half_height_px</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">px_from_meters</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">half_height_m</span><span class="p">);</span>

      <span class="nx">Wall</span><span class="p">.</span><span class="nx">color_default</span> <span class="o">=</span> <span class="s2">&quot;darkgray&quot;</span><span class="p">;</span> <span class="c1">// white</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">color</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">color</span><span class="p">,</span> <span class="nx">Wall</span><span class="p">.</span><span class="nx">color_default</span><span class="p">);</span>
      
      <span class="c1">// Local selection point where candidate revolute joints can be attached.</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">selectionPoint_l_2d_m</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">deleted</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">monkeyHunt</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">monkeyHunt</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
      
      <span class="c1">// All parameters should be set above this point.</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">create_b2d_wall</span><span class="p">();</span>
      <span class="c1">// Create a reference back to this wall from the b2d wall.</span>
      <span class="nx">gW</span><span class="p">.</span><span class="nx">tableMap</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="nx">Wall</span><span class="p">.</span><span class="nx">nameIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="nx">Wall</span><span class="p">.</span><span class="nx">topFenceLegName</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span> <span class="c1">// For use in pi-calc demos</span>
   <span class="nx">Wall</span><span class="p">.</span><span class="nx">applyToAll</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">doThis</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">wallName</span> <span class="k">in</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">wallMap</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">//console.log(&quot;name in applyToAll=&quot;+wallName);</span>
         <span class="kd">var</span> <span class="nx">wall</span> <span class="o">=</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">wallMap</span><span class="p">[</span> <span class="nx">wallName</span><span class="p">];</span>
         <span class="nx">doThis</span><span class="p">(</span> <span class="nx">wall</span><span class="p">);</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="nx">Wall</span><span class="p">.</span><span class="nx">deleteAll</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">Wall</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span> <span class="nx">wall</span> <span class="p">=&gt;</span> <span class="p">{</span>
         <span class="nx">gW</span><span class="p">.</span><span class="nx">tableMap</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span> <span class="nx">wall</span><span class="p">.</span><span class="nx">b2d</span><span class="p">);</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">wall</span><span class="p">.</span><span class="nx">b2d</span><span class="p">)</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">world</span><span class="p">.</span><span class="nx">DestroyBody</span><span class="p">(</span> <span class="nx">wall</span><span class="p">.</span><span class="nx">b2d</span><span class="p">);</span>
      <span class="p">});</span>
      <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">wallMap</span> <span class="o">=</span> <span class="p">{};</span>
      <span class="nx">Wall</span><span class="p">.</span><span class="nx">nameIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="nx">Wall</span><span class="p">.</span><span class="nx">makeFence</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">pars</span> <span class="o">=</span> <span class="p">{},</span> <span class="nx">canvas</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Build perimeter fence (4 walls) using the canvas dimensions.</span>
      
      <span class="kd">var</span> <span class="nx">width_m</span>  <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">meters_from_px</span><span class="p">(</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span> <span class="p">);</span>
      <span class="kd">var</span> <span class="nx">half_width_m</span> <span class="o">=</span> <span class="nx">width_m</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">;</span>
      
      <span class="kd">var</span> <span class="nx">height_m</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">meters_from_px</span><span class="p">(</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">half_height_m</span> <span class="o">=</span> <span class="nx">height_m</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">;</span>
      
      <span class="kd">var</span> <span class="nx">wall_thickness_m</span> <span class="o">=</span> <span class="mf">0.10</span><span class="p">;</span>
      
      <span class="kd">var</span> <span class="nx">pull_in_m</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
      
      <span class="c1">// By default, all four walls of the fence are generated.</span>
      <span class="kd">var</span> <span class="nx">tOn</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">tOn</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">bOn</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">bOn</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">lOn</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">lOn</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">rOn</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">rOn</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
      
      <span class="kd">var</span> <span class="nx">short_wide_dimensions</span>  <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fence&#39;</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span> <span class="s1">&#39;half_width_m&#39;</span><span class="o">:</span><span class="nx">half_width_m</span><span class="p">,</span>         <span class="s1">&#39;half_height_m&#39;</span><span class="o">:</span><span class="nx">wall_thickness_m</span><span class="o">/</span><span class="mf">2.0</span><span class="p">};</span>
      <span class="kd">var</span> <span class="nx">tall_skinny_dimensions</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fence&#39;</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span> <span class="s1">&#39;half_width_m&#39;</span><span class="o">:</span><span class="nx">wall_thickness_m</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="s1">&#39;half_height_m&#39;</span><span class="o">:</span><span class="nx">half_height_m</span><span class="p">};</span>
            
      <span class="c1">// Add four bumper walls to the table.</span>
      <span class="c1">// top</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">tOn</span><span class="p">)</span> <span class="k">new</span> <span class="nx">Wall</span><span class="p">(</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span> <span class="nx">half_width_m</span><span class="p">,</span> <span class="nx">height_m</span> <span class="o">-</span> <span class="nx">pull_in_m</span><span class="p">),</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">({</span><span class="s1">&#39;fenceLeg&#39;</span><span class="o">:</span><span class="s1">&#39;top&#39;</span><span class="p">},</span>    <span class="nx">short_wide_dimensions</span><span class="p">)</span> <span class="p">);</span>
      <span class="c1">// bottom</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">bOn</span><span class="p">)</span> <span class="k">new</span> <span class="nx">Wall</span><span class="p">(</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span> <span class="nx">half_width_m</span><span class="p">,</span>     <span class="mf">0.00</span> <span class="o">+</span> <span class="nx">pull_in_m</span><span class="p">),</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">({</span><span class="s1">&#39;fenceLeg&#39;</span><span class="o">:</span><span class="s1">&#39;bottom&#39;</span><span class="p">},</span> <span class="nx">short_wide_dimensions</span><span class="p">)</span> <span class="p">);</span>
      <span class="c1">// left</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">lOn</span><span class="p">)</span> <span class="k">new</span> <span class="nx">Wall</span><span class="p">(</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span>    <span class="mf">0.00</span> <span class="o">+</span> <span class="nx">pull_in_m</span><span class="p">,</span> <span class="nx">half_height_m</span><span class="p">),</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">({</span><span class="s1">&#39;fenceLeg&#39;</span><span class="o">:</span><span class="s1">&#39;left&#39;</span><span class="p">},</span>   <span class="nx">tall_skinny_dimensions</span><span class="p">)</span> <span class="p">);</span>
      <span class="c1">// right</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">rOn</span><span class="p">)</span> <span class="k">new</span> <span class="nx">Wall</span><span class="p">(</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span> <span class="nx">width_m</span> <span class="o">-</span> <span class="nx">pull_in_m</span><span class="p">,</span> <span class="nx">half_height_m</span><span class="p">),</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">({</span><span class="s1">&#39;fenceLeg&#39;</span><span class="o">:</span><span class="s1">&#39;right&#39;</span><span class="p">},</span>  <span class="nx">tall_skinny_dimensions</span><span class="p">)</span> <span class="p">);</span>
   <span class="p">}</span>
   <span class="nx">Wall</span><span class="p">.</span><span class="nx">deleteFence</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">Wall</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span> <span class="nx">wall</span> <span class="p">=&gt;</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">wall</span><span class="p">.</span><span class="nx">fence</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">wall</span><span class="p">.</span><span class="nx">deleteThisOne</span><span class="p">({});</span>
         <span class="p">}</span>
      <span class="p">});</span>
   <span class="p">}</span>
   <span class="nx">Wall</span><span class="p">.</span><span class="nx">deleteAllButFence</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">Wall</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span> <span class="nx">wall</span> <span class="p">=&gt;</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">wall</span><span class="p">.</span><span class="nx">fence</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">wall</span><span class="p">.</span><span class="nx">deleteThisOne</span><span class="p">({});</span>
         <span class="p">}</span>
      <span class="p">});</span>
   <span class="p">}</span>
   <span class="nx">Wall</span><span class="p">.</span><span class="nx">checkForFence</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">foundFence</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="nx">Wall</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span> <span class="nx">wall</span> <span class="p">=&gt;</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">wall</span><span class="p">.</span><span class="nx">fence</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">foundFence</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
         <span class="p">}</span>
      <span class="p">});</span>
      <span class="k">return</span> <span class="nx">foundFence</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="nx">Wall</span><span class="p">.</span><span class="nx">getFenceParms</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">fenceParms</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;bOn&#39;</span><span class="o">:</span><span class="kc">false</span><span class="p">,</span> <span class="s1">&#39;tOn&#39;</span><span class="o">:</span><span class="kc">false</span><span class="p">,</span> <span class="s1">&#39;rOn&#39;</span><span class="o">:</span><span class="kc">false</span><span class="p">,</span> <span class="s1">&#39;lOn&#39;</span><span class="o">:</span><span class="kc">false</span><span class="p">};</span>
      <span class="nx">Wall</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span> <span class="nx">wall</span> <span class="p">=&gt;</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">wall</span><span class="p">.</span><span class="nx">fence</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">wall</span><span class="p">.</span><span class="nx">fenceLeg</span><span class="p">)</span> <span class="p">{</span>
               <span class="k">if</span> <span class="p">(</span><span class="nx">wall</span><span class="p">.</span><span class="nx">fenceLeg</span> <span class="o">==</span> <span class="s2">&quot;top&quot;</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">fenceParms</span><span class="p">[</span><span class="s1">&#39;tOn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> 
               <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">wall</span><span class="p">.</span><span class="nx">fenceLeg</span> <span class="o">==</span> <span class="s2">&quot;bottom&quot;</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">fenceParms</span><span class="p">[</span><span class="s1">&#39;bOn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> 
               <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">wall</span><span class="p">.</span><span class="nx">fenceLeg</span> <span class="o">==</span> <span class="s2">&quot;right&quot;</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">fenceParms</span><span class="p">[</span><span class="s1">&#39;rOn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> 
               <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">wall</span><span class="p">.</span><span class="nx">fenceLeg</span> <span class="o">==</span> <span class="s2">&quot;left&quot;</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">fenceParms</span><span class="p">[</span><span class="s1">&#39;lOn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> 
               <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
               <span class="c1">// Try to identify the section of fence by its location.</span>
               <span class="k">if</span> <span class="p">(</span><span class="nx">wall</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">.</span><span class="nx">x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">fenceParms</span><span class="p">[</span><span class="s1">&#39;lOn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
               <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">wall</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">.</span><span class="nx">y</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">fenceParms</span><span class="p">[</span><span class="s1">&#39;bOn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
               <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">wall</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">.</span><span class="nx">y</span> <span class="o">&gt;</span> <span class="nx">wall</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">fenceParms</span><span class="p">[</span><span class="s1">&#39;tOn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
               <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">wall</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">.</span><span class="nx">x</span> <span class="o">&gt;</span> <span class="nx">wall</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">fenceParms</span><span class="p">[</span><span class="s1">&#39;rOn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
               <span class="p">}</span>
            <span class="p">}</span>
         <span class="p">}</span>
      <span class="p">});</span>
      <span class="k">return</span> <span class="nx">fenceParms</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="nx">Wall</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span> <span class="nx">dFM</span><span class="p">.</span><span class="nx">DrawingFunctions</span><span class="p">.</span><span class="nx">prototype</span><span class="p">);</span> <span class="c1">// Inherit methods</span>
   <span class="nx">Wall</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">=</span> <span class="nx">Wall</span><span class="p">;</span> <span class="c1">// Rename the constructor (after inheriting)</span>
   <span class="nx">Wall</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">inMultiSelect</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="k">in</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">map</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="nx">Wall</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">deleteThisOne</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">pars</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">deleteMode</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">deleteMode</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
      
      <span class="c1">// Delete reference in the tableMap.</span>
      <span class="nx">gW</span><span class="p">.</span><span class="nx">tableMap</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">);</span>
      
      <span class="c1">// Delete the corresponding Box2d object.</span>
      <span class="nx">gW</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">world</span><span class="p">.</span><span class="nx">DestroyBody</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">);</span>
      
      <span class="c1">// Mark this wall as deleted. Therefore, any springs or joints that</span>
      <span class="c1">// have a reference to this wall will be removed in the game loop.</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">deleted</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      
      <span class="c1">// Remove this wall from the wall map.</span>
      <span class="k">delete</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">wallMap</span><span class="p">[</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">];</span>
      <span class="c1">// ...and from the multi-select map.</span>
      <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">removeOne</span><span class="p">(</span> <span class="k">this</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="nx">Wall</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">copyThisOne</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">pars</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">position_2d_m</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">);</span>
      
      <span class="k">return</span> <span class="k">new</span> <span class="nx">Wall</span><span class="p">(</span> <span class="nx">position_2d_m</span><span class="p">,</span> 
                        <span class="p">{</span><span class="s1">&#39;half_width_m&#39;</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">half_width_m</span><span class="p">,</span> 
                         <span class="s1">&#39;half_height_m&#39;</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">half_height_m</span><span class="p">,</span> 
                         <span class="s1">&#39;angle_r&#39;</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">angle_r</span><span class="p">,</span> 
                         <span class="s1">&#39;angularSpeed_rps&#39;</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">angularSpeed_rps</span><span class="p">,</span>
                         <span class="s1">&#39;monkeyHunt&#39;</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">monkeyHunt</span><span class="p">});</span>
   <span class="p">}</span>
   <span class="nx">Wall</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">define_fixture</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">pars</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Note that the default behavior is to have all scaling factors at 1.0 which only updates the box2d attributes</span>
      <span class="c1">// to correspond to those of the Wall object.</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">width_scaling</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">width_scaling</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">height_scaling</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">height_scaling</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
      
      <span class="kd">var</span> <span class="nx">fixDef</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">b2DW</span><span class="p">.</span><span class="nx">FixtureDef</span><span class="p">;</span>      
      <span class="nx">fixDef</span><span class="p">.</span><span class="nx">shape</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">b2DW</span><span class="p">.</span><span class="nx">PolygonShape</span><span class="p">;</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">sensor</span><span class="p">)</span> <span class="nx">fixDef</span><span class="p">.</span><span class="nx">isSensor</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      
      <span class="c1">// Apply the scaling factors to the current width and height.</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">half_width_m</span> <span class="o">*=</span> <span class="k">this</span><span class="p">.</span><span class="nx">width_scaling</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">half_height_m</span> <span class="o">*=</span> <span class="k">this</span><span class="p">.</span><span class="nx">height_scaling</span><span class="p">;</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">half_width_px</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">px_from_meters</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">half_width_m</span><span class="p">);</span>
      <span class="c1">// Don&#39;t let it get too skinny because it becomes hard to select.</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">half_width_px</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">half_width_px</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">half_width_m</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">meters_from_px</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">half_width_px</span><span class="p">);</span>
      <span class="p">}</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">half_height_px</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">px_from_meters</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">half_height_m</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">half_height_px</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">half_height_px</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">half_height_m</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">meters_from_px</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">half_height_px</span><span class="p">);</span>
      <span class="p">}</span>
      
      <span class="nx">fixDef</span><span class="p">.</span><span class="nx">shape</span><span class="p">.</span><span class="nx">SetAsBox</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">half_width_m</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">half_height_m</span><span class="p">);</span>
      
      <span class="k">return</span> <span class="nx">fixDef</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="nx">Wall</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">create_b2d_wall</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="c1">// Create a rectangular box2d object.</span>
      
      <span class="kd">var</span> <span class="nx">bodyDef</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">b2DW</span><span class="p">.</span><span class="nx">BodyDef</span><span class="p">;</span>
      <span class="c1">// When initially tried the b2_kinematicBody type, had trouble with collisions after using the mouse to</span>
      <span class="c1">// rotate the wall. Collisions (post wall rotation) would clear off the table, delete all pucks.</span>
      <span class="c1">// So played around with animating (see updateStaticBodyState method below) a static body, to avoid this issue. </span>
      <span class="c1">// But of course, kinematic bodies can have their movement represented in the engine and so can model</span>
      <span class="c1">// collisions with things like a moving paddle. So the kinematic body is really needed if the walls are</span>
      <span class="c1">// going to be rotating. Also see the key_t block of the keydown event handler in gwModule.</span>
      <span class="nx">bodyDef</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="nx">b2DW</span><span class="p">.</span><span class="nx">Body</span><span class="p">.</span><span class="nx">b2_kinematicBody</span><span class="p">;</span> <span class="c1">// b2_kinematicBody b2_staticBody</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span> <span class="o">=</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">world</span><span class="p">.</span><span class="nx">CreateBody</span><span class="p">(</span> <span class="nx">bodyDef</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">CreateFixture</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">define_fixture</span><span class="p">({}));</span>
      
      <span class="c1">// Set the state: position and velocity (angle and angular speed).</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">SetPosition</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">SetAngle</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">angle_r</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">m_type</span> <span class="o">!=</span> <span class="nx">b2DW</span><span class="p">.</span><span class="nx">Body</span><span class="p">.</span><span class="nx">b2_staticBody</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">SetLinearVelocity</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">velocity_2d_mps</span><span class="p">);</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">SetAngularVelocity</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">angularSpeed_rps</span><span class="p">);</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="nx">Wall</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setPosition</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">newPosition_2d_m</span><span class="p">,</span> <span class="nx">angle_r</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_m</span> <span class="o">=</span> <span class="nx">newPosition_2d_m</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">SetPosition</span><span class="p">(</span> <span class="nx">newPosition_2d_m</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">angle_r</span> <span class="o">=</span> <span class="nx">angle_r</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">SetAngle</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">angle_r</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="nx">Wall</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setVelocity</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">newVelocity_2d_mps</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">IsAwake</span><span class="p">())</span> <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">SetAwake</span><span class="p">(</span> <span class="kc">true</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">velocity_2d_mps</span> <span class="o">=</span> <span class="nx">newVelocity_2d_mps</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">SetLinearVelocity</span><span class="p">(</span> <span class="nx">newVelocity_2d_mps</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="nx">Wall</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">interpret_editCommand</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">command</span><span class="p">,</span> <span class="nx">sf</span> <span class="o">=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// If you are going to modify the fixture dimensions you have to delete</span>
      <span class="c1">// the old one and make a new one. The m_fixtureList linked list always</span>
      <span class="c1">// points to the most recent addition to the linked list. If there&#39;s only</span>
      <span class="c1">// one fixture, then m_fixtureList is a reference to that single fixture.</span>
      
      <span class="kd">var</span> <span class="nx">width_factor</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">height_factor</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>
      
      <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">hack</span><span class="p">[</span><span class="s1">&#39;pwsEdits&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="nx">command</span> <span class="o">==</span> <span class="s1">&#39;wider&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">width_factor</span> <span class="o">=</span> <span class="p">(</span><span class="nx">sf</span><span class="p">)</span> <span class="o">?</span> <span class="nx">sf</span> <span class="o">:</span> <span class="mf">1.1</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">command</span> <span class="o">==</span> <span class="s1">&#39;thinner&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">width_factor</span> <span class="o">=</span> <span class="p">(</span><span class="nx">sf</span><span class="p">)</span> <span class="o">?</span> <span class="nx">sf</span> <span class="o">:</span> <span class="mf">1.0</span><span class="o">/</span><span class="mf">1.1</span><span class="p">;</span>
         
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">command</span> <span class="o">==</span> <span class="s1">&#39;taller&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">height_factor</span> <span class="o">=</span> <span class="p">(</span><span class="nx">sf</span><span class="p">)</span> <span class="o">?</span> <span class="nx">sf</span> <span class="o">:</span> <span class="mf">1.1</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">command</span> <span class="o">==</span> <span class="s1">&#39;shorter&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">height_factor</span> <span class="o">=</span> <span class="p">(</span><span class="nx">sf</span><span class="p">)</span> <span class="o">?</span> <span class="nx">sf</span> <span class="o">:</span> <span class="mf">1.0</span><span class="o">/</span><span class="mf">1.1</span><span class="p">;</span>
         
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">command</span> <span class="o">==</span> <span class="s1">&#39;noChange&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">// don&#39;t change anything.</span>
      <span class="p">}</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">DestroyFixture</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">m_fixtureList</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">CreateFixture</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">define_fixture</span><span class="p">({</span><span class="s1">&#39;width_scaling&#39;</span><span class="o">:</span><span class="nx">width_factor</span><span class="p">,</span><span class="s1">&#39;height_scaling&#39;</span><span class="o">:</span><span class="nx">height_factor</span><span class="p">}));</span>
      
      <span class="kd">var</span> <span class="nx">dimensionsReport</span> <span class="o">=</span> <span class="s2">&quot;half width, half height = &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">half_width_m</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">half_height_m</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; m&quot;</span><span class="p">;</span>
      <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span> <span class="nx">dimensionsReport</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
      
      <span class="c1">// As the wall is resized, adjust attachment points, and multiselect points.</span>
      <span class="nx">adjustAttachments</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">width_factor</span><span class="p">,</span> <span class="nx">height_factor</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="nx">Wall</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">draw_MultiSelectPoint</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">drawingContext</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">selectionPoint_2d_px</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">comSelection</span><span class="p">.</span><span class="nx">checked</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">selectionPoint_2d_px</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">screenFromWorld</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">GetWorldPoint</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">selectionPoint_l_2d_m</span><span class="p">));</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="nx">selectionPoint_2d_px</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_px</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">drawCircle</span><span class="p">(</span> <span class="nx">drawingContext</span><span class="p">,</span> <span class="nx">selectionPoint_2d_px</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;borderColor&#39;</span><span class="o">:</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="s1">&#39;borderWidth_px&#39;</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;fillColor&#39;</span><span class="o">:</span><span class="s1">&#39;yellow&#39;</span><span class="p">,</span> <span class="s1">&#39;radius_px&#39;</span><span class="o">:</span><span class="mi">5</span><span class="p">});</span>
   <span class="p">}</span>
   <span class="nx">Wall</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getPosition</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_m</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D_from_b2Vec2</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">GetPosition</span><span class="p">());</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_px</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">screenFromWorld</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="nx">Wall</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">updateStaticBodyState</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> 
      <span class="c1">// If modeling walls with static box2d bodies, must animate them directly. Compare</span>
      <span class="c1">// with pins, which always use kinematic bodies; they don&#39;t have animation code like this.</span>
      <span class="c1">// (see comment in create_b2d_wall)</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">m_type</span> <span class="o">==</span> <span class="nx">b2DW</span><span class="p">.</span><span class="nx">Body</span><span class="p">.</span><span class="nx">b2_staticBody</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_m</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D_from_b2Vec2</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">GetPosition</span><span class="p">());</span>      
         <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_px</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">screenFromWorld</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">);</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">.</span><span class="nx">addTo</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">velocity_2d_mps</span><span class="p">.</span><span class="nx">scaleBy</span><span class="p">(</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">getDeltaT_s</span><span class="p">()));</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">SetPosition</span><span class="p">(</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">b2Vec2_from_Vec2D</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">));</span>
         
         <span class="k">this</span><span class="p">.</span><span class="nx">angle_r</span> <span class="o">+=</span> <span class="k">this</span><span class="p">.</span><span class="nx">angularSpeed_rps</span> <span class="o">*</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">getDeltaT_s</span><span class="p">();</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">SetAngle</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">angle_r</span><span class="p">);</span>
      <span class="p">}</span>
   <span class="p">}</span>   
   <span class="nx">Wall</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">draw</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">drawingContext</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// (see comment in create_b2d_wall)</span>
      
      <span class="c1">// Update the position of the wall&#39;s center point and it&#39;s body angle.</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">m_type</span> <span class="o">==</span> <span class="nx">b2DW</span><span class="p">.</span><span class="nx">Body</span><span class="p">.</span><span class="nx">b2_kinematicBody</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">angle_r</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">GetAngle</span><span class="p">();</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">getPosition</span><span class="p">();</span>
      <span class="p">}</span>
      
      <span class="c1">// However, directly use the vertices of the rectangle for drawing.</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">visible</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">drawPolygon</span><span class="p">(</span> <span class="nx">drawingContext</span><span class="p">,</span> <span class="nx">bS</span><span class="p">.</span><span class="nx">b2d_getPolygonVertices_2d_px</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">b2d</span><span class="p">),</span> <span class="p">{</span><span class="s1">&#39;borderColor&#39;</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">color</span><span class="p">,</span> <span class="s1">&#39;borderWidth_px&#39;</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;fillColor&#39;</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">color</span><span class="p">});</span>
      <span class="p">}</span>
   <span class="p">}</span>
   
      
   
   <span class="c1">// Energy, Momentum, and Angular Momentum (and Speed) report</span>
   <span class="c1">// Note: no prototypes here.</span>
   <span class="kd">var</span> <span class="nx">m_EpL</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s1">&#39;displayReport&#39;</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> 
      <span class="s1">&#39;reportType&#39;</span><span class="o">:</span> <span class="s1">&#39;EpL&#39;</span><span class="p">,</span>
      <span class="s1">&#39;reportString&#39;</span><span class="o">:</span> <span class="s1">&#39;initial test&#39;</span><span class="p">,</span>
      <span class="s1">&#39;angularAxis_2d_m&#39;</span><span class="o">:</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mf">1.75</span><span class="p">,</span><span class="mf">1.75</span><span class="p">),</span>
      <span class="s1">&#39;pinName&#39;</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="s1">&#39;COM&#39;</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
   <span class="p">};</span>
   <span class="nx">m_EpL</span><span class="p">.</span><span class="nx">toggle</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">pars</span><span class="o">=</span><span class="p">{})</span> <span class="p">{</span> 
      <span class="kd">let</span> <span class="nx">angularAxis_2d_m</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">angularAxis_2d_m</span><span class="p">,</span> <span class="nx">m_EpL</span><span class="p">.</span><span class="nx">angularAxis_2d_m</span><span class="p">);</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="nx">m_EpL</span><span class="p">.</span><span class="nx">displayReport</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">m_EpL</span><span class="p">.</span><span class="nx">turnDisplayOff</span><span class="p">({});</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="nx">m_EpL</span><span class="p">.</span><span class="nx">turnDisplayOn</span><span class="p">({</span><span class="s1">&#39;angularAxis_2d_m&#39;</span><span class="o">:</span> <span class="nx">angularAxis_2d_m</span><span class="p">});</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="nx">m_EpL</span><span class="p">.</span><span class="nx">turnDisplayOff</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">pars</span><span class="o">=</span><span class="p">{})</span> <span class="p">{</span> 
      <span class="nx">m_EpL</span><span class="p">.</span><span class="nx">displayReport</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">m_EpL</span><span class="p">.</span><span class="nx">pinName</span><span class="p">)</span> <span class="nx">m_EpL</span><span class="p">.</span><span class="nx">deleteEditPin</span><span class="p">();</span>
   <span class="p">}</span>
   <span class="nx">m_EpL</span><span class="p">.</span><span class="nx">turnDisplayOn</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">pars</span><span class="o">=</span><span class="p">{})</span> <span class="p">{</span>
      <span class="nx">m_EpL</span><span class="p">.</span><span class="nx">angularAxis_2d_m</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">angularAxis_2d_m</span><span class="p">,</span> <span class="nx">m_EpL</span><span class="p">.</span><span class="nx">angularAxis_2d_m</span><span class="p">);</span>
      
      <span class="c1">// If the EpL axis is not visible on the current canvas, move it into view.</span>
      <span class="kd">let</span> <span class="nx">inCanvas</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">pointInCanvas</span><span class="p">(</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">get_hostCanvasWH</span><span class="p">(),</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">screenFromWorld</span><span class="p">(</span> <span class="nx">m_EpL</span><span class="p">.</span><span class="nx">angularAxis_2d_m</span><span class="p">))</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">inCanvas</span><span class="p">)</span> <span class="nx">m_EpL</span><span class="p">.</span><span class="nx">angularAxis_2d_m</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mf">1.75</span><span class="p">,</span><span class="mf">1.75</span><span class="p">);</span>
      
      <span class="nx">m_EpL</span><span class="p">.</span><span class="nx">displayReport</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">m_EpL</span><span class="p">.</span><span class="nx">pinName</span><span class="p">)</span> <span class="p">{</span> 
         <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">pinMap</span><span class="p">[</span> <span class="nx">m_EpL</span><span class="p">.</span><span class="nx">pinName</span><span class="p">].</span><span class="nx">setPosition</span><span class="p">(</span> <span class="nx">m_EpL</span><span class="p">.</span><span class="nx">angularAxis_2d_m</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">editor</span><span class="p">.</span><span class="nx">checked</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">m_EpL</span><span class="p">.</span><span class="nx">createEditPin</span><span class="p">(</span> <span class="nx">m_EpL</span><span class="p">.</span><span class="nx">angularAxis_2d_m</span><span class="p">);</span>
      <span class="p">}</span> 
   <span class="p">}</span>
   <span class="nx">m_EpL</span><span class="p">.</span><span class="nx">createEditPin</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">pars</span><span class="o">=</span><span class="p">{})</span> <span class="p">{</span>
      <span class="nx">m_EpL</span><span class="p">.</span><span class="nx">pinName</span> <span class="o">=</span> <span class="s1">&#39;L-axis&#39;</span><span class="p">;</span>
      <span class="k">new</span> <span class="nx">Pin</span><span class="p">(</span> <span class="nx">m_EpL</span><span class="p">.</span><span class="nx">angularAxis_2d_m</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;visible&#39;</span><span class="o">:</span><span class="kc">false</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="o">:</span><span class="nx">m_EpL</span><span class="p">.</span><span class="nx">pinName</span><span class="p">});</span>
   <span class="p">}</span>
   <span class="nx">m_EpL</span><span class="p">.</span><span class="nx">deleteEditPin</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">pars</span><span class="o">=</span><span class="p">{})</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">thisPin</span> <span class="o">=</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">pinMap</span><span class="p">[</span> <span class="nx">m_EpL</span><span class="p">.</span><span class="nx">pinName</span><span class="p">];</span>
      <span class="nx">thisPin</span><span class="p">.</span><span class="nx">deleteThisOne</span><span class="p">({</span><span class="s1">&#39;deleteMode&#39;</span><span class="o">:</span><span class="s1">&#39;fromEpL&#39;</span><span class="p">});</span>
      <span class="nx">m_EpL</span><span class="p">.</span><span class="nx">pinName</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="nx">m_EpL</span><span class="p">.</span><span class="nx">updateAxisPosition</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">pars</span><span class="o">=</span><span class="p">{})</span> <span class="p">{</span>
      <span class="nx">m_EpL</span><span class="p">.</span><span class="nx">angularAxis_2d_m</span> <span class="o">=</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">pinMap</span><span class="p">[</span> <span class="nx">m_EpL</span><span class="p">.</span><span class="nx">pinName</span><span class="p">].</span><span class="nx">position_2d_m</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="nx">m_EpL</span><span class="p">.</span><span class="nx">generateReport</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">editor</span><span class="p">.</span><span class="nx">checked</span> <span class="o">&amp;&amp;</span> <span class="nx">m_EpL</span><span class="p">.</span><span class="nx">pinName</span><span class="p">)</span> <span class="nx">m_EpL</span><span class="p">.</span><span class="nx">updateAxisPosition</span><span class="p">();</span>
      <span class="nx">m_EpL</span><span class="p">.</span><span class="nx">reportString</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="nx">m_EpL</span><span class="p">.</span><span class="nx">reportType</span> <span class="o">==</span> <span class="s2">&quot;EpL&quot;</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">let</span> <span class="nx">l_total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l_total_spin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l_total_orbital</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
         <span class="kd">let</span> <span class="nx">ke_total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">ke_total_rotational</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">ke_total_translational</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
         <span class="kd">let</span> <span class="nx">pe_total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
         <span class="kd">let</span> <span class="nx">e_total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">pe</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
         <span class="kd">let</span> <span class="nx">p_total_2d</span><span class="p">,</span> <span class="nx">p_total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">px_total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">px</span><span class="p">,</span> <span class="nx">py_total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">py</span><span class="p">;</span>
         
         <span class="nx">Puck</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span> <span class="nx">puck</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="kd">let</span> <span class="nx">l_orbital</span> <span class="o">=</span> <span class="nx">puck</span><span class="p">.</span><span class="nx">angularMomentum_Orbital</span><span class="p">();</span>
            <span class="kd">let</span> <span class="nx">l_spin</span> <span class="o">=</span> <span class="nx">puck</span><span class="p">.</span><span class="nx">angularMomentum_Spin</span><span class="p">();</span>
            <span class="nx">l_total_spin</span> <span class="o">+=</span> <span class="nx">l_spin</span><span class="p">;</span>
            <span class="nx">l_total_orbital</span> <span class="o">+=</span> <span class="nx">l_orbital</span><span class="p">;</span>
            <span class="nx">l_total</span> <span class="o">=</span> <span class="nx">l_total_orbital</span> <span class="o">+</span> <span class="nx">l_total_spin</span><span class="p">;</span>
            
            <span class="kd">let</span> <span class="nx">ke_translational</span> <span class="o">=</span> <span class="nx">puck</span><span class="p">.</span><span class="nx">energyKinetic_translational</span><span class="p">();</span>
            <span class="kd">let</span> <span class="nx">ke_rotational</span> <span class="o">=</span> <span class="nx">puck</span><span class="p">.</span><span class="nx">energyKinetic_rotational</span><span class="p">();</span>
            <span class="nx">ke_total_rotational</span> <span class="o">+=</span> <span class="nx">ke_rotational</span><span class="p">;</span> 
            <span class="nx">ke_total_translational</span> <span class="o">+=</span> <span class="nx">ke_translational</span><span class="p">;</span>
            <span class="nx">ke_total</span> <span class="o">=</span> <span class="nx">ke_total_translational</span> <span class="o">+</span> <span class="nx">ke_total_rotational</span><span class="p">;</span>
            
            <span class="nx">pe</span> <span class="o">=</span> <span class="nx">puck</span><span class="p">.</span><span class="nx">potentialEnergy</span><span class="p">();</span>
            <span class="nx">pe_total</span> <span class="o">+=</span> <span class="nx">pe</span><span class="p">;</span>
            
            <span class="nx">px</span> <span class="o">=</span> <span class="nx">puck</span><span class="p">.</span><span class="nx">mass_kg</span> <span class="o">*</span> <span class="nx">puck</span><span class="p">.</span><span class="nx">velocity_2d_mps</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
            <span class="nx">py</span> <span class="o">=</span> <span class="nx">puck</span><span class="p">.</span><span class="nx">mass_kg</span> <span class="o">*</span> <span class="nx">puck</span><span class="p">.</span><span class="nx">velocity_2d_mps</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
            <span class="nx">px_total</span> <span class="o">+=</span> <span class="nx">px</span><span class="p">;</span>
            <span class="nx">py_total</span> <span class="o">+=</span> <span class="nx">py</span><span class="p">;</span>
            <span class="nx">p_total_2d</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span> <span class="nx">px_total</span><span class="p">,</span> <span class="nx">py_total</span><span class="p">);</span>
            <span class="nx">p_total</span> <span class="o">=</span> <span class="nx">p_total_2d</span><span class="p">.</span><span class="nx">length</span><span class="p">();</span>
            
            <span class="kd">let</span> <span class="nx">shortPuckName</span> <span class="o">=</span> <span class="nx">puck</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;puck&#39;</span><span class="p">,</span><span class="s1">&#39;p&#39;</span><span class="p">);</span>
            
            <span class="nx">m_EpL</span><span class="p">.</span><span class="nx">reportString</span> <span class="o">+=</span> <span class="nx">shortPuckName</span><span class="p">.</span><span class="nx">padStart</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">fixed</span><span class="p">(</span> <span class="nx">pe</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
                                                              <span class="s2">&quot;&quot;</span>  <span class="o">+</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">fixed</span><span class="p">(</span> <span class="nx">ke_translational</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span> <span class="o">+</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">fixed</span><span class="p">(</span> <span class="nx">ke_rotational</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> 
                                                              <span class="s2">&quot;&quot;</span>  <span class="o">+</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">fixed</span><span class="p">(</span> <span class="nx">l_orbital</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span>      <span class="o">+</span> <span class="s2">&quot;&quot;</span> <span class="o">+</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">fixed</span><span class="p">(</span> <span class="nx">l_spin</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> 
                                                              <span class="s2">&quot;&quot;</span>  <span class="o">+</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">fixed</span><span class="p">(</span> <span class="nx">px</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span>             <span class="o">+</span> <span class="s2">&quot;&quot;</span> <span class="o">+</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">fixed</span><span class="p">(</span> <span class="nx">py</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;\\&quot;</span><span class="p">;</span>
         <span class="p">});</span>
         
         <span class="nx">Spring</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span> <span class="nx">spring</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">spring</span><span class="p">.</span><span class="nx">cursorOnWallorPin</span><span class="p">())</span> <span class="p">{</span>
               <span class="nx">pe</span> <span class="o">=</span> <span class="nx">spring</span><span class="p">.</span><span class="nx">potentialEnergy</span><span class="p">();</span>
               <span class="kd">let</span> <span class="nx">shortSpringName</span> <span class="o">=</span> <span class="p">(</span><span class="nx">spring</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span><span class="p">)</span> <span class="o">?</span> <span class="s2">&quot;sH&quot;</span> <span class="o">:</span> <span class="nx">spring</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
               <span class="nx">m_EpL</span><span class="p">.</span><span class="nx">reportString</span> <span class="o">+=</span> <span class="nx">shortSpringName</span><span class="p">.</span><span class="nx">padStart</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">fixed</span><span class="p">(</span> <span class="nx">pe</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;\\&quot;</span><span class="p">;</span>
               <span class="nx">pe_total</span> <span class="o">+=</span> <span class="nx">pe</span><span class="p">;</span>
            <span class="p">}</span>
         <span class="p">});</span>
         
         <span class="nx">e_total</span> <span class="o">=</span> <span class="nx">ke_total</span> <span class="o">+</span> <span class="nx">pe_total</span><span class="p">;</span>
         <span class="kd">let</span> <span class="nx">totalsString</span> <span class="o">=</span> <span class="s2">&quot;                                 &quot;</span> <span class="o">+</span> <span class="s2">&quot;\\&quot;</span> <span class="o">+</span>
                        <span class="s2">&quot;[base,cyan] AGG &quot;</span>   <span class="o">+</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">fixed</span><span class="p">(</span> <span class="nx">e_total</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>   <span class="o">+</span> <span class="s2">&quot;[base]&lt;-----------E-&quot;</span> <span class="o">+</span> 
                        <span class="s2">&quot;[base,cyan]&quot;</span>        <span class="o">+</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">fixed</span><span class="p">(</span> <span class="nx">l_total</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;[base]&lt;----L-&quot;</span> <span class="o">+</span>  
                        <span class="s2">&quot;[base,cyan]&quot;</span>        <span class="o">+</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">fixed</span><span class="p">(</span> <span class="nx">p_total</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;[base]&lt;----p-\\&quot;</span> <span class="o">+</span>
                        <span class="s2">&quot;          PE    KEt    KEr      Lo     Lr      px     py \\&quot;</span> <span class="o">+</span>
                        <span class="s2">&quot;[base,cyan] TOT &quot;</span> <span class="o">+</span>   <span class="nx">uT</span><span class="p">.</span><span class="nx">fixed</span><span class="p">(</span> <span class="nx">pe_total</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span> <span class="o">+</span>
                                               <span class="nx">uT</span><span class="p">.</span><span class="nx">fixed</span><span class="p">(</span> <span class="nx">ke_total_translational</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span> <span class="o">+</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">fixed</span><span class="p">(</span> <span class="nx">ke_total_rotational</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span> <span class="o">+</span>
                                               <span class="nx">uT</span><span class="p">.</span><span class="nx">fixed</span><span class="p">(</span> <span class="nx">l_total_orbital</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span>      <span class="o">+</span> <span class="s2">&quot;&quot;</span> <span class="o">+</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">fixed</span><span class="p">(</span> <span class="nx">l_total_spin</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span> <span class="o">+</span>
                                               <span class="nx">uT</span><span class="p">.</span><span class="nx">fixed</span><span class="p">(</span> <span class="nx">px_total</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span>             <span class="o">+</span> <span class="s2">&quot;&quot;</span> <span class="o">+</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">fixed</span><span class="p">(</span> <span class="nx">py_total</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;[base]\\&quot;</span><span class="p">;</span>
         
         <span class="nx">m_EpL</span><span class="p">.</span><span class="nx">reportString</span> <span class="o">=</span> <span class="nx">totalsString</span> <span class="o">+</span> <span class="nx">m_EpL</span><span class="p">.</span><span class="nx">reportString</span><span class="p">;</span>
      
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">m_EpL</span><span class="p">.</span><span class="nx">reportType</span> <span class="o">==</span> <span class="s2">&quot;speed&quot;</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">let</span> <span class="nx">orbit_result</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nx">orbit_title</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nx">orbit_radius_m</span><span class="p">,</span> <span class="nx">puckRows</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nx">springRows</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
         
         <span class="c1">// Before displaying the orbit data, check to see if the current demo (or a capture there of) is in this list.</span>
         <span class="kd">let</span> <span class="nx">demoHasOrbits</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">oneOfThese</span><span class="p">([</span><span class="s1">&#39;4.b&#39;</span><span class="p">,</span><span class="s1">&#39;5.b&#39;</span><span class="p">,</span><span class="s1">&#39;5.b.two&#39;</span><span class="p">,</span><span class="s1">&#39;5.a.orbitingOnSpring&#39;</span><span class="p">],</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoVersion</span><span class="p">());</span>
         <span class="kd">let</span> <span class="nx">stillHasSpring</span> <span class="o">=</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">springMap</span><span class="p">).</span><span class="nx">length</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">);</span>
         
         <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">puckMap</span><span class="p">).</span><span class="nx">length</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">Puck</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span> <span class="nx">puck</span> <span class="p">=&gt;</span> <span class="p">{</span>
               <span class="kd">let</span> <span class="nx">shortPuckName</span> <span class="o">=</span> <span class="nx">puck</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;puck&#39;</span><span class="p">,</span><span class="s1">&#39;p&#39;</span><span class="p">);</span>
               <span class="kd">let</span> <span class="nx">puckSpeed_mps</span> <span class="o">=</span> <span class="nx">puck</span><span class="p">.</span><span class="nx">velocity_2d_mps</span><span class="p">.</span><span class="nx">length</span><span class="p">();</span>
               
               <span class="c1">// For demos with pucks orbiting on springs, include columns for orbit radius and angular speed.</span>
               <span class="k">if</span> <span class="p">(</span><span class="nx">demoHasOrbits</span> <span class="o">&amp;&amp;</span> <span class="nx">stillHasSpring</span><span class="p">)</span> <span class="p">{</span>
                  <span class="kd">let</span> <span class="nx">orbit_radius_2d_m</span> <span class="o">=</span> <span class="nx">puck</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span> <span class="nx">Puck</span><span class="p">.</span><span class="nx">findCenterOfMass</span><span class="p">());</span>
                  <span class="nx">orbit_radius_m</span> <span class="o">=</span> <span class="nx">orbit_radius_2d_m</span><span class="p">.</span><span class="nx">length</span><span class="p">();</span>
                  <span class="c1">// This cross product is negative if the motion is clockwise.</span>
                  <span class="kd">let</span> <span class="nx">rCrossV</span> <span class="o">=</span> <span class="nx">orbit_radius_2d_m</span><span class="p">.</span><span class="nx">cross</span><span class="p">(</span> <span class="nx">puck</span><span class="p">.</span><span class="nx">velocity_2d_mps</span><span class="p">);</span>
                  <span class="kd">let</span> <span class="nx">orbit_tangentialSpeed_mps</span> <span class="o">=</span> <span class="nx">rCrossV</span> <span class="o">/</span> <span class="nx">orbit_radius_m</span><span class="p">;</span>
                  <span class="kd">let</span> <span class="nx">orbit_angularSpeed_rps</span> <span class="o">=</span> <span class="nx">orbit_tangentialSpeed_mps</span> <span class="o">/</span> <span class="nx">orbit_radius_m</span><span class="p">;</span>
                  
                  <span class="nx">orbit_result</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">fixed</span><span class="p">(</span> <span class="nx">orbit_radius_m</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span> <span class="o">+</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">fixed</span><span class="p">(</span> <span class="nx">orbit_angularSpeed_rps</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
                  <span class="nx">orbit_title</span> <span class="o">=</span> <span class="s2">&quot;    Ro      &quot;</span> <span class="o">+</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="mi">937</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="p">;</span>
               <span class="p">}</span>
               
               <span class="nx">puckRows</span> <span class="o">+=</span> <span class="nx">shortPuckName</span><span class="p">.</span><span class="nx">padStart</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">fixed</span><span class="p">(</span> <span class="nx">puckSpeed_mps</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span> <span class="o">+</span> <span class="nx">orbit_result</span> <span class="o">+</span> 
                                     <span class="s2">&quot;&quot;</span> <span class="o">+</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">fixed</span><span class="p">(</span> <span class="nx">puck</span><span class="p">.</span><span class="nx">angularSpeed_rps</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;\\&quot;</span><span class="p">;</span>
            <span class="p">});</span>
            
            <span class="kd">let</span> <span class="nx">puckHeader</span> <span class="o">=</span> <span class="s2">&quot;\\ \\ \\          St &quot;</span> <span class="o">+</span> <span class="nx">orbit_title</span> <span class="o">+</span> <span class="s2">&quot;     &quot;</span> <span class="o">+</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="mi">969</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;  \\&quot;</span><span class="p">;</span>
            
            <span class="nx">m_EpL</span><span class="p">.</span><span class="nx">reportString</span> <span class="o">=</span> <span class="nx">puckHeader</span> <span class="o">+</span> <span class="nx">puckRows</span><span class="p">;</span>
         <span class="p">}</span>
         
         <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">springMap</span><span class="p">).</span><span class="nx">length</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">let</span> <span class="nx">springHeader</span> <span class="o">=</span> <span class="s2">&quot;\\           x     &quot;</span> <span class="o">+</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="mi">916</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;x   x+&quot;</span><span class="o">+</span><span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="mi">916</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;x\\&quot;</span><span class="p">;</span>
            <span class="nx">Spring</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span> <span class="nx">spring</span> <span class="p">=&gt;</span> <span class="p">{</span>
               <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">spring</span><span class="p">.</span><span class="nx">cursorOnWallorPin</span><span class="p">())</span> <span class="p">{</span>
                  <span class="kd">let</span> <span class="nx">stretch_m</span> <span class="o">=</span> <span class="p">(</span><span class="nx">spring</span><span class="p">.</span><span class="nx">forCursor</span> <span class="o">&amp;&amp;</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span> <span class="nx">spring</span><span class="p">.</span><span class="nx">name</span><span class="p">].</span><span class="nx">poolShotLocked</span><span class="p">)</span> <span class="o">?</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span> <span class="nx">spring</span><span class="p">.</span><span class="nx">name</span><span class="p">].</span><span class="nx">poolShotLockedSpringStretch_m</span> <span class="o">:</span> <span class="nx">spring</span><span class="p">.</span><span class="nx">stretch_m</span><span class="p">;</span>
                  <span class="kd">let</span> <span class="nx">totalLength_m</span> <span class="o">=</span> <span class="nx">spring</span><span class="p">.</span><span class="nx">length_m</span> <span class="o">+</span> <span class="nx">stretch_m</span><span class="p">;</span>
                  <span class="kd">let</span> <span class="nx">shortSpringName</span> <span class="o">=</span> <span class="p">(</span><span class="nx">spring</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span><span class="p">)</span> <span class="o">?</span> <span class="s2">&quot;sH&quot;</span> <span class="o">:</span> <span class="nx">spring</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
                  <span class="nx">springRows</span> <span class="o">+=</span> <span class="nx">shortSpringName</span><span class="p">.</span><span class="nx">padStart</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">fixed</span><span class="p">(</span> <span class="nx">spring</span><span class="p">.</span><span class="nx">length_m</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> 
                                        <span class="s2">&quot;&quot;</span> <span class="o">+</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">fixed</span><span class="p">(</span> <span class="nx">stretch_m</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span> <span class="o">+</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">fixed</span><span class="p">(</span> <span class="nx">totalLength_m</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;\\&quot;</span><span class="p">;</span>
               <span class="p">}</span>
            <span class="p">});</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">springRows</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="nx">m_EpL</span><span class="p">.</span><span class="nx">reportString</span> <span class="o">+=</span> <span class="nx">springHeader</span> <span class="o">+</span> <span class="nx">springRows</span><span class="p">;</span>
         <span class="p">}</span>
         
         <span class="k">if</span> <span class="p">((</span><span class="nx">puckRows</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">springRows</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">))</span> <span class="nx">m_EpL</span><span class="p">.</span><span class="nx">reportString</span> <span class="o">+=</span> <span class="s2">&quot;\\ Speed report empty: no pucks, no springs.&quot;</span><span class="p">;</span>
      <span class="p">}</span>
      
      <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;EpLreport&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span> <span class="nx">m_EpL</span><span class="p">.</span><span class="nx">reportString</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">);</span>
   <span class="p">}</span>
   
   
   
   <span class="c1">///////////////////////////////////////////////////////////////////////////</span>
   <span class="c1">// Miscellaneous functions</span>
   <span class="c1">///////////////////////////////////////////////////////////////////////////</span>
   
   <span class="kd">function</span> <span class="nx">adjustAttachments</span><span class="p">(</span> <span class="nx">puckOrWall</span><span class="p">,</span> <span class="nx">width_factor</span><span class="p">,</span> <span class="nx">height_factor</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// As the puck (or wall) is resized, adjust attachment points, and multiselect points.</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">puckOrWall</span><span class="p">.</span><span class="nx">inMultiSelect</span><span class="p">())</span> <span class="p">{</span>
         <span class="nx">puckOrWall</span><span class="p">.</span><span class="nx">selectionPoint_l_2d_m</span><span class="p">.</span><span class="nx">x</span> <span class="o">*=</span> <span class="nx">width_factor</span><span class="p">;</span>
         <span class="nx">puckOrWall</span><span class="p">.</span><span class="nx">selectionPoint_l_2d_m</span><span class="p">.</span><span class="nx">y</span> <span class="o">*=</span> <span class="nx">height_factor</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">Spring</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span> <span class="nx">spring</span> <span class="p">=&gt;</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">((</span><span class="nx">puckOrWall</span> <span class="o">==</span> <span class="nx">spring</span><span class="p">.</span><span class="nx">spo1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">puckOrWall</span> <span class="o">==</span> <span class="nx">spring</span><span class="p">.</span><span class="nx">spo2</span><span class="p">))</span> <span class="p">{</span>
            <span class="c1">// Adjust the attachment points similar to the puck (or wall) size adjustments.</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">puckOrWall</span> <span class="o">==</span> <span class="nx">spring</span><span class="p">.</span><span class="nx">spo1</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">spring</span><span class="p">.</span><span class="nx">spo1_ap_l_2d_m</span><span class="p">.</span><span class="nx">x</span> <span class="o">*=</span> <span class="nx">width_factor</span><span class="p">;</span>
               <span class="nx">spring</span><span class="p">.</span><span class="nx">spo1_ap_l_2d_m</span><span class="p">.</span><span class="nx">y</span> <span class="o">*=</span> <span class="nx">height_factor</span><span class="p">;</span>
            <span class="p">}</span> 
            <span class="k">if</span> <span class="p">(</span><span class="nx">puckOrWall</span> <span class="o">==</span> <span class="nx">spring</span><span class="p">.</span><span class="nx">spo2</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">spring</span><span class="p">.</span><span class="nx">spo2_ap_l_2d_m</span><span class="p">.</span><span class="nx">x</span> <span class="o">*=</span> <span class="nx">width_factor</span><span class="p">;</span>
               <span class="nx">spring</span><span class="p">.</span><span class="nx">spo2_ap_l_2d_m</span><span class="p">.</span><span class="nx">y</span> <span class="o">*=</span> <span class="nx">height_factor</span><span class="p">;</span>
            <span class="p">}</span> 
            <span class="c1">// If there&#39;s a spring that has one (or both) of its ends attached to this puckOrWall (and the puckOrWall is a puck),</span>
            <span class="c1">// and it&#39;s a b2d spring (a distance joint), update that b2d spring because the nature of these b2d springs</span>
            <span class="c1">// depends on the mass of the pucks they are attached to.</span>
            <span class="k">if</span> <span class="p">((</span><span class="nx">puckOrWall</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;Puck&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">spring</span><span class="p">.</span><span class="nx">softConstraints</span><span class="p">)</span> <span class="nx">spring</span><span class="p">.</span><span class="nx">updateB2D_spring</span><span class="p">();</span>
         <span class="p">}</span>
      <span class="p">});</span>
      <span class="nx">Joint</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span> <span class="nx">joint</span> <span class="p">=&gt;</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">puckOrWall</span> <span class="o">==</span> <span class="nx">joint</span><span class="p">.</span><span class="nx">jto1</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">joint</span><span class="p">.</span><span class="nx">jto1_ap_l_2d_m</span><span class="p">.</span><span class="nx">x</span> <span class="o">*=</span> <span class="nx">width_factor</span><span class="p">;</span>
            <span class="nx">joint</span><span class="p">.</span><span class="nx">jto1_ap_l_2d_m</span><span class="p">.</span><span class="nx">y</span> <span class="o">*=</span> <span class="nx">height_factor</span><span class="p">;</span>
            
            <span class="nx">joint</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">m_localAnchor1</span><span class="p">.</span><span class="nx">x</span> <span class="o">*=</span> <span class="nx">width_factor</span><span class="p">;</span>            
            <span class="nx">joint</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">m_localAnchor1</span><span class="p">.</span><span class="nx">y</span> <span class="o">*=</span> <span class="nx">height_factor</span><span class="p">;</span>            
         <span class="p">}</span> 
         <span class="k">if</span> <span class="p">(</span><span class="nx">puckOrWall</span> <span class="o">==</span> <span class="nx">joint</span><span class="p">.</span><span class="nx">jto2</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">joint</span><span class="p">.</span><span class="nx">jto2_ap_l_2d_m</span><span class="p">.</span><span class="nx">x</span> <span class="o">*=</span> <span class="nx">width_factor</span><span class="p">;</span>
            <span class="nx">joint</span><span class="p">.</span><span class="nx">jto2_ap_l_2d_m</span><span class="p">.</span><span class="nx">y</span> <span class="o">*=</span> <span class="nx">height_factor</span><span class="p">;</span>
            
            <span class="nx">joint</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">m_localAnchor2</span><span class="p">.</span><span class="nx">x</span> <span class="o">*=</span> <span class="nx">width_factor</span><span class="p">;</span>            
            <span class="nx">joint</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">m_localAnchor2</span><span class="p">.</span><span class="nx">y</span> <span class="o">*=</span> <span class="nx">height_factor</span><span class="p">;</span>            
         <span class="p">}</span> 
      <span class="p">});</span>
   <span class="p">}</span>
   
   <span class="kd">function</span> <span class="nx">assignName</span><span class="p">(</span> <span class="nx">candidate</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">baseName</span><span class="p">,</span> <span class="nx">mapName</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
      <span class="kd">let</span> <span class="nx">nameInUse</span> <span class="o">=</span> <span class="p">(</span><span class="nx">candidate</span> <span class="o">&amp;&amp;</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">[</span> <span class="nx">mapName</span><span class="p">][</span> <span class="nx">candidate</span><span class="p">]);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">candidate</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">nameInUse</span><span class="p">))</span> <span class="p">{</span>
         <span class="nx">name</span> <span class="o">=</span> <span class="nx">candidate</span><span class="p">;</span>
         <span class="c1">// Get the number part of the name</span>
         <span class="kd">var</span> <span class="nx">numberInName</span> <span class="o">=</span> <span class="nx">name</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span> <span class="nx">baseName</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
         <span class="c1">// Don&#39;t change the index if no number in name.</span>
         <span class="k">if</span> <span class="p">(</span><span class="nb">isNaN</span><span class="p">(</span> <span class="nx">numberInName</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">numberInName</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">numberInName</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span> <span class="nx">numberInName</span><span class="p">);</span>
         <span class="p">}</span>
         <span class="nx">index</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">numberInName</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="nx">index</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
         <span class="nx">name</span> <span class="o">=</span> <span class="nx">baseName</span> <span class="o">+</span> <span class="nx">index</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">nameInUse</span><span class="p">)</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s2">&quot;The name &quot;</span> <span class="o">+</span> <span class="nx">candidate</span> <span class="o">+</span> <span class="s2">&quot; is in use. &quot;</span> <span class="o">+</span> <span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot; was assigned.&quot;</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">);</span>
      <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="o">:</span><span class="nx">name</span><span class="p">,</span> <span class="s1">&#39;index&#39;</span><span class="o">:</span><span class="nx">index</span><span class="p">};</span>
   <span class="p">}</span>
   
   
   
   <span class="c1">// Public references to objects, variables, and methods</span>
   
   <span class="k">return</span> <span class="p">{</span>
      <span class="c1">// object prototypes</span>
      <span class="s1">&#39;Puck&#39;</span><span class="o">:</span> <span class="nx">Puck</span><span class="p">,</span>
      <span class="s1">&#39;Joint&#39;</span><span class="o">:</span> <span class="nx">Joint</span><span class="p">,</span>
      <span class="s1">&#39;Spring&#39;</span><span class="o">:</span> <span class="nx">Spring</span><span class="p">,</span>
      <span class="s1">&#39;Wall&#39;</span><span class="o">:</span> <span class="nx">Wall</span><span class="p">,</span>
      <span class="s1">&#39;Pin&#39;</span><span class="o">:</span> <span class="nx">Pin</span><span class="p">,</span>

      <span class="c1">// general object containers</span>
      <span class="s1">&#39;EpL&#39;</span><span class="o">:</span> <span class="nx">m_EpL</span><span class="p">,</span>
      
   <span class="p">};</span>
   
<span class="p">})();</span>
</pre></div>
</body>
</html>
