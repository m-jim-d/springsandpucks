<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">
<!--
generated by Pygments <https://pygments.org/>
Copyright 2006-2024 by the Pygments team.
Licensed under the BSD license, see LICENSE for details.
-->
<html>
<head>
  <link rel='canonical' href='https://triquence.org/puckPopper.js.html' />
  <title>puckPopper.js</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <style type="text/css">
/*
generated by Pygments <https://pygments.org/>
Copyright 2006-2024 by the Pygments team.
Licensed under the BSD license, see LICENSE for details.
*/
pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
body .hll { background-color: #ffffcc }
body { background: #f8f8f8; }
body .c { color: #3D7B7B; font-style: italic } /* Comment */
body .err { border: 1px solid #FF0000 } /* Error */
body .k { color: #008000; font-weight: bold } /* Keyword */
body .o { color: #666666 } /* Operator */
body .ch { color: #3D7B7B; font-style: italic } /* Comment.Hashbang */
body .cm { color: #3D7B7B; font-style: italic } /* Comment.Multiline */
body .cp { color: #9C6500 } /* Comment.Preproc */
body .cpf { color: #3D7B7B; font-style: italic } /* Comment.PreprocFile */
body .c1 { color: #3D7B7B; font-style: italic } /* Comment.Single */
body .cs { color: #3D7B7B; font-style: italic } /* Comment.Special */
body .gd { color: #A00000 } /* Generic.Deleted */
body .ge { font-style: italic } /* Generic.Emph */
body .ges { font-weight: bold; font-style: italic } /* Generic.EmphStrong */
body .gr { color: #E40000 } /* Generic.Error */
body .gh { color: #000080; font-weight: bold } /* Generic.Heading */
body .gi { color: #008400 } /* Generic.Inserted */
body .go { color: #717171 } /* Generic.Output */
body .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
body .gs { font-weight: bold } /* Generic.Strong */
body .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
body .gt { color: #0044DD } /* Generic.Traceback */
body .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
body .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
body .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
body .kp { color: #008000 } /* Keyword.Pseudo */
body .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
body .kt { color: #B00040 } /* Keyword.Type */
body .m { color: #666666 } /* Literal.Number */
body .s { color: #BA2121 } /* Literal.String */
body .na { color: #687822 } /* Name.Attribute */
body .nb { color: #008000 } /* Name.Builtin */
body .nc { color: #0000FF; font-weight: bold } /* Name.Class */
body .no { color: #880000 } /* Name.Constant */
body .nd { color: #AA22FF } /* Name.Decorator */
body .ni { color: #717171; font-weight: bold } /* Name.Entity */
body .ne { color: #CB3F38; font-weight: bold } /* Name.Exception */
body .nf { color: #0000FF } /* Name.Function */
body .nl { color: #767600 } /* Name.Label */
body .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
body .nt { color: #008000; font-weight: bold } /* Name.Tag */
body .nv { color: #19177C } /* Name.Variable */
body .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
body .w { color: #bbbbbb } /* Text.Whitespace */
body .mb { color: #666666 } /* Literal.Number.Bin */
body .mf { color: #666666 } /* Literal.Number.Float */
body .mh { color: #666666 } /* Literal.Number.Hex */
body .mi { color: #666666 } /* Literal.Number.Integer */
body .mo { color: #666666 } /* Literal.Number.Oct */
body .sa { color: #BA2121 } /* Literal.String.Affix */
body .sb { color: #BA2121 } /* Literal.String.Backtick */
body .sc { color: #BA2121 } /* Literal.String.Char */
body .dl { color: #BA2121 } /* Literal.String.Delimiter */
body .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
body .s2 { color: #BA2121 } /* Literal.String.Double */
body .se { color: #AA5D1F; font-weight: bold } /* Literal.String.Escape */
body .sh { color: #BA2121 } /* Literal.String.Heredoc */
body .si { color: #A45A77; font-weight: bold } /* Literal.String.Interpol */
body .sx { color: #008000 } /* Literal.String.Other */
body .sr { color: #A45A77 } /* Literal.String.Regex */
body .s1 { color: #BA2121 } /* Literal.String.Single */
body .ss { color: #19177C } /* Literal.String.Symbol */
body .bp { color: #008000 } /* Name.Builtin.Pseudo */
body .fm { color: #0000FF } /* Name.Function.Magic */
body .vc { color: #19177C } /* Name.Variable.Class */
body .vg { color: #19177C } /* Name.Variable.Global */
body .vi { color: #19177C } /* Name.Variable.Instance */
body .vm { color: #19177C } /* Name.Variable.Magic */
body .il { color: #666666 } /* Literal.Number.Integer.Long */

  </style>
</head>
<body>
<h2></h2>

<div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm">Copyright 2022 James D. Miller</span>

<span class="cm">Permission is hereby granted, free of charge, to any person obtaining a copy</span>
<span class="cm">of this software and associated documentation files (the &quot;Software&quot;), to deal</span>
<span class="cm">in the Software without restriction, including without limitation the rights</span>
<span class="cm">to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
<span class="cm">copies of the Software, and to permit persons to whom the Software is</span>
<span class="cm">furnished to do so, subject to the following conditions:</span>

<span class="cm">The above copyright notice and this permission notice shall be included in all</span>
<span class="cm">copies or substantial portions of the Software.</span>

<span class="cm">THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="cm">IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="cm">FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
<span class="cm">AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<span class="cm">LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span>
<span class="cm">OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="cm">SOFTWARE.</span>
<span class="cm">*/</span>

<span class="c1">// Puck Popper (pP) module</span>
<span class="c1">// puckPopper.js</span>
<span class="w">   </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;pP _*-*_&#39;</span><span class="p">);</span>
<span class="c1">// 8:55 PM Fri April 29, 2022</span>

<span class="cm">/*</span>
<span class="cm">gwModule.js has an alphabetical list of all modules and their nicknames as added to the windows namespace.</span>
<span class="cm">*/</span>

<span class="nb">window</span><span class="p">.</span><span class="nx">pP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="s2">&quot;use strict&quot;</span><span class="p">;</span>
<span class="w">   </span>
<span class="w">   </span><span class="c1">// Names starting with m_ indicate module-scope globals.</span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">m_playerCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">m_teams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">m_teamCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">m_pucksByTypeAtStart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;human&#39;</span><span class="o">:</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;drone&#39;</span><span class="o">:</span><span class="mf">0</span><span class="p">};</span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">m_npcCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">m_territoryMarked</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">m_puckPopperTimer_s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">m_npcSleep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">m_npcSleepUsage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">m_clientPucksAtGameStart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">m_bulletAgeLimit_ms</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1000</span><span class="p">;</span>
<span class="w">   </span>
<span class="w">   </span><span class="c1">// module globals for objects brought in by initializeModule</span>
<span class="w">   </span><span class="c1">// (none)</span>
<span class="w">   </span>
<span class="w">   </span><span class="c1">///////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span class="w">   </span><span class="c1">///////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">initializeModule</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">activeTTclient</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">activeTTclient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">      </span><span class="nx">cT</span><span class="p">.</span><span class="nx">Client</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">twoThumbsEnabled</span><span class="p">)</span><span class="w"> </span><span class="nx">activeTTclient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">activeTTclient</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">countPucksByType</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// The number of pucks by type.</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">pucksHuman</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">pucksDrone</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">      </span><span class="nx">cT</span><span class="p">.</span><span class="nx">Client</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">puck</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;u&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;local&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">pucksHuman</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">pucksDrone</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;human&#39;</span><span class="o">:</span><span class="nx">pucksHuman</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;drone&#39;</span><span class="o">:</span><span class="nx">pucksDrone</span><span class="p">};</span>
<span class="w">   </span><span class="p">}</span><span class="w">   </span>
<span class="w">      </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">preGameSetUp</span><span class="p">(</span><span class="w"> </span><span class="nx">index</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">m_npcSleep</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">m_pucksByTypeAtStart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">countPucksByType</span><span class="p">();</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">m_pucksByTypeAtStart</span><span class="p">.</span><span class="nx">human</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Looks like someone is ready to play. Label this as a game.</span>
<span class="w">            </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;gameTitle&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s2">&quot;Puck \\Popper&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">);</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">         </span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">index</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">7</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">            </span><span class="c1">// abbreviated help for cannibal in springy chain.</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">([</span><span class="s2">&quot;7.e&quot;</span><span class="p">].</span><span class="nx">includes</span><span class="p">(</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoVersion</span><span class="p">().</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">3</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s2">&quot;shoot (i, j,l, k)&quot;</span><span class="w"> </span><span class="o">+</span><span class="w">   </span>
<span class="w">                                            </span><span class="s2">&quot;\\jet (w, a,d, s)&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">3.0</span><span class="p">);</span>
<span class="w">         </span>
<span class="w">            </span><span class="c1">// If no network clients, assume a beginner is learning the game and provide some help.</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">activeTTclient</span><span class="p">())</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">puck</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessageSeries</span><span class="p">({</span>
<span class="w">                  </span><span class="mf">1</span><span class="o">:</span><span class="p">{</span><span class="s1">&#39;tL_s&#39;</span><span class="o">:</span><span class="mf">2.0</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;message&#39;</span><span class="o">:</span><span class="s2">&quot;Pop the other pucks...&quot;</span><span class="p">},</span>
<span class="w">                  </span><span class="mf">2</span><span class="o">:</span><span class="p">{</span><span class="s1">&#39;tL_s&#39;</span><span class="o">:</span><span class="mf">2.0</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;message&#39;</span><span class="o">:</span><span class="s2">&quot;Use your keyboard to move and shoot...&quot;</span><span class="p">},</span>
<span class="w">                  </span><span class="mf">3</span><span class="o">:</span><span class="p">{</span><span class="s1">&#39;tL_s&#39;</span><span class="o">:</span><span class="mf">5.0</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;message&#39;</span><span class="o">:</span><span class="s2">&quot;move (w, a,d, s)\\  shoot (i, j,l, k)\\    shield (spacebar)\\      find you (?)...&quot;</span><span class="p">},</span>
<span class="w">                  </span><span class="mf">4</span><span class="o">:</span><span class="p">{</span><span class="s1">&#39;tL_s&#39;</span><span class="o">:</span><span class="mf">3.0</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;message&#39;</span><span class="o">:</span><span class="s2">&quot;Place your middle fingers \\  on the \&quot;w\&quot; and \&quot;i\&quot; keys.&quot;</span><span class="p">}</span>
<span class="w">               </span><span class="p">});</span>
<span class="w">               </span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">index</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">8</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">activeTTclient</span><span class="p">())</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">puck</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s2">&quot;move (w, a,d, s)   shoot (i, j,l, k)   shield (spacebar)   find you (?)&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">3.0</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s2">&quot;Drones are [base,yellow]sleeping[base]. Ctrl-Q to wake them.&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">1.5</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="cm">/*</span>
<span class="cm">   Almost all of the NPC (non playing character) code is in this module. There are a few blocks of NPC related code in the Pin methods, copyThisOne, and deleteThisOne.</span>
<span class="cm">   The context there is useful to see what those blocks are doing (so I left them there...).</span>
<span class="cm">   */</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">attachNavSpring</span><span class="p">(</span><span class="w"> </span><span class="nx">puck</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">navSpringName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;s&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="mf">100</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">cP</span><span class="p">.</span><span class="nx">Puck</span><span class="p">.</span><span class="nx">nameIndex</span><span class="p">);</span>
<span class="w">      </span><span class="c1">// Note that instantiation adds the new spring to the spring map.</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">cP</span><span class="p">.</span><span class="nx">Spring</span><span class="p">(</span><span class="w"> </span><span class="nx">puck</span><span class="p">,</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">pinMap</span><span class="p">[</span><span class="w"> </span><span class="nx">puck</span><span class="p">.</span><span class="nx">pinName</span><span class="p">],</span><span class="w"> </span><span class="p">{</span><span class="nx">strength_Npm</span><span class="o">:</span><span class="mf">8.0</span><span class="p">,</span><span class="w"> </span><span class="nx">unstretched_width_m</span><span class="o">:</span><span class="mf">0.1</span><span class="p">,</span><span class="w"> </span><span class="nx">color</span><span class="o">:</span><span class="s1">&#39;brown&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">damper_Ns2pm2</span><span class="o">:</span><span class="mf">5.0</span><span class="p">,</span><span class="w"> </span><span class="nx">navigationForNPC</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;name&#39;</span><span class="o">:</span><span class="nx">navSpringName</span><span class="p">});</span>
<span class="w">      </span><span class="nx">puck</span><span class="p">.</span><span class="nx">navSpringName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">temp</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">stepTheJetAngle</span><span class="p">(</span><span class="w"> </span><span class="nx">puck</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">spring</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">springMap</span><span class="p">[</span><span class="w"> </span><span class="nx">puck</span><span class="p">.</span><span class="nx">navSpringName</span><span class="p">];</span>
<span class="w">      </span><span class="c1">// If this spring still exists.</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">spring</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="c1">// Use the end of the spring that&#39;s attached to the pin.</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">spring</span><span class="p">.</span><span class="nx">spo1</span><span class="p">.</span><span class="nx">nextPinName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">nextPinName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">spring</span><span class="p">.</span><span class="nx">spo1</span><span class="p">.</span><span class="nx">nextPinName</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">nextPinName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">spring</span><span class="p">.</span><span class="nx">spo2</span><span class="p">.</span><span class="nx">nextPinName</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">         </span><span class="c1">// Gradually rotate jet to be in the direction of the next pin.</span>
<span class="w">         </span><span class="c1">// Vector between this puck and the next pin.</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">toNextPin_2d_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">puck</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">pinMap</span><span class="p">[</span><span class="w"> </span><span class="nx">nextPinName</span><span class="p">].</span><span class="nx">position_2d_m</span><span class="p">);</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">angleOfNextPin_deg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">toNextPin_2d_m</span><span class="p">.</span><span class="nx">get_angle</span><span class="p">();</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">angleOfJet_deg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">puck</span><span class="p">.</span><span class="nx">jet</span><span class="p">.</span><span class="nx">rel_position_2d_m</span><span class="p">.</span><span class="nx">get_angle</span><span class="p">();</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">changeNeeded_deg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">angleOfNextPin_deg</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">angleOfJet_deg</span><span class="p">;</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// Take the short way around.</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">changeNeeded_deg</span><span class="w"> </span><span class="o">&gt;</span><span class="w">  </span><span class="mf">180.0</span><span class="p">)</span><span class="w"> </span><span class="nx">changeNeeded_deg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">changeNeeded_deg</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">360</span><span class="p">;</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">changeNeeded_deg</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="o">-</span><span class="mf">180.0</span><span class="p">)</span><span class="w"> </span><span class="nx">changeNeeded_deg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">changeNeeded_deg</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">360</span><span class="p">;</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// Rotate by a percentage in this single step. This will yield a gradual sweep-to-target effect.</span>
<span class="w">         </span><span class="nx">puck</span><span class="p">.</span><span class="nx">jet</span><span class="p">.</span><span class="nx">rotateTubeAndFlame</span><span class="p">(</span><span class="w"> </span><span class="mf">0.15</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">changeNeeded_deg</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">attachNavSpringToNextPin</span><span class="p">(</span><span class="w"> </span><span class="nx">puck</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">spring</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">springMap</span><span class="p">[</span><span class="w"> </span><span class="nx">puck</span><span class="p">.</span><span class="nx">navSpringName</span><span class="p">];</span>
<span class="w">      </span><span class="c1">// If this spring still exists.</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">spring</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="c1">// Use the end of the spring that&#39;s attached to the pin.</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">spring</span><span class="p">.</span><span class="nx">spo1</span><span class="p">.</span><span class="nx">nextPinName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">nextPinName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">spring</span><span class="p">.</span><span class="nx">spo1</span><span class="p">.</span><span class="nx">nextPinName</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">nextPinName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">spring</span><span class="p">.</span><span class="nx">spo2</span><span class="p">.</span><span class="nx">nextPinName</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// If there&#39;s a pin in the map by that name, attach to it.</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">pinMap</span><span class="p">[</span><span class="w"> </span><span class="nx">nextPinName</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Move the end of the spring that&#39;s attached to the pin.</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">springMap</span><span class="p">[</span><span class="w"> </span><span class="nx">puck</span><span class="p">.</span><span class="nx">navSpringName</span><span class="p">].</span><span class="nx">spo1</span><span class="p">.</span><span class="kr">constructor</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;Pin&quot;</span><span class="p">)</span>
<span class="w">               </span><span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">springMap</span><span class="p">[</span><span class="w"> </span><span class="nx">puck</span><span class="p">.</span><span class="nx">navSpringName</span><span class="p">].</span><span class="nx">spo1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">pinMap</span><span class="p">[</span><span class="w"> </span><span class="nx">nextPinName</span><span class="p">];</span>
<span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">springMap</span><span class="p">[</span><span class="w"> </span><span class="nx">puck</span><span class="p">.</span><span class="nx">navSpringName</span><span class="p">].</span><span class="nx">spo2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">pinMap</span><span class="p">[</span><span class="w"> </span><span class="nx">nextPinName</span><span class="p">];</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="nx">puck</span><span class="p">.</span><span class="nx">pinName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">nextPinName</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;no spring to use.&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">makeNPC_OnSinglePin</span><span class="p">(</span><span class="w"> </span><span class="nx">nNPCs</span><span class="p">,</span><span class="w"> </span><span class="nx">pinIndexStart</span><span class="p">,</span><span class="w"> </span><span class="nx">npcIndexStart</span><span class="p">,</span><span class="w"> </span><span class="nx">initialLocation_2d_m</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Make multiple NPC clients, each on its own navigation track (single pin). Use editor to add</span>
<span class="w">      </span><span class="c1">// more pins as wanted.</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">pinIndex</span><span class="p">,</span><span class="w"> </span><span class="nx">pinName</span><span class="p">,</span><span class="w"> </span><span class="nx">npcIndex</span><span class="p">,</span><span class="w"> </span><span class="nx">npcName</span><span class="p">,</span><span class="w"> </span><span class="nx">x_m</span><span class="p">;</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">nNPCs</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">len</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">pinIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pinIndexStart</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">i</span><span class="p">;</span>
<span class="w">         </span><span class="nx">npcIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">npcIndexStart</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">i</span><span class="p">;</span>
<span class="w">         </span><span class="nx">pinName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;pin&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">pinIndex</span><span class="p">;</span>
<span class="w">         </span><span class="nx">npcName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;NPC&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">npcIndex</span><span class="p">;</span>
<span class="w">         </span><span class="c1">// Pin is referenced by the NPC puck (so do this before instantiating the puck)</span>
<span class="w">         </span><span class="ow">new</span><span class="w"> </span><span class="nx">cP</span><span class="p">.</span><span class="nx">Pin</span><span class="p">(</span><span class="w"> </span><span class="nx">initialLocation_2d_m</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;radius_px&#39;</span><span class="o">:</span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;NPC&#39;</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;previousPinName&#39;</span><span class="o">:</span><span class="nx">pinName</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;name&#39;</span><span class="o">:</span><span class="nx">pinName</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;nextPinName&#39;</span><span class="o">:</span><span class="nx">pinName</span><span class="p">});</span>
<span class="w">         </span><span class="c1">// NPC client is referenced by the NPC puck (so do this before instantiating the puck)</span>
<span class="w">         </span><span class="ow">new</span><span class="w"> </span><span class="nx">cT</span><span class="p">.</span><span class="nx">Client</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="o">:</span><span class="nx">npcName</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;color&#39;</span><span class="o">:</span><span class="s1">&#39;purple&#39;</span><span class="p">});</span>
<span class="w">         </span><span class="ow">new</span><span class="w"> </span><span class="nx">cP</span><span class="p">.</span><span class="nx">Puck</span><span class="p">(</span><span class="w"> </span><span class="nx">initialLocation_2d_m</span><span class="p">,</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">),</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;radius_m&#39;</span><span class="o">:</span><span class="mf">0.30</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;color&#39;</span><span class="o">:</span><span class="s1">&#39;darkblue&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;colorSource&#39;</span><span class="o">:</span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;clientName&#39;</span><span class="o">:</span><span class="nx">npcName</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;linDamp&#39;</span><span class="o">:</span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;hitLimit&#39;</span><span class="o">:</span><span class="mf">20</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;pinName&#39;</span><span class="o">:</span><span class="nx">pinName</span><span class="p">}</span><span class="w"> </span><span class="p">);</span>
<span class="w">         </span><span class="c1">// Put the next one a little more to the right</span>
<span class="w">         </span><span class="nx">initialLocation_2d_m</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">makeNPC_OnTwoPins</span><span class="p">(</span><span class="w"> </span><span class="nx">placement_2d_m</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// A 2-pin navigation track for a single client.</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">pinRadius</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3</span><span class="p">;</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">namePinA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;pin&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="nx">cP</span><span class="p">.</span><span class="nx">Pin</span><span class="p">.</span><span class="nx">nameIndex</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">namePinB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;pin&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="nx">cP</span><span class="p">.</span><span class="nx">Pin</span><span class="p">.</span><span class="nx">nameIndex</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">2</span><span class="p">);</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">pinA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">cP</span><span class="p">.</span><span class="nx">Pin</span><span class="p">(</span><span class="w"> </span><span class="nx">placement_2d_m</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;radius_px&#39;</span><span class="o">:</span><span class="nx">pinRadius</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;NPC&#39;</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;previousPinName&#39;</span><span class="o">:</span><span class="nx">namePinB</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;name&#39;</span><span class="o">:</span><span class="nx">namePinA</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;nextPinName&#39;</span><span class="o">:</span><span class="nx">namePinB</span><span class="p">});</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">pinB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">cP</span><span class="p">.</span><span class="nx">Pin</span><span class="p">(</span><span class="w"> </span><span class="nx">placement_2d_m</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">)),</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;radius_px&#39;</span><span class="o">:</span><span class="nx">pinRadius</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;NPC&#39;</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;previousPinName&#39;</span><span class="o">:</span><span class="nx">namePinA</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;name&#39;</span><span class="o">:</span><span class="nx">namePinB</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;nextPinName&#39;</span><span class="o">:</span><span class="nx">namePinA</span><span class="p">});</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">nameForNPC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;NPC&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="nx">cT</span><span class="p">.</span><span class="nx">Client</span><span class="p">.</span><span class="nx">npcIndex</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">      </span><span class="ow">new</span><span class="w"> </span><span class="nx">cT</span><span class="p">.</span><span class="nx">Client</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="o">:</span><span class="nx">nameForNPC</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;color&#39;</span><span class="o">:</span><span class="s1">&#39;purple&#39;</span><span class="p">});</span>
<span class="w">      </span><span class="ow">new</span><span class="w"> </span><span class="nx">cP</span><span class="p">.</span><span class="nx">Puck</span><span class="p">(</span><span class="w"> </span><span class="nx">placement_2d_m</span><span class="p">,</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">),</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;radius_m&#39;</span><span class="o">:</span><span class="mf">0.30</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;color&#39;</span><span class="o">:</span><span class="s1">&#39;darkblue&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;colorSource&#39;</span><span class="o">:</span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;clientName&#39;</span><span class="o">:</span><span class="nx">nameForNPC</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;linDamp&#39;</span><span class="o">:</span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                                            </span><span class="s1">&#39;restitution&#39;</span><span class="o">:</span><span class="mf">0.7</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;restitution_fixed&#39;</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;hitLimit&#39;</span><span class="o">:</span><span class="mf">20</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;pinName&#39;</span><span class="o">:</span><span class="nx">namePinA</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;rayCast_init_deg&#39;</span><span class="o">:</span><span class="mf">0</span><span class="p">}</span><span class="w"> </span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">aimToLead</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Point gun along the ray-cast line and lead for target movement. </span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">gun</span><span class="p">.</span><span class="nx">rayBody</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="c1">// Vector from the shooting NPC to the target</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">NPC_to_TargetPuck_2d_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">gun</span><span class="p">.</span><span class="nx">rayBody</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">);</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">parallel_unit_vector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">NPC_to_TargetPuck_2d_m</span><span class="p">.</span><span class="nx">normal</span><span class="p">();</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// Target&#39;s velocity as seen by the shooting NPC (in the NPC reference frame).</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">target_inNPCrf_2d_mps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">gun</span><span class="p">.</span><span class="nx">rayBody</span><span class="p">.</span><span class="nx">velocity_2d_mps</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">velocity_2d_mps</span><span class="p">);</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// Component of the target&#39;s velocity along (parallel to) the line between the shooting NPC and the target.</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">target_parallel_2d_mps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">target_inNPCrf_2d_mps</span><span class="p">.</span><span class="nx">projection_onto</span><span class="p">(</span><span class="w"> </span><span class="nx">parallel_unit_vector</span><span class="p">);</span>
<span class="w">         </span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">target_parallel_2d_mps</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Component of target&#39;s relative (to shooter) velocity that is perpendicular to the line between the shooting NPC and the target</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">target_perpendicular_2d_mps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">target_inNPCrf_2d_mps</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="w"> </span><span class="nx">target_parallel_2d_mps</span><span class="p">);</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">perpendicular_unit_vector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">target_perpendicular_2d_mps</span><span class="p">.</span><span class="nx">normal</span><span class="p">();</span>
<span class="w">            </span><span class="cm">/*          </span>
<span class="cm">            This next line of code is the clever part. Find the angle, at which the </span>
<span class="cm">            bullet needs to fire, such that its perpendicular component matches the </span>
<span class="cm">            perpendicular component of the target. Then, in cases where the parallel </span>
<span class="cm">            component of the bullet is larger than that of the target, the bullet </span>
<span class="cm">            will overtake and hit the target. These words can be represented with a </span>
<span class="cm">            right triangle where the bullet speed is the hypotenuse and the target&#39;s </span>
<span class="cm">            perpendicular speed is one of the legs. Use Pythagorean equation to find </span>
<span class="cm">            the parallel component of the bullet velocity vector (the third leg of </span>
<span class="cm">            the triangle). This defines the orientation of the bullet vector. </span>
<span class="cm">            */</span><span class="w">           </span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">bullet_parallelSpeed_mps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">gun</span><span class="p">.</span><span class="nx">bulletSpeed_mps</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="w"> </span><span class="nx">target_perpendicular_2d_mps</span><span class="p">.</span><span class="nx">length</span><span class="p">(),</span><span class="w"> </span><span class="mf">2</span><span class="p">));</span>
<span class="w">            </span><span class="c1">// The bullet vector (relative to the shooting NPC) needed to intercept the target.</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">bullet_2d_mps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">target_perpendicular_2d_mps</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="w"> </span><span class="nx">parallel_unit_vector</span><span class="p">.</span><span class="nx">scaleBy</span><span class="p">(</span><span class="w"> </span><span class="nx">bullet_parallelSpeed_mps</span><span class="p">));</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">bullet_angle_deg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">bullet_2d_mps</span><span class="p">.</span><span class="nx">get_angle</span><span class="p">();</span>
<span class="w">            </span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">bullet_angle_deg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">gun</span><span class="p">.</span><span class="nx">rayBody</span><span class="p">.</span><span class="nx">linDamp</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="c1">// If the body has some linear damping drag, simply (easiest to) take the average of the leading angle </span>
<span class="w">                  </span><span class="c1">// and the line-of-sight angle. Otherwise, the leading aim will overshoot the target as it slows</span>
<span class="w">                  </span><span class="c1">// down under drag forces.</span>
<span class="w">                  </span><span class="c1">// x_fraction = 0.5 gives equal weight to both, an average.</span>
<span class="w">                  </span><span class="kd">var</span><span class="w"> </span><span class="nx">x_fraction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="p">;</span>
<span class="w">                  </span><span class="kd">var</span><span class="w"> </span><span class="nx">gun_angle_deg</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="nx">x_fraction</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">bullet_angle_deg</span><span class="w">  </span><span class="o">+</span><span class="w">  </span><span class="p">(</span><span class="mf">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">x_fraction</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">gun</span><span class="p">.</span><span class="nx">angleToFoundPuck</span><span class="p">;</span>
<span class="w">               </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="kd">var</span><span class="w"> </span><span class="nx">gun_angle_deg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">bullet_angle_deg</span><span class="p">;</span>
<span class="w">               </span><span class="p">}</span>
<span class="w">               </span><span class="nx">client</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">gun</span><span class="p">.</span><span class="nx">setTubeAngle</span><span class="p">(</span><span class="nx">gun_angle_deg</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">client</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">gun</span><span class="p">.</span><span class="nx">setTubeAngle</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">gun</span><span class="p">.</span><span class="nx">angleToFoundPuck</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">thinkForNPC</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="p">,</span><span class="w"> </span><span class="nx">deltaT_s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// If a hit is detected, turn the shield on for a while.</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">client</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">inComing</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">NPC_shield_timer_s</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">NPC_shield_timer_limit_s</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">client</span><span class="p">.</span><span class="nx">key_space</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;D&quot;</span><span class="p">;</span>
<span class="w">         </span><span class="nx">client</span><span class="p">.</span><span class="nx">NPC_shield_timer_s</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">deltaT_s</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">client</span><span class="p">.</span><span class="nx">key_space</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;U&quot;</span><span class="p">;</span>
<span class="w">         </span><span class="nx">client</span><span class="p">.</span><span class="nx">NPC_shield_timer_s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">         </span><span class="nx">client</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">inComing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// If found a target.</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">gun</span><span class="p">.</span><span class="nx">scanning</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="c1">// Note that thinkForNPC runs every frame, so this aiming adjustment continuously updates</span>
<span class="w">         </span><span class="c1">// during a bullet-firing sequence, adjusting the aim for each bullet that fires. This will</span>
<span class="w">         </span><span class="c1">// give a curved look to the bullet group unless both shooter and target have the same velocity.</span>
<span class="w">         </span><span class="c1">// The gun tube updates its orientation even when not shooting.</span>
<span class="w">         </span><span class="nx">aimToLead</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="p">);</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">NPC_guncooling_timer_s</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">NPC_guncooling_timer_limit_s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Keep shooting</span>
<span class="w">            </span><span class="nx">client</span><span class="p">.</span><span class="nx">key_i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;D&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="nx">client</span><span class="p">.</span><span class="nx">NPC_guncooling_timer_s</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">deltaT_s</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Release the i key.</span>
<span class="w">            </span><span class="nx">client</span><span class="p">.</span><span class="nx">key_i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;U&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="nx">client</span><span class="p">.</span><span class="nx">NPC_guncooling_timer_s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">client</span><span class="p">.</span><span class="nx">key_i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;U&quot;</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// This flag forces a needed update to navSpringOnly_force_2d_N before drawing</span>
<span class="w">      </span><span class="c1">// the jet along the direction of the spring force.</span>
<span class="w">      </span><span class="nx">client</span><span class="p">.</span><span class="nx">NPC_skipFrame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Move NPC to the next pin</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">NPC_pin_timer_s</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">NPC_pin_timer_limit_s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">client</span><span class="p">.</span><span class="nx">NPC_pin_timer_s</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">deltaT_s</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="c1">// First aim the jet gradually toward the next pin.</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">NPC_aimStepCount</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">NPC_aimStepCount_limit</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">stepTheJetAngle</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">puck</span><span class="p">);</span>
<span class="w">            </span><span class="nx">client</span><span class="p">.</span><span class="nx">NPC_aimStepCount</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">attachNavSpringToNextPin</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">puck</span><span class="p">);</span>
<span class="w">            </span><span class="nx">client</span><span class="p">.</span><span class="nx">NPC_aimStepCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">            </span><span class="nx">client</span><span class="p">.</span><span class="nx">NPC_pin_timer_s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">            </span><span class="nx">client</span><span class="p">.</span><span class="nx">NPC_skipFrame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Aim the jet in the direction opposite to the spring force.</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">NPC_aimStepCount</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">NPC_skipFrame</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">client</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">jet</span><span class="p">.</span><span class="nx">rotateJetAndScaleFlameToThis</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">navSpringOnly_force_2d_N</span><span class="p">.</span><span class="nx">scaleBy</span><span class="p">(</span><span class="o">-</span><span class="mf">1</span><span class="p">));</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">createPucksForNetworkClients</span><span class="p">(</span><span class="w"> </span><span class="nx">canvas</span><span class="p">,</span><span class="w"> </span><span class="nx">networkPuckTemplate</span><span class="p">,</span><span class="w"> </span><span class="nx">startingPosAndVels</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="cm">/*</span>
<span class="cm">      Make a controlled puck for each client (that wants one). Copy attributes from</span>
<span class="cm">      the host puck or the provided template.</span>
<span class="cm">      */</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">position_2d_m</span><span class="p">,</span><span class="w"> </span><span class="nx">velocity_2d_mps</span><span class="p">;</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">networkClientIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">      </span>
<span class="w">      </span><span class="kd">function</span><span class="w"> </span><span class="nx">randomPandV</span><span class="p">(</span><span class="w"> </span><span class="nx">position_2d_m</span><span class="p">,</span><span class="w"> </span><span class="nx">velocity_2d_mps</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="c1">// Randomize the position as constrained by the boundary of the canvas.</span>
<span class="w">         </span><span class="nx">position_2d_m</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">wS</span><span class="p">.</span><span class="nx">meters_from_px</span><span class="p">(</span><span class="w"> </span><span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="mf">0.3</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">();</span>
<span class="w">         </span><span class="nx">position_2d_m</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">wS</span><span class="p">.</span><span class="nx">meters_from_px</span><span class="p">(</span><span class="w"> </span><span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span><span class="p">)</span><span class="o">-</span><span class="mf">0.3</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">();</span>
<span class="w">         </span><span class="c1">// Randomize the initial velocity </span>
<span class="w">         </span><span class="nx">velocity_2d_mps</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">5.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">0.5</span><span class="p">);</span>
<span class="w">         </span><span class="nx">velocity_2d_mps</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">5.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">0.5</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="kd">function</span><span class="w"> </span><span class="nx">initializePuckPosAndVel</span><span class="p">(</span><span class="w"> </span><span class="nx">puckOrTemplate</span><span class="p">,</span><span class="w"> </span><span class="nx">clientName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">networkClientIndex</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">(</span><span class="nx">startingPosAndVels</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Use the array of starting positions</span>
<span class="w">            </span><span class="nx">position_2d_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">startingPosAndVels</span><span class="p">[</span><span class="w"> </span><span class="nx">networkClientIndex</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">].</span><span class="nx">position_2d_m</span><span class="p">;</span>
<span class="w">            </span><span class="nx">velocity_2d_mps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">startingPosAndVels</span><span class="p">[</span><span class="w"> </span><span class="nx">networkClientIndex</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">].</span><span class="nx">velocity_2d_mps</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">randomPandV</span><span class="p">(</span><span class="w"> </span><span class="nx">position_2d_m</span><span class="p">,</span><span class="w"> </span><span class="nx">velocity_2d_mps</span><span class="p">);</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">         </span>
<span class="w">         </span><span class="ow">new</span><span class="w"> </span><span class="nx">cP</span><span class="p">.</span><span class="nx">Puck</span><span class="p">(</span><span class="w"> </span><span class="nx">position_2d_m</span><span class="p">,</span><span class="w"> </span><span class="nx">velocity_2d_mps</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;color&#39;</span><span class="o">:</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;colorSource&#39;</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;clientName&#39;</span><span class="o">:</span><span class="nx">clientName</span><span class="p">,</span><span class="w"> </span>
<span class="w">             </span><span class="s1">&#39;bullet&#39;</span><span class="o">:</span><span class="w">            </span><span class="nx">puckOrTemplate</span><span class="p">.</span><span class="nx">bullet</span><span class="p">,</span>
<span class="w">             </span><span class="s1">&#39;radius_m&#39;</span><span class="o">:</span><span class="w">          </span><span class="nx">puckOrTemplate</span><span class="p">.</span><span class="nx">radius_m</span><span class="p">,</span>
<span class="w">             </span><span class="s1">&#39;hitLimit&#39;</span><span class="o">:</span><span class="w">          </span><span class="nx">puckOrTemplate</span><span class="p">.</span><span class="nx">hitLimit</span><span class="p">,</span>
<span class="w">             </span><span class="s1">&#39;noRecoil&#39;</span><span class="o">:</span><span class="w">          </span><span class="nx">puckOrTemplate</span><span class="p">.</span><span class="nx">noRecoil</span><span class="p">,</span>
<span class="w">             </span><span class="s1">&#39;cannibalize&#39;</span><span class="o">:</span><span class="w">       </span><span class="nx">puckOrTemplate</span><span class="p">.</span><span class="nx">cannibalize</span><span class="p">,</span>
<span class="w">             </span><span class="s1">&#39;linDamp&#39;</span><span class="o">:</span><span class="w">           </span><span class="nx">puckOrTemplate</span><span class="p">.</span><span class="nx">linDamp</span><span class="p">,</span>
<span class="w">             </span><span class="s1">&#39;restitution&#39;</span><span class="o">:</span><span class="w">       </span><span class="nx">puckOrTemplate</span><span class="p">.</span><span class="nx">restitution</span><span class="p">,</span>
<span class="w">             </span><span class="s1">&#39;restitution_fixed&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">puckOrTemplate</span><span class="p">.</span><span class="nx">restitution_fixed</span><span class="p">,</span>
<span class="w">             </span><span class="s1">&#39;friction&#39;</span><span class="o">:</span><span class="w">          </span><span class="nx">puckOrTemplate</span><span class="p">.</span><span class="nx">friction</span><span class="p">,</span>
<span class="w">             </span><span class="s1">&#39;friction_fixed&#39;</span><span class="o">:</span><span class="w">    </span><span class="nx">puckOrTemplate</span><span class="p">.</span><span class="nx">friction_fixed</span>
<span class="w">             </span><span class="p">});</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// First, check to make sure there is a puck for the host, if it&#39;s requested (checked).</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">checked</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">puck</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="c1">// Make the requested puck for the host</span>
<span class="w">         </span><span class="nx">position_2d_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">startingPosAndVels</span><span class="p">[</span><span class="w"> </span><span class="nx">networkClientIndex</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">].</span><span class="nx">position_2d_m</span><span class="p">;</span>
<span class="w">         </span><span class="nx">velocity_2d_mps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">startingPosAndVels</span><span class="p">[</span><span class="w"> </span><span class="nx">networkClientIndex</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">].</span><span class="nx">velocity_2d_mps</span><span class="p">;</span>
<span class="w">         </span><span class="ow">new</span><span class="w"> </span><span class="nx">cP</span><span class="p">.</span><span class="nx">Puck</span><span class="p">(</span><span class="w"> </span><span class="nx">position_2d_m</span><span class="p">,</span><span class="w"> </span><span class="nx">velocity_2d_mps</span><span class="p">,</span><span class="w"> </span><span class="nx">cP</span><span class="p">.</span><span class="nx">Puck</span><span class="p">.</span><span class="nx">hostPars</span><span class="p">);</span>
<span class="w">         </span><span class="nx">networkClientIndex</span><span class="o">++</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="nx">m_clientPucksAtGameStart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">      </span><span class="nx">cT</span><span class="p">.</span><span class="nx">Client</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">position_2d_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">);</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">velocity_2d_mps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">);</span>
<span class="w">         </span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;u&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">player</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">// If the host has a puck for keyboard play, use the local puck as a template.</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">puck</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">initializePuckPosAndVel</span><span class="p">(</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">puck</span><span class="p">,</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
<span class="w">                   </span>
<span class="w">            </span><span class="c1">// If the host is using the virtual game pad and a template has been established (e.g. from the &#39;local&#39; puck in the capture).</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">networkPuckTemplate</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">               </span><span class="nx">initializePuckPosAndVel</span><span class="p">(</span><span class="w"> </span><span class="nx">networkPuckTemplate</span><span class="p">,</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
<span class="w">                               </span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;can not find anything to use as a puck template.&#39;</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">// Update the TwoThumbs interface to show there is a client puck.</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">control_message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;from&#39;</span><span class="o">:</span><span class="s1">&#39;host&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;to&#39;</span><span class="o">:</span><span class="nx">client</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;data&#39;</span><span class="o">:</span><span class="p">{</span><span class="s1">&#39;puckPopped&#39;</span><span class="o">:</span><span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="o">:</span><span class="kc">false</span><span class="p">}}</span><span class="w"> </span><span class="p">};</span>
<span class="w">            </span><span class="nx">hC</span><span class="p">.</span><span class="nx">sendSocketControlMessage</span><span class="p">(</span><span class="w"> </span><span class="nx">control_message</span><span class="p">);</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">// Send out the gun angle of the new puck so that sweep operations on a new puck start out </span>
<span class="w">            </span><span class="c1">// smoothly (instead seeing a jump-to-sync at the client).</span>
<span class="w">            </span><span class="nx">gunAngleFromHost</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span><span class="w"> </span><span class="c1">// true --&gt; bypasses limits and executes immediately</span>
<span class="w">            </span><span class="c1">// Also sync up the jet angle on the client.</span>
<span class="w">            </span><span class="nx">jetAngleFromHost</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="p">);</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">// Increment only for network clients (inside the if block)</span>
<span class="w">            </span><span class="nx">networkClientIndex</span><span class="o">++</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">puck</span><span class="p">)</span><span class="w"> </span><span class="nx">m_clientPucksAtGameStart</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">gunAngleFromHost</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="p">,</span><span class="w"> </span><span class="nx">deltaT_s</span><span class="p">,</span><span class="w"> </span><span class="nx">bypassLimits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">puck</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">client</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">gun</span><span class="p">.</span><span class="nx">scopeRotRateFrac</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="nx">bypassLimits</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// No need to send this every frame, so use timer to limit this.</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">client</span><span class="p">.</span><span class="nx">gunAngle_timer_s</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">gunAngle_timer_limit_s</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="nx">bypassLimits</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="kd">var</span><span class="w"> </span><span class="nx">gunAngle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">gun</span><span class="p">.</span><span class="nx">rel_position_2d_m</span><span class="p">.</span><span class="nx">get_angle</span><span class="p">();</span>
<span class="w">               </span><span class="c1">// If RTC data channel available:</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">dataChannel</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">dataChannel</span><span class="p">.</span><span class="nx">readyState</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;open&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="nx">client</span><span class="p">.</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">dataChannel</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="o">:</span><span class="p">{</span><span class="s1">&#39;gunAngle&#39;</span><span class="o">:</span><span class="nx">gunAngle</span><span class="p">}}</span><span class="w"> </span><span class="p">));</span>
<span class="w">               </span><span class="c1">// Otherwise, send via socket.io</span>
<span class="w">               </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="kd">var</span><span class="w"> </span><span class="nx">control_message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;from&#39;</span><span class="o">:</span><span class="s1">&#39;host&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;to&#39;</span><span class="o">:</span><span class="nx">client</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;data&#39;</span><span class="o">:</span><span class="p">{</span><span class="s1">&#39;gunAngle&#39;</span><span class="o">:</span><span class="nx">gunAngle</span><span class="p">}</span><span class="w"> </span><span class="p">};</span>
<span class="w">                  </span><span class="nx">hC</span><span class="p">.</span><span class="nx">sendSocketControlMessage</span><span class="p">(</span><span class="w"> </span><span class="nx">control_message</span><span class="p">);</span>
<span class="w">               </span><span class="p">}</span>
<span class="w">               </span><span class="nx">client</span><span class="p">.</span><span class="nx">gunAngle_timer_s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">client</span><span class="p">.</span><span class="nx">gunAngle_timer_s</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">deltaT_s</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">jetAngleFromHost</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">puck</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">jetAngle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">jet</span><span class="p">.</span><span class="nx">rel_position_2d_m</span><span class="p">.</span><span class="nx">get_angle</span><span class="p">();</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">control_message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;from&#39;</span><span class="o">:</span><span class="s1">&#39;host&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;to&#39;</span><span class="o">:</span><span class="nx">client</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;data&#39;</span><span class="o">:</span><span class="p">{</span><span class="s1">&#39;jetAngle&#39;</span><span class="o">:</span><span class="nx">jetAngle</span><span class="p">}</span><span class="w"> </span><span class="p">};</span>
<span class="w">         </span><span class="nx">hC</span><span class="p">.</span><span class="nx">sendSocketControlMessage</span><span class="p">(</span><span class="w"> </span><span class="nx">control_message</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">fenceIsClientColor</span><span class="p">(</span><span class="w"> </span><span class="nx">clientName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">theyMatch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">      </span><span class="nx">cP</span><span class="p">.</span><span class="nx">Wall</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span><span class="w"> </span><span class="nx">wall</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">wall</span><span class="p">.</span><span class="nx">fence</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">wall</span><span class="p">.</span><span class="nx">color</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="w"> </span><span class="nx">clientName</span><span class="p">].</span><span class="nx">color</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="nx">theyMatch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">theyMatch</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="c1">// These team functions keep track of the pucks that the clients are driving. For example,</span>
<span class="w">   </span><span class="c1">// if a team looses all it&#39;s pucks, it won&#39;t contribute to the team count here.</span>
<span class="w">   </span><span class="c1">// This is in contrast to some similar code in clientProto.js where client scores are</span>
<span class="w">   </span><span class="c1">// tracked at team levels.</span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">updateTeamInfo</span><span class="p">(</span><span class="w"> </span><span class="nx">clientName</span><span class="p">,</span><span class="w"> </span><span class="nx">countChange</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">hasTeamName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="w"> </span><span class="nx">clientName</span><span class="p">])</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="w"> </span><span class="nx">clientName</span><span class="p">].</span><span class="nx">teamName</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hasTeamName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="kd">let</span><span class="w"> </span><span class="nx">teamName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="w"> </span><span class="nx">clientName</span><span class="p">].</span><span class="nx">teamName</span><span class="p">;</span>
<span class="w">         </span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">m_teams</span><span class="p">[</span><span class="w"> </span><span class="nx">teamName</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">m_teams</span><span class="p">[</span><span class="w"> </span><span class="nx">teamName</span><span class="p">].</span><span class="nx">memberCount</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">countChange</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// initialize the counter key for that team</span>
<span class="w">            </span><span class="nx">m_teams</span><span class="p">[</span><span class="w"> </span><span class="nx">teamName</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;memberCount&#39;</span><span class="o">:</span><span class="nx">countChange</span><span class="p">};</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="nx">countTeams</span><span class="p">();</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">countTeams</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">teamCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">teamName</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">m_teams</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">m_teams</span><span class="p">[</span><span class="w"> </span><span class="nx">teamName</span><span class="p">].</span><span class="nx">memberCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="nx">teamCount</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="nx">m_teamCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">teamCount</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">deleteOldandUnhealthy</span><span class="p">(</span><span class="w"> </span><span class="nx">deltaT_s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">cP</span><span class="p">.</span><span class="nx">Puck</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span><span class="w"> </span><span class="nx">puck</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">puck</span><span class="p">.</span><span class="nx">gunBullet</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">//var age_ms = window.performance.now() - puck.createTime;</span>
<span class="w">            </span><span class="nx">puck</span><span class="p">.</span><span class="nx">age_ms</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">deltaT_s</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1000</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">puck</span><span class="p">.</span><span class="nx">age_ms</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">puck</span><span class="p">.</span><span class="nx">ageLimit_ms</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">               </span><span class="c1">// First penalize the shooter if no hits by this bullet.</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="o">!</span><span class="nx">puck</span><span class="p">.</span><span class="nx">atLeastOneHit</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">cT</span><span class="p">.</span><span class="nx">Client</span><span class="p">.</span><span class="nx">winnerBonusGiven</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="c1">// Make sure the client is still there...</span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="w"> </span><span class="nx">puck</span><span class="p">.</span><span class="nx">clientNameOfShooter</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">                     </span><span class="c1">// Now the penalty.</span>
<span class="w">                     </span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="w"> </span><span class="nx">puck</span><span class="p">.</span><span class="nx">clientNameOfShooter</span><span class="p">].</span><span class="nx">score</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">                  </span><span class="p">}</span>
<span class="w">               </span><span class="p">}</span>
<span class="w">               </span><span class="c1">// Then remove it.</span>
<span class="w">               </span><span class="nx">puck</span><span class="p">.</span><span class="nx">deleteThisOne</span><span class="p">({});</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">puck</span><span class="p">.</span><span class="nx">poorHealthFraction</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">puck</span><span class="p">.</span><span class="nx">deleteThisOne</span><span class="p">({});</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">      </span><span class="p">});</span><span class="w">  </span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="c1">// Note that this check gets called every frame (if running #7 or #8).</span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">checkForPuckPopperWinnerAndReport</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Check for a puck-popper winner. Do this check on the pucks because the human clients</span>
<span class="w">      </span><span class="c1">// are not removed when their pucks are popped.</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="nx">m_playerCount</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">((</span><span class="nx">m_teamCount</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">m_npcCount</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0</span><span class="p">))</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">((</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">friendlyFire</span><span class="p">.</span><span class="nx">checked</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">m_npcCount</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0</span><span class="p">))</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="c1">// Get the name of the client scoring the last hit. The check, to see if the winner (last client to produce a hit)</span>
<span class="w">         </span><span class="c1">// is still there, prevents a failed reference (to nickname) if the host uses the mouse to delete the last NPC. Usually, with</span>
<span class="w">         </span><span class="c1">// mouse deletion of the NPC, they are the last hitter, and so the applyToAll loop will run.</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">winnerClientName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">getLastClientToScoreHit</span><span class="p">();</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">winnerDescString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;scoring winning hit&#39;</span><span class="p">;</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="w"> </span><span class="nx">winnerClientName</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Looks like the last hitting client is not there (host is probably using the mouse for NPC deletes). </span>
<span class="w">            </span><span class="c1">// There might be multiple players left (if friendly fire is off). So take the highest scorer as the winner.</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">highestScore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mf">10000</span><span class="p">;</span>
<span class="w">            </span><span class="nx">cP</span><span class="p">.</span><span class="nx">Puck</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span><span class="w"> </span><span class="nx">puck</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">puck</span><span class="p">.</span><span class="nx">clientName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="w"> </span><span class="nx">puck</span><span class="p">.</span><span class="nx">clientName</span><span class="p">].</span><span class="nx">score</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">highestScore</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                     </span><span class="nx">winnerClientName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">puck</span><span class="p">.</span><span class="nx">clientName</span><span class="p">;</span>
<span class="w">                     </span><span class="nx">highestScore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="w"> </span><span class="nx">puck</span><span class="p">.</span><span class="nx">clientName</span><span class="p">].</span><span class="nx">score</span><span class="p">;</span>
<span class="w">                  </span><span class="p">}</span>
<span class="w">               </span><span class="p">}</span>
<span class="w">            </span><span class="p">});</span>
<span class="w">            </span><span class="nx">winnerDescString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;with highest score&#39;</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">         </span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="w"> </span><span class="nx">winnerClientName</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">winnerNickName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="w"> </span><span class="nx">winnerClientName</span><span class="p">].</span><span class="nx">nickName</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Still having trouble establishing a winner. Let&#39;s exit.</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// If the winner is still around (hasn&#39;t disconnected)</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="w"> </span><span class="nx">winnerClientName</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">winnerNickName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="kd">var</span><span class="w"> </span><span class="nx">displayName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">winnerNickName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39; (&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">cT</span><span class="p">.</span><span class="nx">Client</span><span class="p">.</span><span class="nx">translateIfLocal</span><span class="p">(</span><span class="w"> </span><span class="nx">winnerClientName</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;)&#39;</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="kd">var</span><span class="w"> </span><span class="nx">displayName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cT</span><span class="p">.</span><span class="nx">Client</span><span class="p">.</span><span class="nx">translateIfLocal</span><span class="p">(</span><span class="w"> </span><span class="nx">winnerClientName</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">m_clientPucksAtGameStart</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span>
<span class="w">               </span><span class="c1">// Give a bonus (only once, not every frame) for winning.</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">cT</span><span class="p">.</span><span class="nx">Client</span><span class="p">.</span><span class="nx">winnerBonusGiven</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="nx">cT</span><span class="p">.</span><span class="nx">Client</span><span class="p">.</span><span class="nx">winnerBonusGiven</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">                  </span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="w"> </span><span class="nx">winnerClientName</span><span class="p">].</span><span class="nx">winCount</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">                  </span>
<span class="w">                  </span><span class="c1">// Yes, now add the winner(s) to the summary too. The losers got added when their puck was popped.</span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">friendlyFire</span><span class="p">.</span><span class="nx">checked</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">m_teamCount</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                     </span><span class="c1">// Can only be one puck standing in this case.</span>
<span class="w">                     </span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="w"> </span><span class="nx">winnerClientName</span><span class="p">].</span><span class="nx">score</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">200</span><span class="p">;</span>
<span class="w">                     </span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="w"> </span><span class="nx">winnerClientName</span><span class="p">].</span><span class="nx">addScoreToSummary</span><span class="p">(</span><span class="w"> </span><span class="nx">m_puckPopperTimer_s</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mf">2</span><span class="p">),</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoIndex</span><span class="p">(),</span><span class="w"> </span><span class="nx">m_npcSleepUsage</span><span class="p">);</span>
<span class="w">                  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                     </span><span class="c1">// Assign the winning time to all the client pucks on the no-friendly-fire team.</span>
<span class="w">                     </span><span class="nx">cP</span><span class="p">.</span><span class="nx">Puck</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span><span class="w"> </span><span class="nx">puck</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">puck</span><span class="p">.</span><span class="nx">clientName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                           </span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="w"> </span><span class="nx">puck</span><span class="p">.</span><span class="nx">clientName</span><span class="p">].</span><span class="nx">score</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">200</span><span class="p">;</span>
<span class="w">                           </span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="w"> </span><span class="nx">puck</span><span class="p">.</span><span class="nx">clientName</span><span class="p">].</span><span class="nx">addScoreToSummary</span><span class="p">(</span><span class="w"> </span><span class="nx">m_puckPopperTimer_s</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mf">2</span><span class="p">),</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoIndex</span><span class="p">(),</span><span class="w"> </span><span class="nx">m_npcSleepUsage</span><span class="p">);</span>
<span class="w">                        </span><span class="p">}</span>
<span class="w">                     </span><span class="p">});</span>
<span class="w">                  </span><span class="p">}</span>
<span class="w">                  </span>
<span class="w">                  </span><span class="nx">lB</span><span class="p">.</span><span class="nx">reportGameResults</span><span class="p">();</span>
<span class="w">                  </span>
<span class="w">                  </span><span class="c1">// Send a score to the leaderboard for each human player. Build leaderboard report at the end.</span>
<span class="w">                  </span><span class="nx">lB</span><span class="p">.</span><span class="nx">submitScoresThenReport</span><span class="p">();</span>
<span class="w">                  </span>
<span class="w">                  </span><span class="c1">// Open up the multi-player panel so you can see the leader-board report.</span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">multiplayer</span><span class="p">.</span><span class="nx">checked</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">                     </span><span class="c1">// Note: to directly call the click handler function, toggleMultiplayerStuff, it must be put in</span>
<span class="w">                     </span><span class="c1">// module-level scope, which has been done. So this can be explicitly controlled as follows:</span>
<span class="w">                     </span><span class="c1">//gW.dC.multiplayer.checked = !gW.dC.multiplayer.checked;</span>
<span class="w">                     </span><span class="c1">//toggleMultiplayerStuff();</span>
<span class="w">                     </span><span class="c1">// Another approach is to get at the function via the module-level, gW.dC.multiplayer. The following</span>
<span class="w">                     </span><span class="c1">// are alternate ways to do what the two statements above do. These approaches do not</span>
<span class="w">                     </span><span class="c1">// require toggleMultiplayerStuff to be in the module-level scope.</span>
<span class="w">                     </span><span class="c1">//gW.dC.multiplayer.click();</span>
<span class="w">                     </span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#chkMultiplayer&quot;</span><span class="p">).</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">&quot;click&quot;</span><span class="p">);</span>
<span class="w">                  </span><span class="p">}</span>
<span class="w">                  </span><span class="c1">// only displayed once per win (because this block only runs once per win)</span>
<span class="w">                  </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">resetMessage</span><span class="p">();</span>
<span class="w">                  </span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">winnerClientName</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;NPC&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                     </span><span class="kd">var</span><span class="w"> </span><span class="nx">congratsString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Only one player remaining...&quot;</span><span class="p">;</span>
<span class="w">                     </span><span class="kd">var</span><span class="w"> </span><span class="nx">summaryString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Computer wins (oh man, that&#39;s not good)&quot;</span><span class="w"> </span><span class="o">+</span>
<span class="w">                                         </span><span class="s2">&quot;\\   color = &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="w"> </span><span class="nx">winnerClientName</span><span class="p">].</span><span class="nx">color</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">                                         </span><span class="s2">&quot;\\   time = &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">m_puckPopperTimer_s</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mf">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;s&quot;</span><span class="w"> </span><span class="o">+</span>
<span class="w">                                         </span><span class="s2">&quot;\\   score = &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="w"> </span><span class="nx">winnerClientName</span><span class="p">].</span><span class="nx">score</span><span class="p">;</span>
<span class="w">                  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">friendlyFire</span><span class="p">.</span><span class="nx">checked</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="kd">var</span><span class="w"> </span><span class="nx">congratsString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Only one player (or team) remaining...&quot;</span><span class="p">;</span>
<span class="w">                        </span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">m_teamCount</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                           </span><span class="kd">var</span><span class="w"> </span><span class="nx">summaryString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">displayName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot; wins&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">                                               </span><span class="s2">&quot;\\   color = &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="w"> </span><span class="nx">winnerClientName</span><span class="p">].</span><span class="nx">color</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">                                               </span><span class="s2">&quot;\\   time = &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">m_puckPopperTimer_s</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mf">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;s&quot;</span><span class="w"> </span><span class="o">+</span>
<span class="w">                                               </span><span class="s2">&quot;\\   score = &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="w"> </span><span class="nx">winnerClientName</span><span class="p">].</span><span class="nx">score</span><span class="p">;</span>
<span class="w">                        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                           </span><span class="kd">let</span><span class="w"> </span><span class="nx">teamName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="w"> </span><span class="nx">winnerClientName</span><span class="p">].</span><span class="nx">teamName</span><span class="p">;</span>
<span class="w">                           </span><span class="kd">var</span><span class="w"> </span><span class="nx">summaryString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">teamName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot; team wins&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">                                               </span><span class="s2">&quot;\\   time = &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">m_puckPopperTimer_s</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mf">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;s&quot;</span><span class="p">;</span>
<span class="w">                        </span><span class="p">}</span><span class="w">          </span>
<span class="w">                                            </span>
<span class="w">                     </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="kd">var</span><span class="w"> </span><span class="nx">congratsString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Only good guys remaining...&quot;</span><span class="p">;</span>
<span class="w">                        </span><span class="kd">var</span><span class="w"> </span><span class="nx">summaryString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;The good guys win&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">                                            </span><span class="s2">&quot;\\   name of player &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">winnerDescString</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot; = &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">displayName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">                                            </span><span class="s2">&quot;\\   color of player = &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="w"> </span><span class="nx">winnerClientName</span><span class="p">].</span><span class="nx">color</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">                                            </span><span class="s2">&quot;\\   time to win = &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">m_puckPopperTimer_s</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mf">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;s&quot;</span><span class="p">;</span>
<span class="w">                     </span><span class="p">}</span>
<span class="w">                  </span><span class="p">}</span>
<span class="w">                  </span>
<span class="w">                  </span><span class="kd">var</span><span class="w"> </span><span class="nx">theSeries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">                     </span><span class="mf">1</span><span class="o">:</span><span class="p">{</span><span class="s1">&#39;tL_s&#39;</span><span class="o">:</span><span class="mf">2.0</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;message&#39;</span><span class="o">:</span><span class="nx">congratsString</span><span class="p">},</span>
<span class="w">                     </span><span class="mf">2</span><span class="o">:</span><span class="p">{</span><span class="s1">&#39;tL_s&#39;</span><span class="o">:</span><span class="mf">2.5</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;message&#39;</span><span class="o">:</span><span class="s2">&quot;...so that&#39;s a win!&quot;</span><span class="p">},</span>
<span class="w">                     </span><span class="mf">3</span><span class="o">:</span><span class="p">{</span><span class="s1">&#39;tL_s&#39;</span><span class="o">:</span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;message&#39;</span><span class="o">:</span><span class="s2">&quot;Summary:&quot;</span><span class="p">},</span>
<span class="w">                     </span><span class="mf">4</span><span class="o">:</span><span class="p">{</span><span class="s1">&#39;tL_s&#39;</span><span class="o">:</span><span class="mf">5.0</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;message&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">summaryString</span><span class="p">},</span>
<span class="w">                     </span><span class="mf">5</span><span class="o">:</span><span class="p">{</span><span class="s1">&#39;tL_s&#39;</span><span class="o">:</span><span class="mf">2.0</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;message&#39;</span><span class="o">:</span><span class="s2">&quot;Reports are in the left panel.&quot;</span><span class="p">},</span>
<span class="w">                     </span><span class="mf">6</span><span class="o">:</span><span class="p">{</span><span class="s1">&#39;tL_s&#39;</span><span class="o">:</span><span class="mf">4.0</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;message&#39;</span><span class="o">:</span><span class="s2">&quot;Click the \&quot;multiplayer\&quot; checkbox (or use the m key) \\to toggle back to the help.&quot;</span><span class="p">}};</span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">winnerClientName</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;NPC&#39;</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">friendlyFire</span><span class="p">.</span><span class="nx">checked</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">m_territoryMarked</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                     </span><span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span><span class="w"> </span><span class="nx">theSeries</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">                        </span><span class="mf">7</span><span class="o">:</span><span class="p">{</span><span class="s1">&#39;tL_s&#39;</span><span class="o">:</span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;message&#39;</span><span class="o">:</span><span class="s2">&quot;One last thing to try...&quot;</span><span class="p">},</span>
<span class="w">                        </span><span class="mf">8</span><span class="o">:</span><span class="p">{</span><span class="s1">&#39;tL_s&#39;</span><span class="o">:</span><span class="mf">2.5</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;message&#39;</span><span class="o">:</span><span class="s2">&quot;pop any left-over pucks...&quot;</span><span class="p">},</span>
<span class="w">                        </span><span class="mf">9</span><span class="o">:</span><span class="p">{</span><span class="s1">&#39;tL_s&#39;</span><span class="o">:</span><span class="mf">2.0</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;message&#39;</span><span class="o">:</span><span class="s2">&quot;then navigate...&quot;</span><span class="p">},</span>
<span class="w">                       </span><span class="mf">10</span><span class="o">:</span><span class="p">{</span><span class="s1">&#39;tL_s&#39;</span><span class="o">:</span><span class="mf">3.0</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;message&#39;</span><span class="o">:</span><span class="s2">&quot;to bounce your puck off the four walls.&quot;</span><span class="p">}</span>
<span class="w">                     </span><span class="p">});</span>
<span class="w">                  </span><span class="p">}</span>
<span class="w">                  </span><span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span><span class="w"> </span><span class="nx">theSeries</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">                     </span><span class="mf">12</span><span class="o">:</span><span class="p">{</span><span class="s1">&#39;tL_s&#39;</span><span class="o">:</span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;message&#39;</span><span class="o">:</span><span class="s2">&quot;That&#39;s it...&quot;</span><span class="p">},</span>
<span class="w">                     </span><span class="mf">13</span><span class="o">:</span><span class="p">{</span><span class="s1">&#39;tL_s&#39;</span><span class="o">:</span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;message&#39;</span><span class="o">:</span><span class="s2">&quot;...the end.&quot;</span><span class="p">},</span>
<span class="w">                     </span><span class="mf">15</span><span class="o">:</span><span class="p">{</span><span class="s1">&#39;tL_s&#39;</span><span class="o">:</span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;message&#39;</span><span class="o">:</span><span class="s2">&quot;.&quot;</span><span class="p">},</span>
<span class="w">                     </span><span class="mf">16</span><span class="o">:</span><span class="p">{</span><span class="s1">&#39;tL_s&#39;</span><span class="o">:</span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;message&#39;</span><span class="o">:</span><span class="s2">&quot;..&quot;</span><span class="p">},</span>
<span class="w">                     </span><span class="mf">17</span><span class="o">:</span><span class="p">{</span><span class="s1">&#39;tL_s&#39;</span><span class="o">:</span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;message&#39;</span><span class="o">:</span><span class="s2">&quot;...&quot;</span><span class="p">},</span>
<span class="w">                     </span><span class="mf">18</span><span class="o">:</span><span class="p">{</span><span class="s1">&#39;tL_s&#39;</span><span class="o">:</span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;message&#39;</span><span class="o">:</span><span class="s2">&quot;....&quot;</span><span class="p">},</span>
<span class="w">                     </span><span class="mf">19</span><span class="o">:</span><span class="p">{</span><span class="s1">&#39;tL_s&#39;</span><span class="o">:</span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;message&#39;</span><span class="o">:</span><span class="s2">&quot;.....&quot;</span><span class="p">},</span>
<span class="w">                     </span><span class="mf">20</span><span class="o">:</span><span class="p">{</span><span class="s1">&#39;tL_s&#39;</span><span class="o">:</span><span class="mf">3.0</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;message&#39;</span><span class="o">:</span><span class="s2">&quot;You&#39;re still there?&quot;</span><span class="p">},</span>
<span class="w">                     </span><span class="mf">21</span><span class="o">:</span><span class="p">{</span><span class="s1">&#39;tL_s&#39;</span><span class="o">:</span><span class="mf">2.0</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;message&#39;</span><span class="o">:</span><span class="s2">&quot;Till next time.&quot;</span><span class="p">}</span>
<span class="w">                  </span><span class="p">});</span>
<span class="w">                  </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;win&#39;</span><span class="p">].</span><span class="nx">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;lightgray&#39;</span><span class="p">;</span>
<span class="w">                  </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;win&#39;</span><span class="p">].</span><span class="nx">newMessageSeries</span><span class="p">(</span><span class="w"> </span><span class="nx">theSeries</span><span class="p">);</span>
<span class="w">               </span><span class="p">}</span>
<span class="w">               </span>
<span class="w">               </span><span class="c1">// Turn off (zero out the message string) the little score display for the local client (if they&#39;re the winner).</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">winnerClientName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;local&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">);</span>
<span class="w">               </span>
<span class="w">               </span><span class="c1">// This marked condition is checked every frame after a win. So use m_territoryMarked to post this</span>
<span class="w">               </span><span class="c1">// 5 second message only once per onset of a marked territory. That way it turns off after 5s.</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">fenceIsClientColor</span><span class="p">(</span><span class="w"> </span><span class="nx">winnerClientName</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">m_territoryMarked</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                     </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;lowHelp&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s2">&quot;...nice job marking your territory...&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">5.0</span><span class="p">);</span>
<span class="w">                     </span><span class="nx">m_territoryMarked</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">                  </span><span class="p">}</span>
<span class="w">               </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="nx">m_territoryMarked</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">               </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">m_playerCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="kd">let</span><span class="w"> </span><span class="nx">scoreString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">;</span>
<span class="w">         </span><span class="nx">cT</span><span class="p">.</span><span class="nx">Client</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">            </span><span class="c1">// display score for all surviving human players</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">client</span><span class="p">.</span><span class="nx">puck</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">3</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;NPC&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">scoreString</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">nameString</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;: [base,white]&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">score</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;[base]    &#39;</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">         </span><span class="p">});</span>
<span class="w">         </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="w"> </span><span class="nx">scoreString</span><span class="p">,</span><span class="w"> </span><span class="mf">0.2</span><span class="p">);</span>
<span class="w">         </span>
<span class="w">         </span><span class="nx">m_puckPopperTimer_s</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">getDeltaT_s</span><span class="p">();</span>
<span class="w">         </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;ppTimer&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="w"> </span><span class="nx">m_puckPopperTimer_s</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mf">2</span><span class="p">),</span><span class="w"> </span><span class="mf">0.2</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">Shield</span><span class="p">(</span><span class="w"> </span><span class="nx">puck</span><span class="p">,</span><span class="w"> </span><span class="nx">pars</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">dFM</span><span class="p">.</span><span class="nx">DrawingFunctions</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span><span class="w"> </span><span class="c1">// Inherit attributes</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Make a (circular) reference to the host puck.</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">puck</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">puck</span><span class="p">;</span>

<span class="w">      </span><span class="c1">// Optional parameters and defaults.</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span><span class="w"> </span><span class="nx">pars</span><span class="p">.</span><span class="nx">color</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;lime&#39;</span><span class="p">);</span>

<span class="w">      </span><span class="c1">// Make a direct reference to the client.</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">clientName</span><span class="p">];</span>
<span class="w">            </span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">radius_px</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">px_from_meters</span><span class="p">(</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">radius_m</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1.15</span><span class="p">);</span>
<span class="w">      </span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">ON</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">STRONG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">STRONG_timer_s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">STRONG_time_limit_s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3.0</span><span class="p">;</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">CHARGING_timer_s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">CHARGING_time_limit_s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.0</span><span class="p">;</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">charge_level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="nx">Shield</span><span class="p">.</span><span class="nx">prototype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="w"> </span><span class="nx">dFM</span><span class="p">.</span><span class="nx">DrawingFunctions</span><span class="p">.</span><span class="nx">prototype</span><span class="p">);</span><span class="w"> </span><span class="c1">// Inherit methods (containing module must load first)</span>
<span class="w">   </span><span class="nx">Shield</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="kr">constructor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Shield</span><span class="p">;</span><span class="w"> </span><span class="c1">// Rename the constructor (after inheriting)</span>
<span class="w">   </span><span class="nx">Shield</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">updateState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">drawingContext</span><span class="p">,</span><span class="w"> </span><span class="nx">deltaT_s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Let the client control the state and draw if ON.</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">key_space</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;D&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="k">this</span><span class="p">.</span><span class="nx">ON</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">STRONG</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">dashArray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Shields are weak.</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">dashArray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mf">10</span><span class="p">];</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">         </span><span class="k">this</span><span class="p">.</span><span class="nx">drawCircle</span><span class="p">(</span><span class="w"> </span><span class="nx">drawingContext</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">position_2d_px</span><span class="p">,</span><span class="w"> </span>
<span class="w">            </span><span class="p">{</span><span class="s1">&#39;borderColor&#39;</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">color</span><span class="p">,</span><span class="w"> </span>
<span class="w">             </span><span class="s1">&#39;fillColor&#39;</span><span class="o">:</span><span class="s1">&#39;noFill&#39;</span><span class="p">,</span><span class="w"> </span>
<span class="w">             </span><span class="s1">&#39;borderWidth_px&#39;</span><span class="o">:</span><span class="mf">3</span><span class="p">,</span><span class="w"> </span>
<span class="w">             </span><span class="s1">&#39;radius_px&#39;</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">radius_px</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1.15</span><span class="p">,</span>
<span class="w">             </span><span class="s1">&#39;dashArray&#39;</span><span class="o">:</span><span class="nx">dashArray</span><span class="p">});</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="k">this</span><span class="p">.</span><span class="nx">ON</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="c1">// Drain the shield</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">ON</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">STRONG</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="k">this</span><span class="p">.</span><span class="nx">STRONG_timer_s</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">deltaT_s</span><span class="p">;</span><span class="w">  </span>
<span class="w">         </span><span class="k">this</span><span class="p">.</span><span class="nx">charge_level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.00</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">STRONG_timer_s</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">STRONG_time_limit_s</span><span class="p">);</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">STRONG_timer_s</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">STRONG_time_limit_s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="nx">STRONG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="nx">STRONG_timer_s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span><span class="w">  </span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Recharge the shield only if completely drained.</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">STRONG</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="k">this</span><span class="p">.</span><span class="nx">CHARGING_timer_s</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">deltaT_s</span><span class="p">;</span>
<span class="w">         </span><span class="k">this</span><span class="p">.</span><span class="nx">charge_level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">CHARGING_timer_s</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">CHARGING_time_limit_s</span><span class="p">;</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">CHARGING_timer_s</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">CHARGING_time_limit_s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="nx">STRONG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="nx">CHARGING_timer_s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Display the shield timer on the gun tube.</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">gun</span><span class="p">.</span><span class="nx">indicatorFraction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">charge_level</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>


<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">Tube</span><span class="p">(</span><span class="w"> </span><span class="nx">puck</span><span class="p">,</span><span class="w"> </span><span class="nx">pars</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">dFM</span><span class="p">.</span><span class="nx">DrawingFunctions</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span><span class="w"> </span><span class="c1">// Inherit attributes</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Circular reference back to the puck.</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">puck</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">puck</span><span class="p">;</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Optional parameters and defaults.</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">initial_angle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span><span class="w"> </span><span class="nx">pars</span><span class="p">.</span><span class="nx">initial_angle</span><span class="p">,</span><span class="w"> </span><span class="mf">20</span><span class="p">);</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">indicator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span><span class="w"> </span><span class="nx">pars</span><span class="p">.</span><span class="nx">indicator</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span>

<span class="w">      </span><span class="c1">// Make a direct reference to the client.</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">clientName</span><span class="p">];</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// 360 degrees/second  /  60 frames/second = 6 degrees/frame</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">rotationRate_dps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">240.0</span><span class="p">;</span><span class="w"> </span><span class="c1">//4.0dpf;</span>
<span class="w">      </span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">tube_color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;blue&#39;</span><span class="p">;</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">length_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.05</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">radius_m</span><span class="p">;</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">width_m</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">0.30</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">radius_m</span><span class="p">;</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">width_px</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">px_from_meters</span><span class="p">(</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">width_m</span><span class="p">);</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Establish the relative-position vector (for the end of the tube) using the length of the tube.</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">rel_position_2d_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">length_m</span><span class="p">);</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">rel_position_2d_m</span><span class="p">.</span><span class="nx">set_angle</span><span class="p">(</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">initial_angle</span><span class="p">);</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">absPositionOfEnds</span><span class="p">();</span>
<span class="w">      </span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">indicatorWidth_px</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">px_from_meters</span><span class="p">(</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">width_m</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.40</span><span class="p">);</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">indicatorFraction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="nx">Tube</span><span class="p">.</span><span class="nx">prototype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="w"> </span><span class="nx">dFM</span><span class="p">.</span><span class="nx">DrawingFunctions</span><span class="p">.</span><span class="nx">prototype</span><span class="p">);</span><span class="w"> </span><span class="c1">// Inherit methods (containing module must load first)</span>
<span class="w">   </span><span class="nx">Tube</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="kr">constructor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Tube</span><span class="p">;</span><span class="w"> </span><span class="c1">// Rename the constructor (after inheriting)</span>
<span class="w">   </span><span class="nx">Tube</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">absPositionOfEnds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Determine the absolute positions of the base and the end of the tube.</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">base_2d_px</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">screenFromWorld</span><span class="p">(</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">);</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">end_2d_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">rel_position_2d_m</span><span class="p">);</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">end_2d_px</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">screenFromWorld</span><span class="p">(</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">end_2d_m</span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="nx">Tube</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">absPositionOfIndicator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// The starting point will indicate the &quot;amount&quot; of the indicator.</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">indicatorBase_2d_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">rel_position_2d_m</span><span class="p">.</span><span class="nx">scaleBy</span><span class="p">(</span><span class="mf">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">indicatorFraction</span><span class="p">));</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">indicatorBase_2d_px</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">screenFromWorld</span><span class="p">(</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">indicatorBase_2d_m</span><span class="p">);</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Draw to the end of the tube.</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">indicatorEnd_2d_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">rel_position_2d_m</span><span class="p">.</span><span class="nx">scaleBy</span><span class="p">(</span><span class="w"> </span><span class="mf">1.00</span><span class="p">));</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">indicatorEnd_2d_px</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">screenFromWorld</span><span class="p">(</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">indicatorEnd_2d_m</span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="nx">Tube</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">rotateTube</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">deg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">rel_position_2d_m</span><span class="p">.</span><span class="nx">rotated_by</span><span class="p">(</span><span class="w"> </span><span class="nx">deg</span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="nx">Tube</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setTubeAngle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">deg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">rel_position_2d_m</span><span class="p">.</span><span class="nx">set_angle</span><span class="p">(</span><span class="w"> </span><span class="nx">deg</span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="nx">Tube</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">drawTube</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">drawingContext</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">      </span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">absPositionOfEnds</span><span class="p">();</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">drawLine</span><span class="p">(</span><span class="w"> </span><span class="nx">drawingContext</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">base_2d_px</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">end_2d_px</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;width_px&#39;</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">width_px</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;color&#39;</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">tube_color</span><span class="p">});</span>
<span class="w">      </span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">indicator</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="k">this</span><span class="p">.</span><span class="nx">absPositionOfIndicator</span><span class="p">();</span>
<span class="w">         </span><span class="k">this</span><span class="p">.</span><span class="nx">drawLine</span><span class="p">(</span><span class="w"> </span><span class="nx">drawingContext</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">indicatorBase_2d_px</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">indicatorEnd_2d_px</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;width_px&#39;</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">indicatorWidth_px</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;color&#39;</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">shield</span><span class="p">.</span><span class="nx">color</span><span class="p">});</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">Jet</span><span class="p">(</span><span class="w"> </span><span class="nx">puck</span><span class="p">,</span><span class="w"> </span><span class="nx">pars</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// The following link has a good explanation of the inheritance techniques used in this Jet (and the Gun) prototype.</span>
<span class="w">      </span><span class="c1">// https://tylermcginnis.com/javascript-inheritance-and-the-prototype-chain/</span>
<span class="w">      </span><span class="c1">//</span>
<span class="w">      </span><span class="c1">// Call the Tube constructor. Bind it to &quot;this&quot; jet. Pass the puck and pars to the constructor and run it. This brings in</span>
<span class="w">      </span><span class="c1">// all the attributes of Tube and makes them accessible in Jet. Note that Tube inherits from DrawingFunctions.</span>
<span class="w">      </span><span class="nx">Tube</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="nx">puck</span><span class="p">,</span><span class="w"> </span><span class="nx">pars</span><span class="p">);</span>
<span class="w">            </span>
<span class="w">      </span><span class="c1">// Add properties specific to Jet.</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">width_m</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mf">0.17</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">radius_m</span><span class="p">;</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">height_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.00</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">radius_m</span><span class="p">;</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// This jet-flame triangle is oriented like an arrow pointing the positive x direction.</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">initializeFlame</span><span class="p">(</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">height_m</span><span class="p">);</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Point the jet flame in the same direction as the tube.</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">rotateFlame</span><span class="p">(</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">initial_angle</span><span class="p">);</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Set the tube color to match the client color.</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">tube_color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">color</span><span class="p">;</span>
<span class="w">      </span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">flame_color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;red&#39;</span><span class="p">;</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">flameEdge_color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;blue&#39;</span><span class="p">;</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Scaler magnitude of jet thrust force</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">jet_force_N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">mass_kg</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">getG_mps2</span><span class="p">());</span>
<span class="w">      </span><span class="c1">// Controlled by the Two Thumbs interface.</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">throttle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
<span class="w">      </span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">rotationCounter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">      </span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">noseCone_2d_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="ow">new</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">),</span><span class="w">                    </span><span class="ow">new</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="o">-</span><span class="k">this</span><span class="p">.</span><span class="nx">width_m</span><span class="p">),</span>
<span class="w">                            </span><span class="ow">new</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">width_m</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">2.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">),</span><span class="w">  </span><span class="ow">new</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">width_m</span><span class="p">)];</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="c1">// Use the Tube prototype as starting point for the Jet (inheritance). This brings</span>
<span class="w">   </span><span class="c1">// in all the methods from Tube.</span>
<span class="w">   </span><span class="nx">Jet</span><span class="p">.</span><span class="nx">prototype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="w"> </span><span class="nx">Tube</span><span class="p">.</span><span class="nx">prototype</span><span class="p">);</span>
<span class="w">   </span><span class="c1">// Reset the constructor name back to Jet, so it is not left as &quot;Tube&quot; from the inheritance.</span>
<span class="w">   </span><span class="nx">Jet</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="kr">constructor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Jet</span><span class="p">;</span>
<span class="w">   </span><span class="c1">// Define any new methods for Jet.</span>
<span class="w">   </span><span class="nx">Jet</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">rotateShape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">shapeArray_2d_m</span><span class="p">,</span><span class="w"> </span><span class="nx">degrees</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// degrees is the change from the current orientation.</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">shapeArray_2d_m</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">len</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="c1">// Rotate each vertex.</span>
<span class="w">         </span><span class="nx">shapeArray_2d_m</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">rotated_by</span><span class="p">(</span><span class="w"> </span><span class="nx">degrees</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="nx">Jet</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">rotateFlame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">degrees</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">rotateShape</span><span class="p">(</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">flameTriangle_2d_m</span><span class="p">,</span><span class="w"> </span><span class="nx">degrees</span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="nx">Jet</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">rotateTubeAndFlame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">degrees</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// deg is the change from the current orientation.</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">rotateTube</span><span class="p">(</span><span class="w"> </span><span class="nx">degrees</span><span class="p">);</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">rotateFlame</span><span class="p">(</span><span class="w"> </span><span class="nx">degrees</span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="nx">Jet</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">rotateJetToAngle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">targetAngle_deg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">currentAngle_deg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">rel_position_2d_m</span><span class="p">.</span><span class="nx">get_angle</span><span class="p">();</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">rotateTubeAndFlame</span><span class="p">(</span><span class="w"> </span><span class="o">-</span><span class="nx">currentAngle_deg</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">targetAngle_deg</span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="nx">Jet</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">rotateJetAndScaleFlameToThis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">f_2d_N</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Rotate the tube and jet to be in the same direction as the supplied vector</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">current_deg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">rel_position_2d_m</span><span class="p">.</span><span class="nx">get_angle</span><span class="p">();</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Orient the jet along the x axis so it is simple to scale it. The</span>
<span class="w">      </span><span class="c1">// angle will be 0 after this.</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">rotateTubeAndFlame</span><span class="p">(</span><span class="w"> </span><span class="o">-</span><span class="nx">current_deg</span><span class="p">);</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Scale the jet flame relative to the length of the supplied vector.</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">height_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">height_m</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="nx">f_2d_N</span><span class="p">.</span><span class="nx">length</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">jet_force_N</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">height_m</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.10</span><span class="p">)</span><span class="w"> </span><span class="nx">height_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.10</span><span class="p">;</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">initializeFlame</span><span class="p">(</span><span class="w"> </span><span class="nx">height_m</span><span class="p">);</span>
<span class="w">      </span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">target_deg</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nx">f_2d_N</span><span class="p">.</span><span class="nx">get_angle</span><span class="p">();</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">change_deg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">target_deg</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Rotate, starting from 0, by this amount.</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">rotateTubeAndFlame</span><span class="p">(</span><span class="w"> </span><span class="nx">change_deg</span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="nx">Jet</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">rotateJetByClient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">deltaT_s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// The rate, expressed as degrees per second (dps), instead of degrees per frame, is useful for </span>
<span class="w">      </span><span class="c1">// accommodating the various physics-engine timestep options. </span>

<span class="w">      </span><span class="c1">// Left/Right pointing control</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">key_d</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;D&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">key_shift</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;D&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="k">this</span><span class="p">.</span><span class="nx">rotateTubeAndFlame</span><span class="p">(</span><span class="o">-</span><span class="k">this</span><span class="p">.</span><span class="nx">rotationRate_dps</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">deltaT_s</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">key_a</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;D&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">key_ctrl</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;D&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="k">this</span><span class="p">.</span><span class="nx">rotateTubeAndFlame</span><span class="p">(</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">rotationRate_dps</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">deltaT_s</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// For use in stopping the puck...</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">key_s</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;D&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">key_shift</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s2">&quot;D&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">key_s_enabled</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="c1">// This rotates the rel_position vector (the tube pointer) by the amount that it differs from the direction of motion.</span>
<span class="w">         </span><span class="c1">// The result being that it flips the tube to be in a direction opposite of the motion.</span>
<span class="w">         </span><span class="c1">// After the first flip, the subsequent s pressed rotate by -90 degrees. The rotationCounter is reset</span>
<span class="w">         </span><span class="c1">// when the jet is used.</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">rotationCounter</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="nx">rotateTubeAndFlame</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">velocity_2d_mps</span><span class="p">.</span><span class="nx">get_angle</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">rel_position_2d_m</span><span class="p">.</span><span class="nx">get_angle</span><span class="p">());</span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="nx">rotateTubeAndFlame</span><span class="p">(</span><span class="o">-</span><span class="mf">90</span><span class="p">);</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">         </span><span class="k">this</span><span class="p">.</span><span class="nx">rotationCounter</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">         </span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">key_s_enabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">key_s</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;U&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">key_s_enabled</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">key_s_enabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="nx">Jet</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">initializeFlame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">height_m</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// This jet-flame triangle is oriented like an arrow pointing the positive x direction.</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">flameTriangle_2d_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="ow">new</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">),</span><span class="w">        </span><span class="ow">new</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="o">-</span><span class="k">this</span><span class="p">.</span><span class="nx">width_m</span><span class="p">),</span>
<span class="w">                                 </span><span class="ow">new</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="nx">height_m</span><span class="p">,</span><span class="mf">0</span><span class="p">),</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">width_m</span><span class="p">)];</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="nx">Jet</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">displaceShapeForRendering</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">shapeArray_2d_m</span><span class="p">,</span><span class="w"> </span><span class="nx">offSetVector_2d_m</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Before you draw a shape, you have to know where it should appear on the screen. Return a</span>
<span class="w">      </span><span class="c1">// rendering array (in pixels) that has those vector addition results.</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">shapeArray_2d_px</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">shapeArray_2d_m</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">len</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="c1">// Calculate where the vertices would need to be so as to appear (render) on the end of the tube.</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">p_2d_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">offSetVector_2d_m</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="w"> </span><span class="nx">shapeArray_2d_m</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">p_2d_px</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">screenFromWorld</span><span class="p">(</span><span class="w"> </span><span class="nx">p_2d_m</span><span class="p">);</span>
<span class="w">         </span><span class="c1">// Put it in the triangle array.</span>
<span class="w">         </span><span class="nx">shapeArray_2d_px</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="w"> </span><span class="nx">p_2d_px</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">shapeArray_2d_px</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="nx">Jet</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">drawFlame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">drawingContext</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Draw flame at the end of the tube.</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">flameShape_2d_px</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">displaceShapeForRendering</span><span class="p">(</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">flameTriangle_2d_m</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">end_2d_m</span><span class="p">);</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">drawPolygon</span><span class="p">(</span><span class="w"> </span><span class="nx">drawingContext</span><span class="p">,</span><span class="w"> </span><span class="nx">flameShape_2d_px</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;borderColor&#39;</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">flameEdge_color</span><span class="p">,</span><span class="s1">&#39;borderWidth_px&#39;</span><span class="o">:</span><span class="mf">3</span><span class="p">,</span><span class="s1">&#39;fillColor&#39;</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">flame_color</span><span class="p">});</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="nx">Jet</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">drawNoseCone</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">drawingContext</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// The nose cone is processed with only rotation and displacement, no shape</span>
<span class="w">      </span><span class="c1">// elongation like with the jet flame. So there is no call to a function like</span>
<span class="w">      </span><span class="c1">// initializeFlame, that facilitates the flame shape change.</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// rotate nose cone to match tube</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">currentAngle_deg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">noseCone_2d_m</span><span class="p">[</span><span class="mf">2</span><span class="p">].</span><span class="nx">get_angle</span><span class="p">();</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">targetAngle_deg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">rel_position_2d_m</span><span class="p">.</span><span class="nx">get_angle</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">180</span><span class="p">;</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">rotateShape</span><span class="p">(</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">noseCone_2d_m</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">targetAngle_deg</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">currentAngle_deg</span><span class="p">));</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Draw nose cone at the opposite side of the puck from the jet tube.</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">offset_2d_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">rel_position_2d_m</span><span class="p">);</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">noseConeShape_2d_px</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">displaceShapeForRendering</span><span class="p">(</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">noseCone_2d_m</span><span class="p">,</span><span class="w"> </span><span class="nx">offset_2d_m</span><span class="p">);</span>
<span class="w">      </span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">lightColors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">hC</span><span class="p">.</span><span class="nx">clientLightColors</span><span class="p">;</span><span class="w"> </span><span class="c1">// an array</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">fillColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nx">lightColors</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">tube_color</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;black&#39;</span><span class="o">:</span><span class="s1">&#39;white&#39;</span><span class="p">;</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">drawPolygon</span><span class="p">(</span><span class="w"> </span><span class="nx">drawingContext</span><span class="p">,</span><span class="w"> </span><span class="nx">noseConeShape_2d_px</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;borderColor&#39;</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">tube_color</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;borderWidth_px&#39;</span><span class="o">:</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;fillColor&#39;</span><span class="o">:</span><span class="nx">fillColor</span><span class="p">}</span><span class="w"> </span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="nx">Jet</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">update</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">deltaT_s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Note, for NPC clients, orientation is established in the clients thinkForNPC method.</span>
<span class="w">      </span><span class="c1">// rotateJetAndScaleFlameToThis is called there to point the jet in the direction opposite to the navigation-spring force.</span>
<span class="w">      </span><span class="c1">// Jet flame is always on for NPCs (unless floating free from navigational track).</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Jet flame is controlled to be on/off for human (non NPC) users</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">3</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;NPC&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="c1">// Respond to client controls to rotate the Tube and Jet.</span>
<span class="w">         </span><span class="k">this</span><span class="p">.</span><span class="nx">rotateJetByClient</span><span class="p">(</span><span class="w"> </span><span class="nx">deltaT_s</span><span class="p">);</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// Fire the jet flame: if on (w key down), draw it, and calculate jet forces.</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">key_w</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;D&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">jet_force_2d_N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">rel_position_2d_m</span><span class="p">.</span><span class="nx">scaleBy</span><span class="p">(</span><span class="w"> </span><span class="o">-</span><span class="k">this</span><span class="p">.</span><span class="nx">jet_force_N</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">throttle</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">length_m</span><span class="p">);</span>
<span class="w">            </span><span class="c1">// Set the length of the jet flame to be proportional to the strength of the jet.</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="nx">rotateJetAndScaleFlameToThis</span><span class="p">(</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">jet_force_2d_N</span><span class="p">.</span><span class="nx">scaleBy</span><span class="p">(</span><span class="o">-</span><span class="mf">1</span><span class="p">));</span>
<span class="w">            </span><span class="c1">// If the jet is used, reset the rotation event counter.</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="nx">rotationCounter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">jet_force_2d_N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">rel_position_2d_m</span><span class="p">.</span><span class="nx">scaleBy</span><span class="p">(</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="nx">Jet</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">draw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">drawingContext</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">3</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;NPC&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">editor</span><span class="p">.</span><span class="nx">checked</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">disableJet</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="nx">drawTube</span><span class="p">(</span><span class="w"> </span><span class="nx">drawingContext</span><span class="p">);</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="nx">drawFlame</span><span class="p">(</span><span class="w"> </span><span class="nx">drawingContext</span><span class="p">);</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">      </span><span class="c1">// Jet flame is controlled to be on/off for human (non NPC) users</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="c1">// Always draw the tube and nose cone.</span>
<span class="w">         </span><span class="k">this</span><span class="p">.</span><span class="nx">drawTube</span><span class="p">(</span><span class="w"> </span><span class="nx">drawingContext</span><span class="p">);</span>
<span class="w">         </span><span class="k">this</span><span class="p">.</span><span class="nx">drawNoseCone</span><span class="p">(</span><span class="w"> </span><span class="nx">drawingContext</span><span class="p">);</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// Fire the jet flame: if on (w key down), draw it, and calculate jet forces.</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">key_w</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;D&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="nx">drawFlame</span><span class="p">(</span><span class="w"> </span><span class="nx">drawingContext</span><span class="p">);</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">Gun</span><span class="p">(</span><span class="w"> </span><span class="nx">puck</span><span class="p">,</span><span class="w"> </span><span class="nx">pars</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">Tube</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="nx">puck</span><span class="p">,</span><span class="w"> </span><span class="nx">pars</span><span class="p">);</span><span class="w"> </span><span class="c1">// Inherit attributes from Tube (see details in Jet)</span>
<span class="w">      </span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">tube_color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span><span class="w"> </span><span class="nx">pars</span><span class="p">.</span><span class="nx">tube_color</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;white&#39;</span><span class="p">);</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Add properties specific to Gun.</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">width_m</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mf">0.17</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">radius_m</span><span class="p">;</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">height_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.00</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">radius_m</span><span class="p">;</span>

<span class="w">      </span><span class="c1">// This overrides the rotationRate_dps inherited from the tube.</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">rotationRate_dps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">90.0</span><span class="p">;</span><span class="w"> </span><span class="c1">//1.5dpf</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">bulletSpeed_mps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">7.0</span><span class="p">;</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">bulletCountLimit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">5</span><span class="p">;</span>
<span class="w">      </span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">bulletWaitTimer_ms</span><span class="p">;</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">timeBetweenBullets_ms</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">70</span><span class="p">;</span><span class="w"> </span><span class="c1">//70</span>
<span class="w">      </span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">rayCastLineLength_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pars</span><span class="p">.</span><span class="nx">rayCastLineLength_m</span><span class="p">;</span><span class="w"> </span><span class="c1">//always provided when a new gun is made for the host&#39;s puck.</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">rayCast_init_deg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span><span class="w"> </span><span class="nx">pars</span><span class="p">.</span><span class="nx">rayCast_init_deg</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">);</span>
<span class="w">      </span><span class="c1">// Orient this along the x-axis, zero degrees.</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">rayCastLine_2d_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">rayCastLineLength_m</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">rayCastLine_2d_m</span><span class="p">.</span><span class="nx">rotated_by</span><span class="p">(</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">rayCast_init_deg</span><span class="p">);</span>
<span class="w">      </span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">rayRotationRate_dps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span><span class="w"> </span><span class="nx">pars</span><span class="p">.</span><span class="nx">rayRotationRate_dps</span><span class="p">,</span><span class="w"> </span><span class="mf">80</span><span class="p">);</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">scanning</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span><span class="w"> </span><span class="nx">pars</span><span class="p">.</span><span class="nx">scanning</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">rayBody</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">angleToFoundPuck</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Attributes controlled only by the Two Thumbs interface (not the keyboard).</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">scopeRotRateFrac</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">scopeTrigger</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;U&#39;</span><span class="p">;</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">scopeBreak</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">breakTimer_ms</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">breakTimer_limit_ms</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">100</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="nx">Gun</span><span class="p">.</span><span class="nx">prototype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="w"> </span><span class="nx">Tube</span><span class="p">.</span><span class="nx">prototype</span><span class="p">);</span><span class="w"> </span><span class="c1">// Inherit methods from Tube.</span>
<span class="w">   </span><span class="nx">Gun</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="kr">constructor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Gun</span><span class="p">;</span><span class="w"> </span><span class="c1">// Reset the constructor name back to Gun</span>
<span class="w">   </span><span class="c1">// Define any new methods for Gun.</span>
<span class="w">   </span><span class="nx">Gun</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">rotateGunByClient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">deltaT_s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// The Rate, degrees per frame (dpf), gives the degrees of rotation in one frame.</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Left/Right pointing control using the keyboard</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">key_l</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;D&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">key_alt</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s2">&quot;D&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">key_ctrl</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s2">&quot;D&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="k">this</span><span class="p">.</span><span class="nx">rotateTube</span><span class="p">(</span><span class="o">-</span><span class="k">this</span><span class="p">.</span><span class="nx">rotationRate_dps</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">deltaT_s</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">key_j</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;D&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="k">this</span><span class="p">.</span><span class="nx">rotateTube</span><span class="p">(</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">rotationRate_dps</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">deltaT_s</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Similar, but using the Two-Thumbs interface.</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">scopeRotRateFrac</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="k">this</span><span class="p">.</span><span class="nx">rotateTube</span><span class="p">((</span><span class="o">-</span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">rotationRate_dps</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">scopeRotRateFrac</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">deltaT_s</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">key_k</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;D&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">key_k_enabled</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">key_shift</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;D&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="nx">rotateTube</span><span class="p">(</span><span class="o">+</span><span class="mf">90.0</span><span class="p">);</span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="nx">rotateTube</span><span class="p">(</span><span class="o">-</span><span class="mf">90.0</span><span class="p">);</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">         </span>
<span class="w">         </span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">key_k_enabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">key_k</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;U&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">key_k_enabled</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">key_k_enabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="nx">Gun</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">fireBullet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">      </span>
<span class="w">      </span><span class="c1">// The bullet velocity as seen from the puck (dividing by length produces a normalized vector)</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">relativeVel_2D_mps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">rel_position_2d_m</span><span class="p">.</span><span class="nx">scaleBy</span><span class="p">(</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">bulletSpeed_mps</span><span class="o">/</span><span class="k">this</span><span class="p">.</span><span class="nx">length_m</span><span class="p">);</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Absolute velocity of bullet as seen from the world.</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">absoluteVel_2D_mps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">relativeVel_2D_mps</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">velocity_2d_mps</span><span class="p">);</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Setting bullet friction, to be near 0.0, and bullet restitution, to be near 1.0, </span>
<span class="w">      </span><span class="c1">// gives simple and symmetric collision behavior when the bullets hit the walls.</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Set the group index of the bullets to equal the negative value assigned by default to the</span>
<span class="w">      </span><span class="c1">// host puck. That will prevent bullets (from this gun) from colliding with each other and the host puck.</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Note that the target-leading algorithm for the NPCs is more accurate if you use puck.position_2d_m as compared to end_2d_m (tube end).</span>
<span class="w">      </span><span class="c1">// So, for NPC clients, this will fire the bullet (to fly free) starting from the base of the tube not starting from the end of the tube.</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">3</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;NPC&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">cannibalize</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">bulletStartPosition_2d_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">bulletStartPosition_2d_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">end_2d_m</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Don&#39;t allow shots if cannibalized down to the minimum puck size.</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">cannibalize</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">radius_px</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">cP</span><span class="p">.</span><span class="nx">Puck</span><span class="p">.</span><span class="nx">minRadius_px</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span>
<span class="w">         </span><span class="c1">// Make this bullet with the same groupIndex as the host puck (so no collisions with the host).</span>
<span class="w">         </span><span class="kd">let</span><span class="w"> </span><span class="nx">bulletAgeLimit_ms</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">bulletAgeLimit_ms</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">bulletAgeLimit_ms</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">m_bulletAgeLimit_ms</span><span class="p">;</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">bullet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">cP</span><span class="p">.</span><span class="nx">Puck</span><span class="p">(</span><span class="w"> </span><span class="nx">bulletStartPosition_2d_m</span><span class="p">,</span><span class="w"> </span><span class="nx">absoluteVel_2D_mps</span><span class="p">,</span><span class="w"> </span>
<span class="w">            </span><span class="p">{</span><span class="s1">&#39;radius_m&#39;</span><span class="o">:</span><span class="mf">0.04</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;bullet&#39;</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;color&#39;</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">color</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;colorSource&#39;</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;borderWidth_px&#39;</span><span class="o">:</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;clientNameOfShooter&#39;</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span><span class="w"> </span>
<span class="w">             </span><span class="s1">&#39;ageLimit_ms&#39;</span><span class="o">:</span><span class="nx">bulletAgeLimit_ms</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;restitution_fixed&#39;</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;restitution&#39;</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">bullet_restitution</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;friction_fixed&#39;</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;friction&#39;</span><span class="o">:</span><span class="mf">0.0</span><span class="p">,</span>
<span class="w">             </span><span class="s1">&#39;groupIndex&#39;</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">groupIndex</span><span class="p">});</span>
<span class="w">         </span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">cannibalize</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="cm">/*</span>
<span class="cm">            The mass of the host puck can be reduced to account for creating and launching the bullet.</span>
<span class="cm">            Area = Pi * r^2;</span>
<span class="cm">            r_host = (A_host/Pi) ^ 0.5;</span>
<span class="cm">            */</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="nx">area_host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">radius_m</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="nx">area_bullet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="w"> </span><span class="nx">bullet</span><span class="p">.</span><span class="nx">radius_m</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="nx">r_host_after</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="w"> </span><span class="p">((</span><span class="nx">area_host</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">area_bullet</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="p">),</span><span class="w"> </span><span class="mf">0.5</span><span class="p">);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="nx">radius_scaling_factor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">r_host_after</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">radius_m</span><span class="p">;</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">interpret_editCommand</span><span class="p">(</span><span class="s1">&#39;thinner&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">radius_scaling_factor</span><span class="p">);</span><span class="w"> </span><span class="c1">// yes, thinner will reduce the radius</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// Calculate the recoil impulse from firing the gun (opposite the direction of the bullet).</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">scopeTrigger</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;U&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">noRecoil</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">impulse_2d_Ns</span><span class="p">.</span><span class="nx">addTo</span><span class="p">(</span><span class="w"> </span><span class="nx">relativeVel_2D_mps</span><span class="p">.</span><span class="nx">scaleBy</span><span class="p">(</span><span class="o">-</span><span class="mf">1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">bullet</span><span class="p">.</span><span class="nx">mass_kg</span><span class="p">));</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="nx">Gun</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">start_BulletStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">bulletCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">bulletStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;on&#39;</span><span class="p">;</span>
<span class="w">      </span><span class="c1">// This allows the gun to immediately fire the first bullet.</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">bulletWaitTimer_ms</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="nx">Gun</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">stop_BulletStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">bulletStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;off&#39;</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="nx">Gun</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">update_BulletStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">deltaT_s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// If ok to fire, do so.</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">bulletStream</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;on&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>
<span class="w">           </span><span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">bulletWaitTimer_ms</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">timeBetweenBullets_ms</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">bulletWaitTimer_ms</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0.0</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>
<span class="w">           </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">bulletCount</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">bulletCountLimit</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// If the shields are down.</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">shield</span><span class="p">.</span><span class="nx">ON</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="nx">fireBullet</span><span class="p">();</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">         </span><span class="c1">// Reset the timer.</span>
<span class="w">         </span><span class="k">this</span><span class="p">.</span><span class="nx">bulletWaitTimer_ms</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">         </span><span class="k">this</span><span class="p">.</span><span class="nx">bulletCount</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">bulletWaitTimer_ms</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">deltaT_s</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1000</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="nx">Gun</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">drawRayCastLine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">drawingContext</span><span class="p">,</span><span class="w"> </span><span class="nx">deltaT_s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Update the angle of the ray.</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">3</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;NPC&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">scanning</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">m_npcSleep</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="nx">rayCastLine_2d_m</span><span class="p">.</span><span class="nx">rotated_by</span><span class="p">(</span><span class="w"> </span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">rayRotationRate_dps</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">deltaT_s</span><span class="p">);</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="k">this</span><span class="p">.</span><span class="nx">rayCastLine_2d_m</span><span class="p">.</span><span class="nx">matchAngle</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">rel_position_2d_m</span><span class="p">);</span><span class="w"> </span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">ray_end_2d_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">rayCastLine_2d_m</span><span class="p">);</span>

<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">rayBody</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">      </span><span class="c1">// Set an endpoint in case nothing is hit in the raycast.</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">raycast_end_2d_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ray_end_2d_m</span><span class="p">;</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">minFraction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>

<span class="w">      </span><span class="nx">gW</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">world</span><span class="p">.</span><span class="nx">RayCast</span><span class="p">(</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">fixture</span><span class="p">,</span><span class="w"> </span><span class="nx">point</span><span class="p">,</span><span class="w"> </span><span class="nx">outputNormal</span><span class="p">,</span><span class="w"> </span><span class="nx">fraction</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">fixtureBody</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">tableMap</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="w"> </span><span class="nx">fixture</span><span class="p">.</span><span class="nx">GetBody</span><span class="p">());</span>
<span class="w">         </span><span class="cm">/*</span>
<span class="cm">         This &quot;if&quot; block updates the ray cast results only if it finds something closer.</span>
<span class="cm">         I didn&#39;t expect to have to do this when returning &quot;fraction&quot;. But without</span>
<span class="cm">         this block, the callback will run multiple times and the last fixture to run it</span>
<span class="cm">         will determine the point vector. Last object always wins. So this block makes</span>
<span class="cm">         the closest object (along the ray) win out in identifying the fixture and point.</span>
<span class="cm">         */</span>
<span class="w">         </span><span class="kd">let</span><span class="w"> </span><span class="nx">gunBullet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">fixtureBody</span><span class="p">.</span><span class="kr">constructor</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;Puck&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">fixtureBody</span><span class="p">.</span><span class="nx">gunBullet</span><span class="p">();</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="nx">fraction</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">minFraction</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="p">(</span><span class="nx">gunBullet</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="nx">fixtureBody</span><span class="p">.</span><span class="kr">constructor</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;Pin&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">minFraction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">fraction</span><span class="p">,</span><span class="w"> </span><span class="nx">minFraction</span><span class="p">);</span>
<span class="w">            </span><span class="nx">rayBody</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fixtureBody</span><span class="p">;</span>
<span class="w">            </span><span class="nx">raycast_end_2d_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D_from_b2Vec2</span><span class="p">(</span><span class="w"> </span><span class="nx">point</span><span class="p">);</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">         </span><span class="k">return</span><span class="w"> </span><span class="nx">fraction</span><span class="p">;</span>
<span class="w">      </span><span class="p">},</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">b2Vec2_from_Vec2D</span><span class="p">(</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">),</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">b2Vec2_from_Vec2D</span><span class="p">(</span><span class="w"> </span><span class="nx">ray_end_2d_m</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
<span class="w">      </span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">rayBody</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">rayBody</span><span class="p">.</span><span class="kr">constructor</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;Puck&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="c1">// Make a reference to this rayBody on the gun</span>
<span class="w">         </span><span class="k">this</span><span class="p">.</span><span class="nx">rayBody</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">rayBody</span><span class="p">;</span>
<span class="w">         </span><span class="c1">//this.rayBody.color = &#39;green&#39;;</span>
<span class="w">         </span><span class="k">this</span><span class="p">.</span><span class="nx">scanning</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// Point the ray at the center of the found puck.</span>
<span class="w">         </span><span class="k">this</span><span class="p">.</span><span class="nx">angleToFoundPuck</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">rayBody</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">).</span><span class="nx">get_angle</span><span class="p">();</span>
<span class="w">         </span><span class="k">this</span><span class="p">.</span><span class="nx">rayCastLine_2d_m</span><span class="p">.</span><span class="nx">set_angle</span><span class="p">(</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">angleToFoundPuck</span><span class="p">);</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// This time check keeps you from sweeping during the bullet stream. Something about the small bullets</span>
<span class="w">      </span><span class="c1">// and their speed that yields occasional errors from the raycast.</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">NPC_guncooling_timer_s</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">NPC_guncooling_timer_limit_s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="k">this</span><span class="p">.</span><span class="nx">scanning</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">         </span><span class="k">this</span><span class="p">.</span><span class="nx">rayBody</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Draw it.</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">raycast_end_2d_px</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">screenFromWorld</span><span class="p">(</span><span class="w"> </span><span class="nx">raycast_end_2d_m</span><span class="p">);</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">drawLine</span><span class="p">(</span><span class="w"> </span><span class="nx">drawingContext</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">position_2d_px</span><span class="p">,</span><span class="w"> </span><span class="nx">raycast_end_2d_px</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;width_px&#39;</span><span class="o">:</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;color&#39;</span><span class="o">:</span><span class="s1">&#39;yellow&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;dashArray&#39;</span><span class="o">:</span><span class="p">[</span><span class="mf">4</span><span class="p">]});</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="nx">Gun</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">update</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">deltaT_s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Respond to client controls to rotate the Gun.</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">rotateGunByClient</span><span class="p">(</span><span class="w"> </span><span class="nx">deltaT_s</span><span class="p">);</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Fire the gun:</span>
<span class="w">      </span><span class="c1">// This method gets called every frame. If the i key is down, you</span>
<span class="w">      </span><span class="c1">// don&#39;t want it to fire a bullet every frame. The following logic allows one</span>
<span class="w">      </span><span class="c1">// call to fireBullet and then disables the i key. To enable, must release </span>
<span class="w">      </span><span class="c1">// the key to the up position.</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">key_i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;D&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">scopeTrigger</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;D&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">key_i_enabled</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="nx">start_BulletStream</span><span class="p">();</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">key_i_enabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">         </span><span class="k">this</span><span class="p">.</span><span class="nx">update_BulletStream</span><span class="p">(</span><span class="w"> </span><span class="nx">deltaT_s</span><span class="p">);</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// Reseting this counter here allows you to compensate for recoil with the s key (align opposite the motion) </span>
<span class="w">         </span><span class="c1">// then w (some jet).</span>
<span class="w">         </span><span class="k">this</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">jet</span><span class="p">.</span><span class="nx">rotationCounter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">         </span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(((</span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">key_i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;U&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">scopeTrigger</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;U&quot;</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">key_i_enabled</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="k">this</span><span class="p">.</span><span class="nx">stop_BulletStream</span><span class="p">();</span>
<span class="w">         </span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">key_i_enabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="nx">Gun</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">draw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">drawingContext</span><span class="p">,</span><span class="w"> </span><span class="nx">deltaT_s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Always draw the tube.</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">drawTube</span><span class="p">(</span><span class="w"> </span><span class="nx">drawingContext</span><span class="p">);</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Cast and draw ray based on gun orientation.</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">scopeRayOn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">scopeTrigger</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;D&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">scopeRotRateFrac</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">3</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;NPC&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">scopeRayOn</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="k">this</span><span class="p">.</span><span class="nx">drawRayCastLine</span><span class="p">(</span><span class="w"> </span><span class="nx">drawingContext</span><span class="p">,</span><span class="w"> </span><span class="nx">deltaT_s</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// The scope break is a feature of the TwoThumbs virtual game pad.</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">scopeBreak</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">breakTimer_ms</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">breakTimer_limit_ms</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="nx">breakTimer_ms</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="nx">scopeBreak</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="nx">drawCircle</span><span class="p">(</span><span class="w"> </span><span class="nx">drawingContext</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">position_2d_px</span><span class="p">,</span><span class="w"> </span>
<span class="w">               </span><span class="p">{</span><span class="s1">&#39;borderColor&#39;</span><span class="o">:</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;fillColor&#39;</span><span class="o">:</span><span class="s1">&#39;noFill&#39;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                </span><span class="s1">&#39;borderWidth_px&#39;</span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">radius_px</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.2</span><span class="p">,</span>
<span class="w">                </span><span class="s1">&#39;radius_px&#39;</span><span class="o">:</span><span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">radius_px</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1.2</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">);</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="nx">breakTimer_ms</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">deltaT_s</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1000</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span>
<span class="w">   </span>
<span class="w">   </span><span class="c1">// see comments before the &quot;return&quot; section of gwModule.js</span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Objects</span>
<span class="w">      </span><span class="s1">&#39;Shield&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">Shield</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;Jet&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">Jet</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;Gun&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">Gun</span><span class="p">,</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Variables</span>
<span class="w">      </span><span class="s1">&#39;setPlayerCount&#39;</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">m_playerCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">val</span><span class="p">;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="s1">&#39;incrementPlayerCount&#39;</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">m_playerCount</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">val</span><span class="p">;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span>
<span class="w">      </span><span class="s1">&#39;getTeamCount&#39;</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">m_teamCount</span><span class="p">;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="s1">&#39;resetTeams&#39;</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">m_teams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="s1">&#39;getPucksByTypeAtStart&#39;</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">m_pucksByTypeAtStart</span><span class="p">;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span>
<span class="w">      </span><span class="s1">&#39;setNpcCount&#39;</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">m_npcCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">val</span><span class="p">;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="s1">&#39;addToNpcCount&#39;</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">m_npcCount</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">val</span><span class="p">;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span>
<span class="w">      </span><span class="s1">&#39;setPuckPopperTimer_s&#39;</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">t_s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">m_puckPopperTimer_s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">t_s</span><span class="p">;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span>
<span class="w">      </span><span class="s1">&#39;setNpcSleep&#39;</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">m_npcSleep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">val</span><span class="p">;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="s1">&#39;getNpcSleep&#39;</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">m_npcSleep</span><span class="p">;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span>
<span class="w">      </span><span class="s1">&#39;setNpcSleepUsage&#39;</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">m_npcSleepUsage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">val</span><span class="p">;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="s1">&#39;getNpcSleepUsage&#39;</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">m_npcSleepUsage</span><span class="p">;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span>
<span class="w">      </span><span class="s1">&#39;setBulletAgeLimit_ms&#39;</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">m_bulletAgeLimit_ms</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">val</span><span class="p">;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Methods</span>
<span class="w">      </span><span class="s1">&#39;attachNavSpring&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">attachNavSpring</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;makeNPC_OnSinglePin&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">makeNPC_OnSinglePin</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;makeNPC_OnTwoPins&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">makeNPC_OnTwoPins</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;preGameSetUp&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">preGameSetUp</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;thinkForNPC&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">thinkForNPC</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;createPucksForNetworkClients&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">createPucksForNetworkClients</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;gunAngleFromHost&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">gunAngleFromHost</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;jetAngleFromHost&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">jetAngleFromHost</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;deleteOldandUnhealthy&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">deleteOldandUnhealthy</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;checkForPuckPopperWinnerAndReport&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">checkForPuckPopperWinnerAndReport</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;updateTeamInfo&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">updateTeamInfo</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;countTeams&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">countTeams</span>
<span class="w">   </span><span class="p">};</span>

<span class="p">})();</span>
</pre></div>
</body>
</html>
