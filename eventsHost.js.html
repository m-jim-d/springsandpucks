<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">
<!--
generated by Pygments <http://pygments.org>
Copyright 2006-2019 by the Pygments team.
Licensed under the BSD license, see LICENSE for details.
-->
<html>
<head>
  <link rel='canonical' href='https://triquence.org/eventsHost.js.html' />
  <title>eventsHost.js</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <style type="text/css">
/*
generated by Pygments <http://pygments.org>
Copyright 2006-2019 by the Pygments team.
Licensed under the BSD license, see LICENSE for details.
*/
td.linenos { background-color: #f0f0f0; padding-right: 10px; }
span.lineno { background-color: #f0f0f0; padding: 0 5px 0 5px; }
pre { line-height: 125%; }
body .hll { background-color: #ffffcc }
body  { background: #f8f8f8; }
body .c { color: #408080; font-style: italic } /* Comment */
body .err { border: 1px solid #FF0000 } /* Error */
body .k { color: #008000; font-weight: bold } /* Keyword */
body .o { color: #666666 } /* Operator */
body .ch { color: #408080; font-style: italic } /* Comment.Hashbang */
body .cm { color: #408080; font-style: italic } /* Comment.Multiline */
body .cp { color: #BC7A00 } /* Comment.Preproc */
body .cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */
body .c1 { color: #408080; font-style: italic } /* Comment.Single */
body .cs { color: #408080; font-style: italic } /* Comment.Special */
body .gd { color: #A00000 } /* Generic.Deleted */
body .ge { font-style: italic } /* Generic.Emph */
body .gr { color: #FF0000 } /* Generic.Error */
body .gh { color: #000080; font-weight: bold } /* Generic.Heading */
body .gi { color: #00A000 } /* Generic.Inserted */
body .go { color: #888888 } /* Generic.Output */
body .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
body .gs { font-weight: bold } /* Generic.Strong */
body .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
body .gt { color: #0044DD } /* Generic.Traceback */
body .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
body .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
body .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
body .kp { color: #008000 } /* Keyword.Pseudo */
body .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
body .kt { color: #B00040 } /* Keyword.Type */
body .m { color: #666666 } /* Literal.Number */
body .s { color: #BA2121 } /* Literal.String */
body .na { color: #7D9029 } /* Name.Attribute */
body .nb { color: #008000 } /* Name.Builtin */
body .nc { color: #0000FF; font-weight: bold } /* Name.Class */
body .no { color: #880000 } /* Name.Constant */
body .nd { color: #AA22FF } /* Name.Decorator */
body .ni { color: #999999; font-weight: bold } /* Name.Entity */
body .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
body .nf { color: #0000FF } /* Name.Function */
body .nl { color: #A0A000 } /* Name.Label */
body .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
body .nt { color: #008000; font-weight: bold } /* Name.Tag */
body .nv { color: #19177C } /* Name.Variable */
body .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
body .w { color: #bbbbbb } /* Text.Whitespace */
body .mb { color: #666666 } /* Literal.Number.Bin */
body .mf { color: #666666 } /* Literal.Number.Float */
body .mh { color: #666666 } /* Literal.Number.Hex */
body .mi { color: #666666 } /* Literal.Number.Integer */
body .mo { color: #666666 } /* Literal.Number.Oct */
body .sa { color: #BA2121 } /* Literal.String.Affix */
body .sb { color: #BA2121 } /* Literal.String.Backtick */
body .sc { color: #BA2121 } /* Literal.String.Char */
body .dl { color: #BA2121 } /* Literal.String.Delimiter */
body .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
body .s2 { color: #BA2121 } /* Literal.String.Double */
body .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
body .sh { color: #BA2121 } /* Literal.String.Heredoc */
body .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
body .sx { color: #008000 } /* Literal.String.Other */
body .sr { color: #BB6688 } /* Literal.String.Regex */
body .s1 { color: #BA2121 } /* Literal.String.Single */
body .ss { color: #19177C } /* Literal.String.Symbol */
body .bp { color: #008000 } /* Name.Builtin.Pseudo */
body .fm { color: #0000FF } /* Name.Function.Magic */
body .vc { color: #19177C } /* Name.Variable.Class */
body .vg { color: #19177C } /* Name.Variable.Global */
body .vi { color: #19177C } /* Name.Variable.Instance */
body .vm { color: #19177C } /* Name.Variable.Magic */
body .il { color: #666666 } /* Literal.Number.Integer.Long */

  </style>
</head>
<body>
<h2></h2>

<div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm">Copyright 2022 James D. Miller</span>

<span class="cm">Permission is hereby granted, free of charge, to any person obtaining a copy</span>
<span class="cm">of this software and associated documentation files (the &quot;Software&quot;), to deal</span>
<span class="cm">in the Software without restriction, including without limitation the rights</span>
<span class="cm">to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
<span class="cm">copies of the Software, and to permit persons to whom the Software is</span>
<span class="cm">furnished to do so, subject to the following conditions:</span>

<span class="cm">The above copyright notice and this permission notice shall be included in all</span>
<span class="cm">copies or substantial portions of the Software.</span>

<span class="cm">THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="cm">IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="cm">FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
<span class="cm">AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<span class="cm">LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span>
<span class="cm">OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="cm">SOFTWARE.</span>
<span class="cm">*/</span>

<span class="c1">// Events on Host (eV) module</span>
<span class="c1">// eventsHost.js </span>
   <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;eV _*-*_&#39;</span><span class="p">);</span>
<span class="c1">// 10:18 AM Sun December 10, 2023</span>

<span class="cm">/*</span>
<span class="cm">gwModule.js has an alphabetical list of all modules and their nicknames as added to the windows namespace.</span>
<span class="cm">*/</span>

<span class="nb">window</span><span class="p">.</span><span class="nx">eV</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
   <span class="s2">&quot;use strict&quot;</span><span class="p">;</span>
   
   <span class="c1">// Module globals for objects brought in by initializeModule and initializeEventListeners.</span>
   <span class="kd">var</span> <span class="nx">canvas</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">,</span> <span class="nx">dC</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">aT</span><span class="p">,</span> <span class="nx">keyMap</span><span class="p">,</span> <span class="nx">clients</span><span class="p">,</span> <span class="nx">ts</span><span class="p">;</span>
   
   <span class="c1">///////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
   <span class="c1">///////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
   
   <span class="kd">function</span> <span class="nx">initializeModule</span><span class="p">(</span> <span class="nx">gW_canvas</span><span class="p">,</span> <span class="nx">gW_ctx</span><span class="p">,</span> <span class="nx">gW_dC</span><span class="p">,</span> <span class="nx">gW_c</span><span class="p">,</span> <span class="nx">gW_aT</span><span class="p">,</span> <span class="nx">gW_keyMap</span><span class="p">,</span> <span class="nx">gW_clients</span><span class="p">,</span> <span class="nx">gW_ts</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">canvas</span> <span class="o">=</span> <span class="nx">gW_canvas</span><span class="p">;</span>
      <span class="nx">ctx</span> <span class="o">=</span> <span class="nx">gW_ctx</span><span class="p">;</span>
      
      <span class="nx">dC</span> <span class="o">=</span> <span class="nx">gW_dC</span><span class="p">;</span>
      <span class="nx">c</span> <span class="o">=</span> <span class="nx">gW_c</span><span class="p">;</span>
      <span class="nx">aT</span> <span class="o">=</span> <span class="nx">gW_aT</span><span class="p">;</span>     
      <span class="nx">keyMap</span> <span class="o">=</span> <span class="nx">gW_keyMap</span><span class="p">;</span>
      <span class="nx">clients</span> <span class="o">=</span> <span class="nx">gW_clients</span><span class="p">;</span>
      <span class="nx">ts</span> <span class="o">=</span> <span class="nx">gW_ts</span><span class="p">;</span>
      
      <span class="nx">initializeEventListeners</span><span class="p">();</span>
   <span class="p">}</span>
      
   <span class="c1">/////////////////////////////////////////////////////</span>
   <span class="c1">// Event handlers for the host client (user input)</span>
   <span class="c1">/////////////////////////////////////////////////////</span>
   
   <span class="kd">function</span> <span class="nx">wheelEvent_handler</span><span class="p">(</span> <span class="nx">clientName</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">client</span> <span class="o">=</span> <span class="nx">clients</span><span class="p">[</span> <span class="nx">clientName</span><span class="p">];</span>
      
      <span class="c1">// Adjust pool-shot speed value.         </span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">poolShotLocked</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">client</span><span class="p">.</span><span class="nx">poolShotLockedSpeed_mps</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span> <span class="nx">client</span><span class="p">.</span><span class="nx">poolShotLockedSpeed_mps</span><span class="p">);</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">deltaY</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">client</span><span class="p">.</span><span class="nx">poolShotLockedSpeed_mps</span> <span class="o">+=</span> <span class="mf">1.0</span><span class="p">;</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">client</span><span class="p">.</span><span class="nx">poolShotLockedSpeed_mps</span> <span class="o">-=</span> <span class="mf">1.0</span><span class="p">;</span>
         <span class="p">}</span>
         <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">nameString</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;, shot speed locked: [25px Arial,yellow]&quot;</span> <span class="o">+</span> <span class="nx">client</span><span class="p">.</span><span class="nx">poolShotLockedSpeed_mps</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;[base] mps&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
      <span class="p">}</span>
   <span class="p">}</span>
      
   <span class="kd">function</span> <span class="nx">key_ctrl_handler</span><span class="p">(</span> <span class="nx">mode</span><span class="p">,</span> <span class="nx">clientName</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">client</span> <span class="o">=</span> <span class="nx">clients</span><span class="p">[</span> <span class="nx">clientName</span><span class="p">];</span>
      
      <span class="kd">let</span> <span class="nx">messageString</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
      <span class="kd">let</span> <span class="nx">wordForPuck</span> <span class="o">=</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">demoVersion</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;3.d&quot;</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;ball&#39;</span> <span class="o">:</span> <span class="s1">&#39;puck&#39;</span><span class="p">;</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="nx">mode</span> <span class="o">==</span> <span class="s1">&#39;keydown&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">// When ctrl is depressed, set cursor spring attachment point to the original selection point (not COM).</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">)</span> <span class="nx">client</span><span class="p">.</span><span class="nx">cursorSpring</span><span class="p">.</span><span class="nx">spo2_ap_l_2d_m</span> <span class="o">=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">selectionPoint_l_2d_m</span><span class="p">;</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">touchScreenUsage</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">messageString</span> <span class="o">=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">nameString</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; has &quot;</span> <span class="o">+</span> <span class="nx">wordForPuck</span> <span class="o">+</span> <span class="s2">&quot;-in-hand [base,yellow]ON[base]&quot;</span><span class="p">;</span>
         <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">mode</span> <span class="o">==</span> <span class="s1">&#39;keyup&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">touchScreenUsage</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">messageString</span> <span class="o">=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">nameString</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; turned &quot;</span> <span class="o">+</span> <span class="nx">wordForPuck</span> <span class="o">+</span> <span class="s2">&quot;-in-hand [base,yellow]OFF[base]&quot;</span><span class="p">;</span> 
         <span class="p">}</span>
         
         <span class="c1">// Done with the rotation action. Get ready for the next one.</span>
         <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">resetCenter</span><span class="p">();</span>
         
         <span class="k">if</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Release the one-at-a-time choke on direct movement.</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">firstClientDirectMove</span><span class="p">)</span> <span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">firstClientDirectMove</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>          
            
            <span class="c1">// When releasing the ctrl key, change the cursor spring attachment point according to the</span>
            <span class="c1">// COM selection control.</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">dC</span><span class="p">.</span><span class="nx">comSelection</span><span class="p">.</span><span class="nx">checked</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">client</span><span class="p">.</span><span class="nx">cursorSpring</span><span class="p">.</span><span class="nx">spo2_ap_l_2d_m</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
               <span class="nx">client</span><span class="p">.</span><span class="nx">cursorSpring</span><span class="p">.</span><span class="nx">spo2_ap_l_2d_m</span> <span class="o">=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">selectionPoint_l_2d_m</span><span class="p">;</span>
            <span class="p">}</span>
         <span class="p">}</span>
         
         <span class="c1">// Detach the cursor spring. This prevents unintended movement when releasing the control key.</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">key_shift</span> <span class="o">==</span> <span class="s2">&quot;D&quot;</span><span class="p">)</span> <span class="nx">client</span><span class="p">.</span><span class="nx">modifyCursorSpring</span><span class="p">(</span><span class="s1">&#39;detach&#39;</span><span class="p">);</span>
         
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;not good to be in here...&quot;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">messageString</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span> <span class="nx">messageString</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
   <span class="p">}</span>
      
   <span class="kd">function</span> <span class="nx">key_b_handler</span><span class="p">(</span> <span class="nx">clientName</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">client</span> <span class="o">=</span> <span class="nx">clients</span><span class="p">[</span> <span class="nx">clientName</span><span class="p">];</span>
      <span class="kd">let</span> <span class="nx">nameForHelp</span> <span class="o">=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">nameString</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">key_alt</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">gB</span><span class="p">.</span><span class="nx">getTableCapture</span><span class="p">(</span><span class="s1">&#39;previous&#39;</span><span class="p">);</span>
         
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="kd">let</span> <span class="nx">notPool</span> <span class="o">=</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">demoVersion</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;3.d&quot;</span><span class="p">);</span>
         <span class="kd">let</span> <span class="nx">poolWithGravityOn</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">demoVersion</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;3.d&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">g_ON</span><span class="p">)</span> <span class="p">);</span>
         <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">fineMovesState</span> <span class="o">==</span> <span class="s1">&#39;off&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">notPool</span> <span class="o">||</span> <span class="nx">poolWithGravityOn</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">client</span><span class="p">.</span><span class="nx">fineMovesState</span> <span class="o">=</span> <span class="s1">&#39;on&#39;</span><span class="p">;</span>
            <span class="nx">client</span><span class="p">.</span><span class="nx">previousFine_2d_px</span> <span class="o">=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">mouse_2d_px</span><span class="p">;</span>
            <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;lowHelp&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s2">&quot;[base,lightgray]high-res positioning (&quot;</span><span class="o">+</span> <span class="nx">nameForHelp</span> <span class="o">+</span><span class="s2">&quot;): [base,yellow]ON[base]&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
            
         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">fineMovesState</span> <span class="o">==</span> <span class="s1">&#39;on&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">wS</span><span class="p">.</span><span class="nx">exitFineMoves</span><span class="p">(</span> <span class="nx">client</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
            <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;lowHelp&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s2">&quot;[base,lightgray]high-res positioning (&quot;</span><span class="o">+</span> <span class="nx">nameForHelp</span> <span class="o">+</span><span class="s2">&quot;): [base,yellow]OFF[base]&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>
   
   <span class="kd">function</span> <span class="nx">key_c_handler</span><span class="p">(</span> <span class="nx">clientName</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">client</span> <span class="o">=</span> <span class="nx">clients</span><span class="p">[</span> <span class="nx">clientName</span><span class="p">];</span>
      
      <span class="c1">// Center the attachment (or selection) point along the narrowest dimension of the selected object.</span>
      <span class="c1">// And if it&#39;s already centered (from the first alt-c), push the attachment point to the nearest end of the object (the second alt-c).</span>
      <span class="kd">function</span> <span class="nx">centerThePoint</span><span class="p">(</span> <span class="nx">selectedBody</span><span class="p">,</span> <span class="nx">cursorSelected</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">shape</span> <span class="o">!=</span> <span class="s1">&#39;circle&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">let</span> <span class="nx">aspectRatioTarget</span> <span class="o">=</span> <span class="mf">1.01</span><span class="p">;</span>
            
            <span class="kd">let</span> <span class="nx">aspectRatioWH</span> <span class="o">=</span> <span class="nx">selectedBody</span><span class="p">.</span><span class="nx">half_width_m</span> <span class="o">/</span> <span class="nx">selectedBody</span><span class="p">.</span><span class="nx">half_height_m</span><span class="p">;</span>
            <span class="kd">let</span> <span class="nx">helpString</span> <span class="o">=</span> <span class="s2">&quot;centered&quot;</span><span class="p">;</span>
            
            <span class="kd">let</span> <span class="nx">compForCentering</span><span class="p">,</span> <span class="nx">compForPushToEnd</span><span class="p">,</span> <span class="nx">distToEnd_m</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">aspectRatioWH</span> <span class="o">&gt;</span> <span class="nx">aspectRatioTarget</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">compForCentering</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span><span class="p">;</span>
               <span class="nx">compForPushToEnd</span> <span class="o">=</span> <span class="s1">&#39;x&#39;</span><span class="p">;</span>
               <span class="nx">distToEnd_m</span> <span class="o">=</span> <span class="nx">selectedBody</span><span class="p">.</span><span class="nx">half_width_m</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="nx">aspectRatioWH</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="o">/</span><span class="nx">aspectRatioTarget</span><span class="p">))</span> <span class="p">{</span>
               <span class="nx">compForCentering</span> <span class="o">=</span> <span class="s1">&#39;x&#39;</span><span class="p">;</span>
               <span class="nx">compForPushToEnd</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span><span class="p">;</span>
               <span class="nx">distToEnd_m</span> <span class="o">=</span> <span class="nx">selectedBody</span><span class="p">.</span><span class="nx">half_height_m</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
               <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;lowHelp&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s1">&#39;[base,lightgray]Puck must be [base,yellow]rectangular[base,lightgray], not a perfect square.&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">);</span>
               <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
            
            <span class="c1">// push to the nearest end</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">selectionPoint_l_2d_m</span><span class="p">[</span> <span class="nx">compForCentering</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)</span> <span class="p">{</span>
               <span class="kd">let</span> <span class="nx">directionOfPush</span> <span class="o">=</span> <span class="p">(</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">selectionPoint_l_2d_m</span><span class="p">[</span> <span class="nx">compForPushToEnd</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
               <span class="nx">selectedBody</span><span class="p">.</span><span class="nx">selectionPoint_l_2d_m</span><span class="p">[</span> <span class="nx">compForPushToEnd</span><span class="p">]</span> <span class="o">=</span> <span class="nx">directionOfPush</span> <span class="o">*</span> <span class="nx">distToEnd_m</span><span class="p">;</span>
               <span class="c1">//console.log(&quot;inside pushed to the end&quot;);</span>
               <span class="nx">helpString</span> <span class="o">=</span> <span class="s2">&quot;pushed to the end&quot;</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="c1">// center it along the narrowest component</span>
            <span class="nx">selectedBody</span><span class="p">.</span><span class="nx">selectionPoint_l_2d_m</span><span class="p">[</span> <span class="nx">compForCentering</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
            
            <span class="c1">// If client cursor selected, must also update these client attributes.</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">cursorSelected</span><span class="p">)</span> <span class="p">{</span>
               <span class="c1">// push to the nearest end</span>
               <span class="k">if</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">selectionPoint_l_2d_m</span><span class="p">[</span> <span class="nx">compForCentering</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)</span> <span class="p">{</span>
                  <span class="kd">let</span> <span class="nx">directionOfPush</span> <span class="o">=</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">selectionPoint_l_2d_m</span><span class="p">[</span> <span class="nx">compForPushToEnd</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
                  <span class="nx">client</span><span class="p">.</span><span class="nx">cursorSpring</span><span class="p">.</span><span class="nx">spo2_ap_l_2d_m</span><span class="p">[</span> <span class="nx">compForPushToEnd</span><span class="p">]</span> <span class="o">=</span> <span class="nx">directionOfPush</span> <span class="o">*</span> <span class="nx">distToEnd_m</span><span class="p">;</span>
                  <span class="nx">client</span><span class="p">.</span><span class="nx">selectionPoint_l_2d_m</span><span class="p">[</span> <span class="nx">compForPushToEnd</span><span class="p">]</span> <span class="o">=</span> <span class="nx">directionOfPush</span> <span class="o">*</span> <span class="nx">distToEnd_m</span><span class="p">;</span>
                  <span class="nx">helpString</span> <span class="o">=</span> <span class="s2">&quot;pushed to the end&quot;</span><span class="p">;</span>
               <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                  <span class="nx">helpString</span> <span class="o">=</span> <span class="s2">&quot;centered&quot;</span><span class="p">;</span>
               <span class="p">}</span>
               <span class="c1">// center it along the narrowest component</span>
               <span class="nx">client</span><span class="p">.</span><span class="nx">cursorSpring</span><span class="p">.</span><span class="nx">spo2_ap_l_2d_m</span><span class="p">[</span> <span class="nx">compForCentering</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
               <span class="nx">client</span><span class="p">.</span><span class="nx">selectionPoint_l_2d_m</span><span class="p">[</span> <span class="nx">compForCentering</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
            <span class="p">}</span>
            
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;before help message&quot;</span><span class="p">);</span>
            <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;lowHelp&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s1">&#39;[base,lightgray]attachment points have been [base,yellow]&#39;</span> <span class="o">+</span> <span class="nx">helpString</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">);</span>
         <span class="p">}</span>
      <span class="p">}</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">key_alt</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">let</span> <span class="nx">selectedBody</span> <span class="o">=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">;</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">selectedBody</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">centerThePoint</span><span class="p">(</span> <span class="nx">selectedBody</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
            
         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span> <span class="nx">msObject</span> <span class="p">=&gt;</span> <span class="p">{</span>
               <span class="c1">// Don&#39;t do push-to-the-end operations on points intended to remain at the center.</span>
               <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">msObject</span><span class="p">.</span><span class="nx">selectionPoint_l_2d_m</span><span class="p">.</span><span class="nx">zeroLength</span><span class="p">())</span> <span class="nx">centerThePoint</span><span class="p">(</span> <span class="nx">msObject</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
            <span class="p">});</span>
         <span class="p">}</span>
         
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="c1">// All clients can change the COM selection checkbox.</span>
         <span class="nx">dC</span><span class="p">.</span><span class="nx">comSelection</span><span class="p">.</span><span class="nx">click</span><span class="p">();</span>  <span class="c1">// if (clientName == &#39;local&#39;) dC.comSelection.click();</span>
      <span class="p">}</span>
   <span class="p">}</span>
      
   <span class="kd">function</span> <span class="nx">key_l_handler</span><span class="p">(</span> <span class="nx">mode</span><span class="p">,</span> <span class="nx">clientName</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">client</span> <span class="o">=</span> <span class="nx">clients</span><span class="p">[</span> <span class="nx">clientName</span><span class="p">];</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="nx">mode</span> <span class="o">==</span> <span class="s1">&#39;keydown&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">((</span><span class="nx">client</span><span class="p">.</span><span class="nx">key_ctrl</span> <span class="o">==</span> <span class="s2">&quot;D&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">key_shift</span> <span class="o">==</span> <span class="s2">&quot;D&quot;</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">client</span><span class="p">.</span><span class="nx">ctrlShiftLock</span> <span class="o">=</span> <span class="o">!</span><span class="nx">client</span><span class="p">.</span><span class="nx">ctrlShiftLock</span><span class="p">;</span>
            <span class="kd">let</span> <span class="nx">mS</span> <span class="o">=</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">ctrlShiftLock</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;ON&#39;</span><span class="o">:</span><span class="s1">&#39;OFF&#39;</span><span class="p">;</span>
            <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span> <span class="nx">clients</span><span class="p">[</span> <span class="nx">clientName</span><span class="p">].</span><span class="nx">nameString</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39; set ctrl-shift LOCK [base,yellow]&#39;</span> <span class="o">+</span> <span class="nx">mS</span> <span class="o">+</span> <span class="s1">&#39;[base]&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
         
         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">key_ctrl</span> <span class="o">==</span> <span class="s2">&quot;D&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">key_alt</span> <span class="o">==</span> <span class="s2">&quot;D&quot;</span><span class="p">)</span> <span class="p">{</span>
               <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">cP</span><span class="p">.</span><span class="nx">EpL</span><span class="p">.</span><span class="nx">displayReport</span><span class="p">)</span> <span class="nx">cP</span><span class="p">.</span><span class="nx">EpL</span><span class="p">.</span><span class="nx">turnDisplayOn</span><span class="p">();</span>
               <span class="nx">cP</span><span class="p">.</span><span class="nx">EpL</span><span class="p">.</span><span class="nx">reportType</span> <span class="o">=</span> <span class="p">(</span><span class="nx">cP</span><span class="p">.</span><span class="nx">EpL</span><span class="p">.</span><span class="nx">reportType</span> <span class="o">==</span> <span class="s2">&quot;EpL&quot;</span><span class="p">)</span> <span class="o">?</span> <span class="s2">&quot;speed&quot;</span><span class="o">:</span><span class="s2">&quot;EpL&quot;</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
               <span class="nx">cP</span><span class="p">.</span><span class="nx">EpL</span><span class="p">.</span><span class="nx">toggle</span><span class="p">();</span>
            <span class="p">}</span>
         
         <span class="c1">// alt-l, alt-shift-l : useful in ghost-ball for lining up trick shots</span>
         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">key_alt</span> <span class="o">==</span> <span class="s2">&quot;D&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">key_shift</span> <span class="o">==</span> <span class="s2">&quot;D&quot;</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">tA</span><span class="p">.</span><span class="nx">tableActions</span><span class="p">(</span><span class="s1">&#39;arc-selected-pucks&#39;</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
               <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">align</span><span class="p">();</span>
            <span class="p">}</span>
         <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">mode</span> <span class="o">==</span> <span class="s1">&#39;keyup&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;not good to be in here...&quot;</span><span class="p">);</span>
      <span class="p">}</span>
   <span class="p">}</span>
   
   <span class="kd">function</span> <span class="nx">key_n_handler</span><span class="p">(</span> <span class="nx">clientName</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">client</span> <span class="o">=</span> <span class="nx">clients</span><span class="p">[</span> <span class="nx">clientName</span><span class="p">];</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">key_alt</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">gB</span><span class="p">.</span><span class="nx">getTableCapture</span><span class="p">(</span><span class="s1">&#39;next&#39;</span><span class="p">);</span>
         
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">clientName</span> <span class="o">==</span> <span class="s1">&#39;local&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">dC</span><span class="p">.</span><span class="nx">fullCanvas</span><span class="p">.</span><span class="nx">click</span><span class="p">();</span>
      <span class="p">}</span>
   <span class="p">}</span>
     
   <span class="kd">function</span> <span class="nx">resetMouseOrFingerState</span><span class="p">(</span> <span class="nx">clientName</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">client</span> <span class="o">=</span> <span class="nx">clients</span><span class="p">[</span> <span class="nx">clientName</span><span class="p">];</span>
      
      <span class="nx">client</span><span class="p">.</span><span class="nx">mouseDown</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="nx">client</span><span class="p">.</span><span class="nx">button</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>         
      <span class="nx">client</span><span class="p">.</span><span class="nx">mouseX_m</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="nx">client</span><span class="p">.</span><span class="nx">mouseY_m</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>  
   <span class="p">}</span>
   
   <span class="kd">function</span> <span class="nx">mouseUp_handler</span><span class="p">(</span> <span class="nx">clientName</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">resetMouseOrFingerState</span><span class="p">(</span> <span class="nx">clientName</span><span class="p">);</span>
      
      <span class="kd">var</span> <span class="nx">client</span> <span class="o">=</span> <span class="nx">clients</span><span class="p">[</span> <span class="nx">clientName</span><span class="p">];</span>
      
      <span class="kd">var</span> <span class="nx">selectedPuckName</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">// If you&#39;re the owner of direct movement, remember the puck name, so can release the choke (after the pool shot).</span>
         <span class="k">if</span> <span class="p">((</span><span class="nx">client</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">firstClientDirectMove</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;Puck&quot;</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">selectedPuckName</span> <span class="o">=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
         <span class="p">}</span>
         <span class="c1">// This used to discriminate against dropping the puck over the hoop.</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoVersion</span><span class="p">().</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;basketball&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;Puck&quot;</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">bpH</span><span class="p">.</span><span class="nx">resetShotState</span><span class="p">({</span><span class="s1">&#39;clientName&#39;</span><span class="o">:</span><span class="nx">client</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="s1">&#39;puckName&#39;</span><span class="o">:</span><span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> 
                                <span class="s1">&#39;puck_pos_2d_m&#39;</span><span class="o">:</span><span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">,</span>  <span class="s1">&#39;puck_v_2d_mps&#39;</span><span class="o">:</span><span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">velocity_2d_mps</span><span class="p">});</span>
         <span class="p">}</span>
      <span class="p">}</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">cursorSpring</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">// Shoot the (single-selected) puck with the cursor spring energy.</span>
         <span class="kd">var</span> <span class="nx">tryingToShoot</span> <span class="o">=</span> <span class="p">((</span><span class="nx">client</span><span class="p">.</span><span class="nx">key_ctrl</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">key_shift</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">ctrlShiftLock</span><span class="p">);</span>
         <span class="k">if</span> <span class="p">((</span><span class="nx">tryingToShoot</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s1">&#39;Puck&#39;</span><span class="p">)</span> <span class="p">{</span>
               <span class="c1">// This restriction on shooting is a way for the user to NOT shoot (cancel a shot):</span>
               <span class="c1">//    move the cursor inside the &quot;cue&quot; ball before launching it.</span>
               <span class="kd">var</span> <span class="nx">selected_b2d_Body</span> <span class="o">=</span> <span class="nx">bS</span><span class="p">.</span><span class="nx">b2d_getBodyAt</span><span class="p">(</span> <span class="nx">client</span><span class="p">.</span><span class="nx">mouse_2d_m</span><span class="p">);</span>
               <span class="kd">var</span> <span class="nx">selectedBody</span> <span class="o">=</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">tableMap</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="nx">selected_b2d_Body</span><span class="p">);</span>
               <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">resetMessage</span><span class="p">();</span> <span class="c1">// stop the help for experienced pool players</span>
               <span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="nx">selectedBody</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="nx">selectedBody</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">name</span> <span class="o">!=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">name</span><span class="p">)))</span> <span class="p">{</span>
                  
                  <span class="c1">// Only the first client to select the puck for direct movement (i.e. rotation) can shoot.</span>
                  <span class="k">if</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">firstClientDirectMove</span><span class="p">)</span> <span class="p">{</span>
                     <span class="k">if</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">cursorSpring</span><span class="p">.</span><span class="nx">p1p2_separation_m</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">gB</span><span class="p">.</span><span class="nx">poolShot</span><span class="p">(</span> <span class="nx">client</span><span class="p">);</span>
                        
                        <span class="c1">// delete the platform walls in the Monkey Hunt game</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">demoVersion</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;4.e&#39;</span><span class="p">)</span> <span class="nx">mH</span><span class="p">.</span><span class="nx">deleteMonkeyWalls</span><span class="p">();</span>
                        
                     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s2">&quot;shot prevented:&quot;</span> <span class="o">+</span> 
                                                 <span class="s2">&quot;\\    not enough separation between the ghost and cue ball (touching, or nearly so)&quot;</span> <span class="o">+</span>
                                              <span class="s2">&quot;\\ \\    Try moving the ghost to the other side of the object ball before shooting&quot;</span> <span class="o">+</span>
                                                 <span class="s2">&quot;\\       or try dragging the ghost away from the object ball and then shoot with the alt key down.&quot;</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">);</span>         
                     <span class="p">}</span>
                  <span class="p">}</span>
               <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                  <span class="c1">// report if not ball-in-hand</span>
                  <span class="k">if</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">key_ctrl</span> <span class="o">!=</span> <span class="s1">&#39;D&#39;</span><span class="p">)</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s2">&quot;shot canceled&quot;</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">);</span>          
               <span class="p">}</span>
            <span class="p">}</span>
         <span class="p">}</span>
         <span class="nx">client</span><span class="p">.</span><span class="nx">modifyCursorSpring</span><span class="p">(</span><span class="s1">&#39;detach&#39;</span><span class="p">);</span>
         
         <span class="nx">client</span><span class="p">.</span><span class="nx">fineMovesState</span> <span class="o">=</span> <span class="s1">&#39;off&#39;</span><span class="p">;</span>
      
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="c1">// Reset fine-moves if mouse and fingers are up.</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">fineMovesState</span> <span class="o">==</span> <span class="s1">&#39;on&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">wS</span><span class="p">.</span><span class="nx">exitFineMoves</span><span class="p">(</span> <span class="nx">client</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
         <span class="p">}</span>
      <span class="p">}</span>
      
      <span class="c1">// Now, after possibly shooting the puck (and detaching from it), release the direct-move choke.</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">aT</span><span class="p">.</span><span class="nx">puckMap</span><span class="p">[</span> <span class="nx">selectedPuckName</span><span class="p">])</span> <span class="p">{</span>
         <span class="nx">aT</span><span class="p">.</span><span class="nx">puckMap</span><span class="p">[</span> <span class="nx">selectedPuckName</span><span class="p">].</span><span class="nx">firstClientDirectMove</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="p">}</span>
      
      <span class="c1">// Close the selection box.</span>
      <span class="nx">gW</span><span class="p">.</span><span class="nx">hostSelectBox</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
      
      <span class="c1">// Done with rotation action.</span>
      <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">resetCenter</span><span class="p">();</span>
      
      <span class="c1">// just to sure, clear out the cursor sensor</span>
      <span class="nx">client</span><span class="p">.</span><span class="nx">sensorTargetName</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="nx">client</span><span class="p">.</span><span class="nx">sensorContact</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
   <span class="p">}</span>
   
   <span class="kd">function</span> <span class="nx">handleMouseOrTouchMove</span><span class="p">(</span> <span class="nx">e</span><span class="p">,</span> <span class="nx">fromListener</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Mouse</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">clientX</span> <span class="o">||</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">clientX</span> <span class="o">===</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>  <span class="c1">// note the &quot;=== 0&quot; here, because x can be zero, and 0 is falsy.</span>
         <span class="kd">var</span> <span class="nx">raw_2d_px</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span> <span class="nx">e</span><span class="p">.</span><span class="nx">clientX</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">clientY</span> <span class="p">);</span>
      <span class="c1">// Touch</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">touches</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">var</span> <span class="nx">raw_2d_px</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span> <span class="nx">e</span><span class="p">.</span><span class="nx">touches</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">clientX</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">touches</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">clientY</span> <span class="p">);</span> <span class="c1">// new wS.Vec2D(0,0);            </span>
         <span class="nx">gB</span><span class="p">.</span><span class="nx">interpretTouches</span><span class="p">(</span> <span class="nx">e</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;startOrEnd&#39;</span><span class="o">:</span><span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="s1">&#39;hostOrClient&#39;</span><span class="o">:</span><span class="s1">&#39;host&#39;</span><span class="p">,</span> <span class="s1">&#39;cl&#39;</span><span class="o">:</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">],</span> <span class="s1">&#39;socket&#39;</span><span class="o">:</span><span class="kc">null</span><span class="p">,</span> 
                                  <span class="s1">&#39;fromListener&#39;</span><span class="o">:</span><span class="nx">fromListener</span><span class="p">,</span> <span class="s1">&#39;mK&#39;</span><span class="o">:</span><span class="kc">null</span><span class="p">,</span> <span class="s1">&#39;ts&#39;</span><span class="o">:</span><span class="nx">ts</span><span class="p">,</span> <span class="s1">&#39;raw_2d_px&#39;</span><span class="o">:</span><span class="nx">raw_2d_px</span><span class="p">,</span> <span class="s1">&#39;demoVersionOnHost&#39;</span><span class="o">:</span><span class="nx">c</span><span class="p">.</span><span class="nx">demoVersion</span><span class="p">}</span> <span class="p">);</span>
      <span class="p">}</span>
      
      <span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">raw_2d_px</span> <span class="o">=</span> <span class="nx">raw_2d_px</span><span class="p">;</span>
      
      <span class="c1">//var debugString = &quot;in handler:&quot; + raw_2d_px.x + &quot;,&quot; + raw_2d_px.y;</span>
      <span class="c1">//hC.sendSocketControlMessage( {&#39;from&#39;:&#39;anyone&#39;, &#39;to&#39;:&#39;host&#39;, &#39;data&#39;:{&#39;androidDebug&#39;:{&#39;value&#39;:true,&#39;debugString&#39;:debugString}} } );</span>
      
      <span class="c1">// Always use &#39;mouse&#39; for inputDevice, and avoid the stretching of the x,y (call to stretchRaw_px inside of wS.screenFromRaw_2d_px), </span>
      <span class="c1">// which is mainly useful for cell-phone network clients.</span>
      <span class="kd">var</span> <span class="nx">posOnCanvas_2d_px</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">screenFromRaw_2d_px</span><span class="p">(</span> <span class="nx">canvas</span><span class="p">,</span> <span class="nx">raw_2d_px</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;inputDevice&#39;</span><span class="o">:</span><span class="s1">&#39;mouse&#39;</span><span class="p">,</span> <span class="s1">&#39;demoRunningOnHost&#39;</span><span class="o">:</span><span class="nx">c</span><span class="p">.</span><span class="nx">demoVersion</span><span class="p">});</span>
      
      <span class="c1">// facilitate high-resolution cursor movements</span>
      <span class="kd">var</span> <span class="nx">finalPosOnCanvas_2d_px</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">fineMoves</span><span class="p">(</span><span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="nx">posOnCanvas_2d_px</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">fineMovesState</span> <span class="o">!=</span> <span class="s1">&#39;inTransition&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">mouse_async_2d_px</span> <span class="o">=</span> <span class="nx">finalPosOnCanvas_2d_px</span><span class="p">;</span>
         <span class="c1">// You might think this circle would render more frequently than the cursor in the animation loop. However the browser forces</span>
         <span class="c1">// the mouse events to coalesces with requestAnimationFrame (see discussion at the beginning of the animation loop in gwModule.js).          </span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">lagTesting</span><span class="p">)</span> <span class="nx">dF</span><span class="p">.</span><span class="nx">drawCircle</span><span class="p">(</span> <span class="nx">ctx</span><span class="p">,</span> <span class="nx">finalPosOnCanvas_2d_px</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;borderWidth_px&#39;</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;fillColor&#39;</span><span class="o">:</span><span class="s1">&#39;cyan&#39;</span><span class="p">,</span> <span class="s1">&#39;radius_px&#39;</span><span class="o">:</span><span class="mi">3</span><span class="p">});</span>
      <span class="p">}</span>
   <span class="p">}</span>
               
   <span class="kd">function</span> <span class="nx">pasteSpring</span><span class="p">(</span> <span class="nx">useNewSpring</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">pars</span><span class="o">=</span><span class="p">{})</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">fixedLength</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">fixedLength</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
      
      <span class="c1">// p (a usefully short name) is an array of non-wall pucks or pins.</span>
      <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span> <span class="nx">msObject</span> <span class="p">=&gt;</span> <span class="p">{</span>
         <span class="c1">// Unselect the walls (don&#39;t allow the user to attach springs to the walls).</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">msObject</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s1">&#39;Wall&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">delete</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">map</span><span class="p">[</span> <span class="nx">msObject</span><span class="p">.</span><span class="nx">name</span><span class="p">];</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// Populate the p array so you can pass the pucks and pins as parameters (see call to copyThisOne).</span>
            <span class="nx">p</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">msObject</span><span class="p">);</span>
         <span class="p">}</span>
      <span class="p">});</span>
      
      <span class="c1">// Only consider the case where there are two pucks (or pins) selected.</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">function</span> <span class="nx">samePointSamePuck</span><span class="p">(</span> <span class="nx">springPuck</span><span class="p">,</span> <span class="nx">springPuckPoint</span><span class="p">,</span> <span class="nx">selectedPuck</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="p">(</span> <span class="nx">springPuckPoint</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span> <span class="nx">selectedPuck</span><span class="p">.</span><span class="nx">selectionPoint_l_2d_m</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">springPuck</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="nx">selectedPuck</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="p">);</span>
         <span class="p">}</span>
         
         <span class="kd">var</span> <span class="nx">sameLocalPointsWarning</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
         <span class="c1">// Check each spring, between these two pucks in the multi-select, to see if trying to paste</span>
         <span class="c1">// onto the same local attachment points of an existing spring (don&#39;t allow multiple springs on the same local points).</span>
         <span class="nx">cP</span><span class="p">.</span><span class="nx">Spring</span><span class="p">.</span><span class="nx">findAll_InMultiSelect</span><span class="p">(</span> <span class="nx">spring</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">((</span> <span class="nx">samePointSamePuck</span><span class="p">(</span> <span class="nx">spring</span><span class="p">.</span><span class="nx">spo1</span><span class="p">,</span> <span class="nx">spring</span><span class="p">.</span><span class="nx">spo1_ap_l_2d_m</span><span class="p">,</span> <span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="o">&amp;&amp;</span>  <span class="nx">samePointSamePuck</span><span class="p">(</span> <span class="nx">spring</span><span class="p">.</span><span class="nx">spo2</span><span class="p">,</span> <span class="nx">spring</span><span class="p">.</span><span class="nx">spo2_ap_l_2d_m</span><span class="p">,</span> <span class="nx">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">)</span> <span class="o">||</span>
                <span class="p">(</span> <span class="nx">samePointSamePuck</span><span class="p">(</span> <span class="nx">spring</span><span class="p">.</span><span class="nx">spo2</span><span class="p">,</span> <span class="nx">spring</span><span class="p">.</span><span class="nx">spo2_ap_l_2d_m</span><span class="p">,</span> <span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="o">&amp;&amp;</span>  <span class="nx">samePointSamePuck</span><span class="p">(</span> <span class="nx">spring</span><span class="p">.</span><span class="nx">spo1</span><span class="p">,</span> <span class="nx">spring</span><span class="p">.</span><span class="nx">spo1_ap_l_2d_m</span><span class="p">,</span> <span class="nx">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
               
               <span class="nx">sameLocalPointsWarning</span> <span class="o">=</span> <span class="nx">spring</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span> <span class="c1">// already on target points</span>
            <span class="p">}</span>
         <span class="p">});</span>
         
         <span class="k">if</span> <span class="p">(</span><span class="nx">useNewSpring</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">sameLocalPointsWarning</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="p">{</span>
               
               <span class="c1">// Attach to the center of pins. (Note the use of copy() to disassociate the new spring from the selection points)</span>
               <span class="kd">let</span> <span class="nx">p0_attachmentPoint_l_2d_m</span> <span class="o">=</span> <span class="p">(</span><span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;Pin&quot;</span><span class="p">)</span> <span class="o">?</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">:</span> <span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">selectionPoint_l_2d_m</span><span class="p">.</span><span class="nx">copy</span><span class="p">();</span>
               <span class="kd">let</span> <span class="nx">p1_attachmentPoint_l_2d_m</span> <span class="o">=</span> <span class="p">(</span><span class="nx">p</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;Pin&quot;</span><span class="p">)</span> <span class="o">?</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">:</span> <span class="nx">p</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">selectionPoint_l_2d_m</span><span class="p">.</span><span class="nx">copy</span><span class="p">();</span>
               
               <span class="k">if</span> <span class="p">(</span><span class="nx">fixedLength</span><span class="p">)</span> <span class="p">{</span>
                  <span class="kd">let</span> <span class="nx">p0_w_2d_m</span> <span class="o">=</span> <span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">worldPoint</span><span class="p">(</span> <span class="nx">p0_attachmentPoint_l_2d_m</span><span class="p">);</span>
                  <span class="kd">let</span> <span class="nx">p1_w_2d_m</span> <span class="o">=</span> <span class="nx">p</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">worldPoint</span><span class="p">(</span> <span class="nx">p1_attachmentPoint_l_2d_m</span><span class="p">);</span>
                  <span class="kd">var</span> <span class="nx">length_m</span> <span class="o">=</span> <span class="nx">p0_w_2d_m</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span> <span class="nx">p1_w_2d_m</span><span class="p">).</span><span class="nx">length</span><span class="p">();</span>
               <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                  <span class="kd">var</span> <span class="nx">length_m</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>
               <span class="p">}</span>
               
               <span class="kd">let</span> <span class="nx">tempSpring</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">cP</span><span class="p">.</span><span class="nx">Spring</span><span class="p">(</span><span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">{</span><span class="s1">&#39;spo1_ap_l_2d_m&#39;</span><span class="o">:</span> <span class="nx">p0_attachmentPoint_l_2d_m</span><span class="p">,</span> <span class="s1">&#39;spo2_ap_l_2d_m&#39;</span><span class="o">:</span> <span class="nx">p1_attachmentPoint_l_2d_m</span><span class="p">,</span> 
                                          <span class="s1">&#39;color&#39;</span><span class="o">:</span><span class="s1">&#39;yellow&#39;</span><span class="p">,</span> <span class="s1">&#39;unstretched_width_m&#39;</span><span class="o">:</span><span class="mf">0.10</span><span class="p">,</span> <span class="s1">&#39;length_m&#39;</span><span class="o">:</span><span class="nx">length_m</span><span class="p">,</span> <span class="s1">&#39;damper_Ns2pm2&#39;</span><span class="o">:</span><span class="mf">0.30</span><span class="p">,</span> <span class="s1">&#39;strength_Npm&#39;</span><span class="o">:</span><span class="mf">10.0</span><span class="p">,</span> <span class="s1">&#39;fixedLength&#39;</span><span class="o">:</span><span class="nx">fixedLength</span><span class="p">});</span>
               <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s1">&#39;Name of the new spring is &#39;</span> <span class="o">+</span> <span class="nx">tempSpring</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">);</span>
               
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
               <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s1">&#39;There is already a spring (&#39;</span> <span class="o">+</span> <span class="nx">sameLocalPointsWarning</span> <span class="o">+</span> <span class="s1">&#39;) on the selected points.&#39;</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">);</span>
            <span class="p">}</span>
         
         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">cP</span><span class="p">.</span><span class="nx">Spring</span><span class="p">.</span><span class="nx">nameForPasting</span> <span class="k">in</span> <span class="nx">aT</span><span class="p">.</span><span class="nx">springMap</span><span class="p">)</span> <span class="p">{</span>
            
            <span class="c1">// Paste a copy of the source spring onto these two selected pucks (or pins).</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">sameLocalPointsWarning</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="p">{</span>
               <span class="kd">var</span> <span class="nx">newSpringName</span> <span class="o">=</span> <span class="nx">aT</span><span class="p">.</span><span class="nx">springMap</span><span class="p">[</span> <span class="nx">cP</span><span class="p">.</span><span class="nx">Spring</span><span class="p">.</span><span class="nx">nameForPasting</span><span class="p">].</span><span class="nx">copyThisOne</span><span class="p">(</span> <span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;pasteSingle&quot;</span><span class="p">);</span>
               
               <span class="c1">// If one of these is a NPC puck and the other a NPC navigation pin, supply the puck attributes needed for navigation.</span>
               <span class="k">if</span> <span class="p">((</span><span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">clientName</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s1">&#39;Puck&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">clientName</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;NPC&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">p</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">NPC</span><span class="p">))</span> <span class="p">{</span>
                  <span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">navSpringName</span> <span class="o">=</span> <span class="nx">newSpringName</span><span class="p">;</span>
                  <span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">pinName</span> <span class="o">=</span> <span class="nx">p</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">name</span><span class="p">;</span>
               <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="nx">p</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">clientName</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">p</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s1">&#39;Puck&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">p</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">clientName</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;NPC&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">NPC</span><span class="p">))</span> <span class="p">{</span>
                  <span class="nx">p</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">navSpringName</span> <span class="o">=</span> <span class="nx">newSpringName</span><span class="p">;</span>
                  <span class="nx">p</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">pinName</span> <span class="o">=</span> <span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">name</span><span class="p">;</span>
               <span class="p">}</span>
               
               <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span> <span class="nx">newSpringName</span><span class="o">+</span><span class="s1">&#39; copied from &#39;</span><span class="o">+</span><span class="nx">cP</span><span class="p">.</span><span class="nx">Spring</span><span class="p">.</span><span class="nx">nameForPasting</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">);</span>
               
               <span class="c1">// De-select the pasted spring (and other selected springs) and its pucks (so the user doesn&#39;t have to click on empty space).</span>
               <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">resetAll</span><span class="p">();</span>
               
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s1">&#39;Pasting onto the same points as another spring is not allowed. \\You may want to try turning off the COM option.&#39;</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">);</span>
            <span class="p">}</span>
            
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s1">&#39;No spring was selected for copying (maybe deleted).&#39;</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">);</span>
            <span class="nx">cP</span><span class="p">.</span><span class="nx">Spring</span><span class="p">.</span><span class="nx">nameForPasting</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
         <span class="p">}</span>
         
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">count</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
         <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s2">&quot;Need 2 pucks/pins to paste a spring; &quot;</span><span class="o">+</span><span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">count</span><span class="p">()</span><span class="o">+</span><span class="s2">&quot; selected&quot;</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">);</span>
      <span class="p">}</span>      
   <span class="p">}</span>
   
   <span class="kd">function</span> <span class="nx">addRevoluteJoint</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">// p (a usefully short name) is an array of pucks. There can be a wall in there too.</span>
         <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="p">[];</span>
         
         <span class="c1">// Check for at least one puck in the pair. Can&#39;t join two walls.</span>
         <span class="kd">let</span> <span class="nx">atLeastOnePuck</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
         <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span> <span class="nx">msObject</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="c1">// Populate the p array so you can pass the pucks as parameters.</span>
            <span class="nx">p</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">msObject</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">msObject</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;Puck&quot;</span><span class="p">)</span> <span class="nx">atLeastOnePuck</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
         <span class="p">});</span>
         
         <span class="c1">// Check to see if these two objects are already connected by a revolute joint.</span>
         <span class="kd">let</span> <span class="nx">p_names</span> <span class="o">=</span> <span class="p">[</span><span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">name</span><span class="p">,</span> <span class="nx">p</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">name</span><span class="p">];</span>
         <span class="kd">let</span> <span class="nx">alreadyJoined</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
         <span class="nx">cP</span><span class="p">.</span><span class="nx">Joint</span><span class="p">.</span><span class="nx">findAll_InMultiSelect</span><span class="p">(</span> <span class="nx">joint</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">p_names</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span> <span class="nx">joint</span><span class="p">.</span><span class="nx">jto1</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">p_names</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span> <span class="nx">joint</span><span class="p">.</span><span class="nx">jto2</span><span class="p">.</span><span class="nx">name</span><span class="p">))</span> <span class="p">{</span>
               <span class="nx">alreadyJoined</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="p">}</span>
         <span class="p">});</span>
         
         <span class="k">if</span> <span class="p">(</span><span class="nx">atLeastOnePuck</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">alreadyJoined</span><span class="p">))</span> <span class="p">{</span>
            <span class="kd">let</span> <span class="nx">tempJoint</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">cP</span><span class="p">.</span><span class="nx">Joint</span><span class="p">(</span><span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">{</span><span class="s1">&#39;jto1_ap_l_2d_m&#39;</span><span class="o">:</span> <span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">selectionPoint_l_2d_m</span><span class="p">,</span> <span class="s1">&#39;jto2_ap_l_2d_m&#39;</span><span class="o">:</span> <span class="nx">p</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">selectionPoint_l_2d_m</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="o">:</span><span class="s1">&#39;darkred&#39;</span><span class="p">}</span> <span class="p">);</span>
            <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s1">&#39;Name of the new joint is &#39;</span> <span class="o">+</span> <span class="nx">tempJoint</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">);</span>
            
            <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">resetAll</span><span class="p">();</span>
            
         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">atLeastOnePuck</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s1">&#39;One of the selected objects must be a puck.&#39;</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">);</span>
            
         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">alreadyJoined</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s1">&#39;Only one revolute joint is allowed per pair of objects.&#39;</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">);</span>
         <span class="p">}</span>
         
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s1">&#39;Select two attachment points using multi-select features.&#39;</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">);</span>
      <span class="p">}</span>
   <span class="p">}</span>
   
   <span class="kd">function</span> <span class="nx">comSelection_Toggle</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">duration_s</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">dC</span><span class="p">.</span><span class="nx">comSelection</span><span class="p">.</span><span class="nx">checked</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">// Change the attachment point of the cursor springs to be at the center of the selected body.</span>
         <span class="nx">cT</span><span class="p">.</span><span class="nx">Client</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span> <span class="nx">client</span> <span class="p">=&gt;</span> <span class="p">{</span><span class="k">if</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">)</span> <span class="nx">client</span><span class="p">.</span><span class="nx">cursorSpring</span><span class="p">.</span><span class="nx">spo2_ap_l_2d_m</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)});</span>
         <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s1">&#39;Center of mass (COM) selection: [base,yellow]ON[base]&#39;</span><span class="p">,</span> <span class="nx">duration_s</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="c1">// Change back to the actual selection points.</span>
         <span class="nx">cT</span><span class="p">.</span><span class="nx">Client</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span> <span class="nx">client</span> <span class="p">=&gt;</span> <span class="p">{</span><span class="k">if</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">)</span> <span class="nx">client</span><span class="p">.</span><span class="nx">cursorSpring</span><span class="p">.</span><span class="nx">spo2_ap_l_2d_m</span> <span class="o">=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">selectionPoint_l_2d_m</span><span class="p">});</span>
         <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s1">&#39;Center of mass (COM) selection: [base,yellow]OFF[base]&#39;</span><span class="p">,</span> <span class="nx">duration_s</span><span class="p">);</span>
      <span class="p">}</span>
   <span class="p">}</span>
   
   <span class="kd">function</span> <span class="nx">freeze</span><span class="p">()</span> <span class="p">{</span>      
      <span class="nx">cP</span><span class="p">.</span><span class="nx">Puck</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span> <span class="nx">puck</span> <span class="p">=&gt;</span> <span class="nx">puck</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">SetLinearVelocity</span><span class="p">(</span> <span class="k">new</span> <span class="nx">b2DW</span><span class="p">.</span><span class="nx">Vec2</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">))</span> <span class="p">);</span>
   <span class="p">}</span>
   
   <span class="kd">function</span> <span class="nx">stopRotation</span><span class="p">()</span> <span class="p">{</span>      
      <span class="nx">cP</span><span class="p">.</span><span class="nx">Puck</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span> <span class="nx">puck</span> <span class="p">=&gt;</span> <span class="nx">puck</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">SetAngularVelocity</span><span class="p">(</span> <span class="mf">0.0</span><span class="p">)</span> <span class="p">);</span>
   <span class="p">}</span>
   
   <span class="kd">function</span> <span class="nx">reverseDirection</span><span class="p">()</span> <span class="p">{</span>      
      <span class="nx">cP</span><span class="p">.</span><span class="nx">Puck</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span> <span class="nx">puck</span> <span class="p">=&gt;</span> <span class="p">{</span>
         <span class="nx">puck</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">SetAngularVelocity</span><span class="p">(</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="nx">puck</span><span class="p">.</span><span class="nx">angularSpeed_rps</span><span class="p">);</span>
         <span class="nx">puck</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">SetLinearVelocity</span><span class="p">(</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">b2Vec2_from_Vec2D</span><span class="p">(</span> <span class="nx">puck</span><span class="p">.</span><span class="nx">velocity_2d_mps</span><span class="p">.</span><span class="nx">scaleBy</span><span class="p">(</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">);</span>
      <span class="p">});</span>
   <span class="p">}</span>
   
   <span class="c1">// client related</span>
   <span class="kd">function</span> <span class="nx">setClientCanvasToMatchHost</span><span class="p">()</span> <span class="p">{</span>
      <span class="c1">// This must run within the context of the host&#39;s browser (to get the host&#39;s canvas dimensions).</span>
      <span class="nx">hC</span><span class="p">.</span><span class="nx">sendSocketControlMessage</span><span class="p">({</span><span class="s1">&#39;from&#39;</span><span class="o">:</span><span class="s1">&#39;host&#39;</span><span class="p">,</span> <span class="s1">&#39;to&#39;</span><span class="o">:</span><span class="s1">&#39;roomNoSender&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="o">:</span><span class="p">{</span><span class="s1">&#39;canvasResize&#39;</span><span class="o">:</span><span class="p">{</span><span class="s1">&#39;width&#39;</span><span class="o">:</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span><span class="s1">&#39;height&#39;</span><span class="o">:</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span><span class="p">},</span> <span class="s1">&#39;demoVersion&#39;</span><span class="o">:</span><span class="nx">c</span><span class="p">.</span><span class="nx">demoVersion</span><span class="p">}</span> <span class="p">});</span>
   <span class="p">}</span>
         
   
   <span class="c1">////////////////////////////////////////////////</span>
   <span class="c1">// Setup the event listeners...</span>
   <span class="c1">////////////////////////////////////////////////</span>
   
   <span class="kd">function</span> <span class="nx">initializeEventListeners</span><span class="p">()</span> <span class="p">{</span>
   
      <span class="cm">/* */</span>
      <span class="c1">// text area for JSON captures</span>
      <span class="nx">dC</span><span class="p">.</span><span class="nx">json</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;jsonCapture&#39;</span><span class="p">);</span>
      <span class="nx">dC</span><span class="p">.</span><span class="nx">json</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;mousedown&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">// right click to toggle size</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">button</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">dC</span><span class="p">.</span><span class="nx">json</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">width</span> <span class="o">==</span> <span class="s2">&quot;450px&quot;</span><span class="p">)</span> <span class="p">{</span>
               <span class="c1">// back to normal size</span>
               <span class="nx">dC</span><span class="p">.</span><span class="nx">json</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="s2">&quot;165px&quot;</span><span class="p">;</span>
               <span class="nx">dC</span><span class="p">.</span><span class="nx">json</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="s2">&quot;30px&quot;</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
               <span class="c1">// larger size</span>
               <span class="nx">dC</span><span class="p">.</span><span class="nx">json</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="s2">&quot;450px&quot;</span><span class="p">;</span>
               <span class="nx">dC</span><span class="p">.</span><span class="nx">json</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="s2">&quot;300px&quot;</span><span class="p">;</span>
               <span class="nb">window</span><span class="p">.</span><span class="nx">scrollBy</span><span class="p">(</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
               <span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                  <span class="nb">window</span><span class="p">.</span><span class="nx">scrollBy</span><span class="p">(</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
               <span class="p">},</span> <span class="mi">600</span><span class="p">);</span>
            <span class="p">}</span>
         <span class="c1">// mouse-wheel click</span>
         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">button</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
            <span class="nx">cR</span><span class="p">.</span><span class="nx">cleanCapture</span><span class="p">();</span>
         <span class="p">}</span>
      <span class="p">},</span> <span class="p">{</span><span class="nx">capture</span><span class="o">:</span> <span class="kc">false</span><span class="p">});</span>
      
      <span class="c1">// Inhibit the context menu that pops up when right clicking (third button).</span>
      <span class="c1">// Do this on mainDiv to prevent the menu from appearing when you drag the</span>
      <span class="c1">// mouse off the canvas.</span>
      <span class="kd">var</span> <span class="nx">mainDiv</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;mainDiv&#39;</span><span class="p">);</span>
      <span class="nx">mainDiv</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;contextmenu&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
         <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">},</span> <span class="p">{</span><span class="nx">capture</span><span class="o">:</span> <span class="kc">false</span><span class="p">});</span>
      
      <span class="cm">/*</span>
<span class="cm">      // Added this (11:17 AM Fri May 29, 2020) as workaround to a Chromium bug.</span>
<span class="cm">      // https://bugs.chromium.org/p/chromium/issues/detail?id=1087488</span>
<span class="cm">      // Should not need this!</span>
<span class="cm">      // Bug is fixed in Chrome Version 83.0.4103.97</span>
<span class="cm">      const resizeHandler = new ResizeObserver( entries =&gt; {</span>
<span class="cm">         for (let entry of entries) {</span>
<span class="cm">            const cr = entry.contentRect;</span>
<span class="cm">            console.log(&#39;Element:&#39;, entry.target.id);</span>
<span class="cm">            console.log(`Element size: ${cr.width}px x ${cr.height}px`);</span>
<span class="cm">            if (entry.target.id == &#39;hostCanvas&#39;) {</span>
<span class="cm">               canvasDiv.style.width = cr.width + &quot;px&quot;;</span>
<span class="cm">               canvasDiv.style.height = cr.height + &quot;px&quot;;</span>
<span class="cm">            }</span>
<span class="cm">         }</span>
<span class="cm">      });</span>
<span class="cm">      resizeHandler.observe( canvas);</span>
<span class="cm">      */</span>
      
      <span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;visibilitychange&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">visibilityState</span> <span class="o">!==</span> <span class="s1">&#39;hidden&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;window restored or regained focus&quot;</span><span class="p">);</span>
            <span class="nx">gW</span><span class="p">.</span><span class="nx">restartAnimationLoop</span><span class="p">(</span> <span class="mi">600</span><span class="p">);</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;window minimized or lost focus&quot;</span><span class="p">);</span>
         <span class="p">}</span>
      <span class="p">});</span>

      <span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;wheel&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">// note: see comments in the wheel event listener in hostAndClient.js </span>
         <span class="c1">// Thu May 20, 2021, had to put the wheel listener on the document (window also works) for this event to fire when canvas is fullscreen.</span>
         <span class="c1">// The wS.mouseOverElement call acts to restrict the handler and the prevention of default behavior to the canvas (scrolling still works in the left panel).</span>
         <span class="k">if</span> <span class="p">(</span> <span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">poolShotLocked</span>  <span class="o">&amp;&amp;</span>  <span class="nx">wS</span><span class="p">.</span><span class="nx">mouseOverElement</span><span class="p">(</span> <span class="nx">canvas</span><span class="p">,</span> <span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">raw_2d_px</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
            <span class="nx">wheelEvent_handler</span><span class="p">(</span><span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span>
         <span class="p">}</span>
      <span class="p">},</span> <span class="p">{</span><span class="nx">passive</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">capture</span><span class="o">:</span> <span class="kc">false</span><span class="p">});</span>
      
      <span class="c1">// Note: This call to addEventListener for mousemove could be put (and was for a while) inside the mousedown handler. </span>
      <span class="c1">// Then, if there is a corresponding removeEventListen for this in the mouseup handler, effectively the</span>
      <span class="c1">// the mousemove listener would only run while a mouse button is down. That works out </span>
      <span class="c1">// nicely if you are using the native Windows cursor. But if you are drawing a cursor into</span>
      <span class="c1">// the canvas, you need to keep track of mouse position even if the mouse isn&#39;t clicked down.</span>
      <span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;mousemove&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> 
         <span class="nx">handleMouseOrTouchMove</span><span class="p">(</span> <span class="nx">e</span><span class="p">,</span> <span class="s1">&#39;mousemove&#39;</span><span class="p">);</span>
      <span class="p">},</span> <span class="p">{</span><span class="nx">capture</span><span class="o">:</span> <span class="kc">false</span><span class="p">});</span>
      
      <span class="nx">canvas</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;mousedown&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">mouseDown</span> <span class="o">=</span> <span class="s1">&#39;M&#39;</span><span class="p">;</span>
         
         <span class="c1">// If there&#39;s been a click inside the canvas area, flag it as mouse usage for the local user (host).</span>
         <span class="k">if</span> <span class="p">(</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">pointInCanvas</span><span class="p">(</span> <span class="nx">canvas</span><span class="p">,</span> <span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">mouse_2d_px</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">mouseUsage</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
         <span class="p">}</span>
         
         <span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">button</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">button</span><span class="p">;</span>
         
         <span class="cm">/* for making videos... </span>
<span class="cm">         if (clients[&#39;local&#39;].button == 0) {</span>
<span class="cm">            gW.messages[&#39;lowHelp&#39;].newMessage(&#39;[base,yellow]left[base,lightgray] mouse button&#39;, 20.0);</span>
<span class="cm">         } else if (clients[&#39;local&#39;].button == 1) {</span>
<span class="cm">            gW.messages[&#39;lowHelp&#39;].newMessage(&#39;[base,yellow]middle[base,lightgray] mouse button&#39;, 20.0);</span>
<span class="cm">         } else if (clients[&#39;local&#39;].button == 2) {</span>
<span class="cm">            gW.messages[&#39;lowHelp&#39;].newMessage(&#39;[base,yellow]right[base,lightgray] mouse button&#39;, 20.0);</span>
<span class="cm">         }</span>
<span class="cm">         */</span>
         
         <span class="c1">// Pass this first mouse position to the move handler. This will establish</span>
         <span class="c1">// the world position of the mouse.</span>
         <span class="nx">handleMouseOrTouchMove</span><span class="p">(</span> <span class="nx">e</span><span class="p">,</span> <span class="s1">&#39;mousedown&#39;</span><span class="p">);</span>
      
         <span class="c1">// (Note: also see the checkForMouseSelection method in the cT.Client prototype.)</span>
         <span class="c1">// Clear out the multi-select map, if user clicks in open area.</span>
         <span class="nx">mS</span><span class="p">.</span><span class="nx">clickToClearMulti</span><span class="p">(</span><span class="s1">&#39;local&#39;</span><span class="p">);</span>
         
         <span class="c1">// start a cursor-based selection box (host only)</span>
         <span class="k">if</span> <span class="p">((</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">key_alt</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">key_ctrl</span> <span class="o">==</span> <span class="s1">&#39;U&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">].</span><span class="nx">includes</span><span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">button</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="nx">gW</span><span class="p">.</span><span class="nx">hostSelectBox</span><span class="p">.</span><span class="nx">enabled</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">gW</span><span class="p">.</span><span class="nx">hostSelectBox</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>
            <span class="nx">gW</span><span class="p">.</span><span class="nx">hostSelectBox</span><span class="p">.</span><span class="nx">update</span><span class="p">();</span>
         <span class="p">}</span>
         
         <span class="c1">// This prevents the middle mouse button from doing scrolling operations.</span>
         <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
                  
      <span class="p">},</span> <span class="p">{</span><span class="nx">capture</span><span class="o">:</span> <span class="kc">false</span><span class="p">});</span>
      
      <span class="nx">canvas</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;touchstart&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">// Note: e.preventDefault() not needed here if the following canvas style is set</span>
         <span class="c1">// touch-action: none;</span>
         
         <span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">mouseDown</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
         <span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">button</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
         <span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">touchScreenUsage</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
         
         <span class="c1">//Pass this first mouse position to the move handler.</span>
         <span class="nx">handleMouseOrTouchMove</span><span class="p">(</span> <span class="nx">e</span><span class="p">,</span> <span class="s1">&#39;touchstart&#39;</span><span class="p">);</span>
         
      <span class="p">},</span> <span class="p">{</span><span class="nx">passive</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">capture</span><span class="o">:</span> <span class="kc">false</span><span class="p">});</span>
      
      <span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;mouseup&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
         
         <span class="c1">// Remove focus from checkboxes after use (release mouse button). This is needed for </span>
         <span class="c1">// the canvas to get immediate attention when using the control, shift, and alt keys.</span>
         <span class="c1">// (for example: multi-select using the alt key after enabling the editor)</span>
         <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;:checkbox&quot;</span><span class="p">).</span><span class="nx">blur</span><span class="p">();</span>
         
         <span class="c1">// This is necessary for MS Edge. Some buttons were staying depressed.</span>
         <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;:button&quot;</span><span class="p">).</span><span class="nx">blur</span><span class="p">();</span>
         
         <span class="c1">// To get past here, mouseDown state must be down (true).</span>
         <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">mouseDown</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
         
         <span class="c1">// See corresponding help message in mousedown handler.</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;lowHelp&#39;</span><span class="p">].</span><span class="nx">message</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;mouse button&#39;</span><span class="p">))</span> <span class="p">{</span>
            <span class="c1">// clear out message from mousedown</span>
            <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;lowHelp&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">);</span>
         <span class="p">}</span>
         
         <span class="nx">mouseUp_handler</span><span class="p">(</span><span class="s1">&#39;local&#39;</span><span class="p">);</span>
         
      <span class="p">},</span> <span class="p">{</span><span class="nx">capture</span><span class="o">:</span> <span class="kc">false</span><span class="p">});</span>
      
      <span class="cm">/*</span>
<span class="cm">      Tried to use e.preventDefault() in touchmove to avoid android Firefox scrolling issues for the host page. </span>
<span class="cm">      But when go fullscreen, can&#39;t center the view... Might be a timing issue. Had to use a delay to make the TwoThumbs grid render</span>
<span class="cm">      with Firefox in fullscreen mode. So for now, commenting preventDefault. Also considered starting touchmove</span>
<span class="cm">      in the touchstart event handler. But seems like it might fire multiple times with multiple touch points, unless add</span>
<span class="cm">      on first touch and remove when last touch is released.</span>
<span class="cm">      */</span>
      <span class="nx">canvas</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;touchmove&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">//e.preventDefault();</span>
         <span class="nx">handleMouseOrTouchMove</span><span class="p">(</span> <span class="nx">e</span><span class="p">,</span> <span class="s1">&#39;touchmove&#39;</span><span class="p">);</span>
      <span class="p">},</span> <span class="p">{</span><span class="nx">capture</span><span class="o">:</span> <span class="kc">false</span><span class="p">});</span>
      
      <span class="nx">canvas</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;touchend&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">gB</span><span class="p">.</span><span class="nx">interpretTouches</span><span class="p">(</span> <span class="nx">e</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;startOrEnd&#39;</span><span class="o">:</span><span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="s1">&#39;hostOrClient&#39;</span><span class="o">:</span><span class="s1">&#39;host&#39;</span><span class="p">,</span> <span class="s1">&#39;cl&#39;</span><span class="o">:</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">],</span> <span class="s1">&#39;socket&#39;</span><span class="o">:</span><span class="kc">null</span><span class="p">,</span> 
                                  <span class="s1">&#39;fromListener&#39;</span><span class="o">:</span><span class="s1">&#39;touchend&#39;</span><span class="p">,</span> <span class="s1">&#39;mK&#39;</span><span class="o">:</span><span class="kc">null</span><span class="p">,</span> <span class="s1">&#39;ts&#39;</span><span class="o">:</span><span class="nx">ts</span><span class="p">,</span> <span class="s1">&#39;raw_2d_px&#39;</span><span class="o">:</span><span class="kc">null</span><span class="p">,</span> <span class="s1">&#39;demoVersionOnHost&#39;</span><span class="o">:</span><span class="nx">c</span><span class="p">.</span><span class="nx">demoVersion</span><span class="p">}</span> <span class="p">);</span>
         
         <span class="c1">// Note: e.preventDefault() not needed here if the following canvas style is set</span>
         <span class="c1">// touch-action: none;</span>
         
         <span class="k">if</span> <span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">mouseDown</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
            
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">mouseUp_handler</span><span class="p">(</span><span class="s1">&#39;local&#39;</span><span class="p">);</span>
         <span class="p">}</span>
         
      <span class="p">},</span> <span class="p">{</span><span class="nx">passive</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">capture</span><span class="o">:</span> <span class="kc">false</span><span class="p">});</span>
          
      <span class="kd">var</span> <span class="nx">editKeysMap</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;key_leftArrow&#39;</span><span class="o">:</span><span class="s1">&#39;thinner&#39;</span><span class="p">,</span> <span class="s1">&#39;key_rightArrow&#39;</span><span class="o">:</span><span class="s1">&#39;wider&#39;</span><span class="p">,</span> <span class="s1">&#39;key_upArrow&#39;</span><span class="o">:</span><span class="s1">&#39;taller&#39;</span><span class="p">,</span> <span class="s1">&#39;key_downArrow&#39;</span><span class="o">:</span><span class="s1">&#39;shorter&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;key_[&#39;</span><span class="o">:</span><span class="s1">&#39;lessDamping&#39;</span><span class="p">,</span> <span class="s1">&#39;key_]&#39;</span><span class="o">:</span><span class="s1">&#39;moreDamping&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;key_-&#39;</span><span class="o">:</span><span class="s1">&#39;lessFriction&#39;</span><span class="p">,</span>  <span class="s1">&#39;key_+&#39;</span><span class="o">:</span><span class="s1">&#39;moreFriction&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;key_-_&#39;</span><span class="o">:</span><span class="s1">&#39;lessFriction&#39;</span><span class="p">,</span> <span class="s1">&#39;key_=+&#39;</span><span class="o">:</span><span class="s1">&#39;moreFriction&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;key_lt&#39;</span><span class="o">:</span><span class="s1">&#39;lessDrag&#39;</span><span class="p">,</span>     <span class="s1">&#39;key_gt&#39;</span><span class="o">:</span><span class="s1">&#39;moreDrag&#39;</span><span class="p">};</span>
      <span class="kd">var</span> <span class="nx">allowDefaultKeysMap</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;key_-&#39;</span><span class="o">:</span><span class="kc">null</span><span class="p">,</span> <span class="s1">&#39;key_+&#39;</span><span class="o">:</span><span class="kc">null</span><span class="p">,</span> <span class="s1">&#39;key_-_&#39;</span><span class="o">:</span><span class="kc">null</span><span class="p">,</span> <span class="s1">&#39;key_=+&#39;</span><span class="o">:</span><span class="kc">null</span><span class="p">};</span>
      
      <span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;keydown&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">// Uncomment the following line for an easy test to see if the default key behavior can be inhibited.</span>
         <span class="c1">//e.preventDefault();</span>
         
         <span class="c1">//console.log(&quot;keyCode=&quot; + e.keyCode + &quot;, code=&quot; + e.code + &quot;, key=&quot; + e.key + &quot;, mapName=&quot; + keyMap[e.code]);</span>
         
         <span class="c1">// The following is necessary in Firefox to avoid the spacebar from re-clicking </span>
         <span class="c1">// page controls (like the demo buttons) if they have focus.</span>
         <span class="c1">// This also prevents some unwanted spacebar-related button behavior in Chrome.</span>
         <span class="c1">// (document.activeElement.tagName != &#39;BODY&#39;) &amp;&amp; (document.activeElement.tagName != &#39;INPUT&#39;)</span>
         <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="p">[</span><span class="s1">&#39;BODY&#39;</span><span class="p">,</span><span class="s1">&#39;INPUT&#39;</span><span class="p">,</span><span class="s1">&#39;TEXTAREA&#39;</span><span class="p">].</span><span class="nx">includes</span><span class="p">(</span> <span class="nb">document</span><span class="p">.</span><span class="nx">activeElement</span><span class="p">.</span><span class="nx">tagName</span><span class="p">))</span> <span class="p">{</span>     
            <span class="nb">document</span><span class="p">.</span><span class="nx">activeElement</span><span class="p">.</span><span class="nx">blur</span><span class="p">();</span>
         <span class="p">}</span>
         
         <span class="cm">/*</span>
<span class="cm">         Anything in this first group of blocks will repeat if the key is held down for a </span>
<span class="cm">         while. Holding it down will fire the keydown event repeatedly. Of course </span>
<span class="cm">         this area only affects the local client. Note there is another area in </span>
<span class="cm">         this code where repetition is avoided though use of the key_?_enabled </span>
<span class="cm">         attributes; search on key_s_enabled for example. That repetition is of </span>
<span class="cm">         a different nature in that it comes from action triggered by observing </span>
<span class="cm">         the key state (up/down) each frame. </span>
<span class="cm">         */</span>
         
         <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">code</span> <span class="k">in</span> <span class="nx">keyMap</span><span class="p">)</span> <span class="p">{</span> 
            <span class="c1">// If you want down keys to repeat, put them here.</span>
            
            <span class="c1">// First, exit if focus is in the typing areas (exceptions are the modifier keys that might be used with buttons).</span>
            <span class="k">if</span> <span class="p">(</span> <span class="p">[</span><span class="s1">&#39;INPUT&#39;</span><span class="p">,</span><span class="s1">&#39;TEXTAREA&#39;</span><span class="p">].</span><span class="nx">includes</span><span class="p">(</span> <span class="nb">document</span><span class="p">.</span><span class="nx">activeElement</span><span class="p">.</span><span class="nx">tagName</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="o">!</span> <span class="p">[</span><span class="s1">&#39;key_alt&#39;</span><span class="p">,</span><span class="s1">&#39;key_shift&#39;</span><span class="p">,</span><span class="s1">&#39;key_ctrl&#39;</span><span class="p">].</span><span class="nx">includes</span><span class="p">(</span> <span class="nx">keyMap</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">code</span><span class="p">]))</span> <span class="p">)</span> <span class="p">{</span>
               <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
            
            <span class="c1">// Inhibit default behaviors.</span>
            <span class="k">if</span> <span class="p">([</span><span class="s1">&#39;key_space&#39;</span><span class="p">,</span> <span class="s1">&#39;key_l&#39;</span><span class="p">,</span> <span class="s1">&#39;key_s&#39;</span><span class="p">,</span> <span class="s1">&#39;key_q&#39;</span><span class="p">,</span> <span class="s1">&#39;key_alt&#39;</span><span class="p">,</span> <span class="s1">&#39;key_questionMark&#39;</span><span class="p">,</span> <span class="s1">&#39;key_tab&#39;</span><span class="p">].</span><span class="nx">includes</span><span class="p">(</span> <span class="nx">keyMap</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">code</span><span class="p">]))</span> <span class="p">{</span>
               <span class="c1">// Inhibit page scrolling that results from using the spacebar (when using puck shields)</span>
               <span class="c1">// Also inhibit repeat presses of the demo keys when using the spacebar.</span>
               <span class="c1">// Inhibit ctrl-s behavior in Firefox (save page).</span>
               <span class="c1">// Inhibit ctrl-q behavior in Edge (history panel).</span>
               <span class="c1">// Inhibit questionMark key behavior in Firefox (brings up text-search box)</span>
               <span class="c1">// Inhibit alt key behavior. Prevents a problem where if the alt key is depressed during the middle of a mouse drag, it</span>
               <span class="c1">//    prevents the box select from working on the next try.</span>
               <span class="c1">// Inhibit tabbing: jumping to each of the GUI controls on the page.</span>
               <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
                
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="nx">keyMap</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">code</span><span class="p">]</span> <span class="k">in</span> <span class="nx">editKeysMap</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="nx">keyMap</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">code</span><span class="p">]</span> <span class="k">in</span> <span class="nx">allowDefaultKeysMap</span><span class="p">))</span> <span class="p">{</span>
               <span class="c1">// Prevent page scrolling when using the arrow keys in the editor.</span>
               <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
            
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">keyMap</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">code</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;key_o&#39;</span><span class="p">)</span> <span class="p">{</span>
               <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">dC</span><span class="p">.</span><span class="nx">pause</span><span class="p">.</span><span class="nx">checked</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">uT</span><span class="p">.</span><span class="nx">setElementDisplay</span><span class="p">(</span><span class="s2">&quot;fps_wrapper&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">);</span>
                  <span class="nx">uT</span><span class="p">.</span><span class="nx">setElementDisplay</span><span class="p">(</span><span class="s2">&quot;stepper_wrapper&quot;</span><span class="p">,</span> <span class="s2">&quot;inline&quot;</span><span class="p">);</span>
               <span class="p">}</span>
               <span class="nx">gW</span><span class="p">.</span><span class="nx">stepAnimation</span><span class="p">();</span>
            
            <span class="c1">// Change body rotation when editing.</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="nx">keyMap</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">code</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;key_t&#39;</span><span class="p">))</span> <span class="p">{</span>
               <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span> <span class="nx">tableObj</span> <span class="p">=&gt;</span> <span class="p">{</span>
                  <span class="k">if</span> <span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">key_shift</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="p">)</span> <span class="p">{</span>
                     <span class="c1">// Increase rate counterclockwise</span>
                     <span class="kd">var</span> <span class="nx">rotRate_change_dps</span> <span class="o">=</span> <span class="o">+</span><span class="mi">5</span><span class="p">;</span> <span class="c1">// degrees per second</span>
                  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                     <span class="c1">// clockwise</span>
                     <span class="kd">var</span> <span class="nx">rotRate_change_dps</span> <span class="o">=</span> <span class="o">-</span><span class="mi">5</span><span class="p">;</span>
                  <span class="p">}</span>
                  <span class="kd">var</span> <span class="nx">rotRate_change_rps</span> <span class="o">=</span> <span class="nx">rotRate_change_dps</span> <span class="o">*</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="o">/</span><span class="mi">180</span><span class="p">);</span> <span class="c1">// radians per second</span>
                  
                  <span class="nx">tableObj</span><span class="p">.</span><span class="nx">angularSpeed_rps</span> <span class="o">+=</span> <span class="nx">rotRate_change_rps</span><span class="p">;</span>
                  <span class="c1">// if not a static body type</span>
                  <span class="k">if</span> <span class="p">(</span><span class="nx">tableObj</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">m_type</span> <span class="o">!=</span> <span class="nx">b2DW</span><span class="p">.</span><span class="nx">Body</span><span class="p">.</span><span class="nx">b2_staticBody</span><span class="p">)</span> <span class="p">{</span>
                     <span class="c1">// If you change the rate so that it stops the rotation, or if the body is initially not rotating, it</span>
                     <span class="c1">// will be sleeping. In those cases, must wake it before setting the angular speed.</span>
                     <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">tableObj</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">IsAwake</span><span class="p">())</span> <span class="nx">tableObj</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">SetAwake</span><span class="p">(</span> <span class="kc">true</span><span class="p">);</span>
                     <span class="nx">tableObj</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">SetAngularVelocity</span><span class="p">(</span> <span class="nx">tableObj</span><span class="p">.</span><span class="nx">angularSpeed_rps</span><span class="p">);</span>
                  <span class="p">}</span>
               <span class="p">});</span>
            <span class="p">}</span>
            
            <span class="c1">// Use the keys in the edit-keys map to change the characteristics of the selected body.</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">keyMap</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">code</span><span class="p">]</span> <span class="k">in</span> <span class="nx">editKeysMap</span><span class="p">)</span> <span class="p">{</span>
               <span class="kd">var</span> <span class="nx">command</span> <span class="o">=</span> <span class="nx">editKeysMap</span><span class="p">[</span> <span class="nx">keyMap</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">code</span><span class="p">]];</span>
               
               <span class="kd">function</span> <span class="nx">modifyPuckCommand</span><span class="p">(</span> <span class="nx">tableObject</span><span class="p">,</span> <span class="nx">command</span><span class="p">)</span> <span class="p">{</span>
                  <span class="c1">// The host can use the alt key to modify angular drag on pucks...</span>
                  <span class="k">if</span> <span class="p">((</span><span class="nx">tableObject</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;Puck&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">key_alt</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="p">))</span> <span class="p">{</span>
                     <span class="k">if</span> <span class="p">(</span><span class="nx">command</span> <span class="o">==</span> <span class="s2">&quot;moreDrag&quot;</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">command</span> <span class="o">=</span> <span class="s2">&quot;moreAngDrag&quot;</span><span class="p">;</span>
                     <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">command</span> <span class="o">==</span> <span class="s2">&quot;lessDrag&quot;</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">command</span> <span class="o">=</span> <span class="s2">&quot;lessAngDrag&quot;</span><span class="p">;</span>
                     <span class="p">}</span> 
                  <span class="p">}</span>
                  <span class="k">return</span> <span class="nx">command</span><span class="p">;</span>
               <span class="p">}</span>
               
               <span class="kd">function</span> <span class="nx">modifySpringCommand</span><span class="p">(</span> <span class="nx">command</span><span class="p">)</span> <span class="p">{</span>
                  <span class="c1">// The host can use the alt key to modify the spring command...</span>
                  <span class="k">if</span> <span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">key_alt</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="p">)</span> <span class="p">{</span>
                     <span class="k">if</span> <span class="p">(</span><span class="nx">command</span> <span class="o">==</span> <span class="s2">&quot;wider&quot;</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">command</span> <span class="o">=</span> <span class="s2">&quot;widerAppearance&quot;</span><span class="p">;</span>
                     <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">command</span> <span class="o">==</span> <span class="s2">&quot;thinner&quot;</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">command</span> <span class="o">=</span> <span class="s2">&quot;thinnerAppearance&quot;</span><span class="p">;</span>
                     <span class="p">}</span> 
                  <span class="p">}</span>
                  <span class="k">return</span> <span class="nx">command</span><span class="p">;</span>
               <span class="p">}</span>
               
               <span class="c1">// Multi-select</span>
               <span class="k">if</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                  <span class="c1">// Direct the edit actions at the springs (s key down)</span>
                  <span class="k">if</span> <span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">key_s</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="p">)</span> <span class="p">{</span>
                     <span class="c1">// Arrow keys and page-up/page-down.</span>
                     <span class="k">if</span> <span class="p">((</span><span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">selectMode</span><span class="p">[</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">selectModeIndex</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;springs&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">candidateReportPasteDelete</span><span class="p">))</span> <span class="p">{</span>
                        <span class="nx">aT</span><span class="p">.</span><span class="nx">springMap</span><span class="p">[</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">candidateReportPasteDelete</span><span class="p">].</span><span class="nx">interpret_editCommand</span><span class="p">(</span> <span class="nx">modifySpringCommand</span><span class="p">(</span> <span class="nx">command</span><span class="p">));</span>
                     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nx">cP</span><span class="p">.</span><span class="nx">Spring</span><span class="p">.</span><span class="nx">findAll_InMultiSelect</span><span class="p">(</span> <span class="nx">spring</span> <span class="p">=&gt;</span> <span class="nx">spring</span><span class="p">.</span><span class="nx">interpret_editCommand</span><span class="p">(</span> <span class="nx">modifySpringCommand</span><span class="p">(</span> <span class="nx">command</span><span class="p">)));</span>
                     <span class="p">}</span>
                     
                  <span class="c1">// All other object types</span>
                  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                     <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span> <span class="nx">msObject</span> <span class="p">=&gt;</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">msObject</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">!=</span> <span class="s2">&quot;Pin&quot;</span><span class="p">)</span> <span class="p">{</span>
                           <span class="nx">command</span> <span class="o">=</span> <span class="nx">modifyPuckCommand</span><span class="p">(</span> <span class="nx">msObject</span><span class="p">,</span> <span class="nx">command</span><span class="p">);</span>
                           <span class="nx">msObject</span><span class="p">.</span><span class="nx">interpret_editCommand</span><span class="p">(</span> <span class="nx">command</span><span class="p">);</span>
                        <span class="p">}</span>
                     <span class="p">});</span>
                  <span class="p">}</span>
                  
               <span class="c1">// Single-body selection (client spring)</span>
               <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">selectedBody</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">if</span> <span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">!=</span> <span class="s2">&quot;Pin&quot;</span><span class="p">)</span> <span class="p">{</span>
                     <span class="nx">command</span> <span class="o">=</span> <span class="nx">modifyPuckCommand</span><span class="p">(</span> <span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">selectedBody</span><span class="p">,</span> <span class="nx">command</span><span class="p">);</span>
                     <span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">interpret_editCommand</span><span class="p">(</span> <span class="nx">command</span><span class="p">);</span>
                  <span class="p">}</span>
               <span class="p">}</span>
            <span class="p">}</span>
            
            <span class="cm">/*</span>
<span class="cm">            Keys that are held down will NOT repeat in this next block. Current key </span>
<span class="cm">            state must be UP before it will change the state to DOWN and perform the </span>
<span class="cm">            action. This is for cases where you are toggling the state of the </span>
<span class="cm">            client&#39;s key parameter. Also see comment paragraph on repetition above.</span>
<span class="cm">            </span>
<span class="cm">            Note: when a Client object is initialized, all it&#39;s key values are set to &#39;UP&#39;.</span>
<span class="cm">            */</span>
            
            <span class="c1">// If the current key state is UP...</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">][</span><span class="nx">keyMap</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">code</span><span class="p">]]</span> <span class="o">==</span> <span class="s1">&#39;U&#39;</span><span class="p">)</span> <span class="p">{</span>
               
               <span class="c1">// Set the key state to be DOWN.</span>
               <span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">][</span><span class="nx">keyMap</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">code</span><span class="p">]]</span> <span class="o">=</span> <span class="s1">&#39;D&#39;</span><span class="p">;</span>
               
               <span class="c1">// Immediate execution on keydown (that&#39;s the event that got you in here):</span>
               
               <span class="k">if</span> <span class="p">(</span><span class="nx">keyMap</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">code</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;key_ctrl&#39;</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">key_ctrl_handler</span><span class="p">(</span><span class="s1">&#39;keydown&#39;</span><span class="p">,</span> <span class="s1">&#39;local&#39;</span><span class="p">);</span>
                  
               <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">keyMap</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">code</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;key_l&#39;</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">key_l_handler</span><span class="p">(</span><span class="s1">&#39;keydown&#39;</span><span class="p">,</span> <span class="s1">&#39;local&#39;</span><span class="p">);</span>
               
               <span class="c1">// For showing all the count-to-pi demos without exiting full-screen view (for making videos).</span>
               <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">key_alt</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">keyMap</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">code</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;key_pageDown&#39;</span><span class="p">))</span> <span class="p">{</span>
                  <span class="k">if</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">demoLoopIndex</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                     <span class="nx">cR</span><span class="p">.</span><span class="nx">demoStart_fromCapture</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;fileName&#39;</span><span class="o">:</span><span class="s1">&#39;demoSeries1b.js&#39;</span><span class="p">});</span>
                  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">demoLoopIndex</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>  <span class="p">{</span>
                     <span class="nx">cR</span><span class="p">.</span><span class="nx">demoStart_fromCapture</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;fileName&#39;</span><span class="o">:</span><span class="s1">&#39;demoSeries1c.js&#39;</span><span class="p">});</span>
                  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">demoLoopIndex</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>  <span class="p">{</span>
                     <span class="nx">cR</span><span class="p">.</span><span class="nx">demoStart_fromCapture</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;fileName&#39;</span><span class="o">:</span><span class="s1">&#39;demoSeries1d.js&#39;</span><span class="p">});</span>
                  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">demoLoopIndex</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>  <span class="p">{</span>
                     <span class="nx">cR</span><span class="p">.</span><span class="nx">demoStart_fromCapture</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;fileName&#39;</span><span class="o">:</span><span class="s1">&#39;demoSeries1e.js&#39;</span><span class="p">});</span>
                  <span class="p">}</span>
                  <span class="k">if</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">demoLoopIndex</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
                     <span class="nx">c</span><span class="p">.</span><span class="nx">demoLoopIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                     <span class="nx">c</span><span class="p">.</span><span class="nx">demoLoopIndex</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
                  <span class="p">}</span>
                  
               <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="nx">keyMap</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">code</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;key_a&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">key_ctrl</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="p">))</span> <span class="p">{</span>
                  <span class="nx">c</span><span class="p">.</span><span class="nx">drawSyncImage</span> <span class="o">=</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">c</span><span class="p">.</span><span class="nx">drawSyncImage</span><span class="p">);</span>
                  <span class="nx">cT</span><span class="p">.</span><span class="nx">Client</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span> <span class="nx">client</span> <span class="p">=&gt;</span> <span class="p">{</span><span class="nx">client</span><span class="p">.</span><span class="nx">sendDrawSyncCommand</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;});</span>
                                 
               <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="nx">keyMap</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">code</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;key_b&#39;</span><span class="p">))</span> <span class="p">{</span>
                  <span class="nx">key_b_handler</span><span class="p">(</span><span class="s1">&#39;local&#39;</span><span class="p">);</span>
                  
               <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="nx">keyMap</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">code</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;key_c&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">key_ctrl</span> <span class="o">!=</span> <span class="s1">&#39;D&#39;</span><span class="p">))</span> <span class="p">{</span>
                  <span class="nx">key_c_handler</span><span class="p">(</span><span class="s1">&#39;local&#39;</span><span class="p">);</span>
                  
               <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="nx">keyMap</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">code</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;key_backspace&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">key_ctrl</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="p">))</span> <span class="p">{</span>
                  <span class="nx">reverseDirection</span><span class="p">();</span>
                  <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s1">&#39;translation and rotation have been [base,yellow]reversed[base]&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">);</span>
                  
               <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">keyMap</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">code</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;key_f&#39;</span><span class="p">)</span> <span class="p">{</span> 
                  <span class="k">if</span> <span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">key_alt</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="p">)</span> <span class="p">{</span>
                     <span class="c1">// nothing here yet</span>
                  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                     <span class="nx">freeze</span><span class="p">();</span>
                     <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s1">&#39;[base,yellow]translation[base] has been momentarily [base,yellow]stopped[base]&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
                  <span class="p">}</span>
                  
               <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">keyMap</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">code</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;key_r&#39;</span><span class="p">)</span> <span class="p">{</span> 
                  <span class="k">if</span> <span class="p">((</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">key_alt</span> <span class="o">==</span> <span class="s1">&#39;U&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">key_shift</span> <span class="o">==</span> <span class="s1">&#39;U&#39;</span><span class="p">))</span> <span class="p">{</span>
                     <span class="nx">stopRotation</span><span class="p">();</span>
                     <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s1">&#39;[base,yellow]rotation[base] has been momentarily [base,yellow]stopped[base]&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">);</span>
                     
                  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">key_alt</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="p">)</span> <span class="p">{</span>
                     <span class="nx">addRevoluteJoint</span><span class="p">();</span>
                     
                  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">key_shift</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="p">)</span> <span class="p">{</span>
                     <span class="nx">cR</span><span class="p">.</span><span class="nx">runCapture</span><span class="p">({</span><span class="s1">&#39;fromKeyBoard&#39;</span><span class="o">:</span><span class="kc">true</span><span class="p">});</span>
                  <span class="p">}</span>
               
               <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">keyMap</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">code</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;key_g&#39;</span><span class="p">)</span> <span class="p">{</span> 
                  <span class="nx">c</span><span class="p">.</span><span class="nx">g_ON</span> <span class="o">=</span> <span class="o">!</span><span class="nx">c</span><span class="p">.</span><span class="nx">g_ON</span><span class="p">;</span>
                  <span class="k">if</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">g_ON</span><span class="p">)</span> <span class="p">{</span>
                     <span class="nx">dC</span><span class="p">.</span><span class="nx">gravity</span><span class="p">.</span><span class="nx">checked</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                     <span class="nx">dC</span><span class="p">.</span><span class="nx">gravity</span><span class="p">.</span><span class="nx">checked</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                  <span class="p">}</span>
                  <span class="nx">dS</span><span class="p">.</span><span class="nx">setGravityRelatedParameters</span><span class="p">({</span><span class="s1">&#39;showMessage&#39;</span><span class="o">:</span><span class="kc">true</span><span class="p">});</span>
                  <span class="cm">/*</span>
<span class="cm">                  // If there is only one fixture, m_fixtureList (a linked list) is a reference to that single fixture.</span>
<span class="cm">                  console.log(&#39; &#39;);</span>
<span class="cm">                  console.log(&quot;fixture count=&quot; + aT.wallMap[&#39;wall1&#39;].b2d.m_fixtureCount);</span>
<span class="cm">                  // also might want to look here: m_fixtureList, m_fixtureList.m_shape, m_fixtureList.m_shape.m_vertices</span>
<span class="cm">                  for (var x in aT.wallMap[&#39;wall1&#39;].b2d.m_fixtureList) {</span>
<span class="cm">                     console.log(&quot;name=&quot; + x);</span>
<span class="cm">                  }</span>
<span class="cm">                  */</span>               
               <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">keyMap</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">code</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;key_m&#39;</span><span class="p">)</span> <span class="p">{</span> 
                  <span class="c1">// Note: ctrl key (down) seems to block this m key event. </span>
                  <span class="c1">//console.log(&quot;key_m block, ctrl=&quot; + clients[&#39;local&#39;].key_ctrl + &quot;, alt=&quot; + clients[&#39;local&#39;].key_alt + &quot;, shift=&quot; + clients[&#39;local&#39;].key_shift);</span>
                  <span class="k">if</span> <span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">key_shift</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="p">)</span> <span class="p">{</span>
                     <span class="k">if</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> 
                        <span class="kd">let</span> <span class="nx">message</span> <span class="o">=</span> <span class="s2">&quot;You must select at least one object to run this JSON modification function.&quot;</span><span class="p">;</span>
                        <span class="nx">pS</span><span class="p">.</span><span class="nx">viewGeneralDialog</span><span class="p">({</span><span class="s2">&quot;title&quot;</span><span class="o">:</span><span class="s2">&quot;nothing selected&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="o">:</span><span class="nx">message</span><span class="p">,</span> <span class="s2">&quot;label_close&quot;</span><span class="o">:</span><span class="s2">&quot;close&quot;</span><span class="p">});</span>
                     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nx">cR</span><span class="p">.</span><span class="nx">modifyCapture</span><span class="p">();</span>
                     <span class="p">}</span>
                  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                     <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#chkMultiplayer&#39;</span><span class="p">).</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">);</span>
                  <span class="p">}</span>
                  
               <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">keyMap</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">code</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;key_n&#39;</span><span class="p">)</span> <span class="p">{</span> 
                  <span class="nx">key_n_handler</span><span class="p">(</span><span class="s1">&#39;local&#39;</span><span class="p">);</span>
                  
               <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">keyMap</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">code</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;key_u&#39;</span><span class="p">)</span> <span class="p">{</span> 
                  <span class="nx">cR</span><span class="p">.</span><span class="nx">saveState</span><span class="p">();</span>
                  <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s1">&#39;state has been [base,yellow]captured[base]&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">);</span>
                  
               <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="nx">keyMap</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">code</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;key_v&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">key_ctrl</span> <span class="o">!=</span> <span class="s1">&#39;D&#39;</span><span class="p">))</span> <span class="p">{</span> 
                  <span class="nx">eVN</span><span class="p">.</span><span class="nx">changeFullScreenMode</span><span class="p">(</span> <span class="nx">canvas</span><span class="p">,</span> <span class="s1">&#39;on&#39;</span><span class="p">);</span>
                  
               <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">keyMap</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">code</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;key_e&#39;</span><span class="p">)</span> <span class="p">{</span> 
                  <span class="nx">dC</span><span class="p">.</span><span class="nx">editor</span><span class="p">.</span><span class="nx">checked</span> <span class="o">=</span> <span class="o">!</span><span class="nx">dC</span><span class="p">.</span><span class="nx">editor</span><span class="p">.</span><span class="nx">checked</span><span class="p">;</span>
                  <span class="nx">toggleEditorStuff</span><span class="p">();</span>
               
               <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="nx">keyMap</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">code</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;key_p&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">key_shift</span> <span class="o">!=</span> <span class="s1">&#39;D&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">key_alt</span> <span class="o">!=</span> <span class="s1">&#39;D&#39;</span><span class="p">))</span> <span class="p">{</span> 
                  <span class="nx">dC</span><span class="p">.</span><span class="nx">pause</span><span class="p">.</span><span class="nx">checked</span> <span class="o">=</span> <span class="o">!</span><span class="nx">dC</span><span class="p">.</span><span class="nx">pause</span><span class="p">.</span><span class="nx">checked</span><span class="p">;</span>
                  <span class="nx">gW</span><span class="p">.</span><span class="nx">setPauseState</span><span class="p">();</span>
               
               <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="nx">keyMap</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">code</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;key_p&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">key_alt</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="p">))</span> <span class="p">{</span> 
                  <span class="nx">gW</span><span class="p">.</span><span class="nx">clearCanvas</span><span class="p">();</span>
                  <span class="nx">c</span><span class="p">.</span><span class="nx">pauseErase</span> <span class="o">=</span> <span class="o">!</span> <span class="nx">c</span><span class="p">.</span><span class="nx">pauseErase</span><span class="p">;</span>
                  <span class="k">if</span> <span class="p">((</span><span class="nx">c</span><span class="p">.</span><span class="nx">pauseErase</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">demoVersion</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;3.d&quot;</span><span class="p">))</span> <span class="p">{</span>
                     <span class="c1">// For recording the ball paths of a pool shot. This triggers a shot when the pauseErase is set true.</span>
                     <span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">key_alt</span> <span class="o">=</span> <span class="s1">&#39;U&#39;</span><span class="p">;</span>
                     <span class="nx">mouseUp_handler</span><span class="p">(</span><span class="s1">&#39;local&#39;</span><span class="p">);</span>
                  <span class="p">}</span>
                  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">c</span><span class="p">.</span><span class="nx">pauseErase</span><span class="p">)</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span> <span class="s1">&#39;screen erasing is [base,yellow]ON[base]&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">);</span>
               
               <span class="c1">// Toggle the default spring type</span>
               <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="nx">keyMap</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">code</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;key_s&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">key_shift</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="p">))</span> <span class="p">{</span>
                  <span class="c1">// Clear this zo there is no spring report to conflict with the spring-nature report.</span>
                  <span class="nx">mS</span><span class="p">.</span><span class="nx">clearMultiSelect</span><span class="p">();</span>
                  
                  <span class="nx">c</span><span class="p">.</span><span class="nx">softConstraints_default</span> <span class="o">=</span> <span class="o">!</span><span class="nx">c</span><span class="p">.</span><span class="nx">softConstraints_default</span><span class="p">;</span>
                  <span class="k">if</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">softConstraints_default</span><span class="p">)</span> <span class="p">{</span>
                     <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s2">&quot;new springs: [base,yellow]distance joint[base] with soft constraints&quot;</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">);</span>
                  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                     <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s2">&quot;new springs: [base,yellow]Hooke&#39;s Law[base]&quot;</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">);</span>
                  <span class="p">}</span>
                  <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">aT</span><span class="p">.</span><span class="nx">springMap</span><span class="p">).</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">addToIt</span><span class="p">(</span><span class="s2">&quot;\\ \\   existing springs:&quot;</span><span class="p">);</span>
                  <span class="k">if</span> <span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">key_alt</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="p">)</span> <span class="p">{</span>
                     <span class="nx">cP</span><span class="p">.</span><span class="nx">Spring</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span> <span class="nx">spring</span> <span class="p">=&gt;</span> <span class="p">{</span>
                        
                        <span class="k">delete</span> <span class="nx">spring</span><span class="p">.</span><span class="nx">softConstraints</span><span class="p">;</span>
                        <span class="k">delete</span> <span class="nx">spring</span><span class="p">.</span><span class="nx">fixedLength</span><span class="p">;</span>
                        <span class="nx">spring</span><span class="p">.</span><span class="nx">softConstraints_setInPars</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                        
                        <span class="k">if</span> <span class="p">(</span><span class="nx">spring</span><span class="p">.</span><span class="nx">b2d</span><span class="p">)</span> <span class="p">{</span>
                           <span class="nx">gW</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">world</span><span class="p">.</span><span class="nx">DestroyJoint</span><span class="p">(</span> <span class="nx">spring</span><span class="p">.</span><span class="nx">b2d</span><span class="p">);</span>
                           <span class="nx">spring</span><span class="p">.</span><span class="nx">b2d</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
                        <span class="p">}</span>

                        <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">addToIt</span><span class="p">(</span><span class="s2">&quot;\\     &quot;</span> <span class="o">+</span> <span class="nx">spring</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot; softConstraint key has been [base,yellow]deleted[base].&quot;</span><span class="p">);</span>
                     <span class="p">});</span>
                  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                     <span class="nx">cP</span><span class="p">.</span><span class="nx">Spring</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span> <span class="nx">spring</span> <span class="p">=&gt;</span> <span class="p">{</span>
                        <span class="kd">let</span> <span class="nx">springNature</span><span class="p">;</span>
                        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">spring</span><span class="p">.</span><span class="nx">softConstraints</span> <span class="o">===</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span> <span class="p">{</span>
                           <span class="nx">springNature</span> <span class="o">=</span> <span class="s2">&quot;[18px Arial,yellow]Hooke&#39;s law[18px Arial]&quot;</span><span class="p">;</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                           <span class="kd">let</span> <span class="nx">lockedString</span> <span class="o">=</span> <span class="p">(</span><span class="nx">spring</span><span class="p">.</span><span class="nx">softConstraints_setInPars</span><span class="p">)</span> <span class="o">?</span> <span class="s2">&quot; (locked)&quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
                           <span class="k">if</span> <span class="p">(</span><span class="nx">spring</span><span class="p">.</span><span class="nx">softConstraints</span><span class="p">)</span> <span class="p">{</span>
                              <span class="kd">let</span> <span class="nx">softOrFixed</span> <span class="o">=</span> <span class="p">(</span><span class="nx">spring</span><span class="p">.</span><span class="nx">fixedLength</span><span class="p">)</span> <span class="o">?</span> <span class="s2">&quot;fixed length&quot;</span> <span class="o">:</span> <span class="s2">&quot;soft constraints&quot;</span><span class="p">;</span>
                              <span class="nx">springNature</span> <span class="o">=</span> <span class="s2">&quot;a [18px Arial,yellow]distance joint[18px Arial] with &quot;</span> <span class="o">+</span> <span class="nx">softOrFixed</span> <span class="o">+</span> <span class="nx">lockedString</span><span class="p">;</span>
                           <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                              <span class="nx">springNature</span> <span class="o">=</span> <span class="s2">&quot;[18px Arial,yellow]Hooke&#39;s law[18px Arial]&quot;</span> <span class="o">+</span> <span class="nx">lockedString</span><span class="p">;</span>
                           <span class="p">}</span>
                        <span class="p">}</span>
                        <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">addToIt</span><span class="p">(</span><span class="s2">&quot;\\[18px Arial,lightgray]     &quot;</span> <span class="o">+</span> <span class="nx">spring</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot; spring nature is &quot;</span> <span class="o">+</span> <span class="nx">springNature</span> <span class="o">+</span> <span class="s2">&quot;[base].&quot;</span><span class="p">);</span>
                     <span class="p">});</span>
                  <span class="p">}</span>
                  
               
               <span class="c1">// Toggle the lock on the pool shot and set the speed value (z key pressed, while control and shift are down).</span>
               <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="nx">keyMap</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">code</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;key_z&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(((</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">key_shift</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">key_ctrl</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">ctrlShiftLock</span><span class="p">))</span> <span class="p">)</span> <span class="p">{</span>
                  <span class="nx">gB</span><span class="p">.</span><span class="nx">togglePoolShotLock</span><span class="p">(</span> <span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">]);</span>
               
               <span class="c1">// Pause NPC navigation.</span>
               <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="nx">keyMap</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">code</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;key_q&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">key_ctrl</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="p">))</span> <span class="p">{</span>
                  <span class="nx">pP</span><span class="p">.</span><span class="nx">setNpcSleep</span><span class="p">(</span> <span class="o">!</span> <span class="nx">pP</span><span class="p">.</span><span class="nx">getNpcSleep</span><span class="p">());</span>
                  <span class="k">if</span> <span class="p">(</span><span class="nx">pP</span><span class="p">.</span><span class="nx">getNpcSleep</span><span class="p">())</span> <span class="p">{</span>
                     <span class="c1">// Keep track of this during game play.</span>
                     <span class="nx">pP</span><span class="p">.</span><span class="nx">setNpcSleepUsage</span><span class="p">(</span> <span class="kc">true</span><span class="p">);</span>
                     <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">resetMessage</span><span class="p">();</span>
                     <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s2">&quot;drones are [base,yellow]sleeping[base]&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
                     <span class="c1">// Make sure their i keys are up, i.e. stop trying to shoot (and calling the bullet stream updater).</span>
                     <span class="nx">cT</span><span class="p">.</span><span class="nx">Client</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span> <span class="nx">client</span> <span class="p">=&gt;</span> <span class="p">{</span><span class="k">if</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;NPC&#39;</span><span class="p">)</span> <span class="nx">client</span><span class="p">.</span><span class="nx">key_i</span> <span class="o">=</span> <span class="s2">&quot;U&quot;</span> <span class="p">});</span>
                  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                     <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s2">&quot;drones are [base,yellow]awake[base]&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
                  <span class="p">}</span>
                  
               <span class="c1">// Set delete (and select) mode offered in the tab menu for multiselect.</span>
               <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">keyMap</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">code</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;key_tab&#39;</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">if</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                     <span class="k">if</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">selectModeIndex</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">selectModeIndex</span><span class="o">++</span><span class="p">;</span>
                        
                        <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">resetStepper</span><span class="p">();</span>
                        
                        <span class="k">if</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">selectMode</span><span class="p">[</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">selectModeIndex</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;springs&quot;</span><span class="p">)</span> <span class="p">{</span>
                           <span class="c1">// populate a list of names of the springs in the multiselect</span>
                           <span class="nx">cP</span><span class="p">.</span><span class="nx">Spring</span><span class="p">.</span><span class="nx">findAll_InMultiSelect</span><span class="p">(</span> <span class="nx">spring</span> <span class="p">=&gt;</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">connectedNames</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">spring</span><span class="p">.</span><span class="nx">name</span><span class="p">));</span>
                           
                        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">selectMode</span><span class="p">[</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">selectModeIndex</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;revolute joints&quot;</span><span class="p">)</span> <span class="p">{</span>
                           <span class="nx">cP</span><span class="p">.</span><span class="nx">Joint</span><span class="p">.</span><span class="nx">findAll_InMultiSelect</span><span class="p">(</span> <span class="nx">joint</span> <span class="p">=&gt;</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">connectedNames</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">joint</span><span class="p">.</span><span class="nx">name</span><span class="p">));</span>
                           
                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                           <span class="c1">// nothing yet</span>
                        <span class="p">}</span>
                        
                     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">selectModeIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                     <span class="p">}</span>
                     <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s2">&quot;select and delete: [base,yellow]&quot;</span> <span class="o">+</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">selectModeMessage</span><span class="p">[</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">selectModeIndex</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;[base]&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
                     
                  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                     <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s2">&quot;Select at least two objects to view the &#39;tab&#39; options for multiselect.&quot;</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">);</span>
                  <span class="p">}</span>
                  
               <span class="c1">// Step through the springs and/or joints in the multiselect.</span>
               <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">keyMap</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">code</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;key_enter&#39;</span><span class="p">)</span> <span class="p">{</span>
                  
                  <span class="k">if</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">selectMode</span><span class="p">[</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">selectModeIndex</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;springs&quot;</span><span class="p">)</span> <span class="p">{</span>
                     <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">stepThroughArray</span><span class="p">(</span> <span class="nx">aT</span><span class="p">.</span><span class="nx">springMap</span><span class="p">);</span>
                  
                  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">selectMode</span><span class="p">[</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">selectModeIndex</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;revolute joints&quot;</span><span class="p">)</span> <span class="p">{</span>
                     <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">stepThroughArray</span><span class="p">(</span> <span class="nx">aT</span><span class="p">.</span><span class="nx">jointMap</span><span class="p">);</span>
                  <span class="p">}</span>
                  
               <span class="c1">// Delete stuff   </span>
               <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="nx">keyMap</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">code</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;key_x&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">key_ctrl</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="p">))</span> <span class="p">{</span>
                  
                  <span class="c1">// First process multi-select</span>
                  <span class="kd">var</span> <span class="nx">foundSpringOrJoint</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                  <span class="kd">let</span> <span class="nx">selectMode</span> <span class="o">=</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">selectMode</span><span class="p">[</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">selectModeIndex</span><span class="p">];</span>
                  
                  <span class="k">if</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                     
                     <span class="k">if</span> <span class="p">([</span><span class="s1">&#39;normal&#39;</span><span class="p">,</span><span class="s1">&#39;springs&#39;</span><span class="p">,</span><span class="s1">&#39;everything&#39;</span><span class="p">].</span><span class="nx">includes</span><span class="p">(</span> <span class="nx">selectMode</span><span class="p">))</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">candidateReportPasteDelete</span><span class="p">)</span> <span class="p">{</span>
                           <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">deleteCandidate</span><span class="p">(</span> <span class="nx">aT</span><span class="p">.</span><span class="nx">springMap</span><span class="p">);</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                           <span class="c1">// Delete each spring that has both it&#39;s pucks (or pins) in the multi-select.</span>
                           <span class="nx">cP</span><span class="p">.</span><span class="nx">Spring</span><span class="p">.</span><span class="nx">findAll_InMultiSelect</span><span class="p">(</span> <span class="nx">spring</span> <span class="p">=&gt;</span> <span class="p">{</span>
                              <span class="nx">spring</span><span class="p">.</span><span class="nx">deleteThisOne</span><span class="p">({});</span>
                              <span class="c1">// This function includes the scope of the function in which it is being defined.</span>
                              <span class="c1">// So foundSpringOrJoint, defined in the surrounding function, is accessible (and changeable) here.</span>
                              <span class="nx">foundSpringOrJoint</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> 
                           <span class="p">});</span>
                        <span class="p">}</span>
                     <span class="p">}</span>
                     
                     <span class="k">if</span> <span class="p">([</span><span class="s1">&#39;normal&#39;</span><span class="p">,</span><span class="s1">&#39;revolute joints&#39;</span><span class="p">,</span><span class="s1">&#39;everything&#39;</span><span class="p">].</span><span class="nx">includes</span><span class="p">(</span> <span class="nx">selectMode</span><span class="p">))</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">candidateReportPasteDelete</span><span class="p">)</span> <span class="p">{</span>
                           <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">deleteCandidate</span><span class="p">(</span> <span class="nx">aT</span><span class="p">.</span><span class="nx">jointMap</span><span class="p">);</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                           <span class="c1">// Delete each revolute joint that has both it&#39;s pucks in the multi-select.</span>
                           <span class="nx">cP</span><span class="p">.</span><span class="nx">Joint</span><span class="p">.</span><span class="nx">findAll_InMultiSelect</span><span class="p">(</span> <span class="nx">joint</span> <span class="p">=&gt;</span> <span class="p">{</span>
                              <span class="nx">joint</span><span class="p">.</span><span class="nx">deleteThisOne</span><span class="p">({});</span>
                              <span class="nx">foundSpringOrJoint</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                           <span class="p">});</span>
                        <span class="p">}</span>
                     <span class="p">}</span>
                     
                     <span class="c1">// If springs have been cleared during first delete, now remove pucks, pins and walls that are still selected.</span>
                     <span class="k">if</span> <span class="p">(</span> <span class="p">([</span><span class="s1">&#39;normal&#39;</span><span class="p">].</span><span class="nx">includes</span><span class="p">(</span> <span class="nx">selectMode</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">foundSpringOrJoint</span><span class="p">))</span> <span class="o">||</span> <span class="p">([</span><span class="s1">&#39;everything&#39;</span><span class="p">].</span><span class="nx">includes</span><span class="p">(</span> <span class="nx">selectMode</span><span class="p">))</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span> <span class="nx">msObject</span> <span class="p">=&gt;</span> <span class="nx">msObject</span><span class="p">.</span><span class="nx">deleteThisOne</span><span class="p">({})</span> <span class="p">);</span>
                        <span class="c1">// reset back to normal mode.</span>
                        <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">selectModeIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                     <span class="p">}</span>
                     <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">hack</span><span class="p">[</span><span class="s1">&#39;deletedSomething&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                     
                  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">selectedBody</span><span class="p">)</span> <span class="p">{</span>
                     <span class="c1">// A single-object selection.</span>
                     <span class="k">if</span> <span class="p">((</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s1">&#39;Puck&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">b2dSensor</span><span class="p">))</span> <span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">deleteBox2dSensor</span><span class="p">();</span>
                     <span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">deleteThisOne</span><span class="p">({</span><span class="s1">&#39;deleteMode&#39;</span><span class="o">:</span><span class="s1">&#39;fromEditor&#39;</span><span class="p">});</span> <span class="c1">// Pucks, pins, and walls all have there own version of this method.</span>
                     <span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">selectedBody</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
                     <span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">cursorSpring</span><span class="p">.</span><span class="nx">deleteThisOne</span><span class="p">({});</span>
                     <span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">cursorSpring</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
                     <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">hack</span><span class="p">[</span><span class="s1">&#39;deletedSomething&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                  <span class="p">}</span>
                  
               <span class="c1">// Identify a spring for copying.</span>
               <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="nx">keyMap</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">code</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;key_c&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">key_ctrl</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="p">))</span> <span class="p">{</span>
                  <span class="c1">// If a candidate was already selected...</span>
                  <span class="k">if</span> <span class="p">((</span><span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">selectMode</span><span class="p">[</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">selectModeIndex</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;springs&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">candidateReportPasteDelete</span><span class="p">))</span> <span class="p">{</span>
                     <span class="nx">cP</span><span class="p">.</span><span class="nx">Spring</span><span class="p">.</span><span class="nx">nameForPasting</span> <span class="o">=</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">candidateReportPasteDelete</span><span class="p">;</span>
                     <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">candidateReportPasteDelete</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
                     <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">selectModeIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                     <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s2">&quot;[25px Arial,yellow]&quot;</span> <span class="o">+</span> <span class="nx">cP</span><span class="p">.</span><span class="nx">Spring</span><span class="p">.</span><span class="nx">nameForPasting</span> <span class="o">+</span> <span class="s2">&quot;[base] will be used as the source spring for copy and paste.&quot;</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">);</span>
                     <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">resetAll</span><span class="p">();</span>
                     
                  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                     <span class="k">if</span> <span class="p">((</span><span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">count</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
                        <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">count</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; selected; need 2 to select a spring&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
                     <span class="p">}</span>
                     <span class="c1">// Clear this out each time ctrl-c is used.</span>
                     <span class="nx">cP</span><span class="p">.</span><span class="nx">Spring</span><span class="p">.</span><span class="nx">nameForPasting</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
                     
                     <span class="c1">// Two bodies in the multi-select, so maybe some springs in there...</span>
                     <span class="k">if</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
                        <span class="c1">// Note: this &quot;no spring&quot; message will be overwritten (immediately) if a spring is found in the block below.</span>
                        <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s2">&quot;2 selected, but no spring&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
                        <span class="nx">cP</span><span class="p">.</span><span class="nx">Spring</span><span class="p">.</span><span class="nx">findAll_InMultiSelect</span><span class="p">(</span> <span class="nx">spring</span> <span class="p">=&gt;</span> <span class="p">{</span>
                           <span class="c1">// Make a reference to the spring. If there is more than one spring attached, this will reference the LAST one!</span>
                           <span class="c1">// Rendering characteristics will be different for this source puck.</span>
                           <span class="nx">cP</span><span class="p">.</span><span class="nx">Spring</span><span class="p">.</span><span class="nx">nameForPasting</span> <span class="o">=</span> <span class="nx">spring</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
                           <span class="c1">// De-select all the springs on these two pucks (so the user doesn&#39;t have to click on empty space).</span>
                           <span class="nx">spring</span><span class="p">.</span><span class="nx">selected</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                        <span class="p">});</span>
                        
                        <span class="k">if</span> <span class="p">(</span><span class="nx">cP</span><span class="p">.</span><span class="nx">Spring</span><span class="p">.</span><span class="nx">nameForPasting</span><span class="p">)</span> <span class="p">{</span>
                           <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s2">&quot;[25px Arial,yellow]&quot;</span> <span class="o">+</span> <span class="nx">cP</span><span class="p">.</span><span class="nx">Spring</span><span class="p">.</span><span class="nx">nameForPasting</span> <span class="o">+</span> <span class="s2">&quot;[base] will be used as the source spring for copy and paste.&quot;</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">);</span>
                        <span class="p">}</span>
                        
                        <span class="c1">// Added this mainly to be used in probing the name of a joint. Not used for copying the joint. Revolve joints are added via the pull-down menu or </span>
                        <span class="c1">// corresponding keyboard shortcut.</span>
                        <span class="nx">cP</span><span class="p">.</span><span class="nx">Joint</span><span class="p">.</span><span class="nx">findAll_InMultiSelect</span><span class="p">(</span> <span class="nx">joint</span> <span class="p">=&gt;</span> <span class="p">{</span>
                           <span class="kd">let</span> <span class="nx">jointMessage</span> <span class="o">=</span> <span class="s2">&quot;[20px Arial,yellow]&quot;</span> <span class="o">+</span> <span class="nx">joint</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot;[base] joint has been deselected.&quot;</span><span class="p">;</span>
                           <span class="k">if</span> <span class="p">(</span><span class="nx">cP</span><span class="p">.</span><span class="nx">Spring</span><span class="p">.</span><span class="nx">nameForPasting</span><span class="p">)</span> <span class="p">{</span>
                              <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">addToIt</span><span class="p">(</span><span class="s1">&#39;\\  &#39;</span> <span class="o">+</span> <span class="nx">jointMessage</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;additionalTime_s&#39;</span><span class="o">:</span><span class="mf">2.0</span><span class="p">});</span>
                           <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                              <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span> <span class="nx">jointMessage</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">);</span>
                           <span class="p">}</span>
                           <span class="c1">// De-select joints</span>
                           <span class="nx">joint</span><span class="p">.</span><span class="nx">selected</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                        <span class="p">});</span>
                        
                        <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">resetAll</span><span class="p">();</span>
                        
                     <span class="c1">// Give help to user if a single body is selected directly with the cursor.</span>
                     <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">selectedBody</span><span class="p">)</span> <span class="p">{</span>
                        <span class="c1">// Put this message lower on the screen than the normal help because use of the control key</span>
                        <span class="c1">// will display a help message listing puck attributes.</span>
                        <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;lowHelp&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s2">&quot;If you would like to replicate a single object, try ctrl-v.&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
                     <span class="p">}</span>
                  <span class="p">}</span>
               
               <span class="c1">// Paste a spring onto a pair of pucks.</span>
               <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">keyMap</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">code</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;key_s&#39;</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">if</span> <span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">key_ctrl</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="p">)</span> <span class="p">{</span>
                     <span class="k">if</span> <span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">key_alt</span> <span class="o">==</span> <span class="s1">&#39;U&#39;</span><span class="p">)</span> <span class="p">{</span>
                        <span class="c1">// paste a copy of a spring.</span>
                        <span class="nx">pasteSpring</span><span class="p">(</span> <span class="kc">false</span><span class="p">);</span>
                     <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">key_alt</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="p">)</span> <span class="p">{</span>
                        <span class="c1">// paste a new (default) spring.</span>
                        <span class="nx">pasteSpring</span><span class="p">(</span> <span class="kc">true</span><span class="p">);</span>
                     <span class="p">}</span>
                  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">demoVersion</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;4.e&#39;</span><span class="p">)</span> <span class="p">{</span>
                     <span class="c1">// Manually, using keyboard, advance to the next shot.</span>
                     <span class="nx">mH</span><span class="p">.</span><span class="nx">setPositions</span><span class="p">({</span><span class="s1">&#39;disableAutoPosition&#39;</span><span class="o">:</span><span class="kc">true</span><span class="p">});</span>
                  <span class="p">}</span>
               
               <span class="c1">// A general copy and paste of the selected bodies.</span>
               <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="nx">keyMap</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">code</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;key_v&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">key_ctrl</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="p">))</span> <span class="p">{</span>
                  <span class="c1">// Single object or a group as selected using the techniques of multiselect.</span>
                  <span class="k">if</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                     <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">pasteCopyAtCursor</span><span class="p">();</span>
                  
                  <span class="c1">// A single object as selected using single select (direct host-cursor selection)</span>
                  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">selectedBody</span><span class="p">)</span> <span class="p">{</span>
                     <span class="kd">var</span> <span class="nx">cn</span> <span class="o">=</span> <span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
                     <span class="k">if</span> <span class="p">((</span><span class="nx">cn</span> <span class="o">==</span> <span class="s2">&quot;Wall&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">cn</span> <span class="o">==</span> <span class="s2">&quot;Pin&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">cn</span> <span class="o">==</span> <span class="s2">&quot;Puck&quot;</span><span class="p">))</span> <span class="p">{</span>
                        <span class="c1">// Put the copy a little to the right of the original. The engine will separate them</span>
                        <span class="c1">// if they overlap (colliding).</span>
                        <span class="kd">var</span> <span class="nx">pos_forCopy_2d_m</span> <span class="o">=</span> <span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">.</span><span class="nx">addTo</span><span class="p">(</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">));</span>
                        <span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">copyThisOne</span><span class="p">({</span><span class="s1">&#39;position_2d_m&#39;</span><span class="o">:</span><span class="nx">pos_forCopy_2d_m</span><span class="p">});</span>
                     <span class="p">}</span>
                  <span class="p">}</span>
                     
               <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">key_shift</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">key_p</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">key_d</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="p">))</span> <span class="p">{</span>
                     <span class="c1">// Make a single-pin drone track at the cursor location (for Puck Popper demos only).</span>
                     <span class="k">if</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">demoIndex</span> <span class="o">==</span> <span class="mi">7</span> <span class="o">||</span> <span class="nx">c</span><span class="p">.</span><span class="nx">demoIndex</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">pP</span><span class="p">.</span><span class="nx">makeNPC_OnSinglePin</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">cP</span><span class="p">.</span><span class="nx">Pin</span><span class="p">.</span><span class="nx">nameIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">cT</span><span class="p">.</span><span class="nx">Client</span><span class="p">.</span><span class="nx">npcIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">mouse_2d_m</span><span class="p">);</span>
                     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s1">&#39;This feature is only available for demos 7 and 8 (Puck Popper).&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
                     <span class="p">}</span>
                  
               <span class="c1">// numbers 0 to 9, run a demo</span>
               <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">code</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;Digit&#39;</span><span class="p">))</span> <span class="p">{</span>
                  <span class="k">if</span> <span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">activeElement</span><span class="p">.</span><span class="nx">tagName</span> <span class="o">==</span> <span class="s1">&#39;BODY&#39;</span><span class="p">)</span> <span class="p">{</span>
                     <span class="nx">dS</span><span class="p">.</span><span class="nx">demoStart</span><span class="p">(</span> <span class="nx">e</span><span class="p">.</span><span class="nx">code</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="kc">false</span><span class="p">);</span>
                  <span class="p">}</span>
               <span class="p">}</span>
                             
            <span class="p">}</span>            
         <span class="p">}</span>
      <span class="p">},</span> <span class="p">{</span><span class="nx">capture</span><span class="o">:</span> <span class="kc">false</span><span class="p">});</span> <span class="c1">//This &quot;false&quot; makes this fire in the bubbling phase (not capturing phase).</span>
      
      <span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;keyup&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">code</span> <span class="k">in</span> <span class="nx">keyMap</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Set the key state to be UP.</span>
            <span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">][</span><span class="nx">keyMap</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">code</span><span class="p">]]</span> <span class="o">=</span> <span class="s1">&#39;U&#39;</span><span class="p">;</span>               
         <span class="p">}</span>
         
         <span class="c1">// Some specific actions.</span>
         
         <span class="c1">// Done with box-based selection.</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">keyMap</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">code</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;key_alt&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">gW</span><span class="p">.</span><span class="nx">hostSelectBox</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
            <span class="c1">// This detach is needed for cases when ctrl-alt is used for multi-body rotations. This suppresses</span>
            <span class="c1">// the fling of the selected body that would result when the alt key is lifted. The &quot;if&quot; condition</span>
            <span class="c1">// keeps the detach operation from firing in general alt key usage, for example when the alt-p</span>
            <span class="c1">// is used to inhibit screen erasing each frame. Wow, that&#39;s a lot of explaining for one line of code.</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">key_ctrl</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="p">)</span> <span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">modifyCursorSpring</span><span class="p">(</span><span class="s1">&#39;detach&#39;</span><span class="p">);</span>
            
         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">keyMap</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">code</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;key_ctrl&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Detach the cursor spring. This prevents unintended movement when releasing the control key.</span>
            <span class="c1">//clients[&#39;local&#39;].modifyCursorSpring(&#39;detach&#39;);</span>
            
            <span class="nx">key_ctrl_handler</span><span class="p">(</span><span class="s1">&#39;keyup&#39;</span><span class="p">,</span> <span class="s1">&#39;local&#39;</span><span class="p">);</span>
            
         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">keyMap</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">code</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;key_shift&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Done with the rotation action. Get ready for the next one.</span>
            <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">resetCenter</span><span class="p">();</span>
            <span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">modifyCursorSpring</span><span class="p">(</span><span class="s1">&#39;detach&#39;</span><span class="p">);</span>
         <span class="p">}</span>
         
      <span class="p">},</span> <span class="p">{</span><span class="nx">capture</span><span class="o">:</span> <span class="kc">false</span><span class="p">});</span> <span class="c1">//This &quot;false&quot; makes this fire in the bubbling phase (not capturing phase).</span>
      
      
      <span class="c1">// Gravity toggle</span>
      <span class="nx">dC</span><span class="p">.</span><span class="nx">gravity</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;chkGravity&#39;</span><span class="p">);</span>
      <span class="kd">function</span> <span class="nx">gravityToggle</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">dC</span><span class="p">.</span><span class="nx">gravity</span><span class="p">.</span><span class="nx">checked</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">c</span><span class="p">.</span><span class="nx">g_ON</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">c</span><span class="p">.</span><span class="nx">g_ON</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
         <span class="p">}</span>
         <span class="nx">dS</span><span class="p">.</span><span class="nx">setGravityRelatedParameters</span><span class="p">({</span><span class="s1">&#39;showMessage&#39;</span><span class="o">:</span><span class="kc">true</span><span class="p">});</span>
      <span class="p">}</span>
      <span class="nx">dC</span><span class="p">.</span><span class="nx">gravity</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;click&quot;</span><span class="p">,</span> <span class="nx">gravityToggle</span><span class="p">,</span> <span class="p">{</span><span class="nx">capture</span><span class="o">:</span> <span class="kc">false</span><span class="p">});</span>
      
      <span class="c1">// COM (Center of Mass) selection toggle</span>
      <span class="nx">dC</span><span class="p">.</span><span class="nx">comSelection</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;chkCOM_Selection&#39;</span><span class="p">);</span>
      <span class="nx">dC</span><span class="p">.</span><span class="nx">comSelection</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;click&quot;</span><span class="p">,</span> <span class="nx">comSelection_Toggle</span><span class="p">,</span> <span class="p">{</span><span class="nx">capture</span><span class="o">:</span> <span class="kc">false</span><span class="p">});</span>
      
      <span class="c1">// Multi-player toggle</span>
      <span class="nx">dC</span><span class="p">.</span><span class="nx">multiplayer</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;chkMultiplayer&#39;</span><span class="p">);</span>
      <span class="nx">dC</span><span class="p">.</span><span class="nx">multiplayer</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;click&quot;</span><span class="p">,</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">toggleMultiplayerStuff</span><span class="p">,</span> <span class="p">{</span><span class="nx">capture</span><span class="o">:</span> <span class="kc">false</span><span class="p">});</span>
      
      <span class="c1">// Stream choke</span>
      <span class="nx">dC</span><span class="p">.</span><span class="nx">stream</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;chkStream&#39;</span><span class="p">);</span>
      <span class="nx">dC</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;click&quot;</span><span class="p">,</span> <span class="nx">toggleStream</span><span class="p">,</span> <span class="p">{</span><span class="nx">capture</span><span class="o">:</span> <span class="kc">false</span><span class="p">});</span>
      <span class="kd">function</span> <span class="nx">toggleStream</span><span class="p">()</span> <span class="p">{</span>
         <span class="c1">// Turn the stream On/Off.</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">dC</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">checked</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">hC</span><span class="p">.</span><span class="nx">setCanvasStream</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="p">);</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">hC</span><span class="p">.</span><span class="nx">setCanvasStream</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">);</span>
         <span class="p">}</span>
      <span class="p">}</span>
      
      <span class="c1">// Player option</span>
      <span class="nx">dC</span><span class="p">.</span><span class="nx">player</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;chkPlayer&#39;</span><span class="p">);</span>
      <span class="nx">dC</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;click&quot;</span><span class="p">,</span> <span class="nx">toggleLocalPlayer</span><span class="p">,</span> <span class="p">{</span><span class="nx">capture</span><span class="o">:</span> <span class="kc">false</span><span class="p">});</span>
      <span class="kd">function</span> <span class="nx">toggleLocalPlayer</span><span class="p">()</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">dC</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">checked</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">player</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">player</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
         <span class="p">}</span>
      <span class="p">}</span>
      
      <span class="c1">// Friendly-fire option</span>
      <span class="nx">dC</span><span class="p">.</span><span class="nx">friendlyFire</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;chkFriendlyFire&#39;</span><span class="p">);</span>
      
      <span class="c1">// Editor checkbox</span>
      <span class="nx">dC</span><span class="p">.</span><span class="nx">editor</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;chkEditor&#39;</span><span class="p">);</span>
      <span class="kd">function</span> <span class="nx">toggleEditorStuff</span><span class="p">()</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">dC</span><span class="p">.</span><span class="nx">editor</span><span class="p">.</span><span class="nx">checked</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s1">&#39;Wall and Pin editing: [base,yellow]ON[base]&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">cP</span><span class="p">.</span><span class="nx">EpL</span><span class="p">.</span><span class="nx">displayReport</span><span class="p">)</span> <span class="nx">cP</span><span class="p">.</span><span class="nx">EpL</span><span class="p">.</span><span class="nx">createEditPin</span><span class="p">();</span>
            <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">hack</span><span class="p">[</span><span class="s1">&#39;editor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s1">&#39;Wall and Pin editing: [base,yellow]OFF[base]&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">cP</span><span class="p">.</span><span class="nx">EpL</span><span class="p">.</span><span class="nx">displayReport</span> <span class="o">&amp;&amp;</span> <span class="nx">cP</span><span class="p">.</span><span class="nx">EpL</span><span class="p">.</span><span class="nx">pinName</span><span class="p">)</span> <span class="nx">cP</span><span class="p">.</span><span class="nx">EpL</span><span class="p">.</span><span class="nx">deleteEditPin</span><span class="p">();</span>
         <span class="p">}</span>
      <span class="p">}</span>
      <span class="nx">dC</span><span class="p">.</span><span class="nx">editor</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;click&quot;</span><span class="p">,</span> <span class="nx">toggleEditorStuff</span><span class="p">,</span> <span class="p">{</span><span class="nx">capture</span><span class="o">:</span> <span class="kc">false</span><span class="p">});</span>
            
      <span class="c1">// Pause toggle</span>
      <span class="nx">dC</span><span class="p">.</span><span class="nx">pause</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;chkPause&#39;</span><span class="p">);</span>
      <span class="nx">dC</span><span class="p">.</span><span class="nx">pause</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;click&quot;</span><span class="p">,</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">setPauseState</span><span class="p">,</span> <span class="p">{</span><span class="nx">capture</span><span class="o">:</span> <span class="kc">false</span><span class="p">});</span>
      
      <span class="c1">// Local cursor toggle</span>
      <span class="nx">dC</span><span class="p">.</span><span class="nx">localCursor</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;chkLocalCursor&#39;</span><span class="p">);</span>
      <span class="nx">dC</span><span class="p">.</span><span class="nx">localCursor</span><span class="p">.</span><span class="nx">checked</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="nx">dC</span><span class="p">.</span><span class="nx">localCursor</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;click&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">dC</span><span class="p">.</span><span class="nx">localCursor</span><span class="p">.</span><span class="nx">checked</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">canvas</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">cursor</span> <span class="o">=</span> <span class="s1">&#39;default&#39;</span><span class="p">;</span>
            <span class="c1">// user must put this string in the chat field before checking the local-cursor box.</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">dC</span><span class="p">.</span><span class="nx">inputField</span><span class="p">.</span><span class="nx">value</span> <span class="o">==</span> <span class="s2">&quot;lagtest&quot;</span><span class="p">)</span> <span class="nx">c</span><span class="p">.</span><span class="nx">lagTesting</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">canvas</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">cursor</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">;</span>
            <span class="nx">dC</span><span class="p">.</span><span class="nx">inputField</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
            <span class="nx">c</span><span class="p">.</span><span class="nx">lagTesting</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
         <span class="p">}</span>
      <span class="p">},</span> <span class="p">{</span><span class="nx">capture</span><span class="o">:</span> <span class="kc">false</span><span class="p">});</span>   
      
      <span class="c1">// NickName fields in help panel for Puck Popper, Ghost Ball, Monkey Hunt, and Bipartisan Hoops.</span>
      <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;input.nickNameField&#39;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;keyup blur&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">key</span> <span class="o">==</span> <span class="s2">&quot;Enter&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">blur</span><span class="p">();</span>
            
            <span class="c1">// Wait a bit just to be sure the blur event has time to process.</span>
            <span class="c1">// Note that the ES6 arrow function has the &quot;this&quot; of the surrounding context. </span>
            <span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
               
               <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">==</span> <span class="s1">&#39;nn_pool&#39;</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">if</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">demoVersion</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;3.d&quot;</span><span class="p">)</span> <span class="p">{</span>
                     <span class="nx">dS</span><span class="p">.</span><span class="nx">demoStart</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
                  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                     <span class="nx">cR</span><span class="p">.</span><span class="nx">demoStart_fromCapture</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;fileName&#39;</span><span class="o">:</span><span class="s1">&#39;demo3d.js&#39;</span><span class="p">});</span>
                  <span class="p">}</span>
                  
               <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">==</span> <span class="s1">&#39;nn_monkeyHunt&#39;</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">if</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">demoVersion</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;4.e&quot;</span><span class="p">)</span> <span class="p">{</span>
                     <span class="nx">dS</span><span class="p">.</span><span class="nx">demoStart</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
                  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                     <span class="nx">cR</span><span class="p">.</span><span class="nx">demoStart_fromCapture</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;fileName&#39;</span><span class="o">:</span><span class="s1">&#39;demo4e.monkeyhunt.js&#39;</span><span class="p">});</span>
                  <span class="p">}</span>
               
               <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">==</span> <span class="s1">&#39;nn_basketball&#39;</span><span class="p">)</span> <span class="p">{</span>
                  <span class="kd">let</span> <span class="nx">secretPW</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#pw_basketball&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span> 
                  <span class="c1">// Always run the base of the politician version, no modified captures allowed here.</span>
                  <span class="k">if</span> <span class="p">(</span><span class="nx">secretPW</span> <span class="o">==</span> <span class="s2">&quot;2122pw&quot;</span><span class="p">)</span> <span class="p">{</span>
                     <span class="nx">cR</span><span class="p">.</span><span class="nx">demoStart_fromCapture</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;fileName&#39;</span><span class="o">:</span><span class="s1">&#39;demo5e.basketball-pol.js&#39;</span><span class="p">});</span>
                     
                  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> 
                     <span class="c1">// Allow modified versions (altered captures) of the party version.</span>
                     <span class="k">if</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">demoVersion</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s2">&quot;5.e.basketball-par&quot;</span><span class="p">))</span> <span class="p">{</span>
                        <span class="nx">dS</span><span class="p">.</span><span class="nx">demoStart</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
                        
                     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nx">cR</span><span class="p">.</span><span class="nx">demoStart_fromCapture</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;fileName&#39;</span><span class="o">:</span><span class="s1">&#39;demo5e.basketball-par.js&#39;</span><span class="p">});</span>
                     <span class="p">}</span>
                  <span class="p">}</span>
                  
               <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">==</span> <span class="s1">&#39;nn_popper7&#39;</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">dS</span><span class="p">.</span><span class="nx">demoStart</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>
                  
               <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">==</span> <span class="s1">&#39;nn_popper8&#39;</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">dS</span><span class="p">.</span><span class="nx">demoStart</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
               <span class="p">}</span>
               
               <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">!=</span> <span class="s1">&#39;nn_popper7&#39;</span><span class="p">)</span> <span class="nx">eVN</span><span class="p">.</span><span class="nx">changeFullScreenMode</span><span class="p">(</span> <span class="nx">canvas</span><span class="p">,</span> <span class="s1">&#39;on&#39;</span><span class="p">);</span>
               
            <span class="p">},</span> <span class="mi">100</span><span class="p">);</span>
            
         
         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;blur&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">let</span> <span class="nx">inputString</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
            <span class="kd">let</span> <span class="nx">cleanString</span> <span class="o">=</span> <span class="nx">inputString</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[^a-zA-Z0-9@]/g</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span> <span class="c1">// allow only alphanumeric and the @ character</span>
            
            <span class="c1">// if too short, clean out the field</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">cleanString</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="nx">cleanString</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
            
            <span class="kd">let</span> <span class="nx">localNickName</span> <span class="o">=</span> <span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">nickName</span><span class="p">;</span>
            
            <span class="kd">let</span> <span class="nx">nameString</span> <span class="o">=</span> <span class="p">(</span><span class="nx">localNickName</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;&quot;&#39;</span><span class="o">+</span><span class="nx">localNickName</span><span class="o">+</span><span class="s1">&#39;&quot;&#39;</span> <span class="o">:</span> <span class="s1">&#39;an anonymous host&#39;</span><span class="p">;</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="nx">hC</span><span class="p">.</span><span class="nx">get_socket</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">cleanString</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">cleanString</span> <span class="o">!=</span> <span class="nx">localNickName</span><span class="p">))</span> <span class="p">{</span>
               <span class="kd">let</span> <span class="nx">message</span> <span class="o">=</span> <span class="s1">&#39;\nYou are connected to the server and identified as &#39;</span><span class="o">+</span><span class="nx">nameString</span><span class="o">+</span><span class="s1">&#39;.\n\n&#39;</span> <span class="o">+</span>
                     <span class="s1">&#39;Please make any changes to your name via the chat field. Then click the &quot;Create&quot; button.\n\n&#39;</span> <span class="o">+</span>
                     <span class="s1">&#39;To get to the chat field, you may need to toggle the left panel using the &quot;m&quot; key.&#39;</span>
               <span class="nx">alert</span><span class="p">(</span> <span class="nx">message</span><span class="p">);</span>
               <span class="nx">cleanString</span> <span class="o">=</span> <span class="nx">localNickName</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">hC</span><span class="p">.</span><span class="nx">get_socket</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">cleanString</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">localNickName</span><span class="p">)</span> <span class="p">{</span>
               <span class="kd">let</span> <span class="nx">message</span> <span class="o">=</span> <span class="s1">&#39;\nYou are connected to the server and identified as &#39;</span><span class="o">+</span><span class="nx">nameString</span><span class="o">+</span><span class="s1">&#39;.\n\n&#39;</span> <span class="o">+</span> 
                     <span class="s1">&#39;If you prefer to go back to being anonymous, type &quot;noname&quot; into the chat field. Then click the &quot;Create&quot; button.\n\n&#39;</span> <span class="o">+</span>
                     <span class="s1">&#39;To get to the chat field, you may need to toggle the left panel using the &quot;m&quot; key.&#39;</span>
               <span class="nx">alert</span><span class="p">(</span> <span class="nx">message</span><span class="p">);</span>
               <span class="nx">cleanString</span> <span class="o">=</span> <span class="nx">localNickName</span><span class="p">;</span>
            <span class="p">}</span>
            
            <span class="c1">// sync all the nickname fields to this value</span>
            <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;input.nickNameField&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span> <span class="nx">cleanString</span><span class="p">);</span>
         <span class="p">}</span>
      <span class="p">});</span>
      
      <span class="c1">// password checker for old version of bipartisan hoops</span>
      <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#pw_basketball&#39;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;keyup&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;2122pw&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">backgroundColor</span> <span class="o">=</span> <span class="s2">&quot;lightgreen&quot;</span><span class="p">;</span>
         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;quiet&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">backgroundColor</span> <span class="o">=</span> <span class="s2">&quot;cyan&quot;</span><span class="p">;</span> <span class="c1">// lightgray</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">backgroundColor</span> <span class="o">=</span> <span class="s2">&quot;#FCF55F&quot;</span><span class="p">;</span>
         <span class="p">};</span>
      <span class="p">});</span>
      
      <span class="c1">// Calculator for two pucks in orbit.</span>
      <span class="kd">function</span> <span class="nx">calcTwoInOrbit</span><span class="p">(</span> <span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">//if (event.data.message) console.log(&quot;message=&quot; + event.data.message);</span>
         
         <span class="kd">let</span> <span class="nx">modificationFunction</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">state_capture</span><span class="p">,</span> <span class="nx">demoName</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">let</span> <span class="nx">vx_init_mps</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#vx_init&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">());</span>
            <span class="kd">let</span> <span class="nx">vy_init_mps</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#vy_init&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">());</span>
            
            <span class="c1">// m*s_t^2/r_o = k(2*r_o - L)  centripetal force = spring force</span>
            
            <span class="c1">// m(rXv) = m(r_o^2 * Omega)   initial angular momentum = final angular momentum</span>
            <span class="c1">// Omega = s_t / r_o           Angular rate = speed / radius</span>
            
            <span class="c1">// r_o * s_t = rXv</span>
            
            <span class="kd">let</span> <span class="nx">puck_A</span> <span class="o">=</span> <span class="nx">state_capture</span><span class="p">[</span><span class="s1">&#39;puckMapData&#39;</span><span class="p">][</span><span class="s1">&#39;puck15&#39;</span><span class="p">];</span>
            <span class="kd">let</span> <span class="nx">puck_B</span> <span class="o">=</span> <span class="nx">state_capture</span><span class="p">[</span><span class="s1">&#39;puckMapData&#39;</span><span class="p">][</span><span class="s1">&#39;puck12&#39;</span><span class="p">];</span>
            
            <span class="kd">let</span> <span class="nx">position_A_2d_m</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D_from_b2Vec2</span><span class="p">(</span> <span class="nx">puck_A</span><span class="p">[</span><span class="s1">&#39;position_2d_m&#39;</span><span class="p">]);</span>
            <span class="kd">let</span> <span class="nx">position_B_2d_m</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D_from_b2Vec2</span><span class="p">(</span> <span class="nx">puck_B</span><span class="p">[</span><span class="s1">&#39;position_2d_m&#39;</span><span class="p">]);</span>
            <span class="kd">let</span> <span class="nx">com_2d_m</span> <span class="o">=</span> <span class="nx">position_A_2d_m</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span> <span class="nx">position_B_2d_m</span><span class="p">).</span><span class="nx">scaleBy</span><span class="p">(</span><span class="mf">0.5</span><span class="p">);</span>
            
            <span class="kd">let</span> <span class="nx">velocity_A_2d_mps</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span> <span class="nx">vx_init_mps</span><span class="p">,</span> <span class="nx">vy_init_mps</span><span class="p">);</span> <span class="c1">// wS.Vec2D_from_b2Vec2( puck_A[&#39;velocity_2d_mps&#39;]);</span>
            
            <span class="kd">let</span> <span class="nx">r_A_2d_m</span> <span class="o">=</span> <span class="nx">position_A_2d_m</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span> <span class="nx">com_2d_m</span><span class="p">);</span>
            <span class="kd">let</span> <span class="nx">rXv</span> <span class="o">=</span> <span class="nx">r_A_2d_m</span><span class="p">.</span><span class="nx">cross</span><span class="p">(</span> <span class="nx">velocity_A_2d_mps</span><span class="p">);</span>
            <span class="kd">let</span> <span class="nx">puck_A_mass_kg</span> <span class="o">=</span> <span class="nx">puck_A</span><span class="p">.</span><span class="nx">density</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span> <span class="o">*</span> <span class="nx">puck_A</span><span class="p">.</span><span class="nx">radius_m</span> <span class="o">**</span> <span class="mi">2</span><span class="p">;</span>
            <span class="kd">let</span> <span class="nx">l_total</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="nx">puck_A_mass_kg</span> <span class="o">*</span> <span class="nx">rXv</span><span class="p">;</span>
            
            <span class="kd">let</span> <span class="nx">spring</span> <span class="o">=</span> <span class="nx">state_capture</span><span class="p">[</span><span class="s1">&#39;springMapData&#39;</span><span class="p">][</span><span class="s1">&#39;s14&#39;</span><span class="p">];</span>
            <span class="kd">let</span> <span class="nx">spring_k</span> <span class="o">=</span> <span class="nx">spring</span><span class="p">[</span><span class="s1">&#39;strength_Npm&#39;</span><span class="p">];</span>
            <span class="kd">let</span> <span class="nx">spring_l_m</span> <span class="o">=</span> <span class="nx">spring</span><span class="p">[</span><span class="s1">&#39;length_m&#39;</span><span class="p">];</span>
            
            <span class="c1">//console.log(&quot;rXv = &quot; + rXv);</span>
            <span class="c1">//console.log(&quot;l_total = &quot; + l_total);</span>
            
            <span class="kd">let</span> <span class="nx">testFunction</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">r</span><span class="p">)</span> <span class="p">{</span>
               <span class="k">return</span> <span class="p">(</span> <span class="nx">spring_k</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="nx">r</span> <span class="o">-</span> <span class="nx">spring_l_m</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="nx">puck_A_mass_kg</span> <span class="o">*</span> <span class="nx">rXv</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="nx">r</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>  <span class="p">);</span>
            <span class="p">}</span>
            <span class="kd">let</span> <span class="nx">orbit_r_m</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">keepGuessing</span><span class="p">(</span> <span class="nx">testFunction</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span>
            
            <span class="kd">let</span> <span class="nx">orbit_speed_mps</span> <span class="o">=</span> <span class="nx">rXv</span> <span class="o">/</span> <span class="nx">orbit_r_m</span><span class="p">;</span>
            <span class="kd">let</span> <span class="nx">orbit_rate_rps</span> <span class="o">=</span> <span class="nx">orbit_speed_mps</span> <span class="o">/</span> <span class="nx">orbit_r_m</span><span class="p">;</span>
            
            <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#orbit_speed&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">orbit_speed_mps</span><span class="p">).</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
            <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#orbit_radius&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span> <span class="nx">orbit_r_m</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
            <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#orbit_rate&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span> <span class="nx">orbit_rate_rps</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
        <span class="p">}</span> 
        <span class="nx">cR</span><span class="p">.</span><span class="nx">modifyForCalculator</span><span class="p">(</span><span class="s2">&quot;5.a.orbitingOnSpring&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;okToRunCapture&quot;</span><span class="o">:</span><span class="kc">false</span><span class="p">,</span> <span class="s2">&quot;theFunction&quot;</span><span class="o">:</span><span class="nx">modificationFunction</span><span class="p">});</span>
      <span class="p">}</span>
      <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;input.twoInOrbit&#39;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;change focus&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="o">:</span><span class="s2">&quot;fromInputEvent&quot;</span><span class="p">},</span> <span class="nx">calcTwoInOrbit</span><span class="p">);</span>
      <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#runTwoInOrbit&#39;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="o">:</span><span class="s2">&quot;fromRunEvent&quot;</span><span class="p">},</span> <span class="nx">calcTwoInOrbit</span><span class="p">);</span>
      
      <span class="c1">// Calculator for inelastic three-puck system.</span>
      <span class="kd">function</span> <span class="nx">calcThreePucks</span><span class="p">(</span> <span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">message</span><span class="p">)</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;message=&quot;</span> <span class="o">+</span> <span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
         
         <span class="kd">let</span> <span class="nx">a_init</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#a_init&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">());</span>
         <span class="kd">let</span> <span class="nx">b_init</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#b_init&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">());</span>
         <span class="kd">let</span> <span class="nx">c_init</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#c_init&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">());</span>
         
         <span class="kd">let</span> <span class="nx">final_rps</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">11</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="nx">a_init</span> <span class="o">+</span> <span class="nx">b_init</span> <span class="o">+</span> <span class="nx">c_init</span><span class="p">);</span>
         
         <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#a_final&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span> <span class="nx">final_rps</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
         <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#b_final&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span> <span class="nx">final_rps</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
         <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#c_final&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span> <span class="nx">final_rps</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
         <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#orbit&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span> <span class="nx">final_rps</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
      <span class="p">}</span>
      <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;input.threePuckCalculator&#39;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;change focus&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="o">:</span><span class="s2">&quot;fromInputEvent&quot;</span><span class="p">},</span> <span class="nx">calcThreePucks</span><span class="p">);</span>
      <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#runFromThreePuckCalc&#39;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="o">:</span><span class="s2">&quot;fromRunEvent&quot;</span><span class="p">},</span> <span class="nx">calcThreePucks</span><span class="p">);</span>
      
      <span class="c1">// Calculator for inelastic two-puck system.</span>
      <span class="kd">function</span> <span class="nx">calcTwoPucks</span><span class="p">(</span> <span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">//if (event.data.message) console.log(&quot;message=&quot; + event.data.message);</span>
         
         <span class="kd">let</span> <span class="nx">a_init</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#a_2p_init&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">());</span>
         <span class="kd">let</span> <span class="nx">b_init</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#b_2p_init&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">());</span>
         
         <span class="kd">let</span> <span class="nx">orbit_rps</span> <span class="o">=</span> <span class="p">(</span><span class="nx">a_init</span> <span class="o">+</span> <span class="nx">b_init</span><span class="p">)</span><span class="o">/</span><span class="mi">6</span><span class="p">;</span>
         <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#orbit_2p&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span> <span class="nx">orbit_rps</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
         
         <span class="c1">//let a_final_rps = ((2 * a_init) - b_init)/3;</span>
         <span class="kd">let</span> <span class="nx">a_final_rps</span> <span class="o">=</span> <span class="nx">a_init</span> <span class="o">-</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">orbit_rps</span><span class="p">);</span>
         <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#a_2p_final&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span> <span class="nx">a_final_rps</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
         
         <span class="c1">//let b_final_rps = ((2 * b_init) - a_init)/3;</span>
         <span class="kd">let</span> <span class="nx">b_final_rps</span> <span class="o">=</span> <span class="nx">b_init</span> <span class="o">-</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">orbit_rps</span><span class="p">);</span>
         <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#b_2p_final&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span> <span class="nx">b_final_rps</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
      <span class="p">}</span>
      <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;input.twoPuckCalculator&#39;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;change focus&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="o">:</span><span class="s2">&quot;fromInputEvent&quot;</span><span class="p">},</span> <span class="nx">calcTwoPucks</span><span class="p">);</span>
      <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#runFromTwoPuckCalc&#39;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="o">:</span><span class="s2">&quot;fromRunEvent&quot;</span><span class="p">},</span> <span class="nx">calcTwoPucks</span><span class="p">);</span>
      
      <span class="c1">// Calculator for inelastic four-puck system.</span>
      <span class="kd">function</span> <span class="nx">calcFourPucks</span><span class="p">(</span> <span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">//if (event.data.message) console.log(&quot;message=&quot; + event.data.message);</span>
         
         <span class="kd">let</span> <span class="nx">a_init</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#a_4p_init&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">());</span>
         <span class="kd">let</span> <span class="nx">b_init</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#b_4p_init&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">());</span>
         <span class="kd">let</span> <span class="nx">c_init</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#c_4p_init&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">());</span>
         <span class="kd">let</span> <span class="nx">d_init</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#d_4p_init&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">());</span>
         
         <span class="kd">let</span> <span class="nx">ac_init_avg</span> <span class="o">=</span> <span class="p">(</span><span class="nx">a_init</span> <span class="o">+</span> <span class="nx">c_init</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
         <span class="kd">let</span> <span class="nx">bd_init_avg</span> <span class="o">=</span> <span class="p">(</span><span class="nx">b_init</span> <span class="o">+</span> <span class="nx">d_init</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
         
         <span class="kd">let</span> <span class="nx">orbit_rps</span> <span class="o">=</span> <span class="p">(</span><span class="nx">a_init</span> <span class="o">+</span> <span class="nx">b_init</span> <span class="o">+</span> <span class="nx">c_init</span> <span class="o">+</span> <span class="nx">d_init</span><span class="p">)</span><span class="o">/</span><span class="mi">20</span><span class="p">;</span>
         <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#orbit_4p&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span> <span class="nx">orbit_rps</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
         
         <span class="c1">//let a_final_rps = orbit_rps + (ac_init_avg - bd_init_avg)/2;</span>
         <span class="kd">let</span> <span class="nx">a_final_rps</span> <span class="o">=</span> <span class="nx">ac_init_avg</span> <span class="o">-</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="nx">orbit_rps</span><span class="p">);</span>
         <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#a_4p_final&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span> <span class="nx">a_final_rps</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
         
         <span class="c1">//let b_final_rps = orbit_rps - (ac_init_avg - bd_init_avg)/2;</span>
         <span class="kd">let</span> <span class="nx">b_final_rps</span> <span class="o">=</span> <span class="nx">bd_init_avg</span> <span class="o">-</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="nx">orbit_rps</span><span class="p">)</span> <span class="p">;</span>
         <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#b_4p_final&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span> <span class="nx">b_final_rps</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
         
         <span class="kd">let</span> <span class="nx">c_final_rps</span> <span class="o">=</span> <span class="nx">a_final_rps</span><span class="p">;</span>
         <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#c_4p_final&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span> <span class="nx">c_final_rps</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
         
         <span class="kd">let</span> <span class="nx">d_final_rps</span> <span class="o">=</span> <span class="nx">b_final_rps</span><span class="p">;</span>
         <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#d_4p_final&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span> <span class="nx">d_final_rps</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
      <span class="p">}</span>
      <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;input.fourPuckCalculator&#39;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;change focus&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="o">:</span><span class="s2">&quot;fromInputEvent&quot;</span><span class="p">},</span> <span class="nx">calcFourPucks</span><span class="p">);</span>
      <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#runFromFourPuckCalc&#39;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="o">:</span><span class="s2">&quot;fromRunEvent&quot;</span><span class="p">},</span> <span class="nx">calcFourPucks</span><span class="p">);</span>
      
      <span class="c1">// Calculator for inelastic six-puck system.</span>
      <span class="kd">function</span> <span class="nx">calcSixPucks</span><span class="p">(</span> <span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">//if (event.data.message) console.log(&quot;message=&quot; + event.data.message);</span>
         
         <span class="kd">let</span> <span class="nx">a_init</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#a_6p_init&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">());</span>
         <span class="kd">let</span> <span class="nx">b_init</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#b_6p_init&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">());</span>
         <span class="kd">let</span> <span class="nx">c_init</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#c_6p_init&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">());</span>
         <span class="kd">let</span> <span class="nx">d_init</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#d_6p_init&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">());</span>
         <span class="kd">let</span> <span class="nx">e_init</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#e_6p_init&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">());</span>
         <span class="kd">let</span> <span class="nx">f_init</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#f_6p_init&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">());</span>
         
         <span class="kd">let</span> <span class="nx">ace_init_avg</span> <span class="o">=</span> <span class="p">(</span><span class="nx">a_init</span> <span class="o">+</span> <span class="nx">c_init</span> <span class="o">+</span> <span class="nx">e_init</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="p">;</span>
         <span class="kd">let</span> <span class="nx">bdf_init_avg</span> <span class="o">=</span> <span class="p">(</span><span class="nx">b_init</span> <span class="o">+</span> <span class="nx">d_init</span> <span class="o">+</span> <span class="nx">f_init</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="p">;</span>
         
         <span class="kd">let</span> <span class="nx">orbit_rps</span> <span class="o">=</span> <span class="p">(</span><span class="nx">a_init</span> <span class="o">+</span> <span class="nx">b_init</span> <span class="o">+</span> <span class="nx">c_init</span> <span class="o">+</span> <span class="nx">d_init</span> <span class="o">+</span> <span class="nx">e_init</span> <span class="o">+</span> <span class="nx">f_init</span><span class="p">)</span><span class="o">/</span><span class="mi">54</span><span class="p">;</span>
         <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#orbit_6p&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span> <span class="nx">orbit_rps</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
         
         <span class="kd">let</span> <span class="nx">a_final_rps</span> <span class="o">=</span> <span class="nx">ace_init_avg</span> <span class="o">-</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="nx">orbit_rps</span><span class="p">);</span>
         <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#a_6p_final&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span> <span class="nx">a_final_rps</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
         
         <span class="kd">let</span> <span class="nx">b_final_rps</span> <span class="o">=</span> <span class="nx">bdf_init_avg</span> <span class="o">-</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="nx">orbit_rps</span><span class="p">)</span> <span class="p">;</span>
         <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#b_6p_final&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span> <span class="nx">b_final_rps</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
         
         <span class="kd">let</span> <span class="nx">c_final_rps</span> <span class="o">=</span> <span class="nx">a_final_rps</span><span class="p">;</span>
         <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#c_6p_final&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span> <span class="nx">c_final_rps</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>         
         <span class="kd">let</span> <span class="nx">e_final_rps</span> <span class="o">=</span> <span class="nx">a_final_rps</span><span class="p">;</span>
         <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#e_6p_final&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span> <span class="nx">e_final_rps</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
         
         <span class="kd">let</span> <span class="nx">d_final_rps</span> <span class="o">=</span> <span class="nx">b_final_rps</span><span class="p">;</span>
         <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#d_6p_final&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span> <span class="nx">d_final_rps</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
         <span class="kd">let</span> <span class="nx">f_final_rps</span> <span class="o">=</span> <span class="nx">b_final_rps</span><span class="p">;</span>
         <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#f_6p_final&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span> <span class="nx">f_final_rps</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
      <span class="p">}</span>
      <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;input.sixPuckCalculator&#39;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;change focus&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="o">:</span><span class="s2">&quot;fromInputEvent&quot;</span><span class="p">},</span> <span class="nx">calcSixPucks</span><span class="p">);</span>
      <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#runFromSixPuckCalc&#39;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="o">:</span><span class="s2">&quot;fromRunEvent&quot;</span><span class="p">},</span> <span class="nx">calcSixPucks</span><span class="p">);</span>
      
      <span class="c1">// Fullscreen button (on host)</span>
      <span class="nx">dC</span><span class="p">.</span><span class="nx">fullScreen</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;btnFullScreen&#39;</span><span class="p">);</span>
      <span class="nx">dC</span><span class="p">.</span><span class="nx">fullScreen</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;click&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
         <span class="nx">eVN</span><span class="p">.</span><span class="nx">changeFullScreenMode</span><span class="p">(</span> <span class="nx">canvas</span><span class="p">,</span> <span class="s1">&#39;on&#39;</span><span class="p">);</span>
      <span class="p">},</span> <span class="p">{</span><span class="nx">capture</span><span class="o">:</span> <span class="kc">false</span><span class="p">});</span>
      
      <span class="c1">// fullscreen links (on host): any link with a class of fullScreenLink</span>
      <span class="nb">document</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s1">&#39;.fullScreenLink&#39;</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">item</span> <span class="p">=&gt;</span> <span class="p">{</span>
         <span class="nx">item</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="nx">event</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="nx">dS</span><span class="p">.</span><span class="nx">setNickNameWithoutConnecting</span><span class="p">();</span>
            <span class="nx">eVN</span><span class="p">.</span><span class="nx">changeFullScreenMode</span><span class="p">(</span> <span class="nx">canvas</span><span class="p">,</span> <span class="s1">&#39;on&#39;</span><span class="p">);</span>
         <span class="p">},</span> <span class="p">{</span><span class="nx">capture</span><span class="o">:</span> <span class="kc">false</span><span class="p">});</span>
      <span class="p">});</span>
      
      <span class="c1">// Fullcanvas button (on host)</span>
      <span class="nx">dC</span><span class="p">.</span><span class="nx">fullCanvas</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;btnFullCanvas&#39;</span><span class="p">);</span>
      <span class="nx">dC</span><span class="p">.</span><span class="nx">fullCanvas</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;click&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
         <span class="c1">// A longer delay is needed with FireFox.</span>
         <span class="kd">var</span> <span class="nx">userAgent</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">;</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">userAgent</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s2">&quot;Firefox&quot;</span><span class="p">))</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">waitForFullScreen</span> <span class="o">=</span> <span class="mi">600</span><span class="p">;</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;firefox detected&quot;</span><span class="p">);</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">waitForFullScreen</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
         <span class="p">}</span>
         
         <span class="c1">// This immediately requests fullscreen and then calls restartAnimationLoop (which pauses the loop if not already paused).</span>
         <span class="c1">// The third parameter delays the restart that&#39;s in restartAnimationLoop. The restart will be 500ms after this next block</span>
         <span class="c1">// which resized the canvas to match the fullscreen viewport.</span>
         <span class="nx">eVN</span><span class="p">.</span><span class="nx">changeFullScreenMode</span><span class="p">(</span> <span class="nx">canvas</span><span class="p">,</span> <span class="s1">&#39;on&#39;</span><span class="p">,</span> <span class="nx">waitForFullScreen</span> <span class="o">+</span> <span class="mi">500</span><span class="p">);</span>
         
         <span class="c1">// Wait for the restart to finish before checking for a pause. The call will cause a single frame to get processed</span>
         <span class="c1">// if the loop is paused. Otherwise, a black screen results from fullCanvas if the animation loop is paused.</span>
         <span class="nx">gW</span><span class="p">.</span><span class="nx">oneFrameIfPaused</span><span class="p">(</span> <span class="nx">waitForFullScreen</span> <span class="o">+</span> <span class="mi">500</span> <span class="o">+</span> <span class="mi">100</span><span class="p">);</span>
         
         <span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="cm">/*            </span>
<span class="cm">            Note that the 5-pixel edge here seems to resolve a system crashing </span>
<span class="cm">            problem on my Intel NUC. The crash happens when exiting fullscreen mode </span>
<span class="cm">            with the esc key when using a 0 or 1 pixel edge. The pattern is </span>
<span class="cm">            full-canvas mode, then esc, then full-screen mode, then esc (crash). </span>
<span class="cm">            */</span>
            <span class="kd">var</span> <span class="nx">edge_px</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>           
            <span class="cm">/*</span>
<span class="cm">            If one or both axes of the original canvas is larger than the window, </span>
<span class="cm">            stretch the axis that has the lowest fractional value (relative to its </span>
<span class="cm">            corresponding window axis). Stretch it in a way that the aspect ratio of </span>
<span class="cm">            the stretched canvas is equal to the aspect ratio of the window. </span>
<span class="cm">            That should yield a canvas that fills the window without cutting </span>
<span class="cm">            off any territory or objects in the original canvas. </span>
<span class="cm">            */</span>
            <span class="kd">var</span> <span class="nx">subwindow_px_w</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">innerWidth</span> <span class="o">-</span> <span class="nx">edge_px</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">subwindow_px_h</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">innerHeight</span> <span class="o">-</span> <span class="nx">edge_px</span><span class="p">;</span>
            
            <span class="kd">var</span> <span class="nx">width_ratio</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span> <span class="o">/</span> <span class="nb">window</span><span class="p">.</span><span class="nx">innerWidth</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">height_ratio</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span> <span class="o">/</span> <span class="nb">window</span><span class="p">.</span><span class="nx">innerHeight</span><span class="p">;</span>
            
            <span class="k">if</span> <span class="p">((</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span> <span class="o">&gt;</span> <span class="nx">subwindow_px_w</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span> <span class="o">&gt;</span> <span class="nx">subwindow_px_h</span><span class="p">))</span> <span class="p">{</span>
               <span class="k">if</span> <span class="p">(</span><span class="nx">width_ratio</span> <span class="o">&lt;</span> <span class="nx">height_ratio</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span> <span class="o">*</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">innerWidth</span> <span class="o">/</span> <span class="nb">window</span><span class="p">.</span><span class="nx">innerHeight</span><span class="p">);</span>
               <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                  <span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span> <span class="o">*</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">innerHeight</span> <span class="o">/</span> <span class="nb">window</span><span class="p">.</span><span class="nx">innerWidth</span><span class="p">);</span>
               <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
               <span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span>  <span class="o">=</span> <span class="nx">subwindow_px_w</span><span class="p">;</span>
               <span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">subwindow_px_h</span><span class="p">;</span>               
            <span class="p">}</span>
                    
            <span class="c1">// This apparently needs to be reset after the canvas dimensional changes above.</span>
            <span class="c1">// (only needed for the color mixing demo #9)</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">demoIndex</span> <span class="o">==</span> <span class="mi">9</span><span class="p">)</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">globalCompositeOperation</span> <span class="o">=</span> <span class="s1">&#39;screen&#39;</span><span class="p">;</span>
            
            <span class="c1">// If there is a fence, take it down and put up a new one running along the edge of the canvas.</span>
            <span class="c1">// (leave the fence as-is when playing pool) </span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">cP</span><span class="p">.</span><span class="nx">Wall</span><span class="p">.</span><span class="nx">checkForFence</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">demoVersion</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;3.d&quot;</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
               <span class="k">if</span> <span class="p">(</span> <span class="p">[</span><span class="s1">&#39;1.c&#39;</span><span class="p">,</span><span class="s1">&#39;1.d&#39;</span><span class="p">,</span><span class="s1">&#39;1.e&#39;</span><span class="p">].</span><span class="nx">includes</span><span class="p">(</span> <span class="nx">dS</span><span class="p">.</span><span class="nx">demoVersionBase</span><span class="p">(</span> <span class="nx">c</span><span class="p">.</span><span class="nx">demoVersion</span><span class="p">))</span> <span class="p">)</span> <span class="p">{</span>
                  <span class="nx">cP</span><span class="p">.</span><span class="nx">Wall</span><span class="p">.</span><span class="nx">deleteFence</span><span class="p">();</span>
                  <span class="c1">// Have only a top wall for the pi-calc demos</span>
                  <span class="nx">cP</span><span class="p">.</span><span class="nx">Wall</span><span class="p">.</span><span class="nx">makeFence</span><span class="p">({</span><span class="s1">&#39;bOn&#39;</span><span class="o">:</span><span class="kc">false</span><span class="p">,</span> <span class="s1">&#39;rOn&#39;</span><span class="o">:</span><span class="kc">false</span><span class="p">,</span> <span class="s1">&#39;lOn&#39;</span><span class="o">:</span><span class="kc">false</span><span class="p">},</span> <span class="nx">canvas</span><span class="p">);</span> 
               <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                  <span class="kd">let</span> <span class="nx">currentFenceParameters</span> <span class="o">=</span> <span class="nx">cP</span><span class="p">.</span><span class="nx">Wall</span><span class="p">.</span><span class="nx">getFenceParms</span><span class="p">();</span>
                  <span class="c1">//console.log(&quot;fenceParms=&quot; + JSON.stringify( currentFenceParameters) );</span>
                  <span class="nx">cP</span><span class="p">.</span><span class="nx">Wall</span><span class="p">.</span><span class="nx">deleteFence</span><span class="p">();</span>
                  <span class="nx">cP</span><span class="p">.</span><span class="nx">Wall</span><span class="p">.</span><span class="nx">makeFence</span><span class="p">(</span> <span class="nx">currentFenceParameters</span><span class="p">,</span> <span class="nx">canvas</span><span class="p">);</span>
               <span class="p">}</span>
            <span class="p">}</span>
            
            <span class="c1">// Let the clients know that the canvas dimensions have changed.</span>
            <span class="nx">setClientCanvasToMatchHost</span><span class="p">();</span>
            <span class="c1">// Capture the new layout so the demo can be restarted without having to run this again.</span>
            <span class="nx">cR</span><span class="p">.</span><span class="nx">saveState</span><span class="p">();</span>
            
         <span class="p">},</span> <span class="nx">waitForFullScreen</span><span class="p">);</span> <span class="c1">// delay needed for Firefox</span>
         
      <span class="p">},</span> <span class="p">{</span><span class="nx">capture</span><span class="o">:</span> <span class="kc">false</span><span class="p">});</span>
      
      <span class="c1">// Button on host for posting captures to CloudFlare</span>
      <span class="nx">dC</span><span class="p">.</span><span class="nx">postToCloud</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;button-postToCloud&#39;</span><span class="p">);</span>
      <span class="nx">dC</span><span class="p">.</span><span class="nx">postToCloud</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;click&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
         <span class="kd">let</span> <span class="nx">warningMessage</span><span class="p">,</span> <span class="nx">acceptLabel</span><span class="p">,</span> <span class="nx">purpose</span><span class="p">,</span> <span class="nx">title</span><span class="p">;</span>
         
         <span class="kd">let</span> <span class="nx">leftPanelInfo</span> <span class="o">=</span> <span class="s2">&quot;&lt;li class=&#39;dialog&#39;&gt;Responses from the server are displayed in the chat (left panel).&quot;</span><span class="p">;</span>
         <span class="kd">let</span> <span class="nx">deletAndUpdatInfo</span> <span class="o">=</span> <span class="s2">&quot;&lt;ul class=&#39;dialog&#39;&gt;&quot;</span> <span class="o">+</span>
                                 <span class="s2">&quot;&lt;li class=&#39;dialog&#39;&gt;This will target the cloud capture having the same name &quot;</span> <span class="o">+</span>
                                     <span class="s2">&quot;as the local capture&#39;s demoVersion (right panel).&quot;</span> <span class="o">+</span>
                                 <span class="nx">leftPanelInfo</span> <span class="o">+</span> 
                                 <span class="s2">&quot;&lt;/ul&gt;&quot;</span><span class="p">;</span>
         
         <span class="k">if</span> <span class="p">((</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">key_ctrl</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">key_shift</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">warningMessage</span> <span class="o">=</span> <span class="s2">&quot;This will attempt to DELETE the corresponding capture in cloud storage.&lt;br&gt;&quot;</span> <span class="o">+</span> 
                             <span class="nx">deletAndUpdatInfo</span> <span class="o">+</span>
                             <span class="s2">&quot;&quot;</span><span class="p">;</span> <span class="c1">// Continue ?</span>
            <span class="nx">acceptLabel</span> <span class="o">=</span> <span class="s2">&quot;DELETE&quot;</span><span class="p">;</span>
            <span class="nx">purpose</span> <span class="o">=</span> <span class="s2">&quot;post-delete&quot;</span><span class="p">;</span>
            <span class="nx">title</span> <span class="o">=</span> <span class="s2">&quot;DELETE&quot;</span><span class="p">;</span>
            
         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">key_shift</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">warningMessage</span> <span class="o">=</span> <span class="s2">&quot;This will attempt to UPDATE the corresponding capture in cloud storage.&lt;br&gt;&quot;</span> <span class="o">+</span>
                             <span class="nx">deletAndUpdatInfo</span> <span class="o">+</span>
                             <span class="s2">&quot;&quot;</span><span class="p">;</span> <span class="c1">// Continue ?</span>
            <span class="nx">acceptLabel</span> <span class="o">=</span> <span class="s2">&quot;UPDATE&quot;</span><span class="p">;</span>
            <span class="nx">purpose</span> <span class="o">=</span> <span class="s2">&quot;post-update&quot;</span><span class="p">;</span>
            <span class="nx">title</span> <span class="o">=</span> <span class="s2">&quot;UPDATE&quot;</span><span class="p">;</span>
            
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">warningMessage</span> <span class="o">=</span> <span class="s2">&quot;This will attempt to POST the current capture to cloud storage.&lt;br&gt;&quot;</span> <span class="o">+</span> 
                             <span class="s2">&quot;&lt;ul class=&#39;dialog&#39;&gt;&quot;</span> <span class="o">+</span>
                                <span class="s2">&quot;&lt;li class=&#39;dialog&#39;&gt;To UPDATE a previously posted cloud capture, &quot;</span> <span class="o">+</span>
                                    <span class="s2">&quot;click the P button while holding the SHIFT key down.&quot;</span> <span class="o">+</span>
                                <span class="s2">&quot;&lt;li class=&#39;dialog&#39;&gt;To DELETE a cloud capture, click the P button while &quot;</span> <span class="o">+</span> 
                                    <span class="s2">&quot;holding the CTRL and SHIFT keys down.&quot;</span> <span class="o">+</span>
                                <span class="nx">leftPanelInfo</span> <span class="o">+</span> 
                             <span class="s2">&quot;&lt;/ul&gt;&quot;</span> <span class="o">+</span>
                             <span class="s2">&quot;&quot;</span><span class="p">;</span> <span class="c1">// Continue ?</span>
            <span class="nx">acceptLabel</span> <span class="o">=</span> <span class="s2">&quot;POST&quot;</span><span class="p">;</span>
            <span class="nx">purpose</span> <span class="o">=</span> <span class="s2">&quot;post-normal&quot;</span><span class="p">;</span>
            <span class="nx">title</span> <span class="o">=</span> <span class="s2">&quot;POST&quot;</span><span class="p">;</span>
         <span class="p">}</span>
         
         <span class="nx">pS</span><span class="p">.</span><span class="nx">viewGeneralDialog</span><span class="p">({</span><span class="s2">&quot;title&quot;</span><span class="o">:</span><span class="nx">title</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="o">:</span><span class="nx">warningMessage</span><span class="p">,</span>
                               <span class="s2">&quot;label_accept&quot;</span><span class="o">:</span><span class="nx">acceptLabel</span><span class="p">,</span> <span class="s2">&quot;label_reject&quot;</span><span class="o">:</span><span class="s2">&quot;cancel&quot;</span><span class="p">,</span>  <span class="c1">// &quot;label_close&quot;:&quot;close&quot;,</span>
                               <span class="s2">&quot;purpose&quot;</span><span class="o">:</span><span class="nx">purpose</span><span class="p">});</span>
         
      <span class="p">},</span> <span class="p">{</span><span class="nx">capture</span><span class="o">:</span> <span class="kc">false</span><span class="p">});</span>
      
      <span class="c1">// For handling full-screen mode changes</span>
      <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;webkitfullscreenchange mozfullscreenchange fullscreenchange msfullscreenchange&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">// Check the state:</span>
         <span class="c1">// Starting fullscreen</span>
         <span class="k">if</span> <span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">fullscreenElement</span> <span class="o">||</span> <span class="nb">document</span><span class="p">.</span><span class="nx">mozFullScreenElement</span> <span class="o">||</span> <span class="nb">document</span><span class="p">.</span><span class="nx">webkitFullscreenElement</span> <span class="o">||</span> <span class="nb">document</span><span class="p">.</span><span class="nx">msFullscreenElement</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;fullscreen state: TRUE&#39;</span><span class="p">);</span>
            <span class="nx">c</span><span class="p">.</span><span class="nx">fullScreenState</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="nx">canvas</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">borderWidth</span> <span class="o">=</span> <span class="s1">&#39;0px&#39;</span><span class="p">;</span>
            <span class="nx">canvas</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">backgroundColor</span> <span class="o">=</span> <span class="s1">&#39;#000000&#39;</span><span class="p">;</span> <span class="c1">// black for viewing fullscreen</span>
         
         <span class="c1">// Exiting fullscreen</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;fullscreen state: FALSE&#39;</span><span class="p">);</span>
            <span class="nx">c</span><span class="p">.</span><span class="nx">fullScreenState</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
            <span class="nx">canvas</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">borderWidth</span> <span class="o">=</span> <span class="s1">&#39;5px&#39;</span><span class="p">;</span>
            <span class="cm">/*</span>
<span class="cm">            If background color matches border color, it hides the border-edge </span>
<span class="cm">            problem in Chrome. This fix is inhibited during times when the canvas </span>
<span class="cm">            animation loop is stopped or when the screen erasing is stopped. These </span>
<span class="cm">            conditions, coupled with going in and out of full-screen and full-canvas </span>
<span class="cm">            mode, will leave the whole canvas colored in the border color. So have </span>
<span class="cm">            to handle with care. In these cases, the fix is re-enabled in </span>
<span class="cm">            gW.setPauseState. Note: the problem can still be seen when exiting </span>
<span class="cm">            full-screen (not full-canvas) mode when paused. It&#39;s a small gap by the </span>
<span class="cm">            right-side border.</span>
<span class="cm">            */</span>
            <span class="k">if</span> <span class="p">((</span> <span class="o">!</span> <span class="nx">c</span><span class="p">.</span><span class="nx">pauseErase</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">dC</span><span class="p">.</span><span class="nx">pause</span><span class="p">.</span><span class="nx">checked</span><span class="p">))</span> <span class="p">{</span>
               <span class="nx">canvas</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">backgroundColor</span> <span class="o">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">borderAndBackGroundColor</span><span class="p">;</span> 
            <span class="p">}</span>
            
            <span class="nx">gW</span><span class="p">.</span><span class="nx">restartAnimationLoop</span><span class="p">(</span> <span class="mi">500</span><span class="p">);</span>
         <span class="p">}</span>
      <span class="p">});</span>
   <span class="p">}</span>
   
   <span class="c1">// Public references to objects, variables, and methods</span>
   
   <span class="k">return</span> <span class="p">{</span>
      <span class="c1">// Objects</span>
      
      <span class="c1">// Variables</span>
      
      <span class="c1">// Methods</span>
      <span class="s1">&#39;initializeModule&#39;</span><span class="o">:</span> <span class="nx">initializeModule</span><span class="p">,</span>
      <span class="s1">&#39;initializeEventListeners&#39;</span><span class="o">:</span> <span class="nx">initializeEventListeners</span><span class="p">,</span>
      
      <span class="s1">&#39;wheelEvent_handler&#39;</span><span class="o">:</span> <span class="nx">wheelEvent_handler</span><span class="p">,</span>
      <span class="s1">&#39;mouseUp_handler&#39;</span><span class="o">:</span> <span class="nx">mouseUp_handler</span><span class="p">,</span>
      <span class="s1">&#39;key_ctrl_handler&#39;</span><span class="o">:</span> <span class="nx">key_ctrl_handler</span><span class="p">,</span>
      <span class="s1">&#39;key_b_handler&#39;</span><span class="o">:</span> <span class="nx">key_b_handler</span><span class="p">,</span>
      <span class="s1">&#39;key_c_handler&#39;</span><span class="o">:</span> <span class="nx">key_c_handler</span><span class="p">,</span>
      <span class="s1">&#39;key_l_handler&#39;</span><span class="o">:</span> <span class="nx">key_l_handler</span><span class="p">,</span>
      <span class="s1">&#39;key_n_handler&#39;</span><span class="o">:</span> <span class="nx">key_n_handler</span><span class="p">,</span>
      
      <span class="s1">&#39;pasteSpring&#39;</span><span class="o">:</span> <span class="nx">pasteSpring</span><span class="p">,</span>
      <span class="s1">&#39;addRevoluteJoint&#39;</span><span class="o">:</span> <span class="nx">addRevoluteJoint</span><span class="p">,</span>
      
      <span class="s1">&#39;freeze&#39;</span><span class="o">:</span> <span class="nx">freeze</span><span class="p">,</span>
      <span class="s1">&#39;stopRotation&#39;</span><span class="o">:</span> <span class="nx">stopRotation</span><span class="p">,</span>
      <span class="s1">&#39;reverseDirection&#39;</span><span class="o">:</span> <span class="nx">reverseDirection</span><span class="p">,</span>

      <span class="s1">&#39;setClientCanvasToMatchHost&#39;</span><span class="o">:</span> <span class="nx">setClientCanvasToMatchHost</span><span class="p">,</span>    
      
   <span class="p">};</span>   
   
<span class="p">})();</span>
</pre></div>
</body>
</html>
