<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">
<!--
generated by Pygments <http://pygments.org>
Copyright 2006-2019 by the Pygments team.
Licensed under the BSD license, see LICENSE for details.
-->
<html>
<head>
  <title>utilities.js</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <style type="text/css">
/*
generated by Pygments <http://pygments.org>
Copyright 2006-2019 by the Pygments team.
Licensed under the BSD license, see LICENSE for details.
*/
td.linenos { background-color: #f0f0f0; padding-right: 10px; }
span.lineno { background-color: #f0f0f0; padding: 0 5px 0 5px; }
pre { line-height: 125%; }
body .hll { background-color: #ffffcc }
body  { background: #f8f8f8; }
body .c { color: #408080; font-style: italic } /* Comment */
body .err { border: 1px solid #FF0000 } /* Error */
body .k { color: #008000; font-weight: bold } /* Keyword */
body .o { color: #666666 } /* Operator */
body .ch { color: #408080; font-style: italic } /* Comment.Hashbang */
body .cm { color: #408080; font-style: italic } /* Comment.Multiline */
body .cp { color: #BC7A00 } /* Comment.Preproc */
body .cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */
body .c1 { color: #408080; font-style: italic } /* Comment.Single */
body .cs { color: #408080; font-style: italic } /* Comment.Special */
body .gd { color: #A00000 } /* Generic.Deleted */
body .ge { font-style: italic } /* Generic.Emph */
body .gr { color: #FF0000 } /* Generic.Error */
body .gh { color: #000080; font-weight: bold } /* Generic.Heading */
body .gi { color: #00A000 } /* Generic.Inserted */
body .go { color: #888888 } /* Generic.Output */
body .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
body .gs { font-weight: bold } /* Generic.Strong */
body .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
body .gt { color: #0044DD } /* Generic.Traceback */
body .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
body .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
body .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
body .kp { color: #008000 } /* Keyword.Pseudo */
body .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
body .kt { color: #B00040 } /* Keyword.Type */
body .m { color: #666666 } /* Literal.Number */
body .s { color: #BA2121 } /* Literal.String */
body .na { color: #7D9029 } /* Name.Attribute */
body .nb { color: #008000 } /* Name.Builtin */
body .nc { color: #0000FF; font-weight: bold } /* Name.Class */
body .no { color: #880000 } /* Name.Constant */
body .nd { color: #AA22FF } /* Name.Decorator */
body .ni { color: #999999; font-weight: bold } /* Name.Entity */
body .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
body .nf { color: #0000FF } /* Name.Function */
body .nl { color: #A0A000 } /* Name.Label */
body .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
body .nt { color: #008000; font-weight: bold } /* Name.Tag */
body .nv { color: #19177C } /* Name.Variable */
body .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
body .w { color: #bbbbbb } /* Text.Whitespace */
body .mb { color: #666666 } /* Literal.Number.Bin */
body .mf { color: #666666 } /* Literal.Number.Float */
body .mh { color: #666666 } /* Literal.Number.Hex */
body .mi { color: #666666 } /* Literal.Number.Integer */
body .mo { color: #666666 } /* Literal.Number.Oct */
body .sa { color: #BA2121 } /* Literal.String.Affix */
body .sb { color: #BA2121 } /* Literal.String.Backtick */
body .sc { color: #BA2121 } /* Literal.String.Char */
body .dl { color: #BA2121 } /* Literal.String.Delimiter */
body .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
body .s2 { color: #BA2121 } /* Literal.String.Double */
body .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
body .sh { color: #BA2121 } /* Literal.String.Heredoc */
body .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
body .sx { color: #008000 } /* Literal.String.Other */
body .sr { color: #BB6688 } /* Literal.String.Regex */
body .s1 { color: #BA2121 } /* Literal.String.Single */
body .ss { color: #19177C } /* Literal.String.Symbol */
body .bp { color: #008000 } /* Name.Builtin.Pseudo */
body .fm { color: #0000FF } /* Name.Function.Magic */
body .vc { color: #19177C } /* Name.Variable.Class */
body .vg { color: #19177C } /* Name.Variable.Global */
body .vi { color: #19177C } /* Name.Variable.Instance */
body .vm { color: #19177C } /* Name.Variable.Magic */
body .il { color: #666666 } /* Literal.Number.Integer.Long */

  </style>
</head>
<body>
<h2></h2>

<div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm">Copyright 2022 James D. Miller</span>

<span class="cm">Permission is hereby granted, free of charge, to any person obtaining a copy</span>
<span class="cm">of this software and associated documentation files (the &quot;Software&quot;), to deal</span>
<span class="cm">in the Software without restriction, including without limitation the rights</span>
<span class="cm">to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
<span class="cm">copies of the Software, and to permit persons to whom the Software is</span>
<span class="cm">furnished to do so, subject to the following conditions:</span>

<span class="cm">The above copyright notice and this permission notice shall be included in all</span>
<span class="cm">copies or substantial portions of the Software.</span>

<span class="cm">THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="cm">IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="cm">FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
<span class="cm">AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<span class="cm">LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span>
<span class="cm">OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="cm">SOFTWARE.</span>
<span class="cm">*/</span>

<span class="c1">// Utilities (uT) module</span>
<span class="c1">// utilities.js </span>
   <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;uT _*-*_&#39;</span><span class="p">);</span>
<span class="c1">// 11:25 AM Sat December 9, 2023</span>

<span class="cm">/*</span>
<span class="cm">gwModule.js has an alphabetical list of all modules and their nicknames as added to the windows namespace.</span>
<span class="cm">*/</span>

<span class="nb">window</span><span class="p">.</span><span class="nx">uT</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
   <span class="s2">&quot;use strict&quot;</span><span class="p">;</span>
   
   <span class="c1">// Returns the default if the value is undefined.</span>
   <span class="kd">function</span> <span class="nx">setDefault</span><span class="p">(</span> <span class="nx">theValue</span><span class="p">,</span> <span class="nx">theDefault</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">theValue</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span> <span class="o">?</span> <span class="nx">theValue</span> <span class="o">:</span> <span class="nx">theDefault</span><span class="p">;</span>
   <span class="p">}</span>
   
   <span class="kd">function</span> <span class="nx">setDefaultVector</span><span class="p">(</span> <span class="nx">theValue</span><span class="p">,</span> <span class="nx">theDefault</span><span class="p">,</span> <span class="nx">mode</span><span class="o">=</span><span class="s2">&quot;noCopy&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">theResult</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">theValue</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">((</span><span class="nx">theValue</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;Vec2D&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">mode</span> <span class="o">==</span> <span class="s2">&quot;copy&quot;</span><span class="p">))</span>  <span class="p">{</span>
            <span class="nx">theResult</span> <span class="o">=</span> <span class="nx">theValue</span><span class="p">.</span><span class="nx">copy</span><span class="p">();</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s1">&#39;Warning: failed attempt to copy a vector.&#39;</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">);</span>
            <span class="nx">theResult</span> <span class="o">=</span> <span class="nx">theValue</span><span class="p">;</span>
         <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>  
         <span class="nx">theResult</span> <span class="o">=</span> <span class="nx">theDefault</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">theResult</span><span class="p">;</span>
   <span class="p">}</span>
   
   <span class="kd">function</span> <span class="nx">isPrimitive</span><span class="p">(</span> <span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">val</span> <span class="o">===</span> <span class="nb">Object</span><span class="p">(</span><span class="nx">val</span><span class="p">))</span> <span class="p">{</span>
         <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span>   
   
   <span class="kd">function</span> <span class="nx">fixed</span><span class="p">(</span> <span class="nx">numberValue</span><span class="p">,</span> <span class="nx">nDigits</span><span class="p">,</span> <span class="nx">padding</span><span class="o">=</span><span class="p">(</span><span class="nx">nDigits</span><span class="o">+</span><span class="mi">5</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">absValue</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span> <span class="nx">numberValue</span><span class="p">);</span>
      <span class="kd">let</span> <span class="nx">stringValue</span> <span class="o">=</span> <span class="nx">absValue</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span> <span class="nx">nDigits</span><span class="p">);</span>
      <span class="kd">let</span> <span class="nx">signChar</span><span class="p">;</span>
      <span class="kd">let</span> <span class="nx">small</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="nx">nDigits</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">numberValue</span> <span class="o">&lt;</span> <span class="p">(</span><span class="o">-</span><span class="nx">small</span><span class="p">))</span> <span class="p">{</span>
         <span class="nx">signChar</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span><span class="p">;</span> <span class="c1">//String.fromCharCode(8722);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">numberValue</span> <span class="o">&gt;</span> <span class="p">(</span><span class="o">+</span><span class="nx">small</span><span class="p">))</span> <span class="p">{</span>
         <span class="nx">signChar</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="nx">signChar</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">stringValue</span> <span class="o">=</span> <span class="nx">signChar</span> <span class="o">+</span> <span class="nx">stringValue</span><span class="p">;</span>
      <span class="kd">let</span> <span class="nx">paddedStringValue</span> <span class="o">=</span> <span class="nx">stringValue</span><span class="p">.</span><span class="nx">padStart</span><span class="p">(</span> <span class="nx">padding</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">);</span>      
      <span class="k">return</span> <span class="nx">paddedStringValue</span><span class="p">;</span>
   <span class="p">}</span>
   
   <span class="kd">function</span> <span class="nx">oneOfThese</span><span class="p">(</span> <span class="nx">demoList</span><span class="p">,</span> <span class="nx">captureName</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// &quot;demoList&quot; is an array of strings, usually a list of demos.</span>
      <span class="c1">// &quot;captureName&quot; is a demo name or corresponding capture name with an extension in the name.</span>
      <span class="c1">// The map array method applies the includes string method to see if any of the strings in the array is a </span>
      <span class="c1">// substring of the capture name. Map returns an array (of boolean results) which is then</span>
      <span class="c1">// checked for any True values.</span>
      <span class="c1">// This can be used to check if a capture name has a match against a list of demos.  </span>
      <span class="k">return</span> <span class="nx">demoList</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span> <span class="p">(</span><span class="nx">nameInList</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">captureName</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span> <span class="nx">nameInList</span><span class="p">)</span> <span class="p">).</span><span class="nx">includes</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
   <span class="p">}</span>
   
   <span class="kd">function</span> <span class="nx">toggleElementDisplay</span><span class="p">(</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">displayStyle</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">e</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span> <span class="nx">id</span><span class="p">);</span>
      <span class="c1">// Use ternary operator (?):   condition ? expr1 : expr2</span>
      <span class="c1">// If the current style isn&#39;t equal to the incoming displayStyle, set it to be displayStyle. </span>
      <span class="c1">// If it is equal, set it to &#39;none&#39;. When the value is &#39;none&#39;, the element is hidden.</span>
      <span class="c1">// The effect of this function is that repeated calls to it, with the same displayStyle value, will</span>
      <span class="c1">// toggle the style between &#39;none&#39; and the specified style value.</span>
      <span class="nx">e</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">!=</span> <span class="nx">displayStyle</span><span class="p">)</span> <span class="o">?</span> <span class="nx">displayStyle</span> <span class="o">:</span> <span class="s1">&#39;none&#39;</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="kd">function</span> <span class="nx">setElementDisplay</span><span class="p">(</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">displayStyle</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">e</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span> <span class="nx">id</span><span class="p">);</span>
      <span class="nx">e</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="nx">displayStyle</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="kd">function</span> <span class="nx">toggleSpanValue</span><span class="p">(</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">value1</span><span class="p">,</span> <span class="nx">value2</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">e</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span> <span class="nx">id</span><span class="p">);</span>
      <span class="nx">e</span><span class="p">.</span><span class="nx">innerText</span> <span class="o">=</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">innerText</span> <span class="o">==</span> <span class="nx">value1</span><span class="p">)</span> <span class="o">?</span> <span class="nx">value2</span> <span class="o">:</span> <span class="nx">value1</span><span class="p">;</span> 
   <span class="p">}</span>
   <span class="kd">function</span> <span class="nx">getSpanValue</span><span class="p">(</span> <span class="nx">id</span><span class="p">)</span> <span class="p">{</span>  
      <span class="kd">var</span> <span class="nx">e</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span> <span class="nx">id</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">e</span><span class="p">.</span><span class="nx">innerText</span><span class="p">;</span>
   <span class="p">}</span>
   
   <span class="kd">function</span> <span class="nx">RunningAverage</span><span class="p">(</span> <span class="nx">n_target</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">n_target</span> <span class="o">=</span> <span class="nx">n_target</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
   <span class="p">}</span>
   <span class="nx">RunningAverage</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">reset</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">n_in_avg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">result</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">values</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">total</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">totalSinceReport</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="nx">RunningAverage</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">update</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">new_value</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Only process good stuff.</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">new_value</span> <span class="o">&amp;&amp;</span> <span class="nb">isFinite</span><span class="p">(</span> <span class="nx">new_value</span><span class="p">))</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">n_in_avg</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">n_target</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">total</span> <span class="o">+=</span> <span class="nx">new_value</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">n_in_avg</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// Add the new value and subtract the oldest.</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">total</span> <span class="o">+=</span> <span class="nx">new_value</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">values</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
            <span class="c1">// Discard the oldest value.</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">values</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
         <span class="p">}</span>   
         <span class="k">this</span><span class="p">.</span><span class="nx">values</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">new_value</span><span class="p">);</span>

         <span class="k">this</span><span class="p">.</span><span class="nx">totalSinceReport</span> <span class="o">+=</span> <span class="nx">new_value</span><span class="p">;</span>
         
         <span class="k">this</span><span class="p">.</span><span class="nx">result</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">total</span> <span class="o">/</span> <span class="k">this</span><span class="p">.</span><span class="nx">n_in_avg</span><span class="p">;</span>
         <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">result</span><span class="p">;</span>
         
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="k">return</span> <span class="nx">new_value</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span>
   
   
   
   <span class="kd">function</span> <span class="nx">HSLColor</span><span class="p">(</span> <span class="nx">pars</span> <span class="o">=</span> <span class="p">{})</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">hue</span> <span class="o">=</span> <span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">hue</span><span class="p">,</span> <span class="mi">180</span><span class="p">);</span> <span class="c1">// 0 to 360</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">saturation</span> <span class="o">=</span> <span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">saturation</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span> <span class="c1">// 0 to 100 (%)</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">lightness</span> <span class="o">=</span> <span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">lightness</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span> <span class="c1">// 0 to 100 (%)</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">stepDirection</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// or -1</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">stepSize</span> <span class="o">=</span> <span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">stepSize</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">steppingKey</span> <span class="o">=</span> <span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">steppingKey</span><span class="p">,</span> <span class="s1">&#39;lightness&#39;</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">stepping</span> <span class="o">=</span> <span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">stepping</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="nx">HSLColor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">parse</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">hslString</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// example hsl string:  &#39;hsl(162, 11%, 81%)&#39;</span>
      <span class="kd">let</span> <span class="nx">regexp</span> <span class="o">=</span> <span class="sr">/hsl\(\s*(\d+)\s*,\s*(\d+(?:\.\d+)?%)\s*,\s*(\d+(?:\.\d+)?%)\)/g</span><span class="p">;</span>
      <span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">regexp</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span> <span class="nx">hslString</span><span class="p">).</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">hue</span> <span class="o">=</span>        <span class="nb">Number</span><span class="p">(</span> <span class="nx">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">saturation</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span> <span class="nx">result</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span> <span class="c1">// remove the % sign at the end.</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">lightness</span> <span class="o">=</span>  <span class="nb">Number</span><span class="p">(</span> <span class="nx">result</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span> <span class="c1">// and here too...</span>
   <span class="p">}</span>
   <span class="nx">HSLColor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">step</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stepping</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">steppingKey</span> <span class="o">==</span> <span class="s1">&#39;hue&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">hue</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">hue</span> <span class="o">&gt;</span> <span class="mi">360</span><span class="p">))</span> <span class="k">this</span><span class="p">.</span><span class="nx">stepDirection</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">hue</span> <span class="o">+=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stepSize</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">stepDirection</span><span class="p">;</span>
            
         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">steppingKey</span> <span class="o">==</span> <span class="s1">&#39;saturation&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">saturation</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">saturation</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">))</span> <span class="k">this</span><span class="p">.</span><span class="nx">stepDirection</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">saturation</span> <span class="o">+=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stepSize</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">stepDirection</span><span class="p">;</span>
            
         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">steppingKey</span> <span class="o">==</span> <span class="s1">&#39;lightness&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">lightness</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">lightness</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">))</span> <span class="k">this</span><span class="p">.</span><span class="nx">stepDirection</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">lightness</span> <span class="o">+=</span> <span class="k">this</span><span class="p">.</span><span class="nx">stepSize</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">stepDirection</span><span class="p">;</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="nx">HSLColor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">colorString</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">hslString</span> <span class="o">=</span> <span class="s2">&quot;hsl(&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">hue</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">saturation</span> <span class="o">+</span> <span class="s2">&quot;%, &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">lightness</span> <span class="o">+</span> <span class="s2">&quot;%)&quot;</span><span class="p">;</span>
      <span class="k">return</span> <span class="nb">String</span><span class="p">(</span> <span class="nx">hslString</span><span class="p">);</span>
   <span class="p">}</span>
   
   
   
   <span class="kd">function</span> <span class="nx">HelpMessage</span><span class="p">(</span> <span class="nx">pars</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">message</span> <span class="o">=</span> <span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">timeLimit_s</span> <span class="o">=</span> <span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">timeLimit_s</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">);</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">font</span> <span class="o">=</span> <span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">font</span><span class="p">,</span> <span class="s2">&quot;20px Arial&quot;</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">lineHeight_px</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">font</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span> <span class="o">*</span> <span class="mf">1.20</span><span class="p">;</span>

      <span class="k">this</span><span class="p">.</span><span class="nx">color</span> <span class="o">=</span> <span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">color</span><span class="p">,</span> <span class="s1">&#39;yellow&#39;</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">loc_px</span> <span class="o">=</span> <span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">loc_px</span><span class="p">,</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span><span class="mi">30</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span><span class="mi">40</span><span class="p">});</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">messageSeries</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">timeType</span> <span class="o">=</span> <span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">timeType</span><span class="p">,</span> <span class="s1">&#39;system&#39;</span><span class="p">);</span> <span class="c1">//&#39;game&#39;</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">birthTime</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">performance</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">time_s</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
      
      <span class="k">this</span><span class="p">.</span><span class="nx">popAtEnd</span> <span class="o">=</span> <span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">popAtEnd</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="nx">HelpMessage</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setFont</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">fontString</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">font</span> <span class="o">=</span> <span class="nx">fontString</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">lineHeight_px</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">font</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span> <span class="o">*</span> <span class="mf">1.20</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="nx">HelpMessage</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">resetMessage</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">message</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">messageSeries</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="nx">HelpMessage</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">newMessage</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">timeLimit_s</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">time_s</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">birthTime</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">performance</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">timeLimit_s</span> <span class="o">=</span> <span class="nx">setDefault</span><span class="p">(</span> <span class="nx">timeLimit_s</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">timeLimit_s</span><span class="p">)</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">message</span> <span class="o">=</span> <span class="nx">message</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="nx">HelpMessage</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">newMessageSeries</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">messageSeries</span> <span class="o">=</span> <span class="nx">message</span><span class="p">;</span>
      <span class="c1">// Initialize the first message.</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">time_s</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">birthTime</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">performance</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">message</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">messageSeries</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="p">].</span><span class="nx">message</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">timeLimit_s</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">messageSeries</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="p">].</span><span class="nx">tL_s</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="nx">HelpMessage</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getDurationOfSeries_s</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">seriesTimeTotal_s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">index</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">messageSeries</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">let</span> <span class="nx">messageObj</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">messageSeries</span><span class="p">[</span> <span class="nx">index</span><span class="p">];</span>
         <span class="nx">seriesTimeTotal_s</span> <span class="o">+=</span> <span class="nx">messageObj</span><span class="p">.</span><span class="nx">tL_s</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">seriesTimeTotal_s</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="nx">HelpMessage</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">addToIt</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">moreText</span><span class="p">,</span> <span class="nx">pars</span> <span class="o">=</span> <span class="p">{})</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">timeLimit_s</span> <span class="o">+=</span> <span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">additionalTime_s</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">message</span> <span class="o">+=</span> <span class="nx">moreText</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="nx">HelpMessage</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">yMax_px</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">nLines</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">message</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;\\&quot;</span><span class="p">).</span><span class="nx">length</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">yMax_px</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">loc_px</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="p">(</span><span class="nx">nLines</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">lineHeight_px</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">yMax_px</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="nx">HelpMessage</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">displayIt</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">deltaT_s</span><span class="p">,</span> <span class="nx">drawingContext</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">timeType</span> <span class="o">==</span> <span class="s1">&#39;system&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">time_s</span> <span class="o">=</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">performance</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span> <span class="o">-</span> <span class="k">this</span><span class="p">.</span><span class="nx">birthTime</span><span class="p">)</span><span class="o">/</span><span class="mf">1000.0</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">time_s</span> <span class="o">+=</span> <span class="nx">deltaT_s</span><span class="p">;</span>
      <span class="p">}</span>
      
      <span class="k">if</span> <span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">message</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">time_s</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">timeLimit_s</span><span class="p">))</span> <span class="p">{</span>         
         <span class="c1">// Split each message into multiple lines.</span>
         <span class="c1">// Then, split each line on the formatting [code] pattern.</span>
         <span class="c1">// e.g. this message has two lines. \\In this second line, the word [25px Arial,red]special[base] is highlighted by larger font and red color.</span>
         <span class="c1">// e.g. the word [base,pink]special[base]  has no font size change and a  color change...</span>
         <span class="c1">// e.g. the word [30px Arial]special[base] has a  font size change and no color change...</span>
         <span class="c1">// e.g. these [20px Arial]words [25px Arial]have [30px Arial]larger fonts [base]and then go back to normal... </span>
         <span class="kd">var</span> <span class="nx">lines</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">message</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;\\&quot;</span><span class="p">);</span>
         <span class="c1">// regular expression for finding a formatting code surrounded by brackets</span>
         <span class="kd">var</span> <span class="nx">formatPattern</span> <span class="o">=</span> <span class="sr">/(\[.*?\])/</span><span class="p">;</span>  
         <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">line_index</span> <span class="k">in</span> <span class="nx">lines</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">formatZones</span> <span class="o">=</span> <span class="nx">lines</span><span class="p">[</span> <span class="nx">line_index</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span> <span class="nx">formatPattern</span><span class="p">);</span>
            <span class="kd">var</span> <span class="nx">x_px</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">loc_px</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">zoneFont</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">font</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">zoneColor</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">color</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">zone_index</span> <span class="k">in</span> <span class="nx">formatZones</span><span class="p">)</span> <span class="p">{</span>
               <span class="c1">// Check each zone for the [code] pattern and determine the code without the surrounding brackets.               </span>
               <span class="kd">var</span> <span class="nx">formatCodeMatch</span> <span class="o">=</span> <span class="nx">formatZones</span><span class="p">[</span> <span class="nx">zone_index</span><span class="p">].</span><span class="nx">match</span><span class="p">(</span> <span class="nx">formatPattern</span><span class="p">);</span>
               <span class="k">if</span> <span class="p">(</span><span class="nx">formatCodeMatch</span><span class="p">)</span> <span class="p">{</span>
                  <span class="kd">var</span> <span class="nx">formatCode</span> <span class="o">=</span> <span class="nx">formatCodeMatch</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span> <span class="c1">// strip off the brackets</span>
                  <span class="k">if</span> <span class="p">(</span><span class="nx">formatCode</span> <span class="o">==</span> <span class="s2">&quot;base&quot;</span><span class="p">)</span> <span class="p">{</span>
                     <span class="nx">zoneFont</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">font</span><span class="p">;</span>
                     <span class="nx">zoneColor</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">color</span><span class="p">;</span>
                  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                     <span class="c1">// check if color is specified</span>
                     <span class="kd">var</span> <span class="nx">formatParts</span> <span class="o">=</span> <span class="nx">formatCode</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">);</span>
                     <span class="k">if</span> <span class="p">(</span><span class="nx">formatParts</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">zoneFont</span> <span class="o">=</span>  <span class="p">(</span><span class="nx">formatParts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;base&quot;</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">font</span>  <span class="o">:</span> <span class="nx">formatParts</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
                        <span class="kd">var</span> <span class="nx">zoneColor</span> <span class="o">=</span> <span class="p">(</span><span class="nx">formatParts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;base&quot;</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">color</span> <span class="o">:</span> <span class="nx">formatParts</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
                     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">zoneFont</span> <span class="o">=</span> <span class="nx">formatCode</span><span class="p">;</span>
                        <span class="kd">var</span> <span class="nx">zoneColor</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">color</span><span class="p">;</span>
                     <span class="p">}</span>
                  <span class="p">}</span>
               <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                  <span class="nx">drawingContext</span><span class="p">.</span><span class="nx">font</span> <span class="o">=</span> <span class="nx">zoneFont</span><span class="p">;</span>
                  <span class="nx">drawingContext</span><span class="p">.</span><span class="nx">fillStyle</span> <span class="o">=</span> <span class="nx">zoneColor</span><span class="p">;</span>
                  <span class="kd">var</span> <span class="nx">y_px</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">loc_px</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="p">(</span><span class="nx">line_index</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">lineHeight_px</span><span class="p">);</span>
                  
                  <span class="nx">drawingContext</span><span class="p">.</span><span class="nx">textAlign</span> <span class="o">=</span> <span class="s2">&quot;left&quot;</span><span class="p">;</span>
                  <span class="nx">drawingContext</span><span class="p">.</span><span class="nx">fillText</span><span class="p">(</span> <span class="nx">formatZones</span><span class="p">[</span> <span class="nx">zone_index</span><span class="p">],</span> <span class="nx">x_px</span><span class="p">,</span> <span class="nx">y_px</span><span class="p">);</span>
                  
                  <span class="c1">// Move the position pointer to the right after rendering the zone string.</span>
                  <span class="nx">x_px</span> <span class="o">+=</span> <span class="nx">drawingContext</span><span class="p">.</span><span class="nx">measureText</span><span class="p">(</span> <span class="nx">formatZones</span><span class="p">[</span> <span class="nx">zone_index</span><span class="p">]).</span><span class="nx">width</span><span class="p">;</span>
               <span class="p">}</span> 
            <span class="p">}</span>
         <span class="p">}</span>
         
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="c1">// Before ending the message, make an optional pop sound.</span>
         <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">popAtEnd</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">message</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">))</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">sounds</span><span class="p">[</span><span class="s1">&#39;lowPop&#39;</span><span class="p">].</span><span class="nx">play</span><span class="p">();</span>
         
         <span class="k">this</span><span class="p">.</span><span class="nx">message</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">time_s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
         
         <span class="c1">// If it&#39;s a series, check to see if there&#39;s another message...</span>
         <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">messageSeries</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">index</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">messageSeries</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="p">])</span> <span class="p">{</span>
               <span class="c1">// Update the characteristics of the text if changes have been supplied in the series.</span>
               <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">messageSeries</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="p">].</span><span class="nx">loc_px</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">loc_px</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">messageSeries</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="p">].</span><span class="nx">loc_px</span><span class="p">;</span>
               <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">messageSeries</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="p">].</span><span class="nx">font</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">font</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">messageSeries</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="p">].</span><span class="nx">font</span><span class="p">;</span>
               <span class="k">this</span><span class="p">.</span><span class="nx">popAtEnd</span> <span class="o">=</span> <span class="nx">setDefault</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">messageSeries</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="p">].</span><span class="nx">popAtEnd</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
               
               <span class="k">this</span><span class="p">.</span><span class="nx">message</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">messageSeries</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="p">].</span><span class="nx">message</span><span class="p">;</span>
               <span class="k">this</span><span class="p">.</span><span class="nx">timeLimit_s</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">messageSeries</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="p">].</span><span class="nx">tL_s</span><span class="p">;</span>
               <span class="k">this</span><span class="p">.</span><span class="nx">time_s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
               <span class="k">this</span><span class="p">.</span><span class="nx">birthTime</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">performance</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
            <span class="p">}</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>
   
   
   
   <span class="kd">function</span> <span class="nx">SoundEffect</span><span class="p">(</span> <span class="nx">filePath</span><span class="p">,</span> <span class="nx">nCopies</span><span class="p">,</span> <span class="nx">volumeBase</span> <span class="o">=</span> <span class="mf">1.00</span><span class="p">)</span> <span class="p">{</span>      
      <span class="c1">// The copies allow the same sound to be called repeatedly and thereby played in overlapping sequences. </span>
      <span class="c1">// This is useful for the clack sound in the calculating pi demos.</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">copies</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">nCopies</span> <span class="o">=</span> <span class="nx">nCopies</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">volumeBase</span> <span class="o">=</span> <span class="nx">volumeBase</span><span class="p">;</span>

      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">nCopies</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">copies</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nx">Audio</span><span class="p">(</span> <span class="nx">filePath</span><span class="p">));</span>
      <span class="p">}</span>      
   <span class="p">}</span>
   <span class="nx">SoundEffect</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">play</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">volumeChangeFraction</span> <span class="o">=</span> <span class="mf">1.00</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">oneSound</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">copies</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="p">];</span>
      
      <span class="nx">oneSound</span><span class="p">.</span><span class="nx">volume</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">volumeBase</span> <span class="o">*</span> <span class="nx">volumeChangeFraction</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">oneSound</span><span class="p">.</span><span class="nx">volume</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">oneSound</span><span class="p">.</span><span class="nx">volume</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">oneSound</span><span class="p">.</span><span class="nx">volume</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="nx">oneSound</span><span class="p">.</span><span class="nx">volume</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      
      <span class="c1">// A demo the plays directly from a URL, will not play sound until the user clicks somewhere.</span>
      <span class="c1">// So the error message is translated to the following advice.</span>
      <span class="kd">var</span> <span class="nx">playPromise</span> <span class="o">=</span> <span class="nx">oneSound</span><span class="p">.</span><span class="nx">play</span><span class="p">();</span>
      <span class="nx">playPromise</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="p">}).</span><span class="k">catch</span><span class="p">(</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s1">&#39;NotAllowedError&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help2&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s1">&#39;Sound effects are disabled until you type or click.\\  Go ahead; interact.&#39;</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">);</span>
         <span class="p">}</span>
      <span class="p">});</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">index</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">nCopies</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="o">++</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span>  
   <span class="p">}</span>
  


   <span class="c1">// Public references to objects, variables, and methods</span>
   
   <span class="k">return</span> <span class="p">{</span>
      <span class="c1">// Objects</span>
      <span class="s1">&#39;RunningAverage&#39;</span><span class="o">:</span> <span class="nx">RunningAverage</span><span class="p">,</span>
      <span class="s1">&#39;HelpMessage&#39;</span><span class="o">:</span> <span class="nx">HelpMessage</span><span class="p">,</span>
      <span class="s1">&#39;HSLColor&#39;</span><span class="o">:</span> <span class="nx">HSLColor</span><span class="p">,</span>
      <span class="s1">&#39;SoundEffect&#39;</span><span class="o">:</span> <span class="nx">SoundEffect</span><span class="p">,</span>
      
      <span class="c1">// Variables</span>
      
      <span class="c1">// Methods</span>
      <span class="s1">&#39;setDefault&#39;</span><span class="o">:</span> <span class="nx">setDefault</span><span class="p">,</span>
      <span class="s1">&#39;setDefaultVector&#39;</span><span class="o">:</span> <span class="nx">setDefaultVector</span><span class="p">,</span>
      <span class="s1">&#39;isPrimitive&#39;</span><span class="o">:</span> <span class="nx">isPrimitive</span><span class="p">,</span>
      <span class="s1">&#39;oneOfThese&#39;</span><span class="o">:</span> <span class="nx">oneOfThese</span><span class="p">,</span>
      <span class="s1">&#39;fixed&#39;</span><span class="o">:</span> <span class="nx">fixed</span><span class="p">,</span>
      <span class="s1">&#39;toggleElementDisplay&#39;</span><span class="o">:</span> <span class="nx">toggleElementDisplay</span><span class="p">,</span>
      <span class="s1">&#39;setElementDisplay&#39;</span><span class="o">:</span> <span class="nx">setElementDisplay</span><span class="p">,</span>
      <span class="s1">&#39;toggleSpanValue&#39;</span><span class="o">:</span> <span class="nx">toggleSpanValue</span><span class="p">,</span>
      <span class="s1">&#39;getSpanValue&#39;</span><span class="o">:</span> <span class="nx">getSpanValue</span><span class="p">,</span>
      
   <span class="p">};</span>   
   
<span class="p">})();</span>
</pre></div>
</body>
</html>
