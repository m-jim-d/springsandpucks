<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">
<!--
generated by Pygments <https://pygments.org/>
Copyright 2006-2025 by the Pygments team.
Licensed under the BSD license, see LICENSE for details.
-->
<html>
<head>
  <link rel='canonical' href='https://triquence.org/ghostBall.js.html' />
  <title>ghostBall.js</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <style type="text/css">
/*
generated by Pygments <https://pygments.org/>
Copyright 2006-2025 by the Pygments team.
Licensed under the BSD license, see LICENSE for details.
*/
pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
body .hll { background-color: #ffffcc }
body { background: #f8f8f8; }
body .c { color: #3D7B7B; font-style: italic } /* Comment */
body .err { border: 1px solid #F00 } /* Error */
body .k { color: #008000; font-weight: bold } /* Keyword */
body .o { color: #666 } /* Operator */
body .ch { color: #3D7B7B; font-style: italic } /* Comment.Hashbang */
body .cm { color: #3D7B7B; font-style: italic } /* Comment.Multiline */
body .cp { color: #9C6500 } /* Comment.Preproc */
body .cpf { color: #3D7B7B; font-style: italic } /* Comment.PreprocFile */
body .c1 { color: #3D7B7B; font-style: italic } /* Comment.Single */
body .cs { color: #3D7B7B; font-style: italic } /* Comment.Special */
body .gd { color: #A00000 } /* Generic.Deleted */
body .ge { font-style: italic } /* Generic.Emph */
body .ges { font-weight: bold; font-style: italic } /* Generic.EmphStrong */
body .gr { color: #E40000 } /* Generic.Error */
body .gh { color: #000080; font-weight: bold } /* Generic.Heading */
body .gi { color: #008400 } /* Generic.Inserted */
body .go { color: #717171 } /* Generic.Output */
body .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
body .gs { font-weight: bold } /* Generic.Strong */
body .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
body .gt { color: #04D } /* Generic.Traceback */
body .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
body .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
body .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
body .kp { color: #008000 } /* Keyword.Pseudo */
body .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
body .kt { color: #B00040 } /* Keyword.Type */
body .m { color: #666 } /* Literal.Number */
body .s { color: #BA2121 } /* Literal.String */
body .na { color: #687822 } /* Name.Attribute */
body .nb { color: #008000 } /* Name.Builtin */
body .nc { color: #00F; font-weight: bold } /* Name.Class */
body .no { color: #800 } /* Name.Constant */
body .nd { color: #A2F } /* Name.Decorator */
body .ni { color: #717171; font-weight: bold } /* Name.Entity */
body .ne { color: #CB3F38; font-weight: bold } /* Name.Exception */
body .nf { color: #00F } /* Name.Function */
body .nl { color: #767600 } /* Name.Label */
body .nn { color: #00F; font-weight: bold } /* Name.Namespace */
body .nt { color: #008000; font-weight: bold } /* Name.Tag */
body .nv { color: #19177C } /* Name.Variable */
body .ow { color: #A2F; font-weight: bold } /* Operator.Word */
body .w { color: #BBB } /* Text.Whitespace */
body .mb { color: #666 } /* Literal.Number.Bin */
body .mf { color: #666 } /* Literal.Number.Float */
body .mh { color: #666 } /* Literal.Number.Hex */
body .mi { color: #666 } /* Literal.Number.Integer */
body .mo { color: #666 } /* Literal.Number.Oct */
body .sa { color: #BA2121 } /* Literal.String.Affix */
body .sb { color: #BA2121 } /* Literal.String.Backtick */
body .sc { color: #BA2121 } /* Literal.String.Char */
body .dl { color: #BA2121 } /* Literal.String.Delimiter */
body .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
body .s2 { color: #BA2121 } /* Literal.String.Double */
body .se { color: #AA5D1F; font-weight: bold } /* Literal.String.Escape */
body .sh { color: #BA2121 } /* Literal.String.Heredoc */
body .si { color: #A45A77; font-weight: bold } /* Literal.String.Interpol */
body .sx { color: #008000 } /* Literal.String.Other */
body .sr { color: #A45A77 } /* Literal.String.Regex */
body .s1 { color: #BA2121 } /* Literal.String.Single */
body .ss { color: #19177C } /* Literal.String.Symbol */
body .bp { color: #008000 } /* Name.Builtin.Pseudo */
body .fm { color: #00F } /* Name.Function.Magic */
body .vc { color: #19177C } /* Name.Variable.Class */
body .vg { color: #19177C } /* Name.Variable.Global */
body .vi { color: #19177C } /* Name.Variable.Instance */
body .vm { color: #19177C } /* Name.Variable.Magic */
body .il { color: #666 } /* Literal.Number.Integer.Long */

  </style>
</head>
<body>
<h2></h2>

<div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm">Copyright 2022 James D. Miller</span>

<span class="cm">Permission is hereby granted, free of charge, to any person obtaining a copy</span>
<span class="cm">of this software and associated documentation files (the &quot;Software&quot;), to deal</span>
<span class="cm">in the Software without restriction, including without limitation the rights</span>
<span class="cm">to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
<span class="cm">copies of the Software, and to permit persons to whom the Software is</span>
<span class="cm">furnished to do so, subject to the following conditions:</span>

<span class="cm">The above copyright notice and this permission notice shall be included in all</span>
<span class="cm">copies or substantial portions of the Software.</span>

<span class="cm">THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="cm">IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="cm">FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
<span class="cm">AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<span class="cm">LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span>
<span class="cm">OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="cm">SOFTWARE.</span>
<span class="cm">*/</span>

<span class="c1">// Ghost Ball Pool (gB) module</span>
<span class="c1">// ghostBall.js</span>
<span class="w">   </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;gB _*-*_&#39;</span><span class="p">);</span>
<span class="c1">// 4:44 PM Wed August 10, 2022</span>

<span class="cm">/*</span>
<span class="cm">gwModule.js has an alphabetical list of all modules and their nicknames as added to the windows namespace.</span>
<span class="cm">*/</span>

<span class="nb">window</span><span class="p">.</span><span class="nx">gB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="s2">&quot;use strict&quot;</span><span class="p">;</span>
<span class="w">   </span>
<span class="w">   </span><span class="c1">// Names starting with m_ indicate module-scope globals.</span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">m_poolTimer_gameDuration_s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">m_poolTimer_stateCheck_s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">m_poolTimer_stateCheckLimit_s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.2</span><span class="p">;</span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">m_poolGameOver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">m_nonCueBallPocketed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">m_poolWinType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;no win yet&quot;</span><span class="p">;</span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">m_objectBallFoul</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">m_allPucksStopped</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">m_poolGameShotCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">m_lowPuckName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">m_cushionCollision</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">m_mostRecentPoolShooter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">m_nonCueBallsAtStart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">m_readyForFirstCueBallCollision</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">m_cushionCollisionPenaltyGiven</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">m_tableHistory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">m_tableHistoryIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">m_endResultCaptured</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">m_projectileForecast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">m_cueBallSpot_2d_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">m_canvasWidth_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">m_canvasHeight_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">   </span>
<span class="w">   </span><span class="c1">// module globals for objects brought in by initializeModule</span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">x_canvas</span><span class="p">,</span><span class="w"> </span><span class="nx">x_ctx</span><span class="p">;</span>
<span class="w">   </span>
<span class="w">   </span><span class="c1">///////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span class="w">   </span><span class="c1">///////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">initializeModule</span><span class="p">(</span><span class="w"> </span><span class="nx">canvas</span><span class="p">,</span><span class="w"> </span><span class="nx">ctx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">x_canvas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">canvas</span><span class="p">;</span>
<span class="w">      </span><span class="nx">x_ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ctx</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">resetGame</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">m_poolTimer_gameDuration_s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">      </span><span class="nx">m_poolWinType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;no win yet&quot;</span><span class="p">;</span>
<span class="w">      </span><span class="nx">m_poolGameOver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">      </span><span class="nx">m_poolGameShotCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">      </span><span class="nx">m_mostRecentPoolShooter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;local&#39;</span><span class="p">;</span>
<span class="w">      </span><span class="c1">// Count of numbered pool balls at game start.</span>
<span class="w">      </span><span class="nx">m_nonCueBallsAtStart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">puckMap</span><span class="p">).</span><span class="nx">length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">      </span>
<span class="w">      </span><span class="nx">m_lowPuckName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">findLowPuck</span><span class="p">();</span>
<span class="w">      </span>
<span class="w">      </span><span class="nx">cT</span><span class="p">.</span><span class="nx">Client</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">client</span><span class="p">.</span><span class="nx">stripesOrSolids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;table is open&quot;</span><span class="p">;</span>
<span class="w">         </span><span class="nx">client</span><span class="p">.</span><span class="nx">scratchedDuringGame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">         </span><span class="nx">client</span><span class="p">.</span><span class="nx">objectBallFoulDuringGame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">         </span><span class="nx">client</span><span class="p">.</span><span class="nx">safetyShotFoulDuringGame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">         </span><span class="nx">client</span><span class="p">.</span><span class="nx">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">100</span><span class="p">;</span>
<span class="w">         </span><span class="nx">client</span><span class="p">.</span><span class="nx">poolShotCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">         </span><span class="nx">client</span><span class="p">.</span><span class="nx">pocketedBallCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">         </span><span class="nx">client</span><span class="p">.</span><span class="nx">mouseStopPenalty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">         </span><span class="nx">client</span><span class="p">.</span><span class="nx">mouseStopMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">;</span>
<span class="w">         </span><span class="nx">client</span><span class="p">.</span><span class="nx">mouseStopFoulDuringGame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">      </span>
<span class="w">      </span><span class="nx">m_canvasWidth_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">meters_from_px</span><span class="p">(</span><span class="w"> </span><span class="nx">x_canvas</span><span class="p">.</span><span class="nx">width</span><span class="p">);</span>
<span class="w">      </span><span class="nx">m_canvasHeight_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">meters_from_px</span><span class="p">(</span><span class="w"> </span><span class="nx">x_canvas</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// If not a secondary capture, start with a fresh rack.</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoVersion</span><span class="p">().</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">).</span><span class="nx">length</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">positionCushions</span><span class="p">();</span>
<span class="w">         </span><span class="nx">newRack</span><span class="p">();</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;gameTitle&#39;</span><span class="p">].</span><span class="nx">setFont</span><span class="p">(</span><span class="s1">&#39;50px Arial&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;gameTitle&#39;</span><span class="p">].</span><span class="nx">loc_px</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="o">:</span><span class="mf">75</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="o">:</span><span class="mf">220</span><span class="p">};</span>
<span class="w">      </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;gameTitle&#39;</span><span class="p">].</span><span class="nx">popAtEnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">      </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">loc_px</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="o">:</span><span class="mf">75</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="o">:</span><span class="mf">90</span><span class="p">};</span><span class="w">  </span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Don&#39;t show the intro text (exit) if the capture has a moving cue ball.</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">inhibitIntroHelp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">      </span><span class="nx">cP</span><span class="p">.</span><span class="nx">Puck</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span><span class="w"> </span><span class="nx">puck</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">puck</span><span class="p">.</span><span class="nx">velocity_2d_mps</span><span class="p">.</span><span class="nx">zeroLength</span><span class="p">())</span><span class="w"> </span><span class="nx">inhibitIntroHelp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">inhibitIntroHelp</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>
<span class="w">      </span>
<span class="w">      </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;gameTitle&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s2">&quot;ghost-ball \\  pool&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">2.0</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoVersion</span><span class="p">().</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;9ball&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;gameTitle&#39;</span><span class="p">].</span><span class="nx">addToIt</span><span class="p">(</span><span class="s2">&quot;\\                9-ball&quot;</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoVersion</span><span class="p">().</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;8ball&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;gameTitle&#39;</span><span class="p">].</span><span class="nx">addToIt</span><span class="p">(</span><span class="s2">&quot;\\ \\                          8-ball&quot;</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoVersion</span><span class="p">().</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;rotation&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;gameTitle&#39;</span><span class="p">].</span><span class="nx">addToIt</span><span class="p">(</span><span class="s2">&quot;\\ \\                          simple rotation&quot;</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessageSeries</span><span class="p">({</span>
<span class="w">         </span><span class="mf">1</span><span class="o">:</span><span class="p">{</span><span class="s1">&#39;tL_s&#39;</span><span class="o">:</span><span class="mf">5.0</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;message&#39;</span><span class="o">:</span><span class="s1">&#39;release the ghost:&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">                                </span><span class="s1">&#39;\\    use the mouse to drag the ghost ball out of the cue ball&#39;</span><span class="p">},</span>
<span class="w">         </span><span class="mf">2</span><span class="o">:</span><span class="p">{</span><span class="s1">&#39;tL_s&#39;</span><span class="o">:</span><span class="mf">5.0</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;message&#39;</span><span class="o">:</span><span class="s2">&quot;aim your shot:&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">                                </span><span class="s2">&quot;\\    touch the ghost ball against an object ball or cushion for alignment aids&quot;</span><span class="p">},</span>
<span class="w">         </span><span class="mf">4</span><span class="o">:</span><span class="p">{</span><span class="s1">&#39;tL_s&#39;</span><span class="o">:</span><span class="mf">5.0</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;message&#39;</span><span class="o">:</span><span class="s1">&#39;shoot the cue ball:&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">                                </span><span class="s1">&#39;\\    release the mouse button &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">                                </span><span class="s1">&#39;\\    (release over the cue ball to cancel the shot)&#39;</span><span class="p">},</span>
<span class="w">         </span><span class="mf">5</span><span class="o">:</span><span class="p">{</span><span class="s1">&#39;tL_s&#39;</span><span class="o">:</span><span class="mf">7.0</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;message&#39;</span><span class="o">:</span><span class="s1">&#39;adjust the cue ball [base,yellow]speed[base]:&#39;</span><span class="w"> </span><span class="o">+</span>
<span class="w">                                </span><span class="s1">&#39;\\    tap the &quot;z&quot; key while dragging the ghost ball&#39;</span><span class="w"> </span><span class="o">+</span>
<span class="w">                                </span><span class="s2">&quot;\\    (speed [base,yellow]value[base] is based on ghost-cue separation)&quot;</span><span class="w"> </span><span class="o">+</span>
<span class="w">                                </span><span class="s2">&quot;\\    alternately use the mouse wheel&quot;</span><span class="p">},</span>
<span class="w">         </span><span class="mf">6</span><span class="o">:</span><span class="p">{</span><span class="s1">&#39;tL_s&#39;</span><span class="o">:</span><span class="mf">5.0</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;message&#39;</span><span class="o">:</span><span class="s1">&#39;full-screen view:&#39;</span><span class="w"> </span><span class="o">+</span>
<span class="w">                                </span><span class="s1">&#39;\\    press the &quot;v&quot; key to fill the screen with the pool table&#39;</span><span class="w"> </span><span class="o">+</span>
<span class="w">                                </span><span class="s1">&#39;\\    press the &quot;esc&quot; key to return to the normal view&#39;</span><span class="p">},</span>
<span class="w">         </span><span class="mf">7</span><span class="o">:</span><span class="p">{</span><span class="s1">&#39;tL_s&#39;</span><span class="o">:</span><span class="mf">5.0</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;message&#39;</span><span class="o">:</span><span class="s2">&quot;restart the game (and this help):&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">                                </span><span class="s2">&quot;\\    press #3 key &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">                                </span><span class="s2">&quot;\\    (above the w, not on keypad)&quot;</span><span class="p">},</span>
<span class="w">         </span><span class="mf">8</span><span class="o">:</span><span class="p">{</span><span class="s1">&#39;tL_s&#39;</span><span class="o">:</span><span class="mf">2.0</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;message&#39;</span><span class="o">:</span><span class="s2">&quot;play some pool...&quot;</span><span class="p">}</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">positionCushions</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">halfHeight_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.06</span><span class="p">;</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// shrink the side pocket, move the top and bottom cushions in toward the middle</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">adjust_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.17</span><span class="p">;</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Sides, left right. Rotate 90 degrees.</span>
<span class="w">      </span><span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">wallMap</span><span class="p">[</span><span class="s1">&#39;wall1&#39;</span><span class="p">].</span><span class="nx">setPosition</span><span class="p">(</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="w">               </span><span class="mf">0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">halfHeight_m</span><span class="p">,</span><span class="w"> </span><span class="nx">m_canvasHeight_m</span><span class="o">/</span><span class="mf">2</span><span class="p">),</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="o">/</span><span class="mf">2</span><span class="p">);</span>
<span class="w">      </span><span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">wallMap</span><span class="p">[</span><span class="s1">&#39;wall2&#39;</span><span class="p">].</span><span class="nx">setPosition</span><span class="p">(</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="w"> </span><span class="nx">m_canvasWidth_m</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">halfHeight_m</span><span class="p">,</span><span class="w"> </span><span class="nx">m_canvasHeight_m</span><span class="o">/</span><span class="mf">2</span><span class="p">),</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="o">/</span><span class="mf">2</span><span class="p">);</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Top, left right</span>
<span class="w">      </span><span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">wallMap</span><span class="p">[</span><span class="s1">&#39;wall5&#39;</span><span class="p">].</span><span class="nx">setPosition</span><span class="p">(</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="w"> </span><span class="nx">m_canvasWidth_m</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="mf">4.0</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">adjust_m</span><span class="p">,</span><span class="w"> </span><span class="nx">m_canvasHeight_m</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">halfHeight_m</span><span class="p">),</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>
<span class="w">      </span><span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">wallMap</span><span class="p">[</span><span class="s1">&#39;wall6&#39;</span><span class="p">].</span><span class="nx">setPosition</span><span class="p">(</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="w"> </span><span class="nx">m_canvasWidth_m</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mf">3.0</span><span class="o">/</span><span class="mf">4.0</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">adjust_m</span><span class="p">,</span><span class="w"> </span><span class="nx">m_canvasHeight_m</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">halfHeight_m</span><span class="p">),</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Bottom, left right</span>
<span class="w">      </span><span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">wallMap</span><span class="p">[</span><span class="s1">&#39;wall10&#39;</span><span class="p">].</span><span class="nx">setPosition</span><span class="p">(</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="w"> </span><span class="nx">m_canvasWidth_m</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="mf">4.0</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">adjust_m</span><span class="p">,</span><span class="w"> </span><span class="nx">halfHeight_m</span><span class="p">),</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>
<span class="w">      </span><span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">wallMap</span><span class="p">[</span><span class="s1">&#39;wall11&#39;</span><span class="p">].</span><span class="nx">setPosition</span><span class="p">(</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="w"> </span><span class="nx">m_canvasWidth_m</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mf">3.0</span><span class="o">/</span><span class="mf">4.0</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">adjust_m</span><span class="p">,</span><span class="w"> </span><span class="nx">halfHeight_m</span><span class="p">),</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">newRack</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">remainingPucks</span><span class="p">,</span><span class="w"> </span><span class="nx">remainRackSpots</span><span class="p">;</span>
<span class="w">      </span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">gap_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="p">;</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">radius_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">puckMap</span><span class="p">[</span><span class="s1">&#39;puck0&#39;</span><span class="p">].</span><span class="nx">radius_m</span><span class="p">;</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">delta_y_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="nx">radius_m</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">gap_m</span><span class="p">);</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">delta_x_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">delta_y_m</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="w"> </span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2.0</span><span class="p">;</span><span class="w"> </span><span class="c1">// h = a × √3 / 2</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">n_columns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">5</span><span class="p">;</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">angle_deg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// position of the first (lowest y) ball on left side of rack, the starting position of the rack calculations</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">y_original_position_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">m_canvasHeight_m</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2.0</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="nx">radius_m</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">4.0</span><span class="p">);</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">x_position_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">m_canvasWidth_m</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">4.0</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="nx">delta_x_m</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">4.0</span><span class="p">);</span>
<span class="w">      </span>
<span class="w">      </span><span class="nx">m_cueBallSpot_2d_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="mf">3.0</span><span class="o">/</span><span class="mf">4.0</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">m_canvasWidth_m</span><span class="p">,</span><span class="w"> </span><span class="nx">m_canvasHeight_m</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2.0</span><span class="p">);</span>
<span class="w">      </span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">rackPositions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
<span class="w">      </span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">gameName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoVersion</span><span class="p">().</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mf">2</span><span class="p">];</span>
<span class="w">      </span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">puckIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">n_columns</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="kd">let</span><span class="w"> </span><span class="nx">y_position_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">y_original_position_m</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="nx">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="nx">delta_y_m</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
<span class="w">         </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">i</span><span class="p">;</span><span class="w"> </span><span class="nx">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">n_columns</span><span class="p">;</span><span class="w"> </span><span class="nx">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="nx">puck_pos_2d_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="w"> </span><span class="nx">x_position_m</span><span class="p">,</span><span class="w"> </span><span class="nx">y_position_m</span><span class="p">);</span>
<span class="w">            </span><span class="nx">rackPositions</span><span class="p">[</span><span class="w"> </span><span class="nx">puckIndex</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">puck_pos_2d_m</span><span class="p">;</span>
<span class="w">            </span><span class="nx">y_position_m</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">delta_y_m</span><span class="p">;</span>
<span class="w">            </span><span class="nx">puckIndex</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">         </span><span class="nx">x_position_m</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">delta_x_m</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// spot the cue ball</span>
<span class="w">      </span><span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">puckMap</span><span class="p">[</span><span class="s1">&#39;puck0&#39;</span><span class="p">].</span><span class="nx">setPosition</span><span class="p">(</span><span class="w"> </span><span class="nx">m_cueBallSpot_2d_m</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">);</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// put the 1 ball at the front</span>
<span class="w">      </span><span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">puckMap</span><span class="p">[</span><span class="s1">&#39;puck1&#39;</span><span class="p">].</span><span class="nx">setPosition</span><span class="p">(</span><span class="w"> </span><span class="nx">rackPositions</span><span class="p">[</span><span class="w"> </span><span class="mf">15</span><span class="p">],</span><span class="w"> </span><span class="nx">angle_deg</span><span class="p">);</span>
<span class="w">      </span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">gameName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;9ball&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="c1">// 9 ball in the middle</span>
<span class="w">         </span><span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">puckMap</span><span class="p">[</span><span class="w"> </span><span class="s1">&#39;puck9&#39;</span><span class="p">].</span><span class="nx">setPosition</span><span class="p">(</span><span class="w"> </span><span class="nx">rackPositions</span><span class="p">[</span><span class="w"> </span><span class="mf">11</span><span class="p">],</span><span class="w"> </span><span class="nx">angle_deg</span><span class="p">);</span>
<span class="w">         </span>
<span class="w">         </span><span class="nx">remainingPucks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mf">2</span><span class="p">,</span><span class="mf">3</span><span class="p">,</span><span class="mf">4</span><span class="p">,</span><span class="mf">5</span><span class="p">,</span><span class="mf">6</span><span class="p">,</span><span class="mf">7</span><span class="p">,</span><span class="mf">8</span><span class="p">];</span>
<span class="w">         </span><span class="nx">remainRackSpots</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mf">3</span><span class="p">,</span><span class="mf">7</span><span class="p">,</span><span class="mf">8</span><span class="p">,</span><span class="mf">10</span><span class="p">,</span><span class="mf">12</span><span class="p">,</span><span class="mf">13</span><span class="p">,</span><span class="mf">14</span><span class="p">];</span>
<span class="w">      </span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">([</span><span class="s1">&#39;rotation&#39;</span><span class="p">,</span><span class="s1">&#39;8ball&#39;</span><span class="p">].</span><span class="nx">includes</span><span class="p">(</span><span class="w"> </span><span class="nx">gameName</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">gameName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;8ball&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 8 ball in the middle</span>
<span class="w">            </span><span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">puckMap</span><span class="p">[</span><span class="w"> </span><span class="s1">&#39;puck8&#39;</span><span class="p">].</span><span class="nx">setPosition</span><span class="p">(</span><span class="w"> </span><span class="nx">rackPositions</span><span class="p">[</span><span class="w"> </span><span class="mf">11</span><span class="p">],</span><span class="w"> </span><span class="nx">angle_deg</span><span class="p">);</span>
<span class="w">            </span><span class="nx">remainingPucks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mf">2</span><span class="p">,</span><span class="mf">3</span><span class="p">,</span><span class="mf">4</span><span class="p">,</span><span class="mf">5</span><span class="p">,</span><span class="mf">6</span><span class="p">,</span><span class="mf">7</span><span class="p">,</span><span class="mf">9</span><span class="p">,</span><span class="mf">10</span><span class="p">,</span><span class="mf">11</span><span class="p">,</span><span class="mf">12</span><span class="p">,</span><span class="mf">13</span><span class="p">,</span><span class="mf">14</span><span class="p">,</span><span class="mf">15</span><span class="p">];</span>
<span class="w">            </span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">gameName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;rotation&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 15 ball in the middle</span>
<span class="w">            </span><span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">puckMap</span><span class="p">[</span><span class="w"> </span><span class="s1">&#39;puck15&#39;</span><span class="p">].</span><span class="nx">setPosition</span><span class="p">(</span><span class="w"> </span><span class="nx">rackPositions</span><span class="p">[</span><span class="w"> </span><span class="mf">11</span><span class="p">],</span><span class="w"> </span><span class="nx">angle_deg</span><span class="p">);</span>
<span class="w">            </span><span class="nx">remainingPucks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mf">2</span><span class="p">,</span><span class="mf">3</span><span class="p">,</span><span class="mf">4</span><span class="p">,</span><span class="mf">5</span><span class="p">,</span><span class="mf">6</span><span class="p">,</span><span class="mf">7</span><span class="p">,</span><span class="mf">8</span><span class="p">,</span><span class="mf">9</span><span class="p">,</span><span class="mf">10</span><span class="p">,</span><span class="mf">11</span><span class="p">,</span><span class="mf">12</span><span class="p">,</span><span class="mf">13</span><span class="p">,</span><span class="mf">14</span><span class="p">];</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">         </span><span class="nx">remainRackSpots</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mf">1</span><span class="p">,</span><span class="mf">2</span><span class="p">,</span><span class="mf">3</span><span class="p">,</span><span class="mf">4</span><span class="p">,</span><span class="mf">5</span><span class="p">,</span><span class="mf">6</span><span class="p">,</span><span class="mf">7</span><span class="p">,</span><span class="mf">8</span><span class="p">,</span><span class="mf">9</span><span class="p">,</span><span class="mf">10</span><span class="p">,</span><span class="mf">12</span><span class="p">,</span><span class="mf">13</span><span class="p">,</span><span class="mf">14</span><span class="p">];</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// randomize</span>
<span class="w">      </span><span class="nx">remainRackSpots</span><span class="p">.</span><span class="nx">sort</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">0.5</span><span class="p">);</span>
<span class="w">   </span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">index</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">remainingPucks</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="kd">let</span><span class="w"> </span><span class="nx">puckName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;puck&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">remainingPucks</span><span class="p">[</span><span class="w"> </span><span class="nx">index</span><span class="p">];</span>
<span class="w">         </span><span class="kd">let</span><span class="w"> </span><span class="nx">position_2d_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">rackPositions</span><span class="p">[</span><span class="w"> </span><span class="nx">remainRackSpots</span><span class="p">[</span><span class="w"> </span><span class="nx">i</span><span class="p">]];</span>
<span class="w">         </span><span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">puckMap</span><span class="p">[</span><span class="w"> </span><span class="nx">puckName</span><span class="p">].</span><span class="nx">setPosition</span><span class="p">(</span><span class="w"> </span><span class="nx">position_2d_m</span><span class="p">,</span><span class="w"> </span><span class="nx">angle_deg</span><span class="p">);</span>
<span class="w">         </span><span class="nx">i</span><span class="o">++</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">addToTableHistory</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">m_tableHistory</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="w"> </span><span class="nx">cR</span><span class="p">.</span><span class="nx">saveState</span><span class="p">(</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;inhibitWriteToCaptureCell&#39;</span><span class="o">:</span><span class="kc">true</span><span class="p">}</span><span class="w"> </span><span class="p">));</span>
<span class="w">      </span><span class="nx">m_tableHistoryIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">m_tableHistory</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">restoreFromTableHistory</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">m_tableHistory</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">tA</span><span class="p">.</span><span class="nx">clearTable</span><span class="p">();</span>
<span class="w">         </span><span class="nx">cR</span><span class="p">.</span><span class="nx">restoreFromState</span><span class="p">(</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="w"> </span><span class="nx">m_tableHistory</span><span class="p">[</span><span class="w"> </span><span class="nx">m_tableHistoryIndex</span><span class="p">]));</span>
<span class="w">         </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="w"> </span><span class="s2">&quot;table capture [30px Arial,yellow]_&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="nx">m_tableHistoryIndex</span><span class="o">+</span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;_[base]&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">);</span>
<span class="w">         </span><span class="nx">m_lowPuckName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">findLowPuck</span><span class="p">();</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">getTableCapture</span><span class="p">(</span><span class="w"> </span><span class="nx">mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Before you step through the shot history, make sure the current table state has been captured (but only once).</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">m_endResultCaptured</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">addToTableHistory</span><span class="p">();</span>
<span class="w">         </span><span class="nx">m_endResultCaptured</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;previous&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">m_tableHistoryIndex</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">m_tableHistoryIndex</span><span class="o">--</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;next&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">m_tableHistoryIndex</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">m_tableHistory</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">m_tableHistoryIndex</span><span class="o">++</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="nx">restoreFromTableHistory</span><span class="p">();</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">resetTableHistory</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">m_tableHistory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">      </span><span class="nx">m_tableHistoryIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">      </span><span class="nx">m_endResultCaptured</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">lessThanGlancing</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="p">,</span><span class="w"> </span><span class="nx">contactNormal_2d</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// dot product of cursor spring and contact normal</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">dot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">cursorSpring</span><span class="p">.</span><span class="nx">p1p2_normalized_2d</span><span class="p">.</span><span class="nx">dot</span><span class="p">(</span><span class="w"> </span><span class="nx">contactNormal_2d</span><span class="p">);</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">angle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">contactNormal_2d</span><span class="p">.</span><span class="nx">angleBetweenVectors_d</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">cursorSpring</span><span class="p">.</span><span class="nx">p1p2_normalized_2d</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">dot</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="o">-</span><span class="mf">0.13</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">updateGhostBall</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Primarily, updateGhostBall serves to position the ghost-ball sensor puck before the engine step. The engine result is needed</span>
<span class="w">      </span><span class="c1">// for determining the contact normals for wall targets.</span>
<span class="w">      </span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">displace_2d_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">);</span>
<span class="w">      </span><span class="c1">// Shift cursor pin if it gets displaced from the cursor during aiming process.</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">cursorPinOffset_2d_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">);</span>
<span class="w">      </span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">getG_ON</span><span class="p">())</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">shape</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;circle&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">fineMovesState</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;inTransition&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">sensorTargetName</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">sensorTargetName</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;puck&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">targetPuck</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">puckMap</span><span class="p">[</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">sensorTargetName</span><span class="p">];</span>
<span class="w">            </span><span class="cm">/*</span>
<span class="cm">            It&#39;s debatable whether this block for puck (circular non-wall) targets is needed here. </span>
<span class="cm">            Maybe, this should be only after the engine step, since some of this is repeated there, </span>
<span class="cm">            and the circular case does not depend on the positioning of the sensor puck, and corresponding engine results, for contact normals.</span>
<span class="cm">            If this moves, then the client.pin.setPosition should also.</span>
<span class="cm">            */</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">targetPuck</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">targetPuck</span><span class="p">.</span><span class="nx">shape</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;circle&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="c1">// Distance between the cursor and the center of the target puck.</span>
<span class="w">               </span><span class="kd">var</span><span class="w"> </span><span class="nx">cursorToTarget_2d_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">mouse_2d_m</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="w"> </span><span class="nx">targetPuck</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">);</span>
<span class="w">               </span><span class="kd">var</span><span class="w"> </span><span class="nx">cursorToTarget_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cursorToTarget_2d_m</span><span class="p">.</span><span class="nx">length</span><span class="p">();</span>
<span class="w">               </span>
<span class="w">               </span><span class="c1">// Needed distance between the centers of the ghost and target puck so that they are touching (a kiss).</span>
<span class="w">               </span><span class="kd">var</span><span class="w"> </span><span class="nx">kissSeparation_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">radius_m</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">targetPuck</span><span class="p">.</span><span class="nx">radius_m</span><span class="p">;</span>
<span class="w">               </span>
<span class="w">               </span><span class="kd">var</span><span class="w"> </span><span class="nx">contactNormal_2d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cursorToTarget_2d_m</span><span class="p">.</span><span class="nx">normal</span><span class="p">();</span>
<span class="w">               </span><span class="c1">// The amount the cursor pin needs to be offset from the cursor so that the ghost puck is positioned to</span>
<span class="w">               </span><span class="c1">// be kissing the target puck.</span>
<span class="w">               </span><span class="nx">cursorPinOffset_2d_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">contactNormal_2d</span><span class="p">.</span><span class="nx">scaleBy</span><span class="p">(</span><span class="w"> </span><span class="nx">kissSeparation_m</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">cursorToTarget_m</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">         </span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">sensorTargetName</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;wall&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">sensorContact</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// For wall contact, displace sensor from the cursor (sensor has the radius of the selected ball)</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">// By observation of the contact point (when displace_2d_m is kept at zero, see commented line below), </span>
<span class="w">            </span><span class="c1">// it can be seen that: displacement_needed = sensor_radius - (mouse_point - engine_contact_point).</span>
<span class="w">            </span><span class="c1">// This is convergent, and becomes more accurate as each frame is calculated.</span>
<span class="w">            </span><span class="c1">// Also see: mouseUp_handler in events.js and contact listeners in boxStuff.js</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">mouseToWallContact_2d_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">mouse_2d_m</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D_from_b2Vec2</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">sensorContact</span><span class="p">.</span><span class="nx">points_2d_m</span><span class="p">[</span><span class="mf">0</span><span class="p">]));</span>
<span class="w">            </span><span class="nx">client</span><span class="p">.</span><span class="nx">gBS</span><span class="p">.</span><span class="nx">mouseToWallContact_2d_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">mouseToWallContact_2d_m</span><span class="p">;</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">// Scaler displacement of sensor used to keep the contact point on the surface of the target.</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">displace_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">radius_m</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">mouseToWallContact_2d_m</span><span class="p">.</span><span class="nx">length</span><span class="p">();</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">// the 0.999 helps with stability, especially on the left side of walls and also pointy corners.</span>
<span class="w">            </span><span class="nx">displace_2d_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">sensorContact</span><span class="p">.</span><span class="nx">normal_2d</span><span class="p">.</span><span class="nx">scaleBy</span><span class="p">(</span><span class="w"> </span><span class="mf">0.999</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">displace_m</span><span class="p">);</span>
<span class="w">            </span><span class="c1">// The &quot;sensor&quot; displacement conflicts with the finemoves transition. So disable during the transition. </span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">fineMovesState</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;inTransition&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">displace_2d_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">);</span>
<span class="w">            </span><span class="c1">//displace_2d_m = new wS.Vec2D(0,0); // remove comment to view with an un-displaced sensor and see raw contact info.</span>
<span class="w">      </span>
<span class="w">            </span><span class="nx">cursorPinOffset_2d_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">displace_2d_m</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">//let debugString = &quot;target=&quot; + client.sensorTargetName + &quot;, cursorPinOffset_2d_m=&quot; + cursorPinOffset_2d_m.x.toFixed(2) + &#39;,&#39; + cursorPinOffset_2d_m.y.toFixed(2);</span>
<span class="w">      </span><span class="c1">//hC.sendSocketControlMessage( {&#39;from&#39;:&#39;anyone&#39;, &#39;to&#39;:&#39;host&#39;, &#39;data&#39;:{&#39;androidDebug&#39;:{&#39;value&#39;:true,&#39;debugString&#39;:debugString}} } );</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// For non-wall targets, this update will move the ghost sensor puck along with the cursor (displacement is zero).</span>
<span class="w">      </span><span class="c1">// For wall targets, this update will displace the ghost sensor puck out from the wall (in a direction normal to the wall). </span>
<span class="w">      </span><span class="nx">client</span><span class="p">.</span><span class="nx">updateBox2dSensor</span><span class="p">(</span><span class="w"> </span><span class="nx">displace_2d_m</span><span class="p">);</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Move the client cursor pin to the cursor position and add ghost-ball offsets if any.</span>
<span class="w">      </span><span class="nx">client</span><span class="p">.</span><span class="nx">pin</span><span class="p">.</span><span class="nx">setPosition</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">mouse_2d_m</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="w"> </span><span class="nx">cursorPinOffset_2d_m</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">toggleProjectileForecast</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">m_projectileForecast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">m_projectileForecast</span><span class="p">;</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">flagWord</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">m_projectileForecast</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;ON&#39;</span><span class="o">:</span><span class="s1">&#39;OFF&#39;</span>
<span class="w">      </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="w"> </span><span class="s2">&quot;projectile forecast: [Arial,yellow]&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">flagWord</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;[base]&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">2.0</span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">drawProjectilePath</span><span class="p">(</span><span class="w"> </span><span class="nx">drawingContext</span><span class="p">,</span><span class="w"> </span><span class="nx">client</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">shotVelocity_2d_mps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">calcShotVelocity</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="p">);</span>
<span class="w">      </span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">dt_s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">getDeltaT_s</span><span class="p">();</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">t_report_limit_s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">dt_s</span><span class="p">;</span><span class="w"> </span><span class="c1">// draw every 0.1 seconds</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">g_mps2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">getG_mps2</span><span class="p">();</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">v_n_2d_mps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">shotVelocity_2d_mps</span><span class="p">;</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">pos_n_2d_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">.</span><span class="nx">copy</span><span class="p">();</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// for rectangular pucks</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">vertices_2d_m</span><span class="p">;</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">shape</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s2">&quot;circle&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">vertices_2d_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">bS</span><span class="p">.</span><span class="nx">b2d_getPolygonVertices_2d_m</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">b2d</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">i_report</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">time_s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">      </span>
<span class="w">      </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="cm">/* Quoted from Box2D documentation:</span>
<span class="cm">         &quot;Box2D uses the symplectic Euler integration scheme. It does not </span>
<span class="cm">         reproduce parabolic motion of projectiles and has only first-order </span>
<span class="cm">         accuracy. However it is fast and has good stability.&quot; </span>
<span class="cm">         </span>
<span class="cm">         The Euler method is used here in this prediction of the puck&#39;s 25 </span>
<span class="cm">         positions over a period of 25*0.1 = 2.5s. These 25 predictions are drawn </span>
<span class="cm">         with a 0.4 lineAlpha. These are identical to Box2D calculations. </span>
<span class="cm">         */</span>
<span class="w">         </span><span class="nx">v_n_2d_mps</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">(</span><span class="o">-</span><span class="mf">1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">g_mps2</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">dt_s</span><span class="p">;</span>
<span class="w">         </span><span class="nx">v_n_2d_mps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">v_n_2d_mps</span><span class="p">.</span><span class="nx">scaleBy</span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="mf">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">linDamp</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">dt_s</span><span class="p">))</span><span class="w"> </span><span class="p">);</span><span class="w"> </span><span class="c1">// drag effects</span>
<span class="w">         </span>
<span class="w">         </span><span class="nx">pos_n_2d_m</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">v_n_2d_mps</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">dt_s</span><span class="p">;</span>
<span class="w">         </span><span class="nx">pos_n_2d_m</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">v_n_2d_mps</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">dt_s</span><span class="p">;</span><span class="w">  </span><span class="c1">// ( (v_n_2d_mps.y * dt_s) + (0.5 * (-1 * g_mps2) * Math.pow( dt_s, 2)) );</span>
<span class="w">         </span>
<span class="w">         </span><span class="nx">time_s</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">dt_s</span><span class="p">;</span><span class="w">         </span>
<span class="w">         </span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">time_s</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">t_report_limit_s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">shape</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;circle&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">client</span><span class="p">.</span><span class="nx">drawCircle</span><span class="p">(</span><span class="w"> </span><span class="nx">drawingContext</span><span class="p">,</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">screenFromWorld</span><span class="p">(</span><span class="w"> </span><span class="nx">pos_n_2d_m</span><span class="p">),</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;borderColor&#39;</span><span class="o">:</span><span class="s1">&#39;white&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;borderWidth_px&#39;</span><span class="o">:</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;fillColor&#39;</span><span class="o">:</span><span class="s1">&#39;noFill&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;lineAlpha&#39;</span><span class="o">:</span><span class="mf">0.4</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;radius_px&#39;</span><span class="o">:</span><span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">radius_px</span><span class="p">});</span>
<span class="w">            </span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="c1">// difference between original the nth position (not diff between n-1 and n).</span>
<span class="w">               </span><span class="kd">let</span><span class="w"> </span><span class="nx">delta_n_2d_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pos_n_2d_m</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">);</span>
<span class="w">               </span>
<span class="w">               </span><span class="kd">let</span><span class="w"> </span><span class="nx">vertices_n_2d_px</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">               </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="nx">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">vertices_2d_m</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">len</span><span class="p">;</span><span class="w"> </span><span class="nx">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="c1">// Calculate where the vertices would be at step n...</span>
<span class="w">                  </span><span class="kd">var</span><span class="w"> </span><span class="nx">p_2d_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">vertices_2d_m</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">add</span><span class="p">(</span><span class="w"> </span><span class="nx">delta_n_2d_m</span><span class="p">);</span>
<span class="w">                  </span><span class="nx">vertices_n_2d_px</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">screenFromWorld</span><span class="p">(</span><span class="w"> </span><span class="nx">p_2d_m</span><span class="p">));</span>
<span class="w">               </span><span class="p">}</span>
<span class="w">               </span><span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">drawPolygon</span><span class="p">(</span><span class="w"> </span><span class="nx">drawingContext</span><span class="p">,</span><span class="w"> </span><span class="nx">vertices_n_2d_px</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;borderColor&#39;</span><span class="o">:</span><span class="s1">&#39;white&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;borderWidth_px&#39;</span><span class="o">:</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;fillIt&#39;</span><span class="o">:</span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;lineAlpha&#39;</span><span class="o">:</span><span class="mf">0.4</span><span class="p">});</span><span class="w"> </span><span class="c1">// 0.4</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="nx">i_report</span><span class="o">++</span><span class="p">;</span>
<span class="w">            </span><span class="nx">time_s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">         </span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nx">i_report</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">25</span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">drawGhostBall</span><span class="p">(</span><span class="w"> </span><span class="nx">drawingContext</span><span class="p">,</span><span class="w"> </span><span class="nx">client</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// drawGhostBall runs after the engine step. Path lines for wall targets depend on the engine result (contact normals).</span>
<span class="w">      </span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">mouseToWallContact_2d_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">gBS</span><span class="p">.</span><span class="nx">mouseToWallContact_2d_m</span><span class="p">;</span>
<span class="w">      </span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">lockedAndJustPositioning</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">ctrlShiftLock</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">key_ctrl</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;D&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">key_shift</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;U&quot;</span><span class="p">);</span>
<span class="w">      </span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">lockedAndJustPositioning</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">poolShotLocked</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">speed_mps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">parseFloat</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">poolShotLockedSpeed_mps</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="w"> </span><span class="mf">1</span><span class="p">));</span>
<span class="w">            </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;gameTitle&#39;</span><span class="p">].</span><span class="nx">resetMessage</span><span class="p">();</span>
<span class="w">            </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">nameString</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;:\\  shot speed locked: [25px Arial,yellow]&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">speed_mps</span><span class="p">.</span><span class="nx">toLocaleString</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;[base] mps&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0.3</span><span class="p">);</span>
<span class="w">            </span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">e_s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">calcPoolShotEandS</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="p">);</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">speed_mps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">e_s</span><span class="p">.</span><span class="nx">cueBallSpeed_mps</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mf">1</span><span class="p">);</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">energy_j</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nx">e_s</span><span class="p">.</span><span class="nx">energy_joules</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mf">1</span><span class="p">);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="nx">messageString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">nameString</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;:\\  shot speed: [25px Arial,yellow]&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">speed_mps</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;[base] mps, energy: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">energy_j</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot; J&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">;</span>
<span class="w">                                </span><span class="c1">//&quot;\\   \u03B8_deg:&quot; + (client.selectedBody.b2d.GetAngle() * 180/Math.PI).toFixed(1);</span>
<span class="w">            </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="w"> </span><span class="nx">messageString</span><span class="p">,</span><span class="w"> </span><span class="mf">0.3</span><span class="p">);</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">         </span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nx">m_projectileForecast</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">getG_ON</span><span class="p">()</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">drawProjectilePath</span><span class="p">(</span><span class="w"> </span><span class="nx">drawingContext</span><span class="p">,</span><span class="w"> </span><span class="nx">client</span><span class="p">);</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// add some pool game info...</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoVersion</span><span class="p">().</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">3</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;3.d&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">m_poolGameOver</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">poolShotCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">addToIt</span><span class="p">(</span><span class="w"> </span><span class="s2">&quot;\\  shot count = &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">poolShotCount</span><span class="p">);</span>
<span class="w">               </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">addToIt</span><span class="p">(</span><span class="w"> </span><span class="s2">&quot;\\  pocketed balls (without a foul) = &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">pocketedBallCount</span><span class="p">);</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">scratchedDuringGame</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">objectBallFoulDuringGame</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">mouseStopFoulDuringGame</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">addToIt</span><span class="p">(</span><span class="w"> </span><span class="s2">&quot;\\  clean game so far&quot;</span><span class="p">);</span>
<span class="w">               </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="c1">// nothing yet...</span>
<span class="w">               </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">addToIt</span><span class="p">(</span><span class="w"> </span><span class="s2">&quot;\\  score = [base,yellow]&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">score</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;[base]&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">mouseStopMessage</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">            </span>
<span class="w">               </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">addToIt</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">mouseStopMessage</span><span class="p">);</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">m_cushionCollisionPenaltyGiven</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">addToIt</span><span class="p">(</span><span class="s2">&quot;\\  safety-shot penalty, -10&quot;</span><span class="p">);</span>
<span class="w">               </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Provide alignment aids when ghost-ball is touching the target ball or wall (no aids if shooting a rectangle or if gravity is ON).</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">client</span><span class="p">.</span><span class="nx">sensorTargetName</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">shape</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;circle&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">getG_ON</span><span class="p">())</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">lockedAndJustPositioning</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// In Ghost-Ball Pool, automatically turn on finemoves when ghost touches a target.</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">client</span><span class="p">.</span><span class="nx">fineMovesState</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;off&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoVersion</span><span class="p">().</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">3</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;3.d&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">            </span><span class="nx">client</span><span class="p">.</span><span class="nx">previousFine_2d_px</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">mouse_2d_px</span><span class="p">;</span>
<span class="w">            </span><span class="nx">client</span><span class="p">.</span><span class="nx">fineMovesState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;on&#39;</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span>

<span class="w">         </span><span class="nx">client</span><span class="p">.</span><span class="nx">gBS</span><span class="p">.</span><span class="nx">pathAfter</span><span class="p">.</span><span class="nx">ghostPuckCenter_2d_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">         </span><span class="nx">client</span><span class="p">.</span><span class="nx">gBS</span><span class="p">.</span><span class="nx">pathAfter</span><span class="p">.</span><span class="nx">ghostPuckRadius_px</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">radius_px</span><span class="p">;</span>
<span class="w">         </span><span class="nx">client</span><span class="p">.</span><span class="nx">gBS</span><span class="p">.</span><span class="nx">pathAfter</span><span class="p">.</span><span class="nx">lines</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">         </span><span class="nx">client</span><span class="p">.</span><span class="nx">gBS</span><span class="p">.</span><span class="nx">pathAfter</span><span class="p">.</span><span class="nx">enabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">         </span><span class="nx">client</span><span class="p">.</span><span class="nx">gBS</span><span class="p">.</span><span class="nx">pathAfter</span><span class="p">.</span><span class="nx">sensorTargetName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">sensorTargetName</span><span class="p">;</span>
<span class="w">         </span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">sensorTargetName</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;puck&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">puckMap</span><span class="p">[</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">sensorTargetName</span><span class="p">].</span><span class="nx">shape</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;circle&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">fineMovesState</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;inTransition&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">targetPuck</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">puckMap</span><span class="p">[</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">sensorTargetName</span><span class="p">];</span>
<span class="w">            </span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">restitution</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">1.0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">targetPuck</span><span class="p">.</span><span class="nx">restitution</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">1.0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">friction</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="nx">targetPuck</span><span class="p">.</span><span class="nx">friction</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0.0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="kd">var</span><span class="w"> </span><span class="nx">elasticCollision</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="kd">var</span><span class="w"> </span><span class="nx">elasticCollision</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">// Distance between the cursor and the center of the target puck.</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">cursorToTarget_2d_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">mouse_2d_m</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="w"> </span><span class="nx">targetPuck</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">);</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">cursorToTarget_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cursorToTarget_2d_m</span><span class="p">.</span><span class="nx">length</span><span class="p">();</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">// Needed distance between the centers of the ghost and target puck so that they are touching (a kiss).</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">kissSeparation_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">radius_m</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">targetPuck</span><span class="p">.</span><span class="nx">radius_m</span><span class="p">;</span>
<span class="w">            </span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">contactNormal_2d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cursorToTarget_2d_m</span><span class="p">.</span><span class="nx">normal</span><span class="p">();</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">// Draw normal and tangent lines out from the center of the ghost puck.</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">ghostPuckCenter_2d_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">targetPuck</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="w"> </span><span class="nx">cursorToTarget_2d_m</span><span class="p">.</span><span class="nx">normal</span><span class="p">().</span><span class="nx">scaleBy</span><span class="p">(</span><span class="w"> </span><span class="nx">kissSeparation_m</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
<span class="w">            </span><span class="nx">client</span><span class="p">.</span><span class="nx">gBS</span><span class="p">.</span><span class="nx">pathAfter</span><span class="p">.</span><span class="nx">ghostPuckCenter_2d_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ghostPuckCenter_2d_m</span><span class="p">;</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">lengthScaleFactor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">8</span><span class="p">;</span>
<span class="w">            </span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">contactPoint_2d_m</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nx">ghostPuckCenter_2d_m</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="w"> </span><span class="nx">contactNormal_2d</span><span class="p">.</span><span class="nx">scaleBy</span><span class="p">(</span><span class="w"> </span><span class="o">-</span><span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">radius_m</span><span class="p">));</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">contactPoint_2d_px</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">screenFromWorld</span><span class="p">(</span><span class="w"> </span><span class="nx">contactPoint_2d_m</span><span class="p">);</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">// normal line center of ghostPuck to contact point</span>
<span class="w">            </span><span class="nx">client</span><span class="p">.</span><span class="nx">drawLine</span><span class="p">(</span><span class="w"> </span><span class="nx">drawingContext</span><span class="p">,</span><span class="w"> </span><span class="nx">contactPoint_2d_px</span><span class="p">,</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">screenFromWorld</span><span class="p">(</span><span class="w"> </span><span class="nx">ghostPuckCenter_2d_m</span><span class="p">),</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;width_px&#39;</span><span class="o">:</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;color&#39;</span><span class="o">:</span><span class="s1">&#39;yellow&#39;</span><span class="p">});</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">// the contact point</span>
<span class="w">            </span><span class="nx">client</span><span class="p">.</span><span class="nx">drawCircle</span><span class="p">(</span><span class="w"> </span><span class="nx">drawingContext</span><span class="p">,</span><span class="w"> </span><span class="nx">contactPoint_2d_px</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;borderColor&#39;</span><span class="o">:</span><span class="s1">&#39;white&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;borderWidth_px&#39;</span><span class="o">:</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;fillColor&#39;</span><span class="o">:</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;radius_px&#39;</span><span class="o">:</span><span class="mf">3</span><span class="p">});</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">// Draw lines for shot aiming</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">lessThanGlancing</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="p">,</span><span class="w"> </span><span class="nx">contactNormal_2d</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="kd">let</span><span class="w"> </span><span class="nx">color</span><span class="p">,</span><span class="w"> </span><span class="nx">dashArray</span><span class="p">,</span><span class="w"> </span><span class="nx">lineWidth_px</span><span class="p">,</span><span class="w"> </span><span class="nx">startingPoint_2d_m</span><span class="p">;</span>
<span class="w">               </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">legIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span><span class="w"> </span><span class="nx">legIndex</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">4</span><span class="p">;</span><span class="w"> </span><span class="nx">legIndex</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="kd">let</span><span class="w"> </span><span class="nx">useThisLineForPathShadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">                  </span>
<span class="w">                  </span><span class="c1">// copy so don&#39;t rotate contactNormal_2d</span>
<span class="w">                  </span><span class="kd">let</span><span class="w"> </span><span class="nx">orientation_2d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">contactNormal_2d</span><span class="p">.</span><span class="nx">copy</span><span class="p">();</span>
<span class="w">                  </span><span class="kd">let</span><span class="w"> </span><span class="nx">okToDraw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">                  </span>
<span class="w">                  </span><span class="c1">// tail end of the target ball path </span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">legIndex</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoVersion</span><span class="p">().</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">3</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;3.d&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="nx">startingPoint_2d_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ghostPuckCenter_2d_m</span><span class="p">;</span>
<span class="w">                     </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="nx">startingPoint_2d_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ghostPuckCenter_2d_m</span><span class="p">;</span>
<span class="w">                     </span><span class="p">}</span>
<span class="w">                     </span><span class="nx">orientation_2d</span><span class="p">.</span><span class="nx">rotated_by</span><span class="p">(</span><span class="w">  </span><span class="mf">0</span><span class="p">);</span><span class="w"> </span>
<span class="w">                     </span><span class="nx">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;yellow&#39;</span><span class="p">;</span>
<span class="w">                     </span><span class="nx">lineWidth_px</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2</span><span class="p">;</span>
<span class="w">                     </span><span class="nx">dashArray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mf">10</span><span class="p">];</span><span class="w"> </span><span class="c1">// large dashes</span>
<span class="w">                  </span>
<span class="w">                  </span><span class="c1">// front end of the target ball path</span>
<span class="w">                  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">legIndex</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoVersion</span><span class="p">().</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">3</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;3.d&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="c1">// far edge of target puck</span>
<span class="w">                        </span><span class="nx">startingPoint_2d_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">targetPuck</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="w"> </span><span class="nx">contactNormal_2d</span><span class="p">.</span><span class="nx">scaleBy</span><span class="p">(</span><span class="w"> </span><span class="o">-</span><span class="nx">targetPuck</span><span class="p">.</span><span class="nx">radius_m</span><span class="p">));</span>
<span class="w">                     </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="c1">// slightly in from the near edge of target puck (so don&#39;t draw over the red dot)</span>
<span class="w">                        </span><span class="nx">startingPoint_2d_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">targetPuck</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="w"> </span><span class="nx">contactNormal_2d</span><span class="p">.</span><span class="nx">scaleBy</span><span class="p">(</span><span class="w"> </span><span class="o">+</span><span class="nx">targetPuck</span><span class="p">.</span><span class="nx">radius_m</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">meters_from_px</span><span class="p">(</span><span class="mf">2.5</span><span class="p">)));</span>
<span class="w">                     </span><span class="p">}</span>
<span class="w">                     </span>
<span class="w">                     </span><span class="nx">orientation_2d</span><span class="p">.</span><span class="nx">rotated_by</span><span class="p">(</span><span class="mf">180</span><span class="p">);</span><span class="w">                     </span>
<span class="w">                     </span><span class="nx">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;yellow&#39;</span><span class="p">;</span>
<span class="w">                     </span><span class="nx">lineWidth_px</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2</span><span class="p">;</span>
<span class="w">                     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">elasticCollision</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="nx">dashArray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span><span class="w"> </span><span class="c1">// solid line</span>
<span class="w">                        </span><span class="nx">useThisLineForPathShadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">                     </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="nx">dashArray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mf">3</span><span class="p">];</span>
<span class="w">                     </span><span class="p">}</span>
<span class="w">                  </span>
<span class="w">                  </span><span class="c1">// cue ball path lines, solid one is followed</span>
<span class="w">                  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">legIndex</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">2</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="nx">legIndex</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">4</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                     </span><span class="nx">startingPoint_2d_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ghostPuckCenter_2d_m</span><span class="p">;</span>
<span class="w">                     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">legIndex</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="nx">orientation_2d</span><span class="p">.</span><span class="nx">rotated_by</span><span class="p">(</span><span class="w"> </span><span class="mf">90</span><span class="p">);</span>
<span class="w">                     </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">legIndex</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">4</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="nx">orientation_2d</span><span class="p">.</span><span class="nx">rotated_by</span><span class="p">(</span><span class="mf">270</span><span class="p">);</span>
<span class="w">                     </span><span class="p">}</span>
<span class="w">                     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">radius_m</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">targetPuck</span><span class="p">.</span><span class="nx">radius_m</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="kd">let</span><span class="w"> </span><span class="nx">dotProduct</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">cursorSpring</span><span class="p">.</span><span class="nx">p1p2_normalized_2d</span><span class="p">.</span><span class="nx">dot</span><span class="p">(</span><span class="w"> </span><span class="nx">orientation_2d</span><span class="p">);</span>
<span class="w">                        </span><span class="cm">/*</span>
<span class="cm">                        if (legIndex == 2) {</span>
<span class="cm">                           let debugString = legIndex + &quot;, dot=&quot; + dot.toFixed(3);</span>
<span class="cm">                           hC.sendSocketControlMessage( {&#39;from&#39;:&#39;anyone&#39;, &#39;to&#39;:&#39;host&#39;, &#39;data&#39;:{&#39;androidDebug&#39;:{&#39;value&#39;:true,&#39;debugString&#39;:debugString}} } );</span>
<span class="cm">                        }                  </span>
<span class="cm">                        */</span>
<span class="w">                        </span><span class="nx">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;white&#39;</span><span class="p">;</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">dotProduct</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                           </span><span class="nx">lineWidth_px</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2</span><span class="p">;</span>
<span class="w">                           </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">elasticCollision</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                              </span><span class="nx">dashArray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span><span class="w"> </span><span class="c1">// solid line</span>
<span class="w">                              </span><span class="nx">useThisLineForPathShadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">                           </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                              </span><span class="nx">dashArray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mf">3</span><span class="p">];</span>
<span class="w">                           </span><span class="p">}</span>
<span class="w">                        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                           </span><span class="nx">lineWidth_px</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2</span><span class="p">;</span>
<span class="w">                           </span><span class="nx">dashArray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mf">10</span><span class="p">];</span><span class="w"> </span><span class="c1">// large dashes</span>
<span class="w">                        </span><span class="p">}</span>
<span class="w">                     </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="nx">okToDraw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">                     </span><span class="p">}</span>
<span class="w">                  </span><span class="p">}</span>
<span class="w">                  </span><span class="kd">let</span><span class="w"> </span><span class="nx">endPoint_2d_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ghostPuckCenter_2d_m</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="w"> </span><span class="nx">orientation_2d</span><span class="p">.</span><span class="nx">scaleBy</span><span class="p">(</span><span class="w"> </span><span class="nx">lengthScaleFactor</span><span class="p">));</span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">okToDraw</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                     </span><span class="kd">let</span><span class="w"> </span><span class="nx">startingPoint_2d_px</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">screenFromWorld</span><span class="p">(</span><span class="w"> </span><span class="nx">startingPoint_2d_m</span><span class="p">);</span>
<span class="w">                     </span><span class="kd">let</span><span class="w"> </span><span class="nx">endPoint_2d_px</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">screenFromWorld</span><span class="p">(</span><span class="w"> </span><span class="nx">endPoint_2d_m</span><span class="p">);</span>
<span class="w">                     </span><span class="nx">client</span><span class="p">.</span><span class="nx">drawLine</span><span class="p">(</span><span class="w"> </span><span class="nx">drawingContext</span><span class="p">,</span><span class="w"> </span><span class="nx">startingPoint_2d_px</span><span class="p">,</span><span class="w"> </span><span class="nx">endPoint_2d_px</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;width_px&#39;</span><span class="o">:</span><span class="nx">lineWidth_px</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;color&#39;</span><span class="o">:</span><span class="nx">color</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;dashArray&#39;</span><span class="o">:</span><span class="nx">dashArray</span><span class="p">});</span>
<span class="w">                     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">useThisLineForPathShadow</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="nx">client</span><span class="p">.</span><span class="nx">gBS</span><span class="p">.</span><span class="nx">pathAfter</span><span class="p">.</span><span class="nx">lines</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;direction_2d&#39;</span><span class="o">:</span><span class="nx">orientation_2d</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;color&#39;</span><span class="o">:</span><span class="nx">color</span><span class="p">}</span><span class="w"> </span><span class="p">);</span>
<span class="w">                     </span><span class="p">}</span>
<span class="w">                  </span><span class="p">}</span>
<span class="w">               </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">sensorTargetName</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;wall&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">mouseToWallContact_2d_m</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w">  </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">fineMovesState</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;inTransition&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="nx">dashArray</span><span class="p">,</span><span class="w"> </span><span class="nx">useThisLineForPathShadow</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">restitution</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">1.0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">friction</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0.0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">dashArray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">               </span><span class="nx">useThisLineForPathShadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">dashArray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mf">3</span><span class="p">];</span>
<span class="w">               </span><span class="nx">useThisLineForPathShadow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span>
<span class="w">            </span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">contactPoint_2d_m</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D_from_b2Vec2</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">sensorContact</span><span class="p">.</span><span class="nx">points_2d_m</span><span class="p">[</span><span class="mf">0</span><span class="p">]);</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">contactPoint_2d_px</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">screenFromWorld</span><span class="p">(</span><span class="w"> </span><span class="nx">contactPoint_2d_m</span><span class="p">);</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">// normal line from contact event</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">contactNormal_2d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D_from_b2Vec2</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">sensorContact</span><span class="p">.</span><span class="nx">normal_2d</span><span class="p">);</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">contactNormal_2d_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">contactNormal_2d</span><span class="p">.</span><span class="nx">scaleBy</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">radius_m</span><span class="p">);</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">normalLine_endpoint_2d_px</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">screenFromWorld</span><span class="p">(</span><span class="w"> </span><span class="nx">contactPoint_2d_m</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="w"> </span><span class="nx">contactNormal_2d_m</span><span class="p">));</span>
<span class="w">            </span>
<span class="w">            </span><span class="nx">client</span><span class="p">.</span><span class="nx">drawLine</span><span class="p">(</span><span class="w"> </span><span class="nx">drawingContext</span><span class="p">,</span><span class="w"> </span><span class="nx">contactPoint_2d_px</span><span class="p">,</span><span class="w"> </span><span class="nx">normalLine_endpoint_2d_px</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;width_px&#39;</span><span class="o">:</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;color&#39;</span><span class="o">:</span><span class="s1">&#39;yellow&#39;</span><span class="p">});</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">// the contact point</span>
<span class="w">            </span><span class="nx">client</span><span class="p">.</span><span class="nx">drawCircle</span><span class="p">(</span><span class="w"> </span><span class="nx">drawingContext</span><span class="p">,</span><span class="w"> </span><span class="nx">contactPoint_2d_px</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;borderColor&#39;</span><span class="o">:</span><span class="s1">&#39;white&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;borderWidth_px&#39;</span><span class="o">:</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;fillColor&#39;</span><span class="o">:</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;radius_px&#39;</span><span class="o">:</span><span class="mf">3</span><span class="p">});</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">// vector along the line from the ghost to the selected puck</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">ghostPosition_2d_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">pin</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">;</span><span class="w">  </span><span class="c1">//client.mouse_2d_m.add( cursorPinOffset_2d_m);</span>
<span class="w">            </span><span class="nx">client</span><span class="p">.</span><span class="nx">gBS</span><span class="p">.</span><span class="nx">pathAfter</span><span class="p">.</span><span class="nx">ghostPuckCenter_2d_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ghostPosition_2d_m</span><span class="p">;</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">ghostToSelected_2d_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="w"> </span><span class="nx">ghostPosition_2d_m</span><span class="p">);</span><span class="w"> </span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">// angular difference between the spring line and the contact normal</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">diffWithNormal_deg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ghostToSelected_2d_m</span><span class="p">.</span><span class="nx">get_angle</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">contactNormal_2d_m</span><span class="p">.</span><span class="nx">get_angle</span><span class="p">();</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">diffWithNormal_deg</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="nx">diffWithNormal_deg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">diffWithNormal_deg</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">360</span><span class="p">;</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">// direction after the wall collision</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">angleAfterWallCollision</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ghostToSelected_2d_m</span><span class="p">.</span><span class="nx">get_angle</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="mf">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">diffWithNormal_deg</span><span class="p">);</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">directionAfterWallCollision_2d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">);</span>
<span class="w">            </span><span class="nx">directionAfterWallCollision_2d</span><span class="p">.</span><span class="nx">set_angle</span><span class="p">(</span><span class="w"> </span><span class="nx">angleAfterWallCollision</span><span class="p">);</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">directionAfterWallCollision_2d_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">directionAfterWallCollision_2d</span><span class="p">.</span><span class="nx">scaleBy</span><span class="p">(</span><span class="w"> </span><span class="mf">12</span><span class="p">);</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">// line the puck follows after the wall collision</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">endPointForCollisionLine_2d_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ghostPosition_2d_m</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="w"> </span><span class="nx">directionAfterWallCollision_2d_m</span><span class="p">);</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">// Use the dot product to determine when the user has pushed the cursor into the wall. When the sensor is</span>
<span class="w">            </span><span class="c1">// displaced (using displace_2d_m), the dot product will go negative when the cursor is pushed beyond the engine&#39;s contact point.</span>
<span class="w">            </span><span class="c1">// Also, if diffWithNormal_deg is greater than 90, you must be aiming around a corner or on the far side of a wall.</span>
<span class="w">            </span><span class="c1">// Inhibit the alignment lines in both of these cases.</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">dotProduct</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">contactNormal_2d</span><span class="p">.</span><span class="nx">dot</span><span class="p">(</span><span class="w"> </span><span class="nx">mouseToWallContact_2d_m</span><span class="p">);</span>
<span class="w">            </span><span class="c1">// Not accurate when the user is pushing the sensor into the wall too far (negative dotProduct).</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="nx">dotProduct</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">((</span><span class="nx">diffWithNormal_deg</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">90.0</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="nx">diffWithNormal_deg</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">270.0</span><span class="p">))</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">useThisLineForPathShadow</span><span class="p">)</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">gBS</span><span class="p">.</span><span class="nx">pathAfter</span><span class="p">.</span><span class="nx">lines</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;direction_2d&#39;</span><span class="o">:</span><span class="nx">directionAfterWallCollision_2d</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;color&#39;</span><span class="o">:</span><span class="s1">&#39;white&#39;</span><span class="p">}</span><span class="w"> </span><span class="p">);</span>
<span class="w">               </span><span class="nx">client</span><span class="p">.</span><span class="nx">drawLine</span><span class="p">(</span><span class="w"> </span><span class="nx">drawingContext</span><span class="p">,</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">screenFromWorld</span><span class="p">(</span><span class="w"> </span><span class="nx">ghostPosition_2d_m</span><span class="p">),</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">screenFromWorld</span><span class="p">(</span><span class="w"> </span><span class="nx">endPointForCollisionLine_2d_m</span><span class="p">),</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;width_px&#39;</span><span class="o">:</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;color&#39;</span><span class="o">:</span><span class="s1">&#39;white&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;dashArray&#39;</span><span class="o">:</span><span class="nx">dashArray</span><span class="p">});</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="c1">// If not engaged with a target puck, automatically transition out of finemoves when playing ghost-ball pool.</span>
<span class="w">         </span><span class="kd">let</span><span class="w"> </span><span class="nx">poolWithGravityOff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoVersion</span><span class="p">().</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">3</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;3.d&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">getG_ON</span><span class="p">())</span><span class="w"> </span><span class="p">);</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">poolWithGravityOff</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">fineMovesState</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;on&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">            </span><span class="nx">wS</span><span class="p">.</span><span class="nx">exitFineMoves</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">shape</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;circle&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">lockedAndJustPositioning</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">getG_ON</span><span class="p">())</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="c1">// Draw the ghost ball at the position of the cursor pin (note that the small pin circle is drawn as part of the drawCursor function)</span>
<span class="w">         </span><span class="nx">client</span><span class="p">.</span><span class="nx">drawCircle</span><span class="p">(</span><span class="w"> </span><span class="nx">drawingContext</span><span class="p">,</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">pin</span><span class="p">.</span><span class="nx">position_2d_px</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;borderColor&#39;</span><span class="o">:</span><span class="s1">&#39;white&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;borderWidth_px&#39;</span><span class="o">:</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;fillColor&#39;</span><span class="o">:</span><span class="s1">&#39;noFill&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;lineAlpha&#39;</span><span class="o">:</span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;radius_px&#39;</span><span class="o">:</span><span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">radius_px</span><span class="p">});</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span><span class="w">   </span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">resetPathAfterShot</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">timeForFade_s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.75</span><span class="p">;</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">framesForFade</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">getFrameRate</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">timeForFade_s</span><span class="p">;</span>
<span class="w">      </span>
<span class="w">      </span><span class="nx">client</span><span class="p">.</span><span class="nx">gBS</span><span class="p">.</span><span class="nx">pathAfter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;enabled&#39;</span><span class="o">:</span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;ghostPuckCenter_2d_m&#39;</span><span class="o">:</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;ghostPuckRadius_px&#39;</span><span class="o">:</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;lines&#39;</span><span class="o">:</span><span class="p">[],</span><span class="w"> </span>
<span class="w">                              </span><span class="s1">&#39;sensorTargetName&#39;</span><span class="o">:</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;fadeOut&#39;</span><span class="o">:</span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;fadeCounter&#39;</span><span class="o">:</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;framesForFade&#39;</span><span class="o">:</span><span class="nx">framesForFade</span><span class="p">};</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">drawPathAfterShot</span><span class="p">(</span><span class="w"> </span><span class="nx">drawingContext</span><span class="p">,</span><span class="w"> </span><span class="nx">client</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">client</span><span class="p">.</span><span class="nx">gBS</span><span class="p">.</span><span class="nx">pathAfter</span><span class="p">.</span><span class="nx">enabled</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">gBS</span><span class="p">.</span><span class="nx">pathAfter</span><span class="p">.</span><span class="nx">sensorTargetName</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="kd">let</span><span class="w"> </span><span class="nx">scalingFactor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">12.0</span><span class="p">;</span>
<span class="w">         </span><span class="kd">let</span><span class="w"> </span><span class="nx">dashArray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span><span class="w"> </span><span class="c1">// [] makes the line solid (no dash)</span>
<span class="w">         </span>
<span class="w">         </span><span class="kd">let</span><span class="w"> </span><span class="nx">fadeFactor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">gBS</span><span class="p">.</span><span class="nx">pathAfter</span><span class="p">.</span><span class="nx">framesForFade</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">gBS</span><span class="p">.</span><span class="nx">pathAfter</span><span class="p">.</span><span class="nx">fadeCounter</span><span class="p">)</span><span class="o">/</span><span class="nx">client</span><span class="p">.</span><span class="nx">gBS</span><span class="p">.</span><span class="nx">pathAfter</span><span class="p">.</span><span class="nx">framesForFade</span><span class="p">;</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">fadeFactor</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span><span class="w"> </span><span class="nx">fadeFactor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">gBS</span><span class="p">.</span><span class="nx">pathAfter</span><span class="p">.</span><span class="nx">fadeOut</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">client</span><span class="p">.</span><span class="nx">gBS</span><span class="p">.</span><span class="nx">pathAfter</span><span class="p">.</span><span class="nx">fadeCounter</span><span class="o">++</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">         </span>
<span class="w">         </span><span class="kd">let</span><span class="w"> </span><span class="nx">linesAlpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">fadeFactor</span><span class="p">;</span>
<span class="w">         </span><span class="kd">let</span><span class="w"> </span><span class="nx">ghostAlpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">fadeFactor</span><span class="p">;</span>
<span class="w">         </span><span class="kd">let</span><span class="w"> </span><span class="nx">smallCircleAlpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">fadeFactor</span><span class="p">;</span>
<span class="w">         </span>
<span class="w">         </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="nx">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">gBS</span><span class="p">.</span><span class="nx">pathAfter</span><span class="p">.</span><span class="nx">lines</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">len</span><span class="p">;</span><span class="w"> </span><span class="nx">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="nx">startPoint_2d_px</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">screenFromWorld</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">gBS</span><span class="p">.</span><span class="nx">pathAfter</span><span class="p">.</span><span class="nx">ghostPuckCenter_2d_m</span><span class="p">);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="nx">line_2d_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">gBS</span><span class="p">.</span><span class="nx">pathAfter</span><span class="p">.</span><span class="nx">lines</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">direction_2d</span><span class="p">.</span><span class="nx">scaleBy</span><span class="p">(</span><span class="w"> </span><span class="nx">scalingFactor</span><span class="p">);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="nx">endPoint_2d_px</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">screenFromWorld</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">gBS</span><span class="p">.</span><span class="nx">pathAfter</span><span class="p">.</span><span class="nx">ghostPuckCenter_2d_m</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="w"> </span><span class="nx">line_2d_m</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="nx">lineColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">gBS</span><span class="p">.</span><span class="nx">pathAfter</span><span class="p">.</span><span class="nx">lines</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">color</span><span class="p">;</span>
<span class="w">            </span><span class="nx">client</span><span class="p">.</span><span class="nx">drawLine</span><span class="p">(</span><span class="w"> </span><span class="nx">drawingContext</span><span class="p">,</span><span class="w"> </span><span class="nx">startPoint_2d_px</span><span class="p">,</span><span class="w"> </span><span class="nx">endPoint_2d_px</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;width_px&#39;</span><span class="o">:</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;color&#39;</span><span class="o">:</span><span class="nx">lineColor</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;alpha&#39;</span><span class="o">:</span><span class="nx">linesAlpha</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;dashArray&#39;</span><span class="o">:</span><span class="nx">dashArray</span><span class="p">});</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">         </span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">gBS</span><span class="p">.</span><span class="nx">pathAfter</span><span class="p">.</span><span class="nx">lines</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// the ghost circle</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="nx">circleAttributes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;borderColor&#39;</span><span class="o">:</span><span class="s1">&#39;white&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;borderWidth_px&#39;</span><span class="o">:</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;fillColor&#39;</span><span class="o">:</span><span class="s1">&#39;noFill&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;lineAlpha&#39;</span><span class="o">:</span><span class="nx">ghostAlpha</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;radius_px&#39;</span><span class="o">:</span><span class="nx">client</span><span class="p">.</span><span class="nx">gBS</span><span class="p">.</span><span class="nx">pathAfter</span><span class="p">.</span><span class="nx">ghostPuckRadius_px</span><span class="p">};</span>
<span class="w">            </span><span class="nx">client</span><span class="p">.</span><span class="nx">drawCircle</span><span class="p">(</span><span class="w"> </span><span class="nx">drawingContext</span><span class="p">,</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">screenFromWorld</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">gBS</span><span class="p">.</span><span class="nx">pathAfter</span><span class="p">.</span><span class="nx">ghostPuckCenter_2d_m</span><span class="p">),</span><span class="w"> </span><span class="nx">circleAttributes</span><span class="p">);</span>
<span class="w">            </span><span class="c1">// small circle in the middle</span>
<span class="w">            </span><span class="nx">circleAttributes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;borderColor&#39;</span><span class="o">:</span><span class="s1">&#39;white&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;borderWidth_px&#39;</span><span class="o">:</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;fillColor&#39;</span><span class="o">:</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;fillAlpha&#39;</span><span class="o">:</span><span class="nx">smallCircleAlpha</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;lineAlpha&#39;</span><span class="o">:</span><span class="nx">smallCircleAlpha</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;radius_px&#39;</span><span class="o">:</span><span class="mf">4</span><span class="p">};</span>
<span class="w">            </span><span class="nx">client</span><span class="p">.</span><span class="nx">drawCircle</span><span class="p">(</span><span class="w"> </span><span class="nx">drawingContext</span><span class="p">,</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">screenFromWorld</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">gBS</span><span class="p">.</span><span class="nx">pathAfter</span><span class="p">.</span><span class="nx">ghostPuckCenter_2d_m</span><span class="p">),</span><span class="w"> </span><span class="nx">circleAttributes</span><span class="p">);</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">checkForMouseStops</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="p">,</span><span class="w"> </span><span class="nx">selectedBody</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">m_poolGameOver</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">velocity_2d_mps</span><span class="p">.</span><span class="nx">zeroLength</span><span class="p">())</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">client</span><span class="p">.</span><span class="nx">score</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mf">5</span><span class="p">;</span>
<span class="w">         </span><span class="nx">client</span><span class="p">.</span><span class="nx">mouseStopPenalty</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mf">5</span><span class="p">;</span>
<span class="w">         </span><span class="nx">client</span><span class="p">.</span><span class="nx">mouseStopFoulDuringGame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">nBallsStopped</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">mouseStopPenalty</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">5</span><span class="p">;</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">nBallsStopped</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">ballsString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;a ball&quot;</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">ballsString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">nBallsStopped</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot; balls&quot;</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span>
<span class="w">         </span><span class="nx">client</span><span class="p">.</span><span class="nx">mouseStopMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;\\ \\  for stopping &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">ballsString</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot; with the mouse, &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">mouseStopPenalty</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">calcPoolShotEandS</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// EandS (Energy and Speed)</span>
<span class="w">      </span><span class="nx">client</span><span class="p">.</span><span class="nx">cursorSpring</span><span class="p">.</span><span class="nx">calculateSeparation</span><span class="p">();</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">dl_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">cursorSpring</span><span class="p">.</span><span class="nx">p1p2_separation_m</span><span class="p">;</span>
<span class="w">      </span><span class="c1">// Spring energy = 0.5 * k * x^2</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">springEnergy_joules</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">cursorSpring</span><span class="p">.</span><span class="nx">strength_Npm</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="w"> </span><span class="nx">dl_x</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">);</span>
<span class="w">      </span><span class="c1">// Puck (cue ball) speed after getting the spring energy:  0.5 * m * speed^2 = springEnergy</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">cueBallSpeed_mps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="w"> </span><span class="nx">springEnergy_joules</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mf">2.0</span><span class="o">/</span><span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">mass_kg</span><span class="p">));</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;energy_joules&#39;</span><span class="o">:</span><span class="nx">springEnergy_joules</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;cueBallSpeed_mps&#39;</span><span class="o">:</span><span class="nx">cueBallSpeed_mps</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;cursorSpringStretch_m&#39;</span><span class="o">:</span><span class="nx">dl_x</span><span class="p">};</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">setPoolShotLockedValues</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// These are energy-related characteristics of a locked shot.</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">poolShotEnergy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">calcPoolShotEandS</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="p">);</span>
<span class="w">      </span><span class="nx">client</span><span class="p">.</span><span class="nx">poolShotLockedSpeed_mps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">poolShotEnergy</span><span class="p">.</span><span class="nx">cueBallSpeed_mps</span><span class="p">;</span>
<span class="w">      </span><span class="nx">client</span><span class="p">.</span><span class="nx">poolShotLockedSpringStretch_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">poolShotEnergy</span><span class="p">.</span><span class="nx">cursorSpringStretch_m</span><span class="p">;</span>
<span class="w">      </span><span class="nx">client</span><span class="p">.</span><span class="nx">poolShotLockedEnergy_J</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">poolShotEnergy</span><span class="p">.</span><span class="nx">energy_joules</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">updatePoolShotLockedValues</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="cm">/* This is used AFTER a speed-lock has been set. So, if you release the cursor spring (release a mouse button) </span>
<span class="cm">      to grab a different puck, or change cursor springs, this will use the speed-lock value to determine corresponding</span>
<span class="cm">      shot energy and cursor-spring stretch. */</span>
<span class="w">      </span><span class="c1">// E = 0.5 * mv^2</span>
<span class="w">      </span><span class="nx">client</span><span class="p">.</span><span class="nx">poolShotLockedEnergy_J</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">mass_kg</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">poolShotLockedSpeed_mps</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">);</span>
<span class="w">      </span><span class="c1">// E = kx^2/2, x = (2E/k)^0.5</span>
<span class="w">      </span><span class="nx">client</span><span class="p">.</span><span class="nx">poolShotLockedSpringStretch_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="w"> </span><span class="mf">2.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">poolShotLockedEnergy_J</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">cursorSpring</span><span class="p">.</span><span class="nx">strength_Npm</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">togglePoolShotLock</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="kr">constructor</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;Puck&#39;</span><span class="p">))</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Set the shoot speed and lock it.</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">cursorSpring</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">setPoolShotLockedValues</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="p">);</span>
<span class="w">         </span><span class="nx">client</span><span class="p">.</span><span class="nx">poolShotLocked</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">         </span>
<span class="w">      </span><span class="c1">// Release the speed lock, no cursor spring here, or no ball (puck) selected.</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">client</span><span class="p">.</span><span class="nx">poolShotLocked</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">         </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">nameString</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot; UNLOCKED shot speed&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">calcShotVelocity</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">poolShotLocked</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">client</span><span class="p">.</span><span class="nx">cursorSpring</span><span class="p">.</span><span class="nx">calculateSeparation</span><span class="p">();</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">speed_mps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">poolShotLockedSpeed_mps</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">speed_mps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">calcPoolShotEandS</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="p">).</span><span class="nx">cueBallSpeed_mps</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Normalize the separation vector and then scale by the speed.</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">dr_2d_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">cursorSpring</span><span class="p">.</span><span class="nx">p1p2_separation_2d_m</span><span class="p">;</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// can not calculate a normal in cases where the separation vector has zero length. </span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">dr_2d_m</span><span class="p">.</span><span class="nx">zeroLength</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">velocity_2d_mps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="c1">// sign change is useful if the cue ball ends up touching the next object ball.</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">key_alt</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;D&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">sign</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">sign</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">velocity_2d_mps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">dr_2d_m</span><span class="p">.</span><span class="nx">normal</span><span class="p">().</span><span class="nx">scaleBy</span><span class="p">(</span><span class="w"> </span><span class="nx">sign</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">speed_mps</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">velocity_2d_mps</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">poolShot</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Once play starts, move the title more to the center, out of the way of the help lines.</span>
<span class="w">      </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;gameTitle&#39;</span><span class="p">].</span><span class="nx">loc_px</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="o">:</span><span class="mf">450</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="o">:</span><span class="mf">350</span><span class="p">};</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Restrict this to single-object selections.</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">count</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoVersion</span><span class="p">().</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">3</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;3.d&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s2">&quot;puck0&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">m_poolGameOver</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s2">&quot;shoot the cue ball during the game&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">);</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// Shoot it...</span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Always capture the table state at the time of the shot.</span>
<span class="w">            </span><span class="nx">addToTableHistory</span><span class="p">();</span>
<span class="w">            </span><span class="c1">// This flag indicates whether the end-result state has been captured. This flag is</span>
<span class="w">            </span><span class="c1">// used to capture (and avoid losing) the end-result state if you start to review the shot history (before taking another shot).</span>
<span class="w">            </span><span class="nx">m_endResultCaptured</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">            </span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoVersion</span><span class="p">().</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">3</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;3.d&quot;</span><span class="p">)</span><span class="w"> </span><span class="nx">separateIfTooClose</span><span class="p">();</span>
<span class="w">            </span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">shotVelocity_2d_mps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">calcShotVelocity</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">shotVelocity_2d_mps</span><span class="p">.</span><span class="nx">zeroLength</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="k">return</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">               </span>
<span class="w">               </span><span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">velocity_2d_mps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">shotVelocity_2d_mps</span><span class="p">;</span><span class="w"> </span><span class="c1">// new Vec2D(2.0, 0.0);</span>
<span class="w">               </span><span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">SetLinearVelocity</span><span class="p">(</span><span class="w"> </span><span class="nx">shotVelocity_2d_mps</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoVersion</span><span class="p">().</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">3</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;3.d&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">m_poolGameOver</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">client</span><span class="p">.</span><span class="nx">score</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mf">5</span><span class="p">;</span>
<span class="w">               </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">nameString</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot; has taken a shot, -5&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">10.0</span><span class="p">);</span>
<span class="w">               </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">nameString</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39; score = &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">score</span><span class="p">,</span><span class="w"> </span><span class="mf">10.0</span><span class="p">);</span>
<span class="w">               </span><span class="c1">// If pool shoot is from a network touch screen, the report will show a mark in the virtual-game-pad column.</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">touchScreenUsage</span><span class="p">)</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">virtualGamePadUsage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="c1">// note: cue ball is flagged as spotted after scratching</span>
<span class="w">            </span><span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">spotted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">            </span><span class="nx">m_mostRecentPoolShooter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
<span class="w">            </span><span class="nx">m_objectBallFoul</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">            </span><span class="nx">m_poolGameShotCount</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span><span class="w">  </span><span class="c1">// game shot count</span>
<span class="w">            </span><span class="nx">client</span><span class="p">.</span><span class="nx">poolShotCount</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span><span class="w"> </span><span class="c1">// client shot count</span>
<span class="w">            </span><span class="nx">client</span><span class="p">.</span><span class="nx">mouseStopMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="nx">client</span><span class="p">.</span><span class="nx">mouseStopPenalty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">            </span><span class="nx">client</span><span class="p">.</span><span class="nx">gBS</span><span class="p">.</span><span class="nx">pathAfter</span><span class="p">.</span><span class="nx">enabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">            </span><span class="c1">// Allow check on first CBC (Cue Ball Collision). </span>
<span class="w">            </span><span class="nx">m_readyForFirstCueBallCollision</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">            </span><span class="nx">m_cushionCollision</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">            </span><span class="nx">m_nonCueBallPocketed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">            </span><span class="nx">m_cushionCollisionPenaltyGiven</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">            </span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoVersion</span><span class="p">().</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;basketball&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="c1">// basketball shots</span>
<span class="w">               </span><span class="nx">bpH</span><span class="p">.</span><span class="nx">resetShotState</span><span class="p">({</span><span class="s1">&#39;clientName&#39;</span><span class="o">:</span><span class="nx">client</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;puckName&#39;</span><span class="o">:</span><span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                   </span><span class="s1">&#39;puck_v_2d_mps&#39;</span><span class="o">:</span><span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">velocity_2d_mps</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;puck_pos_2d_m&#39;</span><span class="o">:</span><span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">});</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoVersion</span><span class="p">().</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">3</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;4.e&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="c1">// Monkey Hunt</span>
<span class="w">               </span><span class="nx">mH</span><span class="p">.</span><span class="nx">resetShotState</span><span class="p">({</span><span class="s1">&#39;clientName&#39;</span><span class="o">:</span><span class="nx">client</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;puckName&#39;</span><span class="o">:</span><span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">name</span><span class="p">});</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span>
<span class="w">         </span><span class="p">}</span>
<span class="w">         </span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">ctrlShiftLock</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">key_shift</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;D&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="c1">// Ok ok ok. To shoot a group in the multi-select, ctrl-Shift-L then hold down the &quot;Shift&quot; key. Use the mouse wheel to see the speed-lock value. </span>
<span class="w">         </span><span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span><span class="w"> </span><span class="nx">tableObj</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">shotVelocity_2d_mps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">calcShotVelocity</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">shotVelocity_2d_mps</span><span class="p">.</span><span class="nx">zeroLength</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="k">return</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">               </span>
<span class="w">               </span><span class="nx">tableObj</span><span class="p">.</span><span class="nx">velocity_2d_mps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">shotVelocity_2d_mps</span><span class="p">;</span>
<span class="w">               </span><span class="nx">tableObj</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">SetLinearVelocity</span><span class="p">(</span><span class="w"> </span><span class="nx">shotVelocity_2d_mps</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">         </span><span class="p">});</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">findLowPuck</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// for finding the lowest puck in ghost-ball pool</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">lowPuck</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">100000</span><span class="p">;</span>
<span class="w">      </span><span class="nx">cP</span><span class="p">.</span><span class="nx">Puck</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span><span class="w"> </span><span class="nx">puck</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">puckNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">parseFloat</span><span class="p">(</span><span class="w"> </span><span class="nx">puck</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">4</span><span class="p">));</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">puck</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s2">&quot;puck0&quot;</span><span class="p">)</span><span class="w"> </span><span class="nx">lowPuck</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="w"> </span><span class="nx">puckNumber</span><span class="p">,</span><span class="w"> </span><span class="nx">lowPuck</span><span class="p">);</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">lowPuck</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mf">100000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">lowPuckName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;puck&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">lowPuck</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">lowPuckName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">lowPuckName</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">separateIfTooClose</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Trying to space out stationary balls so that trick-shot setups on the</span>
<span class="w">      </span><span class="c1">// pool table work a little better. This will disturb the rack a little on the</span>
<span class="w">      </span><span class="c1">// break, but maybe that&#39;s ok.</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">puckArray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">puckMap</span><span class="p">);</span>
<span class="w">      </span><span class="c1">// Look at all the puckA-PuckB combinations.</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="nx">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">puckArray</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">len</span><span class="p">;</span><span class="w"> </span><span class="nx">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="nx">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">j</span><span class="o">+</span><span class="mf">1</span><span class="p">;</span><span class="w"> </span><span class="nx">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">len</span><span class="p">;</span><span class="w"> </span><span class="nx">k</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">puckA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">puckMap</span><span class="p">[</span><span class="w"> </span><span class="nx">puckArray</span><span class="p">[</span><span class="w"> </span><span class="nx">j</span><span class="p">]];</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">puckB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">puckMap</span><span class="p">[</span><span class="w"> </span><span class="nx">puckArray</span><span class="p">[</span><span class="w"> </span><span class="nx">k</span><span class="p">]];</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">separationOfCenters_2d_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">puckA</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span><span class="w"> </span><span class="nx">puckB</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">);</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">separationNormal_2d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">separationOfCenters_2d_m</span><span class="p">.</span><span class="nx">normal</span><span class="p">();</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">separationOfCenters_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">separationOfCenters_2d_m</span><span class="p">.</span><span class="nx">length</span><span class="p">();</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">separationOfSurfaces_m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">separationOfCenters_m</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="nx">puckA</span><span class="p">.</span><span class="nx">radius_m</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">puckB</span><span class="p">.</span><span class="nx">radius_m</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">separationOfSurfaces_m</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.006</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="kd">var</span><span class="w"> </span><span class="nx">moveNeeded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mf">0.007</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">separationOfSurfaces_m</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span><span class="p">;</span>
<span class="w">               </span><span class="c1">// Separate pucks along the normal.</span>
<span class="w">               </span><span class="nx">puckA</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">SetPosition</span><span class="p">(</span><span class="w"> </span><span class="nx">puckA</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="w">  </span><span class="nx">separationNormal_2d</span><span class="p">.</span><span class="nx">scaleBy</span><span class="p">(</span><span class="w">  </span><span class="nx">moveNeeded</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">);</span><span class="w"> </span>
<span class="w">               </span><span class="nx">puckB</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">SetPosition</span><span class="p">(</span><span class="w"> </span><span class="nx">puckB</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="w">  </span><span class="nx">separationNormal_2d</span><span class="p">.</span><span class="nx">scaleBy</span><span class="p">(</span><span class="w"> </span><span class="o">-</span><span class="nx">moveNeeded</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">);</span><span class="w"> </span>
<span class="w">            </span><span class="p">}</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">countStripesAndSolids</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">puckNumber</span><span class="p">;</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">n_solids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">n_stripes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">      </span><span class="nx">cP</span><span class="p">.</span><span class="nx">Puck</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span><span class="w"> </span><span class="nx">puck</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">puckNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">parseFloat</span><span class="p">(</span><span class="w"> </span><span class="nx">puck</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">4</span><span class="p">));</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">puckNumber</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">puckNumber</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">8</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">n_solids</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">puckNumber</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">8</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">n_stripes</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;stripes&#39;</span><span class="o">:</span><span class="nx">n_stripes</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;solids&#39;</span><span class="o">:</span><span class="nx">n_solids</span><span class="p">};</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">drawPoolBallFeatures</span><span class="p">(</span><span class="w"> </span><span class="nx">drawingContext</span><span class="p">,</span><span class="w"> </span><span class="nx">puck</span><span class="p">,</span><span class="w"> </span><span class="nx">pars</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{})</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">font</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span><span class="w"> </span><span class="nx">pars</span><span class="p">.</span><span class="nx">font</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;20px Arial&quot;</span><span class="p">);</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span><span class="w"> </span><span class="nx">pars</span><span class="p">.</span><span class="nx">color</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;black&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">puck</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">4</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">name</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="c1">// White circle with ball number in the middle</span>
<span class="w">         </span><span class="nx">puck</span><span class="p">.</span><span class="nx">drawCircle</span><span class="p">(</span><span class="w"> </span><span class="nx">drawingContext</span><span class="p">,</span><span class="w"> </span><span class="nx">puck</span><span class="p">.</span><span class="nx">position_2d_px</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;borderWidth_px&#39;</span><span class="o">:</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;fillColor&#39;</span><span class="o">:</span><span class="s1">&#39;lightgray&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;radius_px&#39;</span><span class="o">:</span><span class="mf">0.5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">puck</span><span class="p">.</span><span class="nx">radius_px</span><span class="p">});</span>
<span class="w">         </span>
<span class="w">         </span><span class="nx">drawingContext</span><span class="p">.</span><span class="nx">font</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">font</span><span class="p">;</span>
<span class="w">         </span><span class="nx">drawingContext</span><span class="p">.</span><span class="nx">fillStyle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">color</span><span class="p">;</span>
<span class="w">         </span><span class="nx">drawingContext</span><span class="p">.</span><span class="nx">textAlign</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;center&quot;</span><span class="p">;</span>
<span class="w">         </span><span class="nx">drawingContext</span><span class="p">.</span><span class="nx">textBaseline</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;middle&quot;</span><span class="p">;</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">x_px</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">puck</span><span class="p">.</span><span class="nx">position_2d_px</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">y_px</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">puck</span><span class="p">.</span><span class="nx">position_2d_px</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="nx">puck</span><span class="p">.</span><span class="nx">radius_px</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.05</span><span class="p">);</span>
<span class="w">         </span><span class="nx">drawingContext</span><span class="p">.</span><span class="nx">fillText</span><span class="p">(</span><span class="w"> </span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">x_px</span><span class="p">,</span><span class="w"> </span><span class="nx">y_px</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Balls higher than 8 are striped.</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">name</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">8</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">puck</span><span class="p">.</span><span class="nx">drawStripe</span><span class="p">(</span><span class="w"> </span><span class="nx">drawingContext</span><span class="p">,{</span><span class="s2">&quot;width&quot;</span><span class="o">:</span><span class="mf">0.25</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;stripeAngle_r&quot;</span><span class="o">:</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="o">/</span><span class="mf">4</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;trackPuckAngle&quot;</span><span class="o">:</span><span class="kc">false</span><span class="p">});</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Draw thick circle to identify the low puck, helpful for 9-ball and rotation.</span>
<span class="w">      </span><span class="c1">// (note: low-puck search and display timer not used for 8-ball)</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">puck</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">m_lowPuckName</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">puck</span><span class="p">.</span><span class="nx">lowBallFinderCircle_timer_s</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">puck</span><span class="p">.</span><span class="nx">lowBallFinderCircle_timerLimit_s</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">puck</span><span class="p">.</span><span class="nx">drawCircle</span><span class="p">(</span><span class="w"> </span><span class="nx">drawingContext</span><span class="p">,</span><span class="w"> </span><span class="nx">puck</span><span class="p">.</span><span class="nx">position_2d_px</span><span class="p">,</span><span class="w"> </span>
<span class="w">            </span><span class="p">{</span><span class="s1">&#39;borderColor&#39;</span><span class="o">:</span><span class="s1">&#39;white&#39;</span><span class="p">,</span><span class="w"> </span><span class="c1">//puck.color</span>
<span class="w">             </span><span class="s1">&#39;fillColor&#39;</span><span class="o">:</span><span class="s1">&#39;noFill&#39;</span><span class="p">,</span><span class="w"> </span>
<span class="w">             </span><span class="s1">&#39;borderWidth_px&#39;</span><span class="o">:</span><span class="nx">puck</span><span class="p">.</span><span class="nx">radius_px</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.2</span><span class="p">,</span><span class="w"> </span>
<span class="w">             </span><span class="s1">&#39;radius_px&#39;</span><span class="w">     </span><span class="o">:</span><span class="nx">puck</span><span class="p">.</span><span class="nx">radius_px</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1.5</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">);</span>
<span class="w">             </span>
<span class="w">         </span><span class="nx">puck</span><span class="p">.</span><span class="nx">lowBallFinderCircle_timer_s</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">getDeltaT_s</span><span class="p">();</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">checkPoolBallState</span><span class="p">(</span><span class="w"> </span><span class="nx">puck</span><span class="p">,</span><span class="w"> </span><span class="nx">pars</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{})</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// m_poolTimer_stateCheckLimit_s limits how often these checks are called in checkPoolGameState in updateAirTable method of gwModule.js.</span>
<span class="w">      </span><span class="c1">// When called, this is applied to each puck in the puck map.</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// If slow moving puck, stop it.</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">puck</span><span class="p">.</span><span class="nx">velocity_2d_mps</span><span class="p">.</span><span class="nx">length</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.2</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">getG_ON</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">puck</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">SetLinearVelocity</span><span class="p">(</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">b2DW</span><span class="p">.</span><span class="nx">Vec2</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">));</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Check if any puck is still moving.</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">puck</span><span class="p">.</span><span class="nx">velocity_2d_mps</span><span class="p">.</span><span class="nx">zeroLength</span><span class="p">())</span><span class="w"> </span><span class="nx">m_allPucksStopped</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Check if this ball has gone in a pocket (i.e. center is off the canvas, in meters).</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">limits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;min_x&#39;</span><span class="o">:</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;max_x&#39;</span><span class="o">:</span><span class="mf">19.0</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;min_y&#39;</span><span class="o">:</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;max_y&#39;</span><span class="o">:</span><span class="mf">10.75</span><span class="p">};</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">mS</span><span class="p">.</span><span class="nx">SelectBox</span><span class="p">.</span><span class="nx">pointInside</span><span class="p">(</span><span class="w"> </span><span class="nx">puck</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">,</span><span class="w"> </span><span class="nx">limits</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">theShooter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="w"> </span><span class="nx">m_mostRecentPoolShooter</span><span class="p">];</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// any ball (except the cue ball) goes in a pocket</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nx">puck</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s2">&quot;puck0&quot;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">m_nonCueBallPocketed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">puckNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">parseFloat</span><span class="p">(</span><span class="w"> </span><span class="nx">puck</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">4</span><span class="p">));</span>
<span class="w">            </span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">m_poolGameOver</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="w"> </span><span class="nx">m_objectBallFoul</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">puckMap</span><span class="p">[</span><span class="s1">&#39;puck0&#39;</span><span class="p">].</span><span class="nx">spotted</span><span class="w"> </span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="nx">theShooter</span><span class="p">.</span><span class="nx">score</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">                  </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">addToIt</span><span class="p">(</span><span class="s1">&#39;\\  &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">puckNumber</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;-ball pocketed after foul, +0&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;additionalTime_s&#39;</span><span class="o">:</span><span class="mf">2.0</span><span class="p">});</span>
<span class="w">               </span>
<span class="w">               </span><span class="c1">// clean shot: numbered ball pocketed without a foul.</span>
<span class="w">               </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="nx">theShooter</span><span class="p">.</span><span class="nx">pocketedBallCount</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoVersion</span><span class="p">().</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;8ball&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                     </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">puckNumber</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">8</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">theShooter</span><span class="p">.</span><span class="nx">stripesOrSolids</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;solids&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">                        </span><span class="nx">theShooter</span><span class="p">.</span><span class="nx">score</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">15</span><span class="p">;</span>
<span class="w">                        </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">addToIt</span><span class="p">(</span><span class="s1">&#39;\\  solid (&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">puckNumber</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;-ball) pocketed, +15&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;additionalTime_s&#39;</span><span class="o">:</span><span class="mf">2.0</span><span class="p">});</span>
<span class="w">                     </span>
<span class="w">                     </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">puckNumber</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">8</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">theShooter</span><span class="p">.</span><span class="nx">stripesOrSolids</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;stripes&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="nx">theShooter</span><span class="p">.</span><span class="nx">score</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">15</span><span class="p">;</span>
<span class="w">                        </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">addToIt</span><span class="p">(</span><span class="s1">&#39;\\  stripe (&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">puckNumber</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;-ball) pocketed, +15&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;additionalTime_s&#39;</span><span class="o">:</span><span class="mf">2.0</span><span class="p">});</span>
<span class="w">                        </span>
<span class="w">                     </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">puckNumber</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mf">8</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">theShooter</span><span class="p">.</span><span class="nx">stripesOrSolids</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;table is open&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                           </span><span class="nx">theShooter</span><span class="p">.</span><span class="nx">score</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">10</span><span class="p">;</span>
<span class="w">                           </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">addToIt</span><span class="p">(</span><span class="s1">&#39;\\  &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">puckNumber</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;-ball pocketed, table open, +10&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;additionalTime_s&#39;</span><span class="o">:</span><span class="mf">2.0</span><span class="p">});</span>
<span class="w">                        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                           </span><span class="nx">theShooter</span><span class="p">.</span><span class="nx">score</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">                           </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">addToIt</span><span class="p">(</span><span class="s1">&#39;\\  &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">puckNumber</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;-ball pocketed, but not in your group, +0&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;additionalTime_s&#39;</span><span class="o">:</span><span class="mf">2.0</span><span class="p">});</span>
<span class="w">                        </span><span class="p">}</span>
<span class="w">                     </span><span class="p">}</span>
<span class="w">                  </span><span class="c1">// 9-ball and rotation</span>
<span class="w">                  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                     </span><span class="nx">theShooter</span><span class="p">.</span><span class="nx">score</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">15</span><span class="p">;</span>
<span class="w">                     </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">addToIt</span><span class="p">(</span><span class="s1">&#39;\\  &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">puckNumber</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;-ball pocketed, +15&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;additionalTime_s&#39;</span><span class="o">:</span><span class="mf">2.0</span><span class="p">});</span>
<span class="w">                     </span>
<span class="w">                     </span><span class="c1">// simple rotation, the win is near...</span>
<span class="w">                     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoVersion</span><span class="p">().</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;rotation&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">theShooter</span><span class="p">.</span><span class="nx">pocketedBallCount</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">7</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">addToIt</span><span class="p">(</span><span class="s2">&quot;\\ \\  seven balls have been pocketed without fouls, need one more for the win...&quot;</span><span class="p">);</span>
<span class="w">                     </span><span class="p">}</span>
<span class="w">                  </span><span class="p">}</span>
<span class="w">                  </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="w"> </span><span class="nx">theShooter</span><span class="p">.</span><span class="nx">nameString</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39; score = &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">theShooter</span><span class="p">.</span><span class="nx">score</span><span class="p">,</span><span class="w"> </span><span class="mf">10.0</span><span class="p">);</span>
<span class="w">               </span><span class="p">}</span>
<span class="w">            </span>
<span class="w">               </span><span class="c1">// This ball went in while table was open (in 8-ball game), and so establishes stripes or solids.</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoVersion</span><span class="p">().</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;8ball&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">theShooter</span><span class="p">.</span><span class="nx">stripesOrSolids</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;table is open&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">m_poolGameShotCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">puckNumber</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">8</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                     </span><span class="nx">theShooter</span><span class="p">.</span><span class="nx">stripesOrSolids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;solids&quot;</span><span class="p">;</span>
<span class="w">                     </span><span class="c1">// Set all other clients to be stripes</span>
<span class="w">                     </span><span class="nx">cT</span><span class="p">.</span><span class="nx">Client</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">theShooter</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">stripesOrSolids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;stripes&#39;</span><span class="p">});</span>
<span class="w">                     </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;gameTitle&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="w"> </span><span class="nx">theShooter</span><span class="p">.</span><span class="nx">nameString</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot; has &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">theShooter</span><span class="p">.</span><span class="nx">stripesOrSolids</span><span class="p">,</span><span class="w"> </span><span class="mf">2.0</span><span class="p">);</span>
<span class="w">                     </span>
<span class="w">                  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">puckNumber</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">8</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                     </span><span class="nx">theShooter</span><span class="p">.</span><span class="nx">stripesOrSolids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;stripes&quot;</span><span class="p">;</span>
<span class="w">                     </span><span class="nx">cT</span><span class="p">.</span><span class="nx">Client</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">theShooter</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">stripesOrSolids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;solids&#39;</span><span class="p">});</span>
<span class="w">                     </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;gameTitle&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="w"> </span><span class="nx">theShooter</span><span class="p">.</span><span class="nx">nameString</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot; has &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">theShooter</span><span class="p">.</span><span class="nx">stripesOrSolids</span><span class="p">,</span><span class="w"> </span><span class="mf">2.0</span><span class="p">);</span>
<span class="w">                     </span>
<span class="w">                  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                     </span><span class="nx">poolGameExit</span><span class="p">(</span><span class="s2">&quot;\\  8-ball pocketed while table is open&quot;</span><span class="p">);</span>
<span class="w">                  </span><span class="p">}</span>
<span class="w">               </span><span class="p">}</span>
<span class="w">               </span>
<span class="w">               </span><span class="c1">// Check for can&#39;t-win condition in simple rotation</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoVersion</span><span class="p">().</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;rotation&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="kd">var</span><span class="w"> </span><span class="nx">enoughBallsForAWin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">                  </span><span class="nx">cT</span><span class="p">.</span><span class="nx">Client</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">                     </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">client</span><span class="p">.</span><span class="nx">pocketedBallCount</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">puckMap</span><span class="p">).</span><span class="nx">length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">))</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">8</span><span class="p">)</span><span class="w"> </span><span class="nx">enoughBallsForAWin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">;</span>
<span class="w">                  </span><span class="p">});</span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">enoughBallsForAWin</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                     </span><span class="nx">poolGameExit</span><span class="p">(</span><span class="s2">&quot;\\  not enough balls left for any player to get to 8&quot;</span><span class="p">);</span>
<span class="w">                  </span><span class="p">}</span>
<span class="w">               </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">// Add this &quot;looks like a win, but wait&quot; string to the &quot;ball goes in message&quot;.</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">moreHelp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoVersion</span><span class="p">().</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;9ball&#39;</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">puck</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;puck9&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">moreHelp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;\\ \\  that was the 9 (the money) ball, wait for the scratch check...&quot;</span><span class="p">;</span>
<span class="w">               </span><span class="nx">m_poolWinType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;9-ball&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoVersion</span><span class="p">().</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;8ball&#39;</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">puck</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;puck8&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">moreHelp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;\\ \\  that was the 8 (the money) ball, wait for the scratch check...&quot;</span><span class="p">;</span>
<span class="w">               </span><span class="nx">m_poolWinType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;8-ball&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="c1">// for simple rotation, 8 balls pocketed</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoVersion</span><span class="p">().</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;rotation&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">theShooter</span><span class="p">.</span><span class="nx">pocketedBallCount</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">8</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">moreHelp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;\\ \\  that was the eighth ball pocketed, wait for the scratch check...&quot;</span><span class="p">;</span>
<span class="w">               </span><span class="nx">m_poolWinType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;rotation&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="c1">// No point in giving the additional help if the remaining balls quickly come to rest and a win is declared.</span>
<span class="w">            </span><span class="c1">// So wait 0.900 seconds and then check to to see if the game is over before adding the moreHelp string.</span>
<span class="w">            </span><span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">m_poolGameOver</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">moreHelp</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">                  </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">addToIt</span><span class="p">(</span><span class="w"> </span><span class="nx">moreHelp</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;additionalTime_s&#39;</span><span class="o">:</span><span class="mf">2.0</span><span class="p">});</span>
<span class="w">               </span><span class="p">}</span>
<span class="w">            </span><span class="p">},</span><span class="w"> </span><span class="mf">900</span><span class="p">);</span>
<span class="w">            </span>
<span class="w">            </span><span class="nx">puck</span><span class="p">.</span><span class="nx">deleteThisOne</span><span class="p">({});</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">// Now, after the deletion, find the new low ball on the table.</span>
<span class="w">            </span><span class="c1">// 9-ball and simple rotation require a low-ball object ball. Help the user find this ball with a finder circle.</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoVersion</span><span class="p">().</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;8ball&#39;</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">m_poolGameOver</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">m_lowPuckName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">findLowPuck</span><span class="p">();</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="nx">m_lowPuckName</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">m_poolWinType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;no win yet&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="c1">// Start displaying the finder circle</span>
<span class="w">                  </span><span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">puckMap</span><span class="p">[</span><span class="w"> </span><span class="nx">m_lowPuckName</span><span class="p">].</span><span class="nx">lowBallFinderCircle_timer_s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">               </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">                        </span>
<span class="w">         </span><span class="c1">// cue ball pocketed </span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// still some other balls left on table</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">puckMap</span><span class="p">).</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">m_poolGameOver</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="c1">// Penalty for scratching</span>
<span class="w">                  </span><span class="nx">theShooter</span><span class="p">.</span><span class="nx">scratchedDuringGame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">                  </span><span class="nx">theShooter</span><span class="p">.</span><span class="nx">score</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mf">20</span><span class="p">;</span>
<span class="w">                  </span><span class="c1">//gW.messages[&#39;gameTitle&#39;].newMessage(&quot;scratch&quot;, 2.0);</span>
<span class="w">               </span><span class="p">}</span>
<span class="w">               </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">addToIt</span><span class="p">(</span><span class="s1">&#39;\\  scratch, cue ball has been spotted&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;additionalTime_s&#39;</span><span class="o">:</span><span class="mf">2.0</span><span class="p">});</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">m_poolGameOver</span><span class="p">)</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">addToIt</span><span class="p">(</span><span class="s1">&#39;, -20&#39;</span><span class="p">);</span><span class="w"> </span><span class="c1">// score not important if shooting after the game...</span>
<span class="w">               </span><span class="c1">// Spot the cue ball</span>
<span class="w">               </span><span class="nx">puck</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">SetPosition</span><span class="p">(</span><span class="w"> </span><span class="nx">m_cueBallSpot_2d_m</span><span class="p">);</span>
<span class="w">               </span><span class="nx">puck</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">SetLinearVelocity</span><span class="p">(</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">));</span>
<span class="w">               </span><span class="nx">puck</span><span class="p">.</span><span class="nx">spotted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">               </span>
<span class="w">            </span><span class="c1">// cue ball was last ball on table, game over...</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">puckMap</span><span class="p">).</span><span class="nx">length</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">m_poolGameOver</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">poolGameExit</span><span class="p">(</span><span class="s2">&quot;\\  scratch on last shot&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">// In case the user still has their cursor-spring connected to the cue ball.</span>
<span class="w">            </span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">modifyCursorSpring</span><span class="p">(</span><span class="s1">&#39;detach&#39;</span><span class="p">);</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">checkPoolGameState</span><span class="p">(</span><span class="w"> </span><span class="nx">drawingContext</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">m_poolTimer_gameDuration_s</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">getDeltaT_s</span><span class="p">();</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// wait for the timer</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">m_poolTimer_stateCheck_s</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">m_poolTimer_stateCheckLimit_s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">m_poolTimer_stateCheck_s</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">getDeltaT_s</span><span class="p">();</span>
<span class="w">         </span>
<span class="w">      </span><span class="c1">// times up, run the checks</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">theShooter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="w"> </span><span class="nx">m_mostRecentPoolShooter</span><span class="p">];</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// Ball speed is checked in checkPoolBallState.</span>
<span class="w">         </span><span class="nx">m_allPucksStopped</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">         </span><span class="nx">cP</span><span class="p">.</span><span class="nx">Puck</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span><span class="w"> </span><span class="nx">puck</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// determine when balls go into pockets</span>
<span class="w">            </span><span class="nx">checkPoolBallState</span><span class="p">(</span><span class="w"> </span><span class="nx">puck</span><span class="p">);</span>
<span class="w">         </span><span class="p">});</span>
<span class="w">         </span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">m_allPucksStopped</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">cT</span><span class="p">.</span><span class="nx">Client</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">resetPathAfterShot</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="p">);</span>
<span class="w">            </span><span class="p">});</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// Must either pocket a ball or hit a cushion</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">m_poolGameShotCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">m_cushionCollisionPenaltyGiven</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">m_allPucksStopped</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">m_readyForFirstCueBallCollision</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">theShooter</span><span class="p">.</span><span class="nx">score</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mf">10</span><span class="p">;</span>
<span class="w">               </span><span class="nx">theShooter</span><span class="p">.</span><span class="nx">safetyShotFoulDuringGame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">               </span><span class="nx">m_cushionCollisionPenaltyGiven</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">m_poolGameOver</span><span class="p">)</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">addToIt</span><span class="p">(</span><span class="s1">&#39;\\  no contact with object ball, -10&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;additionalTime_s&#39;</span><span class="o">:</span><span class="mf">2.0</span><span class="p">});</span>
<span class="w">               </span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">m_nonCueBallPocketed</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">m_cushionCollision</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">theShooter</span><span class="p">.</span><span class="nx">score</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mf">10</span><span class="p">;</span>
<span class="w">               </span><span class="nx">theShooter</span><span class="p">.</span><span class="nx">safetyShotFoulDuringGame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">               </span><span class="nx">m_cushionCollisionPenaltyGiven</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">m_poolGameOver</span><span class="p">)</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">addToIt</span><span class="p">(</span><span class="s1">&#39;\\  nothing pocketed and no collision with a cushion, -10&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;additionalTime_s&#39;</span><span class="o">:</span><span class="mf">2.0</span><span class="p">});</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// If money-ball has been pocketed, report the win (or money-ball foul).</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">m_allPucksStopped</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">puckMap</span><span class="p">[</span><span class="s1">&#39;puck0&#39;</span><span class="p">])</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">puckMap</span><span class="p">[</span><span class="s1">&#39;puck0&#39;</span><span class="p">].</span><span class="nx">spotted</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="p">(</span><span class="nx">m_poolWinType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;no win yet&quot;</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">cT</span><span class="p">.</span><span class="nx">Client</span><span class="p">.</span><span class="nx">winnerBonusGiven</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">m_poolGameOver</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">m_objectBallFoul</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                     </span><span class="nx">poolGameExit</span><span class="p">(</span><span class="s2">&quot;\\ \\  object-ball foul on money-ball shot&quot;</span><span class="p">);</span>
<span class="w">               </span>
<span class="w">               </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">m_poolWinType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;8-ball&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">theShooter</span><span class="p">.</span><span class="nx">stripesOrSolids</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;table is open&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                     </span><span class="nx">poolGameExit</span><span class="p">(</span><span class="s2">&quot;\\ \\  foul, money-ball pocketed while table is open&quot;</span><span class="p">);</span>
<span class="w">                  </span>
<span class="w">                  </span><span class="c1">// Check for not-empty-group foul (a combo shot at the end will trigger this without an object-ball foul)</span>
<span class="w">                  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">countStripesAndSolids</span><span class="p">()[</span><span class="w"> </span><span class="nx">theShooter</span><span class="p">.</span><span class="nx">stripesOrSolids</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                     </span><span class="nx">poolGameExit</span><span class="p">(</span><span class="s2">&quot;\\ \\  foul, money-ball pocketed before pocketing all the &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">theShooter</span><span class="p">.</span><span class="nx">stripesOrSolids</span><span class="p">);</span>
<span class="w">                        </span>
<span class="w">                  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                     </span><span class="nx">reportPoolWin</span><span class="p">(</span><span class="s2">&quot;8-ball win&quot;</span><span class="p">);</span>
<span class="w">                  </span><span class="p">}</span>
<span class="w">                  </span>
<span class="w">               </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">m_poolWinType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;rotation&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="nx">reportPoolWin</span><span class="p">(</span><span class="s2">&quot;simple-rotation win&quot;</span><span class="p">);</span>
<span class="w">                           </span>
<span class="w">               </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">m_poolWinType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;9-ball&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="nx">reportPoolWin</span><span class="p">(</span><span class="s2">&quot;9-ball win&quot;</span><span class="p">);</span>
<span class="w">               </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">               </span>
<span class="w">         </span><span class="c1">// Must have scratched on money-ball shot...</span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="nx">m_allPucksStopped</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="p">(</span><span class="nx">m_poolWinType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;no win yet&quot;</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">m_poolGameOver</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">puckMap</span><span class="p">[</span><span class="s1">&#39;puck0&#39;</span><span class="p">].</span><span class="nx">spotted</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">poolGameExit</span><span class="p">(</span><span class="s2">&quot;\\ \\  scratched on money-ball shot&quot;</span><span class="p">);</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">         </span>
<span class="w">         </span><span class="nx">m_poolTimer_stateCheck_s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// While the game is still underway, keep updating the score.</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">m_poolGameOver</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">theShooter</span><span class="p">)</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="w"> </span><span class="nx">theShooter</span><span class="p">.</span><span class="nx">nameString</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39; score = &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">theShooter</span><span class="p">.</span><span class="nx">score</span><span class="p">,</span><span class="w"> </span><span class="mf">10.0</span><span class="p">);</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">processCueBallFirstCollision</span><span class="p">(</span><span class="w"> </span><span class="nx">puck_A</span><span class="p">,</span><span class="w"> </span><span class="nx">puck_B</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">((</span><span class="nx">puck_A</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;puck0&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="nx">puck_B</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;puck0&quot;</span><span class="p">))</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">m_readyForFirstCueBallCollision</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">theShooter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="w"> </span><span class="nx">m_mostRecentPoolShooter</span><span class="p">];</span>
<span class="w">         </span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">puck_A</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;puck0&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">cueBall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">puck_A</span><span class="p">,</span><span class="w"> </span><span class="nx">objectBall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">puck_B</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">cueBall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">puck_B</span><span class="p">,</span><span class="w"> </span><span class="nx">objectBall</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">puck_A</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// low-ball check in 9-ball and rotation (if readyForFirstPoolBallCollision)</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoVersion</span><span class="p">().</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;9ball&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoVersion</span><span class="p">().</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;rotation&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w">  </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">objectBall</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">m_lowPuckName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">theShooter</span><span class="p">.</span><span class="nx">score</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mf">10</span><span class="p">;</span>
<span class="w">               </span><span class="nx">theShooter</span><span class="p">.</span><span class="nx">objectBallFoulDuringGame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">               </span><span class="nx">m_objectBallFoul</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">m_poolGameOver</span><span class="p">)</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">addToIt</span><span class="p">(</span><span class="s1">&#39;\\  must hit low ball, -10&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;additionalTime_s&#39;</span><span class="o">:</span><span class="mf">2.0</span><span class="p">});</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">         </span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoVersion</span><span class="p">().</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;8ball&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">objectBallNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">parseFloat</span><span class="p">(</span><span class="w"> </span><span class="nx">objectBall</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">4</span><span class="p">));</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">// stripes or solids check in 8-ball</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">objectBallNumber</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">8</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">theShooter</span><span class="p">.</span><span class="nx">stripesOrSolids</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;stripes&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">theShooter</span><span class="p">.</span><span class="nx">score</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mf">10</span><span class="p">;</span>
<span class="w">               </span><span class="nx">theShooter</span><span class="p">.</span><span class="nx">objectBallFoulDuringGame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">               </span><span class="nx">m_objectBallFoul</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">m_poolGameOver</span><span class="p">)</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">addToIt</span><span class="p">(</span><span class="s1">&#39;\\  must hit a stripe first, -10&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;additionalTime_s&#39;</span><span class="o">:</span><span class="mf">2.0</span><span class="p">});</span>
<span class="w">               </span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">objectBallNumber</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">8</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">theShooter</span><span class="p">.</span><span class="nx">stripesOrSolids</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;solids&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">theShooter</span><span class="p">.</span><span class="nx">score</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mf">10</span><span class="p">;</span>
<span class="w">               </span><span class="nx">theShooter</span><span class="p">.</span><span class="nx">objectBallFoulDuringGame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">               </span><span class="nx">m_objectBallFoul</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">m_poolGameOver</span><span class="p">)</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">addToIt</span><span class="p">(</span><span class="s1">&#39;\\  must hit a solid first, -10&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;additionalTime_s&#39;</span><span class="o">:</span><span class="mf">2.0</span><span class="p">});</span>
<span class="w">               </span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="nx">objectBallNumber</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">8</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">m_poolGameOver</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="p">(</span><span class="nx">theShooter</span><span class="p">.</span><span class="nx">stripesOrSolids</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;table is open&quot;</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="kd">var</span><span class="w"> </span><span class="nx">eightBallGame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">countStripesAndSolids</span><span class="p">();</span>
<span class="w">               </span><span class="c1">// If the player still has some balls in his group on the table, warn when shooting at the 8-ball.</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">eightBallGame</span><span class="p">[</span><span class="w"> </span><span class="nx">theShooter</span><span class="p">.</span><span class="nx">stripesOrSolids</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="nx">theShooter</span><span class="p">.</span><span class="nx">score</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mf">10</span><span class="p">;</span>
<span class="w">                  </span><span class="nx">theShooter</span><span class="p">.</span><span class="nx">objectBallFoulDuringGame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">                  </span><span class="nx">m_objectBallFoul</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">                  </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">addToIt</span><span class="p">(</span><span class="s2">&quot;\\  must pocket all &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">theShooter</span><span class="p">.</span><span class="nx">stripesOrSolids</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot; before using the 8 as an object ball (unless table is open), -10&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;additionalTime_s&#39;</span><span class="o">:</span><span class="mf">2.0</span><span class="p">});</span>
<span class="w">               </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="c1">// Must hit first ball in the rack on the break.</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">m_poolGameShotCount</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">objectBall</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s2">&quot;puck1&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">theShooter</span><span class="p">.</span><span class="nx">score</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mf">10</span><span class="p">;</span>
<span class="w">               </span><span class="nx">theShooter</span><span class="p">.</span><span class="nx">objectBallFoulDuringGame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">               </span><span class="nx">m_objectBallFoul</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">m_poolGameOver</span><span class="p">)</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">addToIt</span><span class="p">(</span><span class="s1">&#39;\\  must hit the first ball in the rack on break, -20&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;additionalTime_s&#39;</span><span class="o">:</span><span class="mf">2.0</span><span class="p">});</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">         </span><span class="nx">m_readyForFirstCueBallCollision</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">contactNormals</span><span class="p">(</span><span class="w"> </span><span class="nx">mode</span><span class="p">,</span><span class="w"> </span><span class="nx">contact</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">body_A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">tableMap</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="w"> </span><span class="nx">contact</span><span class="p">.</span><span class="nx">GetFixtureA</span><span class="p">().</span><span class="nx">GetBody</span><span class="p">());</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">body_B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">tableMap</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="w"> </span><span class="nx">contact</span><span class="p">.</span><span class="nx">GetFixtureB</span><span class="p">().</span><span class="nx">GetBody</span><span class="p">());</span>
<span class="w">      </span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">body_A</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">body_B</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;preSolve&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">            </span><span class="c1">// ghost puck sensor event associated with client cursor (also see drawGhostBall)</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">body_A</span><span class="p">.</span><span class="kr">constructor</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;Client&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="nx">body_B</span><span class="p">.</span><span class="kr">constructor</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;Client&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">body_A</span><span class="p">.</span><span class="kr">constructor</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;Client&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="kd">var</span><span class="w"> </span><span class="nx">clientTarget</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">body_B</span><span class="p">,</span><span class="w"> </span><span class="nx">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">body_A</span><span class="p">;</span><span class="w"> </span>
<span class="w">               </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="kd">var</span><span class="w"> </span><span class="nx">clientTarget</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">body_A</span><span class="p">,</span><span class="w"> </span><span class="nx">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">body_B</span><span class="p">;</span>
<span class="w">               </span><span class="p">}</span>
<span class="w">               </span><span class="c1">// Ignore contact between the sensor (the ghost) and the source puck (selected by client).</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">clientTarget</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">name</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="kd">var</span><span class="w"> </span><span class="nx">worldManifold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">b2DW</span><span class="p">.</span><span class="nx">WorldManifold</span><span class="p">();</span>
<span class="w">                  </span><span class="nx">contact</span><span class="p">.</span><span class="nx">GetWorldManifold</span><span class="p">(</span><span class="w"> </span><span class="nx">worldManifold</span><span class="p">);</span>
<span class="w">                  </span>
<span class="w">                  </span><span class="kd">var</span><span class="w"> </span><span class="nx">wM_normal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">({},</span><span class="w"> </span><span class="nx">worldManifold</span><span class="p">.</span><span class="nx">m_normal</span><span class="p">);</span>
<span class="w">                  </span><span class="kd">var</span><span class="w"> </span><span class="nx">wM_points</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">({},</span><span class="w"> </span><span class="nx">worldManifold</span><span class="p">.</span><span class="nx">m_points</span><span class="p">);</span>
<span class="w">                  </span><span class="nx">client</span><span class="p">.</span><span class="nx">sensorContact</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;normal_2d&#39;</span><span class="o">:</span><span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D_from_b2Vec2</span><span class="p">(</span><span class="w"> </span><span class="nx">wM_normal</span><span class="p">),</span><span class="s1">&#39;points_2d_m&#39;</span><span class="o">:</span><span class="nx">wM_points</span><span class="p">};</span>
<span class="w">               </span><span class="p">}</span>
<span class="w">               </span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">clientTarget</span><span class="p">.</span><span class="kr">constructor</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;Wall&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="c1">// Note: since walls don&#39;t move in response to collisions, get identical wall behavior, if disabled (false).</span>
<span class="w">                  </span><span class="nx">contact</span><span class="p">.</span><span class="nx">SetEnabled</span><span class="p">(</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<span class="w">               </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="c1">// For all other targets (pucks and pins), disable any collision response with the ghost puck.</span>
<span class="w">                  </span><span class="nx">contact</span><span class="p">.</span><span class="nx">SetEnabled</span><span class="p">(</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span>
<span class="w">               </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span><span class="w">   </span>
<span class="w">            </span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;endContact&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">body_A</span><span class="p">.</span><span class="kr">constructor</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;Client&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="nx">body_B</span><span class="p">.</span><span class="kr">constructor</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;Client&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">body_A</span><span class="p">.</span><span class="kr">constructor</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;Client&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="kd">var</span><span class="w"> </span><span class="nx">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">body_A</span><span class="p">,</span><span class="w"> </span><span class="nx">clientTarget</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">body_B</span><span class="p">;</span>
<span class="w">               </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="kd">var</span><span class="w"> </span><span class="nx">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">body_B</span><span class="p">,</span><span class="w"> </span><span class="nx">clientTarget</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">body_A</span><span class="p">;</span>
<span class="w">               </span><span class="p">}</span>
<span class="w">               </span>
<span class="w">               </span><span class="c1">// ignore contact between ghost and selected puck (also see drawGhostBall)</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">clientTarget</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">name</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">sensorTargetName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">clientTarget</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                     </span><span class="nx">client</span><span class="p">.</span><span class="nx">sensorTargetName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">                     </span><span class="nx">client</span><span class="p">.</span><span class="nx">sensorContact</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">                  </span><span class="p">}</span>
<span class="w">               </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span><span class="w">      </span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">poolGameExit</span><span class="p">(</span><span class="w"> </span><span class="nx">helpMessage</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">m_poolGameOver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">theShooter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="w"> </span><span class="nx">m_mostRecentPoolShooter</span><span class="p">];</span>
<span class="w">      </span><span class="nx">theShooter</span><span class="p">.</span><span class="nx">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">      </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">].</span><span class="nx">resetMessage</span><span class="p">();</span>
<span class="w">      </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">addToIt</span><span class="p">(</span><span class="w"> </span><span class="nx">helpMessage</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;additionalTime&#39;</span><span class="o">:</span><span class="mf">3.0</span><span class="p">});</span>
<span class="w">      </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">addToIt</span><span class="p">(</span><span class="s2">&quot;\\ \\  game over\\ \\  thanks for playing...&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;additionalTime&#39;</span><span class="o">:</span><span class="mf">3.0</span><span class="p">});</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Position the game-over announcement below (at a higher y value than) the last line of the help message.</span>
<span class="w">      </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;gameTitle&#39;</span><span class="p">].</span><span class="nx">loc_px</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">yMax_px</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;gameTitle&#39;</span><span class="p">].</span><span class="nx">lineHeight_px</span><span class="p">;</span>
<span class="w">      </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;gameTitle&#39;</span><span class="p">].</span><span class="nx">setFont</span><span class="p">(</span><span class="s1">&#39;30px Arial&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">theSeries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="mf">1</span><span class="o">:</span><span class="p">{</span><span class="s1">&#39;tL_s&#39;</span><span class="o">:</span><span class="mf">2.5</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;message&#39;</span><span class="o">:</span><span class="s2">&quot;that was almost a win...&quot;</span><span class="p">},</span>
<span class="w">         </span><span class="mf">2</span><span class="o">:</span><span class="p">{</span><span class="s1">&#39;tL_s&#39;</span><span class="o">:</span><span class="mf">2.5</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;message&#39;</span><span class="o">:</span><span class="s2">&quot;it&#39;s a little smoky in this pool hall...&quot;</span><span class="p">},</span>
<span class="w">         </span><span class="mf">3</span><span class="o">:</span><span class="p">{</span><span class="s1">&#39;tL_s&#39;</span><span class="o">:</span><span class="mf">2.5</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;message&#39;</span><span class="o">:</span><span class="s2">&quot;maybe open a window...&quot;</span><span class="p">},</span>
<span class="w">         </span><span class="mf">4</span><span class="o">:</span><span class="p">{</span><span class="s1">&#39;tL_s&#39;</span><span class="o">:</span><span class="mf">2.5</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;message&#39;</span><span class="o">:</span><span class="s2">&quot;and try again...&quot;</span><span class="p">},</span>
<span class="w">         </span><span class="mf">5</span><span class="o">:</span><span class="p">{</span><span class="s1">&#39;tL_s&#39;</span><span class="o">:</span><span class="mf">3.0</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;message&#39;</span><span class="o">:</span><span class="s2">&quot;press the 3 key \\  to restart from the keyboard...&quot;</span><span class="p">},</span>
<span class="w">         </span><span class="mf">6</span><span class="o">:</span><span class="p">{</span><span class="s1">&#39;tL_s&#39;</span><span class="o">:</span><span class="mf">3.0</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;message&#39;</span><span class="o">:</span><span class="s2">&quot;from a [base,orange]cell phone[base], \\  do a four-finger touch to restart.&quot;</span><span class="p">}};</span>
<span class="w">      </span><span class="c1">//gW.messages[&#39;gameTitle&#39;].newMessage(&quot;thanks for playing&quot;, 5.0);</span>
<span class="w">      </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;gameTitle&#39;</span><span class="p">].</span><span class="nx">newMessageSeries</span><span class="p">(</span><span class="w"> </span><span class="nx">theSeries</span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">reportPoolWin</span><span class="p">(</span><span class="w"> </span><span class="nx">winMessage</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// calculate bonuses and report to leader-board </span>
<span class="w">      </span><span class="nx">cT</span><span class="p">.</span><span class="nx">Client</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">         </span><span class="nx">client</span><span class="p">.</span><span class="nx">mouseUsage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"> </span><span class="c1">// always using the mouse, so this ding doesn&#39;t apply for the pool game.</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// Report for each client score except the local player when the player control is unchecked.</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="p">((</span><span class="nx">client</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;local&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">checked</span><span class="p">))</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">// first, add special bonuses to the winner&#39;s score</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">m_mostRecentPoolShooter</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="c1">// Bonus for money-ball shot</span>
<span class="w">               </span><span class="nx">client</span><span class="p">.</span><span class="nx">score</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">50</span><span class="p">;</span>
<span class="w">               </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">addToIt</span><span class="p">(</span><span class="w"> </span><span class="s2">&quot;\\ \\  a winning shot, +50&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;additionalTime&#39;</span><span class="o">:</span><span class="mf">2.0</span><span class="p">});</span>
<span class="w">               </span>
<span class="w">               </span><span class="c1">// Bonus for low-shot count of winning player. Usually a reward for an early money-ball shot. Note that this also rewards you for winning after</span>
<span class="w">               </span><span class="c1">// your opponent pockets balls (a bonus for shot delegation). Only rewarded if no scratches by the winner. This doesn&#39;t apply well to 8-ball</span>
<span class="w">               </span><span class="c1">// because you must pocket all balls in your group before doing a money-ball shot. However, 8-ball does have the usual 5-point charge per shot</span>
<span class="w">               </span><span class="c1">// to indirectly motivate efficient shooting.</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">m_poolWinType</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s2">&quot;8-ball&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="c1">// typical shot count needed to win game = non-cue ball count</span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoVersion</span><span class="p">().</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;rotation&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                     </span><span class="c1">// Simple rotation really needs a full rack to play as intended, so fix the target at 8.</span>
<span class="w">                     </span><span class="kd">var</span><span class="w"> </span><span class="nx">nominalShotsNeeded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">8</span><span class="p">;</span>
<span class="w">                  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                     </span><span class="c1">// Use this equation to accommodate custom 9-ball racks (with fewer than 9 balls).</span>
<span class="w">                     </span><span class="kd">var</span><span class="w"> </span><span class="nx">nominalShotsNeeded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">m_nonCueBallsAtStart</span><span class="p">;</span>
<span class="w">                  </span><span class="p">}</span>
<span class="w">                  </span><span class="kd">var</span><span class="w"> </span><span class="nx">nBallBonus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">nominalShotsNeeded</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">poolShotCount</span><span class="p">;</span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">scratchedDuringGame</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">nBallBonus</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                     </span><span class="kd">var</span><span class="w"> </span><span class="nx">lowShotCountPointBonus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">nBallBonus</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">5</span><span class="p">;</span>
<span class="w">                     </span><span class="nx">client</span><span class="p">.</span><span class="nx">score</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">lowShotCountPointBonus</span><span class="p">;</span>
<span class="w">                     </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">addToIt</span><span class="p">(</span><span class="w"> </span><span class="s2">&quot;\\ \\  bonus of &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">nBallBonus</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot; balls (5pts/ball) for low-shot-count (&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">poolShotCount</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;) win and no scratch, +&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">                        </span><span class="nx">lowShotCountPointBonus</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;additionalTime&#39;</span><span class="o">:</span><span class="mf">2.0</span><span class="p">});</span>
<span class="w">                  </span><span class="p">}</span>
<span class="w">               </span><span class="p">}</span>
<span class="w">               </span>
<span class="w">               </span><span class="c1">// Bonus for clean game</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">scratchedDuringGame</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">objectBallFoulDuringGame</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">safetyShotFoulDuringGame</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">mouseStopFoulDuringGame</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">                   </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">poolShotCount</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">5</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">m_poolTimer_gameDuration_s</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">60.0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="nx">client</span><span class="p">.</span><span class="nx">score</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">50</span><span class="p">;</span>
<span class="w">                  </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">addToIt</span><span class="p">(</span><span class="w"> </span><span class="s2">&quot;\\ \\  bonus for clean game (five shots or more) with no fouls or scratches, +50&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;additionalTime&#39;</span><span class="o">:</span><span class="mf">2.0</span><span class="p">});</span>
<span class="w">               </span><span class="p">}</span>
<span class="w">               </span>
<span class="w">               </span><span class="c1">// encourage nickname usage</span>
<span class="w">               </span><span class="nx">client</span><span class="p">.</span><span class="nx">winCount</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">client</span><span class="p">.</span><span class="nx">winCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">nickName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">addToIt</span><span class="p">(</span><span class="w"> </span><span class="s2">&quot;\\ \\  (-:  try using a nickname  :-)&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;additionalTime&#39;</span><span class="o">:</span><span class="mf">0.0</span><span class="p">});</span>
<span class="w">               </span><span class="p">}</span>
<span class="w">               </span>
<span class="w">               </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">nameString</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39; score = &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">score</span><span class="p">,</span><span class="w"> </span><span class="mf">10.0</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">// report for each player</span>
<span class="w">            </span><span class="nx">client</span><span class="p">.</span><span class="nx">addScoreToSummary</span><span class="p">(</span><span class="w"> </span><span class="nx">m_poolTimer_gameDuration_s</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mf">2</span><span class="p">),</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoIndex</span><span class="p">(),</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">      </span>
<span class="w">      </span><span class="nx">lB</span><span class="p">.</span><span class="nx">reportGameResults</span><span class="p">();</span>
<span class="w">      </span><span class="c1">// Send a score for each human player to the leader-board. Build leader-board report at the end.</span>
<span class="w">      </span><span class="nx">lB</span><span class="p">.</span><span class="nx">submitScoresThenReport</span><span class="p">();</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Open up the multi-player panel so you can see the leader-board report.</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">multiplayer</span><span class="p">.</span><span class="nx">checked</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">         </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#chkMultiplayer&#39;</span><span class="p">).</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="nx">cT</span><span class="p">.</span><span class="nx">Client</span><span class="p">.</span><span class="nx">winnerBonusGiven</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">      </span><span class="nx">m_poolGameOver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">      </span>
<span class="w">      </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">addToIt</span><span class="p">(</span><span class="s2">&quot;\\ \\  thanks for playing&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;additionalTime&#39;</span><span class="o">:</span><span class="mf">3.0</span><span class="p">});</span>
<span class="w">      </span><span class="c1">// Position the game-over announcement below (at a higher y value than) the last line of the help message.</span>
<span class="w">      </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;gameTitle&#39;</span><span class="p">].</span><span class="nx">loc_px</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">yMax_px</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;gameTitle&#39;</span><span class="p">].</span><span class="nx">lineHeight_px</span><span class="p">;</span>
<span class="w">      </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;gameTitle&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="w"> </span><span class="nx">winMessage</span><span class="p">,</span><span class="w"> </span><span class="mf">5.0</span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">tripleTap</span><span class="p">(</span><span class="w"> </span><span class="nx">ts</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">();</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">timesince</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">now</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">ts</span><span class="p">.</span><span class="nx">previousTapTime</span><span class="p">;</span>
<span class="w">      </span><span class="nx">ts</span><span class="p">.</span><span class="nx">previousTapTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">now</span><span class="p">;</span>
<span class="w">      </span><span class="c1">// A good short tap interval</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">timesince</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">timesince</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">300</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">ts</span><span class="p">.</span><span class="nx">tapCount</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">         </span><span class="c1">// That&#39;s a triple.</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">ts</span><span class="p">.</span><span class="nx">tapCount</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">ts</span><span class="p">.</span><span class="nx">tapCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">         </span><span class="c1">// Nice double, but not a triple.</span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">      </span><span class="c1">// Too much time has passed, so reset.</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">ts</span><span class="p">.</span><span class="nx">tapCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">         </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">interpretTouches</span><span class="p">(</span><span class="w"> </span><span class="nx">e</span><span class="p">,</span><span class="w"> </span><span class="nx">pars</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{})</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// These are primitives, not mutable.</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">startOrEnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span><span class="w"> </span><span class="nx">pars</span><span class="p">.</span><span class="nx">startOrEnd</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">hostOrClient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span><span class="w"> </span><span class="nx">pars</span><span class="p">.</span><span class="nx">hostOrClient</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">demoVersionOnHost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span><span class="w"> </span><span class="nx">pars</span><span class="p">.</span><span class="nx">demoVersionOnHost</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">fromListener</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span><span class="w"> </span><span class="nx">pars</span><span class="p">.</span><span class="nx">fromListener</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// The following are references to mutable objects outside of interpretTouches. So, for example, </span>
<span class="w">      </span><span class="c1">// changes here to mK and cl affect mK and cl outside of this function.</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">mK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span><span class="w"> </span><span class="nx">pars</span><span class="p">.</span><span class="nx">mK</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">cl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span><span class="w"> </span><span class="nx">pars</span><span class="p">.</span><span class="nx">cl</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">ts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span><span class="w"> </span><span class="nx">pars</span><span class="p">.</span><span class="nx">ts</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">raw_2d_px</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span><span class="w"> </span><span class="nx">pars</span><span class="p">.</span><span class="nx">raw_2d_px</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">socket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span><span class="w"> </span><span class="nx">pars</span><span class="p">.</span><span class="nx">socket</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>
<span class="w">      </span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">demoIndexOnHost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">demoVersionOnHost</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">1</span><span class="p">);</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">demoBase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">demoVersionOnHost</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">3</span><span class="p">);</span>
<span class="w">      </span><span class="cm">/*</span>
<span class="cm">      let debugString = &quot;startOrEnd=&quot; + startOrEnd + &quot;, hostOrClient=&quot; + hostOrClient + &#39;, fromListener=&#39; + fromListener + &#39;, touch length=&#39; + e.touches.length;</span>
<span class="cm">      if (fromListener != &#39;touchmove&#39;) {</span>
<span class="cm">         hC.sendSocketControlMessage( {&#39;from&#39;:&#39;anyone&#39;, &#39;to&#39;:&#39;host&#39;, &#39;data&#39;:{&#39;androidDebug&#39;:{&#39;value&#39;:true,&#39;debugString&#39;:debugString}} } );</span>
<span class="cm">      }</span>
<span class="cm">      */</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">startOrEnd</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;start&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="cm">/* </span>
<span class="cm">         if ((e.touches.length == 1) &amp;&amp; (fromListener != &#39;touchmove&#39;)) {</span>
<span class="cm">            // An alternate approach to using touches.length is to use the identifier parameter:</span>
<span class="cm">            // Save the first touch id. This is needed to interpret Firefox touch ids because they keep incrementing. For Chrome this first touch id is</span>
<span class="cm">            // always 0 (zero). So simply subtracting this from any raw touch id gives the needed relative touch id (for both Chrome and Firefox): 0, 1, 2, 3...</span>
<span class="cm">            ts.firstTouchPointID = e.touches[0].identifier;</span>
<span class="cm">         }</span>
<span class="cm">         var touchIndex = e.changedTouches[0].identifier - ts.firstTouchPointID;  // the relative touch id: 0,1,2,3...</span>
<span class="cm">         */</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// Create a lock to prevent position changes when 4 or more touches (restarting pool game from touch screen).</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">touches</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">4</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">ts</span><span class="p">.</span><span class="nx">fourOrMore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">         </span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">inputDevice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;touchScreen&quot;</span><span class="p">;</span>
<span class="w">         </span><span class="c1">// Use the length of the touches array instead of the identifier parameter...</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">touchIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">touches</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// Toggle ball-in-hand state when triple-tap the first touch point. This is like holding</span>
<span class="w">         </span><span class="c1">// down the control key when using a keyboard.</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="nx">fromListener</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;touchmove&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">touchIndex</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nx">tripleTap</span><span class="p">(</span><span class="w"> </span><span class="nx">ts</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hostOrClient</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;client&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">mK</span><span class="p">[</span><span class="s1">&#39;ct&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;D&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                     </span><span class="nx">mK</span><span class="p">[</span><span class="s1">&#39;ct&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;U&#39;</span><span class="p">;</span>
<span class="w">                  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                     </span><span class="nx">mK</span><span class="p">[</span><span class="s1">&#39;ct&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;D&#39;</span><span class="p">;</span>
<span class="w">                  </span><span class="p">}</span>
<span class="w">               </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hostOrClient</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;host&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">cl</span><span class="p">.</span><span class="nx">key_ctrl</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;D&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                     </span><span class="nx">cl</span><span class="p">.</span><span class="nx">key_ctrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;U&#39;</span><span class="p">;</span>
<span class="w">                     </span><span class="nx">eV</span><span class="p">.</span><span class="nx">key_ctrl_handler</span><span class="p">(</span><span class="s1">&#39;keyup&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">cl</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
<span class="w">                  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                     </span><span class="nx">cl</span><span class="p">.</span><span class="nx">key_ctrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;D&#39;</span><span class="p">;</span>
<span class="w">                     </span><span class="nx">eV</span><span class="p">.</span><span class="nx">key_ctrl_handler</span><span class="p">(</span><span class="s1">&#39;keydown&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">cl</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
<span class="w">                  </span><span class="p">}</span>
<span class="w">               </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// First touch started: do nothing here, handled elsewhere...</span>
<span class="w">         </span><span class="c1">// (note: cue ball shoots when the first touch point is lifted)</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">touchIndex</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// Second touch point: </span>
<span class="w">         </span><span class="c1">// If playing playing Ghost Ball, lock in a new value for cue-ball speed via the z-key. </span>
<span class="w">         </span><span class="c1">// If playing projectile games, toggle fine-moves via the b-key.</span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">touchIndex</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">2</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">fromListener</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;touchmove&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hostOrClient</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;client&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">demoBase</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;3.d&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="nx">mK</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;D&#39;</span><span class="p">;</span>
<span class="w">               </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">([</span><span class="s1">&#39;4.e&#39;</span><span class="p">,</span><span class="s1">&#39;5.e&#39;</span><span class="p">].</span><span class="nx">includes</span><span class="p">(</span><span class="w"> </span><span class="nx">demoBase</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="nx">mK</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;D&#39;</span><span class="p">;</span>
<span class="w">               </span><span class="p">}</span><span class="w"> </span>
<span class="w">               </span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hostOrClient</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;host&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">demoBase</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;3.d&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">cl</span><span class="p">.</span><span class="nx">key_z</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;U&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                     </span><span class="nx">togglePoolShotLock</span><span class="p">(</span><span class="w"> </span><span class="nx">cl</span><span class="p">);</span>
<span class="w">                     </span><span class="nx">cl</span><span class="p">.</span><span class="nx">key_z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;D&#39;</span><span class="p">;</span>
<span class="w">                  </span><span class="p">}</span>
<span class="w">               </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">([</span><span class="s1">&#39;4.e&#39;</span><span class="p">,</span><span class="s1">&#39;5.e&#39;</span><span class="p">].</span><span class="nx">includes</span><span class="p">(</span><span class="w"> </span><span class="nx">demoBase</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="nx">eV</span><span class="p">.</span><span class="nx">key_b_handler</span><span class="p">(</span><span class="s1">&#39;local&#39;</span><span class="p">);</span>
<span class="w">               </span><span class="p">}</span><span class="w">   </span>
<span class="w">            </span><span class="p">}</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// Third touch: useful mainly for Bipartisan Hoops, so you can do a ball-in-hand maneuver to get vertical orientation for a bank shot.</span>
<span class="w">         </span><span class="c1">// Works best if 2nd and 3rd touch are done together, toggling between COM and non-COM ball-in-hand.</span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">touchIndex</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">3</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">fromListener</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;touchmove&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">demoVersionOnHost</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;basketball&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hostOrClient</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;client&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="c1">// Reverse the &quot;b&quot; toggle issued in touchIndex 2, on the way to this touchIndex 3.</span>
<span class="w">                  </span><span class="nx">mK</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;U&#39;</span><span class="p">;</span>
<span class="w">                  </span><span class="nx">eVN</span><span class="p">.</span><span class="nx">handle_sending_mK_data</span><span class="p">(</span><span class="w"> </span><span class="nx">mK</span><span class="p">);</span>
<span class="w">                  </span><span class="nx">mK</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;D&#39;</span><span class="p">;</span>
<span class="w">                  </span><span class="nx">eVN</span><span class="p">.</span><span class="nx">handle_sending_mK_data</span><span class="p">(</span><span class="w"> </span><span class="nx">mK</span><span class="p">);</span>
<span class="w">                  </span>
<span class="w">                  </span><span class="nx">mK</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;D&#39;</span><span class="p">;</span>
<span class="w">                  </span><span class="nx">mK</span><span class="p">[</span><span class="s1">&#39;ct&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;D&#39;</span><span class="p">;</span>
<span class="w">                  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;inside touches 3&quot;</span><span class="p">);</span>
<span class="w">                  </span>
<span class="w">               </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hostOrClient</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;host&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="c1">// Reverse the &quot;b&quot; toggle...</span>
<span class="w">                  </span><span class="nx">eV</span><span class="p">.</span><span class="nx">key_b_handler</span><span class="p">(</span><span class="s1">&#39;local&#39;</span><span class="p">);</span>
<span class="w">                  </span>
<span class="w">                  </span><span class="nx">eV</span><span class="p">.</span><span class="nx">key_c_handler</span><span class="p">(</span><span class="s1">&#39;local&#39;</span><span class="p">);</span>
<span class="w">                  </span><span class="nx">cl</span><span class="p">.</span><span class="nx">key_ctrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;D&#39;</span><span class="p">;</span>
<span class="w">                  </span><span class="nx">eV</span><span class="p">.</span><span class="nx">key_ctrl_handler</span><span class="p">(</span><span class="s1">&#39;keydown&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;local&#39;</span><span class="p">);</span>
<span class="w">               </span><span class="p">}</span><span class="w">  </span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span>
<span class="w">         </span><span class="c1">// Forth touch: restart the pool game (e.g. demoIndexOnHost would be the 3 key if playing Ghost Ball)</span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">touchIndex</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">4</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hostOrClient</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;client&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">mK</span><span class="p">[</span><span class="w"> </span><span class="nx">demoIndexOnHost</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;D&#39;</span><span class="p">;</span>
<span class="w">               </span><span class="nx">mK</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;U&#39;</span><span class="p">;</span>
<span class="w">               </span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">hostOrClient</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;host&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">fromListener</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;touchmove&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">dS</span><span class="p">.</span><span class="nx">demoStart</span><span class="p">(</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoIndex</span><span class="p">());</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// Only consider the first touch point for establishing cursor position.</span>
<span class="w">         </span><span class="nx">raw_2d_px</span><span class="p">.</span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">touches</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">clientX</span><span class="p">;</span>
<span class="w">         </span><span class="nx">raw_2d_px</span><span class="p">.</span><span class="nx">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">touches</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">clientY</span><span class="p">;</span>
<span class="w">         </span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">startOrEnd</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;end&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="c1">// Make touchIndex correspond to the start block above.</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">touchIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">touches</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// Reset the 4-touch position lock if get down to 0 touch points.</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">touches</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">ts</span><span class="p">.</span><span class="nx">fourOrMore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// If the first touch point has been lifted: SHOOT the cue ball</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">touchIndex</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hostOrClient</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;client&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">mK</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;U&#39;</span><span class="p">;</span>
<span class="w">               </span><span class="nx">mK</span><span class="p">[</span><span class="s1">&#39;3&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;U&#39;</span><span class="p">;</span>
<span class="w">               </span><span class="nx">mK</span><span class="p">.</span><span class="nx">MD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"> </span><span class="c1">// shoot it</span>
<span class="w">               </span>
<span class="w">               </span><span class="c1">// The touchScreenUsage_sendCounter value is reset to zero on page load and also a normal re-connect with the client connect button.</span>
<span class="w">               </span><span class="c1">// (The &quot;chat message&quot; here, or ones similar, like sendSocketControlMessage with androidDebug, can be useful in debugging from the cell phone.)</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nx">hC</span><span class="p">.</span><span class="nx">gb</span><span class="p">.</span><span class="nx">touchScreenUsage_sendCounter</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;chat message&#39;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;touch screen in use&quot;</span><span class="p">);</span>
<span class="w">                  </span><span class="nx">hC</span><span class="p">.</span><span class="nx">gb</span><span class="p">.</span><span class="nx">touchScreenUsage_sendCounter</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">               </span><span class="p">}</span>
<span class="w">               </span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hostOrClient</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;host&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">cl</span><span class="p">.</span><span class="nx">mouseDown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// reset the z (or b) key</span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">touchIndex</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hostOrClient</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;client&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">demoBase</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;3.d&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="nx">mK</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;U&#39;</span><span class="p">;</span>
<span class="w">                  </span><span class="nx">mK</span><span class="p">.</span><span class="nx">MD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;T&#39;</span><span class="p">;</span><span class="w"> </span><span class="c1">// T for touch, keep the mouse button down, don&#39;t shoot</span>
<span class="w">               </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">([</span><span class="s1">&#39;4.e&#39;</span><span class="p">,</span><span class="s1">&#39;5.e&#39;</span><span class="p">].</span><span class="nx">includes</span><span class="p">(</span><span class="w"> </span><span class="nx">demoBase</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="nx">mK</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;U&#39;</span><span class="p">;</span>
<span class="w">                  </span><span class="nx">mK</span><span class="p">.</span><span class="nx">MD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;T&#39;</span><span class="p">;</span>
<span class="w">               </span><span class="p">}</span><span class="w"> </span>
<span class="w">               </span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hostOrClient</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;host&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">demoBase</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;3.d&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="nx">cl</span><span class="p">.</span><span class="nx">key_z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;U&#39;</span><span class="p">;</span>
<span class="w">                  </span><span class="nx">cl</span><span class="p">.</span><span class="nx">mouseDown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;T&#39;</span><span class="p">;</span><span class="w"> </span><span class="c1">// T for touch...</span>
<span class="w">                  </span>
<span class="w">               </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">([</span><span class="s1">&#39;4.e&#39;</span><span class="p">,</span><span class="s1">&#39;5.e&#39;</span><span class="p">].</span><span class="nx">includes</span><span class="p">(</span><span class="w"> </span><span class="nx">demoBase</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="c1">// nothing yet...</span>
<span class="w">               </span><span class="p">}</span><span class="w"> </span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">touchIndex</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">demoVersionOnHost</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;basketball&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hostOrClient</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;client&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="nx">mK</span><span class="p">.</span><span class="nx">MD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;T&#39;</span><span class="p">;</span><span class="w"> </span><span class="c1">// T for touch, keep the mouse button down, don&#39;t shoot</span>
<span class="w">                 </span>
<span class="w">                  </span><span class="nx">mK</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;U&#39;</span><span class="p">;</span>
<span class="w">                  </span><span class="nx">mK</span><span class="p">[</span><span class="s1">&#39;ct&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;U&#39;</span><span class="p">;</span>
<span class="w">               </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hostOrClient</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;host&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="nx">cl</span><span class="p">.</span><span class="nx">key_ctrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;U&#39;</span><span class="p">;</span>
<span class="w">                  </span><span class="nx">eV</span><span class="p">.</span><span class="nx">key_ctrl_handler</span><span class="p">(</span><span class="s1">&#39;keyup&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;local&#39;</span><span class="p">);</span>
<span class="w">               </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span>
<span class="w">         </span><span class="c1">// reset the number key (demoIndexOnHost) so, for example, ready to restart the pool game</span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">touchIndex</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">4</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hostOrClient</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;client&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">mK</span><span class="p">[</span><span class="w"> </span><span class="nx">demoIndexOnHost</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;U&#39;</span><span class="p">;</span>
<span class="w">               </span><span class="nx">mK</span><span class="p">.</span><span class="nx">MD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;T&#39;</span><span class="p">;</span><span class="w"> </span><span class="c1">// T for touch, don&#39;t shoot</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hostOrClient</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;host&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="c1">// nothing yet...</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">         </span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;catch everything else&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="c1">// see comments before the &quot;return&quot; section of gwModule.js</span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Objects</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Variables</span>
<span class="w">      </span><span class="s1">&#39;setCushionCollision&#39;</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">m_cushionCollision</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">val</span><span class="p">;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Methods</span>
<span class="w">      </span><span class="s1">&#39;initializeModule&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">initializeModule</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;resetGame&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">resetGame</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;resetTableHistory&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">resetTableHistory</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;updateGhostBall&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">updateGhostBall</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;drawGhostBall&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">drawGhostBall</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;drawPathAfterShot&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">drawPathAfterShot</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;resetPathAfterShot&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">resetPathAfterShot</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;checkForMouseStops&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">checkForMouseStops</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;checkPoolGameState&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">checkPoolGameState</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;processCueBallFirstCollision&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">processCueBallFirstCollision</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;contactNormals&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">contactNormals</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;togglePoolShotLock&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">togglePoolShotLock</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;updatePoolShotLockedValues&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">updatePoolShotLockedValues</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;toggleProjectileForecast&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">toggleProjectileForecast</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;poolShot&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">poolShot</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;drawPoolBallFeatures&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">drawPoolBallFeatures</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;interpretTouches&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">interpretTouches</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;getTableCapture&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">getTableCapture</span>
<span class="w">   </span><span class="p">};</span>

<span class="p">})();</span>
</pre></div>
</body>
</html>
