<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">
<!--
generated by Pygments <http://pygments.org>
Copyright 2006-2019 by the Pygments team.
Licensed under the BSD license, see LICENSE for details.
-->
<html>
<head>
  <link rel='canonical' href='https://triquence.org/captureRestore.js.html' />
  <title>captureRestore.js</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <style type="text/css">
/*
generated by Pygments <http://pygments.org>
Copyright 2006-2019 by the Pygments team.
Licensed under the BSD license, see LICENSE for details.
*/
td.linenos { background-color: #f0f0f0; padding-right: 10px; }
span.lineno { background-color: #f0f0f0; padding: 0 5px 0 5px; }
pre { line-height: 125%; }
body .hll { background-color: #ffffcc }
body  { background: #f8f8f8; }
body .c { color: #408080; font-style: italic } /* Comment */
body .err { border: 1px solid #FF0000 } /* Error */
body .k { color: #008000; font-weight: bold } /* Keyword */
body .o { color: #666666 } /* Operator */
body .ch { color: #408080; font-style: italic } /* Comment.Hashbang */
body .cm { color: #408080; font-style: italic } /* Comment.Multiline */
body .cp { color: #BC7A00 } /* Comment.Preproc */
body .cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */
body .c1 { color: #408080; font-style: italic } /* Comment.Single */
body .cs { color: #408080; font-style: italic } /* Comment.Special */
body .gd { color: #A00000 } /* Generic.Deleted */
body .ge { font-style: italic } /* Generic.Emph */
body .gr { color: #FF0000 } /* Generic.Error */
body .gh { color: #000080; font-weight: bold } /* Generic.Heading */
body .gi { color: #00A000 } /* Generic.Inserted */
body .go { color: #888888 } /* Generic.Output */
body .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
body .gs { font-weight: bold } /* Generic.Strong */
body .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
body .gt { color: #0044DD } /* Generic.Traceback */
body .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
body .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
body .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
body .kp { color: #008000 } /* Keyword.Pseudo */
body .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
body .kt { color: #B00040 } /* Keyword.Type */
body .m { color: #666666 } /* Literal.Number */
body .s { color: #BA2121 } /* Literal.String */
body .na { color: #7D9029 } /* Name.Attribute */
body .nb { color: #008000 } /* Name.Builtin */
body .nc { color: #0000FF; font-weight: bold } /* Name.Class */
body .no { color: #880000 } /* Name.Constant */
body .nd { color: #AA22FF } /* Name.Decorator */
body .ni { color: #999999; font-weight: bold } /* Name.Entity */
body .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
body .nf { color: #0000FF } /* Name.Function */
body .nl { color: #A0A000 } /* Name.Label */
body .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
body .nt { color: #008000; font-weight: bold } /* Name.Tag */
body .nv { color: #19177C } /* Name.Variable */
body .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
body .w { color: #bbbbbb } /* Text.Whitespace */
body .mb { color: #666666 } /* Literal.Number.Bin */
body .mf { color: #666666 } /* Literal.Number.Float */
body .mh { color: #666666 } /* Literal.Number.Hex */
body .mi { color: #666666 } /* Literal.Number.Integer */
body .mo { color: #666666 } /* Literal.Number.Oct */
body .sa { color: #BA2121 } /* Literal.String.Affix */
body .sb { color: #BA2121 } /* Literal.String.Backtick */
body .sc { color: #BA2121 } /* Literal.String.Char */
body .dl { color: #BA2121 } /* Literal.String.Delimiter */
body .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
body .s2 { color: #BA2121 } /* Literal.String.Double */
body .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
body .sh { color: #BA2121 } /* Literal.String.Heredoc */
body .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
body .sx { color: #008000 } /* Literal.String.Other */
body .sr { color: #BB6688 } /* Literal.String.Regex */
body .s1 { color: #BA2121 } /* Literal.String.Single */
body .ss { color: #19177C } /* Literal.String.Symbol */
body .bp { color: #008000 } /* Name.Builtin.Pseudo */
body .fm { color: #0000FF } /* Name.Function.Magic */
body .vc { color: #19177C } /* Name.Variable.Class */
body .vg { color: #19177C } /* Name.Variable.Global */
body .vi { color: #19177C } /* Name.Variable.Instance */
body .vm { color: #19177C } /* Name.Variable.Magic */
body .il { color: #666666 } /* Literal.Number.Integer.Long */

  </style>
</head>
<body>
<h2></h2>

<div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm">Copyright 2022 James D. Miller</span>

<span class="cm">Permission is hereby granted, free of charge, to any person obtaining a copy</span>
<span class="cm">of this software and associated documentation files (the &quot;Software&quot;), to deal</span>
<span class="cm">in the Software without restriction, including without limitation the rights</span>
<span class="cm">to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
<span class="cm">copies of the Software, and to permit persons to whom the Software is</span>
<span class="cm">furnished to do so, subject to the following conditions:</span>

<span class="cm">The above copyright notice and this permission notice shall be included in all</span>
<span class="cm">copies or substantial portions of the Software.</span>

<span class="cm">THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="cm">IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="cm">FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
<span class="cm">AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<span class="cm">LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span>
<span class="cm">OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="cm">SOFTWARE.</span>
<span class="cm">*/</span>

<span class="c1">// Capture and Restore (cR) module</span>
<span class="c1">// captureRestore.js</span>
   <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;cR _*-*_&#39;</span><span class="p">);</span>
<span class="c1">// 8:35 PM Sun December 10, 2023</span>

<span class="cm">/*</span>
<span class="cm">gwModule.js has an alphabetical list of all modules and their nicknames as added to the windows namespace.</span>
<span class="cm">*/</span>

<span class="cm">/*</span>
<span class="cm">These functions act to save (capture) a concise representation of the system state for later restoration. </span>
<span class="cm">The engine-related state is limited to position and velocity (translational and rotational). No</span>
<span class="cm">attempt is made to capture the collision-related state internal to the Box2D engine.</span>
<span class="cm">*/</span>

<span class="nb">window</span><span class="p">.</span><span class="nx">cR</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
   <span class="s2">&quot;use strict&quot;</span><span class="p">;</span>
   
   <span class="c1">// Names starting with m_ indicate module-scope globals.</span>
   <span class="kd">var</span> <span class="nx">m_fileHandle</span> <span class="o">=</span> <span class="s1">&#39;documents&#39;</span><span class="p">;</span>
   <span class="kd">var</span> <span class="nx">m_cloudCapture</span> <span class="o">=</span> <span class="p">{};</span>
   
   <span class="c1">// module globals for objects brought in by initializeModule</span>
   <span class="kd">var</span> <span class="nx">x_canvas</span><span class="p">,</span> <span class="nx">x_ctx</span><span class="p">;</span>
   
   <span class="c1">///////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
   <span class="c1">///////////////////////////////////////////////////////////////////////////////////////////////////////////////</span>
   
   <span class="kd">function</span> <span class="nx">initializeModule</span><span class="p">(</span> <span class="nx">canvas</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">x_canvas</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">;</span>
      <span class="nx">x_ctx</span> <span class="o">=</span> <span class="nx">ctx</span><span class="p">;</span>
   <span class="p">}</span>
   
   <span class="kd">function</span> <span class="nx">json_scrubber</span><span class="p">(</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="cm">/*</span>
<span class="cm">      Use this function to exclude the b2d objects in the stringify process. </span>
<span class="cm">      Apparently the b2d and rtc objects have circular references that </span>
<span class="cm">      stringify doesn&#39;t like. So have to regenerate the b2d objects in the </span>
<span class="cm">      demo area when the json capture is restored. </span>

<span class="cm">      Also have to avoid the client related addons: jet, gun, and shield. </span>
<span class="cm">      These have references back their pucks, this too causes circular issues </span>
<span class="cm">      for stringify. </span>

<span class="cm">      Also remove keys like spo1 and spo2 (in Springs object) mainly to keep </span>
<span class="cm">      the wordiness down; many keys are not needed in the reconstruction </span>
<span class="cm">      process. </span>

<span class="cm">      So be careful here: any key with a name in the OR list of json_scrubber </span>
<span class="cm">      (see if block below) will be excluded from the capture. </span>
<span class="cm">      */</span>
      <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="nx">key</span> <span class="o">==</span> <span class="s1">&#39;b2d&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">key</span> <span class="o">==</span> <span class="s1">&#39;b2dSensor&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">key</span> <span class="o">==</span> <span class="s1">&#39;rtc&#39;</span><span class="p">)</span> <span class="o">||</span> 
           <span class="p">(</span><span class="nx">key</span> <span class="o">==</span> <span class="s1">&#39;jet&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">key</span> <span class="o">==</span> <span class="s1">&#39;gun&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">key</span> <span class="o">==</span> <span class="s1">&#39;shield&#39;</span><span class="p">)</span> <span class="o">||</span> 
           <span class="p">(</span><span class="nx">key</span> <span class="o">==</span> <span class="s1">&#39;spo1&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">key</span> <span class="o">==</span> <span class="s1">&#39;spo2&#39;</span><span class="p">)</span> <span class="o">||</span> 
           <span class="p">(</span><span class="nx">key</span> <span class="o">==</span> <span class="s1">&#39;jto1&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">key</span> <span class="o">==</span> <span class="s1">&#39;jto2&#39;</span><span class="p">)</span> <span class="o">||</span> 
           <span class="p">(</span><span class="nx">key</span> <span class="o">==</span> <span class="s1">&#39;parsAtBirth&#39;</span><span class="p">)</span> <span class="o">||</span> 
           <span class="p">(</span><span class="nx">key</span> <span class="o">==</span> <span class="s1">&#39;puck&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">key</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;key_&#39;</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="nx">key</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;_scaling&#39;</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="nx">key</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;selectionPoint&#39;</span><span class="p">))</span> <span class="o">||</span> 
           <span class="p">(</span><span class="nx">key</span> <span class="o">==</span> <span class="s1">&#39;position_2d_px&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">key</span> <span class="o">==</span> <span class="s1">&#39;nonCOM_2d_N&#39;</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
         <span class="k">return</span> <span class="kc">undefined</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span>
   
   <span class="kd">function</span> <span class="nx">saveState</span><span class="p">(</span> <span class="nx">pars</span> <span class="o">=</span> <span class="p">{}</span> <span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">captureName</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">captureName</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">dataForCleaning</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">dataForCleaning</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">inhibitWriteToCaptureCell</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">inhibitWriteToCaptureCell</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
      
      <span class="kd">var</span> <span class="nx">timeString</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="nx">dataForCleaning</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">// Use an old capture, that is passed in via dataForCleaning in pars, as the data sources.</span>
         <span class="c1">// (see comment in cleanCapture)</span>
         
         <span class="k">if</span> <span class="p">(</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">].</span><span class="nx">includes</span><span class="p">(</span> <span class="nx">dataForCleaning</span><span class="p">.</span><span class="nx">demoIndex</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">dataForCleaning</span><span class="p">.</span><span class="nx">startingPosAndVels</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">dataForCleaning</span><span class="p">.</span><span class="nx">startingPosAndVels</span> <span class="o">=</span> <span class="nx">dS</span><span class="p">.</span><span class="nx">defaultStartingPosAndVel</span><span class="p">(</span> <span class="nx">dataForCleaning</span><span class="p">.</span><span class="nx">demoVersion</span><span class="p">);</span>
            <span class="p">}</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// remove the key if not in the 7 or 8 demo groups</span>
            <span class="k">delete</span> <span class="nx">dataForCleaning</span><span class="p">.</span><span class="nx">startingPosAndVels</span><span class="p">;</span>
         <span class="p">}</span>
         
         <span class="c1">// Add some canvas dimensions if needed.</span>
         <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="p">(</span><span class="nx">dataForCleaning</span><span class="p">.</span><span class="nx">canvasDimensions</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">dataForCleaning</span><span class="p">.</span><span class="nx">demoIndex</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">dataForCleaning</span><span class="p">.</span><span class="nx">canvasDimensions</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;width&#39;</span><span class="o">:</span><span class="mi">1250</span><span class="p">,</span> <span class="s1">&#39;height&#39;</span><span class="o">:</span><span class="mi">950</span><span class="p">};</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
               <span class="nx">dataForCleaning</span><span class="p">.</span><span class="nx">canvasDimensions</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;width&#39;</span><span class="o">:</span><span class="mi">600</span><span class="p">,</span> <span class="s1">&#39;height&#39;</span><span class="o">:</span><span class="mi">600</span><span class="p">};</span>
            <span class="p">}</span>
         <span class="p">}</span>
       
         <span class="kd">var</span> <span class="nx">tableState</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;demoIndex&#39;</span><span class="o">:</span><span class="nx">dataForCleaning</span><span class="p">.</span><span class="nx">demoIndex</span><span class="p">,</span>
                           <span class="s1">&#39;demoVersion&#39;</span><span class="o">:</span><span class="nx">dataForCleaning</span><span class="p">.</span><span class="nx">demoVersion</span><span class="p">,</span>
                           <span class="s1">&#39;date&#39;</span><span class="o">:</span><span class="nx">timeString</span><span class="p">.</span><span class="nx">toLocaleString</span><span class="p">(),</span>
                           <span class="s1">&#39;canvasDimensions&#39;</span><span class="o">:</span> <span class="p">{</span><span class="s1">&#39;width&#39;</span><span class="o">:</span><span class="nx">dataForCleaning</span><span class="p">.</span><span class="nx">canvasDimensions</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="s1">&#39;height&#39;</span><span class="o">:</span><span class="nx">dataForCleaning</span><span class="p">.</span><span class="nx">canvasDimensions</span><span class="p">.</span><span class="nx">height</span><span class="p">},</span>
                           <span class="s1">&#39;gravity&#39;</span><span class="o">:</span><span class="nx">dataForCleaning</span><span class="p">.</span><span class="nx">gravity</span><span class="p">,</span>
                           <span class="s1">&#39;comSelection&#39;</span><span class="o">:</span><span class="nx">dataForCleaning</span><span class="p">.</span><span class="nx">comSelection</span><span class="p">,</span>
                           <span class="s1">&#39;fullScreenDemo&#39;</span><span class="o">:</span><span class="nx">dataForCleaning</span><span class="p">.</span><span class="nx">fullScreenDemo</span><span class="p">,</span>
                           <span class="s1">&#39;globalCompositeOperation&#39;</span><span class="o">:</span><span class="nx">dataForCleaning</span><span class="p">.</span><span class="nx">globalCompositeOperation</span><span class="p">,</span>
                           <span class="s1">&#39;EpL&#39;</span><span class="o">:</span> <span class="nx">dataForCleaning</span><span class="p">.</span><span class="nx">EpL</span><span class="p">,</span>
                           <span class="s1">&#39;wallMapData&#39;</span><span class="o">:</span><span class="nx">dataForCleaning</span><span class="p">.</span><span class="nx">wallMapData</span><span class="p">,</span> 
                           <span class="s1">&#39;puckMapData&#39;</span><span class="o">:</span><span class="nx">dataForCleaning</span><span class="p">.</span><span class="nx">puckMapData</span><span class="p">,</span> 
                           <span class="s1">&#39;pinMapData&#39;</span><span class="o">:</span><span class="nx">dataForCleaning</span><span class="p">.</span><span class="nx">pinMapData</span><span class="p">,</span> 
                           <span class="s1">&#39;springMapData&#39;</span><span class="o">:</span><span class="nx">dataForCleaning</span><span class="p">.</span><span class="nx">springMapData</span><span class="p">,</span>
                           <span class="s1">&#39;jointMapData&#39;</span><span class="o">:</span><span class="nx">dataForCleaning</span><span class="p">.</span><span class="nx">jointMapData</span><span class="p">,</span>
                           <span class="s1">&#39;startingPosAndVels&#39;</span><span class="o">:</span><span class="nx">dataForCleaning</span><span class="p">.</span><span class="nx">startingPosAndVels</span><span class="p">,</span>
                           <span class="s1">&#39;clients&#39;</span><span class="o">:</span><span class="nx">dataForCleaning</span><span class="p">.</span><span class="nx">clients</span><span class="p">};</span>
                           
         <span class="k">if</span> <span class="p">(</span><span class="nx">dataForCleaning</span><span class="p">.</span><span class="nx">piCalcs</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">tableState</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">({},</span> <span class="nx">tableState</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;piCalcs&#39;</span><span class="o">:</span><span class="nx">dataForCleaning</span><span class="p">.</span><span class="nx">piCalcs</span><span class="p">}</span> <span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">dataForCleaning</span><span class="p">.</span><span class="nx">piEngine</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">tableState</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">({},</span> <span class="nx">tableState</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;piEngine&#39;</span><span class="o">:</span><span class="nx">dataForCleaning</span><span class="p">.</span><span class="nx">piEngine</span><span class="p">}</span> <span class="p">);</span>
            <span class="p">}</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">tableState</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">({},</span> <span class="nx">tableState</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;piCalcs&#39;</span><span class="o">:</span><span class="p">{}}</span> <span class="p">);</span>
         <span class="p">}</span>
      
      <span class="c1">// Get a fresh capture (i.e., using the live stuff as the data source).            </span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">inhibitWriteToCaptureCell</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">captureName</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">gW</span><span class="p">.</span><span class="nx">setDemoVersion</span><span class="p">(</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoVersion</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">captureName</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
               <span class="nx">gW</span><span class="p">.</span><span class="nx">setDemoVersion</span><span class="p">(</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoVersion</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">((</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoIndex</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
               <span class="c1">// Adjust the highlighting in the plus row (there&#39;s no plus row for demo 0)</span>
               <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoVersion</span><span class="p">().</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.a&quot;</span><span class="p">).</span><span class="nx">style</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
               <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoVersion</span><span class="p">().</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)).</span><span class="nx">style</span> <span class="o">=</span> <span class="s1">&#39;color:white; background-color:gray; border-style:solid; border-color:black; border-width:4px 0px 4px 0px&#39;</span><span class="p">;</span>
            <span class="p">}</span>
         <span class="p">}</span>
         
         <span class="c1">// Temporarily turn off the EpL pin to keep it out of the pinMap in the capture. </span>
         <span class="c1">// Then turn the pin back on AFTER tableState gets stringified.</span>
         <span class="c1">// (The pin gets created during restoration if the editor is on. Only need one!)</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">editor</span><span class="p">.</span><span class="nx">checked</span> <span class="o">&amp;&amp;</span> <span class="nx">cP</span><span class="p">.</span><span class="nx">EpL</span><span class="p">.</span><span class="nx">pinName</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">cP</span><span class="p">.</span><span class="nx">EpL</span><span class="p">.</span><span class="nx">deleteEditPin</span><span class="p">();</span>
         <span class="p">}</span>
         
         <span class="kd">var</span> <span class="nx">tableState</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;demoIndex&#39;</span><span class="o">:</span><span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoIndex</span><span class="p">(),</span>
                           <span class="s1">&#39;demoVersion&#39;</span><span class="o">:</span><span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoVersion</span><span class="p">(),</span>
                           <span class="s1">&#39;date&#39;</span><span class="o">:</span><span class="nx">timeString</span><span class="p">.</span><span class="nx">toLocaleString</span><span class="p">(),</span>
                           <span class="s1">&#39;capturedAtFrame&#39;</span><span class="o">:</span><span class="nx">gW</span><span class="p">.</span><span class="nx">getFrameCount</span><span class="p">(),</span>
                           <span class="s1">&#39;canvasDimensions&#39;</span><span class="o">:</span> <span class="p">{</span><span class="s1">&#39;width&#39;</span><span class="o">:</span><span class="nx">x_canvas</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="s1">&#39;height&#39;</span><span class="o">:</span><span class="nx">x_canvas</span><span class="p">.</span><span class="nx">height</span><span class="p">},</span>
                           <span class="s1">&#39;gravity&#39;</span><span class="o">:</span><span class="nx">gW</span><span class="p">.</span><span class="nx">getG_ON</span><span class="p">(),</span>
                           <span class="s1">&#39;comSelection&#39;</span><span class="o">:</span><span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">comSelection</span><span class="p">.</span><span class="nx">checked</span><span class="p">,</span>
                           <span class="s1">&#39;fullScreenDemo&#39;</span><span class="o">:</span><span class="nx">gW</span><span class="p">.</span><span class="nx">getFullScreenDemo</span><span class="p">(),</span>
                           <span class="s1">&#39;globalCompositeOperation&#39;</span><span class="o">:</span><span class="nx">x_ctx</span><span class="p">.</span><span class="nx">globalCompositeOperation</span><span class="p">,</span>
                           <span class="s1">&#39;EpL&#39;</span><span class="o">:</span> <span class="p">{</span><span class="s1">&#39;display&#39;</span><span class="o">:</span><span class="nx">cP</span><span class="p">.</span><span class="nx">EpL</span><span class="p">.</span><span class="nx">displayReport</span><span class="p">,</span> <span class="s1">&#39;reportType&#39;</span><span class="o">:</span><span class="nx">cP</span><span class="p">.</span><span class="nx">EpL</span><span class="p">.</span><span class="nx">reportType</span><span class="p">,</span> <span class="s1">&#39;COM&#39;</span><span class="o">:</span><span class="nx">cP</span><span class="p">.</span><span class="nx">EpL</span><span class="p">.</span><span class="nx">COM</span><span class="p">,</span> <span class="s1">&#39;angularAxis_2d_m&#39;</span><span class="o">:</span><span class="nx">cP</span><span class="p">.</span><span class="nx">EpL</span><span class="p">.</span><span class="nx">angularAxis_2d_m</span><span class="p">},</span>
                           <span class="s1">&#39;wallMapData&#39;</span><span class="o">:</span><span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">wallMap</span><span class="p">,</span> 
                           <span class="s1">&#39;puckMapData&#39;</span><span class="o">:</span><span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">puckMap</span><span class="p">,</span> 
                           <span class="s1">&#39;pinMapData&#39;</span><span class="o">:</span><span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">pinMap</span><span class="p">,</span> 
                           <span class="s1">&#39;springMapData&#39;</span><span class="o">:</span><span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">springMap</span><span class="p">,</span>
                           <span class="s1">&#39;jointMapData&#39;</span><span class="o">:</span><span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">jointMap</span><span class="p">,</span>
                           <span class="s1">&#39;startingPosAndVels&#39;</span><span class="o">:</span><span class="nx">cT</span><span class="p">.</span><span class="nx">Client</span><span class="p">.</span><span class="nx">startingPandV</span><span class="p">,</span>
                           <span class="s1">&#39;clients&#39;</span><span class="o">:</span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">};</span>
         
         <span class="c1">// For demos using the pi-calc engine, add the engine state to the capture.</span>
         <span class="k">if</span> <span class="p">(</span> <span class="p">[</span><span class="s1">&#39;1.c&#39;</span><span class="p">,</span><span class="s1">&#39;1.d&#39;</span><span class="p">,</span><span class="s1">&#39;1.e&#39;</span><span class="p">].</span><span class="nx">includes</span><span class="p">(</span> <span class="nx">dS</span><span class="p">.</span><span class="nx">demoVersionBase</span><span class="p">(</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoVersion</span><span class="p">()))</span> <span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">piCalcs</span> <span class="o">=</span> <span class="p">{};</span>
            <span class="nx">piCalcs</span><span class="p">[</span><span class="s1">&#39;clacks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">getPiCalcs</span><span class="p">().</span><span class="nx">clacks</span><span class="p">;</span>
            <span class="nx">piCalcs</span><span class="p">[</span><span class="s1">&#39;enabled&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">getPiCalcs</span><span class="p">().</span><span class="nx">enabled</span><span class="p">;</span>
            <span class="nx">piCalcs</span><span class="p">[</span><span class="s1">&#39;usePiEngine&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">getPiCalcs</span><span class="p">().</span><span class="nx">usePiEngine</span><span class="p">;</span>
            
            <span class="kd">let</span> <span class="nx">engineStateSubset</span> <span class="o">=</span> <span class="p">{};</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">piCalcs</span><span class="p">[</span><span class="s1">&#39;usePiEngine&#39;</span><span class="p">])</span> <span class="p">{</span>
               <span class="kd">let</span> <span class="nx">piEngineState</span> <span class="o">=</span> <span class="nx">pE</span><span class="p">.</span><span class="nx">currentState</span><span class="p">();</span>
               
               <span class="nx">engineStateSubset</span><span class="p">[</span><span class="s1">&#39;lastCollidedWithWall&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="nx">piEngineState</span><span class="p">[</span><span class="s1">&#39;lastCollidedWithWall&#39;</span><span class="p">];</span>
               <span class="nx">engineStateSubset</span><span class="p">[</span><span class="s1">&#39;atLeastOneCollisionInFrame&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">piEngineState</span><span class="p">[</span><span class="s1">&#39;atLeastOneCollisionInFrame&#39;</span><span class="p">];</span>
               <span class="nx">engineStateSubset</span><span class="p">[</span><span class="s1">&#39;nFinerTimeStepFactor&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="nx">piEngineState</span><span class="p">[</span><span class="s1">&#39;nFinerTimeStepFactor&#39;</span><span class="p">];</span>               
               
               <span class="nx">piCalcs</span><span class="p">[</span><span class="s1">&#39;p1_v_max&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="nx">piEngineState</span><span class="p">[</span><span class="s1">&#39;p1_v_max&#39;</span><span class="p">];</span>
               <span class="nx">piCalcs</span><span class="p">[</span><span class="s1">&#39;collisionCount&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">piEngineState</span><span class="p">[</span><span class="s1">&#39;collisionCount&#39;</span><span class="p">];</span>
               
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
               <span class="nx">piCalcs</span><span class="p">[</span><span class="s1">&#39;p1_v_max&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">puckMap</span><span class="p">[</span><span class="s1">&#39;puck1&#39;</span><span class="p">].</span><span class="nx">vmax</span><span class="p">;</span>
               <span class="nx">piCalcs</span><span class="p">[</span><span class="s1">&#39;collisionCount&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">collisionCount</span><span class="p">;</span>
            <span class="p">}</span>
            
            <span class="nx">tableState</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span> <span class="p">{},</span> <span class="nx">tableState</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;piCalcs&#39;</span><span class="o">:</span><span class="nx">piCalcs</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;piEngine&#39;</span><span class="o">:</span><span class="nx">engineStateSubset</span><span class="p">}</span> <span class="p">);</span>
         <span class="p">}</span>
      
         <span class="c1">// Here you still have full state info. That&#39;s because this is before the json_scrubber is called. So if you want to keep</span>
         <span class="c1">// something that&#39;s about to be scrubbed out, do it here. As an example: the angle of the NPC casting rays,</span>
         <span class="c1">// that are in the gun attributes. This can be put into the rayCast_init_deg attribute of the NPC&#39;s puck. Then it</span>
         <span class="c1">// will be used when the NPC&#39;s puck and gun are restored (the gun gets this from its puck).</span>
         <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">p_key</span> <span class="k">in</span> <span class="nx">tableState</span><span class="p">.</span><span class="nx">puckMapData</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">puck</span> <span class="o">=</span> <span class="nx">tableState</span><span class="p">.</span><span class="nx">puckMapData</span><span class="p">[</span> <span class="nx">p_key</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">((</span><span class="nx">puck</span><span class="p">.</span><span class="nx">clientName</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">puck</span><span class="p">.</span><span class="nx">clientName</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;NPC&#39;</span><span class="p">))</span> <span class="p">{</span>
               <span class="nx">puck</span><span class="p">.</span><span class="nx">rayCast_init_deg</span> <span class="o">=</span> <span class="nx">puck</span><span class="p">.</span><span class="nx">gun</span><span class="p">.</span><span class="nx">rayCastLine_2d_m</span><span class="p">.</span><span class="nx">get_angle</span><span class="p">();</span>
            <span class="p">}</span>
         <span class="p">}</span>
      <span class="p">}</span>
      
      <span class="c1">// See comments in the json_scrubber function above.</span>
      <span class="kd">var</span> <span class="nx">table_JSON</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span> <span class="nx">tableState</span><span class="p">,</span> <span class="nx">json_scrubber</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
      
      <span class="c1">// Parsing after JSON.stringify makes a deep copy, with no references back to the original objects (and no reference to their methods).</span>
      <span class="c1">// So, can delete stuff without mangling the current running demo.</span>
      <span class="kd">var</span> <span class="nx">tableState_copy</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span> <span class="nx">table_JSON</span><span class="p">);</span>
      
      <span class="c1">// Turn EpL pin back on AFTER the JSON string has been made.</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">editor</span><span class="p">.</span><span class="nx">checked</span> <span class="o">&amp;&amp;</span> <span class="nx">cP</span><span class="p">.</span><span class="nx">EpL</span><span class="p">.</span><span class="nx">displayReport</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">cP</span><span class="p">.</span><span class="nx">EpL</span><span class="p">.</span><span class="nx">createEditPin</span><span class="p">();</span>
      <span class="p">}</span>
      
      <span class="c1">// Remove some non-editable puck keys from all pucks.</span>
      <span class="kd">var</span> <span class="nx">generalPuckKeys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;age_ms&#39;</span><span class="p">,</span><span class="s1">&#39;ageLimit_ms&#39;</span><span class="p">,</span><span class="s1">&#39;radius_px&#39;</span><span class="p">,</span><span class="s1">&#39;mass_kg&#39;</span><span class="p">,</span><span class="s1">&#39;inertia_kgm2&#39;</span><span class="p">,</span><span class="s1">&#39;half_height_px&#39;</span><span class="p">,</span><span class="s1">&#39;half_width_px&#39;</span><span class="p">,</span><span class="s1">&#39;tempInhibitExtForce&#39;</span><span class="p">,</span><span class="s1">&#39;spotted&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;lowBallFinderCircle_timerLimit_s&#39;</span><span class="p">,</span><span class="s1">&#39;lowBallFinderCircle_timer_s&#39;</span><span class="p">,</span><span class="s1">&#39;firstClientDirectMove&#39;</span><span class="p">,</span><span class="s1">&#39;nameTip_timerLimit_s&#39;</span><span class="p">,</span><span class="s1">&#39;nameTip_timer_s&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;sprDamp_force_2d_N&#39;</span><span class="p">,</span><span class="s1">&#39;springOnly_force_2d_N&#39;</span><span class="p">,</span><span class="s1">&#39;jet_force_2d_N&#39;</span><span class="p">,</span><span class="s1">&#39;impulse_2d_Ns&#39;</span><span class="p">,</span><span class="s1">&#39;navSpringOnly_force_2d_N&#39;</span><span class="p">,</span><span class="s1">&#39;drawDuringPE&#39;</span><span class="p">,</span>
                             
                             <span class="s1">&#39;poorHealthFraction&#39;</span><span class="p">,</span><span class="s1">&#39;whoShotBullet&#39;</span><span class="p">,</span><span class="s1">&#39;flash&#39;</span><span class="p">,</span><span class="s1">&#39;inComing&#39;</span><span class="p">,</span><span class="s1">&#39;flashCount&#39;</span><span class="p">,</span><span class="s1">&#39;atLeastOneHit&#39;</span><span class="p">,</span><span class="s1">&#39;stayOn&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;hitCount&#39;</span><span class="p">,</span><span class="s1">&#39;deleted&#39;</span><span class="p">,</span><span class="s1">&#39;clientNameOfShooter&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;bulletAgeLimit_ms&#39;</span> <span class="c1">// this is a client attribute now</span>
                             <span class="p">];</span>
                             
      <span class="c1">// Remove these from pucks with no client controls.</span>
      <span class="kd">var</span> <span class="nx">simplePuckKeys</span> <span class="o">=</span>  <span class="p">[</span><span class="s1">&#39;disableJet&#39;</span><span class="p">,</span><span class="s1">&#39;noRecoil&#39;</span><span class="p">,</span><span class="s1">&#39;bullet_restitution&#39;</span><span class="p">,</span><span class="s1">&#39;hitLimit&#39;</span><span class="p">,</span><span class="s1">&#39;cannibalize&#39;</span><span class="p">];</span>
      
      <span class="c1">// Remove these from the tail of any puck.</span>
      <span class="kd">var</span> <span class="nx">puckTailKeys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;firstPoint_2d_m&#39;</span><span class="p">,</span><span class="s1">&#39;initial_radius_m&#39;</span><span class="p">,</span><span class="s1">&#39;values&#39;</span><span class="p">,</span><span class="s1">&#39;markerPingTimer_s&#39;</span><span class="p">,</span><span class="s1">&#39;pingColor&#39;</span><span class="p">];</span>
      
      <span class="c1">// Remove these from clients depending on whether NPC or Human</span>
      <span class="kd">var</span> <span class="nx">NPC_clientPuckKeys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;angleLine&#39;</span><span class="p">];</span>
      <span class="kd">var</span> <span class="nx">nonNPC_puckKeys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;disableJet&#39;</span><span class="p">,</span><span class="s1">&#39;rayCast_init_deg&#39;</span><span class="p">,</span><span class="s1">&#39;rayRotationRate_dps&#39;</span><span class="p">,</span><span class="s1">&#39;rayCastLineLength_m&#39;</span><span class="p">];</span>
      
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">p_key</span> <span class="k">in</span> <span class="nx">tableState_copy</span><span class="p">.</span><span class="nx">puckMapData</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">var</span> <span class="nx">puck</span> <span class="o">=</span> <span class="nx">tableState_copy</span><span class="p">.</span><span class="nx">puckMapData</span><span class="p">[</span> <span class="nx">p_key</span><span class="p">];</span>
         
         <span class="c1">// Turning off the machSwitch causes the puck to be restored to the captured velocity rather than a specified Mach value.</span>
         <span class="k">if</span> <span class="p">((</span><span class="nx">puck</span><span class="p">.</span><span class="nx">tail</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">dataForCleaning</span><span class="p">))</span> <span class="nx">puck</span><span class="p">.</span><span class="nx">tail</span><span class="p">.</span><span class="nx">machSwitch</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
         
         <span class="c1">// Delete gun bullets and network-client pucks in Puck Popper captures</span>
         <span class="k">if</span> <span class="p">((</span><span class="nx">tableState_copy</span><span class="p">.</span><span class="nx">demoIndex</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">tableState_copy</span><span class="p">.</span><span class="nx">demoIndex</span> <span class="o">==</span> <span class="mi">8</span><span class="p">))</span> <span class="p">{</span>
            <span class="kd">let</span> <span class="nx">gunBullet</span> <span class="o">=</span> <span class="nx">puck</span><span class="p">.</span><span class="nx">bullet</span> <span class="o">&amp;&amp;</span> <span class="nx">puck</span><span class="p">.</span><span class="nx">ageLimit_ms</span><span class="p">;</span> <span class="c1">// the gunBullet puck method is not available here</span>
            <span class="k">if</span> <span class="p">(</span> <span class="nx">gunBullet</span> <span class="o">||</span> <span class="p">((</span><span class="nx">puck</span><span class="p">.</span><span class="nx">clientName</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">puck</span><span class="p">.</span><span class="nx">clientName</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;u&#39;</span><span class="p">))</span> <span class="p">)</span> <span class="p">{</span>
               <span class="k">delete</span> <span class="nx">tableState_copy</span><span class="p">.</span><span class="nx">puckMapData</span><span class="p">[</span> <span class="nx">p_key</span><span class="p">];</span>
               <span class="k">continue</span><span class="p">;</span> <span class="c1">// go directly to next key in this for loop</span>
            <span class="p">}</span> 
         <span class="p">}</span>
         
         <span class="c1">// Delete keys on pucks:</span>
         
         <span class="c1">// all pucks</span>
         <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">generalPuckKeys</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">delete</span> <span class="nx">puck</span><span class="p">[</span> <span class="nx">key</span><span class="p">];</span>
         <span class="p">}</span>
         <span class="c1">// simple pucks (no client controls)</span>
         <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">puck</span><span class="p">.</span><span class="nx">clientName</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">simplePuckKeys</span><span class="p">)</span> <span class="p">{</span>
               <span class="k">delete</span> <span class="nx">puck</span><span class="p">[</span> <span class="nx">key</span><span class="p">];</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">nonNPC_puckKeys</span><span class="p">)</span> <span class="p">{</span>
               <span class="k">delete</span> <span class="nx">puck</span><span class="p">[</span> <span class="nx">key</span><span class="p">];</span>
            <span class="p">}</span>
         <span class="c1">// client pucks</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// all non-NPC client pucks</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">puck</span><span class="p">.</span><span class="nx">clientName</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;NPC&#39;</span><span class="p">)</span> <span class="p">{</span>
               <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">nonNPC_puckKeys</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">delete</span> <span class="nx">puck</span><span class="p">[</span> <span class="nx">key</span><span class="p">];</span>
               <span class="p">}</span>
            <span class="p">}</span> 
            <span class="c1">// all NPC client pucks</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">puck</span><span class="p">.</span><span class="nx">clientName</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;NPC&#39;</span><span class="p">)</span> <span class="p">{</span>
               <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">NPC_clientPuckKeys</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">delete</span> <span class="nx">puck</span><span class="p">[</span> <span class="nx">key</span><span class="p">];</span>
               <span class="p">}</span>
            <span class="p">}</span>
         <span class="p">}</span>
         <span class="c1">// tail parameters</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">puck</span><span class="p">.</span><span class="nx">tail</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">puckTailKeys</span><span class="p">)</span> <span class="p">{</span>
               <span class="k">delete</span> <span class="nx">puck</span><span class="p">.</span><span class="nx">tail</span><span class="p">[</span> <span class="nx">key</span><span class="p">];</span>
            <span class="p">}</span>
         <span class="p">}</span>
      <span class="p">}</span>
      
      <span class="c1">// Remove some non-editable pin keys.  </span>
      <span class="kd">var</span> <span class="nx">pinKeys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;radius_m&#39;</span><span class="p">];</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">pin_key</span> <span class="k">in</span> <span class="nx">tableState_copy</span><span class="p">.</span><span class="nx">pinMapData</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">var</span> <span class="nx">pin</span> <span class="o">=</span> <span class="nx">tableState_copy</span><span class="p">.</span><span class="nx">pinMapData</span><span class="p">[</span> <span class="nx">pin_key</span><span class="p">];</span>
         <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">pinKeys</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">delete</span> <span class="nx">pin</span><span class="p">[</span> <span class="nx">key</span><span class="p">];</span>
         <span class="p">}</span>
      <span class="p">}</span>
      
      <span class="c1">// Remove some non-editable wall keys.</span>
      <span class="kd">var</span> <span class="nx">wallKeys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;deleted&#39;</span><span class="p">,</span><span class="s1">&#39;half_height_px&#39;</span><span class="p">,</span><span class="s1">&#39;half_width_px&#39;</span><span class="p">,</span><span class="s1">&#39;firstClientDirectMove&#39;</span><span class="p">];</span>  <span class="c1">// color</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">wall_key</span> <span class="k">in</span> <span class="nx">tableState_copy</span><span class="p">.</span><span class="nx">wallMapData</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">var</span> <span class="nx">wall</span> <span class="o">=</span> <span class="nx">tableState_copy</span><span class="p">.</span><span class="nx">wallMapData</span><span class="p">[</span> <span class="nx">wall_key</span><span class="p">];</span>
         <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">wallKeys</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">delete</span> <span class="nx">wall</span><span class="p">[</span> <span class="nx">key</span><span class="p">];</span>
         <span class="p">}</span>
      <span class="p">}</span>
      
      <span class="c1">// Remove some spring keys.</span>
      <span class="kd">var</span> <span class="nx">springKeys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pinned&#39;</span><span class="p">,</span><span class="s1">&#39;p1p2_separation_2d_m&#39;</span><span class="p">,</span><span class="s1">&#39;p1p2_separation_m&#39;</span><span class="p">,</span><span class="s1">&#39;p1p2_normalized_2d&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;spo1_ap_w_2d_m&#39;</span><span class="p">,</span><span class="s1">&#39;spo1_ap_w_2d_px&#39;</span><span class="p">,</span><span class="s1">&#39;spo2_ap_w_2d_m&#39;</span><span class="p">,</span><span class="s1">&#39;spo2_ap_w_2d_px&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;selected&#39;</span><span class="p">,</span><span class="s1">&#39;softConstraints_setInPars&#39;</span><span class="p">];</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">spring_key</span> <span class="k">in</span> <span class="nx">tableState_copy</span><span class="p">.</span><span class="nx">springMapData</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">var</span> <span class="nx">spring</span> <span class="o">=</span> <span class="nx">tableState_copy</span><span class="p">.</span><span class="nx">springMapData</span><span class="p">[</span> <span class="nx">spring_key</span><span class="p">];</span>
         
         <span class="c1">// Don&#39;t capture the local ap (attach point) for pins.</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">spring</span><span class="p">.</span><span class="nx">p1_name</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;pin&quot;</span><span class="p">)</span> <span class="k">delete</span> <span class="nx">spring</span><span class="p">[</span><span class="s1">&#39;spo1_ap_l_2d_m&#39;</span><span class="p">];</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">spring</span><span class="p">.</span><span class="nx">p2_name</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;pin&quot;</span><span class="p">)</span> <span class="k">delete</span> <span class="nx">spring</span><span class="p">[</span><span class="s1">&#39;spo2_ap_l_2d_m&#39;</span><span class="p">];</span>
         
         <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">springKeys</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">delete</span> <span class="nx">spring</span><span class="p">[</span> <span class="nx">key</span><span class="p">];</span>
         <span class="p">}</span>
      <span class="p">}</span>
      <span class="c1">// Remove some joint keys.</span>
      <span class="kd">var</span> <span class="nx">jointKeys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;jto1_ap_w_2d_m&#39;</span><span class="p">,</span><span class="s1">&#39;jto1_ap_w_2d_px&#39;</span><span class="p">,</span><span class="s1">&#39;jto2_ap_w_2d_m&#39;</span><span class="p">,</span><span class="s1">&#39;jto2_ap_w_2d_px&#39;</span><span class="p">,</span><span class="s1">&#39;selected&#39;</span><span class="p">,</span><span class="s1">&#39;colorInTransition&#39;</span><span class="p">];</span>  <span class="c1">// color</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">joint_key</span> <span class="k">in</span> <span class="nx">tableState_copy</span><span class="p">.</span><span class="nx">jointMapData</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">var</span> <span class="nx">joint</span> <span class="o">=</span> <span class="nx">tableState_copy</span><span class="p">.</span><span class="nx">jointMapData</span><span class="p">[</span> <span class="nx">joint_key</span><span class="p">];</span>
         <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">jointKeys</span><span class="p">)</span> <span class="p">{</span> 
            <span class="k">delete</span> <span class="nx">joint</span><span class="p">[</span> <span class="nx">key</span><span class="p">];</span>
         <span class="p">}</span>
      <span class="p">}</span>
      
      <span class="c1">// For client objects, clean off all keys EXCEPT these (i.e. SAVE these): </span>
      <span class="kd">var</span> <span class="nx">saveTheseDroneKeys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;NPC_pin_timer_s&#39;</span><span class="p">,</span><span class="s1">&#39;NPC_pin_timer_limit_s&#39;</span><span class="p">,</span><span class="s1">&#39;bulletAgeLimit_ms&#39;</span><span class="p">];</span>
      <span class="kd">var</span> <span class="nx">saveTheseHostKeys</span> <span class="o">=</span>  <span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;bulletAgeLimit_ms&#39;</span><span class="p">,</span><span class="s1">&#39;ctrlShiftLock&#39;</span><span class="p">,</span><span class="s1">&#39;poolShotLocked&#39;</span><span class="p">,</span><span class="s1">&#39;poolShotLockedSpeed_mps&#39;</span><span class="p">];</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">client_key</span> <span class="k">in</span> <span class="nx">tableState_copy</span><span class="p">.</span><span class="nx">clients</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">var</span> <span class="nx">client</span> <span class="o">=</span> <span class="nx">tableState_copy</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span> <span class="nx">client_key</span><span class="p">];</span>
         
         <span class="k">if</span> <span class="p">((</span><span class="nx">client</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;u&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s1">&#39;manWithNoName&#39;</span><span class="p">))</span> <span class="p">{</span>
            <span class="c1">// Delete network clients...</span>
            <span class="k">delete</span> <span class="nx">tableState_copy</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span> <span class="nx">client_key</span><span class="p">];</span>
            
         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;NPC&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Clean-up keys on drone clients.</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">clientKey</span> <span class="k">in</span> <span class="nx">client</span><span class="p">)</span> <span class="p">{</span>
               <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">saveTheseDroneKeys</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span> <span class="nx">clientKey</span><span class="p">))</span> <span class="p">{</span>
                  <span class="k">delete</span> <span class="nx">client</span><span class="p">[</span> <span class="nx">clientKey</span><span class="p">];</span>
               <span class="p">}</span>
            <span class="p">}</span>
            
            <span class="c1">// Add these keys if missing in an old capture...</span>
            <span class="nx">client</span><span class="p">.</span><span class="nx">bulletAgeLimit_ms</span> <span class="o">=</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">bulletAgeLimit_ms</span><span class="p">)</span> <span class="o">?</span> <span class="nx">client</span><span class="p">.</span><span class="nx">bulletAgeLimit_ms</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
            
         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s1">&#39;local&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Clean-up keys on the host.</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">clientKey</span> <span class="k">in</span> <span class="nx">client</span><span class="p">)</span> <span class="p">{</span>
               <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">saveTheseHostKeys</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span> <span class="nx">clientKey</span><span class="p">))</span> <span class="p">{</span>
                  <span class="k">delete</span> <span class="nx">client</span><span class="p">[</span> <span class="nx">clientKey</span><span class="p">];</span>
               <span class="p">}</span>
            <span class="p">}</span>
		 
            <span class="c1">// Add these keys if missing in an old capture...</span>
            <span class="nx">client</span><span class="p">.</span><span class="nx">color</span> <span class="o">=</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">color</span><span class="p">)</span> <span class="o">?</span> <span class="nx">client</span><span class="p">.</span><span class="nx">color</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
            <span class="nx">client</span><span class="p">.</span><span class="nx">bulletAgeLimit_ms</span> <span class="o">=</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">bulletAgeLimit_ms</span><span class="p">)</span> <span class="o">?</span> <span class="nx">client</span><span class="p">.</span><span class="nx">bulletAgeLimit_ms</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
         <span class="p">}</span>
      <span class="p">}</span>
      
      <span class="c1">// Exit if state data was passed in to be cleaned.</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">dataForCleaning</span><span class="p">)</span> <span class="k">return</span> <span class="nx">tableState_copy</span><span class="p">;</span>
      <span class="c1">//----------------------------------------------------------------------</span>
      
      <span class="c1">// Once again, put it in a string...</span>
      <span class="nx">table_JSON</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span> <span class="nx">tableState_copy</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
      
      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">inhibitWriteToCaptureCell</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">// Write the json string to this visible input field.</span>
         <span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">json</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">table_JSON</span><span class="p">;</span>
         <span class="c1">// Wait 0.5 seconds, then scroll the input field to the top.</span>
         <span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">scrollCaptureArea</span><span class="p">();},</span> <span class="mi">500</span><span class="p">);</span>
         
         <span class="c1">// Select, copy to clipboard, and then remove focus from the input field.</span>
         <span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">json</span><span class="p">.</span><span class="nx">select</span><span class="p">();</span>
         <span class="nb">document</span><span class="p">.</span><span class="nx">execCommand</span><span class="p">(</span><span class="s1">&#39;copy&#39;</span><span class="p">);</span>
         <span class="nb">window</span><span class="p">.</span><span class="nx">getSelection</span><span class="p">().</span><span class="nx">removeAllRanges</span><span class="p">();</span> <span class="c1">// this is necessary for the blur method to work in MS Edge.</span>
         <span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">json</span><span class="p">.</span><span class="nx">blur</span><span class="p">();</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="nx">table_JSON</span><span class="p">;</span>
   <span class="p">}</span>
   
   <span class="kd">function</span> <span class="nx">loadJSON</span><span class="p">(</span> <span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">state_capture</span><span class="p">,</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">title</span><span class="p">;</span>
            
      <span class="k">if</span> <span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">value</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">try</span> <span class="p">{</span>
            <span class="nx">state_capture</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span> <span class="nx">element</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
            
         <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">id</span> <span class="o">==</span> <span class="s2">&quot;jsonCapture&quot;</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">title</span> <span class="o">=</span> <span class="s2">&quot;JSON error in the capture&quot;</span><span class="p">;</span>
               <span class="nx">message</span> <span class="o">=</span> <span class="s2">&quot;There is a formatting error in the state capture.&lt;br&gt;&quot;</span> <span class="o">+</span> 
                         <span class="s2">&quot;&lt;ul&gt;&lt;li&gt;Do not use single quotes, use doubles (&quot;</span> <span class="o">+</span> <span class="s1">&#39;&quot;&quot;&#39;</span> <span class="o">+</span> <span class="s2">&quot;).&lt;br&gt;&quot;</span> <span class="o">+</span> 
                         <span class="s2">&quot;&lt;li&gt;Quote strings and attribute names.&lt;br&gt;&quot;</span> <span class="o">+</span> 
                         <span class="s2">&quot;&lt;li&gt;Numbers and logicals don&#39;t need quotes.&lt;br&gt;&quot;</span> <span class="o">+</span> 
                         <span class="s2">&quot;&lt;li&gt;Try reversing recent edits.&lt;br&gt;&quot;</span> <span class="o">+</span>
                         <span class="s2">&quot;&lt;li&gt;Try starting over, clear it (click the &#39;C&#39; button).&lt;/ul&gt;&quot;</span><span class="p">;</span>
               
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">id</span> <span class="o">==</span> <span class="s2">&quot;inputField&quot;</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">title</span> <span class="o">=</span> <span class="s2">&quot;JSON error in chat input&quot;</span><span class="p">;</span>
               <span class="nx">message</span> <span class="o">=</span> <span class="s1">&#39;There is a formatting error in the JSON in the chat input.&lt;br&gt;&#39;</span> <span class="o">+</span> 
                         <span class="s1">&#39;An example of good format is {&quot;color&quot;: &quot;yellow&quot;} or {&quot;friction&quot;: 0.5}.&lt;br&gt;&lt;br&gt;&#39;</span> <span class="o">+</span> 
                         <span class="s1">&#39;You may need to use the &quot;m&quot; key to toggle the left panel and reveal the chat input field.&#39;</span><span class="p">;</span>               
            <span class="p">}</span>
            
            <span class="nx">pS</span><span class="p">.</span><span class="nx">viewGeneralDialog</span><span class="p">({</span><span class="s2">&quot;title&quot;</span><span class="o">:</span><span class="nx">title</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="o">:</span><span class="nx">message</span><span class="p">,</span> <span class="s2">&quot;label_close&quot;</span><span class="o">:</span><span class="s2">&quot;close&quot;</span><span class="p">});</span>
            <span class="nx">state_capture</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
         <span class="p">}</span>
         
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">id</span> <span class="o">==</span> <span class="s2">&quot;jsonCapture&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">title</span> <span class="o">=</span> <span class="s2">&quot;capture missing&quot;</span><span class="p">;</span>
            <span class="nx">message</span> <span class="o">=</span> <span class="s2">&quot;The capture text area is empty.&quot;</span><span class="p">;</span>
            
         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">id</span> <span class="o">==</span> <span class="s2">&quot;inputField&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">title</span> <span class="o">=</span> <span class="s2">&quot;chat field is empty&quot;</span><span class="p">;</span>
            <span class="nx">message</span> <span class="o">=</span> <span class="s1">&#39;There is no modifying JSON to use.&lt;br&gt;&#39;</span> <span class="o">+</span> 
                      <span class="s1">&#39;Put some JSON in the chat input field.&lt;br&gt;&#39;</span> <span class="o">+</span> 
                      <span class="s1">&#39;Examples: {&quot;color&quot;: &quot;yellow&quot;} or {&quot;friction&quot;: 0.5}&#39;</span><span class="p">;</span>
         <span class="p">}</span>
         
         <span class="nx">pS</span><span class="p">.</span><span class="nx">viewGeneralDialog</span><span class="p">({</span><span class="s2">&quot;title&quot;</span><span class="o">:</span><span class="nx">title</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="o">:</span><span class="nx">message</span><span class="p">,</span> <span class="s2">&quot;label_close&quot;</span><span class="o">:</span><span class="s2">&quot;close&quot;</span><span class="p">});</span>
         <span class="nx">state_capture</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="p">}</span>
      
      <span class="k">return</span> <span class="nx">state_capture</span><span class="p">;</span>
   <span class="p">}</span>
   
   <span class="kd">function</span> <span class="nx">modifyCapture</span><span class="p">()</span> <span class="p">{</span>
      <span class="c1">// Use a small piece of JSON (in the chat field) to change corresponding attributes in the capture</span>
      <span class="c1">// for all the selected table objects. This was used mainly to generate demo 1b.</span>
      <span class="kd">let</span> <span class="nx">state_capture</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">jsonModifier</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      
      <span class="c1">// Pull in the capture</span>
      <span class="nx">state_capture</span> <span class="o">=</span> <span class="nx">loadJSON</span><span class="p">(</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">json</span><span class="p">);</span>
      
      <span class="c1">// Parse the JSON in the chat field.</span>
      <span class="nx">jsonModifier</span> <span class="o">=</span> <span class="nx">loadJSON</span><span class="p">(</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">inputField</span><span class="p">);</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="nx">state_capture</span> <span class="o">&amp;&amp;</span> <span class="nx">jsonModifier</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">// Change the attributes of the selected objects</span>
         <span class="nx">gW</span><span class="p">.</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span> <span class="nx">tableObj</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="kd">let</span> <span class="nx">mapName</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">tableObj</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;Puck&quot;</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">mapName</span> <span class="o">=</span> <span class="s1">&#39;puckMapData&#39;</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">tableObj</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;Wall&quot;</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">mapName</span> <span class="o">=</span> <span class="s1">&#39;wallMapData&#39;</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">tableObj</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;Pin&quot;</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">mapName</span> <span class="o">=</span> <span class="s1">&#39;pinMapData&#39;</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">jsonModifier</span><span class="p">)</span> <span class="p">{</span>
               <span class="k">if</span> <span class="p">(</span><span class="nx">mapName</span><span class="p">)</span> <span class="nx">state_capture</span><span class="p">[</span> <span class="nx">mapName</span><span class="p">][</span> <span class="nx">tableObj</span><span class="p">.</span><span class="nx">name</span><span class="p">][</span> <span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">jsonModifier</span><span class="p">[</span> <span class="nx">key</span><span class="p">];</span>
            <span class="p">}</span>
         <span class="p">});</span>
         
         <span class="c1">// Write out the updated capture.</span>
         <span class="nx">state_capture</span><span class="p">.</span><span class="nx">demoVersion</span> <span class="o">+=</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">((</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
         <span class="kd">let</span> <span class="nx">table_JSON</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span> <span class="nx">state_capture</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
         <span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">json</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">table_JSON</span><span class="p">;</span>
         
         <span class="nx">runCapture</span><span class="p">();</span>
      <span class="p">}</span>
   <span class="p">}</span>
   
   <span class="c1">// This is the default modification function used by modifyForCalculator.</span>
   <span class="kd">let</span> <span class="nx">settingsForDemos</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">state_capture</span><span class="p">,</span> <span class="nx">demoName</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Use the speed version of the EpL report.</span>
      <span class="nx">state_capture</span><span class="p">[</span><span class="s1">&#39;EpL&#39;</span><span class="p">][</span><span class="s1">&#39;reportType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;speed&#39;</span><span class="p">;</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="nx">demoName</span> <span class="o">==</span> <span class="s1">&#39;5.a.orbitingOnSpring&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">let</span> <span class="nx">vx_init_mps</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#vx_init&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">());</span>
         <span class="kd">let</span> <span class="nx">vy_init_mps</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#vy_init&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">());</span>
         
         <span class="nx">state_capture</span><span class="p">[</span><span class="s1">&#39;puckMapData&#39;</span><span class="p">][</span><span class="s1">&#39;puck15&#39;</span><span class="p">][</span><span class="s1">&#39;velocity_2d_mps&#39;</span><span class="p">].</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">vx_init_mps</span><span class="p">;</span>
         <span class="nx">state_capture</span><span class="p">[</span><span class="s1">&#39;puckMapData&#39;</span><span class="p">][</span><span class="s1">&#39;puck15&#39;</span><span class="p">][</span><span class="s1">&#39;velocity_2d_mps&#39;</span><span class="p">].</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">vy_init_mps</span><span class="p">;</span>
         <span class="nx">state_capture</span><span class="p">[</span><span class="s1">&#39;puckMapData&#39;</span><span class="p">][</span><span class="s1">&#39;puck12&#39;</span><span class="p">][</span><span class="s1">&#39;velocity_2d_mps&#39;</span><span class="p">].</span><span class="nx">x</span> <span class="o">=</span> <span class="o">-</span><span class="nx">vx_init_mps</span><span class="p">;</span> 
         <span class="nx">state_capture</span><span class="p">[</span><span class="s1">&#39;puckMapData&#39;</span><span class="p">][</span><span class="s1">&#39;puck12&#39;</span><span class="p">][</span><span class="s1">&#39;velocity_2d_mps&#39;</span><span class="p">].</span><span class="nx">y</span> <span class="o">=</span> <span class="o">-</span><span class="nx">vy_init_mps</span><span class="p">;</span> 
      
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">demoName</span> <span class="o">==</span> <span class="s1">&#39;5.b.two&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">let</span> <span class="nx">a_init</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#a_2p_init&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">());</span>
         <span class="kd">let</span> <span class="nx">b_init</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#b_2p_init&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">());</span>
         
         <span class="nx">state_capture</span><span class="p">[</span><span class="s1">&#39;puckMapData&#39;</span><span class="p">][</span><span class="s1">&#39;puck1&#39;</span><span class="p">][</span><span class="s1">&#39;angularSpeed_rps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">a_init</span><span class="p">;</span>
         <span class="nx">state_capture</span><span class="p">[</span><span class="s1">&#39;puckMapData&#39;</span><span class="p">][</span><span class="s1">&#39;puck2&#39;</span><span class="p">][</span><span class="s1">&#39;angularSpeed_rps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">b_init</span><span class="p">;</span> 
         
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">demoName</span> <span class="o">==</span> <span class="s1">&#39;5.b.four&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">let</span> <span class="nx">a_init</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#a_4p_init&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">());</span>
         <span class="kd">let</span> <span class="nx">b_init</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#b_4p_init&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">());</span>
         <span class="kd">let</span> <span class="nx">c_init</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#c_4p_init&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">());</span>
         <span class="kd">let</span> <span class="nx">d_init</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#d_4p_init&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">());</span>
         
         <span class="nx">state_capture</span><span class="p">[</span><span class="s1">&#39;puckMapData&#39;</span><span class="p">][</span><span class="s1">&#39;puck17&#39;</span><span class="p">][</span><span class="s1">&#39;angularSpeed_rps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">a_init</span><span class="p">;</span>
         <span class="nx">state_capture</span><span class="p">[</span><span class="s1">&#39;puckMapData&#39;</span><span class="p">][</span><span class="s1">&#39;puck18&#39;</span><span class="p">][</span><span class="s1">&#39;angularSpeed_rps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">b_init</span><span class="p">;</span>               
         <span class="nx">state_capture</span><span class="p">[</span><span class="s1">&#39;puckMapData&#39;</span><span class="p">][</span><span class="s1">&#39;puck19&#39;</span><span class="p">][</span><span class="s1">&#39;angularSpeed_rps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">c_init</span><span class="p">;</span>               
         <span class="nx">state_capture</span><span class="p">[</span><span class="s1">&#39;puckMapData&#39;</span><span class="p">][</span><span class="s1">&#39;puck20&#39;</span><span class="p">][</span><span class="s1">&#39;angularSpeed_rps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">d_init</span><span class="p">;</span>               
         
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">demoName</span> <span class="o">==</span> <span class="s1">&#39;5.b.six&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">let</span> <span class="nx">a_init</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#a_6p_init&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">());</span>
         <span class="kd">let</span> <span class="nx">b_init</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#b_6p_init&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">());</span>
         <span class="kd">let</span> <span class="nx">c_init</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#c_6p_init&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">());</span>
         <span class="kd">let</span> <span class="nx">d_init</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#d_6p_init&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">());</span>
         <span class="kd">let</span> <span class="nx">e_init</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#e_6p_init&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">());</span>
         <span class="kd">let</span> <span class="nx">f_init</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#f_6p_init&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">());</span>
         
         <span class="c1">// 1,9,14 2,5,13</span>
         <span class="nx">state_capture</span><span class="p">[</span><span class="s1">&#39;puckMapData&#39;</span><span class="p">][</span><span class="s1">&#39;puck1&#39;</span><span class="p">][</span><span class="s1">&#39;angularSpeed_rps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">a_init</span><span class="p">;</span>
         <span class="nx">state_capture</span><span class="p">[</span><span class="s1">&#39;puckMapData&#39;</span><span class="p">][</span><span class="s1">&#39;puck2&#39;</span><span class="p">][</span><span class="s1">&#39;angularSpeed_rps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">b_init</span><span class="p">;</span>               
         <span class="nx">state_capture</span><span class="p">[</span><span class="s1">&#39;puckMapData&#39;</span><span class="p">][</span><span class="s1">&#39;puck3&#39;</span><span class="p">][</span><span class="s1">&#39;angularSpeed_rps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">c_init</span><span class="p">;</span>               
         <span class="nx">state_capture</span><span class="p">[</span><span class="s1">&#39;puckMapData&#39;</span><span class="p">][</span><span class="s1">&#39;puck4&#39;</span><span class="p">][</span><span class="s1">&#39;angularSpeed_rps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">d_init</span><span class="p">;</span>               
         <span class="nx">state_capture</span><span class="p">[</span><span class="s1">&#39;puckMapData&#39;</span><span class="p">][</span><span class="s1">&#39;puck5&#39;</span><span class="p">][</span><span class="s1">&#39;angularSpeed_rps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">e_init</span><span class="p">;</span>               
         <span class="nx">state_capture</span><span class="p">[</span><span class="s1">&#39;puckMapData&#39;</span><span class="p">][</span><span class="s1">&#39;puck6&#39;</span><span class="p">][</span><span class="s1">&#39;angularSpeed_rps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">f_init</span><span class="p">;</span>               
         
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">demoName</span> <span class="o">==</span> <span class="s1">&#39;5.b&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">let</span> <span class="nx">a_init</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#a_init&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">());</span>
         <span class="kd">let</span> <span class="nx">b_init</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#b_init&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">());</span>
         <span class="kd">let</span> <span class="nx">c_init</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#c_init&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">());</span>
         
         <span class="nx">state_capture</span><span class="p">[</span><span class="s1">&#39;puckMapData&#39;</span><span class="p">][</span><span class="s1">&#39;puck9&#39;</span><span class="p">][</span><span class="s1">&#39;angularSpeed_rps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">a_init</span><span class="p">;</span>
         <span class="nx">state_capture</span><span class="p">[</span><span class="s1">&#39;puckMapData&#39;</span><span class="p">][</span><span class="s1">&#39;puck10&#39;</span><span class="p">][</span><span class="s1">&#39;angularSpeed_rps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">b_init</span><span class="p">;</span>               
         <span class="nx">state_capture</span><span class="p">[</span><span class="s1">&#39;puckMapData&#39;</span><span class="p">][</span><span class="s1">&#39;puck11&#39;</span><span class="p">][</span><span class="s1">&#39;angularSpeed_rps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">c_init</span><span class="p">;</span>               
      <span class="p">}</span>
      
      <span class="c1">//state_capture.demoVersion += &#39;.&#39; + Math.floor((Math.random() * 1000) + 1);</span>
      <span class="kd">let</span> <span class="nx">table_JSON</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span> <span class="nx">state_capture</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
      <span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">json</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">table_JSON</span><span class="p">;</span>
   <span class="p">}</span>
   
   <span class="kd">function</span> <span class="nx">modifyForCalculator</span><span class="p">(</span> <span class="nx">demoName</span><span class="p">,</span> <span class="nx">pars</span><span class="o">=</span><span class="p">{})</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">okToRunCapture</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">okToRunCapture</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
      <span class="c1">// note: settingsForDemos is the function above.</span>
      <span class="kd">let</span> <span class="nx">theFunction</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">theFunction</span><span class="p">,</span> <span class="nx">settingsForDemos</span><span class="p">);</span>
      
      <span class="kd">let</span> <span class="nx">demoFileNames</span> <span class="o">=</span> <span class="p">{</span>
         <span class="s1">&#39;5.a.orbitingOnSpring&#39;</span><span class="o">:</span> <span class="s1">&#39;demo5a.orbitingOnSpring.js&#39;</span><span class="p">,</span>
         <span class="s1">&#39;5.b.two&#39;</span><span class="o">:</span> <span class="s1">&#39;demo5b.two.js&#39;</span><span class="p">,</span>
         <span class="s1">&#39;5.b.four&#39;</span><span class="o">:</span> <span class="s1">&#39;demo5b.four.js&#39;</span><span class="p">,</span>
         <span class="s1">&#39;5.b.six&#39;</span><span class="o">:</span> <span class="s1">&#39;demo5b.six.js&#39;</span><span class="p">,</span>
         <span class="s1">&#39;5.b&#39;</span><span class="o">:</span> <span class="s1">&#39;demo5b.js&#39;</span><span class="p">,</span>
      <span class="p">};</span>
      <span class="kd">let</span> <span class="nx">demoIndex</span> <span class="o">=</span> <span class="nx">demoName</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
      
      <span class="c1">// Check for the correct demo capture in the textarea.</span>
      <span class="kd">let</span> <span class="nx">state_capture</span> <span class="o">=</span> <span class="nx">loadJSON</span><span class="p">(</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">json</span><span class="p">);</span>
      <span class="kd">let</span> <span class="nx">loadWaitNeeded</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="p">(</span><span class="nx">state_capture</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">state_capture</span><span class="p">.</span><span class="nx">demoVersion</span> <span class="o">==</span> <span class="nx">demoName</span><span class="p">)))</span> <span class="p">{</span>
         <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s1">&#39;Loading the [base,yellow]&#39;</span> <span class="o">+</span> <span class="nx">demoName</span> <span class="o">+</span> <span class="s1">&#39;[base] demo.&#39;</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">);</span>
         <span class="nx">demoStart_fromCapture</span><span class="p">(</span> <span class="nx">demoIndex</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;fileName&#39;</span><span class="o">:</span><span class="nx">demoFileNames</span><span class="p">[</span> <span class="nx">demoName</span><span class="p">],</span> <span class="s1">&#39;runIt&#39;</span><span class="o">:</span><span class="kc">false</span><span class="p">});</span>
         <span class="nx">loadWaitNeeded</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span>
      
      <span class="c1">// Give it some time to finish loading...</span>
      <span class="kd">let</span> <span class="nx">loadWait</span> <span class="o">=</span> <span class="p">(</span><span class="nx">loadWaitNeeded</span><span class="p">)</span> <span class="o">?</span> <span class="mi">500</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span> 
      <span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> 
         <span class="nx">state_capture</span> <span class="o">=</span> <span class="nx">loadJSON</span><span class="p">(</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">json</span><span class="p">);</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">state_capture</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Ok, now run the modification function that is passed in.</span>
            <span class="nx">theFunction</span><span class="p">(</span> <span class="nx">state_capture</span><span class="p">,</span> <span class="nx">demoName</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">okToRunCapture</span><span class="p">)</span> <span class="nx">runCapture</span><span class="p">();</span>
         <span class="p">}</span>
      <span class="p">},</span> <span class="nx">loadWait</span><span class="p">);</span>
   <span class="p">}</span>
   
   <span class="kd">function</span> <span class="nx">shiftCapture</span><span class="p">()</span> <span class="p">{</span>
      <span class="c1">// Shift the position of the pucks, pins, and walls so that the capture appears centered on a new larger canvas.</span>
      <span class="c1">// Calculate the shift vector using: </span>
      <span class="c1">//   center of the original canvas</span>
      <span class="c1">//   center of the larger final canvas</span>
      
      <span class="kd">let</span> <span class="nx">state_capture</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="kd">let</span> <span class="nx">originalCenter_2d_px</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">originalCenter_2d_m</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="kd">let</span> <span class="nx">finalCenter_2d_px</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">finalCenter_2d_m</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      
      <span class="c1">// Pull in the capture</span>
      <span class="nx">state_capture</span> <span class="o">=</span> <span class="nx">loadJSON</span><span class="p">(</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">json</span><span class="p">);</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="nx">state_capture</span><span class="p">)</span> <span class="p">{</span>
         
         <span class="k">if</span> <span class="p">(</span><span class="nx">state_capture</span><span class="p">[</span><span class="s2">&quot;canvasDimensions&quot;</span><span class="p">])</span> <span class="p">{</span>
            <span class="nx">originalCenter_2d_px</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span> <span class="nx">state_capture</span><span class="p">[</span><span class="s2">&quot;canvasDimensions&quot;</span><span class="p">].</span><span class="nx">width</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span> <span class="nx">state_capture</span><span class="p">[</span><span class="s2">&quot;canvasDimensions&quot;</span><span class="p">].</span><span class="nx">height</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">);</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">originalCenter_2d_px</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">get_hostCanvasWH</span><span class="p">().</span><span class="nx">width</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">get_hostCanvasWH</span><span class="p">().</span><span class="nx">height</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">);</span>
         <span class="p">}</span>
         <span class="nx">originalCenter_2d_m</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">meters_from_px</span><span class="p">(</span> <span class="nx">originalCenter_2d_px</span><span class="p">.</span><span class="nx">x</span><span class="p">),</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">meters_from_px</span><span class="p">(</span> <span class="nx">originalCenter_2d_px</span><span class="p">.</span><span class="nx">y</span><span class="p">));</span>
         
         <span class="c1">// Increase the size of the canvas to match the window. </span>
         <span class="kd">let</span> <span class="nx">w_px</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">innerWidth</span><span class="p">;</span>
         <span class="kd">let</span> <span class="nx">h_px</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">innerHeight</span><span class="p">;</span>
         <span class="nx">state_capture</span><span class="p">[</span><span class="s2">&quot;canvasDimensions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;width&quot;</span><span class="o">:</span> <span class="nx">w_px</span><span class="p">,</span> <span class="s2">&quot;height&quot;</span><span class="o">:</span> <span class="nx">h_px</span><span class="p">};</span>
         <span class="nx">finalCenter_2d_px</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span> <span class="nx">w_px</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span> <span class="nx">h_px</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">);</span>
         <span class="nx">finalCenter_2d_m</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">meters_from_px</span><span class="p">(</span> <span class="nx">finalCenter_2d_px</span><span class="p">.</span><span class="nx">x</span><span class="p">),</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">meters_from_px</span><span class="p">(</span> <span class="nx">finalCenter_2d_px</span><span class="p">.</span><span class="nx">y</span><span class="p">));</span>
         
         <span class="c1">// calculate shift vector</span>
         <span class="kd">let</span> <span class="nx">shift_2d_m</span> <span class="o">=</span> <span class="nx">finalCenter_2d_m</span><span class="p">.</span><span class="nx">subtract</span><span class="p">(</span> <span class="nx">originalCenter_2d_m</span><span class="p">);</span>
         
         <span class="kd">let</span> <span class="nx">shifter</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">mapName</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">objName</span> <span class="k">in</span> <span class="nx">state_capture</span><span class="p">[</span> <span class="nx">mapName</span><span class="p">])</span> <span class="p">{</span>
               <span class="kd">let</span> <span class="nx">obj</span> <span class="o">=</span> <span class="nx">state_capture</span><span class="p">[</span> <span class="nx">mapName</span><span class="p">][</span> <span class="nx">objName</span><span class="p">];</span>
               <span class="nx">obj</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">.</span><span class="nx">x</span> <span class="o">+=</span> <span class="nx">shift_2d_m</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
               <span class="nx">obj</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">.</span><span class="nx">y</span> <span class="o">+=</span> <span class="nx">shift_2d_m</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
            <span class="p">}</span>
         <span class="p">}</span>
         <span class="c1">// Shift (move) the starting positions of all objects.</span>
         <span class="nx">shifter</span><span class="p">(</span><span class="s1">&#39;puckMapData&#39;</span><span class="p">);</span>
         <span class="nx">shifter</span><span class="p">(</span><span class="s1">&#39;pinMapData&#39;</span><span class="p">);</span>
         <span class="nx">shifter</span><span class="p">(</span><span class="s1">&#39;wallMapData&#39;</span><span class="p">);</span>
         
         <span class="c1">// Write out the updated capture.</span>
         <span class="nx">state_capture</span><span class="p">.</span><span class="nx">demoVersion</span> <span class="o">+=</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">((</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
         <span class="kd">let</span> <span class="nx">table_JSON</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span> <span class="nx">state_capture</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
         <span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">json</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">table_JSON</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span>
   
   <span class="kd">function</span> <span class="nx">runCapture</span><span class="p">(</span> <span class="nx">pars</span><span class="o">=</span><span class="p">{})</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">fromKeyBoard</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">fromKeyBoard</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
      <span class="kd">let</span> <span class="nx">state_capture</span><span class="p">,</span> <span class="nx">demoIndex</span><span class="p">;</span>
      
      <span class="nx">state_capture</span> <span class="o">=</span> <span class="nx">loadJSON</span><span class="p">(</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">json</span><span class="p">);</span>
      
      <span class="kd">let</span> <span class="nx">shift_key</span> <span class="o">=</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">key_shift</span><span class="p">;</span> <span class="c1">// before the key-state reset that is in demoStart</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="nx">state_capture</span><span class="p">)</span> <span class="p">{</span> 
         <span class="nx">demoIndex</span> <span class="o">=</span> <span class="nx">state_capture</span><span class="p">.</span><span class="nx">demoIndex</span><span class="p">;</span>
         <span class="nx">dS</span><span class="p">.</span><span class="nx">demoStart</span><span class="p">(</span> <span class="nx">demoIndex</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;scrollCA&#39;</span><span class="o">:</span><span class="kc">false</span><span class="p">});</span>
         
         <span class="c1">// grab a capture before the engine changes state...</span>
         <span class="k">if</span> <span class="p">((</span><span class="nx">shift_key</span> <span class="o">==</span> <span class="s2">&quot;D&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">fromKeyBoard</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">saveState</span><span class="p">();</span>
            <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s1">&#39;The capture has been updated.&#39;</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">);</span>
         <span class="p">}</span>
         
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="c1">// grab a capture before the engine changes state...</span>
         <span class="k">if</span> <span class="p">((</span><span class="nx">shift_key</span> <span class="o">==</span> <span class="s2">&quot;D&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">fromKeyBoard</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">dS</span><span class="p">.</span><span class="nx">demoStart</span><span class="p">(</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoIndex</span><span class="p">());</span>
            <span class="nx">saveState</span><span class="p">();</span>
            <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s1">&#39;A capture has been taken.&#39;</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">);</span>
         <span class="p">}</span>
         
         <span class="c1">// Make sure the loop isn&#39;t paused so the help messages are displayed.</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">pause</span><span class="p">.</span><span class="nx">checked</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">pause</span><span class="p">.</span><span class="nx">checked</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
            <span class="nx">gW</span><span class="p">.</span><span class="nx">setPauseState</span><span class="p">();</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>
   
   <span class="kd">function</span> <span class="nx">clearState</span><span class="p">()</span> <span class="p">{</span>
      <span class="c1">// Reset the capture state...</span>
      <span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">json</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
      <span class="c1">// Reset the highlight styles in the row below the number buttons.</span>
      <span class="kd">var</span> <span class="nx">highlightedLinkInPlusRow</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoVersion</span><span class="p">().</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">));</span>
      <span class="kd">var</span> <span class="nx">firstLinkInPlusRow</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoVersion</span><span class="p">().</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.a&quot;</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">highlightedLinkInPlusRow</span><span class="p">)</span> <span class="nx">highlightedLinkInPlusRow</span><span class="p">.</span><span class="nx">style</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">firstLinkInPlusRow</span><span class="p">)</span> <span class="nx">firstLinkInPlusRow</span><span class="p">.</span><span class="nx">style</span> <span class="o">=</span> <span class="s1">&#39;color:white; background-color:gray; padding:2px 0px&#39;</span><span class="p">;</span>
   <span class="p">}</span>
   
   <span class="kd">function</span> <span class="nx">cleanCapture</span><span class="p">()</span> <span class="p">{</span>
      <span class="cm">/*</span>
<span class="cm">      Clean up an old capture that&#39;s in the text area (or one of the &quot;_fromFile&quot; files).</span>
<span class="cm">      Mainly this removes old keys. You can enlist cleanCapture and saveState to add new editable keys (if it&#39;s in</span>
<span class="cm">      the code), but it is generally best to run the old capture and then immediately take a new capture.</span>
<span class="cm">      </span>
<span class="cm">      Recently modified runCapture to be able to do that (immediately take a capture before the engine modifies state) if the shift key is down.</span>
<span class="cm">      </span>
<span class="cm">      cleanCapture can be run by middle clicking in the text area.</span>
<span class="cm">      */</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoVersion</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;8.a&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">var</span> <span class="nx">state_data</span> <span class="o">=</span> <span class="nx">demo_8_fromFile</span><span class="p">;</span>
         
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoVersion</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;6.a&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">var</span> <span class="nx">state_data</span> <span class="o">=</span> <span class="nx">demo_6_fromFile</span><span class="p">;</span>
         
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">json</span><span class="p">.</span><span class="nx">value</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">state_data</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">json</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s1">&#39;No capture to update.&#39;</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
         <span class="p">}</span>
      <span class="p">}</span>
      
      <span class="c1">// first, process (clean) the capture with saveState</span>
      <span class="nx">state_data</span> <span class="o">=</span> <span class="nx">saveState</span><span class="p">(</span> <span class="p">{</span><span class="s1">&#39;dataForCleaning&#39;</span><span class="o">:</span><span class="nx">state_data</span><span class="p">}</span> <span class="p">);</span>
      
      <span class="c1">// Special loop for pucks.</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">p_key</span> <span class="k">in</span> <span class="nx">state_data</span><span class="p">.</span><span class="nx">puckMapData</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">var</span> <span class="nx">puck</span> <span class="o">=</span> <span class="nx">state_data</span><span class="p">.</span><span class="nx">puckMapData</span><span class="p">[</span> <span class="nx">p_key</span><span class="p">];</span>
         
         <span class="k">if</span> <span class="p">(</span><span class="nx">puck</span><span class="p">.</span><span class="nx">clientName</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">puck</span><span class="p">.</span><span class="nx">groupIndex</span> <span class="o">=</span> <span class="o">-</span><span class="nx">puck</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1000</span><span class="p">;</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">((</span><span class="nx">state_data</span><span class="p">.</span><span class="nx">demoVersion</span> <span class="o">==</span> <span class="s1">&#39;3.b&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">state_data</span><span class="p">.</span><span class="nx">demoVersion</span> <span class="o">==</span> <span class="s1">&#39;3.c&#39;</span><span class="p">))</span> <span class="p">{</span>
               <span class="c1">// leave these alone, puck-puck collisions have been inhibited on these pucks.</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
               <span class="nx">puck</span><span class="p">.</span><span class="nx">groupIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span>
         <span class="p">}</span>
      <span class="p">}</span>
      
      <span class="c1">// For all the maps.</span>
      <span class="kd">var</span> <span class="nx">mapList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;puckMapData&#39;</span><span class="p">,</span><span class="s1">&#39;pinMapData&#39;</span><span class="p">,</span><span class="s1">&#39;springMapData&#39;</span><span class="p">,</span><span class="s1">&#39;jointMapData&#39;</span><span class="p">,</span><span class="s1">&#39;wallMapData&#39;</span><span class="p">,</span><span class="s1">&#39;clients&#39;</span><span class="p">];</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">map</span> <span class="k">of</span> <span class="nx">mapList</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">state_data</span><span class="p">[</span> <span class="nx">map</span><span class="p">])</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">element</span> <span class="o">=</span> <span class="nx">state_data</span><span class="p">[</span> <span class="nx">map</span><span class="p">][</span> <span class="nx">key</span><span class="p">];</span>
            
            <span class="k">delete</span> <span class="nx">element</span><span class="p">[</span><span class="s1">&#39;parsAtBirth&#39;</span><span class="p">];</span>
            
            <span class="k">delete</span> <span class="nx">element</span><span class="p">[</span><span class="s1">&#39;alsoThese&#39;</span><span class="p">];</span>
            
            <span class="c1">// Put the alsoThese key at the beginning of the object. Commented this</span>
            <span class="c1">// out for now. Could be useful if want to force an attribute to be recognized</span>
            <span class="c1">// in the capture.</span>
            <span class="c1">//state_data[ map][ key] = Object.assign({&#39;alsoThese&#39;:[]}, element);</span>
         <span class="p">}</span>
      <span class="p">}</span>
      
      <span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">json</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span> <span class="nx">state_data</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
      
      <span class="c1">// Select, copy to clipboard, and then remove focus from the input field.</span>
      <span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">json</span><span class="p">.</span><span class="nx">select</span><span class="p">();</span>
      <span class="nb">document</span><span class="p">.</span><span class="nx">execCommand</span><span class="p">(</span><span class="s1">&#39;copy&#39;</span><span class="p">);</span>
      <span class="nb">window</span><span class="p">.</span><span class="nx">getSelection</span><span class="p">().</span><span class="nx">removeAllRanges</span><span class="p">();</span> <span class="c1">// this is necessary for the blur method to work in MS Edge.</span>
      <span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">json</span><span class="p">.</span><span class="nx">blur</span><span class="p">();</span>   
   
      <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s1">&#39;The capture has been updated (scripted, without instantiation).&#39;</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">);</span>
   <span class="p">}</span>
   
   <span class="kd">function</span> <span class="nx">newBirth</span><span class="p">(</span> <span class="nx">captureObj</span><span class="p">,</span> <span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Update the birth object (based on the capture state) and use it for restoration.</span>
      <span class="kd">var</span> <span class="nx">newBirthState</span> <span class="o">=</span> <span class="p">{},</span> <span class="nx">par_list</span><span class="p">;</span>
      
      <span class="c1">// If there&#39;s a parameter that is getting into the capture but should be blocked in the birth process:</span>
      <span class="kd">var</span> <span class="nx">forgetList</span> <span class="o">=</span> <span class="p">{</span>
         <span class="s1">&#39;puck&#39;</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;position_2d_m&#39;</span><span class="p">,</span><span class="s1">&#39;velocity_2d_mps&#39;</span><span class="p">],</span> <span class="c1">// These are explicitly passed to constructor via arguments (so not needed in birth object)</span>
         <span class="s1">&#39;wall&#39;</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;position_2d_m&#39;</span><span class="p">],</span>  <span class="c1">// Position is passed via arguments. Velocity can be specified in birth object.</span>
         <span class="s1">&#39;pin&#39;</span><span class="o">:</span>  <span class="p">[</span><span class="s1">&#39;position_2d_m&#39;</span><span class="p">],</span>  <span class="c1">// Position is passed via arguments. Velocity can be specified in birth object.</span>
         <span class="s1">&#39;s&#39;</span><span class="o">:</span>    <span class="p">[],</span> <span class="c1">// spring</span>
         <span class="s1">&#39;j&#39;</span><span class="o">:</span>    <span class="p">[],</span> <span class="c1">// joint</span>
         <span class="s1">&#39;NPC&#39;</span><span class="o">:</span>  <span class="p">[]</span>  <span class="c1">// drones</span>
      <span class="p">};</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">birthParm</span> <span class="k">in</span> <span class="nx">captureObj</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">forgetList</span><span class="p">[</span> <span class="nx">type</span><span class="p">].</span><span class="nx">includes</span><span class="p">(</span> <span class="nx">birthParm</span><span class="p">))</span> <span class="p">{</span>
            <span class="c1">// If this parameter&#39;s value is a vector, instantiate it using Vec2D.</span>
            <span class="c1">// (Note the check for &quot;null.&quot; Null is also an object in javascript, but does not have the hasownProperty method.)</span>
            <span class="k">if</span> <span class="p">(</span> <span class="p">((</span><span class="k">typeof</span><span class="p">(</span><span class="nx">captureObj</span><span class="p">[</span> <span class="nx">birthParm</span><span class="p">])</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">captureObj</span><span class="p">[</span> <span class="nx">birthParm</span><span class="p">]</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">))</span> <span class="o">&amp;&amp;</span> 
                 <span class="p">((</span><span class="nx">captureObj</span><span class="p">[</span> <span class="nx">birthParm</span><span class="p">].</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">captureObj</span><span class="p">[</span> <span class="nx">birthParm</span><span class="p">].</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)))</span> <span class="p">)</span> <span class="p">{</span>
                   
                  <span class="nx">newBirthState</span><span class="p">[</span> <span class="nx">birthParm</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span> <span class="nx">captureObj</span><span class="p">[</span> <span class="nx">birthParm</span><span class="p">].</span><span class="nx">x</span><span class="p">,</span> <span class="nx">captureObj</span><span class="p">[</span> <span class="nx">birthParm</span><span class="p">].</span><span class="nx">y</span><span class="p">);</span>
               
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
               <span class="nx">newBirthState</span><span class="p">[</span> <span class="nx">birthParm</span><span class="p">]</span> <span class="o">=</span> <span class="nx">captureObj</span><span class="p">[</span> <span class="nx">birthParm</span><span class="p">];</span>
            <span class="p">}</span>
         <span class="p">}</span>
      <span class="p">}</span>
      
      <span class="c1">// For all types, override the default naming process, specify a name in the birth parameters. This gives</span>
      <span class="c1">// the new object the name used in the capture object. This is needed in reconstructing </span>
      <span class="c1">// springs (that use the original puck name). This is also needed if pucks are</span>
      <span class="c1">// deleted in a jello matrix.</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">captureObj</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">newBirthState</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">captureObj</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">newBirthState</span><span class="p">;</span>
   <span class="p">}</span>   
   
   <span class="kd">function</span> <span class="nx">restoreFromState</span><span class="p">(</span> <span class="nx">state_data</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">try</span> <span class="p">{</span>
         <span class="c1">// return the template that is returned from restoreFromState_main</span>
         <span class="k">return</span> <span class="nx">restoreFromState_main</span><span class="p">(</span> <span class="nx">state_data</span><span class="p">);</span>
         
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">gW</span><span class="p">.</span><span class="nx">stopit</span><span class="p">();</span>
         
         <span class="kd">let</span> <span class="nx">message</span> <span class="o">=</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoVersion</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;&lt;br&gt;&quot;</span> <span class="o">+</span>
                       <span class="s2">&quot;Unable to restore this capture.&lt;br&gt;&lt;br&gt;&quot;</span> <span class="o">+</span>
                       <span class="s2">&quot;Possibly you&#39;ve been boldly editing the JSON text (that&#39;s good, BTW). &quot;</span> <span class="o">+</span>
                       <span class="s2">&quot;If so, please refine your edits or start from a new capture.&lt;br&gt;&lt;br&gt;&quot;</span> <span class="o">+</span>
                       <span class="s2">&quot;error name: &quot;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot;&lt;br&gt;&quot;</span> <span class="o">+</span>
                       <span class="s2">&quot;error message: &quot;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">;</span>
         <span class="nx">pS</span><span class="p">.</span><span class="nx">viewGeneralDialog</span><span class="p">({</span><span class="s2">&quot;title&quot;</span><span class="o">:</span><span class="s2">&quot;error in capture&quot;</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="o">:</span><span class="nx">message</span><span class="p">,</span> <span class="s2">&quot;label_close&quot;</span><span class="o">:</span><span class="s2">&quot;close&quot;</span><span class="p">});</span>
         
         <span class="nx">dS</span><span class="p">.</span><span class="nx">demoStart</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
      <span class="p">}</span>
   <span class="p">}</span>
      
   <span class="kd">function</span> <span class="nx">restoreFromState_main</span><span class="p">(</span> <span class="nx">state_data</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Environmental parameters...</span>
      
      <span class="c1">// Must do canvas dimensions before setting x_ctx.globalCompositeOperation.</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">state_data</span><span class="p">.</span><span class="nx">canvasDimensions</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">//canvasDiv.style.width = state_data.canvasDimensions.width + &quot;px&quot;;</span>
         <span class="nx">x_canvas</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span>          <span class="nx">state_data</span><span class="p">.</span><span class="nx">canvasDimensions</span><span class="p">.</span><span class="nx">width</span><span class="p">;</span>
         
         <span class="c1">//canvasDiv.style.height = state_data.canvasDimensions.height + &quot;px&quot;;</span>
         <span class="nx">x_canvas</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span>         <span class="nx">state_data</span><span class="p">.</span><span class="nx">canvasDimensions</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span> 
      <span class="p">}</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="nx">state_data</span><span class="p">.</span><span class="nx">globalCompositeOperation</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">x_ctx</span><span class="p">.</span><span class="nx">globalCompositeOperation</span> <span class="o">=</span> <span class="nx">state_data</span><span class="p">.</span><span class="nx">globalCompositeOperation</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="nx">x_ctx</span><span class="p">.</span><span class="nx">globalCompositeOperation</span> <span class="o">=</span> <span class="s1">&#39;source-over&#39;</span><span class="p">;</span>
      <span class="p">}</span>
      
      <span class="nx">gW</span><span class="p">.</span><span class="nx">clearCanvas</span><span class="p">();</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">state_data</span><span class="p">.</span><span class="nx">demoVersion</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">gW</span><span class="p">.</span><span class="nx">setDemoVersion</span><span class="p">(</span> <span class="nx">state_data</span><span class="p">.</span><span class="nx">demoVersion</span><span class="p">);</span>
      <span class="p">}</span>
      
      <span class="c1">// Message the user if the COM setting is changed by the capture restore.</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">state_data</span><span class="p">.</span><span class="nx">comSelection</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">((</span><span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">comSelection</span><span class="p">.</span><span class="nx">checked</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">state_data</span><span class="p">.</span><span class="nx">comSelection</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s1">&#39;Center of mass (COM) selection: [base,yellow]OFF[base]&#39;</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">);</span>
            
         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span> <span class="o">!</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">comSelection</span><span class="p">.</span><span class="nx">checked</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">state_data</span><span class="p">.</span><span class="nx">comSelection</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s1">&#39;Center of mass (COM) selection: [base,yellow]ON[base]&#39;</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">);</span>
         <span class="p">}</span>
         <span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">comSelection</span><span class="p">.</span><span class="nx">checked</span> <span class="o">=</span> <span class="nx">state_data</span><span class="p">.</span><span class="nx">comSelection</span><span class="p">;</span>
         
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">comSelection</span><span class="p">.</span><span class="nx">checked</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s1">&#39;Center of mass (COM) selection: [base,yellow]ON[base]&#39;</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">);</span>
            <span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">comSelection</span><span class="p">.</span><span class="nx">checked</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="c1">//comSelection_Toggle(null, 2);</span>
         <span class="p">}</span>
      <span class="p">}</span>
      
      <span class="c1">// For the count-to-pi demos, set these in gW, BEFORE any table objects are instantiated (so no puck size minimum). </span>
      <span class="c1">// Then, after instantiation, initialize the pi engine (see below).</span>
      <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">state_data</span><span class="p">.</span><span class="nx">piCalcs</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">([</span><span class="s1">&#39;1.c&#39;</span><span class="p">,</span><span class="s1">&#39;1.d&#39;</span><span class="p">,</span><span class="s1">&#39;1.e&#39;</span><span class="p">].</span><span class="nx">includes</span><span class="p">(</span> <span class="nx">dS</span><span class="p">.</span><span class="nx">demoVersionBase</span><span class="p">(</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoVersion</span><span class="p">())))</span> <span class="p">)</span> <span class="p">{</span>
         <span class="nx">gW</span><span class="p">.</span><span class="nx">setPiCalcs</span><span class="p">(</span> <span class="nx">state_data</span><span class="p">.</span><span class="nx">piCalcs</span><span class="p">.</span><span class="nx">enabled</span><span class="p">,</span> <span class="nx">state_data</span><span class="p">.</span><span class="nx">piCalcs</span><span class="p">.</span><span class="nx">clacks</span><span class="p">,</span> <span class="nx">state_data</span><span class="p">.</span><span class="nx">piCalcs</span><span class="p">.</span><span class="nx">usePiEngine</span><span class="p">);</span>
      <span class="p">}</span>      
    
      <span class="c1">// Rebuild the walls from the capture data.</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">wallName</span> <span class="k">in</span> <span class="nx">state_data</span><span class="p">.</span><span class="nx">wallMapData</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">// wall references one specific wall (from the captured state)</span>
         <span class="kd">var</span> <span class="nx">wall</span> <span class="o">=</span> <span class="nx">state_data</span><span class="p">.</span><span class="nx">wallMapData</span><span class="p">[</span> <span class="nx">wallName</span><span class="p">];</span>
         <span class="c1">// Create the new Wall and add it to the wallMap (via its constructor).</span>
         <span class="k">new</span> <span class="nx">cP</span><span class="p">.</span><span class="nx">Wall</span><span class="p">(</span> <span class="nx">wall</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">,</span> <span class="nx">newBirth</span><span class="p">(</span> <span class="nx">wall</span><span class="p">,</span> <span class="s1">&#39;wall&#39;</span><span class="p">));</span>
      <span class="p">}</span>
      <span class="c1">// Establish the name of the top leg of the fence (for use by the PiEngine).</span>
      <span class="k">if</span> <span class="p">((</span><span class="nx">cP</span><span class="p">.</span><span class="nx">Wall</span><span class="p">.</span><span class="nx">topFenceLegName</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">wallMap</span><span class="p">[</span><span class="s1">&#39;wall1&#39;</span><span class="p">]))</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">wallMap</span><span class="p">[</span><span class="s1">&#39;wall1&#39;</span><span class="p">].</span><span class="nx">fence</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">cP</span><span class="p">.</span><span class="nx">Wall</span><span class="p">.</span><span class="nx">topFenceLegName</span> <span class="o">=</span> <span class="s1">&#39;wall1&#39;</span><span class="p">;</span>
            <span class="c1">//console.log(&quot;topFenceLegName=&quot; + cP.Wall.topFenceLegName);</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">//console.log(&quot;wall1 is not part of the fence.&quot;);</span>
         <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="c1">//console.log(&quot;topFenceLegName set by restore&quot;);</span>
      <span class="p">}</span>      
      
      <span class="c1">// NPC clients and host</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">clientName</span> <span class="k">in</span> <span class="nx">state_data</span><span class="p">.</span><span class="nx">clients</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">let</span> <span class="nx">client</span> <span class="o">=</span> <span class="nx">state_data</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span> <span class="nx">clientName</span><span class="p">];</span>
         
         <span class="k">if</span> <span class="p">(</span><span class="nx">clientName</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;NPC&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">new</span> <span class="nx">cT</span><span class="p">.</span><span class="nx">Client</span><span class="p">(</span> <span class="nx">newBirth</span><span class="p">(</span> <span class="nx">client</span><span class="p">,</span> <span class="s1">&#39;NPC&#39;</span><span class="p">));</span>
            
         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">clientName</span> <span class="o">==</span> <span class="s1">&#39;local&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// don&#39;t regenerate the host, it should still be there.</span>
            <span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">color</span> <span class="o">=</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">color</span><span class="p">)</span> <span class="o">?</span> <span class="nx">client</span><span class="p">.</span><span class="nx">color</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
            <span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">bulletAgeLimit_ms</span> <span class="o">=</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">bulletAgeLimit_ms</span><span class="p">)</span> <span class="o">?</span> <span class="nx">client</span><span class="p">.</span><span class="nx">bulletAgeLimit_ms</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
            <span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">ctrlShiftLock</span> <span class="o">=</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">ctrlShiftLock</span><span class="p">)</span> <span class="o">?</span> <span class="nx">client</span><span class="p">.</span><span class="nx">ctrlShiftLock</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>            
            <span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">poolShotLocked</span> <span class="o">=</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">poolShotLocked</span><span class="p">)</span> <span class="o">?</span> <span class="nx">client</span><span class="p">.</span><span class="nx">poolShotLocked</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>            
            <span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">poolShotLockedSpeed_mps</span> <span class="o">=</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">poolShotLockedSpeed_mps</span><span class="p">)</span> <span class="o">?</span> <span class="nx">client</span><span class="p">.</span><span class="nx">poolShotLockedSpeed_mps</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
         <span class="p">}</span>
      <span class="p">}</span>
      
      <span class="c1">// Push (copy) specific local-client attributes (in the capture) to the other human clients.</span>
      <span class="nx">cT</span><span class="p">.</span><span class="nx">Client</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span> <span class="nx">client</span> <span class="p">=&gt;</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;u&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">player</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">client</span><span class="p">.</span><span class="nx">bulletAgeLimit_ms</span> <span class="o">=</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">bulletAgeLimit_ms</span><span class="p">;</span>
         <span class="p">}</span>
      <span class="p">});</span>
      
      <span class="c1">// Rebuild the pins.</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">pinName</span> <span class="k">in</span> <span class="nx">state_data</span><span class="p">.</span><span class="nx">pinMapData</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">// &quot;pin&quot; is one pin (captured state)</span>
         <span class="kd">var</span> <span class="nx">pin</span> <span class="o">=</span> <span class="nx">state_data</span><span class="p">.</span><span class="nx">pinMapData</span><span class="p">[</span> <span class="nx">pinName</span><span class="p">];</span>
         <span class="c1">// Create the new Pin and add it to the pinMap (via its constructor).</span>
         <span class="k">new</span> <span class="nx">cP</span><span class="p">.</span><span class="nx">Pin</span><span class="p">(</span> <span class="nx">pin</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">,</span> <span class="nx">newBirth</span><span class="p">(</span> <span class="nx">pin</span><span class="p">,</span> <span class="s1">&#39;pin&#39;</span><span class="p">));</span>
      <span class="p">}</span>
      
      <span class="c1">// Rebuild the pucks (and the puck map).</span>
      <span class="kd">var</span> <span class="nx">localHostPuckName</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">networkClientName</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">puckNameForTemplate</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">p_key</span> <span class="k">in</span> <span class="nx">state_data</span><span class="p">.</span><span class="nx">puckMapData</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">// puck is a single puck (captured state)</span>
         <span class="kd">var</span> <span class="nx">puck</span> <span class="o">=</span> <span class="nx">state_data</span><span class="p">.</span><span class="nx">puckMapData</span><span class="p">[</span> <span class="nx">p_key</span><span class="p">];</span>
         
         <span class="c1">// If there&#39;s a puck for the local host, record the name for use in returning a puck template.</span>
         <span class="c1">// Also snag a puck name from the network clients as a second option.</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">puck</span><span class="p">.</span><span class="nx">clientName</span> <span class="o">==</span> <span class="s1">&#39;local&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">localHostPuckName</span> <span class="o">=</span> <span class="nx">puck</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="nx">puck</span><span class="p">.</span><span class="nx">clientName</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">puck</span><span class="p">.</span><span class="nx">clientName</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;u&#39;</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">networkClientName</span> <span class="o">=</span> <span class="nx">puck</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
         <span class="p">}</span>
         
         <span class="c1">// Now create the puck and give it the old name (see the end of the newBirth function).</span>
         <span class="c1">// The &quot;Host player&quot; option must be checked to enable the creation of a puck for the local client.</span>
         <span class="c1">// Network-client pucks are not recreation here (because it depends on active network clients for assignment).</span>
         <span class="kd">let</span> <span class="nx">gunBullet</span> <span class="o">=</span> <span class="nx">puck</span><span class="p">.</span><span class="nx">bullet</span> <span class="o">&amp;&amp;</span> <span class="nx">puck</span><span class="p">.</span><span class="nx">ageLimit_ms</span><span class="p">;</span> <span class="c1">// the gunBullet puck method is not available here</span>
         <span class="k">if</span> <span class="p">(</span> <span class="p">(</span> <span class="o">!</span> <span class="p">(</span><span class="nx">gunBullet</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoIndex</span><span class="p">()</span> <span class="o">==</span> <span class="mi">7</span> <span class="o">||</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoIndex</span><span class="p">()</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)))</span> <span class="o">&amp;&amp;</span>   <span class="c1">// NOT a gun bullet in Puck Popper AND </span>
              <span class="p">(</span> <span class="p">(</span><span class="nx">puck</span><span class="p">.</span><span class="nx">clientName</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="o">||</span>                                              <span class="c1">// (Regular puck  OR</span>
                <span class="p">(</span><span class="nx">puck</span><span class="p">.</span><span class="nx">clientName</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;NPC&#39;</span><span class="p">)</span> <span class="o">||</span>                                  <span class="c1">//  Drone puck    OR</span>
                <span class="p">((</span><span class="nx">puck</span><span class="p">.</span><span class="nx">clientName</span> <span class="o">==</span> <span class="s1">&#39;local&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">checked</span><span class="p">))</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>            <span class="c1">//  Local host and puck requested)</span>
            
            <span class="c1">// the remainder operator normalizes the angle to be within +/- 2Pi.</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">puck</span><span class="p">.</span><span class="nx">angle_r</span><span class="p">)</span> <span class="nx">puck</span><span class="p">.</span><span class="nx">angle_r</span> <span class="o">=</span> <span class="nx">puck</span><span class="p">.</span><span class="nx">angle_r</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="p">);</span>
            
            <span class="kd">var</span> <span class="nx">newPuck</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">cP</span><span class="p">.</span><span class="nx">Puck</span><span class="p">(</span> <span class="nx">puck</span><span class="p">.</span><span class="nx">position_2d_m</span><span class="p">,</span> <span class="nx">puck</span><span class="p">.</span><span class="nx">velocity_2d_mps</span><span class="p">,</span> <span class="nx">newBirth</span><span class="p">(</span> <span class="nx">puck</span><span class="p">,</span> <span class="s1">&#39;puck&#39;</span><span class="p">));</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="nx">puck</span><span class="p">.</span><span class="nx">jello</span><span class="p">)</span> <span class="nx">jM</span><span class="p">.</span><span class="nx">addPuck</span><span class="p">(</span> <span class="nx">newPuck</span><span class="p">);</span>
         <span class="p">}</span>
      <span class="p">}</span>
      
      <span class="c1">// For the count-to-pi demos (note: this enabled boolean is set above, before instantiation).</span>
      <span class="k">if</span> <span class="p">(</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">getPiCalcs</span><span class="p">().</span><span class="nx">enabled</span> <span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">state_data</span><span class="p">.</span><span class="nx">piCalcs</span><span class="p">.</span><span class="nx">usePiEngine</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// pi engine</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">state_data</span><span class="p">.</span><span class="nx">piEngine</span><span class="p">)</span> <span class="p">{</span>
               <span class="kd">let</span> <span class="nx">enginePars</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">({},</span> <span class="nx">state_data</span><span class="p">.</span><span class="nx">piEngine</span><span class="p">,</span> <span class="nx">state_data</span><span class="p">.</span><span class="nx">piCalcs</span><span class="p">);</span>
               <span class="nx">pE</span><span class="p">.</span><span class="nx">initializeModule</span><span class="p">(</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">puckMap</span><span class="p">[</span><span class="s1">&#39;puck1&#39;</span><span class="p">],</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">puckMap</span><span class="p">[</span><span class="s1">&#39;puck2&#39;</span><span class="p">],</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">sounds</span><span class="p">[</span><span class="s1">&#39;clack2&#39;</span><span class="p">],</span> <span class="nx">enginePars</span><span class="p">);</span>               
               
            <span class="p">}</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// box2d engine</span>
            <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">puckMap</span><span class="p">[</span><span class="s1">&#39;puck1&#39;</span><span class="p">].</span><span class="nx">vmax</span> <span class="o">=</span> <span class="nx">state_data</span><span class="p">.</span><span class="nx">piCalcs</span><span class="p">.</span><span class="nx">p1_v_max</span><span class="p">;</span>
            <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">collisionCount</span>        <span class="o">=</span> <span class="nx">state_data</span><span class="p">.</span><span class="nx">piCalcs</span><span class="p">.</span><span class="nx">collisionCount</span><span class="p">;</span>         
         <span class="p">}</span>
      <span class="p">}</span>
      
      <span class="c1">// get a reference to a table object using its name</span>
      <span class="kd">function</span> <span class="nx">tableObj</span><span class="p">(</span> <span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">let</span> <span class="nx">first3</span> <span class="o">=</span> <span class="nx">name</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span>
         <span class="kd">let</span> <span class="nx">tableObj</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">first3</span> <span class="o">==</span> <span class="s2">&quot;pin&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">tableObj</span> <span class="o">=</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">pinMap</span><span class="p">[</span> <span class="nx">name</span><span class="p">];</span>
         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">first3</span> <span class="o">==</span> <span class="s2">&quot;puc&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">tableObj</span> <span class="o">=</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">puckMap</span><span class="p">[</span> <span class="nx">name</span><span class="p">];</span>
         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">first3</span> <span class="o">==</span> <span class="s2">&quot;wal&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">tableObj</span> <span class="o">=</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">wallMap</span><span class="p">[</span> <span class="nx">name</span><span class="p">];</span>
         <span class="p">}</span>
         <span class="k">return</span> <span class="nx">tableObj</span><span class="p">;</span>
      <span class="p">}</span>
      
      <span class="c1">// Rebuild the springs.</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">springName</span> <span class="k">in</span> <span class="nx">state_data</span><span class="p">.</span><span class="nx">springMapData</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">var</span> <span class="nx">theSpring</span> <span class="o">=</span> <span class="nx">state_data</span><span class="p">.</span><span class="nx">springMapData</span><span class="p">[</span> <span class="nx">springName</span><span class="p">];</span>
         
         <span class="c1">// Don&#39;t try to restore navigation springs. Those are created</span>
         <span class="c1">// when the NPC pucks are restored.</span>
         <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">theSpring</span><span class="p">.</span><span class="nx">navigationForNPC</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">theSpring</span><span class="p">.</span><span class="nx">forCursor</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">let</span> <span class="nx">p1</span> <span class="o">=</span> <span class="nx">tableObj</span><span class="p">(</span> <span class="nx">theSpring</span><span class="p">.</span><span class="nx">p1_name</span><span class="p">);</span>
            <span class="kd">let</span> <span class="nx">p2</span> <span class="o">=</span> <span class="nx">tableObj</span><span class="p">(</span> <span class="nx">theSpring</span><span class="p">.</span><span class="nx">p2_name</span><span class="p">);</span>
            
            <span class="k">if</span> <span class="p">((</span><span class="nx">p1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">p2</span><span class="p">))</span> <span class="p">{</span>
               <span class="k">new</span> <span class="nx">cP</span><span class="p">.</span><span class="nx">Spring</span><span class="p">(</span><span class="nx">p1</span><span class="p">,</span> <span class="nx">p2</span><span class="p">,</span> <span class="nx">newBirth</span><span class="p">(</span> <span class="nx">theSpring</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">));</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
               <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;WARNING: Attempting to rebuild a spring with one or both connected objects missing.&#39;</span><span class="p">);</span>
            <span class="p">}</span>
            
         <span class="p">}</span>
      <span class="p">}</span>
      <span class="c1">// Rebuild the joints.</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">jointName</span> <span class="k">in</span> <span class="nx">state_data</span><span class="p">.</span><span class="nx">jointMapData</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">var</span> <span class="nx">joint</span> <span class="o">=</span> <span class="nx">state_data</span><span class="p">.</span><span class="nx">jointMapData</span><span class="p">[</span> <span class="nx">jointName</span><span class="p">];</span>
         
         <span class="kd">let</span> <span class="nx">to1</span> <span class="o">=</span> <span class="nx">tableObj</span><span class="p">(</span> <span class="nx">joint</span><span class="p">.</span><span class="nx">jto1_name</span><span class="p">);</span>
         <span class="kd">let</span> <span class="nx">to2</span> <span class="o">=</span> <span class="nx">tableObj</span><span class="p">(</span> <span class="nx">joint</span><span class="p">.</span><span class="nx">jto2_name</span><span class="p">);</span>
         
         <span class="k">if</span> <span class="p">((</span><span class="nx">to1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">to2</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">new</span> <span class="nx">cP</span><span class="p">.</span><span class="nx">Joint</span><span class="p">(</span> <span class="nx">to1</span><span class="p">,</span> <span class="nx">to2</span><span class="p">,</span> <span class="nx">newBirth</span><span class="p">(</span> <span class="nx">joint</span><span class="p">,</span> <span class="s1">&#39;j&#39;</span><span class="p">));</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;WARNING: Attempting to rebuild a joint with one or both connected objects missing.&#39;</span><span class="p">);</span>
         <span class="p">}</span>
      <span class="p">}</span>
      
      <span class="c1">// Note that setGravityRelatedParameters runs at the end of demoStart in demoStart.js.</span>
      <span class="nx">gW</span><span class="p">.</span><span class="nx">setG_ON</span><span class="p">(</span> <span class="nx">state_data</span><span class="p">.</span><span class="nx">gravity</span><span class="p">);</span>
      <span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">gravity</span><span class="p">.</span><span class="nx">checked</span> <span class="o">=</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">getG_ON</span><span class="p">();</span>
      
      <span class="c1">// Give priority to the host&#39;s puck for use as a template. If there was no host puck when</span>
      <span class="c1">// the capture was done, the network puck will be used.</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">localHostPuckName</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">puckNameForTemplate</span> <span class="o">=</span> <span class="nx">localHostPuckName</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="nx">puckNameForTemplate</span> <span class="o">=</span> <span class="nx">networkClientName</span><span class="p">;</span>
      <span class="p">}</span>
      
      <span class="c1">// Sometimes just want to be sure the user gets the fullscreen view.</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">state_data</span><span class="p">.</span><span class="nx">fullScreenDemo</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">gW</span><span class="p">.</span><span class="nx">setFullScreenDemo</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
      <span class="p">}</span>
            
      <span class="c1">// The energy, momentum, and angular momentum report</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">state_data</span><span class="p">.</span><span class="nx">EpL</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">state_data</span><span class="p">.</span><span class="nx">EpL</span><span class="p">.</span><span class="nx">reportType</span><span class="p">)</span> <span class="nx">cP</span><span class="p">.</span><span class="nx">EpL</span><span class="p">.</span><span class="nx">reportType</span> <span class="o">=</span> <span class="nx">state_data</span><span class="p">.</span><span class="nx">EpL</span><span class="p">.</span><span class="nx">reportType</span><span class="p">;</span>
         
         <span class="k">if</span> <span class="p">(</span><span class="nx">state_data</span><span class="p">.</span><span class="nx">EpL</span><span class="p">.</span><span class="nx">COM</span> <span class="o">&amp;&amp;</span> <span class="nx">state_data</span><span class="p">.</span><span class="nx">EpL</span><span class="p">.</span><span class="nx">display</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">cP</span><span class="p">.</span><span class="nx">EpL</span><span class="p">.</span><span class="nx">turnDisplayOn</span><span class="p">({</span><span class="s1">&#39;angularAxis_2d_m&#39;</span><span class="o">:</span> <span class="nx">cP</span><span class="p">.</span><span class="nx">Puck</span><span class="p">.</span><span class="nx">findCenterOfMass</span><span class="p">()});</span>
            <span class="nx">cP</span><span class="p">.</span><span class="nx">EpL</span><span class="p">.</span><span class="nx">COM</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">state_data</span><span class="p">.</span><span class="nx">EpL</span><span class="p">.</span><span class="nx">display</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">state_data</span><span class="p">.</span><span class="nx">EpL</span><span class="p">.</span><span class="nx">angularAxis_2d_m</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">cP</span><span class="p">.</span><span class="nx">EpL</span><span class="p">.</span><span class="nx">turnDisplayOn</span><span class="p">(</span> <span class="p">{</span><span class="s1">&#39;angularAxis_2d_m&#39;</span><span class="o">:</span> <span class="nx">state_data</span><span class="p">.</span><span class="nx">EpL</span><span class="p">.</span><span class="nx">angularAxis_2d_m</span><span class="p">}</span> <span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
               <span class="nx">cP</span><span class="p">.</span><span class="nx">EpL</span><span class="p">.</span><span class="nx">turnDisplayOn</span><span class="p">({});</span>
            <span class="p">}</span>
         <span class="p">}</span>
      <span class="p">}</span>
      
      <span class="c1">// Exit here...</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">puckNameForTemplate</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">return</span> <span class="nx">state_data</span><span class="p">.</span><span class="nx">puckMapData</span><span class="p">[</span> <span class="nx">puckNameForTemplate</span><span class="p">];</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="c1">// Looks like a capture was made after host and all network pucks were popped, savage battle.</span>
         <span class="c1">// So let&#39;s make a puck template from the default pars for the host puck.</span>
         <span class="k">return</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">({},</span> <span class="p">{</span><span class="s1">&#39;position_2d_m&#39;</span><span class="o">:</span><span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">),</span> <span class="s1">&#39;velocity_2d_mps&#39;</span><span class="o">:</span><span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)},</span> <span class="nx">cP</span><span class="p">.</span><span class="nx">Puck</span><span class="p">.</span><span class="nx">hostPars</span><span class="p">);</span>
      <span class="p">}</span> 
   <span class="p">}</span>
   
   <span class="c1">// Note that the filePicker and fileWriter require HTTPS (secure).</span>
   <span class="kd">function</span> <span class="nx">filePicker</span><span class="p">()</span> <span class="p">{</span>
      <span class="c1">// async enlists promise features.</span>
      <span class="nx">async</span> <span class="kd">function</span> <span class="nx">getFile</span><span class="p">()</span> <span class="p">{</span>
         <span class="c1">// m_fileHandle is initialized to &#39;documents&#39; and then becomes a filepicker object which is useful as</span>
         <span class="c1">// a startIn value. This starts the next pick in the directory that the most recent file was picked in.</span>
         <span class="kd">let</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
           <span class="s1">&#39;types&#39;</span><span class="o">:</span> <span class="p">[</span> <span class="p">{</span><span class="s1">&#39;accept&#39;</span><span class="o">:</span> <span class="p">{</span><span class="s1">&#39;text/plain&#39;</span><span class="o">:</span> <span class="s1">&#39;.js&#39;</span><span class="p">}</span> <span class="p">},</span> <span class="p">],</span>
           <span class="s1">&#39;multiple&#39;</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
           <span class="s1">&#39;excludeAcceptAllOption&#39;</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
           <span class="s1">&#39;startIn&#39;</span><span class="o">:</span> <span class="nx">m_fileHandle</span><span class="p">,</span> 
         <span class="p">};</span>
         <span class="c1">// open file picker, destructure (square brackets) the returned array (one element, because multiple:false)</span>
         <span class="p">[</span><span class="nx">m_fileHandle</span><span class="p">]</span> <span class="o">=</span> <span class="nx">await</span> <span class="nb">window</span><span class="p">.</span><span class="nx">showOpenFilePicker</span><span class="p">(</span> <span class="nx">options</span><span class="p">);</span>
         
         <span class="kd">let</span> <span class="nx">file</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">m_fileHandle</span><span class="p">.</span><span class="nx">getFile</span><span class="p">();</span>
         <span class="kd">let</span> <span class="nx">contents</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">file</span><span class="p">.</span><span class="nx">text</span><span class="p">();</span>
         
         <span class="kd">let</span> <span class="nx">jsonString</span> <span class="o">=</span> <span class="p">(</span><span class="nx">contents</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s2">&quot; = &quot;</span><span class="p">))</span> <span class="o">?</span> <span class="nx">contents</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot; = &quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="nx">contents</span><span class="p">;</span>
         <span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">json</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">jsonString</span><span class="p">;</span>
         
         <span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">scrollCaptureArea</span><span class="p">();},</span> <span class="mi">500</span><span class="p">);</span>
         <span class="nx">runCapture</span><span class="p">();</span>
      <span class="p">}</span>                                        
      <span class="nx">getFile</span><span class="p">()</span>
      <span class="p">.</span><span class="nx">then</span><span class="p">(</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
         <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s2">&quot;Thanks for using the file picker.&quot;</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">);</span>     
      <span class="p">})</span>
      <span class="p">.</span><span class="k">catch</span><span class="p">(</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="nx">err</span><span class="p">);</span>
         <span class="kd">let</span> <span class="nx">messageString</span> <span class="o">=</span> <span class="s2">&quot;Picker use declined, failed, or unavailable.&quot;</span><span class="p">;</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">message</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">addToIt</span><span class="p">(</span><span class="s2">&quot;\\ \\&quot;</span> <span class="o">+</span> <span class="nx">messageString</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">);</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span> <span class="nx">messageString</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">);</span>
         <span class="p">}</span>
      <span class="p">});</span>
   <span class="p">}</span>
   <span class="c1">// Note that the filePicker and fileWriter require HTTPS (secure).</span>
   <span class="kd">function</span> <span class="nx">fileWriter</span><span class="p">()</span> <span class="p">{</span>
      <span class="c1">// async enlists promise features.</span>
      <span class="nx">async</span> <span class="kd">function</span> <span class="nx">writeFile</span><span class="p">()</span> <span class="p">{</span>
         <span class="c1">// m_fileHandle is initialized to &#39;documents&#39; and then becomes a filepicker object which is useful as</span>
         <span class="c1">// a startIn value. This starts the next pick in the directory that the most recent file was picked in.</span>
         <span class="kd">let</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
           <span class="s1">&#39;types&#39;</span><span class="o">:</span> <span class="p">[</span> <span class="p">{</span><span class="s1">&#39;accept&#39;</span><span class="o">:</span> <span class="p">{</span><span class="s1">&#39;text/plain&#39;</span><span class="o">:</span> <span class="s1">&#39;.txt&#39;</span><span class="p">}</span> <span class="p">},</span> <span class="p">],</span>
           <span class="s1">&#39;multiple&#39;</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
           <span class="s1">&#39;excludeAcceptAllOption&#39;</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
           <span class="s1">&#39;suggestedName&#39;</span><span class="o">:</span> <span class="s1">&#39;demo.&#39;</span> <span class="o">+</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoVersion</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;.txt&quot;</span><span class="p">,</span>
           <span class="s1">&#39;startIn&#39;</span><span class="o">:</span> <span class="nx">m_fileHandle</span><span class="p">,</span> 
         <span class="p">};</span>
         <span class="c1">// open handle to the destination folder </span>
         <span class="nx">m_fileHandle</span> <span class="o">=</span> <span class="nx">await</span> <span class="nb">window</span><span class="p">.</span><span class="nx">showSaveFilePicker</span><span class="p">(</span> <span class="nx">options</span><span class="p">);</span>
         <span class="kr">const</span> <span class="nx">writable</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">m_fileHandle</span><span class="p">.</span><span class="nx">createWritable</span><span class="p">();</span>
         <span class="nx">await</span> <span class="nx">writable</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s2">&quot;demo_capture = &quot;</span> <span class="o">+</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">json</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
         <span class="nx">await</span> <span class="nx">writable</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
      <span class="p">}</span>                                        
      <span class="nx">writeFile</span><span class="p">()</span>
      <span class="p">.</span><span class="nx">then</span><span class="p">(</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">json</span><span class="p">.</span><span class="nx">value</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s2">&quot;Thanks for using the file writer.&quot;</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">);</span>     
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s2">&quot;The file was written but note that &quot;</span> <span class="o">+</span> 
                                         <span class="s2">&quot;\\the capture text area appears to be empty.&quot;</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">);</span>
         <span class="p">}</span> 
      <span class="p">})</span>
      <span class="p">.</span><span class="k">catch</span><span class="p">(</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="nx">err</span><span class="p">);</span>
         <span class="kd">let</span> <span class="nx">messageString</span> <span class="o">=</span> <span class="s2">&quot;File-writer use declined, failed, or unavailable.&quot;</span><span class="p">;</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">message</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">addToIt</span><span class="p">(</span><span class="s2">&quot;\\ \\&quot;</span> <span class="o">+</span> <span class="nx">messageString</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">);</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span> <span class="nx">messageString</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">);</span>
         <span class="p">}</span>
      <span class="p">});</span>
   <span class="p">}</span>
   
   
   <span class="nx">async</span> <span class="kd">function</span> <span class="nx">checkForFile</span><span class="p">(</span> <span class="nx">demoFileName</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;status&#39;</span><span class="o">:</span><span class="kc">null</span><span class="p">,</span> <span class="s1">&#39;fileText&#39;</span><span class="o">:</span><span class="kc">null</span><span class="p">};</span>
      
      <span class="c1">// A fetch check to see if the file is here, on this webserver.</span>
      <span class="k">try</span> <span class="p">{</span>
         <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;demoFileName = &quot;</span> <span class="o">+</span> <span class="nx">demoFileName</span><span class="p">);</span>
         
         <span class="kr">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">fetch</span><span class="p">(</span> <span class="nx">demoFileName</span><span class="p">);</span> <span class="c1">// , {method: &#39;HEAD&#39;}</span>
         <span class="kr">const</span> <span class="nx">content</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">response</span><span class="p">.</span><span class="nx">text</span><span class="p">();</span>
         
         <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;response.status = &quot;</span> <span class="o">+</span> <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">);</span>
         <span class="c1">//console.log(&quot;content = &quot; + content);</span>
         
         <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">404</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// A clear indication that the file by that name is not there.</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;webserver fetch: file not found (404)&quot;</span><span class="p">);</span>
            <span class="nx">result</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="s2">&quot;file not found&quot;</span><span class="p">;</span>
            
         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;webserver fetch: ok, maybe found file.&quot;</span><span class="p">);</span>
            
            <span class="c1">// Check the contents to see if it looks like a typical capture file on the server.</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">content</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s2">&quot;demoVersion&quot;</span><span class="p">))</span> <span class="p">{</span>
               <span class="nx">result</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="s2">&quot;file exists&quot;</span><span class="p">;</span>
               <span class="nx">result</span><span class="p">.</span><span class="nx">fileText</span> <span class="o">=</span> <span class="nx">content</span><span class="p">;</span>
            
            <span class="c1">// Not a capture, so must be a default file on the server, probably index.html.</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
               <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;probably got index.html&quot;</span><span class="p">);</span>
               <span class="nx">result</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="s2">&quot;file not found&quot;</span><span class="p">;</span>
            <span class="p">}</span>
            
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;webserver fetch: NOT ok&quot;</span><span class="p">);</span>
            <span class="nx">result</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="s2">&quot;file not found&quot;</span><span class="p">;</span>
         <span class="p">}</span>
         
      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;---Error caught in Fetch file check.---&quot;</span><span class="p">);</span>
         <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span> <span class="nx">error</span><span class="p">);</span>
         <span class="nx">result</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="s2">&quot;error caught&quot;</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
   <span class="p">}</span>
   
   <span class="kd">function</span> <span class="nx">switchToTheChatPanel</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">multiplayer</span><span class="p">.</span><span class="nx">checked</span><span class="p">)</span> <span class="p">{</span>  
         <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#chkMultiplayer&quot;</span><span class="p">).</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">&quot;click&quot;</span><span class="p">);</span>
      <span class="p">}</span>      
   <span class="p">}</span>
   
   <span class="nx">async</span> <span class="kd">function</span> <span class="nx">postCaptureToCF</span><span class="p">(</span> <span class="nx">pars</span><span class="o">=</span><span class="p">{})</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">action</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">action</span><span class="p">,</span> <span class="s2">&quot;list&quot;</span><span class="p">);</span>
      <span class="kd">let</span> <span class="nx">actionType</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">actionType</span><span class="p">,</span> <span class="s2">&quot;normal&quot;</span><span class="p">);</span>
      <span class="kd">let</span> <span class="nx">downLoadKey</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">downLoadKey</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span> <span class="c1">// key for KV (key-value) storage at Cloudflare </span>
      
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;inside poster v25, key = &quot;</span> <span class="o">+</span> <span class="nx">downLoadKey</span><span class="p">);</span>
      
      <span class="kd">let</span> <span class="nx">workerURL</span> <span class="o">=</span> <span class="s2">&quot;https://triquence.org/captures/submit&quot;</span><span class="p">;</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="nx">action</span> <span class="o">==</span> <span class="s2">&quot;postOne&quot;</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">// Check for valid JSON in textarea.</span>
         <span class="kd">let</span> <span class="nx">captureObject</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
         <span class="nx">captureObject</span> <span class="o">=</span> <span class="nx">loadJSON</span><span class="p">(</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">json</span><span class="p">);</span>
         <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">captureObject</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
         
         <span class="nx">switchToTheChatPanel</span><span class="p">();</span>
         
         <span class="c1">// check the form of the version-name string</span>
         <span class="kr">const</span> <span class="nx">pattern</span> <span class="o">=</span> <span class="sr">/^[0-9]\.[a-z]\.(?:[a-zA-Z0-9-]+\.?)+[a-zA-Z0-9-]+$/</span><span class="p">;</span>
         <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">pattern</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span> <span class="nx">captureObject</span><span class="p">.</span><span class="nx">demoVersion</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">hC</span><span class="p">.</span><span class="nx">displayMessage</span><span class="p">(</span><span class="s2">&quot;Names for cloud posts should have three (or more) parts.&lt;br&gt;&lt;br&gt;&quot;</span> <span class="o">+</span>
              <span class="s2">&quot;Examples:&lt;br&gt;&quot;</span> <span class="o">+</span> 
              <span class="s2">&quot;1.b.new-one &lt;br&gt;2.c.my-version &lt;br&gt;9.b.no-fence &lt;br&gt;3.d.9ball.big-twist&lt;br&gt;&lt;br&gt;&quot;</span> <span class="o">+</span>
              <span class="s1">&#39;The idea is to start the name with a reference to a similar demo. This should have two parts: a single digit, and a single letter.&lt;br&gt;&lt;br&gt;&#39;</span> <span class="o">+</span>
              <span class="s1">&#39;Then add a third part that uniquely describes your capture. This can be multiple words separated with dashes.&lt;br&gt;&lt;br&gt;&#39;</span> <span class="o">+</span>
              <span class="s1">&#39;You establish this name by editing the &quot;demoVersion&quot; in the capture. &#39;</span> <span class="o">+</span>
              <span class="s1">&#39;You may also need to edit the &quot;demoIndex&quot; (located above &quot;demoVersion&quot;) so that the index matches the digit in the name.&lt;br&gt;&lt;br&gt;&#39;</span> <span class="o">+</span>
              <span class="s1">&#39;(Note: right click in the capture area for a larger view.)&#39;</span>
            <span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
         <span class="p">}</span>
         <span class="kd">let</span> <span class="nx">indexInDemoVersion</span> <span class="o">=</span> <span class="nx">captureObject</span><span class="p">.</span><span class="nx">demoVersion</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">indexInDemoVersion</span> <span class="o">!=</span> <span class="nx">captureObject</span><span class="p">.</span><span class="nx">demoIndex</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">hC</span><span class="p">.</span><span class="nx">displayMessage</span><span class="p">(</span><span class="s2">&quot;In the capture, the index in the demo version name (&quot;</span><span class="o">+</span> <span class="nx">indexInDemoVersion</span> <span class="o">+</span><span class="s2">&quot;) does not match the value of demoIndex (&quot;</span><span class="o">+</span> <span class="nx">captureObject</span><span class="p">.</span><span class="nx">demoIndex</span> <span class="o">+</span><span class="s2">&quot;).&quot;</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
         <span class="p">}</span> 
         
         <span class="c1">// Based on actionType in pars, pick which of the three variations of postOne: deleteOne, updateOne, and postOne.</span>
         <span class="c1">// Make it a little harder to delete captures.</span>
         <span class="kd">let</span> <span class="nx">nickName</span> <span class="o">=</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="s2">&quot;local&quot;</span><span class="p">].</span><span class="nx">nickName</span><span class="p">)</span> <span class="o">?</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="s2">&quot;local&quot;</span><span class="p">].</span><span class="nx">nickName</span> <span class="o">:</span> <span class="s2">&quot;host&quot;</span><span class="p">;</span>
         
         <span class="k">if</span> <span class="p">(</span><span class="nx">actionType</span> <span class="o">==</span> <span class="s2">&quot;delete&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">nickName</span> <span class="o">==</span> <span class="s2">&quot;jim&quot;</span><span class="p">)</span> <span class="p">{</span>                  
               <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#chkC19&#39;</span><span class="p">).</span><span class="nx">prop</span><span class="p">(</span><span class="s1">&#39;checked&#39;</span><span class="p">))</span> <span class="p">{</span>
                  <span class="nx">action</span> <span class="o">=</span> <span class="s2">&quot;deleteOne&quot;</span><span class="p">;</span>
                  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;deleteOne request&quot;</span><span class="p">);</span>
               <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                  <span class="nx">hC</span><span class="p">.</span><span class="nx">displayMessage</span><span class="p">(</span><span class="s2">&quot;We can&#39;t delete Jim&#39;s posts.&quot;</span><span class="p">);</span>
                  <span class="k">return</span><span class="p">;</span>
               <span class="p">}</span>                  
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
               <span class="nx">action</span> <span class="o">=</span> <span class="s2">&quot;deleteOne&quot;</span><span class="p">;</span>
               <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;deleteOne request&quot;</span><span class="p">);</span>
            <span class="p">}</span> 
            
         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">actionType</span> <span class="o">==</span> <span class="s2">&quot;update&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">action</span> <span class="o">=</span> <span class="s2">&quot;updateOne&quot;</span><span class="p">;</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;updateOne request&quot;</span><span class="p">);</span>
               
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">action</span> <span class="o">=</span> <span class="s2">&quot;postOne&quot;</span><span class="p">;</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;normal postOne request&quot;</span><span class="p">);</span>
         <span class="p">}</span>
         
         <span class="c1">// Check if new stuff, by name and by content. Cloud posts should not be copies</span>
         <span class="c1">// of capture files on the web server.</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">action</span> <span class="o">==</span> <span class="s2">&quot;postOne&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Determine the corresponding filename from the demoVersion string.</span>
            <span class="kd">let</span> <span class="nx">demoName</span> <span class="o">=</span> <span class="nx">captureObject</span><span class="p">.</span><span class="nx">demoVersion</span><span class="p">;</span>
            <span class="kd">let</span> <span class="nx">parts</span> <span class="o">=</span> <span class="nx">demoName</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">);</span>
            <span class="kd">let</span> <span class="nx">demoFileName</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;demoName = &#39;</span> <span class="o">+</span> <span class="nx">demoName</span> <span class="o">+</span> <span class="s2">&quot;, n=&quot;</span> <span class="o">+</span> <span class="nx">parts</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
            <span class="c1">// This first check should also be covered by the regular expression above...</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">parts</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">hC</span><span class="p">.</span><span class="nx">displayMessage</span><span class="p">(</span><span class="s2">&quot;names for posts should have at least 3 parts, e.g. 1.b.coolone &quot;</span><span class="p">);</span>
               <span class="k">return</span><span class="p">;</span>
               
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">parts</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
               <span class="c1">// e.g. 3.a.333  --&gt; demo3a.333.js  </span>
               <span class="c1">//  or  5.b.rube --&gt; demo5b.rube.js</span>
               <span class="nx">demoFileName</span> <span class="o">=</span> <span class="s2">&quot;demo&quot;</span> <span class="o">+</span> <span class="nx">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nx">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="nx">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.js&quot;</span><span class="p">;</span>
               
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">parts</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
               <span class="c1">// e.g. 5.b.rube.334 --&gt; demo5b.rube.334.js</span>
               <span class="nx">demoFileName</span> <span class="o">=</span> <span class="s2">&quot;demo&quot;</span> <span class="o">+</span> <span class="nx">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nx">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
               <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">index</span> <span class="k">in</span> <span class="nx">parts</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">if</span> <span class="p">(</span><span class="nx">index</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="nx">demoFileName</span> <span class="o">+=</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="nx">parts</span><span class="p">[</span> <span class="nx">index</span><span class="p">];</span>
               <span class="p">}</span>
               <span class="nx">demoFileName</span> <span class="o">+=</span> <span class="s2">&quot;.js&quot;</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">demoFileName</span> <span class="o">==</span> <span class="s2">&quot;demo3d.9ball.js&quot;</span><span class="p">)</span> <span class="nx">demoFileName</span> <span class="o">=</span> <span class="s2">&quot;demo3d.js&quot;</span><span class="p">;</span> <span class="c1">// special case</span>
            
            <span class="kd">let</span> <span class="nx">fileCheckResult</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">checkForFile</span><span class="p">(</span> <span class="nx">demoFileName</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">fileCheckResult</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="s2">&quot;file exists&quot;</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">hC</span><span class="p">.</span><span class="nx">displayMessage</span><span class="p">(</span><span class="s2">&quot;This file exists as a demo on the webserver. Please post something new.&quot;</span><span class="p">);</span>
               <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
               <span class="cm">/*</span>
<span class="cm">               Use checkForFile to fetch the base version and compare the content to see if the user has simply renamed a base demo:</span>
<span class="cm">                  Remove &quot;demo_capture = &quot; from the file text.</span>
<span class="cm">                  Parse it into an object.</span>
<span class="cm">                  Replace the version string in the file text to be the base.</span>
<span class="cm">                  Do a formated stringify.</span>
<span class="cm">                  Then compare to the capture in textarea.</span>
<span class="cm">               */</span>
               <span class="kd">let</span> <span class="nx">baseFileName</span> <span class="o">=</span> <span class="s2">&quot;demo&quot;</span> <span class="o">+</span> <span class="nx">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nx">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.js&quot;</span><span class="p">;</span>
               <span class="kd">let</span> <span class="nx">fileContentCheck</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">checkForFile</span><span class="p">(</span> <span class="nx">baseFileName</span><span class="p">);</span>
               
               <span class="k">if</span> <span class="p">(</span><span class="nx">fileContentCheck</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="s2">&quot;file exists&quot;</span><span class="p">)</span> <span class="p">{</span>
                  <span class="kd">let</span> <span class="nx">contentText</span> <span class="o">=</span> <span class="nx">fileContentCheck</span><span class="p">.</span><span class="nx">fileText</span><span class="p">;</span>
                  <span class="c1">// Remove the global assignment at the beginning of the file.</span>
                  <span class="nx">contentText</span> <span class="o">=</span> <span class="nx">contentText</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s2">&quot;demo_capture = &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">);</span>
                  
                  <span class="c1">// To facilitate a simple content comparison, make the names the same, and then format the JSON.</span>
                  <span class="kd">let</span> <span class="nx">contentObject</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span> <span class="nx">contentText</span><span class="p">);</span>
                  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;name in file = &quot;</span> <span class="o">+</span> <span class="nx">contentObject</span><span class="p">.</span><span class="nx">demoVersion</span><span class="p">);</span>
                  <span class="nx">contentObject</span><span class="p">.</span><span class="nx">demoVersion</span> <span class="o">=</span> <span class="nx">demoName</span><span class="p">;</span>
                  <span class="kd">let</span> <span class="nx">formatedText</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span> <span class="nx">contentObject</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
                  <span class="k">if</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">json</span><span class="p">.</span><span class="nx">value</span> <span class="o">==</span> <span class="nx">formatedText</span><span class="p">)</span> <span class="p">{</span>
                     <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Looks identical to the base demo content.&quot;</span><span class="p">);</span>
                     <span class="nx">hC</span><span class="p">.</span><span class="nx">displayMessage</span><span class="p">(</span><span class="s2">&quot;This capture looks equivalent to the content in the base demo. Please post something new.&quot;</span><span class="p">);</span>
                     <span class="k">return</span><span class="p">;</span>
                  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                     <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Looks like fresh stuff.&quot;</span><span class="p">);</span>
                  <span class="p">}</span>
                  
               <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;base file not found: &quot;</span> <span class="o">+</span> <span class="nx">baseFileName</span><span class="p">);</span>
               <span class="p">}</span>
            <span class="p">}</span>
         <span class="p">}</span>
         
         <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;demo version = &quot;</span> <span class="o">+</span> <span class="nx">captureObject</span><span class="p">.</span><span class="nx">demoVersion</span><span class="p">);</span>
      
         <span class="kd">let</span> <span class="nx">keyName</span> <span class="o">=</span> <span class="nx">captureObject</span><span class="p">.</span><span class="nx">demoVersion</span> <span class="o">+</span> <span class="s2">&quot;__&quot;</span> <span class="o">+</span> <span class="nx">nickName</span><span class="p">;</span>
         <span class="kd">let</span> <span class="nx">postObject</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;keyName&quot;</span><span class="o">:</span><span class="nx">keyName</span><span class="p">,</span> <span class="s2">&quot;action&quot;</span><span class="o">:</span><span class="nx">action</span><span class="p">,</span> <span class="s2">&quot;capture&quot;</span><span class="o">:</span><span class="nx">captureObject</span><span class="p">};</span>
         <span class="nx">postObject</span><span class="p">.</span><span class="nx">expiration</span> <span class="o">=</span> <span class="p">(</span><span class="nx">nickName</span> <span class="o">==</span> <span class="s2">&quot;host&quot;</span><span class="p">)</span> <span class="o">?</span> <span class="mi">259200</span> <span class="o">:</span> <span class="s2">&quot;never&quot;</span><span class="p">;</span> <span class="c1">// 3 days</span>

         <span class="kr">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">fetch</span><span class="p">(</span> <span class="nx">workerURL</span><span class="p">,</span> <span class="p">{</span>
            <span class="s1">&#39;method&#39;</span><span class="o">:</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span>
            <span class="s1">&#39;headers&#39;</span><span class="o">:</span> <span class="p">{</span>
               <span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;application/json&#39;</span>
            <span class="p">},</span>
            <span class="s1">&#39;body&#39;</span><span class="o">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span> <span class="nx">postObject</span><span class="p">)</span>
         <span class="p">});</span> 

         <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">let</span> <span class="nx">jsonInResponse</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
            <span class="c1">//console.log(&quot;response sender = &quot; + JSON.stringify( jsonInResponse.sender));</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;response sender = &quot;</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span> <span class="nx">jsonInResponse</span><span class="p">));</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="nx">jsonInResponse</span><span class="p">.</span><span class="nx">action</span> <span class="o">==</span> <span class="s2">&quot;postOne&quot;</span><span class="p">)</span> <span class="p">{</span> 
               <span class="k">if</span> <span class="p">(</span><span class="nx">jsonInResponse</span><span class="p">.</span><span class="nx">foundOne</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">hC</span><span class="p">.</span><span class="nx">displayMessage</span><span class="p">(</span><span class="s2">&quot;Cloud capture found. That name is in use. If you&#39;re trying to update an existing capture, hold the shift key down while clicking the &#39;P&#39; button.&quot;</span><span class="p">);</span>
                  
               <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                  <span class="nx">hC</span><span class="p">.</span><span class="nx">displayMessage</span><span class="p">(</span><span class="s2">&quot;Capture &lt;strong&gt;&quot;</span> <span class="o">+</span> <span class="nx">captureObject</span><span class="p">.</span><span class="nx">demoVersion</span> <span class="o">+</span> <span class="s2">&quot;&lt;/strong&gt; posted to Cloud storage for &lt;strong&gt;&quot;</span> <span class="o">+</span> <span class="nx">nickName</span> <span class="o">+</span> <span class="s2">&quot;&lt;/strong&gt;.&lt;br&gt;&quot;</span> <span class="o">+</span>
                     <span class="s2">&quot;Note: it may take 1 to 20 seconds to affect the listing.&quot;</span><span class="p">);</span>
                  <span class="k">if</span> <span class="p">(</span><span class="nx">nickName</span> <span class="o">==</span> <span class="s2">&quot;host&quot;</span><span class="p">)</span> <span class="nx">hC</span><span class="p">.</span><span class="nx">displayMessage</span><span class="p">(</span><span class="s2">&quot;Note that &lt;strong&gt;anonymous cloud posts&lt;/strong&gt; (using the default nickname of &#39;host&#39;) &lt;strong&gt;expire&lt;/strong&gt; (self delete) in 3 days.&quot;</span><span class="p">);</span>
                  
               <span class="p">}</span>
               
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">jsonInResponse</span><span class="p">.</span><span class="nx">action</span> <span class="o">==</span> <span class="s2">&quot;updateOne&quot;</span><span class="p">)</span> <span class="p">{</span>
               <span class="k">if</span> <span class="p">(</span><span class="nx">jsonInResponse</span><span class="p">.</span><span class="nx">foundOne</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">if</span> <span class="p">(</span><span class="nx">jsonInResponse</span><span class="p">.</span><span class="nx">updated</span><span class="p">)</span> <span class="p">{</span>
                     <span class="nx">hC</span><span class="p">.</span><span class="nx">displayMessage</span><span class="p">(</span><span class="s2">&quot;Cloud capture found and updated.&quot;</span><span class="p">);</span>
                  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                     <span class="nx">hC</span><span class="p">.</span><span class="nx">displayMessage</span><span class="p">(</span><span class="s2">&quot;Cloud capture found, but no change detected. Update not needed.&quot;</span><span class="p">);</span>
                  <span class="p">}</span>
                  
               <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                  <span class="nx">hC</span><span class="p">.</span><span class="nx">displayMessage</span><span class="p">(</span><span class="s2">&quot;Cloud capture not found. You may need to do an initial post (without the shift key down). Then updates should work.&quot;</span><span class="p">);</span>
                  
               <span class="p">}</span>
               
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">jsonInResponse</span><span class="p">.</span><span class="nx">action</span> <span class="o">==</span> <span class="s2">&quot;deleteOne&quot;</span><span class="p">)</span> <span class="p">{</span>
               <span class="k">if</span> <span class="p">(</span><span class="nx">jsonInResponse</span><span class="p">.</span><span class="nx">deleted</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">hC</span><span class="p">.</span><span class="nx">displayMessage</span><span class="p">(</span><span class="s2">&quot;Cloud capture &lt;strong&gt;&quot;</span> <span class="o">+</span> <span class="nx">captureObject</span><span class="p">.</span><span class="nx">demoVersion</span> <span class="o">+</span> <span class="s2">&quot;&lt;/strong&gt; found and deleted for &lt;strong&gt;&quot;</span> <span class="o">+</span> <span class="nx">nickName</span> <span class="o">+</span> <span class="s2">&quot;&lt;/strong&gt;.&lt;br&gt;&quot;</span> <span class="o">+</span>
                     <span class="s2">&quot;Note: it may take 1 to 20 seconds to affect the listing.&quot;</span><span class="p">);</span>
                  
               <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                  <span class="nx">hC</span><span class="p">.</span><span class="nx">displayMessage</span><span class="p">(</span><span class="s2">&quot;Didn&#39;t find &lt;strong&gt;&quot;</span> <span class="o">+</span> 
                     <span class="nx">captureObject</span><span class="p">.</span><span class="nx">demoVersion</span> <span class="o">+</span> <span class="s2">&quot;&lt;/strong&gt; under your nickname (&lt;strong&gt;&quot;</span> <span class="o">+</span> <span class="nx">nickName</span> <span class="o">+</span> <span class="s2">&quot;&lt;/strong&gt;). &lt;br&gt;&quot;</span> <span class="o">+</span> 
                     <span class="s2">&quot;You may need to specify (or change) your nickname and try again.&quot;</span><span class="p">);</span>
               <span class="p">}</span>
            <span class="p">}</span>
            
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">hC</span><span class="p">.</span><span class="nx">displayMessage</span><span class="p">(</span><span class="s2">&quot;Looks like there&#39;s a problem connecting to CloudFlare.&quot;</span><span class="p">);</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;response NOT ok (CF worker)&quot;</span><span class="p">);</span>  
         <span class="p">}</span> 
         
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">action</span> <span class="o">==</span> <span class="s2">&quot;downLoadOne&quot;</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">let</span> <span class="nx">postObject</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="o">:</span><span class="nx">action</span><span class="p">,</span> <span class="s2">&quot;keyName&quot;</span><span class="o">:</span><span class="nx">downLoadKey</span><span class="p">};</span>

         <span class="kr">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">fetch</span><span class="p">(</span> <span class="nx">workerURL</span><span class="p">,</span> <span class="p">{</span>
            <span class="s1">&#39;method&#39;</span><span class="o">:</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span>
            <span class="s1">&#39;headers&#39;</span><span class="o">:</span> <span class="p">{</span>
               <span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;application/json&#39;</span>
            <span class="p">},</span>
            <span class="s1">&#39;body&#39;</span><span class="o">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span> <span class="nx">postObject</span><span class="p">)</span>
         <span class="p">});</span> 

         <span class="nx">switchToTheChatPanel</span><span class="p">();</span>

         <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">let</span> <span class="nx">jsonInResponse</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;response sender = &quot;</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span> <span class="nx">jsonInResponse</span><span class="p">.</span><span class="nx">sender</span><span class="p">));</span>
            
            <span class="c1">// Write to the textarea element.</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">jsonInResponse</span><span class="p">.</span><span class="nx">foundIt</span><span class="p">)</span> <span class="p">{</span>
               <span class="c1">// keep the original of the most recent capture for capture-edit checking</span>
               <span class="nx">m_cloudCapture</span><span class="p">.</span><span class="nx">object</span> <span class="o">=</span> <span class="nx">jsonInResponse</span><span class="p">.</span><span class="nx">capture</span><span class="p">;</span>
               <span class="nx">m_cloudCapture</span><span class="p">.</span><span class="nx">string</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span> <span class="nx">jsonInResponse</span><span class="p">.</span><span class="nx">capture</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
               
               <span class="c1">// give it to the user (put the string in the textarea).</span>
               <span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">json</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">m_cloudCapture</span><span class="p">.</span><span class="nx">string</span><span class="p">;</span>
               
               <span class="nx">runCapture</span><span class="p">();</span>
               
               <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s2">&quot;Capture downloaded.&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
               
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
               <span class="nx">hC</span><span class="p">.</span><span class="nx">displayMessage</span><span class="p">(</span><span class="s2">&quot;Capture not found.&quot;</span><span class="p">);</span>
            <span class="p">}</span>
            
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">hC</span><span class="p">.</span><span class="nx">displayMessage</span><span class="p">(</span><span class="s2">&quot;Looks like there&#39;s a problem connecting to CloudFlare.&quot;</span><span class="p">);</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;response NOT ok&quot;</span><span class="p">);</span>  
         <span class="p">}</span> 
         
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">action</span> <span class="o">==</span> <span class="s2">&quot;list&quot;</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">switchToTheChatPanel</span><span class="p">();</span>
         
         <span class="kd">let</span> <span class="nx">searchString</span> <span class="o">=</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">].</span><span class="nx">key_shift</span> <span class="o">==</span> <span class="s2">&quot;D&quot;</span><span class="p">)</span> <span class="o">?</span> <span class="s2">&quot;&quot;</span> <span class="o">:</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoIndex</span><span class="p">();</span>
         <span class="kd">let</span> <span class="nx">postObject</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;action&quot;</span><span class="o">:</span><span class="nx">action</span><span class="p">,</span> <span class="s2">&quot;searchString&quot;</span><span class="o">:</span><span class="nx">searchString</span><span class="p">};</span>

         <span class="kr">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">fetch</span><span class="p">(</span> <span class="nx">workerURL</span><span class="p">,</span> <span class="p">{</span>
            <span class="s1">&#39;method&#39;</span><span class="o">:</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span>
            <span class="s1">&#39;headers&#39;</span><span class="o">:</span> <span class="p">{</span>
               <span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;application/json&#39;</span>
            <span class="p">},</span>
            <span class="s1">&#39;body&#39;</span><span class="o">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span> <span class="nx">postObject</span><span class="p">)</span>
         <span class="p">});</span> 

         <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">let</span> <span class="nx">jsonInResponse</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;response sender = &quot;</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span> <span class="nx">jsonInResponse</span><span class="p">.</span><span class="nx">sender</span><span class="p">));</span>
            <span class="cm">/*</span>
<span class="cm">            structure of the KW list</span>
<span class="cm">              &quot;keys&quot;: [</span>
<span class="cm">                {</span>
<span class="cm">                  &quot;name&quot;: &quot;foo&quot;,</span>
<span class="cm">                  &quot;expiration&quot;: 1234,</span>
<span class="cm">                  &quot;metadata&quot;: { &quot;someMetadataKey&quot;: &quot;someMetadataValue&quot; }</span>
<span class="cm">                }</span>
<span class="cm">              ],</span>
<span class="cm">              &quot;list_complete&quot;: false,</span>
<span class="cm">              &quot;cursor&quot;: &quot;6Ck1la0VxJ0djhidm1MdX2FyD&quot;</span>
<span class="cm">            */</span>     
            <span class="k">if</span> <span class="p">(</span><span class="nx">jsonInResponse</span><span class="p">.</span><span class="nx">captureList</span><span class="p">.</span><span class="nx">keys</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
               <span class="kd">let</span> <span class="nx">tableString</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">+</span> 
                  <span class="s2">&quot;&lt;table class=&#39;score&#39;&gt;&lt;tr align=&#39;right&#39;&gt;&quot;</span> <span class="o">+</span>
                  <span class="s2">&quot;&lt;td class=&#39;scoreHeader&#39; title=&#39;capture name, click to download and run&#39;&gt;capture&lt;/td&gt;&quot;</span> <span class="o">+</span>
                  <span class="s2">&quot;&lt;td class=&#39;scoreHeader&#39; title=&#39;user nickname, default (for anonymous) is host&#39;&gt;nickname&lt;/td&gt;&quot;</span> <span class="o">+</span>
                  <span class="s2">&quot;&lt;/tr&gt;&quot;</span><span class="p">;</span>
               <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">index</span> <span class="k">in</span> <span class="nx">jsonInResponse</span><span class="p">.</span><span class="nx">captureList</span><span class="p">.</span><span class="nx">keys</span><span class="p">)</span> <span class="p">{</span>
                  <span class="kd">let</span> <span class="nx">keyObject</span> <span class="o">=</span> <span class="nx">jsonInResponse</span><span class="p">.</span><span class="nx">captureList</span><span class="p">.</span><span class="nx">keys</span><span class="p">[</span> <span class="nx">index</span><span class="p">];</span>
                  <span class="kd">let</span> <span class="nx">clickCommandString</span> <span class="o">=</span> <span class="s2">&quot;cR.postCaptureToCF({&#39;action&#39;:&#39;downLoadOne&#39;,&#39;downLoadKey&#39;:&#39;&quot;</span> <span class="o">+</span> <span class="nx">keyObject</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot;&#39;})&quot;</span><span class="p">;</span>
                  <span class="kd">let</span> <span class="nx">demoName</span> <span class="o">=</span> <span class="nx">keyObject</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
                  <span class="kd">let</span> <span class="nx">userName</span> <span class="o">=</span> <span class="nx">keyObject</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>
                  <span class="nx">userName</span> <span class="o">=</span> <span class="p">(</span><span class="nx">userName</span><span class="p">)</span> <span class="o">?</span> <span class="nx">userName</span> <span class="o">:</span> <span class="s2">&quot;???&quot;</span><span class="p">;</span>
                  
                  <span class="kd">let</span> <span class="nx">linkString</span> <span class="o">=</span> <span class="s2">&quot;&lt;a onclick=&quot;</span> <span class="o">+</span> <span class="nx">clickCommandString</span> <span class="o">+</span> <span class="s2">&quot;&gt;&quot;</span> <span class="o">+</span> <span class="nx">demoName</span> <span class="o">+</span> <span class="s2">&quot;&lt;/a&gt;&quot;</span><span class="p">;</span>
                  <span class="nx">tableString</span> <span class="o">+=</span> <span class="s2">&quot;&lt;tr align=&#39;right&#39;&gt;&quot;</span> <span class="o">+</span> 
                  <span class="s2">&quot;&lt;td class=&#39;score edits&#39;&gt;&quot;</span> <span class="o">+</span> <span class="nx">linkString</span> <span class="o">+</span> <span class="s2">&quot;&lt;/td&gt;&quot;</span> <span class="o">+</span> 
                  <span class="s2">&quot;&lt;td class=&#39;score&#39;&gt;&quot;</span> <span class="o">+</span> <span class="nx">userName</span> <span class="o">+</span> <span class="s2">&quot;&lt;/td&gt;&quot;</span> <span class="o">+</span> 
                  <span class="s2">&quot;&lt;/tr&gt;&quot;</span><span class="p">;</span>
               <span class="p">}</span>
               <span class="nx">tableString</span> <span class="o">+=</span> <span class="s2">&quot;&lt;/table&gt;&quot;</span>
               <span class="nx">hC</span><span class="p">.</span><span class="nx">displayMessage</span><span class="p">(</span> <span class="nx">tableString</span><span class="p">);</span>
               
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
               <span class="nx">hC</span><span class="p">.</span><span class="nx">displayMessage</span><span class="p">(</span><span class="s2">&quot;No cloud captures found with names starting with &#39;&quot;</span> <span class="o">+</span> <span class="nx">searchString</span> <span class="o">+</span> <span class="s2">&quot;&#39;.&quot;</span><span class="p">);</span>
            <span class="p">}</span>
                        
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">hC</span><span class="p">.</span><span class="nx">displayMessage</span><span class="p">(</span><span class="s2">&quot;Looks like there&#39;s a problem connecting to CloudFlare.&quot;</span><span class="p">);</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;response NOT ok&quot;</span><span class="p">);</span>  
         <span class="p">}</span> 
      <span class="p">}</span>
   <span class="p">}</span>

   <span class="c1">// This checks to see if the capture has been edited to be different from the original file.</span>
   <span class="c1">// It requires taking time to load files. So, this is called at the start of a game. The results</span>
   <span class="c1">// of this (in aT.hack) are used later when reports are issued to the leaderboard.</span>
   <span class="kd">function</span> <span class="nx">compareCaptureToFile</span><span class="p">(</span> <span class="nx">pars</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">fileName</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">fileName</span><span class="p">,</span> <span class="s1">&#39;null&#39;</span><span class="p">);</span>
      <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">hack</span><span class="p">[</span><span class="s1">&#39;captureEdit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;fetching &#39;</span> <span class="o">+</span> <span class="nx">fileName</span> <span class="o">+</span> <span class="s1">&#39; from server&#39;</span><span class="p">);</span>
      
      <span class="nx">$</span><span class="p">.</span><span class="nx">getScript</span><span class="p">(</span> <span class="nx">fileName</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
         <span class="c1">// Note: demo_capture is a page level global and is assigned a value, the capture object, in the first line of the loading capture file.</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">json</span><span class="p">.</span><span class="nx">value</span> <span class="o">!=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span> <span class="nx">demo_capture</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">hack</span><span class="p">[</span><span class="s1">&#39;captureEdit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
         
      <span class="p">}).</span><span class="nx">fail</span><span class="p">(</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
         <span class="c1">// Try again...</span>
         <span class="nx">$</span><span class="p">.</span><span class="nx">getScript</span><span class="p">(</span> <span class="nx">fileName</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">json</span><span class="p">.</span><span class="nx">value</span> <span class="o">!=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span> <span class="nx">demo_capture</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">hack</span><span class="p">[</span><span class="s1">&#39;captureEdit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            
         <span class="p">}).</span><span class="nx">fail</span><span class="p">(</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;capture file not found on server&#39;</span><span class="p">);</span>
         <span class="p">});</span>
      <span class="p">})</span>
   <span class="p">}</span>
   
   <span class="kd">function</span> <span class="nx">compareCaptureToCloudOriginal</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">sameNameAsOriginal</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      
      <span class="c1">// First check if one has been downloaded.</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">m_cloudCapture</span><span class="p">.</span><span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">// Check for intent to run that one (as indicated in textarea) </span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">json</span><span class="p">.</span><span class="nx">value</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="p">{</span> 
            <span class="kd">let</span> <span class="nx">state_data</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span> <span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">json</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
            <span class="kd">let</span> <span class="nx">versionInTextArea</span> <span class="o">=</span> <span class="nx">state_data</span><span class="p">.</span><span class="nx">demoVersion</span><span class="p">;</span>
            <span class="kd">let</span> <span class="nx">versionInCloudCapture</span> <span class="o">=</span> <span class="nx">m_cloudCapture</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">demoVersion</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">versionInTextArea</span> <span class="o">==</span> <span class="nx">versionInCloudCapture</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">sameNameAsOriginal</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
               <span class="c1">// Intent is there. Now check for edits.</span>
               <span class="k">if</span> <span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">json</span><span class="p">.</span><span class="nx">value</span> <span class="o">!=</span> <span class="nx">m_cloudCapture</span><span class="p">.</span><span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">hack</span><span class="p">[</span><span class="s1">&#39;captureEdit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
               <span class="p">}</span>
            <span class="p">}</span>
         <span class="p">}</span>
      <span class="p">}</span>
      
      <span class="k">return</span> <span class="nx">sameNameAsOriginal</span><span class="p">;</span>
   <span class="p">}</span>
      
   <span class="c1">// For loading and running a capture from a web page link.</span>
   <span class="kd">function</span> <span class="nx">demoStart_fromCapture</span><span class="p">(</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">pars</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">fileName</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">fileName</span><span class="p">,</span> <span class="s1">&#39;null&#39;</span><span class="p">);</span>
      <span class="kd">let</span> <span class="nx">runIt</span> <span class="o">=</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span> <span class="nx">pars</span><span class="p">.</span><span class="nx">runIt</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
      
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;fetching &#39;</span> <span class="o">+</span> <span class="nx">fileName</span> <span class="o">+</span> <span class="s1">&#39; from server&#39;</span><span class="p">);</span>
      <span class="nx">$</span><span class="p">.</span><span class="nx">getScript</span><span class="p">(</span> <span class="nx">fileName</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
         <span class="c1">// Note: demo_capture is a page level global and is assigned a value, the capture object, in the first line of the loading capture file.</span>
         <span class="c1">// Put the capture into the capture input box on the page.</span>
         <span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">json</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span> <span class="nx">demo_capture</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
         <span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">scrollCaptureArea</span><span class="p">();},</span> <span class="mi">500</span><span class="p">);</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">runIt</span><span class="p">)</span> <span class="nx">dS</span><span class="p">.</span><span class="nx">demoStart</span><span class="p">(</span> <span class="nx">index</span><span class="p">);</span>
         
      <span class="p">}).</span><span class="nx">fail</span><span class="p">(</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
         <span class="c1">// Try again...</span>
         <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s2">&quot;please wait...&quot;</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">);</span>
         <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;attempting second fetch &#39;</span> <span class="o">+</span> <span class="nx">fileName</span> <span class="o">+</span> <span class="s1">&#39; from server&#39;</span><span class="p">);</span>
         <span class="nx">$</span><span class="p">.</span><span class="nx">getScript</span><span class="p">(</span> <span class="nx">fileName</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">json</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span> <span class="nx">demo_capture</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
            <span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">scrollCaptureArea</span><span class="p">();},</span> <span class="mi">500</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">runIt</span><span class="p">)</span> <span class="nx">dS</span><span class="p">.</span><span class="nx">demoStart</span><span class="p">(</span> <span class="nx">index</span><span class="p">);</span>

         <span class="p">}).</span><span class="nx">fail</span><span class="p">(</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;capture file not found on server&#39;</span><span class="p">);</span>
            <span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s2">&quot;Unable to get this capture file: [base,yellow]&quot;</span> <span class="o">+</span> <span class="nx">fileName</span> <span class="o">+</span> <span class="s2">&quot;[base]&quot;</span> <span class="o">+</span>
                                        <span class="s2">&quot;\\  from the server. Please try again or &quot;</span> <span class="o">+</span>
                                        <span class="s2">&quot;\\  use the file picker to open a local copy.&quot;</span><span class="p">,</span> <span class="mf">7.0</span><span class="p">);</span>
            <span class="c1">// One last thing to try, the file picker...</span>
            <span class="nx">filePicker</span><span class="p">();</span>
         <span class="p">});</span>
      <span class="p">});</span>
   <span class="p">}</span>
   
   <span class="kd">function</span> <span class="nx">scrollCaptureArea</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">json</span><span class="p">.</span><span class="nx">scrollTop</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span> 
      <span class="nx">gW</span><span class="p">.</span><span class="nx">dC</span><span class="p">.</span><span class="nx">json</span><span class="p">.</span><span class="nx">scrollLeft</span> <span class="o">=</span> <span class="mi">130</span><span class="p">;</span>
   <span class="p">}</span>
   
   
   <span class="c1">// see comments before the &quot;return&quot; section of gwModule.js</span>
   <span class="k">return</span> <span class="p">{</span>
      <span class="c1">// Objects</span>
      <span class="s1">&#39;cloudCapture&#39;</span><span class="o">:</span> <span class="nx">m_cloudCapture</span><span class="p">,</span>
      
      <span class="c1">// Variables</span>
      
      <span class="c1">// Methods</span>
      <span class="s1">&#39;initializeModule&#39;</span><span class="o">:</span> <span class="nx">initializeModule</span><span class="p">,</span>
      <span class="s1">&#39;saveState&#39;</span><span class="o">:</span> <span class="nx">saveState</span><span class="p">,</span>
      <span class="s1">&#39;loadJSON&#39;</span><span class="o">:</span> <span class="nx">loadJSON</span><span class="p">,</span>
      <span class="s1">&#39;modifyCapture&#39;</span><span class="o">:</span> <span class="nx">modifyCapture</span><span class="p">,</span>
      <span class="s1">&#39;modifyForCalculator&#39;</span><span class="o">:</span> <span class="nx">modifyForCalculator</span><span class="p">,</span>
      <span class="s1">&#39;shiftCapture&#39;</span><span class="o">:</span> <span class="nx">shiftCapture</span><span class="p">,</span>
      <span class="s1">&#39;runCapture&#39;</span><span class="o">:</span> <span class="nx">runCapture</span><span class="p">,</span>
      <span class="s1">&#39;cleanCapture&#39;</span><span class="o">:</span> <span class="nx">cleanCapture</span><span class="p">,</span>
      <span class="s1">&#39;restoreFromState&#39;</span><span class="o">:</span> <span class="nx">restoreFromState</span><span class="p">,</span>
      <span class="s1">&#39;compareCaptureToFile&#39;</span><span class="o">:</span> <span class="nx">compareCaptureToFile</span><span class="p">,</span>
      <span class="s1">&#39;compareCaptureToCloudOriginal&#39;</span><span class="o">:</span> <span class="nx">compareCaptureToCloudOriginal</span><span class="p">,</span>
      <span class="s1">&#39;demoStart_fromCapture&#39;</span><span class="o">:</span> <span class="nx">demoStart_fromCapture</span><span class="p">,</span>
      <span class="s1">&#39;clearState&#39;</span><span class="o">:</span> <span class="nx">clearState</span><span class="p">,</span>
      <span class="s1">&#39;filePicker&#39;</span><span class="o">:</span> <span class="nx">filePicker</span><span class="p">,</span>
      <span class="s1">&#39;fileWriter&#39;</span><span class="o">:</span> <span class="nx">fileWriter</span><span class="p">,</span>
      <span class="s1">&#39;postCaptureToCF&#39;</span><span class="o">:</span> <span class="nx">postCaptureToCF</span><span class="p">,</span>
      <span class="s1">&#39;scrollCaptureArea&#39;</span><span class="o">:</span> <span class="nx">scrollCaptureArea</span>
      
   <span class="p">};</span>

<span class="p">})();</span>
</pre></div>
</body>
</html>
