<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">
<!--
generated by Pygments <http://pygments.org>
Copyright 2006-2019 by the Pygments team.
Licensed under the BSD license, see LICENSE for details.
-->
<html>
<head>
  <link rel='canonical' href='https://triquence.org/gwModule.js.html' />
  <title>gwModule.js</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <style type="text/css">
/*
generated by Pygments <http://pygments.org>
Copyright 2006-2019 by the Pygments team.
Licensed under the BSD license, see LICENSE for details.
*/
td.linenos { background-color: #f0f0f0; padding-right: 10px; }
span.lineno { background-color: #f0f0f0; padding: 0 5px 0 5px; }
pre { line-height: 125%; }
body .hll { background-color: #ffffcc }
body  { background: #f8f8f8; }
body .c { color: #408080; font-style: italic } /* Comment */
body .err { border: 1px solid #FF0000 } /* Error */
body .k { color: #008000; font-weight: bold } /* Keyword */
body .o { color: #666666 } /* Operator */
body .ch { color: #408080; font-style: italic } /* Comment.Hashbang */
body .cm { color: #408080; font-style: italic } /* Comment.Multiline */
body .cp { color: #BC7A00 } /* Comment.Preproc */
body .cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */
body .c1 { color: #408080; font-style: italic } /* Comment.Single */
body .cs { color: #408080; font-style: italic } /* Comment.Special */
body .gd { color: #A00000 } /* Generic.Deleted */
body .ge { font-style: italic } /* Generic.Emph */
body .gr { color: #FF0000 } /* Generic.Error */
body .gh { color: #000080; font-weight: bold } /* Generic.Heading */
body .gi { color: #00A000 } /* Generic.Inserted */
body .go { color: #888888 } /* Generic.Output */
body .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
body .gs { font-weight: bold } /* Generic.Strong */
body .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
body .gt { color: #0044DD } /* Generic.Traceback */
body .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
body .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
body .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
body .kp { color: #008000 } /* Keyword.Pseudo */
body .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
body .kt { color: #B00040 } /* Keyword.Type */
body .m { color: #666666 } /* Literal.Number */
body .s { color: #BA2121 } /* Literal.String */
body .na { color: #7D9029 } /* Name.Attribute */
body .nb { color: #008000 } /* Name.Builtin */
body .nc { color: #0000FF; font-weight: bold } /* Name.Class */
body .no { color: #880000 } /* Name.Constant */
body .nd { color: #AA22FF } /* Name.Decorator */
body .ni { color: #999999; font-weight: bold } /* Name.Entity */
body .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
body .nf { color: #0000FF } /* Name.Function */
body .nl { color: #A0A000 } /* Name.Label */
body .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
body .nt { color: #008000; font-weight: bold } /* Name.Tag */
body .nv { color: #19177C } /* Name.Variable */
body .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
body .w { color: #bbbbbb } /* Text.Whitespace */
body .mb { color: #666666 } /* Literal.Number.Bin */
body .mf { color: #666666 } /* Literal.Number.Float */
body .mh { color: #666666 } /* Literal.Number.Hex */
body .mi { color: #666666 } /* Literal.Number.Integer */
body .mo { color: #666666 } /* Literal.Number.Oct */
body .sa { color: #BA2121 } /* Literal.String.Affix */
body .sb { color: #BA2121 } /* Literal.String.Backtick */
body .sc { color: #BA2121 } /* Literal.String.Char */
body .dl { color: #BA2121 } /* Literal.String.Delimiter */
body .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
body .s2 { color: #BA2121 } /* Literal.String.Double */
body .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
body .sh { color: #BA2121 } /* Literal.String.Heredoc */
body .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
body .sx { color: #008000 } /* Literal.String.Other */
body .sr { color: #BB6688 } /* Literal.String.Regex */
body .s1 { color: #BA2121 } /* Literal.String.Single */
body .ss { color: #19177C } /* Literal.String.Symbol */
body .bp { color: #008000 } /* Name.Builtin.Pseudo */
body .fm { color: #0000FF } /* Name.Function.Magic */
body .vc { color: #19177C } /* Name.Variable.Class */
body .vg { color: #19177C } /* Name.Variable.Global */
body .vi { color: #19177C } /* Name.Variable.Instance */
body .vm { color: #19177C } /* Name.Variable.Magic */
body .il { color: #666666 } /* Literal.Number.Integer.Long */

  </style>
</head>
<body>
<h2></h2>

<div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm">Copyright 2022 James D. Miller</span>

<span class="cm">Permission is hereby granted, free of charge, to any person obtaining a copy</span>
<span class="cm">of this software and associated documentation files (the &quot;Software&quot;), to deal</span>
<span class="cm">in the Software without restriction, including without limitation the rights</span>
<span class="cm">to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
<span class="cm">copies of the Software, and to permit persons to whom the Software is</span>
<span class="cm">furnished to do so, subject to the following conditions:</span>

<span class="cm">The above copyright notice and this permission notice shall be included in all</span>
<span class="cm">copies or substantial portions of the Software.</span>

<span class="cm">THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="cm">IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="cm">FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
<span class="cm">AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<span class="cm">LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span>
<span class="cm">OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="cm">SOFTWARE.</span>
<span class="cm">*/</span>

<span class="c1">// Game Window (gW) module</span>
<span class="c1">// gwModule.js </span>
   <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;gW3 _*-*_&#39;</span><span class="p">);</span>
<span class="c1">// 10:13 AM Sun December 10, 2023</span>

<span class="cm">/*</span>
<span class="cm">modules: filename and global nickname (i.e. window.nickname)</span>
<span class="cm">   Box2D.js (b2DW)</span>
<span class="cm">   bpHoops.js (bpH)</span>
<span class="cm">   boxStuff.js (bS)</span>
<span class="cm">   consAndPros.js (cP)</span>
<span class="cm">   clientProto.js (cT)</span>
<span class="cm">   captureRestore.js (cR)</span>
<span class="cm">   drawFunc.js (dFM and dF)</span>
<span class="cm">   demoStart.js (dS)</span>
<span class="cm">   eventsHost (eV)</span>
<span class="cm">   eventsNonHost.js (eVN)</span>
<span class="cm">   ghostBall.js (gB)</span>
<span class="cm">   gwModule.js (gW)</span>
<span class="cm">   hostAndClient.js (hC)</span>
<span class="cm">   jellowMadness.js (jM)</span>
<span class="cm">   leaderBoard.js (lB)</span>
<span class="cm">   monkeyHunt.js (mH)</span>
<span class="cm">   multiSelect.js (mS)</span>
<span class="cm">   pageStuff.js (pS)</span>
<span class="cm">   piEngine.js (pE)</span>
<span class="cm">   puckPopper.js (pP)</span>
<span class="cm">   tableActs (tA)</span>
<span class="cm">   twoThumbs.js (twoThumbs)</span>
<span class="cm">   utilities.js (uT)</span>
<span class="cm">   worldScreen.js (wS)</span>
<span class="cm">*/</span>

<span class="nb">window</span><span class="p">.</span><span class="nx">gW</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
   <span class="s2">&quot;use strict&quot;</span><span class="p">;</span>
      
   <span class="c1">////////////////////////////////////////////////////////////////////</span>
   <span class="c1">// Common variables inside of gW (game window) module //////////////</span>
   <span class="c1">////////////////////////////////////////////////////////////////////</span>
   
   <span class="c1">// The Air Table (aT): a place to call home for pucks, pins, springs, joints, and walls.</span>
   <span class="kd">var</span> <span class="nx">aT</span> <span class="o">=</span> <span class="p">{};</span>
  
   <span class="nx">aT</span><span class="p">.</span><span class="nx">puckMap</span> <span class="o">=</span> <span class="p">{};</span> <span class="c1">// keyed by puck name.</span>
   
   <span class="nx">aT</span><span class="p">.</span><span class="nx">pinMap</span> <span class="o">=</span> <span class="p">{};</span>  <span class="c1">// keyed by pin name.</span>
   
   <span class="nx">aT</span><span class="p">.</span><span class="nx">springMap</span> <span class="o">=</span> <span class="p">{};</span> <span class="c1">// keyed by spring name.</span>
   <span class="nx">aT</span><span class="p">.</span><span class="nx">jointMap</span> <span class="o">=</span> <span class="p">{};</span> <span class="c1">// keyed by joint name.</span>
   
   <span class="nx">aT</span><span class="p">.</span><span class="nx">wallMap</span> <span class="o">=</span> <span class="p">{};</span> <span class="c1">// keyed by wall name.</span>
   
   <span class="nx">aT</span><span class="p">.</span><span class="nx">collisionCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="nx">aT</span><span class="p">.</span><span class="nx">collisionInThisStep</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
   
   <span class="nx">aT</span><span class="p">.</span><span class="nx">hack</span> <span class="o">=</span> <span class="p">{};</span> <span class="c1">// a place to keep track of edits made to the base version of the game</span>
   
   <span class="c1">// Make a separate container for constants (c) and control flags used by aT objects. This avoids</span>
   <span class="c1">// circular references (and associated problems) with JSON capturing.</span>
   <span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="p">{};</span>
   <span class="nx">c</span><span class="p">.</span><span class="nx">g_mps2</span> <span class="o">=</span> <span class="mf">9.8</span><span class="p">;</span>
   <span class="nx">c</span><span class="p">.</span><span class="nx">g_ON</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
   <span class="nx">c</span><span class="p">.</span><span class="nx">px_per_m</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
   
   <span class="c1">// This 60 corresponds with the selected (default) value on the index.html page.</span>
   <span class="nx">c</span><span class="p">.</span><span class="nx">frameRate</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">;</span>
   <span class="nx">c</span><span class="p">.</span><span class="nx">frameCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="c1">// Seconds per frame</span>
   <span class="nx">c</span><span class="p">.</span><span class="nx">deltaT_s</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="nx">c</span><span class="p">.</span><span class="nx">frameRate</span><span class="p">;</span>
   <span class="nx">c</span><span class="p">.</span><span class="nx">dtFloating</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
   
   <span class="nx">c</span><span class="p">.</span><span class="nx">borderAndBackGroundColor</span> <span class="o">=</span> <span class="s1">&#39;#008080&#39;</span><span class="p">;</span> <span class="c1">// &#39;#008080&#39;;</span>
   <span class="nx">c</span><span class="p">.</span><span class="nx">fullScreenState</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
   
   <span class="nx">c</span><span class="p">.</span><span class="nx">fullScreenDemo</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
   
   <span class="nx">c</span><span class="p">.</span><span class="nx">demoIndex</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
   <span class="nx">c</span><span class="p">.</span><span class="nx">demoLoopIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="nx">c</span><span class="p">.</span><span class="nx">demoVersion</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
   
   <span class="nx">c</span><span class="p">.</span><span class="nx">lastClientToScoreHit</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
   
   <span class="nx">c</span><span class="p">.</span><span class="nx">chatLayoutState</span> <span class="o">=</span> <span class="s1">&#39;notSetYet&#39;</span><span class="p">;</span>
   
   <span class="nx">c</span><span class="p">.</span><span class="nx">singleStep</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
   <span class="nx">c</span><span class="p">.</span><span class="nx">softConstraints_default</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
   
   <span class="nx">c</span><span class="p">.</span><span class="nx">canvasColor</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span><span class="p">;</span>
   
   <span class="nx">c</span><span class="p">.</span><span class="nx">piCalcs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;enabled&#39;</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span> <span class="s1">&#39;usePiEngine&#39;</span><span class="o">:</span><span class="kc">false</span><span class="p">,</span> <span class="s1">&#39;clacks&#39;</span><span class="o">:</span><span class="kc">false</span><span class="p">};</span>

   <span class="nx">c</span><span class="p">.</span><span class="nx">pauseErase</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
   <span class="c1">// The user can set this true by putting the string &quot;lagtest&quot; in the chat field before checking the local cursor box (under multiplayer). </span>
   <span class="c1">// Use this to see little circles drawn at cursor position in handleMouseOrTouchMove for the host and cT.updateClientState for network client&#39;s.</span>
   <span class="c1">// Must use p or alt-p to avoid the canvas erasing actions. See comments at the beginning of updateAirTable.</span>
   <span class="nx">c</span><span class="p">.</span><span class="nx">lagTesting</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
   <span class="nx">aT</span><span class="p">.</span><span class="nx">cursorSpeed_pxps</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">RunningAverage</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>
   
   <span class="nx">c</span><span class="p">.</span><span class="nx">drawSyncImage</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
   
   <span class="nx">c</span><span class="p">.</span><span class="nx">displaySCM</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="c1">// System Center of Mass for all pucks</span>
   <span class="nx">c</span><span class="p">.</span><span class="nx">displayMSC</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="c1">// Multi-Select Center</span>
   
   <span class="c1">// Client map keyed by client name.</span>
   <span class="kd">var</span> <span class="nx">clients</span> <span class="o">=</span> <span class="p">{};</span>
   
   <span class="kd">var</span> <span class="nx">tableMap</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">();</span>  <span class="c1">// Special map where keys can be objects (specifically, box2d objects here).</span>
   <span class="kd">var</span> <span class="nx">b2d</span> <span class="o">=</span> <span class="p">{};</span> <span class="c1">// a wrapper for the Box2D world</span>
   <span class="kd">var</span> <span class="nx">myRequest</span><span class="p">,</span> <span class="nx">time_previous</span><span class="p">,</span> <span class="nx">dt_frame_ms</span><span class="p">,</span> <span class="nx">dt_frame_previous_ms</span><span class="p">,</span> <span class="nx">dt_frame_s</span><span class="p">,</span> <span class="nx">resumingAfterPause</span><span class="p">;</span>
   
   <span class="kd">var</span> <span class="nx">canvasDiv</span><span class="p">;</span>
   <span class="kd">var</span> <span class="nx">canvas</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">;</span>
   
   <span class="kd">var</span> <span class="nx">sounds</span> <span class="o">=</span> <span class="p">{};</span>
   <span class="kd">var</span> <span class="nx">messages</span> <span class="o">=</span> <span class="p">{};</span>
   
   <span class="c1">// these two require that multiSelect.js is loaded before gwModule.js</span>
   <span class="kd">var</span> <span class="nx">hostSelectBox</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mS</span><span class="p">.</span><span class="nx">SelectBox</span><span class="p">({});</span>
   <span class="kd">var</span> <span class="nx">hostMSelect</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mS</span><span class="p">.</span><span class="nx">MultiSelect</span><span class="p">();</span>
   
   <span class="c1">// Document Controls (dC).</span>
   <span class="kd">var</span> <span class="nx">dC</span> <span class="o">=</span> <span class="p">{};</span>
   <span class="nx">dC</span><span class="p">.</span><span class="nx">gravity</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
   <span class="nx">dC</span><span class="p">.</span><span class="nx">pause</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
   <span class="nx">dC</span><span class="p">.</span><span class="nx">comSelection</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
   <span class="nx">dC</span><span class="p">.</span><span class="nx">multiplayer</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
   <span class="nx">dC</span><span class="p">.</span><span class="nx">stream</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
   <span class="nx">dC</span><span class="p">.</span><span class="nx">localCursor</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
   <span class="nx">dC</span><span class="p">.</span><span class="nx">player</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
   <span class="nx">dC</span><span class="p">.</span><span class="nx">friendlyFire</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
   <span class="nx">dC</span><span class="p">.</span><span class="nx">editor</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
                    
   <span class="c1">// Key values.</span>
   <span class="kd">var</span> <span class="nx">keyMap</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Digit0&#39;</span><span class="o">:</span><span class="s1">&#39;key_0&#39;</span><span class="p">,</span> <span class="s1">&#39;Digit1&#39;</span><span class="o">:</span><span class="s1">&#39;key_1&#39;</span><span class="p">,</span> <span class="s1">&#39;Digit2&#39;</span><span class="o">:</span><span class="s1">&#39;key_2&#39;</span><span class="p">,</span> <span class="s1">&#39;Digit3&#39;</span><span class="o">:</span><span class="s1">&#39;key_3&#39;</span><span class="p">,</span> <span class="s1">&#39;Digit4&#39;</span><span class="o">:</span><span class="s1">&#39;key_4&#39;</span><span class="p">,</span> 
                 <span class="s1">&#39;Digit5&#39;</span><span class="o">:</span><span class="s1">&#39;key_5&#39;</span><span class="p">,</span> <span class="s1">&#39;Digit6&#39;</span><span class="o">:</span><span class="s1">&#39;key_6&#39;</span><span class="p">,</span> <span class="s1">&#39;Digit7&#39;</span><span class="o">:</span><span class="s1">&#39;key_7&#39;</span><span class="p">,</span> <span class="s1">&#39;Digit8&#39;</span><span class="o">:</span><span class="s1">&#39;key_8&#39;</span><span class="p">,</span> <span class="s1">&#39;Digit9&#39;</span><span class="o">:</span><span class="s1">&#39;key_9&#39;</span><span class="p">,</span>
                 
                 <span class="s1">&#39;KeyA&#39;</span><span class="o">:</span><span class="s1">&#39;key_a&#39;</span><span class="p">,</span> <span class="s1">&#39;KeyB&#39;</span><span class="o">:</span><span class="s1">&#39;key_b&#39;</span><span class="p">,</span> <span class="s1">&#39;KeyC&#39;</span><span class="o">:</span><span class="s1">&#39;key_c&#39;</span><span class="p">,</span> <span class="s1">&#39;KeyD&#39;</span><span class="o">:</span><span class="s1">&#39;key_d&#39;</span><span class="p">,</span> <span class="s1">&#39;KeyE&#39;</span><span class="o">:</span><span class="s1">&#39;key_e&#39;</span><span class="p">,</span> <span class="s1">&#39;KeyF&#39;</span><span class="o">:</span><span class="s1">&#39;key_f&#39;</span><span class="p">,</span> <span class="s1">&#39;KeyG&#39;</span><span class="o">:</span><span class="s1">&#39;key_g&#39;</span><span class="p">,</span> 
                 <span class="s1">&#39;KeyI&#39;</span><span class="o">:</span><span class="s1">&#39;key_i&#39;</span><span class="p">,</span> <span class="s1">&#39;KeyJ&#39;</span><span class="o">:</span><span class="s1">&#39;key_j&#39;</span><span class="p">,</span> <span class="s1">&#39;KeyK&#39;</span><span class="o">:</span><span class="s1">&#39;key_k&#39;</span><span class="p">,</span> <span class="s1">&#39;KeyL&#39;</span><span class="o">:</span><span class="s1">&#39;key_l&#39;</span><span class="p">,</span> <span class="s1">&#39;KeyM&#39;</span><span class="o">:</span><span class="s1">&#39;key_m&#39;</span><span class="p">,</span> <span class="s1">&#39;KeyN&#39;</span><span class="o">:</span><span class="s1">&#39;key_n&#39;</span><span class="p">,</span> <span class="s1">&#39;KeyO&#39;</span><span class="o">:</span><span class="s1">&#39;key_o&#39;</span><span class="p">,</span> 
                 <span class="s1">&#39;KeyP&#39;</span><span class="o">:</span><span class="s1">&#39;key_p&#39;</span><span class="p">,</span> <span class="s1">&#39;KeyQ&#39;</span><span class="o">:</span><span class="s1">&#39;key_q&#39;</span><span class="p">,</span> <span class="s1">&#39;KeyR&#39;</span><span class="o">:</span><span class="s1">&#39;key_r&#39;</span><span class="p">,</span> <span class="s1">&#39;KeyS&#39;</span><span class="o">:</span><span class="s1">&#39;key_s&#39;</span><span class="p">,</span> 
                 <span class="s1">&#39;KeyT&#39;</span><span class="o">:</span><span class="s1">&#39;key_t&#39;</span><span class="p">,</span> <span class="s1">&#39;KeyU&#39;</span><span class="o">:</span><span class="s1">&#39;key_u&#39;</span><span class="p">,</span> <span class="s1">&#39;KeyV&#39;</span><span class="o">:</span><span class="s1">&#39;key_v&#39;</span><span class="p">,</span> <span class="s1">&#39;KeyW&#39;</span><span class="o">:</span><span class="s1">&#39;key_w&#39;</span><span class="p">,</span> <span class="s1">&#39;KeyX&#39;</span><span class="o">:</span><span class="s1">&#39;key_x&#39;</span><span class="p">,</span> <span class="s1">&#39;KeyZ&#39;</span><span class="o">:</span><span class="s1">&#39;key_z&#39;</span><span class="p">,</span>
                 
                 <span class="s1">&#39;Backspace&#39;</span><span class="o">:</span><span class="s1">&#39;key_backspace&#39;</span><span class="p">,</span> <span class="s1">&#39;Tab&#39;</span><span class="o">:</span><span class="s1">&#39;key_tab&#39;</span><span class="p">,</span> <span class="s1">&#39;Enter&#39;</span><span class="o">:</span><span class="s1">&#39;key_enter&#39;</span><span class="p">,</span> 
                 <span class="s1">&#39;ShiftLeft&#39;</span><span class="o">:</span><span class="s1">&#39;key_shift&#39;</span><span class="p">,</span> <span class="s1">&#39;ShiftRight&#39;</span><span class="o">:</span><span class="s1">&#39;key_shift&#39;</span><span class="p">,</span> 
                 <span class="s1">&#39;ControlLeft&#39;</span><span class="o">:</span><span class="s1">&#39;key_ctrl&#39;</span><span class="p">,</span> <span class="s1">&#39;ControlRight&#39;</span><span class="o">:</span><span class="s1">&#39;key_ctrl&#39;</span><span class="p">,</span> 
                 <span class="s1">&#39;AltLeft&#39;</span><span class="o">:</span><span class="s1">&#39;key_alt&#39;</span><span class="p">,</span> <span class="s1">&#39;AltRight&#39;</span><span class="o">:</span><span class="s1">&#39;key_alt&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;Space&#39;</span><span class="o">:</span><span class="s1">&#39;key_space&#39;</span><span class="p">,</span> 
                 
                 <span class="c1">// Note that default behavior is blocked on all these arrow-key type keys. Search on</span>
                 <span class="c1">// editKeysMap in the handler for the keydown event (in eventsHost.js).</span>
                 <span class="c1">// Exceptions to this are the key_+ and key_- number-pad keys that are in the allowDefaultKeysMap.</span>
                 <span class="c1">// This allows the desired native zoom feature when using the ctrl key along with these keys.  </span>
                 <span class="s1">&#39;PageUp&#39;</span><span class="o">:</span><span class="s1">&#39;key_pageUp&#39;</span><span class="p">,</span> <span class="s1">&#39;PageDown&#39;</span><span class="o">:</span><span class="s1">&#39;key_pageDown&#39;</span><span class="p">,</span> 
                 <span class="s1">&#39;ArrowLeft&#39;</span><span class="o">:</span><span class="s1">&#39;key_leftArrow&#39;</span><span class="p">,</span> <span class="s1">&#39;ArrowUp&#39;</span><span class="o">:</span><span class="s1">&#39;key_upArrow&#39;</span><span class="p">,</span> <span class="s1">&#39;ArrowRight&#39;</span><span class="o">:</span><span class="s1">&#39;key_rightArrow&#39;</span><span class="p">,</span> <span class="s1">&#39;ArrowDown&#39;</span><span class="o">:</span><span class="s1">&#39;key_downArrow&#39;</span><span class="p">,</span>
                 
                 <span class="c1">// Number pad +/- keys.</span>
                 <span class="s1">&#39;NumpadAdd&#39;</span><span class="o">:</span><span class="s1">&#39;key_+&#39;</span><span class="p">,</span> <span class="s1">&#39;NumpadSubtract&#39;</span><span class="o">:</span><span class="s1">&#39;key_-&#39;</span><span class="p">,</span>
                 <span class="c1">// Main keyboard +/- keys.</span>
                 <span class="s1">&#39;Equal&#39;</span><span class="o">:</span><span class="s1">&#39;key_=+&#39;</span><span class="p">,</span> <span class="s1">&#39;Minus&#39;</span><span class="o">:</span><span class="s1">&#39;key_-_&#39;</span><span class="p">,</span>
                 
                 <span class="s1">&#39;Comma&#39;</span><span class="o">:</span><span class="s1">&#39;key_lt&#39;</span><span class="p">,</span> <span class="s1">&#39;Period&#39;</span><span class="o">:</span><span class="s1">&#39;key_gt&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;Slash&#39;</span><span class="o">:</span><span class="s1">&#39;key_questionMark&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;BracketLeft&#39;</span><span class="o">:</span><span class="s1">&#39;key_[&#39;</span><span class="p">,</span> <span class="s1">&#39;BracketRight&#39;</span><span class="o">:</span><span class="s1">&#39;key_]&#39;</span><span class="p">};</span>
   
   <span class="kd">var</span> <span class="nx">fileName</span> <span class="o">=</span> <span class="s2">&quot;gwModule.js&quot;</span><span class="p">;</span>
   
   <span class="c1">// supporting touch-screen event processing</span>
   <span class="kd">var</span> <span class="nx">ts</span> <span class="o">=</span> <span class="p">{};</span>
   <span class="nx">ts</span><span class="p">.</span><span class="nx">previousTapTime</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">();</span>
   <span class="nx">ts</span><span class="p">.</span><span class="nx">tapCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
   
      
   <span class="c1">/////////////////////////////////////////////////////////////////////////////</span>
   <span class="c1">////  Functions</span>
   <span class="c1">/////////////////////////////////////////////////////////////////////////////</span>
   
   <span class="kd">function</span> <span class="nx">toggleMultiplayerStuff</span><span class="p">()</span> <span class="p">{</span>
      <span class="c1">// This double toggle has the effect of switching between the following two divs.</span>
      <span class="nx">uT</span><span class="p">.</span><span class="nx">toggleElementDisplay</span><span class="p">(</span><span class="s2">&quot;multiPlayer&quot;</span><span class="p">,</span> <span class="s2">&quot;table-cell&quot;</span><span class="p">);</span>
      <span class="nx">uT</span><span class="p">.</span><span class="nx">toggleElementDisplay</span><span class="p">(</span><span class="s2">&quot;ttcIntro&quot;</span><span class="p">,</span>    <span class="s2">&quot;table-cell&quot;</span><span class="p">);</span>
      
      <span class="c1">// This toggles (displays/hides) the client links.</span>
      <span class="nx">uT</span><span class="p">.</span><span class="nx">toggleElementDisplay</span><span class="p">(</span><span class="s2">&quot;clientLinks&quot;</span><span class="p">,</span> <span class="s2">&quot;block&quot;</span><span class="p">);</span>
      
      <span class="c1">// Toggling the help panel can involve a width change, especially if changing to</span>
      <span class="c1">// or leaving demo 8. Therefore, need to update the help panel&#39;s scroll position.</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">pS</span><span class="p">.</span><span class="nx">scrollHistory</span><span class="p">.</span><span class="nx">currentTarget</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">pS</span><span class="p">.</span><span class="nx">scroll</span><span class="p">(</span> <span class="nx">pS</span><span class="p">.</span><span class="nx">scrollHistory</span><span class="p">.</span><span class="nx">currentTarget</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;scrollDuration&#39;</span><span class="o">:</span><span class="mi">0</span><span class="p">});</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="nx">pS</span><span class="p">.</span><span class="nx">scroll</span><span class="p">(</span><span class="s1">&#39;d&#39;</span> <span class="o">+</span> <span class="nx">c</span><span class="p">.</span><span class="nx">demoIndex</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;scrollDuration&#39;</span><span class="o">:</span><span class="mi">0</span><span class="p">});</span>
      <span class="p">}</span>
   <span class="p">}</span>
   
   <span class="kd">function</span> <span class="nx">resetFenceColor</span><span class="p">(</span> <span class="nx">newColor</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">cP</span><span class="p">.</span><span class="nx">Wall</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span> <span class="nx">wall</span> <span class="p">=&gt;</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">wall</span><span class="p">.</span><span class="nx">fence</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">wall</span><span class="p">.</span><span class="nx">color</span> <span class="o">=</span> <span class="nx">newColor</span><span class="p">;</span>
            <span class="nx">wall</span><span class="p">.</span><span class="nx">draw</span><span class="p">(</span> <span class="nx">ctx</span><span class="p">);</span>
         <span class="p">}</span>
      <span class="p">});</span>
   <span class="p">}</span>
   
   <span class="kd">function</span> <span class="nx">hackerCheck</span><span class="p">(</span> <span class="nx">action</span><span class="o">=</span><span class="s1">&#39;noReset&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">levelString</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
      
      <span class="c1">// The only place the editor attribute can be set back to false is in this reset block.</span>
      <span class="c1">// hackerCheck is called in reset mode in early in demoStart() in the demoStart.js module.</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">action</span> <span class="o">==</span> <span class="s1">&#39;reset&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">aT</span><span class="p">.</span><span class="nx">hack</span><span class="p">[</span><span class="s1">&#39;editor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="c1">// enabling wall/pin edits</span>
         <span class="nx">aT</span><span class="p">.</span><span class="nx">hack</span><span class="p">[</span><span class="s1">&#39;pwsEdits&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="c1">// changing characteristics of pucks, walls, and springs</span>
         <span class="nx">aT</span><span class="p">.</span><span class="nx">hack</span><span class="p">[</span><span class="s1">&#39;wallpinDirectMove&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="c1">// direct movement of walls and pins</span>
         <span class="nx">aT</span><span class="p">.</span><span class="nx">hack</span><span class="p">[</span><span class="s1">&#39;puckDirectMove&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="c1">// direct movement of pucks (ball in hand)</span>
         <span class="nx">aT</span><span class="p">.</span><span class="nx">hack</span><span class="p">[</span><span class="s1">&#39;captureEdit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="c1">// edits to the capture textarea</span>
         <span class="nx">aT</span><span class="p">.</span><span class="nx">hack</span><span class="p">[</span><span class="s1">&#39;deletedSomething&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="c1">// deleted something</span>
         
         <span class="c1">// Check for edits to captures on the web server.</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">demoVersion</span> <span class="o">==</span> <span class="s2">&quot;3.d.9ball&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">cR</span><span class="p">.</span><span class="nx">compareCaptureToFile</span><span class="p">({</span><span class="s1">&#39;fileName&#39;</span><span class="o">:</span><span class="s1">&#39;demo3d.js&#39;</span><span class="p">});</span>
         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">demoVersion</span> <span class="o">==</span> <span class="s2">&quot;3.d.8ball&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">cR</span><span class="p">.</span><span class="nx">compareCaptureToFile</span><span class="p">({</span><span class="s1">&#39;fileName&#39;</span><span class="o">:</span><span class="s1">&#39;demo3d.8ball.js&#39;</span><span class="p">});</span>
         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">demoVersion</span> <span class="o">==</span> <span class="s2">&quot;3.d.rotation&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">cR</span><span class="p">.</span><span class="nx">compareCaptureToFile</span><span class="p">({</span><span class="s1">&#39;fileName&#39;</span><span class="o">:</span><span class="s1">&#39;demo3d.rotation.js&#39;</span><span class="p">});</span>

         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">demoVersion</span> <span class="o">==</span> <span class="s2">&quot;4.e.monkeyhunt&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">cR</span><span class="p">.</span><span class="nx">compareCaptureToFile</span><span class="p">({</span><span class="s1">&#39;fileName&#39;</span><span class="o">:</span><span class="s1">&#39;demo4e.monkeyhunt.js&#39;</span><span class="p">});</span>
            
         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">demoVersion</span> <span class="o">==</span> <span class="s2">&quot;5.e.basketball-par&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">cR</span><span class="p">.</span><span class="nx">compareCaptureToFile</span><span class="p">({</span><span class="s1">&#39;fileName&#39;</span><span class="o">:</span><span class="s1">&#39;demo5e.basketball-par.js&#39;</span><span class="p">});</span>
            
         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">demoVersion</span> <span class="o">==</span> <span class="s2">&quot;6.d&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">cR</span><span class="p">.</span><span class="nx">compareCaptureToFile</span><span class="p">({</span><span class="s1">&#39;fileName&#39;</span><span class="o">:</span><span class="s1">&#39;demo6d.js&#39;</span><span class="p">});</span>
            
         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">demoVersion</span> <span class="o">==</span> <span class="s2">&quot;7.b&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">cR</span><span class="p">.</span><span class="nx">compareCaptureToFile</span><span class="p">({</span><span class="s1">&#39;fileName&#39;</span><span class="o">:</span><span class="s1">&#39;demo7b.js&#39;</span><span class="p">});</span>
         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">demoVersion</span> <span class="o">==</span> <span class="s2">&quot;7.c&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">cR</span><span class="p">.</span><span class="nx">compareCaptureToFile</span><span class="p">({</span><span class="s1">&#39;fileName&#39;</span><span class="o">:</span><span class="s1">&#39;demo7c.js&#39;</span><span class="p">});</span>
         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">demoVersion</span> <span class="o">==</span> <span class="s2">&quot;7.d&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">cR</span><span class="p">.</span><span class="nx">compareCaptureToFile</span><span class="p">({</span><span class="s1">&#39;fileName&#39;</span><span class="o">:</span><span class="s1">&#39;demo7d.js&#39;</span><span class="p">});</span>

         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">demoVersion</span> <span class="o">==</span> <span class="s2">&quot;8.b&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">cR</span><span class="p">.</span><span class="nx">compareCaptureToFile</span><span class="p">({</span><span class="s1">&#39;fileName&#39;</span><span class="o">:</span><span class="s1">&#39;demo8b.js&#39;</span><span class="p">});</span>
         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">demoVersion</span> <span class="o">==</span> <span class="s2">&quot;8.c&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">cR</span><span class="p">.</span><span class="nx">compareCaptureToFile</span><span class="p">({</span><span class="s1">&#39;fileName&#39;</span><span class="o">:</span><span class="s1">&#39;demo8c.js&#39;</span><span class="p">});</span>
         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">demoVersion</span> <span class="o">==</span> <span class="s2">&quot;8.d&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">cR</span><span class="p">.</span><span class="nx">compareCaptureToFile</span><span class="p">({</span><span class="s1">&#39;fileName&#39;</span><span class="o">:</span><span class="s1">&#39;demo8d.js&#39;</span><span class="p">});</span>
         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">demoVersion</span> <span class="o">==</span> <span class="s2">&quot;8.e&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">cR</span><span class="p">.</span><span class="nx">compareCaptureToFile</span><span class="p">({</span><span class="s1">&#39;fileName&#39;</span><span class="o">:</span><span class="s1">&#39;demo8e.js&#39;</span><span class="p">});</span>
         <span class="p">}</span>
         
         <span class="c1">// Also check for edits to cloud captures.</span>
         <span class="nx">cR</span><span class="p">.</span><span class="nx">compareCaptureToCloudOriginal</span><span class="p">();</span>
      
      <span class="c1">// hackerCheck is called in noReset mode after a game is over, and before the submit to the leaderboard.  </span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">action</span> <span class="o">==</span> <span class="s1">&#39;noReset&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">// All &quot;a&quot; versions of the games run (as default) without a capture.</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">demoVersion</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// If there is a capture, check to see if it has the same demo version. </span>
            <span class="c1">// If so, that&#39;s considered an edit. Otherwise, that&#39;s just a lingering capture from another demo.</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">dC</span><span class="p">.</span><span class="nx">json</span><span class="p">.</span><span class="nx">value</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="p">{</span>
               <span class="kd">let</span> <span class="nx">capture_data</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span> <span class="nx">dC</span><span class="p">.</span><span class="nx">json</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
               <span class="k">if</span> <span class="p">(</span><span class="nx">capture_data</span><span class="p">.</span><span class="nx">demoVersion</span> <span class="o">==</span> <span class="nx">c</span><span class="p">.</span><span class="nx">demoVersion</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">cR</span><span class="p">.</span><span class="nx">compareCaptureToCloudOriginal</span><span class="p">())</span> <span class="p">{</span>
                     <span class="nx">aT</span><span class="p">.</span><span class="nx">hack</span><span class="p">[</span><span class="s1">&#39;captureEdit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                  <span class="p">}</span>
               <span class="p">}</span>
            <span class="p">}</span>
         <span class="p">}</span>  

         <span class="c1">// If wall edits are turned on and then off during a game, aT.hack[&#39;editor&#39;] will have been</span>
         <span class="c1">// set true in eventsHosts and still be true here.</span>
         
         <span class="c1">// Set a level string for display in the report tables.</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">aT</span><span class="p">.</span><span class="nx">hack</span><span class="p">[</span><span class="s1">&#39;editor&#39;</span><span class="p">])</span> <span class="nx">levelString</span> <span class="o">=</span> <span class="s2">&quot;e&quot;</span><span class="p">;</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">aT</span><span class="p">.</span><span class="nx">hack</span><span class="p">[</span><span class="s1">&#39;pwsEdits&#39;</span><span class="p">])</span> <span class="nx">levelString</span> <span class="o">+=</span> <span class="s2">&quot;a&quot;</span><span class="p">;</span> <span class="c1">// a for attributes</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">aT</span><span class="p">.</span><span class="nx">hack</span><span class="p">[</span><span class="s1">&#39;wallpinDirectMove&#39;</span><span class="p">])</span> <span class="nx">levelString</span> <span class="o">+=</span> <span class="s2">&quot;w&quot;</span><span class="p">;</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">aT</span><span class="p">.</span><span class="nx">hack</span><span class="p">[</span><span class="s1">&#39;puckDirectMove&#39;</span><span class="p">])</span> <span class="nx">levelString</span> <span class="o">+=</span> <span class="s2">&quot;h&quot;</span><span class="p">;</span> <span class="c1">// h for ball-in-hand</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">aT</span><span class="p">.</span><span class="nx">hack</span><span class="p">[</span><span class="s1">&#39;captureEdit&#39;</span><span class="p">])</span> <span class="nx">levelString</span> <span class="o">+=</span> <span class="s2">&quot;c&quot;</span><span class="p">;</span> <span class="c1">// c for capture</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">aT</span><span class="p">.</span><span class="nx">hack</span><span class="p">[</span><span class="s1">&#39;deletedSomething&#39;</span><span class="p">])</span> <span class="nx">levelString</span> <span class="o">+=</span> <span class="s2">&quot;d&quot;</span><span class="p">;</span> <span class="c1">// d for deleted something</span>
      <span class="p">}</span>
      
      <span class="c1">// The following checks are made at BOTH the start and end of games (reset and noReset).</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">dC</span><span class="p">.</span><span class="nx">editor</span><span class="p">.</span><span class="nx">checked</span><span class="p">)</span> <span class="nx">aT</span><span class="p">.</span><span class="nx">hack</span><span class="p">[</span><span class="s1">&#39;editor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      
        
      <span class="k">return</span> <span class="nx">levelString</span><span class="p">;</span>
   <span class="p">}</span>
   
   <span class="kd">function</span> <span class="nx">setPauseState</span><span class="p">(</span> <span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Make the pause state agrees with the check box.</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">dC</span><span class="p">.</span><span class="nx">pause</span><span class="p">.</span><span class="nx">checked</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s1">&#39;Physics engine is [base,yellow]paused[base]. \\  Use the [base,yellow]&quot;o&quot;[base] key to single-step it, [base,yellow]&quot;p&quot;[base] to resume.&#39;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">);</span>
         <span class="c1">// Wait for one frame, so the message to be displayed, then pause the engine.</span>
         <span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">stopit</span><span class="p">();</span>
            <span class="nx">uT</span><span class="p">.</span><span class="nx">setElementDisplay</span><span class="p">(</span><span class="s2">&quot;fps_wrapper&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">);</span>
            <span class="nx">uT</span><span class="p">.</span><span class="nx">setElementDisplay</span><span class="p">(</span><span class="s2">&quot;stepper_wrapper&quot;</span><span class="p">,</span> <span class="s2">&quot;inline&quot;</span><span class="p">);</span>
         <span class="p">},</span> <span class="mi">20</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="nx">startit</span><span class="p">();</span>
         <span class="nx">c</span><span class="p">.</span><span class="nx">singleStep</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
         <span class="nx">uT</span><span class="p">.</span><span class="nx">setElementDisplay</span><span class="p">(</span><span class="s2">&quot;fps_wrapper&quot;</span><span class="p">,</span> <span class="s2">&quot;inline&quot;</span><span class="p">);</span>
         <span class="nx">uT</span><span class="p">.</span><span class="nx">setElementDisplay</span><span class="p">(</span><span class="s2">&quot;stepper_wrapper&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">);</span>
         <span class="c1">// This hides the border glitch in Chrome...</span>
         <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">c</span><span class="p">.</span><span class="nx">fullScreenState</span><span class="p">)</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">backgroundColor</span> <span class="o">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">borderAndBackGroundColor</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span>
   
   <span class="kd">function</span> <span class="nx">oneFrameIfPaused</span><span class="p">(</span> <span class="nx">delay_ms</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="cm">/*</span>
<span class="cm">      Force a single-frame update. This is useful for avoiding a black screen if paused and changing to full-canvas.</span>
<span class="cm">      Note: this must be delayed until after the pause and restart in restartAnimationLoop.</span>
<span class="cm">      (see comments in dC.fullCanvas.addEventListener)</span>
<span class="cm">      */</span>
      <span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">dC</span><span class="p">.</span><span class="nx">pause</span><span class="p">.</span><span class="nx">checked</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s1">&#39;Physics engine is [base,yellow]paused[base]. \\  Use the [base,yellow]&quot;o&quot;[base] key to single-step it, [base,yellow]&quot;p&quot;[base] to resume.&#39;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">);</span>
            <span class="c1">// Do one step so that this message gets written to the canvas.</span>
            <span class="nx">stepAnimation</span><span class="p">();</span>
         <span class="p">}</span>
      <span class="p">},</span> <span class="nx">delay_ms</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="kd">function</span> <span class="nx">restartAnimationLoop</span><span class="p">(</span> <span class="nx">delay_ms</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// This pause and restart, helps to minimize the lag in the browser&#39;s mouse input. Note you can visualize the lag by putting the string &quot;lagtest&quot; in the chat</span>
      <span class="c1">// and then checking the local cursor option under multiplayer. This displays a circle with radius equal to the cursor movement in two frames.</span>
      <span class="k">if</span> <span class="p">((</span><span class="nx">hC</span><span class="p">.</span><span class="nx">get_hostOrClient</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;host&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">dC</span><span class="p">.</span><span class="nx">pause</span><span class="p">.</span><span class="nx">checked</span><span class="p">))</span> <span class="p">{</span>
         <span class="nx">dC</span><span class="p">.</span><span class="nx">pause</span><span class="p">.</span><span class="nx">checked</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> 
         <span class="nx">stopit</span><span class="p">();</span>
         
         <span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">dC</span><span class="p">.</span><span class="nx">pause</span><span class="p">.</span><span class="nx">checked</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> 
            <span class="nx">startit</span><span class="p">();</span>
         <span class="p">},</span> <span class="nx">delay_ms</span><span class="p">);</span>
         
         <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;animation restarted&quot;</span><span class="p">);</span>
      <span class="p">}</span>
   <span class="p">}</span>
   
   <span class="kd">function</span> <span class="nx">startit</span><span class="p">()</span> <span class="p">{</span>
      <span class="c1">// Only start a game loop if there is no game loop running.</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">myRequest</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">resetFenceColor</span><span class="p">(</span> <span class="nx">cP</span><span class="p">.</span><span class="nx">Wall</span><span class="p">.</span><span class="nx">color_default</span><span class="p">);</span>
         <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">c</span><span class="p">.</span><span class="nx">singleStep</span><span class="p">)</span> <span class="nx">dC</span><span class="p">.</span><span class="nx">pause</span><span class="p">.</span><span class="nx">checked</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

         <span class="c1">// Start the game loop.</span>
         <span class="nx">myRequest</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">requestAnimationFrame</span><span class="p">(</span> <span class="nx">gameLoop</span><span class="p">);</span>
      <span class="p">}</span>
   <span class="p">}</span>

   <span class="kd">function</span> <span class="nx">stopit</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">resetFenceColor</span><span class="p">(</span> <span class="s2">&quot;red&quot;</span><span class="p">);</span>
      <span class="nx">aT</span><span class="p">.</span><span class="nx">dt_RA_ms</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
      <span class="nx">dC</span><span class="p">.</span><span class="nx">fps</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span><span class="p">;</span>

      <span class="nb">window</span><span class="p">.</span><span class="nx">cancelAnimationFrame</span><span class="p">(</span> <span class="nx">myRequest</span><span class="p">);</span>
      <span class="nx">myRequest</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="nx">resumingAfterPause</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
   <span class="p">}</span>
   
   <span class="kd">function</span> <span class="nx">stepAnimation</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">dC</span><span class="p">.</span><span class="nx">pause</span><span class="p">.</span><span class="nx">checked</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="c1">// Set flag to allow only one step.</span>
      <span class="nx">c</span><span class="p">.</span><span class="nx">singleStep</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="nx">startit</span><span class="p">();</span>
   <span class="p">}</span>
   
   <span class="kd">function</span> <span class="nx">setFrameRateBasedOnDisplayRate</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;fps=&quot;</span> <span class="o">+</span> <span class="nx">dC</span><span class="p">.</span><span class="nx">fps</span><span class="p">.</span><span class="nx">innerHTML</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">current_fps</span> <span class="o">=</span> <span class="nx">dC</span><span class="p">.</span><span class="nx">fps</span><span class="p">.</span><span class="nx">innerHTML</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">fps_choices</span> <span class="o">=</span> <span class="p">[</span><span class="mi">60</span><span class="p">,</span><span class="mi">75</span><span class="p">,</span><span class="mi">85</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">120</span><span class="p">,</span><span class="mi">144</span><span class="p">,</span><span class="mi">240</span><span class="p">];</span>
      <span class="kd">var</span> <span class="nx">min_diff</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">min_diff_index</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">fps_choices</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">var</span> <span class="nx">diff</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span> <span class="nx">fps_choices</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">-</span> <span class="nx">current_fps</span><span class="p">);</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">diff</span> <span class="o">&lt;</span> <span class="nx">min_diff</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">min_diff</span> <span class="o">=</span> <span class="nx">diff</span><span class="p">;</span>
            <span class="nx">min_diff_index</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
         <span class="p">}</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">bestMatch</span> <span class="o">=</span> <span class="nx">fps_choices</span><span class="p">[</span> <span class="nx">min_diff_index</span><span class="p">];</span>
      <span class="c1">// Set the value in the pulldown control.</span>
      <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#FrameRate&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span> <span class="nx">bestMatch</span><span class="p">);</span>
      <span class="nx">setFrameRate</span><span class="p">();</span>
   <span class="p">}</span>
   
   <span class="kd">function</span> <span class="nx">setFrameRate</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">frameRate</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#FrameRate&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">frameRate</span> <span class="o">!=</span> <span class="s1">&#39;float&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">c</span><span class="p">.</span><span class="nx">frameRate</span> <span class="o">=</span> <span class="nx">frameRate</span><span class="p">;</span>
         <span class="nx">c</span><span class="p">.</span><span class="nx">deltaT_s</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="nx">frameRate</span><span class="p">;</span>
         <span class="nx">c</span><span class="p">.</span><span class="nx">dtFloating</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="nx">c</span><span class="p">.</span><span class="nx">dtFloating</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span>
   
   
   <span class="c1">///////////////////////////////////////////////////////</span>
   <span class="c1">// Initialize almost everything ///////////////////////</span>
   <span class="c1">///////////////////////////////////////////////////////</span>

   <span class="cm">/*</span>
<span class="cm">   init() is called from index.html after the page load. This delays the </span>
<span class="cm">   execution of init() until after all the page elements have loaded in. </span>
<span class="cm">   Listeners are initialize here, after the delay, so that the </span>
<span class="cm">   corresponding page elements exist. </span>
<span class="cm">   </span>
<span class="cm">   Note that because of this delay, no objects can be defined here (inside init)</span>
<span class="cm">   that need to be revealed in the public pointers at the end of this file.</span>
<span class="cm">   */</span>
   
   <span class="kd">function</span> <span class="nx">init</span><span class="p">()</span> <span class="p">{</span>
      
      <span class="c1">// Initialize Box2D world: set gravity vector to 0, allow sleep.</span>
      <span class="nx">b2d</span><span class="p">.</span><span class="nx">world</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">b2DW</span><span class="p">.</span><span class="nx">World</span><span class="p">(</span> <span class="k">new</span> <span class="nx">b2DW</span><span class="p">.</span><span class="nx">Vec2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0</span><span class="p">),</span> <span class="kc">true</span><span class="p">);</span>
      
      <span class="c1">// Event handlers for Box2D. Get collision information.</span>
      
      <span class="kd">var</span> <span class="nx">listener</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">b2DW</span><span class="p">.</span><span class="nx">ContactListener</span><span class="p">;</span>
      
      <span class="nx">listener</span><span class="p">.</span><span class="nx">BeginContact</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">contact</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">bS</span><span class="p">.</span><span class="nx">beginContactHandler</span><span class="p">(</span> <span class="nx">contact</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">listener</span><span class="p">.</span><span class="nx">PreSolve</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">contact</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">gB</span><span class="p">.</span><span class="nx">contactNormals</span><span class="p">(</span><span class="s1">&#39;preSolve&#39;</span><span class="p">,</span> <span class="nx">contact</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">listener</span><span class="p">.</span><span class="nx">EndContact</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">contact</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">gB</span><span class="p">.</span><span class="nx">contactNormals</span><span class="p">(</span><span class="s1">&#39;endContact&#39;</span><span class="p">,</span> <span class="nx">contact</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">b2d</span><span class="p">.</span><span class="nx">world</span><span class="p">.</span><span class="nx">SetContactListener</span><span class="p">(</span> <span class="nx">listener</span><span class="p">);</span>
         
      
      
      <span class="c1">// Demo specified in URL query string.</span>
      <span class="c1">// Take the first part of the string (ignore, for now, anything after the &amp; character).</span>
      <span class="kd">var</span> <span class="nx">queryStringInURL</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">search</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;&amp;&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
      <span class="kd">var</span> <span class="nx">demoFromURL</span> <span class="o">=</span> <span class="p">{};</span>
      <span class="kd">var</span> <span class="nx">scrollTargetAtStart</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      
      <span class="c1">// e.g. triquence.org/?7</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">queryStringInURL</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">demoFromURL</span><span class="p">.</span><span class="nx">index</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span> <span class="nx">queryStringInURL</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">));</span>
      
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">queryStringInURL</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">// for a special version of the demo, e.g. demo5d or demo5d.fullscreen</span>
         <span class="c1">// e.g. triquence.org/?7b  or  triquence.org/index.html?3d.8ball</span>
         <span class="k">if</span> <span class="p">((</span><span class="nx">queryStringInURL</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="o">||</span> <span class="nx">queryStringInURL</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">))</span> <span class="p">{</span>
            <span class="c1">// Take everything after the ?</span>
            <span class="nx">demoFromURL</span><span class="p">.</span><span class="nx">file</span> <span class="o">=</span> <span class="s1">&#39;demo&#39;</span> <span class="o">+</span> <span class="nx">queryStringInURL</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.js&#39;</span><span class="p">;</span>
            <span class="c1">// Take only the first character after the ?</span>
            <span class="nx">demoFromURL</span><span class="p">.</span><span class="nx">index</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span> <span class="nx">queryStringInURL</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">));</span>
            
         <span class="c1">// Open to a particular help topic, e.g. triquence.org/?codeLinks</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">scrollTargetAtStart</span> <span class="o">=</span> <span class="nx">queryStringInURL</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
         <span class="p">}</span>
      <span class="p">}</span>

      <span class="nx">sounds</span><span class="p">[</span><span class="s1">&#39;lowPop&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="k">new</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">SoundEffect</span><span class="p">(</span><span class="s2">&quot;sounds/puckpop_lower.mp3&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span> <span class="c1">// n copies...</span>
      <span class="nx">sounds</span><span class="p">[</span><span class="s1">&#39;highPop&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">SoundEffect</span><span class="p">(</span><span class="s2">&quot;sounds/puckpop.mp3&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
      <span class="nx">sounds</span><span class="p">[</span><span class="s1">&#39;clack2&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="k">new</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">SoundEffect</span><span class="p">(</span><span class="s2">&quot;sounds/clack_long_b.mp3&quot;</span><span class="p">,</span> <span class="mi">35</span><span class="p">);</span> <span class="c1">//35 100 Note: version &quot;b&quot; avoids overly quiet play in chrome.</span>
      
      <span class="nx">sounds</span><span class="p">[</span><span class="s1">&#39;monkeyPlacement&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="k">new</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">SoundEffect</span><span class="p">(</span><span class="s2">&quot;sounds/monkey-mocking-and-giggling.mp3&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">);</span>
      <span class="nx">sounds</span><span class="p">[</span><span class="s1">&#39;monkeyPlacement2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">SoundEffect</span><span class="p">(</span><span class="s2">&quot;sounds/monkey-mocking-laugh.mp3&quot;</span><span class="p">,</span>        <span class="mi">1</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">);</span>
      <span class="nx">sounds</span><span class="p">[</span><span class="s1">&#39;monkeyOK&#39;</span><span class="p">]</span> <span class="o">=</span>         <span class="k">new</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">SoundEffect</span><span class="p">(</span><span class="s2">&quot;sounds/monkey-baby-laugh.mp3&quot;</span><span class="p">,</span>           <span class="mi">1</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">);</span>
      <span class="nx">sounds</span><span class="p">[</span><span class="s1">&#39;monkeyAlarmed&#39;</span><span class="p">]</span> <span class="o">=</span>    <span class="k">new</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">SoundEffect</span><span class="p">(</span><span class="s2">&quot;sounds/monkey-alarmed.mp3&quot;</span><span class="p">,</span>              <span class="mi">1</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">);</span>


      <span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;ppTimer&#39;</span><span class="p">]</span> <span class="o">=</span>    <span class="k">new</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">HelpMessage</span><span class="p">({</span><span class="s1">&#39;font&#39;</span><span class="o">:</span><span class="s1">&#39;14px Arial&#39;</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="o">:</span><span class="s1">&#39;lightgray&#39;</span><span class="p">});</span>
      <span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;jelloTimer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">HelpMessage</span><span class="p">({</span><span class="s1">&#39;font&#39;</span><span class="o">:</span><span class="s1">&#39;25px Arial&#39;</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="o">:</span><span class="s1">&#39;lightgray&#39;</span><span class="p">});</span>
      <span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;hoopsTimer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">HelpMessage</span><span class="p">({</span><span class="s1">&#39;font&#39;</span><span class="o">:</span><span class="s1">&#39;18px Arial&#39;</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="o">:</span><span class="s1">&#39;lightgray&#39;</span><span class="p">});</span>
      <span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">=</span>      <span class="k">new</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">HelpMessage</span><span class="p">({</span><span class="s1">&#39;font&#39;</span><span class="o">:</span><span class="s1">&#39;18px Arial&#39;</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="o">:</span><span class="s1">&#39;lightgray&#39;</span><span class="p">});</span>
      <span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">]</span> <span class="o">=</span>       <span class="k">new</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">HelpMessage</span><span class="p">({</span><span class="s1">&#39;font&#39;</span><span class="o">:</span><span class="s1">&#39;20px Arial&#39;</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="o">:</span><span class="s1">&#39;lightgray&#39;</span><span class="p">});</span>   
      <span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help2&#39;</span><span class="p">]</span> <span class="o">=</span>      <span class="k">new</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">HelpMessage</span><span class="p">({</span><span class="s1">&#39;font&#39;</span><span class="o">:</span><span class="s1">&#39;20px Arial&#39;</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="o">:</span><span class="s1">&#39;lightgray&#39;</span><span class="p">});</span>
      <span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;EpLreport&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="k">new</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">HelpMessage</span><span class="p">({</span><span class="s1">&#39;font&#39;</span><span class="o">:</span><span class="s2">&quot;17px Courier, &#39;Courier New&#39;, monospace&quot;</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="o">:</span><span class="s1">&#39;white&#39;</span><span class="p">});</span>
      <span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;win&#39;</span><span class="p">]</span> <span class="o">=</span>        <span class="k">new</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">HelpMessage</span><span class="p">({</span><span class="s1">&#39;font&#39;</span><span class="o">:</span><span class="s1">&#39;20px Arial&#39;</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="o">:</span><span class="s1">&#39;yellow&#39;</span><span class="p">});</span>
      <span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;lowHelp&#39;</span><span class="p">]</span> <span class="o">=</span>    <span class="k">new</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">HelpMessage</span><span class="p">({</span><span class="s1">&#39;font&#39;</span><span class="o">:</span><span class="s1">&#39;20px Arial&#39;</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="o">:</span><span class="s1">&#39;yellow&#39;</span><span class="p">});</span>
      <span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;gameTitle&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="k">new</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">HelpMessage</span><span class="p">({</span><span class="s1">&#39;font&#39;</span><span class="o">:</span><span class="s1">&#39;50px Arial&#39;</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="o">:</span><span class="s1">&#39;lightgray&#39;</span><span class="p">});</span>
      <span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;videoTitle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">HelpMessage</span><span class="p">({</span><span class="s1">&#39;color&#39;</span><span class="o">:</span><span class="s1">&#39;lightgray&#39;</span><span class="p">});</span>

      <span class="c1">// Initialize the canvas display window.</span>
      
      <span class="nx">myRequest</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="nx">resumingAfterPause</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="nx">time_previous</span> <span class="o">=</span> <span class="nx">performance</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span> <span class="c1">// Initialize the previous time variable to now.</span>
      
      <span class="nx">canvasDiv</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;hostCanvasDiv&#39;</span><span class="p">);</span>
      <span class="nx">canvas</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;hostCanvas&#39;</span><span class="p">);</span>
      <span class="nx">ctx</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s1">&#39;2d&#39;</span><span class="p">);</span>

      <span class="c1">// Add a local user to the clients dictionary.</span>
      <span class="k">new</span> <span class="nx">cT</span><span class="p">.</span><span class="nx">Client</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="o">:</span><span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="o">:</span><span class="s1">&#39;tomato&#39;</span><span class="p">});</span>
      
      <span class="c1">// share some of the globals in gwModule.js with other modules</span>
      
      <span class="nx">eV</span><span class="p">.</span><span class="nx">initializeModule</span><span class="p">(</span> <span class="nx">canvas</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">,</span> <span class="nx">dC</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">aT</span><span class="p">,</span> <span class="nx">keyMap</span><span class="p">,</span> <span class="nx">clients</span><span class="p">,</span> <span class="nx">ts</span><span class="p">);</span> <span class="c1">// keyboard, mouse, and touch event handlers for the host</span>
      <span class="nx">dS</span><span class="p">.</span><span class="nx">initializeModule</span><span class="p">(</span> <span class="nx">canvas</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">,</span> <span class="nx">dC</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">aT</span><span class="p">,</span> <span class="nx">keyMap</span><span class="p">,</span> <span class="nx">clients</span><span class="p">);</span> <span class="c1">// demo starter</span>
      <span class="nx">tA</span><span class="p">.</span><span class="nx">initializeModule</span><span class="p">(</span> <span class="nx">canvas</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">);</span> <span class="c1">// table actions</span>
      
      <span class="nx">cT</span><span class="p">.</span><span class="nx">initializeModule</span><span class="p">(</span> <span class="nx">canvas</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">);</span> <span class="c1">// client prototype and client-state updater</span>
      
      <span class="nx">cR</span><span class="p">.</span><span class="nx">initializeModule</span><span class="p">(</span> <span class="nx">canvas</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">);</span> <span class="c1">// capture and restore</span>
      
      <span class="nx">gB</span><span class="p">.</span><span class="nx">initializeModule</span><span class="p">(</span> <span class="nx">canvas</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">);</span> <span class="c1">// Ghost Ball Pool</span>
      
      <span class="c1">// twoThumbs is initialized in hostAndClient.js</span>
      
      <span class="c1">// The running average.</span>
      <span class="nx">aT</span><span class="p">.</span><span class="nx">dt_RA_ms</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">uT</span><span class="p">.</span><span class="nx">RunningAverage</span><span class="p">(</span><span class="mi">60</span><span class="p">);</span>
      <span class="nx">dC</span><span class="p">.</span><span class="nx">fps</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;fps&quot;</span><span class="p">);</span>
      
      <span class="nx">dC</span><span class="p">.</span><span class="nx">extraDemos</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;extraDemos&quot;</span><span class="p">);</span>
      <span class="nx">dC</span><span class="p">.</span><span class="nx">indexInPlusRow</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;indexInPlusRow&quot;</span><span class="p">);</span>

      <span class="c1">// Start the blank demo for frame rate testing.</span>
      <span class="nx">dS</span><span class="p">.</span><span class="nx">demoStart</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;restartLoop&#39;</span><span class="o">:</span><span class="kc">false</span><span class="p">,</span> <span class="s1">&#39;logThis&#39;</span><span class="o">:</span><span class="kc">false</span><span class="p">});</span>
      <span class="kd">var</span> <span class="nx">fpsTestDelay</span> <span class="o">=</span> <span class="mi">1800</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">startupDelay</span> <span class="o">=</span>  <span class="mi">2000</span><span class="p">;</span>
      
      <span class="c1">// Wait about 2 seconds for the blank demo (#0) to settle in, then set the physics time-step (frame rate) </span>
      <span class="c1">// based on the observed display rate.</span>
      <span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s1">&#39;starting...&#39;</span><span class="p">,</span> <span class="nx">startupDelay</span><span class="o">/</span><span class="mf">1000.0</span><span class="p">);</span>
      <span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> 
         <span class="nx">setFrameRateBasedOnDisplayRate</span><span class="p">();</span>
      <span class="p">},</span> <span class="nx">fpsTestDelay</span><span class="p">);</span>
      
      <span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> 
         <span class="c1">// Start the &quot;ready&quot; message about 0.5 seconds before the demo starts.</span>
         <span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s1">&#39;...ready.&#39;</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">);</span>
      <span class="p">},</span> <span class="nx">startupDelay</span> <span class="o">-</span> <span class="mi">500</span><span class="p">);</span>
      
      <span class="c1">//////////////////////////////////////////////////////////////////////////</span>
      <span class="c1">// Now, about 0.2 seconds after the framerate measurement, start the demo.</span>
      <span class="c1">//////////////////////////////////////////////////////////////////////////</span>
      <span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">demoFromURL</span><span class="p">.</span><span class="nx">file</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">cR</span><span class="p">.</span><span class="nx">demoStart_fromCapture</span><span class="p">(</span> <span class="nx">demoFromURL</span><span class="p">.</span><span class="nx">index</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;fileName&#39;</span><span class="o">:</span><span class="nx">demoFromURL</span><span class="p">.</span><span class="nx">file</span><span class="p">});</span>
         <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span> <span class="o">!</span> <span class="nx">demoFromURL</span><span class="p">.</span><span class="nx">file</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">demoFromURL</span><span class="p">.</span><span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">dS</span><span class="p">.</span><span class="nx">demoStart</span><span class="p">(</span> <span class="nx">demoFromURL</span><span class="p">.</span><span class="nx">index</span><span class="p">);</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">dS</span><span class="p">.</span><span class="nx">demoStart</span><span class="p">(</span> <span class="mi">9</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;scrollHelp&#39;</span><span class="o">:</span><span class="kc">false</span><span class="p">,</span> <span class="s1">&#39;logThis&#39;</span><span class="o">:</span><span class="kc">false</span><span class="p">});</span> <span class="c1">// don&#39;t scroll to demo-9 help when the page loads</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">scrollTargetAtStart</span><span class="p">)</span> <span class="nx">pS</span><span class="p">.</span><span class="nx">scroll</span><span class="p">(</span> <span class="nx">scrollTargetAtStart</span><span class="p">);</span>
         <span class="p">}</span>
      <span class="p">},</span> <span class="nx">startupDelay</span><span class="p">);</span>
      
   <span class="p">}</span> <span class="c1">// end of init()</span>

   
   <span class="c1">// It&#39;s alive. MuuuUUuuuAhhhh Haaaaaa Ha Ha Ha.</span>
   <span class="kd">function</span> <span class="nx">gameLoop</span><span class="p">(</span> <span class="nx">timeStamp_ms</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Note: The time-stamp argument can have any name.</span>
      
      <span class="nx">dt_frame_ms</span> <span class="o">=</span> <span class="nx">timeStamp_ms</span> <span class="o">-</span> <span class="nx">time_previous</span><span class="p">;</span>
      <span class="c1">//dt_frame_ms = c.deltaT_s * 1000;</span>
      <span class="c1">//dt_frame_ms = 1000 * 1/60.0</span>
      <span class="nx">dt_frame_s</span> <span class="o">=</span> <span class="nx">dt_frame_ms</span> <span class="o">/</span> <span class="mf">1000.0</span><span class="p">;</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="nx">resumingAfterPause</span> <span class="o">||</span> <span class="p">(</span><span class="nx">dt_frame_s</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">))</span> <span class="p">{</span>
         <span class="c1">// Use the dt info saved in last frame before it was paused.</span>
         <span class="nx">dt_frame_ms</span> <span class="o">=</span> <span class="nx">dt_frame_previous_ms</span><span class="p">;</span>
         <span class="nx">dt_frame_s</span> <span class="o">=</span> <span class="nx">dt_frame_ms</span> <span class="o">/</span> <span class="mf">1000.0</span><span class="p">;</span>
         <span class="nx">time_previous</span> <span class="o">=</span> <span class="nx">performance</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
         <span class="nx">resumingAfterPause</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">dtFloating</span><span class="p">)</span> <span class="nx">c</span><span class="p">.</span><span class="nx">deltaT_s</span> <span class="o">=</span> <span class="nx">dt_frame_s</span><span class="p">;</span>
      
      <span class="kd">var</span> <span class="nx">dt_avg_ms</span> <span class="o">=</span> <span class="nx">aT</span><span class="p">.</span><span class="nx">dt_RA_ms</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span> <span class="nx">dt_frame_ms</span><span class="p">);</span>
      
      <span class="c1">// Report frame-rate every half second.</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">aT</span><span class="p">.</span><span class="nx">dt_RA_ms</span><span class="p">.</span><span class="nx">totalSinceReport</span> <span class="o">&gt;</span> <span class="mf">500.0</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">dC</span><span class="p">.</span><span class="nx">fps</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="nx">dt_avg_ms</span><span class="o">/</span><span class="mi">1000</span><span class="p">)).</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
         <span class="nx">aT</span><span class="p">.</span><span class="nx">dt_RA_ms</span><span class="p">.</span><span class="nx">totalSinceReport</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
      <span class="p">}</span>
      
      <span class="c1">// Draw the walls, step the engine, draw the pucks.</span>
      <span class="nx">updateAirTable</span><span class="p">();</span>
      
      <span class="nx">time_previous</span> <span class="o">=</span> <span class="nx">timeStamp_ms</span><span class="p">;</span>
      <span class="nx">dt_frame_previous_ms</span> <span class="o">=</span> <span class="nx">dt_frame_ms</span>
      
      <span class="nx">myRequest</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">requestAnimationFrame</span><span class="p">(</span> <span class="nx">gameLoop</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">singleStep</span><span class="p">)</span> <span class="nx">stopit</span><span class="p">();</span>
   <span class="p">}</span>
   
   <span class="kd">function</span> <span class="nx">clearCanvas</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">canvas_width_px_int</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span><span class="p">);</span>
      <span class="kd">let</span> <span class="nx">canvas_height_px_int</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>
      
      <span class="c1">// Clear the canvas (from one corner to the other)</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">globalCompositeOperation</span> <span class="o">==</span> <span class="s1">&#39;screen&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">ctx</span><span class="p">.</span><span class="nx">clearRect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="nx">canvas_width_px_int</span><span class="p">,</span> <span class="nx">canvas_height_px_int</span><span class="p">);</span>
         
         <span class="nx">ctx</span><span class="p">.</span><span class="nx">fillStyle</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span><span class="p">;</span>
         <span class="nx">ctx</span><span class="p">.</span><span class="nx">fillRect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="nx">canvas_width_px_int</span><span class="p">,</span> <span class="nx">canvas_height_px_int</span><span class="p">);</span>
         
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="nx">ctx</span><span class="p">.</span><span class="nx">fillStyle</span> <span class="o">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">canvasColor</span><span class="p">;</span>
         <span class="nx">ctx</span><span class="p">.</span><span class="nx">fillRect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="nx">canvas_width_px_int</span><span class="p">,</span> <span class="nx">canvas_height_px_int</span><span class="p">);</span>
      <span class="p">}</span>
   <span class="p">}</span>
   
   <span class="kd">function</span> <span class="nx">updateAirTable</span><span class="p">()</span> <span class="p">{</span>
      <span class="cm">/*</span>
<span class="cm">      This update function is structured as follows:</span>
<span class="cm">      </span>
<span class="cm">      1. Based on user input (cursor, keyboard, and network client), update all things that affect the physics engine:</span>
<span class="cm">         position the cursor springs and the ghost-puck sensor, deleted objects, and calculate external spring and impulse forces.</span>
<span class="cm">      2. Step the physics engine.</span>
<span class="cm">      3. Calculate the screen positions of objects as affected by the physics engine</span>
<span class="cm">         and draw the results.</span>
<span class="cm">      */</span>
      
      <span class="cm">/*</span>
<span class="cm">      Most of the event-based (asynchronous) input is &quot;allowed&quot; to enter this </span>
<span class="cm">      update function at any time. However, the mouse position input is copied </span>
<span class="cm">      at the beginning of this function. For consistency, all processing of </span>
<span class="cm">      the mouse position is based on this copy, not the mouse_async_2d_px </span>
<span class="cm">      values. In effect, the async mouse input is blocked from entering this </span>
<span class="cm">      function anywhere but here at the beginning. </span>
<span class="cm">      </span>
<span class="cm">      I put quotes on &quot;allowed&quot; in the previous paragraph because the </span>
<span class="cm">      mousemove events are coalesced (by the browser) and released at the </span>
<span class="cm">      beginning of requestAnimationFrame cycle. So you will NEVER see host&#39;s </span>
<span class="cm">      (local client) mouse position updated during the execution of this </span>
<span class="cm">      updateAirTable function. Network clients mouse position can be updated </span>
<span class="cm">      during updateAirTable since the WebRTC events are not coalesced. So the </span>
<span class="cm">      use of the &quot;copy&quot; actually enforces consistency for the clients mouse </span>
<span class="cm">      position during updateAirTable. </span>

<span class="cm">      Search this code for the c.lagTesting flag (only changeable via code edit) </span>
<span class="cm">      that enables the drawing of a little circle directly in the event handlers </span>
<span class="cm">      for mouse position (), cyan for host, white for network clients.</span>
<span class="cm">         * Use alt-p to inhibit erasing</span>
<span class="cm">         * Use p to inhibit the requestAnimationFrame loop.</span>
<span class="cm">      </span>
<span class="cm">      Note: web search on getCoalescedEvents.</span>
<span class="cm">      </span>
<span class="cm">      Input delay (or lag) is an issue with html games and to some extent </span>
<span class="cm">      this site. If you check the &quot;Multiplayer&quot; option and then check the </span>
<span class="cm">      &quot;Local cursor&quot; option you will be able see the delay to the cursor </span>
<span class="cm">      rendered on the canvas. This delay will generally range from 2 to 5 </span>
<span class="cm">      fames. You can calibrate your sense of delay here: </span>
<span class="cm">      </span>
<span class="cm">      https://www.vsynctester.com/</span>
<span class="cm">      */</span>
      
      <span class="c1">// Copy the event-based results for use in the loop.</span>
      <span class="nx">cT</span><span class="p">.</span><span class="nx">Client</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span> <span class="nx">client</span> <span class="p">=&gt;</span> <span class="p">{</span>
         <span class="nx">client</span><span class="p">.</span><span class="nx">prev_mouse_2d_px</span> <span class="o">=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">mouse_2d_px</span><span class="p">.</span><span class="nx">copy</span><span class="p">();</span>
         <span class="nx">client</span><span class="p">.</span><span class="nx">mouse_2d_px</span> <span class="o">=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">mouse_async_2d_px</span><span class="p">.</span><span class="nx">copy</span><span class="p">();</span>
         <span class="nx">client</span><span class="p">.</span><span class="nx">mouse_2d_m</span> <span class="o">=</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">worldFromScreen</span><span class="p">(</span> <span class="nx">client</span><span class="p">.</span><span class="nx">mouse_2d_px</span><span class="p">);</span>
      <span class="p">});</span>
      
      <span class="cm">/*</span>
<span class="cm">      Leaving this commented block here as an example of a technique for deleting elements</span>
<span class="cm">      from an array when looping over it.</span>
<span class="cm">      </span>
<span class="cm">      // Clean out old bullets and unhealthy pucks. Note this loops</span>
<span class="cm">      // in reverse order over the array to avoid indexing problems as the</span>
<span class="cm">      // array elements are deleted.</span>
<span class="cm">      for (var j = aT.pucks.length - 1; j &gt;= 0; j--) {</span>
<span class="cm">         if (aT.pucks[j].bullet) {</span>
<span class="cm">            var age_ms = window.performance.now() - aT.pucks[j].createTime;</span>
<span class="cm">            if (age_ms &gt; aT.pucks[j].ageLimit_ms) {  </span>
<span class="cm">               deletePuckAndParts( aT.pucks[j]);</span>
<span class="cm">               aT.pucks.splice(j, 1);</span>
<span class="cm">            }</span>
<span class="cm">         } else if (aT.pucks[j].poorHealthFraction &gt;= 1.0) {</span>
<span class="cm">            deletePuckAndParts( aT.pucks[j]);</span>
<span class="cm">            aT.pucks.splice(j, 1);</span>
<span class="cm">         }</span>
<span class="cm">      }     </span>
<span class="cm">      */</span>
      
      <span class="c1">// Update bullet age and clean out old bullets and unhealthy pucks.</span>
      <span class="k">if</span> <span class="p">((</span><span class="nx">c</span><span class="p">.</span><span class="nx">demoIndex</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">demoIndex</span> <span class="o">==</span> <span class="mi">8</span><span class="p">))</span> <span class="p">{</span>
         <span class="nx">pP</span><span class="p">.</span><span class="nx">deleteOldandUnhealthy</span><span class="p">(</span> <span class="nx">c</span><span class="p">.</span><span class="nx">deltaT_s</span><span class="p">);</span>
      <span class="p">}</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="nx">aT</span><span class="p">.</span><span class="nx">collisionInThisStep</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">// If not using the PiEngine but still doing some pi calculations (e.g. demo 1c), </span>
         <span class="c1">// you&#39;ll need to do a few things like play the clack sound.</span>
         <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">c</span><span class="p">.</span><span class="nx">piCalcs</span><span class="p">.</span><span class="nx">usePiEngine</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">piCalcs</span><span class="p">.</span><span class="nx">clacks</span><span class="p">)</span> <span class="nx">sounds</span><span class="p">[</span><span class="s1">&#39;clack2&#39;</span><span class="p">].</span><span class="nx">play</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">piCalcs</span><span class="p">.</span><span class="nx">enabled</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">aT</span><span class="p">.</span><span class="nx">puckMap</span><span class="p">[</span><span class="s1">&#39;puck1&#39;</span><span class="p">].</span><span class="nx">vmax</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span> <span class="nx">aT</span><span class="p">.</span><span class="nx">puckMap</span><span class="p">[</span><span class="s1">&#39;puck1&#39;</span><span class="p">].</span><span class="nx">vmax</span><span class="p">,</span> <span class="nx">aT</span><span class="p">.</span><span class="nx">puckMap</span><span class="p">[</span><span class="s1">&#39;puck1&#39;</span><span class="p">].</span><span class="nx">velocity_2d_mps</span><span class="p">.</span><span class="nx">y</span><span class="p">);</span>
               <span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="s2">&quot;count = &quot;</span> <span class="o">+</span> <span class="nx">aT</span><span class="p">.</span><span class="nx">collisionCount</span> <span class="o">+</span> <span class="s2">&quot;\\v max = &quot;</span> <span class="o">+</span> <span class="nx">aT</span><span class="p">.</span><span class="nx">puckMap</span><span class="p">[</span><span class="s1">&#39;puck1&#39;</span><span class="p">].</span><span class="nx">vmax</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
            <span class="p">}</span>
         <span class="p">}</span> 
      <span class="p">}</span>
      
      <span class="nx">cP</span><span class="p">.</span><span class="nx">Spring</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span> <span class="nx">spring</span> <span class="p">=&gt;</span> <span class="p">{</span>
         <span class="c1">// If either puck/pin has been deleted, remove the spring.</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">spring</span><span class="p">.</span><span class="nx">spo1</span><span class="p">.</span><span class="nx">deleted</span> <span class="o">||</span> <span class="nx">spring</span><span class="p">.</span><span class="nx">spo2</span><span class="p">.</span><span class="nx">deleted</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Remove this spring from the spring map.</span>
            <span class="nx">spring</span><span class="p">.</span><span class="nx">deleteThisOne</span><span class="p">({});</span>
         <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// Otherwise, business as usual.</span>
            <span class="nx">spring</span><span class="p">.</span><span class="nx">force_on_pucks</span><span class="p">();</span>
         <span class="p">}</span>
      <span class="p">});</span>
      <span class="nx">cP</span><span class="p">.</span><span class="nx">Joint</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span> <span class="nx">joint</span> <span class="p">=&gt;</span> <span class="p">{</span>
         <span class="c1">// If either table object has been deleted, remove the joint.</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">joint</span><span class="p">.</span><span class="nx">jto1</span><span class="p">.</span><span class="nx">deleted</span> <span class="o">||</span> <span class="nx">joint</span><span class="p">.</span><span class="nx">jto2</span><span class="p">.</span><span class="nx">deleted</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">joint</span><span class="p">.</span><span class="nx">deleteThisOne</span><span class="p">({});</span>
         <span class="p">}</span>
      <span class="p">});</span>
      
      <span class="c1">// Update the games</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">demoVersion</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;3.d&quot;</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">// A timer limits how often checks are run on pool-game state. Check once for every c.poolTimer_stateCheckLimit_s timer period.</span>
         <span class="nx">gB</span><span class="p">.</span><span class="nx">checkPoolGameState</span><span class="p">(</span> <span class="nx">ctx</span><span class="p">);</span>
      
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">uT</span><span class="p">.</span><span class="nx">oneOfThese</span><span class="p">([</span><span class="s1">&#39;6.a&#39;</span><span class="p">,</span><span class="s1">&#39;6.d&#39;</span><span class="p">],</span> <span class="nx">c</span><span class="p">.</span><span class="nx">demoVersion</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">jM</span><span class="p">.</span><span class="nx">puckCount</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
         <span class="nx">jM</span><span class="p">.</span><span class="nx">checkForJelloTangle</span><span class="p">();</span>
      
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">uT</span><span class="p">.</span><span class="nx">oneOfThese</span><span class="p">([</span><span class="s1">&#39;basketball&#39;</span><span class="p">],</span> <span class="nx">c</span><span class="p">.</span><span class="nx">demoVersion</span><span class="p">))</span> <span class="p">{</span>
         <span class="nx">bpH</span><span class="p">.</span><span class="nx">checkTimeLimit</span><span class="p">();</span>
      
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(((</span><span class="nx">c</span><span class="p">.</span><span class="nx">demoIndex</span> <span class="o">==</span> <span class="mi">7</span> <span class="o">||</span> <span class="nx">c</span><span class="p">.</span><span class="nx">demoIndex</span> <span class="o">==</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">pP</span><span class="p">.</span><span class="nx">getNpcSleep</span><span class="p">()))</span> <span class="p">{</span>
         <span class="nx">pP</span><span class="p">.</span><span class="nx">checkForPuckPopperWinnerAndReport</span><span class="p">();</span>
      <span class="p">}</span>
      
      <span class="c1">// Consider all client-mouse influences on a selected object.</span>
      <span class="nx">cT</span><span class="p">.</span><span class="nx">Client</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span> <span class="nx">client</span> <span class="p">=&gt;</span> <span class="p">{</span>
         
         <span class="c1">// Jets and Guns</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">puck</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Tell the NPCs what to do.</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;NPC&#39;</span><span class="p">)</span> <span class="p">{</span>
               <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">pP</span><span class="p">.</span><span class="nx">getNpcSleep</span><span class="p">())</span> <span class="nx">pP</span><span class="p">.</span><span class="nx">thinkForNPC</span><span class="p">(</span> <span class="nx">client</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">deltaT_s</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="c1">// Respond to client controls, calculate corresponding jet and gun recoil forces, and draw.</span>
            <span class="nx">client</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">jet</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span> <span class="nx">c</span><span class="p">.</span><span class="nx">deltaT_s</span><span class="p">);</span>
            <span class="nx">client</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">gun</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span> <span class="nx">c</span><span class="p">.</span><span class="nx">deltaT_s</span><span class="p">);</span>
            
            <span class="c1">// If sweeping the gun with the TwoThumbs scope control, send out the resulting gunAngle to the client.</span>
            <span class="nx">pP</span><span class="p">.</span><span class="nx">gunAngleFromHost</span><span class="p">(</span> <span class="nx">client</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">deltaT_s</span><span class="p">);</span>
         <span class="p">}</span>
         
         <span class="c1">// Check to see if the mouse button is down and if there&#39;s a body under the cursor.</span>
         <span class="c1">// Select it and/or add it to the multi-select group.</span>
         <span class="nx">client</span><span class="p">.</span><span class="nx">checkForMouseSelection</span><span class="p">();</span>
         
         <span class="c1">// Note that network clients are NOT allowed to select walls and pins (see checkForMouseSelection).</span>
         <span class="c1">// So only the local client will get into the following block in those (wall and pin) cases.</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// World position of selection points are needed for direct movements and for spring calculations.</span>
            <span class="nx">client</span><span class="p">.</span><span class="nx">updateSelectionPoint</span><span class="p">();</span>
            
            <span class="nx">gB</span><span class="p">.</span><span class="nx">resetPathAfterShot</span><span class="p">(</span> <span class="nx">client</span><span class="p">);</span>
            
            <span class="c1">// direct movement</span>
            <span class="k">if</span> <span class="p">((</span><span class="nx">client</span><span class="p">.</span><span class="nx">key_ctrl</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">ctrlShiftLock</span><span class="p">))</span> <span class="p">{</span>
               
               <span class="c1">// If the choke is open (null), take exclusive ownership of direct movements. Note that this client</span>
               <span class="c1">// will release its ownership via mouse-up or control-key-up events.</span>
               <span class="k">if</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">firstClientDirectMove</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">firstClientDirectMove</span> <span class="o">=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
               <span class="p">}</span> 
               <span class="c1">// Allow only one client at a time to make direct movements.</span>
               <span class="k">if</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">firstClientDirectMove</span><span class="p">)</span> <span class="p">{</span>
                  <span class="c1">// translation</span>
                  <span class="k">if</span> <span class="p">((</span><span class="nx">client</span><span class="p">.</span><span class="nx">key_ctrl</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">key_shift</span> <span class="o">==</span> <span class="s1">&#39;U&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">key_alt</span> <span class="o">==</span> <span class="s1">&#39;U&#39;</span><span class="p">))</span> <span class="p">{</span>
                     <span class="nx">client</span><span class="p">.</span><span class="nx">moveToCursorPosition</span><span class="p">();</span>
                     
                     <span class="k">if</span> <span class="p">([</span><span class="s1">&#39;Wall&#39;</span><span class="p">,</span><span class="s1">&#39;Pin&#39;</span><span class="p">].</span><span class="nx">includes</span><span class="p">(</span> <span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span><span class="p">))</span> <span class="p">{</span>
                        <span class="nx">aT</span><span class="p">.</span><span class="nx">hack</span><span class="p">[</span><span class="s1">&#39;wallpinDirectMove&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                     <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">([</span><span class="s1">&#39;Puck&#39;</span><span class="p">].</span><span class="nx">includes</span><span class="p">(</span> <span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span><span class="p">))</span> <span class="p">{</span>
                        <span class="nx">aT</span><span class="p">.</span><span class="nx">hack</span><span class="p">[</span><span class="s1">&#39;puckDirectMove&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                     <span class="p">}</span>
                     
                  <span class="c1">// rotation</span>
                  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="p">((</span><span class="nx">client</span><span class="p">.</span><span class="nx">key_ctrl</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">key_shift</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="p">))</span> <span class="o">||</span> <span class="p">((</span><span class="nx">client</span><span class="p">.</span><span class="nx">ctrlShiftLock</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s1">&#39;Puck&#39;</span><span class="p">))</span> <span class="p">)</span> <span class="p">{</span>
                     <span class="nx">client</span><span class="p">.</span><span class="nx">rotateToCursorPosition</span><span class="p">();</span>
                  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="nx">client</span><span class="p">.</span><span class="nx">key_ctrl</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">key_alt</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="p">))</span> <span class="p">{</span>
                     <span class="nx">client</span><span class="p">.</span><span class="nx">rotateEachAboutItself</span><span class="p">();</span>
                  <span class="p">}</span>               
               <span class="p">}</span>
            <span class="p">}</span>
         <span class="p">}</span>
         
         <span class="c1">// Prepare to draw a cursor for the local and network clients.</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;NPC&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">deviceType</span> <span class="o">!=</span> <span class="s1">&#39;mobile&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">client</span><span class="p">.</span><span class="nx">twoThumbsEnabled</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span> 
               <span class="nx">client</span><span class="p">.</span><span class="nx">updateCursor</span><span class="p">();</span> <span class="c1">// and ghost ball...</span>
            <span class="p">}</span>
         <span class="p">}</span> 
      <span class="p">});</span>
      
      <span class="c1">// Sum up all the forces and apply them to the pucks.</span>
      <span class="nx">cP</span><span class="p">.</span><span class="nx">Puck</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span> <span class="nx">puck</span> <span class="p">=&gt;</span> <span class="p">{</span>
         <span class="nx">puck</span><span class="p">.</span><span class="nx">applyForces</span><span class="p">(</span> <span class="nx">c</span><span class="p">.</span><span class="nx">deltaT_s</span><span class="p">);</span> 
      <span class="p">});</span>
      
      <span class="c1">//////////////////////////////////////////////////////////////////////////////////////////////////////</span>
      <span class="c1">// Step the physics engine (calculate the resulting state of the objects)</span>
      <span class="c1">//////////////////////////////////////////////////////////////////////////////////////////////////////</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">piCalcs</span><span class="p">.</span><span class="nx">usePiEngine</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">pE</span><span class="p">.</span><span class="nx">step</span><span class="p">(</span> <span class="nx">c</span><span class="p">.</span><span class="nx">deltaT_s</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="nx">aT</span><span class="p">.</span><span class="nx">collisionInThisStep</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
         <span class="nx">b2d</span><span class="p">.</span><span class="nx">world</span><span class="p">.</span><span class="nx">Step</span><span class="p">(</span> <span class="nx">c</span><span class="p">.</span><span class="nx">deltaT_s</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>  <span class="c1">// dt, vel iterations, pos iterations: dt,10,10</span>
         <span class="nx">c</span><span class="p">.</span><span class="nx">frameCount</span><span class="o">++</span><span class="p">;</span>
         <span class="nx">b2d</span><span class="p">.</span><span class="nx">world</span><span class="p">.</span><span class="nx">ClearForces</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="c1">///////////////////////////////////////////////////////////////////////////////////////////////////////</span>
      <span class="c1">///////////////////////////////////////////////////////////////////////////////////////////////////////</span>
      
      <span class="c1">// Precede all drawing operations by clearing off the canvas.</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">c</span><span class="p">.</span><span class="nx">pauseErase</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">clearCanvas</span><span class="p">();</span>
      <span class="p">}</span>
      
      <span class="c1">// Start with the walls (render these on the bottom).</span>
      <span class="nx">cP</span><span class="p">.</span><span class="nx">Wall</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span> <span class="nx">wall</span> <span class="p">=&gt;</span> <span class="p">{</span>
         <span class="nx">wall</span><span class="p">.</span><span class="nx">draw</span><span class="p">(</span> <span class="nx">ctx</span><span class="p">);</span>
      <span class="p">});</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">demoVersion</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;3.d&quot;</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">cT</span><span class="p">.</span><span class="nx">Client</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span> <span class="nx">client</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="nx">gB</span><span class="p">.</span><span class="nx">drawPathAfterShot</span><span class="p">(</span> <span class="nx">ctx</span><span class="p">,</span> <span class="nx">client</span><span class="p">);</span>
         <span class="p">});</span>
      <span class="p">}</span>
      
      <span class="nx">cP</span><span class="p">.</span><span class="nx">Puck</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span> <span class="nx">puck</span> <span class="p">=&gt;</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">c</span><span class="p">.</span><span class="nx">piCalcs</span><span class="p">.</span><span class="nx">usePiEngine</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">puck</span><span class="p">.</span><span class="nx">updateState</span><span class="p">();</span>
         <span class="p">}</span>
         <span class="nx">puck</span><span class="p">.</span><span class="nx">draw</span><span class="p">(</span> <span class="nx">ctx</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">deltaT_s</span><span class="p">);</span>
      <span class="p">});</span>
      
      <span class="c1">// Select all springs where both ends are connected to pucks/pins in the multiselect map.</span>
      <span class="nx">cP</span><span class="p">.</span><span class="nx">Spring</span><span class="p">.</span><span class="nx">findAll_InMultiSelect</span><span class="p">(</span> <span class="nx">spring</span> <span class="p">=&gt;</span> <span class="p">{</span><span class="k">if</span> <span class="p">(</span><span class="nx">spring</span><span class="p">.</span><span class="nx">name</span> <span class="o">!=</span> <span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">candidateReportPasteDelete</span><span class="p">)</span> <span class="nx">spring</span><span class="p">.</span><span class="nx">selected</span> <span class="o">=</span> <span class="kc">true</span><span class="p">});</span>
      <span class="nx">cP</span><span class="p">.</span><span class="nx">Joint</span><span class="p">.</span><span class="nx">findAll_InMultiSelect</span><span class="p">(</span> <span class="nx">joint</span> <span class="p">=&gt;</span> <span class="p">{</span><span class="k">if</span> <span class="p">(</span><span class="nx">joint</span><span class="p">.</span><span class="nx">name</span> <span class="o">!=</span> <span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">candidateReportPasteDelete</span><span class="p">)</span> <span class="nx">joint</span><span class="p">.</span><span class="nx">selected</span> <span class="o">=</span> <span class="kc">true</span><span class="p">});</span>
      
      <span class="nx">cP</span><span class="p">.</span><span class="nx">Spring</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span> <span class="nx">spring</span> <span class="p">=&gt;</span> <span class="p">{</span>
         <span class="c1">// Note that the draw method calls calculateSeparation, updating the stretch calculation.</span>
         <span class="nx">spring</span><span class="p">.</span><span class="nx">draw</span><span class="p">(</span> <span class="nx">ctx</span><span class="p">);</span>
         <span class="c1">// For a single spring, write report.</span>
         <span class="k">if</span> <span class="p">(</span> <span class="p">((</span><span class="nx">cP</span><span class="p">.</span><span class="nx">Spring</span><span class="p">.</span><span class="nx">countInMultiSelect</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">spring</span><span class="p">.</span><span class="nx">inMultiSelect</span><span class="p">()))</span> <span class="o">||</span> <span class="p">((</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">candidateReportPasteDelete</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">spring</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">candidateReportPasteDelete</span><span class="p">))</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">cP</span><span class="p">.</span><span class="nx">EpL</span><span class="p">.</span><span class="nx">displayReport</span><span class="p">)</span> <span class="nx">spring</span><span class="p">.</span><span class="nx">report</span><span class="p">();</span>
         <span class="p">}</span>
      <span class="p">});</span>
      
      <span class="c1">// Run this report after the spring draw above (calculates stretch value) and the puck.updateState method.</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">cP</span><span class="p">.</span><span class="nx">EpL</span><span class="p">.</span><span class="nx">displayReport</span><span class="p">)</span> <span class="nx">cP</span><span class="p">.</span><span class="nx">EpL</span><span class="p">.</span><span class="nx">generateReport</span><span class="p">();</span>
      
      <span class="nx">cP</span><span class="p">.</span><span class="nx">Pin</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span> <span class="nx">pin</span> <span class="p">=&gt;</span> <span class="p">{</span>
         <span class="nx">pin</span><span class="p">.</span><span class="nx">draw</span><span class="p">(</span> <span class="nx">ctx</span><span class="p">,</span> <span class="nx">pin</span><span class="p">.</span><span class="nx">radius_px</span><span class="p">);</span>
      <span class="p">});</span>
      
      <span class="nx">cP</span><span class="p">.</span><span class="nx">Joint</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span> <span class="nx">joint</span> <span class="p">=&gt;</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span> <span class="p">((</span><span class="nx">cP</span><span class="p">.</span><span class="nx">Joint</span><span class="p">.</span><span class="nx">countInMultiSelect</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">cP</span><span class="p">.</span><span class="nx">Spring</span><span class="p">.</span><span class="nx">countInMultiSelect</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">joint</span><span class="p">.</span><span class="nx">inMultiSelect</span><span class="p">()))</span> <span class="o">||</span> <span class="p">((</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">candidateReportPasteDelete</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">joint</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">candidateReportPasteDelete</span><span class="p">))</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">joint</span><span class="p">.</span><span class="nx">report</span><span class="p">();</span>
         <span class="p">}</span>
         <span class="nx">joint</span><span class="p">.</span><span class="nx">draw</span><span class="p">(</span> <span class="nx">ctx</span><span class="p">);</span>
      <span class="p">});</span>
      
      <span class="nx">cT</span><span class="p">.</span><span class="nx">Client</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span> <span class="nx">client</span> <span class="p">=&gt;</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">puck</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">client</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">jet</span><span class="p">.</span><span class="nx">draw</span><span class="p">(</span> <span class="nx">ctx</span><span class="p">);</span>
            <span class="nx">client</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">gun</span><span class="p">.</span><span class="nx">draw</span><span class="p">(</span> <span class="nx">ctx</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">deltaT_s</span><span class="p">);</span>
         <span class="p">}</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">gBS</span><span class="p">.</span><span class="nx">readyToDraw</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">gB</span><span class="p">.</span><span class="nx">drawGhostBall</span><span class="p">(</span> <span class="nx">ctx</span><span class="p">,</span> <span class="nx">client</span><span class="p">);</span>
            <span class="nx">client</span><span class="p">.</span><span class="nx">gBS</span><span class="p">.</span><span class="nx">readyToDraw</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
         <span class="p">}</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">client</span><span class="p">.</span><span class="nx">drawSelectionPoint</span><span class="p">(</span> <span class="nx">ctx</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">clientName</span><span class="p">)</span> <span class="nx">client</span><span class="p">.</span><span class="nx">selectedBody</span><span class="p">.</span><span class="nx">drawClientName</span><span class="p">(</span> <span class="nx">ctx</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">deltaT_s</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;stayOn&#39;</span><span class="o">:</span><span class="kc">true</span><span class="p">});</span>
         <span class="p">}</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">drawSyncImage</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">dF</span><span class="p">.</span><span class="nx">drawLine</span><span class="p">(</span> <span class="nx">ctx</span><span class="p">,</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">15</span><span class="p">),</span> <span class="k">new</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span><span class="mi">15</span><span class="p">),</span> <span class="p">{</span><span class="s1">&#39;width_px&#39;</span><span class="o">:</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="o">:</span><span class="s1">&#39;white&#39;</span><span class="p">}</span> <span class="p">);</span>
         <span class="p">}</span>
         <span class="k">if</span> <span class="p">((</span><span class="nx">client</span><span class="p">.</span><span class="nx">sendDrawSyncCommand</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">name</span> <span class="o">!=</span> <span class="s1">&#39;local&#39;</span><span class="p">))</span> <span class="p">{</span>
            <span class="kd">let</span> <span class="nx">control_message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;from&#39;</span><span class="o">:</span><span class="s1">&#39;host&#39;</span><span class="p">,</span> <span class="s1">&#39;to&#39;</span><span class="o">:</span><span class="nx">client</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="o">:</span><span class="p">{</span><span class="s1">&#39;drawSync&#39;</span><span class="o">:</span><span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="o">:</span><span class="nx">c</span><span class="p">.</span><span class="nx">drawSyncImage</span><span class="p">}}</span> <span class="p">};</span>
            <span class="nx">hC</span><span class="p">.</span><span class="nx">sendSocketControlMessage</span><span class="p">(</span> <span class="nx">control_message</span><span class="p">);</span>
            <span class="nx">client</span><span class="p">.</span><span class="nx">sendDrawSyncCommand</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="c1">// so start/stop messages only gets sent once</span>
         <span class="p">}</span>
      <span class="p">});</span>
      
      <span class="c1">// Draw mark for axis of angular momentum calculations.</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">cP</span><span class="p">.</span><span class="nx">EpL</span><span class="p">.</span><span class="nx">displayReport</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">dF</span><span class="p">.</span><span class="nx">drawMark</span><span class="p">(</span> <span class="nx">ctx</span><span class="p">,</span> <span class="nx">wS</span><span class="p">.</span><span class="nx">screenFromWorld</span><span class="p">(</span> <span class="nx">cP</span><span class="p">.</span><span class="nx">EpL</span><span class="p">.</span><span class="nx">angularAxis_2d_m</span><span class="p">),</span> <span class="p">{</span><span class="s1">&#39;borderColor&#39;</span><span class="o">:</span><span class="s1">&#39;cyan&#39;</span><span class="p">,</span> <span class="s1">&#39;radius_px&#39;</span><span class="o">:</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;crossHairLength_px&#39;</span><span class="o">:</span><span class="mi">15</span><span class="p">});</span>
         <span class="k">if</span> <span class="p">((</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help2&#39;</span><span class="p">].</span><span class="nx">message</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">))</span> <span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;EpLreport&#39;</span><span class="p">].</span><span class="nx">displayIt</span><span class="p">(</span> <span class="nx">c</span><span class="p">.</span><span class="nx">deltaT_s</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">);</span>
      <span class="p">}</span>
      
      <span class="c1">// Draw a marking circle on each object in the multi-select map.</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span> <span class="nx">msObject</span> <span class="p">=&gt;</span> <span class="nx">msObject</span><span class="p">.</span><span class="nx">draw_MultiSelectPoint</span><span class="p">(</span> <span class="nx">ctx</span><span class="p">)</span> <span class="p">);</span>
         <span class="c1">// Draw a center mark for the multi-select group.</span>
         <span class="k">if</span> <span class="p">((</span><span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">displayMSC</span><span class="p">))</span> <span class="nx">hostMSelect</span><span class="p">.</span><span class="nx">drawCenter</span><span class="p">(</span> <span class="nx">ctx</span><span class="p">);</span>
      <span class="p">}</span>
      
      <span class="c1">// Draw mark for SCM</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">displaySCM</span><span class="p">)</span> <span class="nx">cP</span><span class="p">.</span><span class="nx">Puck</span><span class="p">.</span><span class="nx">drawSystemCenterOfMass</span><span class="p">(</span> <span class="nx">ctx</span><span class="p">);</span>
      
      <span class="k">if</span> <span class="p">(</span> <span class="p">([</span><span class="s1">&#39;3.d&#39;</span><span class="p">,</span><span class="s1">&#39;4.e&#39;</span><span class="p">,</span><span class="s1">&#39;5.e&#39;</span><span class="p">].</span><span class="nx">includes</span><span class="p">(</span> <span class="nx">c</span><span class="p">.</span><span class="nx">demoVersion</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)))</span> <span class="o">||</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">].</span><span class="nx">includes</span><span class="p">(</span> <span class="nx">c</span><span class="p">.</span><span class="nx">demoIndex</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
         <span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">].</span><span class="nx">displayIt</span><span class="p">(</span> <span class="nx">c</span><span class="p">.</span><span class="nx">deltaT_s</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">);</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">demoVersion</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;5.e.basketball&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">bpH</span><span class="p">.</span><span class="nx">gameState</span><span class="p">.</span><span class="nx">showTimer</span><span class="p">)</span> <span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;hoopsTimer&#39;</span><span class="p">].</span><span class="nx">displayIt</span><span class="p">(</span> <span class="nx">c</span><span class="p">.</span><span class="nx">deltaT_s</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">);</span>
         
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="nx">c</span><span class="p">.</span><span class="nx">demoVersion</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;6.a&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">demoVersion</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;6.d&quot;</span><span class="p">))</span> <span class="p">{</span> 
         <span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;jelloTimer&#39;</span><span class="p">].</span><span class="nx">displayIt</span><span class="p">(</span> <span class="nx">c</span><span class="p">.</span><span class="nx">deltaT_s</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">);</span>
      <span class="p">}</span>
      
      <span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help&#39;</span><span class="p">].</span><span class="nx">displayIt</span><span class="p">(</span> <span class="nx">c</span><span class="p">.</span><span class="nx">deltaT_s</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">);</span>
      <span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;help2&#39;</span><span class="p">].</span><span class="nx">displayIt</span><span class="p">(</span> <span class="nx">c</span><span class="p">.</span><span class="nx">deltaT_s</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">);</span>
      
      <span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;gameTitle&#39;</span><span class="p">].</span><span class="nx">displayIt</span><span class="p">(</span> <span class="nx">c</span><span class="p">.</span><span class="nx">deltaT_s</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">);</span>
      <span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;win&#39;</span><span class="p">].</span><span class="nx">displayIt</span><span class="p">(</span> <span class="nx">c</span><span class="p">.</span><span class="nx">deltaT_s</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">);</span>
      
      <span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;lowHelp&#39;</span><span class="p">].</span><span class="nx">loc_px</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="mi">50</span><span class="p">;</span> <span class="c1">// adjust this near-the-bottom help as needed</span>
      <span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;lowHelp&#39;</span><span class="p">].</span><span class="nx">displayIt</span><span class="p">(</span> <span class="nx">c</span><span class="p">.</span><span class="nx">deltaT_s</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">);</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;videoTitle&#39;</span><span class="p">])</span> <span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;videoTitle&#39;</span><span class="p">].</span><span class="nx">displayIt</span><span class="p">(</span> <span class="nx">c</span><span class="p">.</span><span class="nx">deltaT_s</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">);</span> <span class="c1">// See demo #0</span>
      
      <span class="c1">// Client cursors</span>
      <span class="nx">cT</span><span class="p">.</span><span class="nx">Client</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span> <span class="nx">client</span> <span class="p">=&gt;</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;NPC&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">deviceType</span> <span class="o">!=</span> <span class="s1">&#39;mobile&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">client</span><span class="p">.</span><span class="nx">twoThumbsEnabled</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span> 
            <span class="nx">client</span><span class="p">.</span><span class="nx">drawCursor</span><span class="p">(</span> <span class="nx">ctx</span><span class="p">);</span>
         <span class="p">}</span>
      <span class="p">});</span>
      
      <span class="c1">// Display the selection box.</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">hostSelectBox</span><span class="p">.</span><span class="nx">enabled</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">hostSelectBox</span><span class="p">.</span><span class="nx">update</span><span class="p">();</span>
         <span class="nx">hostSelectBox</span><span class="p">.</span><span class="nx">draw</span><span class="p">(</span> <span class="nx">ctx</span><span class="p">);</span>
      <span class="p">}</span>
      
   <span class="p">}</span> <span class="c1">// End of updateAirTable</span>
      
             
   <span class="cm">/*   </span>
<span class="cm">   Reveal public references.</span>
<span class="cm">   </span>
<span class="cm">   You can reveal mutable objects and functions. But javascript primitives </span>
<span class="cm">   (always copied by values instead of reference) must be accessed with </span>
<span class="cm">   corresponding get and set functions. So, any variable that points to a </span>
<span class="cm">   primitive (and can be changed in this module, not a constant) must be </span>
<span class="cm">   revealed through the use of get and set functions.</span>
<span class="cm">   </span>
<span class="cm">   An alternative, to the get and set functions for the attributes of c, is to </span>
<span class="cm">   reveal the c object, which is mutable (more control with get and set).</span>
<span class="cm">   </span>
<span class="cm">   Also note that arrays are mutable objects and can be revealed here. But </span>
<span class="cm">   beware if you need to do filter operations or reset the array by assigning</span>
<span class="cm">   to a new empty array. This will leave a hanging reference to the old array</span>
<span class="cm">   in the return section. Using a functional interface to the array will avoid</span>
<span class="cm">   these problems (see jelloMadness.js and its m_jelloPucks array). Otherwise, </span>
<span class="cm">   be careful, avoid filters, and use a pop loop if you need to empty out the </span>
<span class="cm">   array. Another option is the put the array in a wrapper object and reveal </span>
<span class="cm">   that object.</span>
<span class="cm">   </span>
<span class="cm">   The canvas element, also an object, makes a good instructive example: </span>
<span class="cm">   Defining before init, </span>
<span class="cm">      var canvas = {}.</span>
<span class="cm">   After getElementById is used in init, and assigned to canvas, there will</span>
<span class="cm">   be a hanging reference (in the return below) to the original defining </span>
<span class="cm">   statement {}.</span>

<span class="cm">   One working approach is to pass canvas and ctx, after the using </span>
<span class="cm">   getElementById, into the initializeModule calls in init. There are also </span>
<span class="cm">   get and set methods (below) that can access canvas dimensions. Another </span>
<span class="cm">   option is to start with a wrapper object, then add canvas and ctx as </span>
<span class="cm">   attributes in init.</span>

<span class="cm">   A general working approach is to define external objects as empty </span>
<span class="cm">   objects (a non-primitive), wrappers, as I sometimes refer to them. </span>
<span class="cm">   Then add attributes as needed in init or before. If the initialization </span>
<span class="cm">   involves a call to another module it&#39;s best to do that in init because </span>
<span class="cm">   all modules (and their methods) will have been loaded. </span>

<span class="cm">   Notice how sounds and messages are handled this way, attributes added </span>
<span class="cm">   in init.</span>

<span class="cm">   And note that b2d is a wrapper. The engine is added as an attribute in init.</span>
<span class="cm">   </span>
<span class="cm">   Note that hostMSelect and hostSelectBox are instantiated before calling init.</span>
<span class="cm">   So this requires that multiSelect.js be loaded before this module. A better</span>
<span class="cm">   approach would be to define a single wrapper for both, expose that in the</span>
<span class="cm">   return below, and instantiate these as attributes of the wrapper. For now,</span>
<span class="cm">   it&#39;s instructive (and easier) to leave these as they are...</span>
<span class="cm">   */</span>

   <span class="k">return</span> <span class="p">{</span>
      <span class="c1">// Objects</span>
      <span class="s1">&#39;b2d&#39;</span><span class="o">:</span> <span class="nx">b2d</span><span class="p">,</span>
      
      <span class="s1">&#39;tableMap&#39;</span><span class="o">:</span> <span class="nx">tableMap</span><span class="p">,</span>
      <span class="s1">&#39;hostMSelect&#39;</span><span class="o">:</span> <span class="nx">hostMSelect</span><span class="p">,</span>
      <span class="s1">&#39;hostSelectBox&#39;</span><span class="o">:</span> <span class="nx">hostSelectBox</span><span class="p">,</span>
      <span class="s1">&#39;clients&#39;</span><span class="o">:</span> <span class="nx">clients</span><span class="p">,</span>
      <span class="s1">&#39;sounds&#39;</span><span class="o">:</span> <span class="nx">sounds</span><span class="p">,</span>
      <span class="s1">&#39;dC&#39;</span><span class="o">:</span> <span class="nx">dC</span><span class="p">,</span>
      <span class="s1">&#39;keyMap&#39;</span><span class="o">:</span> <span class="nx">keyMap</span><span class="p">,</span>
      <span class="s1">&#39;messages&#39;</span><span class="o">:</span> <span class="nx">messages</span><span class="p">,</span>
      <span class="s1">&#39;aT&#39;</span><span class="o">:</span> <span class="nx">aT</span><span class="p">,</span>
      
      <span class="c1">// Variables</span>
      <span class="s1">&#39;getG_ON&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nx">g_ON</span><span class="p">;</span> <span class="p">},</span>
      <span class="s1">&#39;setG_ON&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">val</span><span class="p">)</span> <span class="p">{</span> <span class="nx">c</span><span class="p">.</span><span class="nx">g_ON</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span> <span class="p">},</span>
      
      <span class="s1">&#39;getG_mps2&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nx">g_mps2</span><span class="p">;</span> <span class="p">},</span>
      
      <span class="s1">&#39;getPx_per_m&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nx">px_per_m</span><span class="p">;</span> <span class="p">},</span>
      
      <span class="s1">&#39;getDeltaT_s&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nx">deltaT_s</span><span class="p">;</span> <span class="p">},</span>
      
      <span class="s1">&#39;getSingleStep&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nx">singleStep</span><span class="p">;</span> <span class="p">},</span>
      
      <span class="s1">&#39;getFrameRate&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nx">frameRate</span><span class="p">;</span> <span class="p">},</span>
      
      <span class="s1">&#39;getFrameCount&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nx">frameCount</span><span class="p">;</span> <span class="p">},</span>
      
      <span class="s1">&#39;getChatLayoutState&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nx">chatLayoutState</span><span class="p">;</span> <span class="p">},</span>
      
      <span class="s1">&#39;getDemoVersion&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nx">demoVersion</span><span class="p">;</span> <span class="p">},</span>
      <span class="s1">&#39;setDemoVersion&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">val</span><span class="p">)</span> <span class="p">{</span> <span class="nx">c</span><span class="p">.</span><span class="nx">demoVersion</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span> <span class="p">},</span>
      
      <span class="s1">&#39;getDemoIndex&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nx">demoIndex</span><span class="p">;</span> <span class="p">},</span>
      
      <span class="s1">&#39;getPauseErase&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nx">pauseErase</span><span class="p">;</span> <span class="p">},</span>
      
      <span class="s1">&#39;getLagTesting&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nx">lagTesting</span><span class="p">;</span> <span class="p">},</span>
      
      <span class="s1">&#39;getSoftConstraints_default&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nx">softConstraints_default</span><span class="p">;</span> <span class="p">},</span>
      
      <span class="s1">&#39;getLastClientToScoreHit&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nx">lastClientToScoreHit</span><span class="p">;</span> <span class="p">},</span>
      <span class="s1">&#39;setLastClientToScoreHit&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">val</span><span class="p">)</span> <span class="p">{</span> <span class="nx">c</span><span class="p">.</span><span class="nx">lastClientToScoreHit</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span> <span class="p">},</span>
      
      <span class="s1">&#39;getFullScreenDemo&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nx">fullScreenDemo</span><span class="p">;</span> <span class="p">},</span>
      <span class="s1">&#39;setFullScreenDemo&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">val</span><span class="p">)</span> <span class="p">{</span> <span class="nx">c</span><span class="p">.</span><span class="nx">fullScreenDemo</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span> <span class="p">},</span>
      
      <span class="s1">&#39;getPiCalcs&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="k">return</span> <span class="p">{</span><span class="s1">&#39;enabled&#39;</span><span class="o">:</span> <span class="nx">c</span><span class="p">.</span><span class="nx">piCalcs</span><span class="p">.</span><span class="nx">enabled</span><span class="p">,</span> <span class="s1">&#39;clacks&#39;</span><span class="o">:</span><span class="nx">c</span><span class="p">.</span><span class="nx">piCalcs</span><span class="p">.</span><span class="nx">clacks</span><span class="p">,</span> <span class="s1">&#39;usePiEngine&#39;</span><span class="o">:</span><span class="nx">c</span><span class="p">.</span><span class="nx">piCalcs</span><span class="p">.</span><span class="nx">usePiEngine</span><span class="p">};</span> <span class="p">},</span>
      <span class="s1">&#39;setPiCalcs&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">enabled</span><span class="p">,</span> <span class="nx">clacks</span><span class="p">,</span> <span class="nx">usePiEngine</span><span class="p">)</span> <span class="p">{</span> <span class="nx">c</span><span class="p">.</span><span class="nx">piCalcs</span><span class="p">.</span><span class="nx">enabled</span> <span class="o">=</span> <span class="nx">enabled</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">piCalcs</span><span class="p">.</span><span class="nx">clacks</span> <span class="o">=</span> <span class="nx">clacks</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">piCalcs</span><span class="p">.</span><span class="nx">usePiEngine</span> <span class="o">=</span> <span class="nx">usePiEngine</span><span class="p">;</span> <span class="p">},</span> 
      
      <span class="s1">&#39;get_displaySCM&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nx">displaySCM</span><span class="p">;</span> <span class="p">},</span>
      <span class="s1">&#39;set_displaySCM&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">val</span><span class="p">)</span> <span class="p">{</span> <span class="nx">c</span><span class="p">.</span><span class="nx">displaySCM</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span> <span class="p">},</span>
      
      <span class="s1">&#39;get_displayMSC&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nx">displayMSC</span><span class="p">;</span> <span class="p">},</span>
      <span class="s1">&#39;set_displayMSC&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">val</span><span class="p">)</span> <span class="p">{</span> <span class="nx">c</span><span class="p">.</span><span class="nx">displayMSC</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span> <span class="p">},</span>
      
      <span class="s1">&#39;get_hostCanvasWH&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="k">return</span> <span class="p">{</span><span class="s1">&#39;width&#39;</span><span class="o">:</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="s1">&#39;height&#39;</span><span class="o">:</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span><span class="p">};},</span>
      <span class="s1">&#39;set_hostCanvasWH&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span> <span class="nx">width</span><span class="p">,</span> <span class="nx">height</span><span class="p">)</span> <span class="p">{</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">width</span><span class="p">,</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">height</span><span class="p">;},</span> 
      
      <span class="c1">// Methods</span>
      <span class="s1">&#39;toggleMultiplayerStuff&#39;</span><span class="o">:</span> <span class="nx">toggleMultiplayerStuff</span><span class="p">,</span>    
      
      <span class="s1">&#39;init&#39;</span><span class="o">:</span> <span class="nx">init</span><span class="p">,</span>
      <span class="s1">&#39;setPauseState&#39;</span><span class="o">:</span> <span class="nx">setPauseState</span><span class="p">,</span>
      <span class="s1">&#39;startit&#39;</span><span class="o">:</span> <span class="nx">startit</span><span class="p">,</span>
      <span class="s1">&#39;stopit&#39;</span><span class="o">:</span> <span class="nx">stopit</span><span class="p">,</span>
      <span class="s1">&#39;setFrameRate&#39;</span><span class="o">:</span> <span class="nx">setFrameRate</span><span class="p">,</span>
      <span class="s1">&#39;stepAnimation&#39;</span><span class="o">:</span> <span class="nx">stepAnimation</span><span class="p">,</span>
      <span class="s1">&#39;oneFrameIfPaused&#39;</span><span class="o">:</span> <span class="nx">oneFrameIfPaused</span><span class="p">,</span>
      <span class="s1">&#39;restartAnimationLoop&#39;</span><span class="o">:</span> <span class="nx">restartAnimationLoop</span><span class="p">,</span>
      
      <span class="s1">&#39;clearCanvas&#39;</span><span class="o">:</span> <span class="nx">clearCanvas</span><span class="p">,</span>
      <span class="s1">&#39;resetFenceColor&#39;</span><span class="o">:</span> <span class="nx">resetFenceColor</span><span class="p">,</span>
      <span class="s1">&#39;hackerCheck&#39;</span><span class="o">:</span> <span class="nx">hackerCheck</span><span class="p">,</span>
   <span class="p">};</span>
   
<span class="p">})();</span>
</pre></div>
</body>
</html>
