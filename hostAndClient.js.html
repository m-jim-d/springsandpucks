<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">
<!--
generated by Pygments <https://pygments.org/>
Copyright 2006-2025 by the Pygments team.
Licensed under the BSD license, see LICENSE for details.
-->
<html>
<head>
  <link rel='canonical' href='https://triquence.org/hostAndClient.js.html' />
  <title>hostAndClient.js</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <style type="text/css">
/*
generated by Pygments <https://pygments.org/>
Copyright 2006-2025 by the Pygments team.
Licensed under the BSD license, see LICENSE for details.
*/
pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
body .hll { background-color: #ffffcc }
body { background: #f8f8f8; }
body .c { color: #3D7B7B; font-style: italic } /* Comment */
body .err { border: 1px solid #F00 } /* Error */
body .k { color: #008000; font-weight: bold } /* Keyword */
body .o { color: #666 } /* Operator */
body .ch { color: #3D7B7B; font-style: italic } /* Comment.Hashbang */
body .cm { color: #3D7B7B; font-style: italic } /* Comment.Multiline */
body .cp { color: #9C6500 } /* Comment.Preproc */
body .cpf { color: #3D7B7B; font-style: italic } /* Comment.PreprocFile */
body .c1 { color: #3D7B7B; font-style: italic } /* Comment.Single */
body .cs { color: #3D7B7B; font-style: italic } /* Comment.Special */
body .gd { color: #A00000 } /* Generic.Deleted */
body .ge { font-style: italic } /* Generic.Emph */
body .ges { font-weight: bold; font-style: italic } /* Generic.EmphStrong */
body .gr { color: #E40000 } /* Generic.Error */
body .gh { color: #000080; font-weight: bold } /* Generic.Heading */
body .gi { color: #008400 } /* Generic.Inserted */
body .go { color: #717171 } /* Generic.Output */
body .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
body .gs { font-weight: bold } /* Generic.Strong */
body .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
body .gt { color: #04D } /* Generic.Traceback */
body .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
body .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
body .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
body .kp { color: #008000 } /* Keyword.Pseudo */
body .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
body .kt { color: #B00040 } /* Keyword.Type */
body .m { color: #666 } /* Literal.Number */
body .s { color: #BA2121 } /* Literal.String */
body .na { color: #687822 } /* Name.Attribute */
body .nb { color: #008000 } /* Name.Builtin */
body .nc { color: #00F; font-weight: bold } /* Name.Class */
body .no { color: #800 } /* Name.Constant */
body .nd { color: #A2F } /* Name.Decorator */
body .ni { color: #717171; font-weight: bold } /* Name.Entity */
body .ne { color: #CB3F38; font-weight: bold } /* Name.Exception */
body .nf { color: #00F } /* Name.Function */
body .nl { color: #767600 } /* Name.Label */
body .nn { color: #00F; font-weight: bold } /* Name.Namespace */
body .nt { color: #008000; font-weight: bold } /* Name.Tag */
body .nv { color: #19177C } /* Name.Variable */
body .ow { color: #A2F; font-weight: bold } /* Operator.Word */
body .w { color: #BBB } /* Text.Whitespace */
body .mb { color: #666 } /* Literal.Number.Bin */
body .mf { color: #666 } /* Literal.Number.Float */
body .mh { color: #666 } /* Literal.Number.Hex */
body .mi { color: #666 } /* Literal.Number.Integer */
body .mo { color: #666 } /* Literal.Number.Oct */
body .sa { color: #BA2121 } /* Literal.String.Affix */
body .sb { color: #BA2121 } /* Literal.String.Backtick */
body .sc { color: #BA2121 } /* Literal.String.Char */
body .dl { color: #BA2121 } /* Literal.String.Delimiter */
body .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
body .s2 { color: #BA2121 } /* Literal.String.Double */
body .se { color: #AA5D1F; font-weight: bold } /* Literal.String.Escape */
body .sh { color: #BA2121 } /* Literal.String.Heredoc */
body .si { color: #A45A77; font-weight: bold } /* Literal.String.Interpol */
body .sx { color: #008000 } /* Literal.String.Other */
body .sr { color: #A45A77 } /* Literal.String.Regex */
body .s1 { color: #BA2121 } /* Literal.String.Single */
body .ss { color: #19177C } /* Literal.String.Symbol */
body .bp { color: #008000 } /* Name.Builtin.Pseudo */
body .fm { color: #00F } /* Name.Function.Magic */
body .vc { color: #19177C } /* Name.Variable.Class */
body .vg { color: #19177C } /* Name.Variable.Global */
body .vi { color: #19177C } /* Name.Variable.Instance */
body .vm { color: #19177C } /* Name.Variable.Magic */
body .il { color: #666 } /* Literal.Number.Integer.Long */

  </style>
</head>
<body>
<h2></h2>

<div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm">Copyright 2022 James D. Miller</span>

<span class="cm">Permission is hereby granted, free of charge, to any person obtaining a copy</span>
<span class="cm">of this software and associated documentation files (the &quot;Software&quot;), to deal</span>
<span class="cm">in the Software without restriction, including without limitation the rights</span>
<span class="cm">to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
<span class="cm">copies of the Software, and to permit persons to whom the Software is</span>
<span class="cm">furnished to do so, subject to the following conditions:</span>

<span class="cm">The above copyright notice and this permission notice shall be included in all</span>
<span class="cm">copies or substantial portions of the Software.</span>

<span class="cm">THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="cm">IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="cm">FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
<span class="cm">AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<span class="cm">LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span>
<span class="cm">OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="cm">SOFTWARE.</span>
<span class="cm">*/</span>

<span class="c1">// Host and Client (hC) module</span>
<span class="c1">// hostAndClient.js</span>
<span class="w">   </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;hC _*-*_&#39;</span><span class="p">);</span>
<span class="c1">// 9:53 PM Mon January 2, 2023</span>

<span class="cm">/*</span>
<span class="cm">gwModule.js has an alphabetical list of all modules and their nicknames as added to the windows namespace.</span>
<span class="cm">*/</span>

<span class="cm">/*</span>
<span class="cm">hostAndClient.js communicates with server functionality in server.js running</span>
<span class="cm">at Heroku or on a local node server.</span>
<span class="cm">*/</span>

<span class="nb">window</span><span class="p">.</span><span class="nx">hC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="s2">&quot;use strict&quot;</span><span class="p">;</span>
<span class="w">   </span>
<span class="w">   </span><span class="c1">// Globals within hC. /////////////////////////////////////////////////</span>
<span class="w">   </span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s2">&quot;client&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">hostOrClient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;client&quot;</span><span class="p">;</span>
<span class="w">      </span><span class="c1">// cl_clientSide is a global reference to the one and only client-like object on the client.html page.</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">cl_clientSide</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="o">:</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;previous_name&#39;</span><span class="o">:</span><span class="kc">null</span><span class="p">};</span>
<span class="w">   </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// see comments in referenceToClient function</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">hostOrClient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;host&quot;</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">socket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">nodeServerURL</span><span class="p">,</span><span class="w"> </span><span class="nx">serverArray</span><span class="p">;</span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">chatStyleToggle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">timer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">   </span><span class="nx">timer</span><span class="p">.</span><span class="nx">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">   </span><span class="nx">timer</span><span class="p">.</span><span class="nx">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">   </span><span class="nx">timer</span><span class="p">.</span><span class="nx">pingArray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">clientDeviceType</span><span class="p">;</span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">clientCanvas</span><span class="p">,</span><span class="w"> </span><span class="nx">ctx</span><span class="p">;</span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">clientCanvas_tt</span><span class="p">,</span><span class="w"> </span><span class="nx">ctx_tt</span><span class="p">;</span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">videoMirror</span><span class="p">,</span><span class="w"> </span><span class="nx">videoStream</span><span class="p">;</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">demoRunningOnHost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;N/A&quot;</span><span class="p">;</span>
<span class="w">   </span>
<span class="w">   </span><span class="c1">// Document Controls (dC).</span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">dC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span><span class="w">   </span>
<span class="w">   </span><span class="nx">dC</span><span class="p">.</span><span class="nx">chkRequestStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">   </span><span class="nx">dC</span><span class="p">.</span><span class="nx">chkLocalCursor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">   </span><span class="nx">dC</span><span class="p">.</span><span class="nx">chkTwoThumbs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">   </span><span class="nx">dC</span><span class="p">.</span><span class="nx">btnTwoThumbs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">   </span><span class="nx">dC</span><span class="p">.</span><span class="nx">btnFullScreen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">   </span><span class="nx">dC</span><span class="p">.</span><span class="nx">chkPlayer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">      </span>
<span class="w">   </span><span class="c1">// Mouse and keyboard (mK) from non-host clients.</span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">mK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">   </span><span class="nx">mK</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">      </span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">clientColors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;1&#39;</span><span class="o">:</span><span class="s1">&#39;yellow&#39;</span><span class="p">,</span><span class="s1">&#39;2&#39;</span><span class="o">:</span><span class="s1">&#39;cyan&#39;</span><span class="p">,</span><span class="s1">&#39;3&#39;</span><span class="o">:</span><span class="s1">&#39;green&#39;</span><span class="p">,</span><span class="s1">&#39;4&#39;</span><span class="o">:</span><span class="s1">&#39;pink&#39;</span><span class="p">,</span><span class="s1">&#39;5&#39;</span><span class="o">:</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span>
<span class="w">                        </span><span class="s1">&#39;6&#39;</span><span class="o">:</span><span class="s1">&#39;brown&#39;</span><span class="p">,</span><span class="s1">&#39;7&#39;</span><span class="o">:</span><span class="s1">&#39;greenyellow&#39;</span><span class="p">,</span><span class="s1">&#39;8&#39;</span><span class="o">:</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span><span class="s1">&#39;9&#39;</span><span class="o">:</span><span class="s1">&#39;tan&#39;</span><span class="p">,</span><span class="s1">&#39;0&#39;</span><span class="o">:</span><span class="s1">&#39;purple&#39;</span><span class="p">};</span><span class="w">  </span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">clientLightColors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;yellow&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;greenyellow&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;pink&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;cyan&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;tan&#39;</span><span class="p">];</span>
<span class="w">   </span>
<span class="w">   </span><span class="c1">// The client name of this user. This global is only used on the client page and</span>
<span class="w">   </span><span class="c1">// is some increment of u1, u2, etc for network clients.</span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">newClientName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">rtc_choke</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">   </span>
<span class="w">   </span><span class="c1">// connection history and metrics</span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">connHist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">   </span><span class="nx">connHist</span><span class="p">.</span><span class="nx">connectListenCounts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">fileName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;hostAndClient.js&quot;</span><span class="p">;</span>
<span class="w">   </span>
<span class="w">   </span><span class="c1">// Pacifier (connecting status) string for connecting...</span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">pacifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">connMssg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">   </span>
<span class="w">   </span><span class="c1">// Switches to enable debugging...</span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">db</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">   </span><span class="nx">db</span><span class="p">.</span><span class="nx">rtc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"> </span><span class="c1">// WebRTC debug.</span>
<span class="w">   </span>
<span class="w">   </span><span class="c1">// a few misc. globals (gb) that get exposure to other modules</span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">gb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">   </span><span class="nx">gb</span><span class="p">.</span><span class="nx">gameReportCounter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">   </span><span class="nx">gb</span><span class="p">.</span><span class="nx">touchScreenUsage_sendCounter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">m_myRequest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">   </span>
<span class="w">   </span><span class="c1">// for nickname queries to the leaderboard</span>
<span class="w">   </span><span class="nx">google</span><span class="p">.</span><span class="nx">charts</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="s1">&#39;current&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;packages&#39;</span><span class="o">:</span><span class="p">[</span><span class="s1">&#39;corechart&#39;</span><span class="p">]});</span>
<span class="w">   </span><span class="nx">google</span><span class="p">.</span><span class="nx">charts</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="s1">&#39;current&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;packages&#39;</span><span class="o">:</span><span class="p">[</span><span class="s1">&#39;table&#39;</span><span class="p">]});</span>
<span class="w">   </span>
<span class="w">   </span><span class="c1">//////////////////////////////////////////////////   </span>
<span class="w">   </span><span class="c1">// object prototypes</span>
<span class="w">   </span><span class="c1">//////////////////////////////////////////////////   </span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">RTC</span><span class="p">(</span><span class="w"> </span><span class="nx">pars</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">user1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span><span class="w"> </span><span class="nx">pars</span><span class="p">.</span><span class="nx">user1</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">user2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span><span class="w"> </span><span class="nx">pars</span><span class="p">.</span><span class="nx">user2</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">streamRequested</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span><span class="w"> </span><span class="nx">pars</span><span class="p">.</span><span class="nx">streamRequested</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>
<span class="w">      </span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">pc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">dataChannel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="nx">RTC</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">shutdown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Close then nullify any references to the datachannel and the p2p connection.</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">dataChannel</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="k">this</span><span class="p">.</span><span class="nx">dataChannel</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">senders</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">pc</span><span class="p">.</span><span class="nx">getSenders</span><span class="p">();</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">senders</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="nx">pc</span><span class="p">.</span><span class="nx">removeTrack</span><span class="p">(</span><span class="w"> </span><span class="nx">senders</span><span class="p">[</span><span class="mf">0</span><span class="p">]);</span>
<span class="w">            </span><span class="nx">senders</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">pc</span><span class="p">.</span><span class="nx">getSenders</span><span class="p">();</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">         </span><span class="k">this</span><span class="p">.</span><span class="nx">pc</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">dataChannel</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="k">this</span><span class="p">.</span><span class="nx">dataChannel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="k">this</span><span class="p">.</span><span class="nx">pc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="c1">// This method works only on the host side of the WebRTC connection. So, that&#39;s why there&#39;s a check here</span>
<span class="w">   </span><span class="c1">// to see if user1 is the host.</span>
<span class="w">   </span><span class="nx">RTC</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">turnVideoStreamOff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pc</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">user1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;host&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">senders</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">pc</span><span class="p">.</span><span class="nx">getSenders</span><span class="p">();</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">senders</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="nx">pc</span><span class="p">.</span><span class="nx">removeTrack</span><span class="p">(</span><span class="w"> </span><span class="nx">senders</span><span class="p">[</span><span class="mf">0</span><span class="p">]);</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="c1">//////////////////////////////////////////////////   </span>
<span class="w">   </span><span class="c1">// functions supporting the socket.io connections</span>
<span class="w">   </span><span class="c1">//////////////////////////////////////////////////   </span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">disableClientControls</span><span class="p">(</span><span class="w"> </span><span class="nx">diableMode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// diableMode: true (disable it) or false</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">diableMode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#ConnectButton&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s1">&#39;Wait&#39;</span><span class="p">);</span>
<span class="w">         </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#ConnectButton&#39;</span><span class="p">).</span><span class="nx">prop</span><span class="p">(</span><span class="s1">&#39;disabled&#39;</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<span class="w">         </span>
<span class="w">         </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#chkRequestStream&#39;</span><span class="p">).</span><span class="nx">prop</span><span class="p">(</span><span class="s1">&#39;disabled&#39;</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<span class="w">         </span>
<span class="w">         </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#twoThumbsButton&#39;</span><span class="p">).</span><span class="nx">prop</span><span class="p">(</span><span class="s1">&#39;disabled&#39;</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<span class="w">         </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#ChatButton&#39;</span><span class="p">).</span><span class="nx">prop</span><span class="p">(</span><span class="s1">&#39;disabled&#39;</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<span class="w">         </span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="c1">// Change the label from &#39;Wait&#39; to &#39;Connect&#39;.</span>
<span class="w">         </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#ConnectButton&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s1">&#39;Connect&#39;</span><span class="p">);</span>
<span class="w">         </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#ConnectButton&#39;</span><span class="p">).</span><span class="nx">prop</span><span class="p">(</span><span class="s1">&#39;disabled&#39;</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span>
<span class="w">         </span><span class="c1">// Note: the streaming checkbox opens when the p2p data-channel opens (see cl.rtc.dataChannel.onopen).</span>
<span class="w">         </span><span class="c1">//       the two-thumbs button opens when the room is successfully joined.</span>
<span class="w">         </span><span class="c1">//       the chat button opens when the room is successfully joined.</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">clearInputDefault</span><span class="p">(</span><span class="w"> </span><span class="nx">a</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">defaultValue</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">a</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">a</span><span class="p">.</span><span class="nx">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">restoreInputDefault</span><span class="p">(</span><span class="w"> </span><span class="nx">a</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">a</span><span class="p">.</span><span class="nx">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">a</span><span class="p">.</span><span class="nx">defaultValue</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="c1">// The following group of functions work with checkForNickName to query the leaderboard for similar names.</span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">processResponse</span><span class="p">(</span><span class="w"> </span><span class="nx">response</span><span class="p">,</span><span class="w"> </span><span class="nx">nameType</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">cl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">referenceToClient</span><span class="p">();</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">dataTable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">getDataTable</span><span class="p">();</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">nRows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">dataTable</span><span class="p">.</span><span class="nx">getNumberOfRows</span><span class="p">();</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">nRows</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="kd">let</span><span class="w"> </span><span class="nx">inUseName</span><span class="p">,</span><span class="w"> </span><span class="nx">displayString</span><span class="p">,</span><span class="w"> </span><span class="nx">similarList_string</span><span class="p">,</span><span class="w"> </span><span class="nx">similarList_array</span><span class="p">;</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// List of unique similar names with exact match in bold.</span>
<span class="w">         </span><span class="nx">similarList_array</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">         </span><span class="nx">similarList_string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">;</span><span class="w"> </span><span class="c1">//(</span>
<span class="w">         </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">dataTable</span><span class="p">.</span><span class="nx">getNumberOfRows</span><span class="p">();</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="nx">similarName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">dataTable</span><span class="p">.</span><span class="nx">getValue</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span><span class="mf">0</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mf">0</span><span class="p">];</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">similarList_array</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="w"> </span><span class="nx">similarName</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">similarList_array</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="w"> </span><span class="nx">similarName</span><span class="p">);</span>
<span class="w">               </span><span class="kd">let</span><span class="w"> </span><span class="nx">candidateName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">nameType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;nick&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">cl</span><span class="p">.</span><span class="nx">nickName</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">cl</span><span class="p">.</span><span class="nx">teamName</span><span class="p">;</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">candidateName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">similarName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="nx">similarList_string</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s2">&quot;&lt;strong&gt;&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">similarName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;&lt;/strong&gt;, &quot;</span><span class="p">;</span>
<span class="w">               </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="nx">similarList_string</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">similarName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;, &quot;</span><span class="p">;</span>
<span class="w">               </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">         </span><span class="nx">similarList_string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">similarList_string</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="o">-</span><span class="mf">2</span><span class="p">);</span>
<span class="w">         </span><span class="nx">similarList_string</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">;</span><span class="w"> </span><span class="c1">//)</span>
<span class="w">         </span>
<span class="w">         </span><span class="kd">let</span><span class="w"> </span><span class="nx">tab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&amp;nbsp;&amp;nbsp;&amp;nbsp;&quot;</span><span class="p">;</span>
<span class="w">         </span><span class="kd">let</span><span class="w"> </span><span class="nx">nameTypeString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">nameType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;nick&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s2">&quot;nicknames&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;team names&quot;</span><span class="p">;</span>
<span class="w">         </span><span class="kd">let</span><span class="w"> </span><span class="nx">similarString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">uT</span><span class="p">.</span><span class="nx">allOfThese</span><span class="p">([</span><span class="s1">&#39;007&#39;</span><span class="p">,</span><span class="s1">&#39;whitefang&#39;</span><span class="p">],</span><span class="w"> </span><span class="nx">similarList_string</span><span class="p">))</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s2">&quot;all&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;similar&quot;</span><span class="p">;</span>
<span class="w">         </span><span class="nx">displayString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;On the leaderboard&lt;br&gt;&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">tab</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">similarString</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot; &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">nameTypeString</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;:&amp;nbsp;&amp;nbsp;&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">similarList_string</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">;</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">//console.log(&quot;name report (lb) = &quot; + similarList_string);</span>
<span class="w">         </span><span class="nx">displayMessage</span><span class="p">(</span><span class="w"> </span><span class="nx">displayString</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;color&#39;</span><span class="o">:</span><span class="s1">&#39;yellow&#39;</span><span class="p">});</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">handleNickNameQueryResponse</span><span class="p">(</span><span class="w"> </span><span class="nx">response</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">processResponse</span><span class="p">(</span><span class="w"> </span><span class="nx">response</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;nick&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">handleTeamNameQueryResponse</span><span class="p">(</span><span class="w"> </span><span class="nx">response</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">processResponse</span><span class="p">(</span><span class="w"> </span><span class="nx">response</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;team&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">similarName</span><span class="p">(</span><span class="w"> </span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">handleQueryResponse</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">nameWithoutNumbersAtEnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">name</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\d+$/</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">);</span>
<span class="w">      </span><span class="c1">// If user entered a pure numeric name, query for similar names using the first digit.</span>
<span class="w">      </span><span class="c1">// A special case, the prime numbers series, will produce a pure wild card query, returning all the nicknames on the leaderboard.</span>
<span class="w">      </span><span class="c1">// A single letter followed by a number will pass the filter for two characters, then lose its number, </span>
<span class="w">      </span><span class="c1">// yielding a single-letter-with-a-wild-card query (e.g. a5 will return a list of all the nicknames starting with the letter &quot;a&quot;)</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">nameWithoutNumbersAtEnd</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">name</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s2">&quot;235711&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">            </span><span class="nx">nameWithoutNumbersAtEnd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">name</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">1</span><span class="p">);</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">sqlString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;select A where (A like &#39;&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">nameWithoutNumbersAtEnd</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;%&#39;) order by A&quot;</span><span class="p">;</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">sheetURL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;https://docs.google.com/spreadsheets/d/1TLMLXsfnmsUU24aQxq0CqcfXvAtW0uAKrOwXL2kc2OE/edit?usp=sharing&amp;sheet=games&amp;headers=1&quot;</span><span class="p">;</span><span class="w"> </span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">query</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">google</span><span class="p">.</span><span class="nx">visualization</span><span class="p">.</span><span class="nx">Query</span><span class="p">(</span><span class="w"> </span><span class="nx">sheetURL</span><span class="p">);</span>
<span class="w">      </span><span class="nx">query</span><span class="p">.</span><span class="nx">setQuery</span><span class="p">(</span><span class="w"> </span><span class="nx">sqlString</span><span class="p">);</span>
<span class="w">      </span><span class="nx">query</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="w"> </span><span class="nx">handleQueryResponse</span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span><span class="w">   </span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">checkForNickName</span><span class="p">(</span><span class="w"> </span><span class="nx">mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">cl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">referenceToClient</span><span class="p">();</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">nickName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;status&#39;</span><span class="o">:</span><span class="s1">&#39;ok&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;value&#39;</span><span class="o">:</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;teamName&#39;</span><span class="o">:</span><span class="kc">null</span><span class="p">};</span>

<span class="w">      </span><span class="c1">// Check the chat input field, e.g. jimbo</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">chatString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#inputField&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Ignore anything that looks like JSON: {}</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">chatString</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s2">&quot;{&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">nickName</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;JSON&quot;</span><span class="p">;</span>
<span class="w">         </span><span class="k">return</span><span class="w"> </span><span class="nx">nickName</span><span class="p">;</span>
<span class="w">      </span><span class="c1">// Ignore commands in the chat.</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">chatString</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s2">&quot;::&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="k">return</span><span class="w"> </span><span class="nx">nickName</span><span class="p">;</span>
<span class="w">      </span><span class="c1">// Go back to being anonymous.</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">chatString</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;noname&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">cl</span><span class="p">.</span><span class="nx">nickName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">         </span><span class="nx">cl</span><span class="p">.</span><span class="nx">teamName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">         </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#inputField&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">         </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;input.nickNameField&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">         </span><span class="k">return</span><span class="w"> </span><span class="nx">nickName</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="c1">// nickname input field in the ghost-ball pool help panel (all the nick-name fields should be in sync, so just snag from any of these fields)</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">nnFieldValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#nn_pool&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span><span class="w"> </span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">defaultValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#inputField&#39;</span><span class="p">).</span><span class="nx">prop</span><span class="p">(</span><span class="s1">&#39;defaultValue&#39;</span><span class="p">);</span><span class="w"> </span><span class="c1">//this is the value attribute in the html</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">mode</span><span class="w"> </span><span class="o">==</span><span class="s1">&#39;normal&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="c1">// Generally, the chat field will be empty (or a command with :: in it and ignored above). If not, it&#39;s a nickname.</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">chatString</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">chatString</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">defaultValue</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="nx">chatString_clean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">chatString</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[^a-zA-Z0-9@]/g</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">);</span><span class="w"> </span><span class="c1">// allow alphanumeric and the @ character</span>
<span class="w">            </span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">chatString_clean</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="kd">let</span><span class="w"> </span><span class="nx">nickNameParts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">chatString_clean</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">);</span>
<span class="w">               </span><span class="nx">nickName</span><span class="p">.</span><span class="nx">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">nickNameParts</span><span class="p">[</span><span class="mf">0</span><span class="p">];</span>
<span class="w">               </span><span class="nx">nickName</span><span class="p">.</span><span class="nx">teamName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">nickNameParts</span><span class="p">[</span><span class="mf">1</span><span class="p">];</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">nickName</span><span class="p">.</span><span class="nx">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">chatString_clean</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">nickName</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">10</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">nickName</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;too long&quot;</span><span class="p">;</span>
<span class="w">               </span><span class="k">return</span><span class="w"> </span><span class="nx">nickName</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">nickName</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">nickName</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;too short&quot;</span><span class="p">;</span>
<span class="w">               </span><span class="k">return</span><span class="w"> </span><span class="nx">nickName</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">cl</span><span class="p">.</span><span class="nx">nickName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">nickName</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
<span class="w">               </span><span class="nx">cl</span><span class="p">.</span><span class="nx">teamName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">nickName</span><span class="p">.</span><span class="nx">teamName</span><span class="p">;</span>
<span class="w">               </span>
<span class="w">               </span><span class="c1">// Clear out the input field where the nick name was entered.</span>
<span class="w">               </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#inputField&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">               </span>
<span class="w">               </span><span class="c1">// Set all the inputs in the nickNameField class (these are only on the host) to the nickname.</span>
<span class="w">               </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;input.nickNameField&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="w"> </span><span class="nx">nickName</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
<span class="w">               </span>
<span class="w">               </span><span class="c1">// Wait for sockets to settle and also so that corresponding chat message is the most recent.</span>
<span class="w">               </span><span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="c1">// Check the leaderboard for similar names.</span>
<span class="w">                  </span><span class="nx">similarName</span><span class="p">(</span><span class="w"> </span><span class="nx">nickName</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span><span class="w"> </span><span class="nx">handleNickNameQueryResponse</span><span class="p">);</span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">nickName</span><span class="p">.</span><span class="nx">teamName</span><span class="p">)</span><span class="w"> </span><span class="nx">similarName</span><span class="p">(</span><span class="w"> </span><span class="nx">nickName</span><span class="p">.</span><span class="nx">teamName</span><span class="p">,</span><span class="w"> </span><span class="nx">handleTeamNameQueryResponse</span><span class="p">);</span>
<span class="w">                  </span>
<span class="w">                  </span><span class="c1">// Check the node server for similar names.</span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">socket</span><span class="p">)</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;name report&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;nickName&#39;</span><span class="o">:</span><span class="nx">nickName</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;teamName&#39;</span><span class="o">:</span><span class="nx">nickName</span><span class="p">.</span><span class="nx">teamName</span><span class="p">});</span>
<span class="w">               </span><span class="p">},</span><span class="w"> </span><span class="mf">2500</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// Nothing new in the chat, so use the current nick name if it&#39;s there.</span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hostOrClient</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;client&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">nickName</span><span class="p">.</span><span class="nx">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cl</span><span class="p">.</span><span class="nx">nickName</span><span class="p">;</span>
<span class="w">               </span><span class="nx">nickName</span><span class="p">.</span><span class="nx">teamName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cl</span><span class="p">.</span><span class="nx">teamName</span><span class="p">;</span>
<span class="w">               </span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hostOrClient</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;host&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="kd">let</span><span class="w"> </span><span class="nx">nickNameParts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">nnFieldValue</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">);</span>
<span class="w">               </span><span class="c1">// Note that teamName is not changed here. Only allowed to change the teamName via the chat field.</span>
<span class="w">               </span><span class="nx">nickName</span><span class="p">.</span><span class="nx">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">nickNameParts</span><span class="p">[</span><span class="mf">0</span><span class="p">];</span>
<span class="w">               </span><span class="nx">cl</span><span class="p">.</span><span class="nx">nickName</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nx">nickName</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
<span class="w">               </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;input.nickNameField&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="w"> </span><span class="nx">nickName</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;re-connect&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">cl</span><span class="p">.</span><span class="nx">nickName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">nickName</span><span class="p">.</span><span class="nx">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cl</span><span class="p">.</span><span class="nx">nickName</span><span class="p">;</span>
<span class="w">         </span><span class="nx">nickName</span><span class="p">.</span><span class="nx">teamName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cl</span><span class="p">.</span><span class="nx">teamName</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">nickName</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="cm">/*</span>
<span class="cm">   Overview of the conversation between client, server, and host, for establishing the P2P connection:</span>
<span class="cm">   </span>
<span class="cm">   Host: </span>
<span class="cm">      starting with the &quot;Create&quot; button, runs &quot;connect_and_listen&quot; to establish socket.io connection with server. </span>
<span class="cm">      io.connect and init_socket_listeners are run</span>
<span class="cm">   Server: </span>
<span class="cm">      on connection, listeners are initialized on the server for that connection</span>
<span class="cm">      server automatically sends to &quot;connect&quot; listener on host</span>
<span class="cm">   Host: </span>
<span class="cm">      from &quot;connect&quot; listener, host sends to &quot;roomJoin&quot; listener on server with room name as indicated on the host&#39;s page</span>
<span class="cm">   Server: </span>
<span class="cm">      from &quot;roomJoin&quot; listener, server sets up the room, adds the host to the room as host, </span>
<span class="cm">      and sends to &quot;room-joining-message&quot; listener on host: (1) you joined room, (2) you are host</span>
<span class="cm">   Client (and Server): </span>
<span class="cm">      Starting with the &quot;Connect&quot; button, the client makes a similar (like the host&#39;s above) exchange with the server to establish </span>
<span class="cm">      the socket.io connection and join the room as a member (not as host).</span>
<span class="cm">      The server sends to the &quot;your name is&quot; listener on the client where the rtc object is instantiated and openDataChannel is run.</span>
<span class="cm">      openDataChannel( false, clientName); // client run this as NOT the initiator </span>
<span class="cm">         the guts of the WebRTC is instantiated ----&gt; new RTCPeerConnection</span>
<span class="cm">         onicecandidate event handler established which uses the &quot;signaling message&quot; listeners</span>
<span class="cm">         ondatachannel handler is defined (responds to data channel initiation by the host)</span>
<span class="cm">   Server: </span>
<span class="cm">      At the end of the client connection process an additional step is done in the server&#39;s &quot;roomJoin&quot; listener. </span>
<span class="cm">      The server sends the new client name to the &quot;new-game-client&quot; listener on the host. </span>
<span class="cm">   Host: </span>
<span class="cm">      &quot;new-game-client&quot; listener instantiates a new Client object where the host-side of each P2P connection, for each client, exists:</span>
<span class="cm">         createNetworkClient(...)</span>
<span class="cm">      Then these two calls start the P2P connection process:</span>
<span class="cm">         openDataChannel( true, clientName); // host opens as the initiator</span>
<span class="cm">            the guts of the WebRTC is instantiated ----&gt; new RTCPeerConnection</span>
<span class="cm">            onicecandidate event handler established</span>
<span class="cm">               handler will send ICE info to the server&#39;s &quot;signaling message&quot; listener, then relayed to the client&#39;s listener.</span>
<span class="cm">            createDataChannel: starts the datachannel on the host; client responds with its ondatachannel handler</span>
<span class="cm">         createOffer</span>
<span class="cm">            an offer is forwarded to the client using the &quot;signaling message&quot; listeners</span>
<span class="cm">   Client:</span>
<span class="cm">      &quot;signaling message&quot; listener</span>
<span class="cm">         handleOffer</span>
<span class="cm">            cl.rtc.pc.setRemoteDescription</span>
<span class="cm">            cl.rtc.pc.createAnswer</span>
<span class="cm">            cl.rtc.pc.setLocalDescription( answer);</span>
<span class="cm">            an answer is sent to the Host via &quot;signaling message&quot; listeners</span>
<span class="cm">   Host:</span>
<span class="cm">      &quot;signaling message&quot; listener</span>
<span class="cm">         handleAnswer</span>
<span class="cm">            cl.rtc.pc.setRemoteDescription( answer)</span>
<span class="cm">   */</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">connect_and_listen</span><span class="p">(</span><span class="w"> </span><span class="nx">mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hostOrClient</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;client&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">startAnimation</span><span class="p">();</span><span class="w"> </span><span class="c1">// on ctx</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// The host always connects in normal mode.</span>
<span class="w">      </span><span class="c1">// Re-connection happens only when the client is starting a stream or when the P2P connection makes a second attempt.</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;normal&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="c1">// Reset the counter when the connection is initiated from the button.</span>
<span class="w">         </span><span class="nx">connHist</span><span class="p">.</span><span class="nx">connectListenCounts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">         </span><span class="nx">gb</span><span class="p">.</span><span class="nx">touchScreenUsage_sendCounter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;re-connect&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="c1">// Add to the count so the number of retries can be limited.</span>
<span class="w">         </span><span class="nx">connHist</span><span class="p">.</span><span class="nx">connectListenCounts</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;re-connect-with-stream&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="c1">// Don&#39;t count the first re-connect associated with the video stream.</span>
<span class="w">         </span><span class="nx">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;re-connect&#39;</span><span class="p">;</span>
<span class="w">         </span><span class="nx">connHist</span><span class="p">.</span><span class="nx">connectListenCounts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Run some checks on the room name.</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">roomName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#roomName&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
<span class="w">      </span><span class="c1">// Gotta have something...</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">roomName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">buttonName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">hostOrClient</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;client&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;&quot;Connect&quot;&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;&quot;Create&quot;&#39;</span><span class="p">;</span>
<span class="w">         </span><span class="nx">displayMessage</span><span class="p">(</span><span class="s1">&#39;Type in a short &quot;Room&quot; name, then click the &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">buttonName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39; button.&#39;</span><span class="p">);</span>
<span class="w">         </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;roomName&quot;</span><span class="p">).</span><span class="nx">style</span><span class="p">.</span><span class="nx">borderColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;red&quot;</span><span class="p">;</span>
<span class="w">         </span><span class="k">return</span><span class="p">;</span>
<span class="w">      </span><span class="c1">// the HTML limit is set to 9 (so you can try a little more then 7, but then get some advice to limit it to 7)</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">roomName</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">7</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">displayMessage</span><span class="p">(</span><span class="s1">&#39;The name should have 7 characters or less.&#39;</span><span class="p">);</span>
<span class="w">         </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;roomName&quot;</span><span class="p">).</span><span class="nx">style</span><span class="p">.</span><span class="nx">borderColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;red&quot;</span><span class="p">;</span>
<span class="w">         </span><span class="k">return</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Clear the default string (nickname tip) in the chat field.</span>
<span class="w">      </span><span class="nx">clearInputDefault</span><span class="p">(</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;inputField&#39;</span><span class="p">));</span>
<span class="w">            </span>
<span class="w">      </span><span class="c1">// Check to see if there&#39;s a nickname in the chat input field.</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">nickName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">checkForNickName</span><span class="p">(</span><span class="w"> </span><span class="nx">mode</span><span class="p">);</span>
<span class="w">      </span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">nickName</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;too long&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">displayMessage</span><span class="p">(</span><span class="s1">&#39;Nicknames must have 10 characters or less. Shorten the name and then try connecting again.&#39;</span><span class="p">);</span>
<span class="w">         </span><span class="k">return</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">nickName</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;too short&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">displayMessage</span><span class="p">(</span><span class="s1">&#39;Nicknames must have at least 2 characters. Lengthen the name and then try connecting again.&#39;</span><span class="p">);</span>
<span class="w">         </span><span class="k">return</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">            </span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hostOrClient</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;client&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="c1">// Disable some of the client controls to keep users from repeatedly</span>
<span class="w">         </span><span class="c1">// clicking the connect button.</span>
<span class="w">         </span><span class="nx">disableClientControls</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">         </span><span class="nx">refresh_P2P_indicator</span><span class="p">({</span><span class="s1">&#39;mode&#39;</span><span class="o">:</span><span class="s1">&#39;connecting&#39;</span><span class="p">});</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// Open the connect button after 4 seconds. Sometimes there are network delays.</span>
<span class="w">         </span><span class="c1">// Note: most of the disabled controls open based on events. For example: the </span>
<span class="w">         </span><span class="c1">// streaming checkbox opens when the p2p data-channel opens (see cl.rtc.dataChannel.onopen).</span>
<span class="w">         </span><span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">disableClientControls</span><span class="p">(</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span>
<span class="w">         </span><span class="p">},</span><span class="w"> </span><span class="mf">4000</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hostOrClient</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;host&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">displayMessage</span><span class="p">(</span><span class="s1">&#39;Connecting as host. Please wait up to 20 seconds...&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">nodeString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#nodeServer&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">nodeString</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="c1">// Use one in the list as a default.</span>
<span class="w">         </span><span class="nx">nodeString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">serverArray</span><span class="p">[</span><span class="mf">0</span><span class="p">];</span><span class="w">  </span><span class="c1">// [0] or [2]</span>
<span class="w">         </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#nodeServer&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="w"> </span><span class="nx">nodeString</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;nodeString = &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">nodeString</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">nodeString</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s2">&quot;triquence&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">nodeString</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s2">&quot;herokuapp&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">nodeString</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s2">&quot;3443&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">urlPrefix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;https://&quot;</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">urlPrefix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;http://&quot;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="nx">nodeServerURL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">urlPrefix</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">nodeString</span><span class="p">;</span>
<span class="w">            </span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;URL = &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">nodeServerURL</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;/socket.io/socket.io.js&quot;</span><span class="p">);</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Use jquery to load the socket.io client code.  </span>
<span class="w">      </span><span class="nx">$</span><span class="p">.</span><span class="nx">getScript</span><span class="p">(</span><span class="w"> </span><span class="nx">nodeServerURL</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;/socket.io/socket.io.js&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="c1">// This callback function will run after the getScript finishes loading the socket.io client.</span>
<span class="w">         </span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">cl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">referenceToClient</span><span class="p">();</span>
<span class="w">         </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;socket.io script has loaded.&quot;</span><span class="p">);</span><span class="w"> </span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// If there are already active network connections, close them before making new ones. This is </span>
<span class="w">         </span><span class="c1">// the case if the client repeatedly clicks the connect button trying to get a preferred color.</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">socket</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hostOrClient</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;client&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="c1">// Send a message to the host (via socket.io server) to shutdown RTC connections.</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">newClientName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">videoMirror</span><span class="p">.</span><span class="nx">srcObject</span><span class="p">)</span><span class="w"> </span><span class="nx">videoMirror</span><span class="p">.</span><span class="nx">srcObject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">                  </span><span class="c1">// Trigger client shutdown at the host.</span>
<span class="w">                  </span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;shutDown-p2p-deleteClient&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">newClientName</span><span class="p">);</span>
<span class="w">               </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="c1">// Close socket.io connection after waiting a bit for the p2p connections to close.</span>
<span class="w">               </span><span class="nx">socket</span><span class="p">.</span><span class="nx">disconnect</span><span class="p">();</span>
<span class="w">            </span><span class="p">},</span><span class="w"> </span><span class="mf">500</span><span class="p">);</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// Delay this (connection to the server) longer than the delay for socket.disconnect() above (to be sure the disconnect has finished).</span>
<span class="w">         </span><span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// When starting a new normal connection, turn off the stream.</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;normal&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">hostOrClient</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;client&#39;</span><span class="p">))</span><span class="w"> </span><span class="nx">dC</span><span class="p">.</span><span class="nx">chkRequestStream</span><span class="p">.</span><span class="nx">checked</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">// Here is where the socket.io client initiates it&#39;s connection to the server. The &#39;connectOptions&#39; object</span>
<span class="w">            </span><span class="c1">// is passed via the auth attribute of the options. This is how you pass extra parameters to the connection </span>
<span class="w">            </span><span class="c1">// handler in server.js. </span>
<span class="w">            </span><span class="c1">// This is where the results from checkForNickName (see above) are passed to the server, which, eventually, </span>
<span class="w">            </span><span class="c1">// emits to the new-game-client listener on the host.</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="nx">connectOptions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;mode&#39;</span><span class="o">:</span><span class="nx">mode</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;currentName&#39;</span><span class="o">:</span><span class="nx">cl</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;nickName&#39;</span><span class="o">:</span><span class="nx">nickName</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;teamName&#39;</span><span class="o">:</span><span class="nx">nickName</span><span class="p">.</span><span class="nx">teamName</span><span class="p">};</span>
<span class="w">            </span><span class="nx">socket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">io</span><span class="p">(</span><span class="w"> </span><span class="nx">nodeServerURL</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;forceNew&#39;</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;auth&#39;</span><span class="o">:</span><span class="nx">connectOptions</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;withCredentials&#39;</span><span class="o">:</span><span class="kc">false</span><span class="p">});</span>
<span class="w">            </span>
<span class="w">            </span><span class="nx">init_socket_listeners</span><span class="p">(</span><span class="w"> </span><span class="nx">roomName</span><span class="p">);</span>
<span class="w">            </span>
<span class="w">         </span><span class="p">},</span><span class="w"> </span><span class="mf">600</span><span class="p">);</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// Check for P2P on the client and try again (reconnect) if needed.</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">hostOrClient</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;client&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">connHist</span><span class="p">.</span><span class="nx">connectListenCounts</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">1</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s2">&quot;Firefox&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="kd">var</span><span class="w"> </span><span class="nx">waitBeforeCheck</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">5500</span><span class="p">;</span><span class="w"> </span><span class="c1">// Mozilla</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="kd">var</span><span class="w"> </span><span class="nx">waitBeforeCheck</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3500</span><span class="p">;</span><span class="w"> </span><span class="c1">// Chrome</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;checking for p2p connection&#39;</span><span class="p">);</span>
<span class="w">               </span><span class="kd">var</span><span class="w"> </span><span class="nx">p2pConnection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">rtc_choke</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">cl</span><span class="p">.</span><span class="nx">rtc</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">cl</span><span class="p">.</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">dataChannel</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">cl</span><span class="p">.</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">dataChannel</span><span class="p">.</span><span class="nx">readyState</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;open&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">p2pConnection</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="nx">connect_and_listen</span><span class="p">(</span><span class="s1">&#39;re-connect&#39;</span><span class="p">);</span><span class="w"> </span><span class="c1">// Yes, connect_and_listen is this function.</span>
<span class="w">               </span><span class="p">}</span>
<span class="w">            </span><span class="p">},</span><span class="w"> </span><span class="nx">waitBeforeCheck</span><span class="p">);</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">         </span>
<span class="w">      </span><span class="c1">// Use the &quot;fail&quot; method of getScript to report a connection problem.  </span>
<span class="w">      </span><span class="p">}).</span><span class="nx">fail</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">jqxhr</span><span class="p">,</span><span class="w"> </span><span class="nx">settings</span><span class="p">,</span><span class="w"> </span><span class="nx">exception</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">displayMessage</span><span class="p">(</span><span class="s1">&#39;The node server is not responding. Try changing to a different server.&#39;</span><span class="p">);</span>
<span class="w">         </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;roomName&quot;</span><span class="p">).</span><span class="nx">style</span><span class="p">.</span><span class="nx">borderColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;red&quot;</span><span class="p">;</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hostOrClient</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;client&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">refresh_P2P_indicator</span><span class="p">({</span><span class="s1">&#39;mode&#39;</span><span class="o">:</span><span class="s1">&#39;reset&#39;</span><span class="p">});</span>
<span class="w">      </span><span class="p">});</span><span class="w">  </span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">displayMessage</span><span class="p">(</span><span class="w"> </span><span class="nx">msgText</span><span class="p">,</span><span class="w"> </span><span class="nx">pars</span><span class="o">=</span><span class="p">{})</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span><span class="w"> </span><span class="nx">pars</span><span class="p">.</span><span class="nx">color</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;gray&quot;</span><span class="p">);</span>
<span class="w">      </span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">msgText</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s2">&quot;Game Summary&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">msgText</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s2">&quot;do not display&quot;</span><span class="p">))</span><span class="w"> </span><span class="nx">msgText</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Please wait for query results...&lt;br&gt;&quot;</span><span class="p">;</span>
<span class="w">         </span><span class="nx">gb</span><span class="p">.</span><span class="nx">gameReportCounter</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">idString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot; id=&#39;gR&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">gb</span><span class="p">.</span><span class="nx">gameReportCounter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;&#39;&quot;</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">idString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">colorA</span><span class="p">,</span><span class="w"> </span><span class="nx">colorB</span><span class="p">;</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">color</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;yellow&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">colorA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;#E8ED99&quot;</span><span class="p">;</span><span class="w"> </span><span class="c1">// shade of yellow</span>
<span class="w">         </span><span class="nx">colorB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;#E8ED99&quot;</span><span class="p">;</span><span class="w"> </span><span class="c1">// same </span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">color</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;green&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">colorA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;#9FE2BF&quot;</span><span class="p">;</span><span class="w"> </span><span class="c1">// seafoam green</span>
<span class="w">         </span><span class="nx">colorB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;#9FE2BF&quot;</span><span class="p">;</span><span class="w"> </span><span class="c1">// same</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">color</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;gray&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">colorA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;#efefef&quot;</span><span class="p">;</span><span class="w"> </span><span class="c1">// gray</span>
<span class="w">         </span><span class="nx">colorB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;#d9d9d9&quot;</span><span class="p">;</span><span class="w"> </span><span class="c1">// darker gray</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Every other line, toggle the background shading.</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">chatStyleToggle</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">styleString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;style=&#39;background: &quot;</span><span class="o">+</span><span class="nx">colorA</span><span class="o">+</span><span class="s2">&quot;;&#39;&quot;</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">styleString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;style=&#39;background: &quot;</span><span class="o">+</span><span class="nx">colorB</span><span class="o">+</span><span class="s2">&quot;;&#39;&quot;</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#messages&quot;</span><span class="p">).</span><span class="nx">prepend</span><span class="p">(</span><span class="s2">&quot;&lt;li &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">styleString</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">idString</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;&gt;&quot;</span><span class="o">+</span><span class="w"> </span><span class="nx">msgText</span><span class="w"> </span><span class="o">+</span><span class="s2">&quot;&lt;/li&gt;&quot;</span><span class="p">);</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Remove any help links on the client (because only the host has the help div).</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">clientDeviceType</span><span class="p">)</span><span class="w"> </span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;.helpLinkFromLB&quot;</span><span class="p">).</span><span class="nx">remove</span><span class="p">();</span>
<span class="w">      </span>
<span class="w">      </span><span class="nx">chatStyleToggle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="nx">chatStyleToggle</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="c1">// Used for broadcasting a message to non-host players.</span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">chatToNonHostPlayers</span><span class="p">(</span><span class="w"> </span><span class="nx">msgTxt</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">socket</span><span class="p">)</span><span class="w"> </span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;chat message but not me&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">msgTxt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;&lt;/br&gt;&#39;</span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">init_chatFeatures</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">serverArray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;connect.triquence.org&#39;</span><span class="p">,</span>
<span class="w">                         </span><span class="s1">&#39;triquence-ca88d70f0e55.herokuapp.com&#39;</span><span class="p">,</span>
<span class="w">                         </span><span class="s1">&#39;timetocode-test.herokuapp.com&#39;</span><span class="p">,</span>
<span class="w">                         </span><span class="s1">&#39;localhost:3000&#39;</span><span class="p">,</span>
<span class="w">                         </span><span class="s1">&#39;localhost:3443&#39;</span><span class="p">,</span>
<span class="w">                         </span><span class="s1">&#39;192.168.1.104:3000&#39;</span><span class="p">,</span><span class="w">  </span><span class="c1">//BeeLink</span>
<span class="w">                         </span><span class="s1">&#39;192.168.1.104:3443&#39;</span><span class="p">,</span><span class="w">  </span><span class="c1">//BeeLink</span>
<span class="w">                         </span><span class="s1">&#39;192.168.1.106:3000&#39;</span><span class="p">,</span><span class="w">  </span><span class="c1">//NUC</span>
<span class="w">                         </span><span class="s1">&#39;192.168.1.109:3000&#39;</span><span class="p">,</span><span class="w">  </span><span class="c1">//David&#39;s computer</span>
<span class="w">                         </span><span class="s1">&#39;192.168.1.116:3000&#39;</span><span class="p">,</span><span class="w">  </span><span class="c1">//RPi</span>
<span class="w">                         </span><span class="s1">&#39;192.168.1.117:3000&#39;</span><span class="p">];</span><span class="w"> </span><span class="c1">//Laptop                 </span>
<span class="w">      </span><span class="c1">// Use jquery to loop over the serverArray and build the URL datalist.</span>
<span class="w">      </span><span class="nx">jQuery</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="w"> </span><span class="nx">serverArray</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">i</span><span class="p">,</span><span class="w"> </span><span class="nx">val</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#nodeServerList&#39;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;&lt;option value=&#39;&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">val</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;&#39;&gt;&quot;</span><span class="p">);</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">      </span><span class="c1">//$(&quot;#nodeServer&quot;).attr(&quot;value&quot;, &quot;192.168.1.106:3000&quot;);</span>
<span class="w">      </span><span class="c1">//$(&quot;#nodeServer&quot;).attr(&quot;value&quot;, &quot;localhost:3000&quot;);</span>
<span class="w">   </span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">pingTestHelp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Your ping test has started.&lt;br&gt;&lt;br&gt;&quot;</span><span class="w"> </span><span class="o">+</span>
<span class="w">                         </span><span class="s2">&quot;Please wait a few seconds for the results of the 100-ping test to return. Each time you hit enter or click the chat button &quot;</span><span class="w"> </span><span class="o">+</span>
<span class="w">                         </span><span class="s2">&quot;a new 100-ping test will be queued. Please manually clear out the words &#39;ping&#39; or &#39;ping:host&#39; to stop pinging and start chatting.&quot;</span><span class="p">;</span>
<span class="w">   </span>
<span class="w">      </span><span class="c1">// Function that emits (if a socket has been established) the text in the form&#39;s input field.</span>
<span class="w">      </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#chatForm&#39;</span><span class="p">).</span><span class="nx">submit</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">chatString</span><span class="w"> </span><span class="o">=</span><span class="w">   </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#inputField&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span><span class="w"> </span><span class="c1">// user entry</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">defaultValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#inputField&#39;</span><span class="p">).</span><span class="nx">prop</span><span class="p">(</span><span class="s1">&#39;defaultValue&#39;</span><span class="p">);</span><span class="w"> </span><span class="c1">//this is the value attribute in the html</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">socket</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// ping to server</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">chatString</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;ping&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">echoTest</span><span class="p">(</span><span class="s1">&#39;server&#39;</span><span class="p">);</span>
<span class="w">               </span><span class="nx">displayMessage</span><span class="p">(</span><span class="w"> </span><span class="nx">pingTestHelp</span><span class="p">);</span>
<span class="w">               </span>
<span class="w">            </span><span class="c1">// ping to host   </span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">chatString</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;ping:host&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">echoTest</span><span class="p">(</span><span class="s1">&#39;host&#39;</span><span class="p">);</span>
<span class="w">               </span><span class="nx">displayMessage</span><span class="p">(</span><span class="w"> </span><span class="nx">pingTestHelp</span><span class="p">);</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">// peer-to-peer ping test...</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">chatString</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">8</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;ping:p2p&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="c1">// example command from the host chat field: ping:p2p-u15</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hostOrClient</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;host&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="nx">displayMessage</span><span class="p">(</span><span class="w"> </span><span class="nx">pingTestHelp</span><span class="p">);</span>
<span class="w">                  </span><span class="kd">var</span><span class="w"> </span><span class="nx">clientName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">chatString</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mf">1</span><span class="p">];</span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="w"> </span><span class="nx">clientName</span><span class="p">])</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="w"> </span><span class="nx">clientName</span><span class="p">].</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">dataChannel</span><span class="p">.</span><span class="nx">readyState</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;open&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                     </span><span class="nx">timer</span><span class="p">.</span><span class="nx">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">window</span><span class="p">.</span><span class="nx">performance</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
<span class="w">                     </span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="w"> </span><span class="nx">clientName</span><span class="p">].</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">dataChannel</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;ping&#39;</span><span class="o">:</span><span class="kc">true</span><span class="p">}</span><span class="w"> </span><span class="p">));</span>
<span class="w">                  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                     </span><span class="nx">displayMessage</span><span class="p">(</span><span class="s1">&#39;no client by that name (&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">clientName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;) or no p2p connection with that client&#39;</span><span class="p">);</span>
<span class="w">                  </span><span class="p">}</span>
<span class="w">               </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="nx">displayMessage</span><span class="p">(</span><span class="s1">&#39;P2P ping tests must start from the host.&#39;</span><span class="p">);</span>
<span class="w">                  </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#inputField&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">               </span><span class="p">}</span>
<span class="w">            </span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">chatString</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;noname&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">connect_and_listen</span><span class="p">(</span><span class="s1">&#39;normal&#39;</span><span class="p">);</span>
<span class="w">               </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#inputField&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">            </span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">chatString</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;help&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="kd">let</span><span class="w"> </span><span class="nx">tab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp&quot;</span><span class="p">;</span>
<span class="w">               </span><span class="kd">let</span><span class="w"> </span><span class="nx">helpString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Commands:&lt;br&gt;&quot;</span><span class="w"> </span><span class="o">+</span>
<span class="w">                  </span><span class="nx">tab</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;&lt;strong&gt;help&lt;/strong&gt;: list of the network commands than can run from the chat field&lt;br&gt;&quot;</span><span class="w"> </span><span class="o">+</span>
<span class="w">                  </span><span class="nx">tab</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;&lt;strong&gt;rr&lt;/strong&gt;: room report on connections to this room&lt;br&gt;&quot;</span><span class="w"> </span><span class="o">+</span>
<span class="w">                  </span><span class="nx">tab</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;&lt;strong&gt;dcir&lt;/strong&gt;: disconnect the clients in this room&lt;br&gt;&quot;</span><span class="w"> </span><span class="o">+</span>
<span class="w">                  </span><span class="nx">tab</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;&lt;strong&gt;ping&lt;/strong&gt;: ping test to the server&lt;br&gt;&quot;</span><span class="w"> </span><span class="o">+</span>
<span class="w">                  </span><span class="nx">tab</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;&lt;strong&gt;ping:host&lt;/strong&gt;: ping test to the host&lt;br&gt;&quot;</span><span class="w"> </span><span class="o">+</span>
<span class="w">                  </span><span class="nx">tab</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;&lt;strong&gt;ping:p2p-uN&lt;/strong&gt;: ping test to another p2p client, where N is an integer&lt;br&gt;&quot;</span><span class="w"> </span><span class="o">+</span>
<span class="w">                  </span><span class="nx">tab</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;&lt;strong&gt;cmd&lt;/strong&gt;: get more detailed help on the cmd commands&lt;br&gt;&quot;</span><span class="w"> </span><span class="o">+</span>
<span class="w">                  </span><span class="nx">tab</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;&lt;strong&gt;lb&lt;/strong&gt;: get more detailed help on leaderboard queries&lt;br&gt;&quot;</span><span class="w"> </span><span class="o">+</span>
<span class="w">                  </span><span class="nx">tab</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;&lt;strong&gt;dbrtc&lt;/strong&gt;: get more detailed help on debugging WebRTC stuff&lt;br&gt;&quot;</span><span class="w"> </span><span class="o">+</span>
<span class="w">                  </span><span class="nx">tab</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;&lt;strong&gt;noname&lt;/strong&gt;: reconnect as anonymous&lt;br&gt;&quot;</span><span class="w"> </span><span class="o">+</span>
<span class="w">                  </span><span class="s2">&quot;&quot;</span><span class="p">;</span>
<span class="w">               </span><span class="nx">displayMessage</span><span class="p">(</span><span class="w"> </span><span class="nx">helpString</span><span class="p">);</span>
<span class="w">               </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#inputField&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">            </span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">chatString</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;cmd&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="kd">let</span><span class="w"> </span><span class="nx">tab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&amp;nbsp;&amp;nbsp;&quot;</span><span class="p">;</span>
<span class="w">               </span><span class="kd">let</span><span class="w"> </span><span class="nx">helpString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;cmd examples:&lt;br&gt;&quot;</span><span class="w"> </span><span class="o">+</span>
<span class="w">                  </span><span class="nx">tab</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;cmd::{&quot;to&quot;:&quot;roomNoSender&quot;,&quot;data&quot;:{&quot;displayThis&quot;:&quot;exclude sender&quot;}}&lt;br&gt;&#39;</span><span class="w"> </span><span class="o">+</span>
<span class="w">                  </span><span class="nx">tab</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;cmd::{&quot;to&quot;:&quot;host&quot;,&quot;data&quot;:{&quot;displayThis&quot;:&quot;test string to room host&quot;}}&lt;br&gt;&#39;</span><span class="w"> </span><span class="o">+</span>
<span class="w">                  </span><span class="nx">tab</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;cmd::{&quot;to&quot;:&quot;room&quot;,&quot;data&quot;:{&quot;displayThis&quot;:&quot;test string to the whole room&quot;}}&lt;br&gt;&#39;</span><span class="w"> </span><span class="o">+</span>
<span class="w">                  </span><span class="nx">tab</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;cmd::{&quot;to&quot;:&quot;u20&quot;,&quot;data&quot;:{&quot;displayThis&quot;:&quot;test string to specific user&quot;}}&lt;br&gt;&#39;</span><span class="w"> </span><span class="o">+</span>
<span class="w">                  </span><span class="nx">tab</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;cmd::{&quot;to&quot;:&quot;jack&quot;,&quot;data&quot;:{&quot;displayThis&quot;:&quot;test string to specific user&quot;}}&lt;br&gt;&#39;</span><span class="w"> </span><span class="o">+</span>
<span class="w">                  </span><span class="s2">&quot;&quot;</span><span class="p">;</span>
<span class="w">               </span><span class="nx">displayMessage</span><span class="p">(</span><span class="w"> </span><span class="nx">helpString</span><span class="p">);</span>
<span class="w">               </span><span class="c1">// Put the first example into the chat field. This makes it easy to edit and submit.</span>
<span class="w">               </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#inputField&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="s1">&#39;cmd::{&quot;to&quot;:&quot;host&quot;,&quot;data&quot;:{&quot;displayThis&quot;:&quot;test string to room host&quot;}}&#39;</span><span class="p">);</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">// general command string input...</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">chatString</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">5</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;cmd::&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="kd">let</span><span class="w"> </span><span class="nx">string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">chatString</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;::&#39;</span><span class="p">)[</span><span class="mf">1</span><span class="p">];</span>
<span class="w">                  </span><span class="kd">let</span><span class="w"> </span><span class="nx">messageCommand</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="w"> </span><span class="nx">string</span><span class="p">);</span>
<span class="w">                  </span><span class="nx">sendSocketControlMessage</span><span class="p">(</span><span class="w"> </span><span class="nx">messageCommand</span><span class="p">);</span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">connected</span><span class="p">)</span><span class="w"> </span><span class="nx">displayMessage</span><span class="p">(</span><span class="s2">&quot;command sent...&quot;</span><span class="p">);</span><span class="w"> </span><span class="c1">// reassurance</span>
<span class="w">               </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="nx">displayMessage</span><span class="p">(</span><span class="s1">&#39;Might be an error in your JSON. Use &quot; not single quotes.&lt;br&gt;&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">e</span><span class="p">);</span>
<span class="w">                  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Error: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">e</span><span class="p">);</span>
<span class="w">               </span><span class="p">}</span>
<span class="w">               </span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">chatString</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;lb&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="kd">let</span><span class="w"> </span><span class="nx">tab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&amp;nbsp;&amp;nbsp;&quot;</span><span class="p">;</span>
<span class="w">               </span><span class="kd">let</span><span class="w"> </span><span class="nx">helpString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;lb (leaderboard) query examples:&lt;br&gt;&quot;</span><span class="w"> </span><span class="o">+</span>
<span class="w">                  </span><span class="nx">tab</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;lb::7.a&lt;br&gt;&#39;</span><span class="w"> </span><span class="o">+</span>
<span class="w">                  </span><span class="nx">tab</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;lb::4.e.monkeyhunt&lt;br&gt;&#39;</span><span class="w"> </span><span class="o">+</span>
<span class="w">                  </span><span class="nx">tab</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;lb::current&lt;br&gt;&#39;</span><span class="w"> </span><span class="o">+</span>
<span class="w">                  </span><span class="s2">&quot;&quot;</span><span class="p">;</span>
<span class="w">               </span><span class="nx">displayMessage</span><span class="p">(</span><span class="w"> </span><span class="nx">helpString</span><span class="p">);</span>
<span class="w">               </span><span class="c1">// Put the first example into the chat field. This makes it easy to edit and submit.</span>
<span class="w">               </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#inputField&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="s1">&#39;lb::current&#39;</span><span class="p">);</span>
<span class="w">               </span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">chatString</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">4</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;lb::&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hostOrClient</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;host&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="kd">let</span><span class="w"> </span><span class="nx">gameName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">chatString</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;::&quot;</span><span class="p">)[</span><span class="mf">1</span><span class="p">];</span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">gameName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;current&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                     </span><span class="nx">gameName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoVersion</span><span class="p">();</span>
<span class="w">                  </span><span class="p">}</span>
<span class="w">                  </span><span class="nx">lB</span><span class="p">.</span><span class="nx">requestReportOnly</span><span class="p">(</span><span class="w"> </span><span class="nx">gameName</span><span class="p">);</span>
<span class="w">               </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="nx">displayMessage</span><span class="p">(</span><span class="s2">&quot;Leaderboard queries are only available to the host.&quot;</span><span class="p">);</span>
<span class="w">               </span><span class="p">}</span>
<span class="w">               </span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">chatString</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">6</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;dbrtc&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="kd">let</span><span class="w"> </span><span class="nx">tab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&amp;nbsp;&amp;nbsp;&quot;</span><span class="p">;</span>
<span class="w">               </span><span class="kd">let</span><span class="w"> </span><span class="nx">helpString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dbrtc (debug webrtc) examples:&lt;br&gt;&quot;</span><span class="w"> </span><span class="o">+</span>
<span class="w">                  </span><span class="nx">tab</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;dbrtc:on&lt;br&gt;&#39;</span><span class="w"> </span><span class="o">+</span>
<span class="w">                  </span><span class="nx">tab</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;dbrtc:off&lt;br&gt;&#39;</span><span class="w"> </span><span class="o">+</span>
<span class="w">                  </span><span class="s2">&quot;&quot;</span><span class="p">;</span>
<span class="w">               </span><span class="nx">displayMessage</span><span class="p">(</span><span class="w"> </span><span class="nx">helpString</span><span class="p">);</span>
<span class="w">               </span><span class="c1">// Put the first example into the chat field. This makes it easy to edit and submit.</span>
<span class="w">               </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#inputField&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="s1">&#39;dbrtc:on&#39;</span><span class="p">);</span>
<span class="w">               </span>
<span class="w">            </span><span class="c1">// turn on (off) WebRTC debugging: set the db.rtc boolean   </span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">chatString</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">6</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;dbrtc:&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="c1">// dbrtc:on   dbrtc:off</span>
<span class="w">               </span><span class="kd">let</span><span class="w"> </span><span class="nx">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">chatString</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mf">1</span><span class="p">];</span>
<span class="w">               </span><span class="nx">sendSocketControlMessage</span><span class="p">({</span><span class="s2">&quot;to&quot;</span><span class="o">:</span><span class="s2">&quot;room&quot;</span><span class="p">,</span><span class="s2">&quot;data&quot;</span><span class="o">:</span><span class="p">{</span><span class="s2">&quot;dbrtc&quot;</span><span class="o">:</span><span class="nx">value</span><span class="p">}});</span>
<span class="w">               </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#inputField&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">               </span>
<span class="w">            </span><span class="c1">// all is well, just a chat message, send it out</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">chatString</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">defaultValue</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span>
<span class="w">                  </span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;chat message&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">chatString</span><span class="p">);</span>
<span class="w">                  </span>
<span class="w">                  </span><span class="c1">// If removing connections on the node server, delete corresponding clients.</span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">chatString</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;dcir&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                     </span><span class="nx">cT</span><span class="p">.</span><span class="nx">Client</span><span class="p">.</span><span class="nx">applyToAll</span><span class="p">(</span><span class="w"> </span><span class="nx">client</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;local&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s2">&quot;NPC&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                           </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">puck</span><span class="p">)</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">puck</span><span class="p">.</span><span class="nx">deleteThisOne</span><span class="p">({});</span>
<span class="w">                           </span><span class="ow">delete</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">name</span><span class="p">];</span>
<span class="w">                        </span><span class="p">}</span>
<span class="w">                     </span><span class="p">});</span>
<span class="w">                  </span><span class="p">}</span>
<span class="w">               </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="nx">displayMessage</span><span class="p">(</span><span class="s1">&#39;Nickname tip has been cleared from the chat field. Ready to chat now.&lt;br&gt;&lt;br&gt;&#39;</span><span class="w"> </span><span class="o">+</span>
<span class="w">                                 </span><span class="s1">&#39;Note: an alternative way for the host to establish a nickname is to put it in the chat field before starting demos 6, 7, or 8.&#39;</span><span class="p">);</span>
<span class="w">               </span><span class="p">}</span>
<span class="w">               </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#inputField&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span><span class="w"> </span><span class="c1">//clear out the input field.</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">         </span><span class="c1">// no socket...   </span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Note that I&#39;ve grayed out the unconnected (no socket) chat button on both the client and host pages so</span>
<span class="w">            </span><span class="c1">// this little block will not run anymore.</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">buttonName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">hostOrClient</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;client&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;&quot;Connect&quot;&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;&quot;Create&quot;&#39;</span><span class="p">;</span>
<span class="w">            </span><span class="nx">displayMessage</span><span class="p">(</span><span class="s1">&#39;Type in a short &quot;Room&quot; name, then click the &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">buttonName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39; button.&#39;</span><span class="p">);</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">         </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">      </span>
<span class="w">      </span><span class="cm">/*</span>
<span class="cm">      Leaving this here (commented). Replaced this bubbling stopper (for typing areas) with a more controlled exit</span>
<span class="cm">      in the keydown handler for the host and also for the client. That allows for modifier keys</span>
<span class="cm">      to be processed in the event handler even if the focus is in an input area.</span>
<span class="cm">      </span>
<span class="cm">      // Prevent typing in the input fields from triggering document level keyboard events.  </span>
<span class="cm">      $(&#39;#inputField, #nodeServer, #roomName, #jsonCapture&#39;).on(&#39;keyup keydown keypress&#39;, function( e) {</span>
<span class="cm">         e.stopPropagation(); // stops bubbling...</span>
<span class="cm">      });</span>
<span class="cm">      */</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// A first message in the chat area</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">helloMessage</span><span class="p">,</span><span class="w"> </span><span class="nx">helloMessageA</span><span class="p">;</span>
<span class="w">      </span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hostOrClient</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;host&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">helloMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="o">+</span>
<span class="w">         </span><span class="s1">&#39;From this page you can host a multiplayer room.&lt;/br&gt;&lt;/br&gt;&#39;</span><span class="o">+</span>
<span class="w">         </span>
<span class="w">         </span><span class="s1">&#39;To get started, type a short room name into the red box, then click the &quot;Create&quot; button.&lt;/br&gt;&lt;/br&gt;&#39;</span><span class="o">+</span>
<span class="w">         </span>
<span class="w">         </span><span class="s1">&#39;Optionally, provide a nickname in the chat field before clicking the &quot;Create&quot; button or starting a game (e.g. bob). &#39;</span><span class="o">+</span>
<span class="w">         </span><span class="s1">&#39;You may indicate team membership using the @ character (e.g. bob@green).&lt;/br&gt;&lt;/br&gt;&#39;</span><span class="w"> </span><span class="o">+</span>
<span class="w">         </span>
<span class="w">         </span><span class="s1">&#39;Use the &quot;m&quot; key (or click the &quot;Multiplayer&quot; checkbox) to toggle between this chat panel (where leaderboard reports are presented) and the &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">         </span><span class="s2">&quot;&lt;a onclick= \&quot; $(&#39;#chkMultiplayer&#39;).trigger(&#39;click&#39;); \&quot;&gt;help panel&lt;/a&gt;. &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">         </span><span class="s1">&#39;Doing so will not disable connections.&lt;/br&gt;&lt;/br&gt;&#39;</span><span class="o">+</span>
<span class="w">         </span>
<span class="w">         </span><span class="s1">&#39;Please note the &lt;a href=&quot;client.html&quot; target=&quot;_blank&quot;&gt;client&lt;/a&gt; links in the right panel (below the &quot;Friendly fire&quot; checkbox). &#39;</span><span class="o">+</span>
<span class="w">         </span><span class="s1">&#39;You can also get to the client from the site menu in the upper-left corner.&lt;/br&gt;&lt;/br&gt;&#39;</span><span class="o">+</span>
<span class="w">         </span>
<span class="w">         </span><span class="s1">&#39;When setting up the room as host, you might not get an immediate response from the server. It can take a little while for the Heroku node application to wake up. &#39;</span><span class="o">+</span>
<span class="w">         </span><span class="s1">&#39;If waking, give it 10 to 20 seconds before expecting a confimation message in this chat area.&lt;/br&gt;&lt;/br&gt;&#39;</span><span class="o">+</span>
<span class="w">         </span>
<span class="w">         </span><span class="s1">&#39;To start over, or disconnect from the server, please reload the page.&#39;</span><span class="p">;</span>
<span class="w">         </span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">clientDeviceType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;mobile&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">helloMessageA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;This is the mini-client page for multiplayer. This opens the Two Thumbs interface for the Puck Popper game. &#39;</span><span class="o">+</span>
<span class="w">                            </span><span class="s2">&quot;(Note that there are additional options with the &lt;a href=&#39;client.html&#39;&gt;full client&lt;/a&gt;.) &lt;/br&gt;&lt;/br&gt;&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="nb">window</span><span class="p">.</span><span class="nx">resizeTo</span><span class="p">(</span><span class="mf">475</span><span class="p">,</span><span class="mf">750</span><span class="p">);</span><span class="w">   </span><span class="c1">// 475,750</span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">helloMessageA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;This is the client page for multiplayer. &#39;</span><span class="o">+</span>
<span class="w">                            </span><span class="s2">&quot;(Note that the &lt;a href=&#39;client.html?m&#39;&gt;mini-client&lt;/a&gt; page is dedicated to the Two Thumbs interface for Puck Popper.) &lt;/br&gt;&lt;/br&gt;&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="nb">window</span><span class="p">.</span><span class="nx">resizeTo</span><span class="p">(</span><span class="mf">1240</span><span class="p">,</span><span class="mf">750</span><span class="p">);</span><span class="w">  </span><span class="c1">// 1240,750</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">         </span>
<span class="w">         </span><span class="nx">helloMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">helloMessageA</span><span class="w"> </span><span class="o">+</span>
<span class="w">         </span>
<span class="w">         </span><span class="s1">&#39;From here you can be a client in a multiplayer room. The room must be started (hosted) from the main triquence.org page. &#39;</span><span class="o">+</span>
<span class="w">         </span><span class="s1">&#39;Generally, a separate computer is used for hosting. For testing, the host and multiple clients can be run in separate windows on the same computer.&lt;/br&gt;&lt;/br&gt;&#39;</span><span class="o">+</span>
<span class="w">         </span>
<span class="w">         </span><span class="s1">&#39;To connect as a client, enter the room name (provided to you by the host), into the red box here, then click the &quot;Connect&quot; button.&lt;/br&gt;&lt;/br&gt;&#39;</span><span class="o">+</span><span class="w"> </span>
<span class="w">         </span>
<span class="w">         </span><span class="s1">&#39;Optionally, provide a nickname in the chat field before clicking the &quot;Connect&quot; button (e.g. bob). &#39;</span><span class="o">+</span>
<span class="w">         </span><span class="s1">&#39;You may indicate team membership using the @ character (e.g. bob@green).&lt;/br&gt;&lt;/br&gt;&#39;</span><span class="w"> </span><span class="o">+</span>
<span class="w">         </span>
<span class="w">         </span><span class="s1">&#39;To start over, or disconnect from the server, please reload the page.&#39;</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="nx">displayMessage</span><span class="p">(</span><span class="w"> </span><span class="nx">helloMessage</span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">clientColor</span><span class="p">(</span><span class="w"> </span><span class="nx">clientName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">clientName</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">1</span><span class="p">);</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">colorIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">trunc</span><span class="p">(</span><span class="nx">n</span><span class="o">/</span><span class="mf">10</span><span class="p">)</span><span class="o">*</span><span class="mf">10</span><span class="p">;</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">clientColors</span><span class="p">[</span><span class="w"> </span><span class="nx">colorIndex</span><span class="p">];</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">init_socket_listeners</span><span class="p">(</span><span class="w"> </span><span class="nx">roomName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Listeners needed by both the client and the host.</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Listen for chat being forwarded by the server.</span>
<span class="w">      </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;chat message&#39;</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">displayMessage</span><span class="p">(</span><span class="w"> </span><span class="nx">msg</span><span class="p">);</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Listen for similar-names report coming back from the server.</span>
<span class="w">      </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;name report&#39;</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">cl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">referenceToClient</span><span class="p">();</span>
<span class="w">         </span><span class="kd">let</span><span class="w"> </span><span class="nx">tab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&amp;nbsp;&amp;nbsp;&amp;nbsp;&quot;</span><span class="p">;</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">//console.log(&quot;name report (sv) = &quot; + msg.nickName);</span>
<span class="w">         </span>
<span class="w">         </span><span class="kd">let</span><span class="w"> </span><span class="nx">nickNameString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">nickName</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s2">&quot;&lt;br&gt;&quot;</span><span class="o">+</span><span class="nx">tab</span><span class="o">+</span><span class="s2">&quot;similar nicknames:&amp;nbsp;&amp;nbsp;&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">nickName</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">;</span>
<span class="w">         </span><span class="kd">let</span><span class="w"> </span><span class="nx">teamNameString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">teamName</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s2">&quot;&lt;br&gt;&quot;</span><span class="o">+</span><span class="nx">tab</span><span class="o">+</span><span class="s2">&quot;similar team names:&amp;nbsp;&amp;nbsp;&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">teamName</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">;</span>
<span class="w">         </span><span class="kd">let</span><span class="w"> </span><span class="nx">teamMemberString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">teamMemberCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s2">&quot;&lt;br&gt;&quot;</span><span class="o">+</span><span class="nx">tab</span><span class="o">+</span><span class="s2">&quot;&lt;strong&gt;&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">cl</span><span class="p">.</span><span class="nx">teamName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;&lt;/strong&gt; team count:&amp;nbsp;&amp;nbsp;&lt;strong&gt;&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">teamMemberCount</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;&lt;/strong&gt;&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">;</span>
<span class="w">         </span>
<span class="w">         </span><span class="kd">let</span><span class="w"> </span><span class="nx">displayString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;On the server&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">nickNameString</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">teamNameString</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">teamMemberString</span><span class="p">;</span>
<span class="w">         </span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">msg</span><span class="p">.</span><span class="nx">nickName</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">teamName</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">displayMessage</span><span class="p">(</span><span class="w"> </span><span class="nx">displayString</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;color&#39;</span><span class="o">:</span><span class="s1">&#39;green&#39;</span><span class="p">});</span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">teamMemberCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">displayMessage</span><span class="p">(</span><span class="w"> </span><span class="nx">displayString</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;color&#39;</span><span class="o">:</span><span class="s1">&#39;gray&#39;</span><span class="p">});</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Change the border color of the roomName input box depending on the </span>
<span class="w">      </span><span class="c1">// message from the node server. And add additional info to the message.</span>
<span class="w">      </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;room-joining-message&#39;</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">msg_object</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">debug</span><span class="p">(</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">rtc</span><span class="p">,</span><span class="s1">&#39;inside room-joining-message listener&#39;</span><span class="p">);</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">msg_object</span><span class="p">.</span><span class="nx">message</span><span class="p">;</span>
<span class="w">         </span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">cl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">referenceToClient</span><span class="p">();</span>
<span class="w">         </span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;You have joined room&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Some visual indicators that the connection succeeded.</span>
<span class="w">            </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;roomName&quot;</span><span class="p">).</span><span class="nx">style</span><span class="p">.</span><span class="nx">borderColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;#008080&quot;</span><span class="p">;</span><span class="w"> </span><span class="c1">//Dark green.</span>
<span class="w">            </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#ChatButton&#39;</span><span class="p">).</span><span class="nx">prop</span><span class="p">(</span><span class="s1">&#39;disabled&#39;</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">// If the names are the same, this indicates the network client has rejoined with a video stream.</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hostOrClient</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;client&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#twoThumbsButton&#39;</span><span class="p">).</span><span class="nx">prop</span><span class="p">(</span><span class="s1">&#39;disabled&#39;</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span>
<span class="w">            </span>
<span class="w">               </span><span class="c1">// If the name is the same, that indicates a reconnection. Either the client has</span>
<span class="w">               </span><span class="c1">// requested a video stream or is making a second attempt at a P2P connection.</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">cl</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">cl</span><span class="p">.</span><span class="nx">previous_name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">cl</span><span class="p">.</span><span class="nx">nickName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                     </span><span class="kd">var</span><span class="w"> </span><span class="nx">nNstring</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39; (&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">cl</span><span class="p">.</span><span class="nx">nickName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;).&#39;</span><span class="p">;</span>
<span class="w">                  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                     </span><span class="kd">var</span><span class="w"> </span><span class="nx">nNstring</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;.&#39;</span><span class="p">;</span>
<span class="w">                  </span><span class="p">}</span>
<span class="w">                  </span><span class="kd">var</span><span class="w"> </span><span class="nx">nameString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cl</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">nNstring</span><span class="p">;</span>
<span class="w">                  </span>
<span class="w">                  </span><span class="c1">// Adjust the reconnection message for P2P and streaming attempts. Wait for the connection process to finish.</span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s2">&quot;Firefox&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                     </span><span class="kd">var</span><span class="w"> </span><span class="nx">waitBeforeCheck</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">4500</span><span class="p">;</span><span class="w"> </span><span class="c1">// Mozilla</span>
<span class="w">                  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                     </span><span class="kd">var</span><span class="w"> </span><span class="nx">waitBeforeCheck</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2000</span><span class="p">;</span><span class="w"> </span><span class="c1">// Chrome</span>
<span class="w">                  </span><span class="p">}</span>
<span class="w">                  </span><span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">                     </span><span class="kd">var</span><span class="w"> </span><span class="nx">p2pConnection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">rtc_choke</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">cl</span><span class="p">.</span><span class="nx">rtc</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">cl</span><span class="p">.</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">dataChannel</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">cl</span><span class="p">.</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">dataChannel</span><span class="p">.</span><span class="nx">readyState</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;open&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
<span class="w">                     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">p2pConnection</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">dC</span><span class="p">.</span><span class="nx">chkRequestStream</span><span class="p">.</span><span class="nx">checked</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">                           </span><span class="nx">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;You have reconnected with a video stream. Your name is still &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">nameString</span><span class="p">;</span>
<span class="w">                        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                           </span><span class="nx">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;A P2P connection has been established. Your name is still &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">nameString</span><span class="p">;</span>
<span class="w">                        </span><span class="p">}</span>
<span class="w">                     </span><span class="c1">// P2P attempt failed</span>
<span class="w">                     </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">dC</span><span class="p">.</span><span class="nx">chkRequestStream</span><span class="p">.</span><span class="nx">checked</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">                           </span><span class="nx">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;You attempted to reconnected with a video stream. However, the needed P2P connection could not be established. Your name is still &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">nameString</span><span class="p">;</span>
<span class="w">                        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                           </span><span class="nx">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;An attempt to upgrade your connection from socket.io to peer-to-peer (P2P) has not succeeded. Your name is still &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">nameString</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="w"> </span><span class="o">+</span>
<span class="w">                                 </span><span class="s1">&#39;You may wish to simply try the &quot;Connect&quot; button again... &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">                                 </span><span class="s1">&#39;&lt;br&gt;&lt;br&gt;&#39;</span><span class="w"> </span><span class="o">+</span>
<span class="w">                                 </span><span class="s1">&#39;All the demos work well with a socket.io connection, but there is a little more lag and no streaming option. &#39;</span><span class="w"> </span><span class="o">+</span>
<span class="w">                                 </span><span class="s1">&#39;&lt;br&gt;&lt;br&gt;&#39;</span><span class="w"> </span><span class="o">+</span>
<span class="w">                                 </span><span class="s1">&#39;Difficulty establishing a P2P connection can be related to your browser or network conditions. &#39;</span><span class="w"> </span><span class="o">+</span>
<span class="w">                                 </span><span class="s1">&#39;As an alternative, you may wish to try running your own local node server as described in the &quot;Installation of a node server&quot; section &#39;</span><span class="w"> </span><span class="o">+</span>
<span class="w">                                 </span><span class="s1">&#39;on the &lt;a href=&quot;multiplayer.html&quot; target=&quot;_blank&quot;&gt;Multiplayer&lt;/a&gt; page.&#39;</span><span class="p">;</span>
<span class="w">                        </span><span class="p">}</span>
<span class="w">                     </span><span class="p">}</span>
<span class="w">                     </span><span class="nx">displayMessage</span><span class="p">(</span><span class="w"> </span><span class="nx">msg</span><span class="p">);</span>
<span class="w">                  </span><span class="p">},</span><span class="w"> </span><span class="nx">waitBeforeCheck</span><span class="p">);</span>
<span class="w">               </span>
<span class="w">               </span><span class="c1">// Normal non-host client connection (not a reconnect).</span>
<span class="w">               </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">clientDeviceType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;mobile&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                     </span><span class="c1">// Let the host know this (pure Two-Thumbs) so the client cursor can be inhibited.</span>
<span class="w">                     </span><span class="kd">var</span><span class="w"> </span><span class="nx">control_message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;from&#39;</span><span class="o">:</span><span class="nx">cl</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;to&#39;</span><span class="o">:</span><span class="s1">&#39;host&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;data&#39;</span><span class="o">:</span><span class="p">{</span><span class="s1">&#39;clientDeviceType&#39;</span><span class="o">:</span><span class="s1">&#39;mobile&#39;</span><span class="p">}</span><span class="w"> </span><span class="p">};</span>
<span class="w">                     </span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;control message&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">control_message</span><span class="p">);</span>
<span class="w">                     </span>
<span class="w">                     </span><span class="nx">msg</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="o">+</span>
<span class="w">                     </span><span class="s2">&quot;&lt;/br&gt;&lt;/br&gt;&quot;</span><span class="o">+</span>
<span class="w">                                       </span>
<span class="w">                     </span><span class="s2">&quot;Touch the &lt;strong&gt;Two Thumbs&lt;/strong&gt; button to start the virtual game-pad interface. This requires line-of-sight to the host&#39;s monitor. &quot;</span><span class="o">+</span>
<span class="w">                     </span><span class="s2">&quot;If you don&#39;t have line-of-sight, you can start up a second client (in desktop mode) and stream to it.&lt;/br&gt;&quot;</span><span class="p">;</span>
<span class="w">                  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                     </span><span class="nx">msg</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="o">+</span>
<span class="w">                     </span><span class="s2">&quot;&lt;/br&gt;&lt;/br&gt;&quot;</span><span class="o">+</span>
<span class="w">                     </span><span class="s2">&quot;You are in &lt;strong&gt;normal desktop&lt;/strong&gt; mode. Your mouse and keyboard events get sent to the host. You must have direct visual access to the host&#39;s monitor.&quot;</span><span class="o">+</span>
<span class="w">                     </span><span class="s2">&quot;&lt;/br&gt;&lt;/br&gt;&quot;</span><span class="o">+</span>
<span class="w">                     </span>
<span class="w">                     </span><span class="s2">&quot;Two other options:&lt;/br&gt;&lt;/br&gt;&quot;</span><span class="o">+</span>
<span class="w">                     </span>
<span class="w">                     </span><span class="s2">&quot;&lt;strong&gt;Stream:&lt;/strong&gt; This is like normal mode, but the host&#39;s canvas is rendered in the video element here. &quot;</span><span class="o">+</span>
<span class="w">                     </span><span class="s2">&quot;So you can play out-of-sight of the host&#39;s monitor, in a separate room, city, country...&lt;/br&gt;&lt;/br&gt;&quot;</span><span class="o">+</span>
<span class="w">                     </span>
<span class="w">                     </span><span class="s2">&quot;&lt;strong&gt;Two Thumbs:&lt;/strong&gt; touch-screen interface for your phone. Similar to normal mode, this requires line-of-sight to the host&#39;s monitor. &quot;</span><span class="o">+</span>
<span class="w">                     </span><span class="s2">&quot;However, you can start up a second client (on a second device) and stream to it if you don&#39;t have line-of-sight.&lt;/br&gt;&quot;</span><span class="p">;</span>
<span class="w">                  </span><span class="p">}</span>
<span class="w">               </span><span class="p">}</span><span class="w"> </span>
<span class="w">            </span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hostOrClient</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;host&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">cl</span><span class="p">.</span><span class="nx">nameFromServer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">msg_object</span><span class="p">.</span><span class="nx">userName</span><span class="p">;</span>
<span class="w">               </span><span class="c1">// If you have reconnected as host, or if there is another room active, your new nickname may be in use by someone else, and therefore incremented by the server.</span>
<span class="w">               </span><span class="c1">// Accept that incremented version of your nickname (e.g. bob15).</span>
<span class="w">               </span><span class="nx">cl</span><span class="p">.</span><span class="nx">nickName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">msg_object</span><span class="p">.</span><span class="nx">nickName</span><span class="p">;</span>
<span class="w">               </span><span class="c1">// Also reset all the nickname fields near each game.</span>
<span class="w">               </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;input.nickNameField&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="w"> </span><span class="nx">cl</span><span class="p">.</span><span class="nx">nickName</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// Client might get this warning...</span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;Sorry, there is no host&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;roomName&quot;</span><span class="p">).</span><span class="nx">style</span><span class="p">.</span><span class="nx">borderColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;red&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="nx">refresh_P2P_indicator</span><span class="p">({</span><span class="s1">&#39;mode&#39;</span><span class="o">:</span><span class="s1">&#39;reset&#39;</span><span class="p">});</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// A candidate host might get this warning... </span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;Sorry, there is already a host&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;roomName&quot;</span><span class="p">).</span><span class="nx">style</span><span class="p">.</span><span class="nx">borderColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;red&quot;</span><span class="p">;</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// Additional instructions for the new host. This room-joining-message event will have to be triggered a second time to get this message to the host after</span>
<span class="w">         </span><span class="c1">// the &quot;You have joined room&quot; message above.</span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;You are the host&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">openWindowString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&quot;&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;window.open(&#39;client.html&#39;, &#39;_blank&#39;, &#39;width=1240, height=750&#39;) &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;&quot;&#39;</span><span class="p">;</span>
<span class="w">            </span><span class="nx">msg</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s1">&#39; Your name is &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">cl</span><span class="p">.</span><span class="nx">nameString</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;. &#39;</span><span class="w"> </span><span class="o">+</span>
<span class="w">            </span><span class="s2">&quot;&lt;/br&gt;&lt;/br&gt;&quot;</span><span class="o">+</span>
<span class="w">            </span><span class="s1">&#39;You can still establish or change the nickname for the host. Put it in the chat field &#39;</span><span class="o">+</span>
<span class="w">            </span><span class="s1">&#39;before running the game demos (e.g. 3d, 4e, 6, 7 and 8). Do not submit as chat. This nickname is used in reports to the leaderboard.&#39;</span><span class="o">+</span>
<span class="w">            </span><span class="s1">&#39;&lt;/br&gt;&lt;/br&gt;&#39;</span><span class="o">+</span>
<span class="w">            </span><span class="s2">&quot;You can open a test &lt;a href=&#39;#&#39; onClick=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">openWindowString</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;title=&#39;Open a client page in a new window.&#39;&gt;client&lt;/a&gt; in a new window. &quot;</span><span class="o">+</span>
<span class="w">            </span><span class="s2">&quot;Connect the client using the same room name you established here as the host. Then the client mouse and keyboard events will be transmitted to the canvas of the host.&quot;</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">         </span><span class="nx">displayMessage</span><span class="p">(</span><span class="w"> </span><span class="nx">msg</span><span class="p">);</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Once your connection succeeds, join a room.</span>
<span class="w">      </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connect&#39;</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">debug</span><span class="p">(</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">rtc</span><span class="p">,</span><span class="s1">&#39;inside connect listener&#39;</span><span class="p">);</span>
<span class="w">         </span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hostOrClient</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;host&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;roomJoin&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;hostOrClient&#39;</span><span class="o">:</span><span class="nx">hostOrClient</span><span class="p">,</span><span class="s1">&#39;roomName&#39;</span><span class="o">:</span><span class="nx">roomName</span><span class="p">}</span><span class="w"> </span><span class="p">);</span>
<span class="w">            </span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hostOrClient</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;client&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;roomJoin&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;hostOrClient&#39;</span><span class="o">:</span><span class="nx">hostOrClient</span><span class="p">,</span><span class="s1">&#39;roomName&#39;</span><span class="o">:</span><span class="nx">roomName</span><span class="p">,</span>
<span class="w">                                     </span><span class="s1">&#39;player&#39;</span><span class="o">:</span><span class="nx">dC</span><span class="p">.</span><span class="nx">chkPlayer</span><span class="p">.</span><span class="nx">checked</span><span class="p">,</span>
<span class="w">                                     </span><span class="s1">&#39;requestStream&#39;</span><span class="o">:</span><span class="nx">dC</span><span class="p">.</span><span class="nx">chkRequestStream</span><span class="p">.</span><span class="nx">checked</span><span class="p">}</span><span class="w"> </span><span class="p">);</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Listen for echo response from the server.</span>
<span class="w">      </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;echo-from-Server-to-Client&#39;</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">echoTarget</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">msg</span><span class="p">;</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// Stop timer (measure the round trip).</span>
<span class="w">         </span><span class="nx">timer</span><span class="p">.</span><span class="nx">stop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">window</span><span class="p">.</span><span class="nx">performance</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">elapsed_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">timer</span><span class="p">.</span><span class="nx">stop</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">timer</span><span class="p">.</span><span class="nx">start</span><span class="p">;</span>
<span class="w">         </span><span class="c1">// Add this new timing result to the array.</span>
<span class="w">         </span><span class="nx">timer</span><span class="p">.</span><span class="nx">pingArray</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="w"> </span><span class="nx">elapsed_time</span><span class="p">);</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// The echo series STOPs here.</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">timer</span><span class="p">.</span><span class="nx">pingArray</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">99</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">displayMessage</span><span class="p">(</span><span class="w"> </span><span class="nx">echoReport</span><span class="p">(</span><span class="w"> </span><span class="nx">echoTarget</span><span class="p">));</span>
<span class="w">            </span><span class="nx">timer</span><span class="p">.</span><span class="nx">pingArray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// Ping it again (continue the series).</span>
<span class="w">         </span><span class="nx">echoTest</span><span class="p">(</span><span class="w"> </span><span class="nx">echoTarget</span><span class="p">);</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// Do this after the timer starts (don&#39;t slow it down with a write to the console.)</span>
<span class="w">         </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="w"> </span><span class="nx">echoTarget</span><span class="p">);</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// WebRTC Signaling.</span>
<span class="w">      </span><span class="c1">// This handles signaling from both sides of the peer-to-peer connection.</span>
<span class="w">      </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;signaling message&#39;</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">         </span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="kr">from</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;host&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">clientName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">to</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">clientName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="kr">from</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">cl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">referenceToClient</span><span class="p">(</span><span class="w"> </span><span class="nx">clientName</span><span class="p">);</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// Note that signalData needs to be in a stringified form when writing to the console.</span>
<span class="w">         </span><span class="nx">debug</span><span class="p">(</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">rtc</span><span class="p">,</span><span class="s2">&quot;signal message from &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="kr">from</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;, to &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">to</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">signalData</span><span class="p">));</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// Offers and Answers</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">signalData</span><span class="p">.</span><span class="nx">sdp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">signalData</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;offer&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">debug</span><span class="p">(</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">rtc</span><span class="p">,</span><span class="s2">&quot;an offer&quot;</span><span class="p">);</span>
<span class="w">               </span><span class="nx">handleOffer</span><span class="p">(</span><span class="w"> </span><span class="nx">clientName</span><span class="p">,</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">signalData</span><span class="p">);</span>
<span class="w">               </span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">signalData</span><span class="p">.</span><span class="nx">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;answer&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">debug</span><span class="p">(</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">rtc</span><span class="p">,</span><span class="s2">&quot;an answer&quot;</span><span class="p">);</span>
<span class="w">               </span><span class="nx">handleAnswer</span><span class="p">(</span><span class="w"> </span><span class="nx">clientName</span><span class="p">,</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">signalData</span><span class="p">);</span>
<span class="w">               </span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Woooooo-HoHo-Hoooooo, this can&#39;t be good.&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// ICE candidates</span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">signalData</span><span class="p">.</span><span class="nx">candidate</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// handle ICE stuff.</span>
<span class="w">            </span><span class="nx">cl</span><span class="p">.</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">pc</span><span class="p">.</span><span class="nx">addIceCandidate</span><span class="p">(</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">signalData</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">debug</span><span class="p">(</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">rtc</span><span class="p">,</span><span class="s1">&#39;signaling state after handling ICE candidate = &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">cl</span><span class="p">.</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">pc</span><span class="p">.</span><span class="nx">signalingState</span><span class="p">);</span>
<span class="w">            </span><span class="p">})</span>
<span class="w">            </span><span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">reason</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="c1">// An error occurred, so...</span>
<span class="w">               </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Error while handling ICE candidate:&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">reason</span><span class="p">);</span>
<span class="w">            </span><span class="p">});</span>
<span class="w">            </span>
<span class="w">            </span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">//No WebRTC stuff found in the signaling message. Maybe you are testing...</span>
<span class="w">            </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;No WebRTC stuff found in the signaling message. This is the final else block of &#39;signaling message&#39; listener.&quot;</span><span class="p">);</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">      </span>
<span class="w">      </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;control message&#39;</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="c1">// General receiver of control messages. This can be used by either the host or a client to</span>
<span class="w">         </span><span class="c1">// receive messages from anyone. Note that the server directs the control messages according to its</span>
<span class="w">         </span><span class="c1">// msg.to values: &#39;host&#39;, &#39;room&#39;, &#39;roomNoSender&#39;, or a specific user name like &#39;u15&#39;.</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// (Refer to the handler for command-from-host-to-all-clients for a similar but more specific approach to</span>
<span class="w">         </span><span class="c1">// command processing.)</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// Control actions allowed on both the host and client pages.</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="s1">&#39;displayThis&#39;</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">displayMessage</span><span class="p">(</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="s1">&#39;displayThis&#39;</span><span class="p">]);</span>
<span class="w">            </span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="s1">&#39;dbrtc&#39;</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">displayMessage</span><span class="p">(</span><span class="w"> </span><span class="s2">&quot;RTC debug setting = &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="s1">&#39;dbrtc&#39;</span><span class="p">]);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="s1">&#39;dbrtc&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;on&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">db</span><span class="p">.</span><span class="nx">rtc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">db</span><span class="p">.</span><span class="nx">rtc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// Control actions allowed only on the host&#39;s page.</span>
<span class="w">         </span><span class="c1">// Note the use of gW.clients here. This is only available on the host device.</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hostOrClient</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;host&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="s1">&#39;videoStream&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;off&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="kr">from</span><span class="p">].</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">turnVideoStreamOff</span><span class="p">();</span>
<span class="w">               </span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="s1">&#39;fullScreen&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;off&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;full screen requested off by client&#39;</span><span class="p">);</span>
<span class="w">               </span><span class="c1">// I played around with trying to do something here, but the browsers fullscreen API requires that</span>
<span class="w">               </span><span class="c1">// a change starts with a gesture. The error: &#39;...API can only be initiated by a user gesture.&#39;</span>
<span class="w">               </span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="s1">&#39;clientDeviceType&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;mobile&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="c1">// Attribute to inhibit client cursor.</span>
<span class="w">               </span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="kr">from</span><span class="p">].</span><span class="nx">deviceType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;mobile&#39;</span><span class="p">;</span>
<span class="w">               </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;client &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="kr">from</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39; is in mobile mode&#39;</span><span class="p">);</span>
<span class="w">               </span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="s1">&#39;puckPopped&#39;</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="s1">&#39;puckPopped&#39;</span><span class="p">].</span><span class="nx">value</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;probeAtHost&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="c1">// Check to see if the requesting client is still in the clients object and still has a puck.</span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">msg</span><span class="p">.</span><span class="kr">from</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="kr">from</span><span class="p">].</span><span class="nx">puck</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                     </span><span class="kd">var</span><span class="w"> </span><span class="nx">puckPopped</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">                  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                     </span><span class="kd">var</span><span class="w"> </span><span class="nx">puckPopped</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">                  </span><span class="p">}</span>
<span class="w">                  </span><span class="c1">// Send reply message back to the client.</span>
<span class="w">                  </span><span class="kd">var</span><span class="w"> </span><span class="nx">control_message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;from&#39;</span><span class="o">:</span><span class="s1">&#39;host&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;to&#39;</span><span class="o">:</span><span class="nx">msg</span><span class="p">.</span><span class="kr">from</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;data&#39;</span><span class="o">:</span><span class="p">{</span><span class="s1">&#39;puckPopped&#39;</span><span class="o">:</span><span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="o">:</span><span class="nx">puckPopped</span><span class="p">}}</span><span class="w"> </span><span class="p">};</span>
<span class="w">                  </span><span class="nx">sendSocketControlMessage</span><span class="p">(</span><span class="w"> </span><span class="nx">control_message</span><span class="p">);</span>
<span class="w">                  </span>
<span class="w">                  </span><span class="c1">// Sync the gun and jet angles, i.e. send angles out to the clients.</span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="kr">from</span><span class="p">])</span><span class="w"> </span><span class="nx">pP</span><span class="p">.</span><span class="nx">gunAngleFromHost</span><span class="p">(</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="kr">from</span><span class="p">],</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="kr">from</span><span class="p">])</span><span class="w"> </span><span class="nx">pP</span><span class="p">.</span><span class="nx">jetAngleFromHost</span><span class="p">(</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="kr">from</span><span class="p">]);</span>
<span class="w">               </span><span class="p">}</span>
<span class="w">               </span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="s1">&#39;twoThumbsEnabled&#39;</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="kr">from</span><span class="p">])</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="kr">from</span><span class="p">].</span><span class="nx">twoThumbsEnabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="s1">&#39;twoThumbsEnabled&#39;</span><span class="p">].</span><span class="nx">value</span><span class="p">;</span>
<span class="w">               </span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="s1">&#39;androidDebug&#39;</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">gW</span><span class="p">.</span><span class="nx">messages</span><span class="p">[</span><span class="s1">&#39;lowHelp&#39;</span><span class="p">].</span><span class="nx">newMessage</span><span class="p">(</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="s1">&#39;androidDebug&#39;</span><span class="p">].</span><span class="nx">debugString</span><span class="p">,</span><span class="w"> </span><span class="mf">10.0</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span>
<span class="w">         </span><span class="c1">// Control actions allowed only the client page.</span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hostOrClient</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;client&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="s1">&#39;canvasResize&#39;</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;command to resize canvas: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="s1">&#39;canvasResize&#39;</span><span class="p">].</span><span class="nx">width</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;, &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="s1">&#39;canvasResize&#39;</span><span class="p">].</span><span class="nx">height</span><span class="p">);</span>
<span class="w">               </span><span class="nx">videoMirror</span><span class="p">.</span><span class="nx">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">canvasResize</span><span class="p">.</span><span class="nx">width</span><span class="p">;</span><span class="w"> </span>
<span class="w">               </span><span class="nx">videoMirror</span><span class="p">.</span><span class="nx">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">canvasResize</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
<span class="w">               </span>
<span class="w">               </span><span class="nx">demoRunningOnHost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="s1">&#39;demoVersion&#39;</span><span class="p">];</span>
<span class="w">               </span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="s1">&#39;gunAngle&#39;</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">twoThumbs</span><span class="p">.</span><span class="nx">processGunAngleFromHost</span><span class="p">(</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
<span class="w">               </span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="s1">&#39;jetAngle&#39;</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">twoThumbs</span><span class="p">.</span><span class="nx">processJetAngleFromHost</span><span class="p">(</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
<span class="w">               </span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="s1">&#39;drawSync&#39;</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="s1">&#39;drawSync&#39;</span><span class="p">].</span><span class="nx">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="nx">refresh_P2P_indicator</span><span class="p">({</span><span class="s1">&#39;mode&#39;</span><span class="o">:</span><span class="s1">&#39;sync&#39;</span><span class="p">});</span>
<span class="w">               </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="nx">refresh_P2P_indicator</span><span class="p">({</span><span class="s1">&#39;mode&#39;</span><span class="o">:</span><span class="s1">&#39;p2p&#39;</span><span class="p">});</span>
<span class="w">               </span><span class="p">}</span>
<span class="w">               </span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="s1">&#39;puckPopped&#39;</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">twoThumbs</span><span class="p">.</span><span class="nx">setPuckPopped</span><span class="p">(</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="s1">&#39;puckPopped&#39;</span><span class="p">].</span><span class="nx">value</span><span class="p">);</span>
<span class="w">               </span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="s1">&#39;controlKey&#39;</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">mK</span><span class="p">[</span><span class="s1">&#39;ct&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="s1">&#39;controlKey&#39;</span><span class="p">].</span><span class="nx">value</span><span class="p">;</span>
<span class="w">               </span><span class="nx">eVN</span><span class="p">.</span><span class="nx">handle_sending_mK_data</span><span class="p">(</span><span class="w"> </span><span class="nx">mK</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Listeners needed by the client only.</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hostOrClient</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;client&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">         </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;your name is&#39;</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>
<span class="w">            </span><span class="c1">// To see where nickName and teamName are sent to the host, look at the emit to </span>
<span class="w">            </span><span class="c1">// new-game-client on the server and the corresponding listener here.</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">// Put this name in the mouse and keyboard (mK) global that is used to send</span>
<span class="w">            </span><span class="c1">// state data from the client.</span>
<span class="w">            </span><span class="nx">mK</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">name</span><span class="p">;</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">// Put your name in this global (on the client side) for (possible) use by the WebRTC functions.</span>
<span class="w">            </span><span class="nx">newClientName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">name</span><span class="p">;</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">// Before updating cl_clientSide.name with the new client name, store it&#39;s current value in previous_name.</span>
<span class="w">            </span><span class="nx">cl_clientSide</span><span class="p">.</span><span class="nx">previous_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cl_clientSide</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
<span class="w">            </span><span class="nx">cl_clientSide</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">newClientName</span><span class="p">;</span>
<span class="w">            </span>
<span class="w">            </span><span class="nx">debug</span><span class="p">(</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">rtc</span><span class="p">,</span><span class="s1">&#39;inside &quot;your name is&quot;, names: current=&#39;</span><span class="o">+</span><span class="nx">cl_clientSide</span><span class="p">.</span><span class="nx">name</span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;, previous=&#39;</span><span class="o">+</span><span class="w"> </span><span class="nx">cl_clientSide</span><span class="p">.</span><span class="nx">previous_name</span><span class="w"> </span><span class="p">);</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">// Initialize rtc for the client side of the p2p connection.</span>
<span class="w">            </span><span class="nx">cl_clientSide</span><span class="p">.</span><span class="nx">rtc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">RTC</span><span class="p">({</span><span class="s1">&#39;user1&#39;</span><span class="o">:</span><span class="nx">newClientName</span><span class="p">,</span><span class="s1">&#39;user2&#39;</span><span class="o">:</span><span class="s1">&#39;host&#39;</span><span class="p">});</span>
<span class="w">            </span><span class="nx">openDataChannel</span><span class="p">(</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span><span class="w"> </span><span class="c1">// Open as NOT the initiator</span>
<span class="w">         </span><span class="p">});</span>
<span class="w">         </span>
<span class="w">         </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;disconnectByServer&#39;</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">debug</span><span class="p">(</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">rtc</span><span class="p">,</span><span class="s1">&#39;in client disconnectByServer, msg=&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;,&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">originator</span><span class="p">);</span>
<span class="w">            </span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">clientName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
<span class="w">            </span><span class="nx">displayMessage</span><span class="p">(</span><span class="s2">&quot;This client (&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">clientName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;) is being disconnected by the &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">originator</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;.&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;roomName&quot;</span><span class="p">).</span><span class="nx">style</span><span class="p">.</span><span class="nx">borderColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;red&quot;</span><span class="p">;</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">// When the server gets this one, it will remove the socket.</span>
<span class="w">            </span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;okDisconnectMe&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">clientName</span><span class="p">);</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">// Shutdown and delete the client side of the WebRTC p2p connection.</span>
<span class="w">            </span><span class="nx">cl_clientSide</span><span class="p">.</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">shutdown</span><span class="p">();</span>
<span class="w">            </span><span class="nx">eVN</span><span class="p">.</span><span class="nx">initialize_mK</span><span class="p">();</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">// Delay this so it takes effect after the p2p toggle finishes.</span>
<span class="w">            </span><span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">displayMessage</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
<span class="w">               </span><span class="nx">displayMessage</span><span class="p">(</span><span class="s2">&quot;Shutdown of the connection for &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">clientName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot; has finished.&quot;</span><span class="p">);</span>
<span class="w">               </span><span class="nx">displayMessage</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
<span class="w">               </span><span class="nx">displayMessage</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
<span class="w">               </span><span class="nx">displayMessage</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
<span class="w">               </span><span class="nx">refresh_P2P_indicator</span><span class="p">({</span><span class="s1">&#39;mode&#39;</span><span class="o">:</span><span class="s1">&#39;disconnected&#39;</span><span class="p">});</span>
<span class="w">            </span><span class="p">},</span><span class="w"> </span><span class="mf">100</span><span class="p">);</span>
<span class="w">         </span><span class="p">});</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// Refer to the &quot;control message&quot; handler for a more general approach to command processing. Below is a</span>
<span class="w">         </span><span class="c1">// specific host-to-all-clients approach.</span>
<span class="w">         </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;command-from-host-to-all-clients&#39;</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Clients (only) do something based on the message from the host.</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">type</span><span class="p">;</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">command</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">command</span><span class="p">;</span>
<span class="w">            </span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;resize&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">clientDeviceType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;mobile&#39;</span><span class="p">)</span><span class="w"> </span><span class="nx">command</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;mobile&#39;</span><span class="p">;</span>
<span class="w">               </span><span class="c1">//console.log(&#39;command = &#39; + command);</span>
<span class="w">               </span><span class="nx">dS</span><span class="p">.</span><span class="nx">adjustSizeOfChatDiv</span><span class="p">(</span><span class="w"> </span><span class="nx">command</span><span class="p">);</span>
<span class="w">               </span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">command</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;normal&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="nx">videoMirror</span><span class="p">.</span><span class="nx">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">600</span><span class="p">,</span><span class="w"> </span><span class="nx">videoMirror</span><span class="p">.</span><span class="nx">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">600</span><span class="p">;</span>
<span class="w">               </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="nx">videoMirror</span><span class="p">.</span><span class="nx">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1250</span><span class="p">,</span><span class="w"> </span><span class="nx">videoMirror</span><span class="p">.</span><span class="nx">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">950</span><span class="p">;</span>
<span class="w">               </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;no match in command-from-host-to-all-clients handler&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">         </span><span class="p">});</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Listeners needed by the host only.</span>
<span class="w">      </span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hostOrClient</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;host&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="c1">// (Note: this is the one place where calls to gW are made inside of hC.)</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// Listen for client mouse and keyboard (mk) events broadcast from the server.</span>
<span class="w">         </span><span class="c1">// StH: Server to Host</span>
<span class="w">         </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;client-mK-StH-event&#39;</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="nx">mk_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">msg</span><span class="p">;</span>
<span class="w">            </span><span class="c1">// On the host, update the mouse-and-keyboard state for the specified client.</span>
<span class="w">            </span><span class="nx">cT</span><span class="p">.</span><span class="nx">updateClientState</span><span class="p">(</span><span class="w"> </span><span class="nx">mk_data</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">mk_data</span><span class="p">);</span>
<span class="w">         </span><span class="p">});</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// As host, create a new client in gW framework.</span>
<span class="w">         </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;new-game-client&#39;</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">streamRequested</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">requestStream</span><span class="p">;</span>
<span class="w">            </span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">clientName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">clientName</span><span class="p">;</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">player</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">player</span><span class="p">;</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">nickName</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">nickName</span><span class="p">;</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">teamName</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nx">msg</span><span class="p">.</span><span class="nx">teamName</span><span class="p">;</span>
<span class="w">            </span>
<span class="w">            </span><span class="nx">createNetworkClient</span><span class="p">({</span><span class="s1">&#39;clientName&#39;</span><span class="o">:</span><span class="nx">clientName</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;player&#39;</span><span class="o">:</span><span class="nx">player</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;nickName&#39;</span><span class="o">:</span><span class="nx">nickName</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;teamName&#39;</span><span class="o">:</span><span class="nx">teamName</span><span class="p">});</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">// WebRTC. Start the p2p connection here (from the host) when we hear (from the server)</span>
<span class="w">            </span><span class="c1">// that a client is trying to connect to a room.</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">cl_hostSide</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="w"> </span><span class="nx">clientName</span><span class="p">];</span>
<span class="w">            </span><span class="nx">cl_hostSide</span><span class="p">.</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">user1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;host&#39;</span><span class="p">;</span>
<span class="w">            </span><span class="nx">cl_hostSide</span><span class="p">.</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">user2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">clientName</span><span class="p">;</span>
<span class="w">            </span><span class="nx">cl_hostSide</span><span class="p">.</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">streamRequested</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">streamRequested</span><span class="p">;</span>
<span class="w">            </span><span class="nx">debug</span><span class="p">(</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">rtc</span><span class="p">,</span><span class="s1">&#39;in new-game-client, cl_hostSide.rtc.user2 = &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">cl_hostSide</span><span class="p">.</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">user2</span><span class="p">);</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">// Start the WebRTC signaling exchange with the new client.</span>
<span class="w">            </span><span class="c1">// Diagnostic tools: chrome://webrtc-internals (in Chrome) and about:webrtc (in Firefox)</span>
<span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">openDataChannel</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="nx">clientName</span><span class="p">);</span><span class="w"> </span><span class="c1">// open as the initiator</span>
<span class="w">               </span><span class="nx">debug</span><span class="p">(</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">rtc</span><span class="p">,</span><span class="s1">&#39;data channel initiated&#39;</span><span class="p">);</span>
<span class="w">               </span><span class="nx">createOffer</span><span class="p">(</span><span class="w"> </span><span class="nx">clientName</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;WebRTC startup: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">e</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">// Someone just connected. Send the host&#39;s layout state to them (actually to everyone, but that</span>
<span class="w">            </span><span class="c1">// should, of course, cover the connecting user also). Delay it a bit...</span>
<span class="w">            </span><span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="c1">// Adjust client chat panel and canvas to match host (normal or small chat).</span>
<span class="w">               </span><span class="nx">resizeClients</span><span class="p">(</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">getChatLayoutState</span><span class="p">());</span>
<span class="w">               </span><span class="c1">// Adjust client canvas to match specific custom dimensions of the host&#39;s canvas.</span>
<span class="w">               </span><span class="nx">eV</span><span class="p">.</span><span class="nx">setClientCanvasToMatchHost</span><span class="p">();</span>
<span class="w">            </span><span class="p">},</span><span class="w"> </span><span class="mf">300</span><span class="p">);</span>
<span class="w">         </span><span class="p">});</span>
<span class="w">         </span>
<span class="w">         </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;client-disconnected&#39;</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">clientName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">msg</span><span class="p">;</span><span class="w">   </span>
<span class="w">            </span><span class="nx">debug</span><span class="p">(</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">rtc</span><span class="p">,</span><span class="s1">&#39;in client-disconnected, clientName=&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">clientName</span><span class="p">);</span>
<span class="w">            </span>
<span class="w">            </span><span class="nx">nullReferences_toRTC_on_cl</span><span class="p">(</span><span class="w"> </span><span class="nx">clientName</span><span class="p">);</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">// Do corresponding cleanup.</span>
<span class="w">            </span><span class="nx">deleteNetworkClient</span><span class="p">(</span><span class="w"> </span><span class="nx">clientName</span><span class="p">);</span>
<span class="w">         </span><span class="p">});</span>
<span class="w">         </span>
<span class="w">         </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;echo-from-Server-to-Host&#39;</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Bounce this back to server.</span>
<span class="w">            </span><span class="c1">// The msg string is the client id.</span>
<span class="w">            </span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;echo-from-Host-to-Server&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">msg</span><span class="p">);</span>
<span class="w">         </span><span class="p">});</span>
<span class="w">         </span>
<span class="w">         </span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;shutDown-p2p-deleteClient&#39;</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">debug</span><span class="p">(</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">rtc</span><span class="p">,</span><span class="s1">&#39;in shutDown-p2p-deleteClient&#39;</span><span class="p">);</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">clientName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">msg</span><span class="p">;</span>
<span class="w">            </span><span class="c1">// First check for the case where the host has reloaded their page and </span>
<span class="w">            </span><span class="c1">// then a client attempts to reconnect. In that case the clients map will be empty and</span>
<span class="w">            </span><span class="c1">// this clientName won&#39;t be found in there.</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="w"> </span><span class="nx">clientName</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="c1">// Check for a puck controlled by this client. Delete it first.</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="w"> </span><span class="nx">clientName</span><span class="p">].</span><span class="nx">puck</span><span class="p">)</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="w"> </span><span class="nx">clientName</span><span class="p">].</span><span class="nx">puck</span><span class="p">.</span><span class="nx">deleteThisOne</span><span class="p">({});</span>
<span class="w">               </span><span class="c1">// Then start shutting down the WebRTC connection.</span>
<span class="w">               </span><span class="nx">deleteRTC_onClientAndHost</span><span class="p">(</span><span class="w"> </span><span class="nx">clientName</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">         </span><span class="p">});</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span><span class="w"> </span><span class="c1">// end of init_socket_listeners</span>
<span class="w">   </span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">forceClientDisconnect</span><span class="p">(</span><span class="w"> </span><span class="nx">clientName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">debug</span><span class="p">(</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">rtc</span><span class="p">,</span><span class="s1">&#39;in forceClientDisconnect&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;clientDisconnectByHost&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">clientName</span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">resizeClients</span><span class="p">(</span><span class="w"> </span><span class="nx">command</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">socket</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;command-from-host-to-all-clients&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="o">:</span><span class="s1">&#39;resize&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;command&#39;</span><span class="o">:</span><span class="nx">command</span><span class="p">}</span><span class="w"> </span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">sendSocketControlMessage</span><span class="p">(</span><span class="w"> </span><span class="nx">message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// This emit is received and distributed at the server in its &#39;control message&#39; handler. Then</span>
<span class="w">      </span><span class="c1">// received and processed at the host or client in their &#39;control message&#39; handler.</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">socket</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;control message&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span>
<span class="w">   </span><span class="c1">////////////////////////////////////////////////</span>
<span class="w">   </span><span class="c1">// Functions supporting the WebRTC connections.</span>
<span class="w">   </span><span class="c1">////////////////////////////////////////////////</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">configuration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;iceServers&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">[{</span><span class="s1">&#39;urls&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;stun:stun1.l.google.com:19302&#39;</span><span class="p">}]</span><span class="w"> </span><span class="p">};</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">openDataChannel</span><span class="p">(</span><span class="w"> </span><span class="nx">isInitiator</span><span class="p">,</span><span class="w"> </span><span class="nx">clientName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// On the client page: cl refers to the one and only object that holds name info and the RTC object for that client.</span>
<span class="w">      </span><span class="c1">// On the   host page: cl refers to the named client, of possibly many client instances on the host, in the clients array.</span>
<span class="w">      </span><span class="c1">// referenceToClient switches cl to make the appropriate reference depending on the page context.</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">cl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">referenceToClient</span><span class="p">(</span><span class="w"> </span><span class="nx">clientName</span><span class="p">);</span>
<span class="w">      </span><span class="nx">cl</span><span class="p">.</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">pc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">RTCPeerConnection</span><span class="p">(</span><span class="w"> </span><span class="nx">configuration</span><span class="p">);</span>
<span class="w">      </span>
<span class="w">      </span><span class="nx">cl</span><span class="p">.</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">pc</span><span class="p">.</span><span class="nx">onicecandidate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">evt</span><span class="p">.</span><span class="nx">candidate</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// send any ice candidates to the other peer</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">signal_message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;from&#39;</span><span class="o">:</span><span class="nx">cl</span><span class="p">.</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">user1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;to&#39;</span><span class="o">:</span><span class="nx">cl</span><span class="p">.</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">user2</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;signalData&#39;</span><span class="o">:</span><span class="nx">evt</span><span class="p">.</span><span class="nx">candidate</span><span class="p">};</span>
<span class="w">            </span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;signaling message&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">signal_message</span><span class="p">);</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">      </span><span class="p">};</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Host-side data channel</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">isInitiator</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">debug</span><span class="p">(</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">rtc</span><span class="p">,</span><span class="s1">&#39;host is setting up datachannel...&#39;</span><span class="p">);</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">dc_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cl</span><span class="p">.</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">user2</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">1</span><span class="p">);</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">dc_options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="o">:</span><span class="nx">dc_id</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;ordered&#39;</span><span class="o">:</span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;maxRetransmits&#39;</span><span class="o">:</span><span class="mf">1</span><span class="p">};</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">dc_label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dc-&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">cl</span><span class="p">.</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">user2</span><span class="p">;</span>
<span class="w">         </span><span class="nx">cl</span><span class="p">.</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">dataChannel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cl</span><span class="p">.</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">pc</span><span class="p">.</span><span class="nx">createDataChannel</span><span class="p">(</span><span class="w"> </span><span class="nx">dc_label</span><span class="p">,</span><span class="w"> </span><span class="nx">dc_options</span><span class="p">);</span>
<span class="w">         </span>
<span class="w">         </span><span class="nx">cl</span><span class="p">.</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">dataChannel</span><span class="p">.</span><span class="nx">onmessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">objFromClient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span><span class="w">   </span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">// Ping to client test...</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">objFromClient</span><span class="p">[</span><span class="s1">&#39;ping&#39;</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">timer</span><span class="p">.</span><span class="nx">stop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">window</span><span class="p">.</span><span class="nx">performance</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
<span class="w">               </span><span class="kd">var</span><span class="w"> </span><span class="nx">elapsed_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">timer</span><span class="p">.</span><span class="nx">stop</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">timer</span><span class="p">.</span><span class="nx">start</span><span class="p">;</span>
<span class="w">               </span><span class="nx">timer</span><span class="p">.</span><span class="nx">pingArray</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="w"> </span><span class="nx">elapsed_time</span><span class="p">);</span>
<span class="w">         </span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">timer</span><span class="p">.</span><span class="nx">pingArray</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">100</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="nx">timer</span><span class="p">.</span><span class="nx">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">window</span><span class="p">.</span><span class="nx">performance</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
<span class="w">                  </span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">user2</span><span class="p">].</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">dataChannel</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;ping&#39;</span><span class="o">:</span><span class="kc">true</span><span class="p">}</span><span class="w"> </span><span class="p">));</span>
<span class="w">               </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="nx">displayMessage</span><span class="p">(</span><span class="w"> </span><span class="nx">echoReport</span><span class="p">(</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">user2</span><span class="p">));</span>
<span class="w">                  </span><span class="nx">timer</span><span class="p">.</span><span class="nx">pingArray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">               </span><span class="p">}</span>
<span class="w">               </span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">handle_RTC_message</span><span class="p">(</span><span class="w"> </span><span class="nx">objFromClient</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">         </span><span class="p">}.</span><span class="nx">bind</span><span class="p">({</span><span class="s1">&#39;user2&#39;</span><span class="o">:</span><span class="nx">cl</span><span class="p">.</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">user2</span><span class="p">});</span><span class="w">  </span><span class="c1">// bind object to &quot;this&quot; so it (this.user2) is available when onmessage runs.</span>
<span class="w">         </span>
<span class="w">         </span><span class="nx">cl</span><span class="p">.</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">dataChannel</span><span class="p">.</span><span class="nx">onopen</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;------ RTC DC(H) OPENED ------&quot;</span><span class="p">);};</span>
<span class="w">         </span><span class="nx">cl</span><span class="p">.</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">dataChannel</span><span class="p">.</span><span class="nx">onclose</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;------ RTC DC(H) closed ------&quot;</span><span class="p">);};</span>
<span class="w">         </span><span class="nx">cl</span><span class="p">.</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">dataChannel</span><span class="p">.</span><span class="nx">onerror</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">error</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s2">&quot;OperationError: Transport channel closed&quot;</span><span class="p">)</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;RTC DC(H) error: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
<span class="w">         </span><span class="p">};</span>
<span class="w">         </span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">cl</span><span class="p">.</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">streamRequested</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">startVideoStream</span><span class="p">(</span><span class="w"> </span><span class="nx">clientName</span><span class="p">);</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Client-side data channel</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">debug</span><span class="p">(</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">rtc</span><span class="p">,</span><span class="s1">&#39;client is setting up datachannel...&#39;</span><span class="p">);</span>

<span class="w">         </span><span class="c1">// This side of the data channel gets established in response to the channel initialization </span>
<span class="w">         </span><span class="c1">// on the host side.</span>
<span class="w">         </span><span class="nx">cl</span><span class="p">.</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">pc</span><span class="p">.</span><span class="nx">ondatachannel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">debug</span><span class="p">(</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">rtc</span><span class="p">,</span><span class="s1">&#39;client response in ondatachannel handler&#39;</span><span class="p">);</span>
<span class="w">            </span><span class="nx">cl</span><span class="p">.</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">dataChannel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">evt</span><span class="p">.</span><span class="nx">channel</span><span class="p">;</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">// Must also set up an onmessage handler for the clients.</span>
<span class="w">            </span><span class="nx">cl</span><span class="p">.</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">dataChannel</span><span class="p">.</span><span class="nx">onmessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">debug</span><span class="p">(</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">rtc</span><span class="p">,</span><span class="s2">&quot;DC (@client) message:&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
<span class="w">               </span><span class="kd">var</span><span class="w"> </span><span class="nx">objFromHost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
<span class="w">               </span>
<span class="w">               </span><span class="c1">// Ping back to the host</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">objFromHost</span><span class="p">[</span><span class="s1">&#39;ping&#39;</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="nx">cl</span><span class="p">.</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">dataChannel</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;ping&#39;</span><span class="o">:</span><span class="kc">true</span><span class="p">}</span><span class="w"> </span><span class="p">));</span>
<span class="w">               </span>
<span class="w">               </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="c1">// The gun-angle info is on a &#39;data&#39; key of the sent object.</span>
<span class="w">                  </span><span class="nx">twoThumbs</span><span class="p">.</span><span class="nx">processGunAngleFromHost</span><span class="p">(</span><span class="w"> </span><span class="nx">objFromHost</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
<span class="w">               </span><span class="p">}</span>
<span class="w">            </span><span class="p">};</span>
<span class="w">            </span>
<span class="w">            </span><span class="nx">cl</span><span class="p">.</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">dataChannel</span><span class="p">.</span><span class="nx">onopen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;------ RTC DC(C) OPENED ------&quot;</span><span class="p">);</span>
<span class="w">               </span><span class="nx">rtc_choke</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">               </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#chkRequestStream&#39;</span><span class="p">).</span><span class="nx">prop</span><span class="p">(</span><span class="s1">&#39;disabled&#39;</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span>
<span class="w">               </span><span class="nx">refresh_P2P_indicator</span><span class="p">({</span><span class="s1">&#39;mode&#39;</span><span class="o">:</span><span class="s1">&#39;p2p&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;context&#39;</span><span class="o">:</span><span class="s1">&#39;dataChannelOpen&#39;</span><span class="p">});</span>
<span class="w">            </span><span class="p">};</span>
<span class="w">            </span><span class="nx">cl</span><span class="p">.</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">dataChannel</span><span class="p">.</span><span class="nx">onclose</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;------ RTC DC(C) closed ------&quot;</span><span class="p">);</span>
<span class="w">               </span><span class="nx">rtc_choke</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">            </span><span class="p">};</span>
<span class="w">            </span><span class="nx">cl</span><span class="p">.</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">dataChannel</span><span class="p">.</span><span class="nx">onerror</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">error</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s2">&quot;OperationError: Transport channel closed&quot;</span><span class="p">)</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;RTC DC(C) error: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
<span class="w">            </span><span class="p">};</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// Respond to a new track by sending the stream to the video element.</span>
<span class="w">         </span><span class="nx">cl</span><span class="p">.</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">pc</span><span class="p">.</span><span class="nx">ontrack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">videoMirror</span><span class="p">.</span><span class="nx">srcObject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">evt</span><span class="p">.</span><span class="nx">streams</span><span class="p">[</span><span class="mf">0</span><span class="p">];</span>
<span class="w">         </span><span class="p">};</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="nx">debug</span><span class="p">(</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">rtc</span><span class="p">,</span><span class="s1">&#39;signaling state at end of openDataChannel = &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">cl</span><span class="p">.</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">pc</span><span class="p">.</span><span class="nx">signalingState</span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="c1">// This function is used (only) by the host when someone connects and wants a stream.</span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">startVideoStream</span><span class="p">(</span><span class="w"> </span><span class="nx">clientName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">cl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">referenceToClient</span><span class="p">(</span><span class="w"> </span><span class="nx">clientName</span><span class="p">);</span>
<span class="w">      </span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">videoStream</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">hostCanvas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;hostCanvas&#39;</span><span class="p">);</span>
<span class="w">         </span><span class="nx">videoStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">hostCanvas</span><span class="p">.</span><span class="nx">captureStream</span><span class="p">();</span><span class="w"> </span><span class="c1">//60</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="nx">cl</span><span class="p">.</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">pc</span><span class="p">.</span><span class="nx">addTrack</span><span class="p">(</span><span class="w"> </span><span class="nx">videoStream</span><span class="p">.</span><span class="nx">getVideoTracks</span><span class="p">()[</span><span class="mf">0</span><span class="p">],</span><span class="w"> </span><span class="nx">videoStream</span><span class="p">);</span>
<span class="w">      </span><span class="c1">// The chkStream is on the host page only (index.html)</span>
<span class="w">      </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;chkStream&quot;</span><span class="p">).</span><span class="nx">checked</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">      </span><span class="nx">videoStream</span><span class="p">.</span><span class="nx">getVideoTracks</span><span class="p">()[</span><span class="mf">0</span><span class="p">].</span><span class="nx">enabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">setCanvasStream</span><span class="p">(</span><span class="w"> </span><span class="nx">newState</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">videoStream</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">newState</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;on&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">videoStream</span><span class="p">.</span><span class="nx">getVideoTracks</span><span class="p">()[</span><span class="mf">0</span><span class="p">].</span><span class="nx">enabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">videoStream</span><span class="p">.</span><span class="nx">getVideoTracks</span><span class="p">()[</span><span class="mf">0</span><span class="p">].</span><span class="nx">enabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">handle_RTC_message</span><span class="p">(</span><span class="w"> </span><span class="nx">mK_data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">//var user2 = Object.assign({}, cl.rtc.user2);</span>
<span class="w">      </span>
<span class="w">      </span><span class="cm">/*</span>
<span class="cm">      var user2 = JSON.stringify(cl.rtc.user2);</span>
<span class="cm">      console.log(&quot;I am (cl.rtc.user2) = &quot; + user2);</span>
<span class="cm">      console.log(&quot;DC ID = &quot; + JSON.stringify(cl.rtc.dataChannel.id));</span>
<span class="cm">      console.log(&quot;DC (@host) message: &quot; + e.data);</span>
<span class="cm">      */</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// On the host, update the mouse-and-keyboard state for the specified client.</span>
<span class="w">      </span><span class="nx">cT</span><span class="p">.</span><span class="nx">updateClientState</span><span class="p">(</span><span class="w"> </span><span class="nx">mK_data</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">mK_data</span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">createOffer</span><span class="p">(</span><span class="w"> </span><span class="nx">clientName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">cl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">referenceToClient</span><span class="p">(</span><span class="w"> </span><span class="nx">clientName</span><span class="p">);</span>
<span class="w">      </span><span class="nx">cl</span><span class="p">.</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">pc</span><span class="p">.</span><span class="nx">createOffer</span><span class="p">()</span>
<span class="w">      </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">offer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="k">return</span><span class="w"> </span><span class="nx">cl</span><span class="p">.</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">pc</span><span class="p">.</span><span class="nx">setLocalDescription</span><span class="p">(</span><span class="w"> </span><span class="nx">offer</span><span class="p">);</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">      </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">signal_message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;from&#39;</span><span class="o">:</span><span class="nx">cl</span><span class="p">.</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">user1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;to&#39;</span><span class="o">:</span><span class="nx">cl</span><span class="p">.</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">user2</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;signalData&#39;</span><span class="o">:</span><span class="nx">cl</span><span class="p">.</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">pc</span><span class="p">.</span><span class="nx">localDescription</span><span class="p">};</span>
<span class="w">         </span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;signaling message&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">signal_message</span><span class="p">);</span>
<span class="w">         </span><span class="nx">debug</span><span class="p">(</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">rtc</span><span class="p">,</span><span class="s1">&#39;signaling state after createOffer = &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">cl</span><span class="p">.</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">pc</span><span class="p">.</span><span class="nx">signalingState</span><span class="p">);</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">      </span><span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">reason</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Error while creating offer:&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">reason</span><span class="p">);</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">handleOffer</span><span class="p">(</span><span class="w"> </span><span class="nx">clientName</span><span class="p">,</span><span class="w"> </span><span class="nx">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">cl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">referenceToClient</span><span class="p">(</span><span class="w"> </span><span class="nx">clientName</span><span class="p">);</span>
<span class="w">      </span>
<span class="w">      </span><span class="nx">cl</span><span class="p">.</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">pc</span><span class="p">.</span><span class="nx">setRemoteDescription</span><span class="p">(</span><span class="w"> </span><span class="nx">msg</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="k">return</span><span class="w"> </span><span class="nx">cl</span><span class="p">.</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">pc</span><span class="p">.</span><span class="nx">createAnswer</span><span class="p">(</span><span class="w"> </span><span class="p">);</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">      </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">answer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="k">return</span><span class="w"> </span><span class="nx">cl</span><span class="p">.</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">pc</span><span class="p">.</span><span class="nx">setLocalDescription</span><span class="p">(</span><span class="w"> </span><span class="nx">answer</span><span class="p">);</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">      </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="c1">// Send the answer (localDescription) to the remote peer</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">signal_message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;from&#39;</span><span class="o">:</span><span class="nx">cl</span><span class="p">.</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">user1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;to&#39;</span><span class="o">:</span><span class="nx">cl</span><span class="p">.</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">user2</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;signalData&#39;</span><span class="o">:</span><span class="nx">cl</span><span class="p">.</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">pc</span><span class="p">.</span><span class="nx">localDescription</span><span class="p">};</span>
<span class="w">         </span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;signaling message&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">signal_message</span><span class="p">);</span>
<span class="w">         </span><span class="nx">debug</span><span class="p">(</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">rtc</span><span class="p">,</span><span class="s1">&#39;signaling state after handleOffer = &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">cl</span><span class="p">.</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">pc</span><span class="p">.</span><span class="nx">signalingState</span><span class="p">);</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">      </span><span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">reason</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Error while handling offer:&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">reason</span><span class="p">);</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">handleAnswer</span><span class="p">(</span><span class="w"> </span><span class="nx">clientName</span><span class="p">,</span><span class="w"> </span><span class="nx">answer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">cl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">referenceToClient</span><span class="p">(</span><span class="w"> </span><span class="nx">clientName</span><span class="p">);</span>
<span class="w">      </span><span class="nx">cl</span><span class="p">.</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">pc</span><span class="p">.</span><span class="nx">setRemoteDescription</span><span class="p">(</span><span class="w"> </span><span class="nx">answer</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">debug</span><span class="p">(</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">rtc</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;signaling state after handleAnswer = &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">cl</span><span class="p">.</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">pc</span><span class="p">.</span><span class="nx">signalingState</span><span class="p">);</span>
<span class="w">      </span><span class="p">})</span>
<span class="w">      </span><span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">reason</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Error while handling answer:&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">reason</span><span class="p">);</span>
<span class="w">      </span><span class="p">});</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">logError</span><span class="p">(</span><span class="w"> </span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="w"> </span><span class="nx">error</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;: &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span><span class="w">   </span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">nullReferences_toRTC_on_cl</span><span class="p">(</span><span class="w"> </span><span class="nx">clientName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">cl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">referenceToClient</span><span class="p">(</span><span class="w"> </span><span class="nx">clientName</span><span class="p">);</span>
<span class="w">      </span><span class="c1">// Check the global &quot;cl&quot; pointer (to the most recently connected client) to see if it happens to</span>
<span class="w">      </span><span class="c1">// be pointed at this client.</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">cl</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">debug</span><span class="p">(</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">rtc</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;in nullReferences_toRTC_on_cl \n  cl.rtc=&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="w"> </span><span class="nx">cl</span><span class="p">.</span><span class="nx">rtc</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;, newClientName=&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">clientName</span><span class="p">);</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">cl</span><span class="p">.</span><span class="nx">rtc</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">cl</span><span class="p">.</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">user2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">clientName</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">cl</span><span class="p">.</span><span class="nx">rtc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">RTC</span><span class="p">({});</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="c1">// client not found in clients array; maybe already removed by a disconnection...</span>
<span class="w">         </span><span class="c1">//debug( db.rtc, &quot;can&#39;t find &quot; + clientName + &quot; in clients&quot;);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">refresh_P2P_indicator</span><span class="p">(</span><span class="w"> </span><span class="nx">pars</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span><span class="w"> </span><span class="nx">pars</span><span class="p">.</span><span class="nx">mode</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;p2p&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span><span class="w"> </span><span class="nx">pars</span><span class="p">.</span><span class="nx">context</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Stop the pacifier (note: pacifier is a global object)</span>
<span class="w">      </span><span class="c1">// clearInterval() method clears a timer set with the setInterval() method</span>
<span class="w">      </span><span class="nx">clearInterval</span><span class="p">(</span><span class="w"> </span><span class="nx">pacifier</span><span class="p">.</span><span class="nx">intFunction</span><span class="p">);</span>
<span class="w">      </span><span class="nx">pacifier</span><span class="p">.</span><span class="nx">string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">      </span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">cl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">referenceToClient</span><span class="p">();</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// If connected, there will be a name (assigned from the server)</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;p2p&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">cl</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="c1">// Show (flood/erase the canvas with) the client&#39;s color.</span>
<span class="w">         </span><span class="nx">connMssg</span><span class="p">.</span><span class="nx">fillColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">clientColor</span><span class="p">(</span><span class="w"> </span><span class="nx">cl</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
<span class="w">         </span>
<span class="w">         </span><span class="nx">connMssg</span><span class="p">.</span><span class="nx">font</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;12px Arial&quot;</span><span class="p">;</span>
<span class="w">         </span><span class="c1">// Use dark letters for the lighter client colors.</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">clientLightColors</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="w"> </span><span class="nx">clientColor</span><span class="p">(</span><span class="w"> </span><span class="nx">cl</span><span class="p">.</span><span class="nx">name</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">connMssg</span><span class="p">.</span><span class="nx">textColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;black&#39;</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">connMssg</span><span class="p">.</span><span class="nx">textColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;white&#39;</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// If the rtc choke is off and there&#39;s a data channel, display the &quot;P2P&quot; text.</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">rtc_choke</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">cl</span><span class="p">.</span><span class="nx">rtc</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">cl</span><span class="p">.</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">dataChannel</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">cl</span><span class="p">.</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">dataChannel</span><span class="p">.</span><span class="nx">readyState</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;open&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">connMssg</span><span class="p">.</span><span class="nx">string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;P2P&#39;</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">connMssg</span><span class="p">.</span><span class="nx">string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;socket.io&#39;</span><span class="p">;</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">         </span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;connecting&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">connMssg</span><span class="p">.</span><span class="nx">fillColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;darkgray&#39;</span><span class="p">;</span>
<span class="w">         </span>
<span class="w">         </span><span class="nx">connMssg</span><span class="p">.</span><span class="nx">font</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;12px Arial&quot;</span><span class="p">;</span>
<span class="w">         </span><span class="nx">connMssg</span><span class="p">.</span><span class="nx">textColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;white&#39;</span><span class="p">;</span>
<span class="w">         </span><span class="nx">connMssg</span><span class="p">.</span><span class="nx">string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;CONNECTING&#39;</span><span class="p">;</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// Start the pacifier</span>
<span class="w">         </span><span class="nx">pacifier</span><span class="p">.</span><span class="nx">string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">         </span><span class="nx">pacifier</span><span class="p">.</span><span class="nx">intFunction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">setInterval</span><span class="p">(</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">            </span><span class="nx">pacifier</span><span class="p">.</span><span class="nx">string</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="s1">&#39;--&#39;</span><span class="p">;</span>
<span class="w">         </span><span class="p">},</span><span class="w"> </span><span class="mf">200</span><span class="p">);</span>
<span class="w">         </span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;reset&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="c1">// Light gray fill.</span>
<span class="w">         </span><span class="nx">connMssg</span><span class="p">.</span><span class="nx">fillColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;#EFEFEF&#39;</span><span class="p">;</span>
<span class="w">         </span><span class="nx">connMssg</span><span class="p">.</span><span class="nx">string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="w">         </span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;sync&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">connMssg</span><span class="p">.</span><span class="nx">fillColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;black&#39;</span><span class="p">;</span>
<span class="w">         </span>
<span class="w">         </span><span class="nx">connMssg</span><span class="p">.</span><span class="nx">font</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;12px Arial&quot;</span><span class="p">;</span>
<span class="w">         </span><span class="nx">connMssg</span><span class="p">.</span><span class="nx">textColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;white&#39;</span><span class="p">;</span>
<span class="w">         </span><span class="nx">connMssg</span><span class="p">.</span><span class="nx">string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;SYNC&#39;</span><span class="p">;</span>
<span class="w">         </span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;disconnected&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">connMssg</span><span class="p">.</span><span class="nx">fillColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;darkgray&#39;</span><span class="p">;</span>
<span class="w">         </span>
<span class="w">         </span><span class="nx">connMssg</span><span class="p">.</span><span class="nx">font</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;12px Arial&quot;</span><span class="p">;</span>
<span class="w">         </span><span class="nx">connMssg</span><span class="p">.</span><span class="nx">textColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;white&#39;</span><span class="p">;</span>
<span class="w">         </span><span class="nx">connMssg</span><span class="p">.</span><span class="nx">string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;DISCONNECTED&#39;</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">draw_connectionIndicators</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Note the use of improveCanvasResolution (see demoStart.js) in making the text crisp.</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// First, clear it.</span>
<span class="w">      </span><span class="nx">ctx</span><span class="p">.</span><span class="nx">fillStyle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">connMssg</span><span class="p">.</span><span class="nx">fillColor</span><span class="p">;</span>
<span class="w">      </span><span class="nx">ctx</span><span class="p">.</span><span class="nx">fillRect</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">clientCanvas</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span><span class="w"> </span><span class="nx">clientCanvas</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// The sync bar, toggled with ctrl-a on the host.</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">connMssg</span><span class="p">.</span><span class="nx">string</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;SYNC&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">dF</span><span class="p">.</span><span class="nx">drawLine</span><span class="p">(</span><span class="w"> </span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mf">55</span><span class="p">,</span><span class="mf">8</span><span class="p">),</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">wS</span><span class="p">.</span><span class="nx">Vec2D</span><span class="p">(</span><span class="mf">85</span><span class="p">,</span><span class="mf">8</span><span class="p">),</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;width_px&#39;</span><span class="o">:</span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;color&#39;</span><span class="o">:</span><span class="s1">&#39;white&#39;</span><span class="p">}</span><span class="w"> </span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Then write out the message text.</span>
<span class="w">      </span><span class="nx">ctx</span><span class="p">.</span><span class="nx">font</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">connMssg</span><span class="p">.</span><span class="nx">font</span><span class="p">;</span>
<span class="w">      </span><span class="nx">ctx</span><span class="p">.</span><span class="nx">fillStyle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">connMssg</span><span class="p">.</span><span class="nx">textColor</span><span class="p">;</span>
<span class="w">      </span><span class="nx">ctx</span><span class="p">.</span><span class="nx">fillText</span><span class="p">(</span><span class="w"> </span><span class="nx">connMssg</span><span class="p">.</span><span class="nx">string</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="mf">12</span><span class="p">);</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Add the ---- of the pacifier.</span>
<span class="w">      </span><span class="nx">ctx</span><span class="p">.</span><span class="nx">fillText</span><span class="p">(</span><span class="w"> </span><span class="nx">pacifier</span><span class="p">.</span><span class="nx">string</span><span class="p">,</span><span class="w"> </span><span class="mf">95</span><span class="p">,</span><span class="w"> </span><span class="mf">12</span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span><span class="w">   </span>
<span class="w">      </span>
<span class="w">   </span><span class="c1">////////////////////////////////////////////////////////////////////////////////</span>
<span class="w">   </span><span class="c1">// Functions supporting animation for the connection canvas</span>
<span class="w">   </span><span class="c1">////////////////////////////////////////////////////////////////////////////////</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">canvasLoop</span><span class="p">(</span><span class="w"> </span><span class="nx">timeStamp_ms</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">updateCanvas</span><span class="p">();</span>
<span class="w">      </span><span class="nx">m_myRequest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">window</span><span class="p">.</span><span class="nx">requestAnimationFrame</span><span class="p">(</span><span class="w"> </span><span class="nx">canvasLoop</span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">updateCanvas</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">     </span>
<span class="w">      </span><span class="nx">draw_connectionIndicators</span><span class="p">();</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">startAnimation</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Only start an animation loop if there is no loop running.</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">m_myRequest</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="c1">// Start the canvas loop.</span>
<span class="w">         </span><span class="nx">m_myRequest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">window</span><span class="p">.</span><span class="nx">requestAnimationFrame</span><span class="p">(</span><span class="w"> </span><span class="nx">canvasLoop</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">stopAnimation</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nb">window</span><span class="p">.</span><span class="nx">cancelAnimationFrame</span><span class="p">(</span><span class="w"> </span><span class="nx">m_myRequest</span><span class="p">);</span>
<span class="w">      </span><span class="nx">m_myRequest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="c1">////////////////////////////////////////////////////////////////////////////////</span>
<span class="w">   </span><span class="c1">// functions for adding and/or removing a network client</span>
<span class="w">   </span><span class="c1">////////////////////////////////////////////////////////////////////////////////</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">createNetworkClient</span><span class="p">(</span><span class="w"> </span><span class="nx">pars</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">clientName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span><span class="w"> </span><span class="nx">pars</span><span class="p">.</span><span class="nx">clientName</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;theInvisibleMan&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="c1">// &quot;player&quot; is true/false to indicate if the client is requesting that a player puck be </span>
<span class="w">      </span><span class="c1">// added to the client instance.</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span><span class="w"> </span><span class="nx">pars</span><span class="p">.</span><span class="nx">player</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">nickName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span><span class="w"> </span><span class="nx">pars</span><span class="p">.</span><span class="nx">nickName</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">teamName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">uT</span><span class="p">.</span><span class="nx">setDefault</span><span class="p">(</span><span class="w"> </span><span class="nx">pars</span><span class="p">.</span><span class="nx">teamName</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>
<span class="w">      </span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">clientName</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">1</span><span class="p">);</span>
<span class="w">      </span><span class="c1">// Repeat the color index every 10 users (10 colors in clientColors)</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">colorIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">trunc</span><span class="p">(</span><span class="nx">n</span><span class="o">/</span><span class="mf">10</span><span class="p">)</span><span class="o">*</span><span class="mf">10</span><span class="p">;</span>
<span class="w">      </span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">clientPars</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">      </span><span class="nx">clientPars</span><span class="p">.</span><span class="nx">player</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">player</span><span class="p">;</span>
<span class="w">      </span><span class="nx">clientPars</span><span class="p">.</span><span class="nx">nickName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">nickName</span><span class="p">;</span>
<span class="w">      </span><span class="nx">clientPars</span><span class="p">.</span><span class="nx">teamName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">teamName</span><span class="p">;</span>
<span class="w">      </span><span class="nx">clientPars</span><span class="p">.</span><span class="nx">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">clientColors</span><span class="p">[</span><span class="w"> </span><span class="nx">colorIndex</span><span class="p">];</span>
<span class="w">      </span><span class="nx">clientPars</span><span class="p">.</span><span class="nx">nameFromServer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">clientName</span><span class="p">;</span>
<span class="w">      </span><span class="nx">clientPars</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">clientName</span><span class="p">;</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// if client is joining a ghost-ball pool game that&#39;s underway, initialize these.</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">getDemoVersion</span><span class="p">().</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">3</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;3.d&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">clientPars</span><span class="p">.</span><span class="nx">ctrlShiftLock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">         </span><span class="nx">clientPars</span><span class="p">.</span><span class="nx">poolShotLocked</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">         </span><span class="nx">clientPars</span><span class="p">.</span><span class="nx">poolShotLockedSpeed_mps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">20</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="ow">new</span><span class="w"> </span><span class="nx">cT</span><span class="p">.</span><span class="nx">Client</span><span class="p">(</span><span class="w"> </span><span class="nx">clientPars</span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">deleteNetworkClient</span><span class="p">(</span><span class="w"> </span><span class="nx">clientName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// This function does not directly remove the client socket at the node server, but</span>
<span class="w">      </span><span class="c1">// that does happen at the server...</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">db</span><span class="p">.</span><span class="nx">rtc</span><span class="p">)</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;in deleteNetworkClient, clientName=&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">clientName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;, fileName=&quot;</span><span class="o">+</span><span class="nx">fileName</span><span class="p">);</span>
<span class="w">      </span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="nx">clientName</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="c1">// If it&#39;s driving a puck. First, delete that.</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="nx">clientName</span><span class="p">].</span><span class="nx">puck</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">thePuck</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="nx">clientName</span><span class="p">].</span><span class="nx">puck</span>
<span class="w">            </span>
<span class="w">            </span><span class="c1">// Remove this puck and do associated clean-up.</span>
<span class="w">            </span><span class="nx">thePuck</span><span class="p">.</span><span class="nx">jet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">            </span><span class="nx">thePuck</span><span class="p">.</span><span class="nx">gun</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">            </span><span class="nx">thePuck</span><span class="p">.</span><span class="nx">shield</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">            </span><span class="nx">gW</span><span class="p">.</span><span class="nx">tableMap</span><span class="p">.</span><span class="ow">delete</span><span class="p">(</span><span class="w"> </span><span class="nx">thePuck</span><span class="p">.</span><span class="nx">b2d</span><span class="p">);</span>
<span class="w">            </span><span class="nx">gW</span><span class="p">.</span><span class="nx">b2d</span><span class="p">.</span><span class="nx">world</span><span class="p">.</span><span class="nx">DestroyBody</span><span class="p">(</span><span class="w"> </span><span class="nx">thePuck</span><span class="p">.</span><span class="nx">b2d</span><span class="p">);</span>
<span class="w">            </span><span class="ow">delete</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">aT</span><span class="p">.</span><span class="nx">puckMap</span><span class="p">[</span><span class="w"> </span><span class="nx">thePuck</span><span class="p">.</span><span class="nx">name</span><span class="p">];</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">         </span><span class="nx">deleteRTC_onHost</span><span class="p">(</span><span class="w"> </span><span class="nx">clientName</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">deleteRTC_onHost</span><span class="p">(</span><span class="w"> </span><span class="nx">clientName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">db</span><span class="p">.</span><span class="nx">rtc</span><span class="p">)</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;in deleteRTC_onHost&#39;</span><span class="p">);</span>
<span class="w">   </span>
<span class="w">      </span><span class="c1">// Shutdown and nullify any references to the host side of this WebRTC p2p connection.</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="nx">clientName</span><span class="p">].</span><span class="nx">rtc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="w"> </span><span class="nx">clientName</span><span class="p">].</span><span class="nx">rtc</span><span class="p">.</span><span class="nx">shutdown</span><span class="p">();</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Remove the client in the clients map.</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="nx">clientName</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="ow">delete</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="w"> </span><span class="nx">clientName</span><span class="p">];</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">deleteRTC_onClientAndHost</span><span class="p">(</span><span class="w"> </span><span class="nx">clientName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">db</span><span class="p">.</span><span class="nx">rtc</span><span class="p">)</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;in deleteRTC_onClientAndHost&#39;</span><span class="p">);</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Remove network clients on the node server.</span>
<span class="w">      </span><span class="c1">// (Note: this is one of the several places where hC is used inside of gW.)</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">clientName</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;u&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="c1">// Send message to the server and then to the client to disconnect.</span>
<span class="w">         </span><span class="nx">forceClientDisconnect</span><span class="p">(</span><span class="w"> </span><span class="nx">clientName</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Remove the client in the clients map.</span>
<span class="w">      </span><span class="nx">deleteRTC_onHost</span><span class="p">(</span><span class="w"> </span><span class="nx">clientName</span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span>
<span class="w">   </span><span class="c1">////////////////////////////////////////////////////////////////////////////////</span>
<span class="w">   </span><span class="c1">// Misc functions</span>
<span class="w">   </span><span class="c1">////////////////////////////////////////////////////////////////////////////////</span>
<span class="w">   </span>
<span class="w">   </span><span class="cm">/*</span>
<span class="cm">   It&#39;s important, as multiple players connect, to use referenceToClient, </span>
<span class="cm">   especially in the context of the host&#39;s page, to set references within </span>
<span class="cm">   the local scope of the functions and callbacks used below. Global scope, </span>
<span class="cm">   on the host page, could result in references changing, as a new player </span>
<span class="cm">   connects, before the ongoing asynchronous connection process completes. </span>

<span class="cm">   When referenceToClient is called without a parameter, it returns a </span>
<span class="cm">   reference to either gW.clients[&#39;local&#39;] (on the host&#39;s page) or </span>
<span class="cm">   cl_clientSide (on the client page). If a client name is provided (and on </span>
<span class="cm">   the host page) this points at the particular client in the clients </span>
<span class="cm">   array.</span>
<span class="cm">   */</span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">referenceToClient</span><span class="p">(</span><span class="w"> </span><span class="nx">clientName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;local&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hostOrClient</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;client&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="c1">// a reference to the one and only client-similar object on the client page</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">clientRef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cl_clientSide</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">hostOrClient</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;host&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="c1">// a reference to one of the clients on the host page</span>
<span class="w">         </span><span class="kd">var</span><span class="w"> </span><span class="nx">clientRef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">gW</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="w"> </span><span class="nx">clientName</span><span class="p">];</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">clientRef</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">init_nonHostClients</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Get the URL query string. Discard everything after the &quot;&amp;&quot;.</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">queryStringInURL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">search</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;&amp;&quot;</span><span class="p">)[</span><span class="mf">0</span><span class="p">];</span>
<span class="w">      </span><span class="c1">// Take everything after the ? and set a module (hC) level global, clientDeviceType, that will</span>
<span class="w">      </span><span class="c1">// be used in restricting features for a simplified mobile version of the client page.</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">queryStringValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">queryStringInURL</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">1</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">queryStringValue</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;m&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">clientDeviceType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;mobile&quot;</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">clientDeviceType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;desktop&quot;</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">clientDeviceType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;mobile&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">dS</span><span class="p">.</span><span class="nx">adjustSizeOfChatDiv</span><span class="p">(</span><span class="s1">&#39;mobile&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nx">dS</span><span class="p">.</span><span class="nx">adjustSizeOfChatDiv</span><span class="p">(</span><span class="s1">&#39;normal&#39;</span><span class="p">);</span><span class="w">          </span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="nx">clientCanvas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;connectionCanvas&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="nx">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">clientCanvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s1">&#39;2d&#39;</span><span class="p">);</span>
<span class="w">            </span>
<span class="w">      </span><span class="nx">clientCanvas_tt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;twoThumbsCanvas&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="nx">ctx_tt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">clientCanvas_tt</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s1">&#39;2d&#39;</span><span class="p">);</span>

<span class="w">      </span><span class="nx">videoMirror</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;videoMirror&#39;</span><span class="p">);</span>
<span class="w">      </span>
<span class="w">      </span><span class="nx">eVN</span><span class="p">.</span><span class="nx">initializeModule</span><span class="p">(</span><span class="w"> </span><span class="nx">clientCanvas_tt</span><span class="p">,</span><span class="w"> </span><span class="nx">ctx_tt</span><span class="p">,</span><span class="w"> </span><span class="nx">videoMirror</span><span class="p">,</span><span class="w"> </span><span class="nx">mK</span><span class="p">,</span><span class="w"> </span><span class="nx">cl_clientSide</span><span class="p">,</span><span class="w"> </span><span class="nx">dC</span><span class="p">);</span><span class="w"> </span><span class="c1">// mK is initialized to {} above</span>
<span class="w">      </span><span class="nx">init_chatFeatures</span><span class="p">();</span>
<span class="w">      </span><span class="nx">twoThumbs</span><span class="p">.</span><span class="nx">initializeModule</span><span class="p">(</span><span class="w"> </span><span class="nx">clientCanvas_tt</span><span class="p">,</span><span class="w"> </span><span class="nx">ctx_tt</span><span class="p">,</span><span class="w"> </span><span class="nx">videoMirror</span><span class="p">,</span><span class="w"> </span><span class="nx">mK</span><span class="p">,</span><span class="w"> </span><span class="nx">cl_clientSide</span><span class="p">);</span>
<span class="w">      </span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">clientDeviceType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;mobile&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="c1">// Resize (reduce) the button</span>
<span class="w">         </span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#twoThumbsButton&quot;</span><span class="p">).</span><span class="nx">css</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;28px&quot;</span><span class="p">);</span>
<span class="w">         </span><span class="c1">// Move it</span>
<span class="w">         </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#divForTwoThumbsMobile&#39;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="w"> </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#twoThumbsButton&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// Hide the video streaming element.</span>
<span class="w">         </span><span class="nx">videoMirror</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s2">&quot;hidden&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>
<span class="w">         </span>
<span class="w">         </span><span class="c1">// Hide controls</span>
<span class="w">         </span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#nodeServerDiv&quot;</span><span class="p">).</span><span class="nx">hide</span><span class="p">();</span><span class="w">  </span>
<span class="w">         </span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#playerAndCursor&quot;</span><span class="p">).</span><span class="nx">hide</span><span class="p">();</span><span class="w">  </span>
<span class="w">         </span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#streamAndFullscreen&quot;</span><span class="p">).</span><span class="nx">hide</span><span class="p">();</span><span class="w">  </span>
<span class="w">         </span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#twoThumbsButtonDiv&quot;</span><span class="p">).</span><span class="nx">hide</span><span class="p">();</span><span class="w">       </span>

<span class="w">         </span><span class="c1">// page title</span>
<span class="w">         </span><span class="nb">document</span><span class="p">.</span><span class="nx">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;S&amp;P mini-client&quot;</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// Hide the div that covers the mess (while elements are moving)</span>
<span class="w">      </span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#blankWhiteDiv&quot;</span><span class="p">).</span><span class="nx">hide</span><span class="p">();</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">debug</span><span class="p">(</span><span class="w"> </span><span class="nx">flag</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">flag</span><span class="p">)</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="w"> </span><span class="nx">message</span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">echoTest</span><span class="p">(</span><span class="w"> </span><span class="nx">hostOrServer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">      </span>
<span class="w">      </span><span class="c1">// Start the timer for one echo.</span>
<span class="w">      </span><span class="nx">timer</span><span class="p">.</span><span class="nx">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">window</span><span class="p">.</span><span class="nx">performance</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">// The echo series STARTs here.</span>
<span class="w">      </span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;echo-from-Client-to-Server&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">hostOrServer</span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="kd">function</span><span class="w"> </span><span class="nx">echoReport</span><span class="p">(</span><span class="w"> </span><span class="nx">echoTarget</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Note the lowercase m on math.mean for example. These methods are from the mathjs library. See script load on index.html and client.html.</span>
<span class="w">      </span><span class="c1">// These are not part of the native Math (upper case M) methods.</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">timeAvg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">math</span><span class="p">.</span><span class="nx">mean</span><span class="p">(</span><span class="w"> </span><span class="nx">timer</span><span class="p">.</span><span class="nx">pingArray</span><span class="p">).</span><span class="nx">toFixed</span><span class="p">(</span><span class="mf">1</span><span class="p">);</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">timeSTD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">math</span><span class="p">.</span><span class="nx">std</span><span class="p">(</span><span class="w"> </span><span class="nx">timer</span><span class="p">.</span><span class="nx">pingArray</span><span class="p">).</span><span class="nx">toFixed</span><span class="p">(</span><span class="mf">1</span><span class="p">);</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">timeLen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">timer</span><span class="p">.</span><span class="nx">pingArray</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">timeMax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="w"> </span><span class="nx">timer</span><span class="p">.</span><span class="nx">pingArray</span><span class="p">).</span><span class="nx">toFixed</span><span class="p">(</span><span class="mf">1</span><span class="p">);</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">timeMin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="w"> </span><span class="nx">timer</span><span class="p">.</span><span class="nx">pingArray</span><span class="p">).</span><span class="nx">toFixed</span><span class="p">(</span><span class="mf">1</span><span class="p">);</span>
<span class="w">      </span><span class="kd">var</span><span class="w"> </span><span class="nx">reportString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Echo test to &#39;</span><span class="o">+</span><span class="w"> </span><span class="nx">echoTarget</span><span class="w"> </span><span class="o">+</span><span class="s1">&#39;: &#39;</span><span class="o">+</span><span class="w"> </span><span class="nx">timeAvg</span><span class="w"> </span><span class="o">+</span><span class="s1">&#39; ms &#39;</span><span class="o">+</span>
<span class="w">          </span><span class="s1">&#39;(std=&#39;</span><span class="o">+</span><span class="w">  </span><span class="nx">timeSTD</span><span class="w"> </span><span class="o">+</span>
<span class="w">          </span><span class="s1">&#39;, min=&#39;</span><span class="o">+</span><span class="w"> </span><span class="nx">timeMin</span><span class="w"> </span><span class="o">+</span>
<span class="w">          </span><span class="s1">&#39;, max=&#39;</span><span class="o">+</span><span class="w"> </span><span class="nx">timeMax</span><span class="w"> </span><span class="o">+</span>
<span class="w">          </span><span class="s1">&#39;, n=&#39;</span><span class="o">+</span><span class="w">   </span><span class="nx">timeLen</span><span class="w"> </span><span class="o">+</span><span class="s1">&#39;)&#39;</span><span class="p">;</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">reportString</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span>

<span class="w">   </span><span class="c1">// Reveal public references ///////////////</span>

<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Objects</span>
<span class="w">      </span><span class="s1">&#39;RTC&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">RTC</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;gb&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">gb</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;dC&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">dC</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;clientLightColors&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">clientLightColors</span><span class="p">,</span>

<span class="w">      </span><span class="c1">// Variables</span>
<span class="w">      </span><span class="s1">&#39;getClientDeviceType&#39;</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">clientDeviceType</span><span class="p">;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="s1">&#39;get_hostOrClient&#39;</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">hostOrClient</span><span class="p">;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="s1">&#39;get_demoRunningOnHost&#39;</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">demoRunningOnHost</span><span class="p">;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span>
<span class="w">      </span><span class="s1">&#39;get_rtc_choke&#39;</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">rtc_choke</span><span class="p">;</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="s1">&#39;set_rtc_choke&#39;</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="w"> </span><span class="nx">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">rtc_choke</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">val</span><span class="p">;</span><span class="w"> </span><span class="p">},</span>
<span class="w">            </span>
<span class="w">      </span><span class="c1">// Methods</span>
<span class="w">      </span><span class="c1">//nodeServerURL: nodeServerURL,</span>
<span class="w">      </span><span class="s1">&#39;forceClientDisconnect&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">forceClientDisconnect</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;resizeClients&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">resizeClients</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;sendSocketControlMessage&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">sendSocketControlMessage</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;init_chatFeatures&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">init_chatFeatures</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;init_nonHostClients&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">init_nonHostClients</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;connect_and_listen&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">connect_and_listen</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;refresh_P2P_indicator&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">refresh_P2P_indicator</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;setCanvasStream&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">setCanvasStream</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;chatToNonHostPlayers&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">chatToNonHostPlayers</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;displayMessage&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">displayMessage</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;checkForNickName&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">checkForNickName</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;clearInputDefault&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">clearInputDefault</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;restoreInputDefault&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">restoreInputDefault</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;clientColor&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">clientColor</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;referenceToClient&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">referenceToClient</span><span class="p">,</span>
<span class="w">      </span>
<span class="w">      </span><span class="s1">&#39;get_socket&#39;</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">socket</span><span class="p">;</span><span class="w"> </span><span class="p">},</span><span class="w">      </span>
<span class="w">   </span><span class="p">};</span>
<span class="w">   </span>
<span class="p">})();</span>
</pre></div>
</body>
</html>
