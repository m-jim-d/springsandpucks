<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">
<!--
generated by Pygments <https://pygments.org/>
Copyright 2006-2024 by the Pygments team.
Licensed under the BSD license, see LICENSE for details.
-->
<html>
<head>
  <link rel='canonical' href='https://triquence.org/code.js.html' />
  <title>code.js</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <style type="text/css">
/*
generated by Pygments <https://pygments.org/>
Copyright 2006-2024 by the Pygments team.
Licensed under the BSD license, see LICENSE for details.
*/
pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
body .hll { background-color: #ffffcc }
body { background: #f8f8f8; }
body .c { color: #3D7B7B; font-style: italic } /* Comment */
body .err { border: 1px solid #FF0000 } /* Error */
body .k { color: #008000; font-weight: bold } /* Keyword */
body .o { color: #666666 } /* Operator */
body .ch { color: #3D7B7B; font-style: italic } /* Comment.Hashbang */
body .cm { color: #3D7B7B; font-style: italic } /* Comment.Multiline */
body .cp { color: #9C6500 } /* Comment.Preproc */
body .cpf { color: #3D7B7B; font-style: italic } /* Comment.PreprocFile */
body .c1 { color: #3D7B7B; font-style: italic } /* Comment.Single */
body .cs { color: #3D7B7B; font-style: italic } /* Comment.Special */
body .gd { color: #A00000 } /* Generic.Deleted */
body .ge { font-style: italic } /* Generic.Emph */
body .ges { font-weight: bold; font-style: italic } /* Generic.EmphStrong */
body .gr { color: #E40000 } /* Generic.Error */
body .gh { color: #000080; font-weight: bold } /* Generic.Heading */
body .gi { color: #008400 } /* Generic.Inserted */
body .go { color: #717171 } /* Generic.Output */
body .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
body .gs { font-weight: bold } /* Generic.Strong */
body .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
body .gt { color: #0044DD } /* Generic.Traceback */
body .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
body .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
body .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
body .kp { color: #008000 } /* Keyword.Pseudo */
body .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
body .kt { color: #B00040 } /* Keyword.Type */
body .m { color: #666666 } /* Literal.Number */
body .s { color: #BA2121 } /* Literal.String */
body .na { color: #687822 } /* Name.Attribute */
body .nb { color: #008000 } /* Name.Builtin */
body .nc { color: #0000FF; font-weight: bold } /* Name.Class */
body .no { color: #880000 } /* Name.Constant */
body .nd { color: #AA22FF } /* Name.Decorator */
body .ni { color: #717171; font-weight: bold } /* Name.Entity */
body .ne { color: #CB3F38; font-weight: bold } /* Name.Exception */
body .nf { color: #0000FF } /* Name.Function */
body .nl { color: #767600 } /* Name.Label */
body .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
body .nt { color: #008000; font-weight: bold } /* Name.Tag */
body .nv { color: #19177C } /* Name.Variable */
body .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
body .w { color: #bbbbbb } /* Text.Whitespace */
body .mb { color: #666666 } /* Literal.Number.Bin */
body .mf { color: #666666 } /* Literal.Number.Float */
body .mh { color: #666666 } /* Literal.Number.Hex */
body .mi { color: #666666 } /* Literal.Number.Integer */
body .mo { color: #666666 } /* Literal.Number.Oct */
body .sa { color: #BA2121 } /* Literal.String.Affix */
body .sb { color: #BA2121 } /* Literal.String.Backtick */
body .sc { color: #BA2121 } /* Literal.String.Char */
body .dl { color: #BA2121 } /* Literal.String.Delimiter */
body .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
body .s2 { color: #BA2121 } /* Literal.String.Double */
body .se { color: #AA5D1F; font-weight: bold } /* Literal.String.Escape */
body .sh { color: #BA2121 } /* Literal.String.Heredoc */
body .si { color: #A45A77; font-weight: bold } /* Literal.String.Interpol */
body .sx { color: #008000 } /* Literal.String.Other */
body .sr { color: #A45A77 } /* Literal.String.Regex */
body .s1 { color: #BA2121 } /* Literal.String.Single */
body .ss { color: #19177C } /* Literal.String.Symbol */
body .bp { color: #008000 } /* Name.Builtin.Pseudo */
body .fm { color: #0000FF } /* Name.Function.Magic */
body .vc { color: #19177C } /* Name.Variable.Class */
body .vg { color: #19177C } /* Name.Variable.Global */
body .vi { color: #19177C } /* Name.Variable.Instance */
body .vm { color: #19177C } /* Name.Variable.Magic */
body .il { color: #666666 } /* Literal.Number.Integer.Long */

  </style>
</head>
<body>
<h2></h2>

<div class="highlight"><pre><span></span><span class="c1">// Adaptation by James D. Miller (8:02 PM Sat December 1, 2018)</span>
<span class="c1">//    original code:</span>
<span class="c1">//    https://blog.elblearning.com/blog/how-to-create-a-leaderboard-elearning-google</span>
<span class="c1">//    Archived link (of the original page):</span>
<span class="c1">//    https://web.archive.org/web/20201108130226/https://elearningbrothers.com/blog/how-to-create-a-leaderboard-elearning-google/</span>

<span class="c1">// m_ indicate global scope (m for module)</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">m_doc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">SpreadsheetApp</span><span class="p">.</span><span class="nx">getActiveSpreadsheet</span><span class="p">();</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">m_sheet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">m_doc</span><span class="p">.</span><span class="nx">getSheetByName</span><span class="p">(</span><span class="s1">&#39;games&#39;</span><span class="p">);</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">m_nColumns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">14</span><span class="p">;</span><span class="w"> </span><span class="c1">// number of columns in the games sheet</span>

<span class="cm">/*</span>
<span class="cm">Refer to the client-side code for composing an HTTP Get request (e.g. submitScoresThenReport).</span>
<span class="cm">The &quot;Deployment ID&quot; in the URL is found via the &quot;Tools/Script editor/Select a project...&quot; interface for the spreadsheet. </span>
<span class="cm">Pick &quot;Manage deployments&quot; from the &quot;Deploy&quot; select element, upper right.</span>
<span class="cm">The &quot;Deployment ID&quot; does not give general access to your account. It only allows the web user to submit parameters</span>
<span class="cm">to the doGet function below.</span>

<span class="cm">To deploy an update to this script (without changing the URL for the app) do the following:</span>
<span class="cm">  save it (ctrl-s) / Deploy / Manage deployments / click the edit icon / select new version / click Deploy in the pop-up</span>
<span class="cm">*/</span>

<span class="c1">// Handle HTTP GET request:</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">doGet</span><span class="p">(</span><span class="w"> </span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">addGameResult</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">parameter</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">],</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">parameter</span><span class="p">[</span><span class="s1">&#39;userName&#39;</span><span class="p">],</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">parameter</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">],</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">parameter</span><span class="p">[</span><span class="s1">&#39;gameVersion&#39;</span><span class="p">],</span><span class="w"> </span>
<span class="w">                         </span><span class="nx">e</span><span class="p">.</span><span class="nx">parameter</span><span class="p">[</span><span class="s1">&#39;winTime&#39;</span><span class="p">],</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">parameter</span><span class="p">[</span><span class="s1">&#39;mouse&#39;</span><span class="p">],</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">parameter</span><span class="p">[</span><span class="s1">&#39;npcSleep&#39;</span><span class="p">],</span><span class="w"> </span>
<span class="w">                         </span><span class="nx">e</span><span class="p">.</span><span class="nx">parameter</span><span class="p">[</span><span class="s1">&#39;nPeople&#39;</span><span class="p">],</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">parameter</span><span class="p">[</span><span class="s1">&#39;nDrones&#39;</span><span class="p">],</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">parameter</span><span class="p">[</span><span class="s1">&#39;frMonitor&#39;</span><span class="p">],</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">parameter</span><span class="p">[</span><span class="s1">&#39;hzPhysics&#39;</span><span class="p">],</span><span class="w"> </span>
<span class="w">                         </span><span class="nx">e</span><span class="p">.</span><span class="nx">parameter</span><span class="p">[</span><span class="s1">&#39;virtualGamePad&#39;</span><span class="p">],</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">parameter</span><span class="p">[</span><span class="s1">&#39;noFriendlyFire&#39;</span><span class="p">],</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">parameter</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">],</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// This test function doesn&#39;t require publishing and/or calling from a web page. It presents</span>
<span class="c1">// the results returned from addGameResult (called with debug parameter set to true).</span>
<span class="c1">// Use the menu (run/debug) if you want to run this with break points.</span>
<span class="c1">// Use control-enter to see the log output (from manual runs, not from web requests).</span>
<span class="c1">// You might have to comment out the locking stuff during debugging. Generally not.</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">testDoGet</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Call with debug parameter set to true.</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">summaryFromAdd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">addGameResult</span><span class="p">(</span><span class="s1">&#39;report&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;PeteBoy&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">29600</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;7.a&#39;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                        </span><span class="mf">5.1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                        </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="mf">60</span><span class="p">,</span><span class="w"> </span><span class="mf">60</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                        </span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">12345</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// First, just output everything...</span>
<span class="w">    </span><span class="nx">Logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Full Result(ver 8)=&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">summaryFromAdd</span><span class="p">));</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">summaryFromAdd</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">summaryFromAdd</span><span class="p">.</span><span class="nx">result</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;report&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">Logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;userName=&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">summaryFromAdd</span><span class="p">.</span><span class="nx">userName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">                       </span><span class="s1">&#39;, score=&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">summaryFromAdd</span><span class="p">.</span><span class="nx">userScore</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39; (&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">summaryFromAdd</span><span class="p">.</span><span class="nx">userRank</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;/&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">summaryFromAdd</span><span class="p">.</span><span class="nx">scoreCount</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;)&#39;</span><span class="w"> </span><span class="p">);</span><span class="w">    </span>
<span class="w">            </span><span class="c1">// Line by line user data...</span>
<span class="w">            </span><span class="nx">Logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;=======Best Results===================&#39;</span><span class="p">);</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">summaryFromAdd</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">len</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">var</span><span class="w"> </span><span class="nx">userData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">summaryFromAdd</span><span class="p">.</span><span class="nx">users</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
<span class="w">                </span><span class="nx">Logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="w"> </span><span class="nx">userData</span><span class="p">));</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="nx">Logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;=================================&#39;</span><span class="p">);</span>
<span class="w">        </span>
<span class="w">            </span><span class="c1">// This next one will prompt you, must respond or it will keep waiting.</span>
<span class="w">            </span><span class="c1">// Browser.msgBox(&#39;userName=&#39; + summaryFromAdd.userName);</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">test1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">summaryFromAdd</span><span class="p">.</span><span class="nx">userName</span><span class="p">;</span>
<span class="w">            </span><span class="c1">// Can use the following dummy line as a break point (click by the number).</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">stop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>

<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">Logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;result=&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">summaryFromAdd</span><span class="p">.</span><span class="nx">result</span><span class="p">);</span>
<span class="w">            </span><span class="nx">Logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;error=&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">summaryFromAdd</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Add the new submission (make a new row) and return the list of the best submissions.</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">addGameResult</span><span class="p">(</span><span class="w"> </span><span class="nx">mode</span><span class="p">,</span><span class="w"> </span><span class="nx">userName</span><span class="p">,</span><span class="w"> </span><span class="nx">score</span><span class="p">,</span><span class="w"> </span><span class="nx">gameVersion</span><span class="p">,</span><span class="w"> </span><span class="nx">winTime</span><span class="p">,</span><span class="w"> </span><span class="nx">mouse</span><span class="p">,</span><span class="w"> </span><span class="nx">npcSleep</span><span class="p">,</span><span class="w"> </span><span class="nx">nPeople</span><span class="p">,</span><span class="w"> </span><span class="nx">nDrones</span><span class="p">,</span><span class="w"> </span><span class="nx">frMonitor</span><span class="p">,</span><span class="w"> </span>
<span class="w">                        </span><span class="nx">hzPhysics</span><span class="p">,</span><span class="w"> </span><span class="nx">virtualGamePad</span><span class="p">,</span><span class="w"> </span><span class="nx">noFriendlyFire</span><span class="p">,</span><span class="w"> </span><span class="nx">index</span><span class="p">,</span><span class="w"> </span><span class="nx">debug</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// A script lock, one that locks out all but one invocation. Forces one-at-a-time (wait your turn) operation.</span>
<span class="w">    </span><span class="c1">// http://googleappsdeveloper.blogspot.co.uk/2011/10/concurrency-and-google-apps-script.html</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">lock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">LockService</span><span class="p">.</span><span class="nx">getScriptLock</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// Attempts to acquire the lock, timing out with an exception after the specified number of milliseconds.</span>
<span class="w">    </span><span class="nx">lock</span><span class="p">.</span><span class="nx">waitLock</span><span class="p">(</span><span class="mf">30000</span><span class="p">);</span><span class="w"> </span><span class="c1">// 30 seconds</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">timeNow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">();</span><span class="w"> </span><span class="c1">// create a timestamp</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">nextRow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">m_sheet</span><span class="p">.</span><span class="nx">getLastRow</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span><span class="w"> </span><span class="c1">// locate next empty row</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">// Create an array of the new data to facilitate the write.</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">row</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[[</span><span class="nx">userName</span><span class="p">,</span><span class="w"> </span><span class="nx">score</span><span class="p">,</span><span class="w"> </span><span class="nx">timeNow</span><span class="p">,</span><span class="w"> </span><span class="nx">gameVersion</span><span class="p">,</span><span class="w"> </span><span class="nx">winTime</span><span class="p">,</span><span class="w"> </span><span class="nx">mouse</span><span class="p">,</span><span class="w"> </span><span class="nx">npcSleep</span><span class="p">,</span><span class="w"> </span><span class="nx">nPeople</span><span class="p">,</span><span class="w"> </span><span class="nx">nDrones</span><span class="p">,</span><span class="w"> </span><span class="nx">frMonitor</span><span class="p">,</span><span class="w"> </span>
<span class="w">                    </span><span class="nx">hzPhysics</span><span class="p">,</span><span class="w"> </span><span class="nx">virtualGamePad</span><span class="p">,</span><span class="w"> </span><span class="nx">noFriendlyFire</span><span class="p">,</span><span class="w"> </span><span class="nx">index</span><span class="p">]];</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">// Put the new data into the row.</span>
<span class="w">        </span><span class="nx">m_sheet</span><span class="p">.</span><span class="nx">getRange</span><span class="p">(</span><span class="nx">nextRow</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">m_nColumns</span><span class="p">).</span><span class="nx">setValues</span><span class="p">(</span><span class="nx">row</span><span class="p">);</span>
<span class="w">        </span>
<span class="w">        </span><span class="c1">// If the user is asking for a leaderboard report.</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;report&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// First, sort by score, and get the best scores for the specified version of the game.</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">bestSubmissions_score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getBestSubmissions</span><span class="p">(</span><span class="w"> </span><span class="nx">gameVersion</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;score&#39;</span><span class="p">);</span>
<span class="w">            </span><span class="c1">// Determine user&#39;s rank based on the score sorting.</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">userSummary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">findUserRank</span><span class="p">(</span><span class="w"> </span><span class="nx">userName</span><span class="p">,</span><span class="w"> </span><span class="nx">score</span><span class="p">,</span><span class="w"> </span><span class="nx">timeNow</span><span class="p">,</span><span class="w"> </span><span class="nx">gameVersion</span><span class="p">);</span>
<span class="w">        </span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">newRecordSummary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;result&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;report&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;userName&quot;</span><span class="o">:</span><span class="w"> </span><span class="nx">userName</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;userRank&quot;</span><span class="o">:</span><span class="w"> </span><span class="nx">userSummary</span><span class="p">.</span><span class="nx">rank</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;scoreCount&quot;</span><span class="o">:</span><span class="w"> </span><span class="nx">userSummary</span><span class="p">.</span><span class="nx">scoreCount</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;userScore&quot;</span><span class="o">:</span><span class="w"> </span><span class="nx">score</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;winTime&quot;</span><span class="o">:</span><span class="w"> </span><span class="nx">winTime</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;users&quot;</span><span class="o">:</span><span class="w"> </span><span class="nx">bestSubmissions_score</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;version&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;v1.1&quot;</span>
<span class="w">            </span><span class="p">};</span>

<span class="w">            </span><span class="c1">// Next, sort by winTime, and get the lowest times for the specified version of the game.</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">bestSubmissions_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getBestSubmissions</span><span class="p">(</span><span class="w"> </span><span class="nx">gameVersion</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;winTime&#39;</span><span class="p">);</span>
<span class="w">            </span><span class="c1">// Determine user&#39;s rank based on the winTime sorting.</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">userSummary_timeBased</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">findUserRank</span><span class="p">(</span><span class="w"> </span><span class="nx">userName</span><span class="p">,</span><span class="w"> </span><span class="nx">score</span><span class="p">,</span><span class="w"> </span><span class="nx">timeNow</span><span class="p">,</span><span class="w"> </span><span class="nx">gameVersion</span><span class="p">);</span>

<span class="w">            </span><span class="c1">// Insert this time-based result as an attribute of main score-based newRecordSummary result.</span>
<span class="w">            </span><span class="nx">newRecordSummary</span><span class="p">.</span><span class="nx">timeSortedResults</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="s2">&quot;userName&quot;</span><span class="o">:</span><span class="w"> </span><span class="nx">userName</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;userRank&quot;</span><span class="o">:</span><span class="w"> </span><span class="nx">userSummary_timeBased</span><span class="p">.</span><span class="nx">rank</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;scoreCount&quot;</span><span class="o">:</span><span class="w"> </span><span class="nx">userSummary_timeBased</span><span class="p">.</span><span class="nx">scoreCount</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;userScore&quot;</span><span class="o">:</span><span class="w"> </span><span class="nx">score</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;winTime&quot;</span><span class="o">:</span><span class="w"> </span><span class="nx">winTime</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;users&quot;</span><span class="o">:</span><span class="w"> </span><span class="nx">bestSubmissions_time</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">newRecordSummary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;one record added (no report)&quot;</span><span class="p">};</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">debug</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// for testing...</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">newRecordSummary</span><span class="p">;</span><span class="w">           </span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Retun an object with the user summary and leader results.</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">ContentService</span><span class="p">.</span><span class="nx">createTextOutput</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="w"> </span><span class="nx">newRecordSummary</span><span class="p">)).</span><span class="nx">setMimeType</span><span class="p">(</span><span class="nx">ContentService</span><span class="p">.</span><span class="nx">MimeType</span><span class="p">.</span><span class="nb">JSON</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">errorSummary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;result&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;error&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;error&quot;</span><span class="o">:</span><span class="w"> </span><span class="nx">e</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">        </span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">debug</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// For testing...</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">errorSummary</span><span class="p">;</span><span class="w">        </span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">ContentService</span><span class="p">.</span><span class="nx">createTextOutput</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="w"> </span><span class="nx">errorSummary</span><span class="p">)).</span><span class="nx">setMimeType</span><span class="p">(</span><span class="nx">ContentService</span><span class="p">.</span><span class="nx">MimeType</span><span class="p">.</span><span class="nb">JSON</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">lock</span><span class="p">.</span><span class="nx">releaseLock</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Get the best submissions (by score or time), up to a count of nQueryLimit.</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">getBestSubmissions</span><span class="p">(</span><span class="w"> </span><span class="nx">gameVersion</span><span class="p">,</span><span class="w"> </span><span class="nx">secondSortColumn</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">colMap</span><span class="w"> </span><span class="o">=</span><span class="w">       </span><span class="p">{</span><span class="s1">&#39;score&#39;</span><span class="o">:</span><span class="mf">2</span><span class="p">,</span><span class="w">     </span><span class="s1">&#39;version&#39;</span><span class="o">:</span><span class="mf">4</span><span class="p">,</span><span class="w">    </span><span class="s1">&#39;winTime&#39;</span><span class="o">:</span><span class="mf">5</span><span class="p">};</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">ascendingMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;score&#39;</span><span class="o">:</span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;version&#39;</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;winTime&#39;</span><span class="o">:</span><span class="kc">true</span><span class="p">};</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">thirdSortColumn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">secondSortColumn</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;score&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s2">&quot;winTime&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;score&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">nQueryLimit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">25</span><span class="p">;</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// Get a range starting in second row, first column.</span>
<span class="w">    </span><span class="c1">// Considering the header row, the number of rows and colums in the range.</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">nRows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">m_sheet</span><span class="p">.</span><span class="nx">getLastRow</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">nCols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">m_nColumns</span><span class="p">;</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">range</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">m_sheet</span><span class="p">.</span><span class="nx">getRange</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">nRows</span><span class="p">,</span><span class="w"> </span><span class="nx">nCols</span><span class="p">);</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// Sort this range (all the data) by game version and then other columns (score or winTime).</span>
<span class="w">    </span><span class="c1">// Note the array of sorting indications, one for each level of sorting.</span>
<span class="w">    </span><span class="c1">// https://developers.google.com/apps-script/reference/spreadsheet/range#sort(Object)</span>
<span class="w">    </span><span class="nx">range</span><span class="p">.</span><span class="nx">sort</span><span class="p">([{</span><span class="nx">column</span><span class="o">:</span><span class="w"> </span><span class="nx">colMap</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">],</span><span class="w">         </span><span class="nx">ascending</span><span class="o">:</span><span class="w"> </span><span class="nx">ascendingMap</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]},</span>
<span class="w">                </span><span class="p">{</span><span class="nx">column</span><span class="o">:</span><span class="w"> </span><span class="nx">colMap</span><span class="p">[</span><span class="w"> </span><span class="nx">secondSortColumn</span><span class="p">],</span><span class="w"> </span><span class="nx">ascending</span><span class="o">:</span><span class="w"> </span><span class="nx">ascendingMap</span><span class="p">[</span><span class="w"> </span><span class="nx">secondSortColumn</span><span class="p">]},</span>
<span class="w">                </span><span class="p">{</span><span class="nx">column</span><span class="o">:</span><span class="w"> </span><span class="nx">colMap</span><span class="p">[</span><span class="w"> </span><span class="nx">thirdSortColumn</span><span class="p">],</span><span class="w">  </span><span class="nx">ascending</span><span class="o">:</span><span class="w"> </span><span class="nx">ascendingMap</span><span class="p">[</span><span class="w"> </span><span class="nx">thirdSortColumn</span><span class="p">]}]);</span>
<span class="w">   </span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">userData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">range</span><span class="p">.</span><span class="nx">getValues</span><span class="p">();</span>
<span class="w">    </span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">bestSubmissions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">userCounter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// Count up to nQueryLimit in the group, for rows that have: </span>
<span class="w">    </span><span class="c1">// (1) a user name and, (2) a value in the secondary sort column, and (3) no mouse or npcSleep usage.</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="nx">row</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">userData</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">row</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">len</span><span class="p">;</span><span class="w"> </span><span class="nx">row</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">userData</span><span class="p">[</span><span class="nx">row</span><span class="p">][</span><span class="mf">3</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">gameVersion</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">userData</span><span class="p">[</span><span class="nx">row</span><span class="p">][</span><span class="mf">0</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>
<span class="w">            </span><span class="p">(</span><span class="nx">userData</span><span class="p">[</span><span class="nx">row</span><span class="p">][</span><span class="w"> </span><span class="nx">colMap</span><span class="p">[</span><span class="w"> </span><span class="nx">secondSortColumn</span><span class="p">]</span><span class="o">-</span><span class="mf">1</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">userData</span><span class="p">[</span><span class="nx">row</span><span class="p">][</span><span class="mf">5</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">userData</span><span class="p">[</span><span class="nx">row</span><span class="p">][</span><span class="mf">6</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>

<span class="w">            </span><span class="nx">userCounter</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">            </span><span class="nx">user</span><span class="p">.</span><span class="nx">userName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">userData</span><span class="p">[</span><span class="nx">row</span><span class="p">][</span><span class="mf">0</span><span class="p">];</span>
<span class="w">            </span><span class="nx">user</span><span class="p">.</span><span class="nx">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">userData</span><span class="p">[</span><span class="nx">row</span><span class="p">][</span><span class="mf">1</span><span class="p">];</span>
<span class="w">            </span><span class="nx">user</span><span class="p">.</span><span class="nx">date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">userData</span><span class="p">[</span><span class="nx">row</span><span class="p">][</span><span class="mf">2</span><span class="p">];</span>
<span class="w">            </span><span class="nx">user</span><span class="p">.</span><span class="nx">winTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">userData</span><span class="p">[</span><span class="nx">row</span><span class="p">][</span><span class="mf">4</span><span class="p">];</span>
<span class="w">            </span><span class="nx">user</span><span class="p">.</span><span class="nx">mouse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">userData</span><span class="p">[</span><span class="nx">row</span><span class="p">][</span><span class="mf">5</span><span class="p">];</span>
<span class="w">            </span><span class="nx">user</span><span class="p">.</span><span class="nx">npcSleep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">userData</span><span class="p">[</span><span class="nx">row</span><span class="p">][</span><span class="mf">6</span><span class="p">];</span>
<span class="w">            </span><span class="nx">user</span><span class="p">.</span><span class="nx">nPeople</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">userData</span><span class="p">[</span><span class="nx">row</span><span class="p">][</span><span class="mf">7</span><span class="p">];</span>
<span class="w">            </span><span class="nx">user</span><span class="p">.</span><span class="nx">nDrones</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">userData</span><span class="p">[</span><span class="nx">row</span><span class="p">][</span><span class="mf">8</span><span class="p">];</span>
<span class="w">            </span><span class="nx">user</span><span class="p">.</span><span class="nx">frMonitor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">userData</span><span class="p">[</span><span class="nx">row</span><span class="p">][</span><span class="mf">9</span><span class="p">];</span>
<span class="w">            </span><span class="nx">user</span><span class="p">.</span><span class="nx">hzPhysics</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">userData</span><span class="p">[</span><span class="nx">row</span><span class="p">][</span><span class="mf">10</span><span class="p">];</span>
<span class="w">            </span><span class="nx">user</span><span class="p">.</span><span class="nx">virtualGamePad</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">userData</span><span class="p">[</span><span class="nx">row</span><span class="p">][</span><span class="mf">11</span><span class="p">];</span><span class="w">            </span>
<span class="w">            </span><span class="nx">user</span><span class="p">.</span><span class="nx">noFriendlyFire</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">userData</span><span class="p">[</span><span class="nx">row</span><span class="p">][</span><span class="mf">12</span><span class="p">];</span>
<span class="w">            </span><span class="nx">user</span><span class="p">.</span><span class="nx">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">userData</span><span class="p">[</span><span class="nx">row</span><span class="p">][</span><span class="mf">13</span><span class="p">];</span>
<span class="w">                        </span>
<span class="w">            </span><span class="c1">// Add this user to the array</span>
<span class="w">            </span><span class="nx">bestSubmissions</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">user</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">userCounter</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">nQueryLimit</span><span class="p">)</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">bestSubmissions</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Find this users rank (assuming the sheet has been sorted by score or time). </span>
<span class="c1">// Find match based on name, score, and timestamp.</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">findUserRank</span><span class="p">(</span><span class="w"> </span><span class="nx">userName</span><span class="p">,</span><span class="w"> </span><span class="nx">score</span><span class="p">,</span><span class="w"> </span><span class="nx">recordTime</span><span class="p">,</span><span class="w"> </span><span class="nx">gameVersion</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Get a range starting in second row, first column.</span>
<span class="w">    </span><span class="c1">// Considering the header row, the number of rows and colums in the range.</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">nRows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">m_sheet</span><span class="p">.</span><span class="nx">getLastRow</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">nCols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">m_nColumns</span><span class="p">;</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">range</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">m_sheet</span><span class="p">.</span><span class="nx">getRange</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">nRows</span><span class="p">,</span><span class="w"> </span><span class="nx">nCols</span><span class="p">);</span>

<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">userData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">range</span><span class="p">.</span><span class="nx">getValues</span><span class="p">();</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// In case this user has mouse usage...</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">userSummary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;rank&#39;</span><span class="o">:</span><span class="s1">&#39;mouse or npcSleep usage&#39;</span><span class="p">};</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">rank</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">foundGameSection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// Loop thru all rows, looking for the group of records corresponding to this version of</span>
<span class="w">    </span><span class="c1">// the game. Break from the loop after getting to the end of that group.</span>
<span class="w">    </span><span class="c1">// Count, in the rows for this particular version of the game, to determine the user rank</span>
<span class="w">    </span><span class="c1">// and the overall number of score entries (scoreCount) for this version of the game.</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="nx">row</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">userData</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">row</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">len</span><span class="p">;</span><span class="w"> </span><span class="nx">row</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">foundGameSection</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">userData</span><span class="p">[</span><span class="nx">row</span><span class="p">][</span><span class="mf">3</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">gameVersion</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">userSummary</span><span class="p">.</span><span class="nx">scoreCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">rank</span><span class="p">;</span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="c1">// Don&#39;t count entries with mouse or npcSleep usage.</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">userData</span><span class="p">[</span><span class="nx">row</span><span class="p">][</span><span class="mf">3</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">gameVersion</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">userData</span><span class="p">[</span><span class="nx">row</span><span class="p">][</span><span class="mf">5</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;x&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">userData</span><span class="p">[</span><span class="nx">row</span><span class="p">][</span><span class="mf">6</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;x&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">foundGameSection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">            </span><span class="nx">rank</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span>
<span class="w">            </span><span class="c1">// Look for the row of the current user. Identify it using name, score, and timestamp.</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">userData</span><span class="p">[</span><span class="nx">row</span><span class="p">][</span><span class="mf">0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">userName</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">userData</span><span class="p">[</span><span class="nx">row</span><span class="p">][</span><span class="mf">1</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">score</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">userData</span><span class="p">[</span><span class="nx">row</span><span class="p">][</span><span class="mf">2</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">recordTime</span><span class="p">.</span><span class="nx">toString</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">userSummary</span><span class="p">.</span><span class="nx">userName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">userData</span><span class="p">[</span><span class="nx">row</span><span class="p">][</span><span class="mf">0</span><span class="p">];</span>
<span class="w">                </span><span class="nx">userSummary</span><span class="p">.</span><span class="nx">score</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">userData</span><span class="p">[</span><span class="nx">row</span><span class="p">][</span><span class="mf">1</span><span class="p">];</span>
<span class="w">                </span><span class="nx">userSummary</span><span class="p">.</span><span class="nx">winTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">userData</span><span class="p">[</span><span class="nx">row</span><span class="p">][</span><span class="mf">4</span><span class="p">];</span>
<span class="w">                </span><span class="nx">userSummary</span><span class="p">.</span><span class="nx">date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">userData</span><span class="p">[</span><span class="nx">row</span><span class="p">][</span><span class="mf">2</span><span class="p">];</span>
<span class="w">                </span><span class="nx">userSummary</span><span class="p">.</span><span class="nx">rank</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">rank</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">userSummary</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Initialize the spreadsheet</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">setup</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">    </span><span class="c1">// An array of labels</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">row</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;score&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;timestamp&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;game version&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;win time&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;mouse&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;sleep&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;players&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;drones&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;fr monitor&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                </span><span class="s2">&quot;fr physics&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;game pad&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;no friendly fire&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;index&quot;</span><span class="p">]];</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// Initialize the header row</span>
<span class="w">    </span><span class="nx">m_sheet</span><span class="p">.</span><span class="nx">getRange</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">m_nColumns</span><span class="p">).</span><span class="nx">setValues</span><span class="p">(</span><span class="nx">row</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</body>
</html>
